(function(){"use strict";var c=Windows.ApplicationModel.Background,t=Windows.Storage,u=Windows.UI.WebUI,d=Windows.UI.Notifications,b=Microsoft.WindowsLive.ClientAccessLibrary,q=3,j=310,r=31536e6,f=6e4,n="ModernPhoto\\PhotosBackgroundTaskWorker\\PhotosTileUpdaterBackgroundTask.js",h="BackgroundTileUpdateTask",p="image",i="binding",o="visual",l="branding",m="src",g=function(){this._tileHelper=new k;this._nTilesSent=0;this._targetNumOfNotifications=q;this._sources={};this._backgroundTaskTimer=null;this._bici=new Microsoft.WindowsLive.Instrumentation.Bici;this._bici&&this._bici.startExperience();var a=this;this._libraryManager=b.LibraryManager.getLibraryManager();this._libraryManager.addEventListener("userready",function(b){if(!b||!b.target){msWriteProfilerMark("Photos BG task: No connected user.");a._finishBackgroundTask(true)}});this._libraryManager.addEventListener("sourcepropertieschanged",function(b){var c=b.target;a._runTileUpdateForSourceIfConnected(c)});this._libraryManager.addEventListener("sourcechanged",function(c){var b=c.target;a._libraryManager.getSourcePropertiesAsync(b).done(function(b){a._runTileUpdateForSourceIfConnected(b)},function(){msWriteProfilerMark("Photos BG task: Error getting source properties for "+b+".");a._targetNumOfNotifications--;a._finishIfNoMoreExpected()})})},a=g.prototype;a.setOrResetBackgroundTaskTimer=function(){var a=this;this._backgroundTaskTimer&&clearTimeout(this._backgroundTaskTimer);this._backgroundTaskTimer=setTimeout(function(){msWriteProfilerMark("Photos BG task: Background task timeout of "+f+"ms reached.");a._finishBackgroundTask(true)},f)};a._runTileUpdateForSourceIfConnected=function(a){if(a.sourceType===b.Operation.SourceType.service){var c=a.id;if(!this[c])if(a.connectionState===b.Operation.ConnectionState.connectedProviderOnline){msWriteProfilerMark("Photos BG task: "+a.id+" is connected and online.");this[c]=true;var d=this;this._runTileUpdateForServiceAsync(a,function(){d._finishIfNoMoreExpected()})}else if(a.connectionState!==b.Operation.ConnectionState.notInitialized&&a.connectionState!==b.Operation.ConnectionState.syncServerError){msWriteProfilerMark("Photos BG task: "+a.id+" is not an online, connected provider ("+a.connectionState+").");this[c]=true;this._targetNumOfNotifications--;this._finishIfNoMoreExpected()}else msWriteProfilerMark("Photos BG task: "+a.id+": Connection state = "+a.connectionState+".")}};a._runTileUpdateForServiceAsync=function(a,c){var b=this;this._getServiceHeroShotDataStreamAsync(a,j,j,function(e){var d=b._tileHelper.sendImageTileNotification(e);if(d)msWriteProfilerMark("Photos BG task: Sent tile notification for "+a.id+".");else msWriteProfilerMark("Photos BG task: Tile notification was NOT sent for "+a.id+".");b._nTilesSent+=d?1:0;c()})};a._getServiceHeroShotDataStreamAsync=function(d,i,h,c){var a=this._libraryManager.getAccessWorker(d.id);if(a){var e=new Date(0),f=new Date,g={priority:0,queryType:2,beginDate:e,endDate:f};a.getItemsByDateRangeAsync(g).then(function(c){var d=null;if(c&&c.size>0){var e={resourceId:c[0].resourceId,width:i,height:h,queryType:b.Worker.DataStreamQueryType.photo,queryProperties:b.Worker.DataStreamQueryProperties.uri,streamResource:c[0].streamResource};d=a.getItemDataStreamAsync(0,e)}return d}).done(function(a){c(a&&a.size>0?a[0].uri:null)},function(){msWriteProfilerMark("Photos BG task: Error getting hero shot for "+d.id+".");c(null)})}else c(null)};a._finishIfNoMoreExpected=function(){if(this._nTilesSent>=this._targetNumOfNotifications){msWriteProfilerMark("Photos BG task: Finished sending expected number of notifications ("+this._nTilesSent+").");this._finishBackgroundTask(false)}};a._finishBackgroundTask=function(a){a&&this._nTilesSent===0&&this._registerForConnectedIdTrigger();if(this._bici){this._bici.endExperience();this._bici=null}close()};a._isCurrentlyRegistered=function(){var b=false,g=c.BackgroundTaskRegistration.allTasks,a=g.first(),e=a.hasCurrent;while(e){var f=a.current,d=f.value;if(d&&d.name===h){b=true;break}e=a.moveNext()}return b};a._registerForConnectedIdTrigger=function(){if(!this._isCurrentlyRegistered()){var a=new c.BackgroundTaskBuilder;if(a){a.name=h;a.taskEntryPoint=n;a.setTrigger(new c.SystemTrigger(c.SystemTriggerType.onlineIdConnectedStateChange,false));a.addCondition(new c.SystemCondition(c.SystemConditionType.internetAvailable));a.register()}}};var k=function(){this._updater=d.TileUpdateManager.createTileUpdaterForApplication();this._updater.enableNotificationQueue(true)},e=k.prototype;e.sendImageTileNotification=function(a){var h=Date.now(),i=new Date(h+r),e=false;if(a){var g=this._getNotificationXmlFromTemplate(d.TileTemplateType.tileWideImage,a);if(g){var c=this._getNotificationXmlFromTemplate(d.TileTemplateType.tileSquareImage,a);if(c){var f=this._bundleNotificationsTogether(g,c);if(f){var b=new d.TileNotification(f);b.expirationTime=i;this._updater.update(b);e=true}}}}else msWriteProfilerMark("Photos BG task: Uri was null or empty.");return e};e._getNotificationXmlFromTemplate=function(h,j){var g="name",a=d.TileUpdateManager.getTemplateContent(h);if(a){var c=a.getElementsByTagName(p),b=a.getElementsByTagName(i);if(c&&c.length>0&&b&&b.length>0){var f=c.item(0),e=b.item(0);if(f&&e){e.setAttribute(l,g);f.setAttribute(m,j)}}}return a};e._bundleNotificationsTogether=function(g,e){var a=null;if(g&&e){a=g;var c=e.getElementsByTagName(i);if(c&&c.length>0){var f=c.item(0);if(f){var h=a.importNode(f,true);if(h){var b=a.getElementsByTagName(o);if(b&&b.length>0){var d=b.item(0);d&&d.appendChild(h)}}}}}return a};var s=new g;s.setOrResetBackgroundTaskTimer()})()