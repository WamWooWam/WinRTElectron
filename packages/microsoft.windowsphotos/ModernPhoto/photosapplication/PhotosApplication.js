(function(){window.PhotosApplication={}})();(function(){var e=window.PhotosApplication,b=Windows.Storage,c=Windows.ApplicationModel.Background,d="application",f="ModernPhotoBackgroundTaskWorker";e.Root=function(){this._dataProvider=new WindowsLive.Photo.App.DataProvider;this.initComponent();this._onBeforeUnload=this._onBeforeUnload.bind(this);this._callbackSearchQuerySubmitted=this._callbackSearchQuerySubmitted.bind(this);this._callbackSearchPaneVisibilityChanged=this._callbackSearchPaneVisibilityChanged.bind(this);this._callbackShareDataRequest=this._callbackShareDataRequest.bind(this);this._callbackPlayToSourceRequest=this._callbackPlayToSourceRequest.bind(this);this._callbackSettingsPaneOpen=this._callbackSettingsPaneOpen.bind(this);this._callbackPrintTaskRequested=this._callbackPrintTaskRequested.bind(this);this._onOnlineIdConnectedStateChange=this._onOnlineIdConnectedStateChange.bind(this)};Jx.augment(e.Root,Jx.Component);var a=e.Root.prototype;a.createAppFrame=function(){var a=new WindowsLive.Photo.Viewer.DataModel.Hub(this._dataProvider);this._frame=new PhotoViewer.Frame(this,a,"Photos")};a.registerListeners=function(){window.addEventListener("beforeunload",this._onBeforeUnload,false);var a=Jx.activation;a.addListener(a.autoPlayFile,this._onAutoplayFileActivation,this);a.addListener(a.autoPlayDevice,this._onAutoplayDeviceActivation.bind(this));a.addListener(a.fileOpenPicker,this._onFileOpenPickerActivation,this);a.addListener(a.search,this._onSearchActivation,this);a.addListener(a.tile,this._onTileActivation,this);a.addListener(a.suspending,this._onSuspend,this);a.addListener(a.resuming,this._onResume,this);var b=this;this._frame.addPostApplicationLaunchWorkItem(function(){if(!b._filePickerMode){var a=Windows.ApplicationModel.Search.SearchPane.getForCurrentView();a.addEventListener("querysubmitted",b._callbackSearchQuerySubmitted);a.addEventListener("visibilitychanged",b._callbackSearchPaneVisibilityChanged);var c=Windows.ApplicationModel.DataTransfer.DataTransferManager.getForCurrentView();c.addEventListener("datarequested",b._callbackShareDataRequest);try{var f=Windows.Media.PlayTo.PlayToManager.getForCurrentView();f.addEventListener("sourcerequested",b._callbackPlayToSourceRequest)}catch(g){}var e=Windows.UI.ApplicationSettings.SettingsPane.getForCurrentView();e.addEventListener("commandsrequested",b._callbackSettingsPaneOpen);var d=Windows.Graphics.Printing.PrintManager.getForCurrentView();d.addEventListener("printtaskrequested",b._callbackPrintTaskRequested)}});this._registerOnlineIdConnectedStateChangeBackgroundTask()};a.getUI=function(a){var b=Jx.getUI(this._frame);Object.keys(b).forEach(function(c){a[c]+=b[c]});a.html='<div id="'+this._id+'">'+a.html+"</div>"};a.shutdownComponent=function(){this._activated=false;this._unregisterListeners();this._frame=null;if(this._dataProvider){this._dataProvider.applicationSuspend();this._dataProvider=null}Jx.Component.prototype.shutdownComponent.call(this)};a._callbackShareDataRequest=function(a){this._frame.handleShare(a)};a._callbackSearchQuerySubmitted=function(a){this._handleSearch(a.queryText)};a._callbackSearchPaneVisibilityChanged=function(a){this._frame.handleSearchPaneVisibilityChanged(a)};a._callbackPlayToSourceRequest=function(a){this._frame.handlePlayTo(a)};a._callbackSettingsPaneOpen=function(a){this._frame.initSettingsPane(a)};a._callbackPrintTaskRequested=function(a){this._frame.handlePrint(a)};a._onOnlineIdConnectedStateChange=function(){this._frame.onOnlineIdConnectedStateChange()};a._onSuspend=function(){this._frame.onSuspend();this._unregisterOnlineIdConnectedStateChangeBackgroundTask()};a._onResume=function(){if(Jx.launch.getCurrentAppStatus()===Jx.Launch.AppStatus.mandatoryUpdate){this.shutdownComponent();var a=Jx.activation;a.removeListener(a.suspending,this._onSuspend,this);a.removeListener(a.resuming,this._onResume,this)}else this._frame.onResume();this._registerOnlineIdConnectedStateChangeBackgroundTask()};a._onTileActivation=function(a){this._onActivated(a)};a._onAutoplayFileActivation=function(c){var a=c.files[0];if(!a.isOfType(b.StorageItemTypes.folder))this._handleOpenWith(a);else this._handleImportFromAutoplay(a)};a._onAutoplayDeviceActivation=function(a){var b=Windows.Devices.Portable.StorageDevice.fromId(a.deviceInformationId);this._handleImportFromAutoplay(b,a.deviceInformationId)};a._onSearchActivation=function(a){if(!this._activated){var b={forceRootView:true};this._onActivated(a,b)}var c=this;window.msSetImmediate(function(){c._handleSearch(a.queryText)})};a._onFileOpenPickerActivation=function(a){this._filePickerMode=true;this._onActivated(a)};a._onBeforeUnload=function(){Jx.log.perf("evModernPhotos_UnloadUI_Start");this._onSuspend();Jx.app.shutdownUI();Jx.log.perf("evModernPhotos_UnloadUI_Stop");Jx.app.shutdown()};a._handleImportFromAutoplay=function(a,b){Jx.log.info("Import autoplay started...");this._activated=true;if(this._frame.handleAutoplayImport(a,b)){Jx.log.info("Initializing UI from import");Jx.app.initUI(document.getElementById(d))}};a._handleOpenWith=function(c){this._activated=true;if(this._frame.isImportViewActive()){Jx.log.info("Import session in progress, aborting open with...");return}Jx.log.perf("evModernPhotos_HandleOpenWith_Start");var h=c.name,a=b.AccessCache.StorageApplicationPermissions.futureAccessList;a.entries.length>=a.maximumItemsAllowed&&a.remove(a.entries[0].token);var e=a.add(c,h),f=this._dataProvider,g=f.getContainerIdForPath(e),i=f.getIdFromUri(e,false);this._frame.openAsset(g,i)&&Jx.app.initUI(document.getElementById(d));this._frame.addPostApplicationLaunchWorkItem(function(){var d=c.path;if(Jx.isNonEmptyString(d)){var a=new b.Search.QueryOptions;a.folderDepth=b.Search.FolderDepth.deep;a.indexerOption=b.Search.IndexerOption.onlyUseIndexer;a.applicationSearchFilter='System.ItemUrl:="'+d+'"';var e=b.KnownFolders.picturesLibrary,f=e.createFileQueryWithOptions(a);f.getFilesAsync(0,1).then(function(a){if(a.length>0)Jx.bici.increment(Microsoft.WindowsLive.Instrumentation.Ids.Photo.openWithInsideLibraryCount,1);else Jx.bici.increment(Microsoft.WindowsLive.Instrumentation.Ids.Photo.openWithOutsideLibraryCount,1)})}else Jx.bici.increment(Microsoft.WindowsLive.Instrumentation.Ids.Photo.openWithOutsideLibraryCount,1)});Jx.log.perf("evModernPhotos_HandleOpenWith_Stop")};a._onActivated=function(b,a){this._activated=true;this._frame.onActivated(b,a)&&Jx.app.initUI(document.getElementById(d))};a._handleSearch=function(a){PhotoViewer.log.perf("evSearch_SearchCommit",{emptyValue:true});this._frame.handleSearch(a)};a._registerOnlineIdConnectedStateChangeBackgroundTask=function(){try{var i=c.BackgroundTaskRegistration.allTasks,b=i.first(),e=b.hasCurrent;while(e){var g=b.current,d=g.value;if(!Jx.isNullOrUndefined(d)&&d.name===f){this._task=d;break}e=b.moveNext()}if(!this._task){var a=new c.BackgroundTaskBuilder;a.name=f;a.taskEntryPoint="ModernPhoto\\PhotosBackgroundTaskWorker\\PhotosBackgroundTaskWorker.js";var h=new c.SystemTrigger(c.SystemTriggerType.onlineIdConnectedStateChange,false);a.setTrigger(h);this._task=a.register()}this._task.addEventListener("completed",this._onOnlineIdConnectedStateChange)}catch(j){}};a._unregisterOnlineIdConnectedStateChangeBackgroundTask=function(){if(this._task){this._task.removeEventListener("completed",this._onOnlineIdConnectedStateChange);this._task.unregister(true);this._task=null}};a._unregisterListeners=function(){window.removeEventListener("beforeunload",this._onBeforeUnload,false);this._unregisterOnlineIdConnectedStateChangeBackgroundTask();if(!this._filePickerMode){var a=Windows.ApplicationModel.Search.SearchPane.getForCurrentView();a.removeEventListener("querysubmitted",this._callbackSearchQuerySubmitted);a.removeEventListener("visibilitychanged",this._callbackSearchPaneVisibilityChanged);var b=Windows.ApplicationModel.DataTransfer.DataTransferManager.getForCurrentView();b.removeEventListener("datarequested",this._callbackShareDataRequest);try{var e=Windows.Media.PlayTo.PlayToManager.getForCurrentView();e.removeEventListener("sourcerequested",this._callbackPlayToSourceRequest)}catch(f){}var d=Windows.UI.ApplicationSettings.SettingsPane.getForCurrentView();d.removeEventListener("commandsrequested",this._callbackSettingsPaneOpen);var c=Windows.Graphics.Printing.PrintManager.getForCurrentView();c.removeEventListener("printtaskrequested",this._callbackPrintTaskRequested)}};a._activated=false;a._task=null;a._frame=null;a._dataProvider=null;a._filePickerMode=false})();(function(){Jx.log.provider=new Microsoft.WindowsLive.Etw.Providers.PhotoAppProvider;Jx.log.perf("evModernPhotos_InitUI_Start");Jx.app=new Jx.Application(Jx.AppId.photo,true,true);if(Jx.launch.getCurrentAppStatus()!==Jx.Launch.AppStatus.mandatoryUpdate){var a=new PhotosApplication.Root;Jx.app.setRoot(a,null);a.createAppFrame();a.registerListeners()}Jx.log.perf("evModernPhotos_InitUI_Stop")})()