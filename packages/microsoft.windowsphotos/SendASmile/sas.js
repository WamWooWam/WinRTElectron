(function(){Jx.Sas=function(b,a){this._feedback={userid:"Anonymous",device:"",build:"",application:b,isBeta:false};this._filesRegistered=false;this._localizedAppName=a;this.initComponent();this._id="SendASmile"};Jx.augment(Jx.Sas,Jx.Component);Jx.Sas.HELPER_PAGE_URL="ms-appx-web:///sendasmile/survey_helper.html";Jx.Sas.LoadState={loading:0,jsLoaded:1,firstPage:2,secondPage:3,submitted:4,error:5};var a=Jx.Sas.prototype;a.getUI=function(b){var a=SasManager.getConfig().privacyUrl;a=Jx.escapeHtml(a.replace(/\{0\}/,SasManager.getMarket()));b.html="<div id='SendASmile' class='win-wide' data-win-control='WinJS.UI.SettingsFlyout'><div id='sasHeader' class='win-header'><button id='sasBackButton' type='button' class='win-backbutton' aria-label='"+Jx.escapeHtml(Jx.res.getString("/accountsStrings/asc-backButtonAriaLabel"))+"'></button><div class='typeSizeMedium singleLineText' id='sasTitle'>"+this._localizedAppName+" "+Jx.res.getString("/strings/sasSurveyHeader")+"</div><div id='sasAppIcon'></div></div><div id='sasLoadCtr'><div id='sasLoadHeader'><progress id='sasLoadSpinner' class='win-ring win-small'></progress><span id='sasLoadHeaderText' class='typeSizeNormal'>"+Jx.res.getString("/strings/sasLoadingHeader")+"</span></div><div id='sasLoadText' class='typeSizeNormal'></div></div><div id='sasForm'><div id='surveyIFrameHost'></div><a id='sasLegalLink' href='"+a+"'>"+Jx.res.getString("/strings/sasPrivacyText")+"</a></div></div>";this._addCss("/resources/sendasmile/css/sas.css");this._addCss("/resources/sendasmile/css/"+this._feedback.application+"SaSColor.css");this._hasUI=true};a.activateUI=function(){Jx.Component.activateUI.call(this);var b=document.createElement("iframe");b.className="settings_section";b.id="surveyFrame";document.getElementById("surveyIFrameHost").replaceNode(b);this._flyout=document.getElementById("SendASmile");this._surveyFrame=document.getElementById("surveyFrame");this._backButton=document.getElementById("sasBackButton");WinJS.UI.processAll(this._flyout).then();var a=this;this._listeners=[{element:window,type:"message",handler:function(){a._onMessage.apply(a,arguments)}},{element:this._flyout,type:"afterhide",handler:function(){a._onHide.apply(a)}},{element:this._backButton,type:"click",handler:function(){a._handleBackButton.apply(a)}}];this._listeners.forEach(function(a){a.element.addEventListener(a.type,a.handler)});this._collectFeedback();this._loadState=Jx.Sas.LoadState.loading};a.deactivateUI=function(){Jx.Component.deactivateUI.call(this);this._listeners.forEach(function(a){a.element&&a.element.removeEventListener(a.type,a.handler)})};a.show=function(){this._flyout.winControl&&this._flyout.winControl.show();if(this._loadState===Jx.Sas.LoadState.loading){var b=Jx.appId?Jx.appId:0,a=SasManager._config.application.lookup(b).surveyId;this._loadIframe(this._surveyFrame,a);this._startLoadTime=+new Date}};a.hide=function(){this._flyout.winControl&&this._flyout.winControl.hide()};a.setUserInfo=function(b,a){this._feedback.isBeta=a;this._feedback.userid=b};a.collectAndUploadLogs=function(d,h){if(SasManager.enableIssueReporting()){var l=Windows.ApplicationModel.Package.current.id.familyName,g=Windows.ApplicationModel.Package.current.id.fullName,b=Windows.ApplicationModel.Package.current.id.version,i=b.major+"."+b.minor+"."+b.revision+"."+b.build,j=Windows.Storage.ApplicationData.current.localFolder,f=d+"_bug.txt",e=[],k=function(a){if(!c._filesRegistered){a.forEach(function(a){Jx.erRegisterFile(a)});c._filesRegistered=true}Jx.fault("sas_bugreport","sas_bugreport")},a=function(a){return function(){Jx.log.error("Feedback: "+a)}},c=this;j.createFileAsync(f,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(a){e.push(a.path);e.push(a.path.replace(f,"LiveCommLast.etl"));return a.openAsync(Windows.Storage.FileAccessMode.readWrite)},a("Unable to create a new text file for bug information.")).then(function(f){var e=f.getOutputStreamAt(f.size),b=new Windows.Storage.Streams.DataWriter(e);function j(){b.detachStream();return e.flushAsync()}b.writeString("Bug report");b.writeString("Bug title: "+d+","+c._feedback.userid);b.writeString("Bug description: "+h);b.writeString("Application name: "+d);b.writeString("Package full name: "+g);b.writeString("Package version: "+i);b.writeString("User id: "+c._feedback.userid);return b.storeAsync().then(j,a("Unable to write bug information to newly created file."))},a("Unable to open newly created bug file.")).then(function(){k(e)},a("Unable to flush bug information to file stream."))}};a._loadIframe=function(c,b){var a={target:"",template:"default",enableLTS:0,survey:{language:SasManager.getLanguage(),id:b,host:SasManager.getConfig().fmsDomain,features:["Title,AllNormalPages,NextButton,Thankyou,SubmitButton,PreviousButton"],renderOption:"noDefault,overrideall"},site:{name:this._id,id:"3",brand:"3"},content:{id:"7D36270F8ABD495CADEF88DE0F0B904A",type:"kb",aggregateId:"Sas"},parameters:[this._feedback.application,this._feedback.userid,this._feedback.build,this._feedback.device,this._feedback.isBeta,SasManager.getMarket()],localCss:"//Microsoft.WinJS.1.0/css/ui-light.css",loadTimeout:15e3,localizedAppName:this._localizedAppName};c.src=Jx.Sas.HELPER_PAGE_URL+"?"+JSON.stringify(a)};a._onMessage=function(e){var a=e.data;if(e.origin==="ms-appx-web://"+Windows.ApplicationModel.Package.current.id.name)if(a.badLoad){if(this._loadState===Jx.Sas.LoadState.loading||this._loadState===Jx.Sas.LoadState.jsLoaded){document.getElementById("sasLoadHeaderText").innerText=Jx.res.getString("/strings/sasBadLoadHeader");document.getElementById("sasLoadText").innerText=Jx.res.getString("/strings/sasBadLoad");document.getElementById("sasLoadSpinner").outerText="";this._loadState=Jx.Sas.LoadState.error;Jx.bici.increment(Microsoft.WindowsLive.Instrumentation.Ids.General.sendSmileErrorCount,1);var g=this._loadState===Jx.Sas.LoadState.jsLoaded?Microsoft.WindowsLive.Instrumentation.ErrorType.network:Microsoft.WindowsLive.Instrumentation.ErrorType.fault;this._recordQos(this._startLoadTime,2,g)}}else if(a.loaded){if(this._loadState===Jx.Sas.LoadState.loading||this._loadState===Jx.Sas.LoadState.jsLoaded){document.getElementById("sasLoadCtr").outerText="";document.getElementById("sasForm").style.display="block";this._loadState=Jx.Sas.LoadState.firstPage;this._recordQos(this._startLoadTime,0,Microsoft.WindowsLive.Instrumentation.ErrorType.success)}}else if(a.jsLoaded){if(this._loadState===Jx.Sas.LoadState.loading)this._loadState=Jx.Sas.LoadState.jsLoaded}else if(a.submitted){this.collectAndUploadLogs(this._feedback.application,a.textInput);this._loadState=Jx.Sas.LoadState.submitted;Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.General.sendSmile,0)}else if(a.onFirstPage&&this._loadState===Jx.Sas.LoadState.secondPage)this._loadState=Jx.Sas.LoadState.firstPage;else if(a.onFirstPage!==undefined&&this._loadState===Jx.Sas.LoadState.firstPage){this._loadState=Jx.Sas.LoadState.secondPage;if(a.showHelp){Jx.bici.increment(Microsoft.WindowsLive.Instrumentation.Ids.General.sendSmile,1);this._loadState=Jx.Sas.LoadState.submitted;var b=true,d=Jx.appId?Jx.appId:0;if(d===Jx.AppId.photo)try{var f=new window.PhotoViewer.SettingsView;f.helpPaneInvoked();b=false}catch(h){Jx.log.exception("Feedback: Unable to show Photo-specific Help Flyout",h)}if(b){var c=SasManager._config.application.lookup(d).helpFlyoutUrl;c&&Jx.SettingsFlyout.showHelp(c)}this.hide()}}};a._recordQos=function(e,b,c){try{var d=+new Date-e,a=Microsoft.WindowsLive.Instrumentation;Jx.bici.recordDependentApiQos(a.ScenarioId.modernSendaSmile_ShowSurvey,a.ApiId.fms_LoadSurvey,a.PropertyId.fms,d,0,b,c,null);Jx.bici.recordScenarioQos(a.ScenarioId.modernSendaSmile_ShowSurvey,a.PropertyId.fms,d,0,b,c,null)}catch(f){Jx.log.exception("Feedback: Unable to record QoS",f)}};a._collectFeedback=function(){var a=(new Windows.Devices.Input.KeyboardCapabilities).keyboardPresent,b=(new Windows.Devices.Input.MouseCapabilities).mousePresent,c=(new Windows.Devices.Input.TouchCapabilities).touchPresent;this._feedback.device=a+","+b+","+c;this._feedback.build=Windows.ApplicationModel.Package.current.id.fullName};a._handleBackButton=function(){if(this._loadState!==Jx.Sas.LoadState.secondPage){this.hide();Windows.UI.ApplicationSettings.SettingsPane.show()}else this._surveyFrame.contentWindow.postMessage({backButtonPressed:true},"*")};a._onHide=function(){(this._loadState===Jx.Sas.LoadState.submitted||this._loadState===Jx.Sas.LoadState.error)&&this.shutdownUI()};a._addCss=function(b){var a=document.createElement("link");a.type="text/css";a.rel="stylesheet";a.href=b;document.head.appendChild(a)}})()