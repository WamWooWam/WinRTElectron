(function(){var b=window.PhotoViewer,e=b.DataHubHelpers,f=b.ViewHelpers,g=b.Graphics,d=WindowsLive.Photo.Viewer.DataModel,h=WinJS.Promise,c={width:40,height:40};b.BasketThumb=function(e,b,d){this.initComponent();this._dataHub=e;this._deactivated=false;this._command=d;this._appbarComponent=b;b.appendChild(this);var c=Jx.getUI(this),a=this._command.element.getElementsByClassName("win-commandicon")[0];a.innerHTML=c.html;Jx.removeClass(a,"win-commandring");this._hubSelectionChangedHandler=this._hubSelectionChangedHandler.bind(this)};Jx.augment(b.BasketThumb,Jx.Component);var a=b.BasketThumb.prototype;a.getUI=function(a){a.html='    <div id="basketThumb-UX" class="photoViewer-thumbContainer win-commandimage">        <img id="basketThumb-img" />        <div id="basketThumb-overlayContainer">        </div>    </div>'};a.activateUI=function(){this._overlayContainerElement=document.getElementById("basketThumb-overlayContainer");var b=this._dataHub.selection;this._dataAdaptor=new PhotoViewer.ObjectCollectionDSA(this._dataHub,b);b.addEventListener("changed",this._hubSelectionChangedHandler);this._hubSelectionChangedRegistrar=b;var g=this._command.element.getElementsByClassName("win-commandicon")[0];Jx.addClass(g,"photoViewer-placeholder");var a=document.getElementById("basketThumb-UX");this._thumbnailElementParent=a;var e=document.getElementById("basketThumb-img"),d=this;e.addEventListener("load",function(){if(!d._deactivated){var b=a.style.opacity==="0"?a:e;WinJS.UI.Animation.fadeIn(b).then(function(){if(!d._deactivated){b.style.opacity="1";d._releaseOldImageIfAny()}})}},false);this._thumbnailElement=e;this._deactivated=false;var f=this._thumbnailElementParent.style;f.width=c.width.toString()+"px";f.height=c.height.toString()+"px";this._updateThumbnailAndItemCount(false);Jx.Component.prototype.activateUI.call(this);PhotoViewer.log.perf("evBasket_BasketThumbSetUpCompleted",{emptyValue:true})};a.deactivateUI=function(){this._deactivated=true;this._previousLastObjectId=null;this._removeEventListeners();var a=this._dataAdaptor;if(a){a.shutdown();this._dataAdaptor=null}Jx.Component.prototype.deactivateUI.call(this)};a._hubSelectionChangedHandler=function(f){for(var i=f.target,e=f.detail[0],h=e.length,c=false,b=0;b<h;b++){var a=e[b];switch(a.type){case d.ObjectCollectionChangedEventType.modified:var g=this._dataAdaptor.count;if(a.position+a.count===g){c=true;break}}}this._updateThumbnailAndItemCount(c)};a._removeEventListeners=function(){if(this._hubSelectionChangedRegistrar){this._hubSelectionChangedRegistrar.removeEventListener("changed",this._hubSelectionChangedHandler);this._hubSelectionChangedRegistrar=null}};a._updateThumbnailAndItemCount=function(h){var b=this._dataAdaptor.count,a=this._thumbnailElement;if(b>0){Jx.removeClass(a,"displayNone");var d=this._dataAdaptor.indexToObjectId(b-1);if(h||d!==this._previousLastObjectId){var i=this._dataAdaptor.indexToObject(b-1);if(Jx.isNonEmptyString(this._previousLastObjectId)){this._releaseOldImageIfAny();if(Jx.isNonEmptyString(a.src)){var e=a.cloneNode(true);this._thumbnailElementParent.appendChild(e);this._oldThumbnailElement=e;Jx.addClass(a,"photoViewer-temporaryOverlay")}a.src="";a.style.opacity="0"}else{this._thumbnailElementParent.style.opacity="0";a.style.opacity="1"}i.getProperties(["width","height"],this._getImageSizeCallback());this._previousLastObjectId=d}}else{Jx.addClass(a,"displayNone");this._previousLastObjectId=null}var c=f.formatInteger(b);this._command.label=Jx.res.loadCompoundString("residItemSelected",c);var g=b===1?"residSelectedItemCount_1_Fmt":"residSelectedItemCount_N_Fmt";this._command.tooltip=Jx.res.loadCompoundString(g,c);PhotoViewer.log.perf("evBasket_BasketThumbUpdateCompleted",{emptyValue:true})};a._getImageSizeCallback=function(){var a=this,b=a._thumbnailElement;return function(f,g){if(Boolean(a._dataAdaptor)&&!a._dataAdaptor.isDeactivated()){var b=e.tryLookupPropertiesInMap(g,["width","height"]);if(!b)return;var h=a._dataAdaptor.objectIdToIndex(f.id),d=parseInt(b.width,10),c=parseInt(b.height,10);if(!Jx.isValidNumber(d)||!Jx.isValidNumber(c)||d<=0||c<=0)a._renderFailedItem();else a._loadThumbnail(f)}}};a._loadThumbnail=function(d){var a=this,b=a._thumbnailElement;d.getThumbnailAsync(b.width,b.height,null,false).then(function(f){if(!a._deactivated)if(e.isBlobOperationResultValid(f)){var h=f.dimensions,j=c.width,i=c.height,l=h.width,k=h.height,m=g.scaleAndCenter(b,l,k,j,i,true);if(d.type==="asset.video")Jx.addClass(a._overlayContainerElement,"basketThumb-imgOverlay");else Jx.removeClass(a._overlayContainerElement,"basketThumb-imgOverlay");b.src=e.getSourceFromBlobOperationResult(f,false)}else a._renderFailedItem()}).done(null,function(){!a._deactivated&&a._renderFailedItem()})};a._renderFailedItem=function(){Jx.addClass(this._thumbnailElement,"displayNone");this._releaseOldImageIfAny();var a=this._overlayContainerElement;Jx.removeClass(a,"basketThumb-imgOverlay");this._thumbnailElementParent.style.opacity="1"};a._releaseOldImageIfAny=function(){var a=this._oldThumbnailElement;if(a){this._thumbnailElementParent.removeChild(a);this._oldThumbnailElement=null;Jx.removeClass(this._thumbnailElement,"photoViewer-temporaryOverlay")}};a._previousLastObjectId=null;a._dataAdaptor=null;a._dataHub=null;a._thumbnailElement=null;a._oldThumbnailElement=null;a._thumbnailElementParent=null;a._overlayContainerElement=null;a._hubSelectionChangedRegistrar=null;a._deactivated=null;a._command=null})()