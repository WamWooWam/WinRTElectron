(function(){var b=window.PhotoViewer,c=b.AppBar.Commands;b.PlayToComponent=function(c,a){this.initComponent();this._site=c;this._dataHub=a;this._controller=new b.PlayToController(a,c,this)};Jx.augment(b.PlayToComponent,Jx.Component);var a=b.PlayToComponent.prototype;a.deactivateUI=function(){this._controller.shutdownView();Jx.Component.prototype.deactivateUI.call(this)};a.getUI=function(a){this._controller.getMainViewUI(this._id,a)};a.activateUI=function(){var a;if(Boolean(this._setWithActiveItem)&&this._setWithActiveItem.size>0)a=this._setWithActiveItem.idAt(0);this._controller.finalizeInitUI(a);Jx.Component.prototype.activateUI.call(this)};a.handlePlayTo=function(a){this._controller.handlePlayTo(a)};a.setInitializationParameters=function(a){Boolean(a.context)&&this._controller.setDataSet(a.context);if(Boolean(a.additionalData))this._setWithActiveItem=a.additionalData};a.addStatus=function(f,e,d,c,b,a){return this._site.addStatus(f,e,d,c,b,a)};a.getEntranceAnimationInfo=function(){return this._controller.getEntranceAnimationInfo()};a.getExitAnimationInfo=function(){return this._controller.getExitAnimationInfo()};a.exitPlayTo=function(){this._site.doCommand(c.navigateBack,WindowsLive.Photo.Viewer.Commanding.CommandSurface.canvas,null,null)};a._site=null;a._controller=null;a._dataHub=null;a._setWithActiveItem=null})();(function(){var k=0,e=0,i=5e3,j=1,f=-1,h=false;PhotoViewer.PlayToWLI={};PhotoViewer.PlayToWLI.PlayToSessionInteraction={autoPlayOnly:0,autoPlayAndManual:1};var c=window.PhotoViewer,b=c.AppBar.Commands;c.PlayToHighResItemError={none:"none",fetchTimeout:"fetchTimeout",qualityTooLow:"qualityTooLow",errorUnknown:"unknown",dataLayerFetchError:"dataLayerFetchError",imgTagError:"imgTagError",videoTagAborted:"videoTagAborted",videoTagNetwork:"videoTagNetwork",videoTagDecode:"videoTagDecode",videoTagSrcNotSupported:"videoTagSrcNotSupported",playToConnectionDeviceError:"playToConnectionDeviceError"};c.PlayToCurrentItemInfo=function(){};var g=c.PlayToCurrentItemInfo.prototype;g.reset=function(){this.itemObjectId=null;this.imageRendered=false;this.completed=false};g.set=function(a){this.reset();this.itemObjectId=a};g.itemObjectId=null;g.imageRendered=false;g.completed=false;var d=WindowsLive.Photo.Viewer.Commanding;c.PlayToController=function(d,a,b){c.log.perf("evPhotoViewerPlayTo_BeginInitialization",{emptyValue:true});this._dataHub=d;this._component=b;this._coordinator=a;this._highResItemPrefetcher=null;this._cachedIndexNotificationHelper=null;this._toggleAutoPlayHandler=this._toggleAutoPlayHandler.bind(this);this._togglePlayPauseHandler=this._togglePlayPauseHandler.bind(this);this._view=null;this._playToPlaybackManager=null;this._playToStatusView=null};var l=c.PlayToController,a=c.PlayToController.prototype;a.getMainViewUI=function(a,b){if(!Boolean(this._view))this._view=new c.PlayToView;this._view.getMainViewUI(a,b)};a.handlePlayTo=function(a){Jx.log.info("PlayToController: Received SourceRequestEvent");if(!this._playToPlaybackManager)this._playToPlaybackManager=new c.PlayToPlaybackManager(this);this._playToPlaybackManager.handlePlayTo(a)};a.playToSourceSelected=function(){if(Boolean(this._view)&&this._viewEnabled&&this._view.isInitialized())return;this._connectedToDevice&&this._shutDownConnection(true);c.log.perf("evPhotoViewerPlayTo_ConnectionEstablished",{emptyValue:true});this._coordinator.doCommand(b.launchPlayTo,d.CommandSurface.charmsBar,null,null);this._initPlayToStatus()};a._shutDownConnection=function(a){this.endAutoPlay(true);if(Boolean(this._view)&&this._viewEnabled&&this._view.isInitialized())this._coordinator.isCommandEnabled(b.navigateBack)&&this._coordinator.doCommand(b.navigateBack,d.CommandSurface.canvas,null,null);this._connectedToDevice=false;this._currentPlayToStatus.remove();this._currentPlayToStatus=null;this._playToStatusView.shutdown();this._playToStatusView=null;if(this._dataAdaptor){this._dataAdaptor.shutdown();this._dataAdaptor=null}if(this._highResItemPrefetcher){this._highResItemPrefetcher.shutdown();this._highResItemPrefetcher=null}this._knownBadObjectIds={};if(this._cachedIndexNotificationHelper){this._cachedIndexNotificationHelper.shutdown();this._cachedIndexNotificationHelper=null}if(!a&&Boolean(this._playToPlaybackManager)){this._playToPlaybackManager.shutdown();this._playToPlaybackManager=null}this._currentItemInfo=null;var c=this._enteredManualMode?PhotoViewer.PlayToWLI.PlayToSessionInteraction.autoPlayAndManual:PhotoViewer.PlayToWLI.PlayToSessionInteraction.autoPlayOnly;Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.Photo.playToSessionInteraction,c);this._enteredManualMode=false};a.playToConnectionConnected=function(b){var a=this._highResItemPrefetcher.getItemFromElement(b);this._detectAutoIterate(a);if(!this._connectedToDevice){Jx.log.info("PlayToController: Connected to Remote Device.");this._beginAutoPlayWhenFirstItemIsReady=h;this._connectedToDevice=true;this._playHighResItem(this._currentItemInfo.itemObjectId)}};a.playToConnectionRendering=function(b){var a=this._highResItemPrefetcher.getItemFromElement(b);this._detectAutoIterate(a);Jx.log.info("PlayToController: Rendering item.");this._currentItemInfo.imageRendered=true;this._tryIterateToNextItem()};a.playToConnectionDisconnected=function(){Jx.log.info("PlayToController: Disconnected from Remote Device.");this._shutDownConnection(false);c.log.perf("evPhotoViewer_PlayTo_Disconnected",{emptyValue:true})};a.playToConnectionPlay=function(d){if(this._uiInitiatedPlayPausePending){this._uiInitiatedPlayPausePending=false;return}var a=this._highResItemPrefetcher.getItemFromElement(d);if(a){var c=a.getObjectId(),b=this._currentItemInfo.itemObjectId;if(c===b){Jx.log.info("PlayToController::playToConnectionPlay detected play from DMR.");this.startAutoPlay()}}};a.playToConnectionPause=function(d){if(this._uiInitiatedPlayPausePending){this._uiInitiatedPlayPausePending=false;return}var a=this._highResItemPrefetcher.getItemFromElement(d);if(a){var c=a.getObjectId(),b=this._currentItemInfo.itemObjectId;if(c===b){Jx.log.info("PlayToController::playToConnectionPause detected pause from DMR.");this.endAutoPlay(true)}}};a.playToConnectionChanged=function(b){var a=this._highResItemPrefetcher.getItemFromElement(b);this._detectAutoIterate(a)};a.playToError=function(e,f,g){Jx.log.info('PlayToController: Error with PlayToConnection. ErrorCode= "'+String(e)+'"  ErrorMessage= "'+f+'".');var d=Windows.Media.PlayTo.PlayToConnectionError,a;switch(e){case d.deviceError:a=c.PlayToHighResItemError.playToConnectionDeviceError}if(a){var b=this._highResItemPrefetcher.getItemFromElement(g);if(b){b.setError(a);this._onItemErrorHelper(b,a)}}};a.getEntranceAnimationInfo=function(){return this._view.getEntranceAnimationInfo()};a.getExitAnimationInfo=function(){return this._view.getExitAnimationInfo()};a.setDataSet=function(b){Jx.log.info("PlayToController: Setting new dataSet.");var a=b.clone();this._dataAdaptor=new PhotoViewer.AssetOnlyDSA(this._dataHub,a);this._cachedIndexNotificationHelper=new PhotoViewer.CachedIndexNotificationHelper(this,this._dataAdaptor);this._highResItemPrefetcher=new c.PlayToHighResItemPrefetcher(this._dataHub,this,this._dataAdaptor)};a.finalizeInitUI=function(b){Jx.log.info("PlayToController: finalizeInitUI");var h=this;this._currentItemInfo=new c.PlayToCurrentItemInfo;this._setCommanding();var a=k;if(b){var e=this._dataAdaptor.objectIdToIndex(b);if(Jx.isValidNumber(e))a=e}this._view.initialize(a,this._dataAdaptor,this);var d=this._getDeviceName();d&&this._view.updateDeviceName(d);var g=this._dataAdaptor.count;this._view.updateItemCount(g);this._viewEnabled=true;this._enteredManualMode=false;var f=h._dataAdaptor.indexToObject(a);this._playHighResItem(f.id)};a.shutdownView=function(){Jx.log.info("PlayToController::shutdownView");if(this._viewEnabled){this._view.shutdown();this._view=null;this._viewEnabled=false}};Object.defineProperty(a,"coordinator",{"get":function(){return this._coordinator}});a.itemInvoked=function(e){PhotoViewer.log.perf("evPhotoViewer_PlayTo_ItemInvoked",{emptyValue:true});Jx.log.info("PlayToController::itemInvoked: Item invoked event on index "+String(e));var f=this._dataAdaptor.indexToObject(e),d=f.id,c;try{c=this._dataAdaptor.objectIdToIndex(this._currentItemInfo.itemObjectId)}catch(g){}if(Jx.isValidNumber(c)){var a=this._highResItemPrefetcher.getItem(c,false);if(Boolean(a)&&a.isLoaded()&&a.isVideo()){var b=a.element;!b.paused&&!b.ended&&b.pause()}!this.isObjectIdKnownError(d)&&this._playHighResItem(d,true)}this._inAutoPlay&&this.endAutoPlay(false)};a.startAutoPlay=function(){Jx.log.info("PlayToController::startAutoPlay");this._coordinator.setCommandStage(b.autoPlayButton,b.stopAutoPlay);if(this._inAutoPlay)return;this._view&&this._view.setMode(c.PlayToViewMode.autoPlay);this._inAutoPlay=true;if(this._view){var e=this._currentItemInfo;if(e){var f=e.itemObjectId;Jx.isNonEmptyString(f)&&this._view.setActiveItem(f,true)}}var g=this._nextIndex=this._dataAdaptor.objectIdToIndex(this._currentItemInfo.itemObjectId);this._setNextIndex();var a=this._highResItemPrefetcher.getItem(g,false);if(Boolean(a)&&a.isLoaded()&&a.isVideo()){var d=a.element;(d.paused||d.ended)&&d.play()}this._tryIterateToNextItem()};a.endAutoPlay=function(e){Jx.log.info("PlayToController::endAutoPlay");var f=this._dataAdaptor.objectIdToIndex(this._currentItemInfo.itemObjectId),d=this._highResItemPrefetcher.getItem(f,false);if(Boolean(d)&&d.isLoaded()&&d.isVideo()){var a=d.element;if(e)!a.paused&&!a.ended&&a.pause();a.loop=false}this._coordinator.setCommandStage(b.autoPlayButton,b.startAutoPlay);this._playToPlaybackManager.setNextItem(null);if(this._inAutoPlay){this._enteredManualMode=true;this._view&&this._view.setMode(c.PlayToViewMode.manual);this._inAutoPlay=false;this._beginAutoPlayWhenFirstItemIsReady=false;this._clearIterateTimer()}};a.onThumbsStripInput=function(b){Jx.log.info("PlayToController::onThumbsStripInput");if(!this._inAutoPlay)return;var a=false;switch(b.type){case"mousedown":case"touchdown":a=true;break;case"keydown":switch(b.key){case"Up":case"Down":case"Left":case"Right":case"Home":case"End":case"PageUp":case"PageDown":case"Enter":case"Spacebar":a=true}}if(a){Jx.log.info("PlayToController::onThumbsStripInput: Canceling autoPlay");this.endAutoPlay(false)}};a.keyPress=function(a){Jx.log.info("PlayToController::keyPress");switch(a.key){case"Esc":Jx.log.info("PlayToController::keyPress ESC");this._coordinator.isCommandEnabled(b.navigateBack)&&this._coordinator.doCommand(b.navigateBack,d.CommandSurface.keyboardShortcut,null,null);break;case"F12":Jx.log.info("PlayToController::keyPress F12");!this._inAutoPlay&&this.startAutoPlay()}};a.isObjectIdKnownError=function(a){return this._knownBadObjectIds[a]};a.onHighResImageLoaded=function(b){var a=b.getObjectId();Jx.log.info("PlayToController::onHighResImageLoaded  objectId: "+a);if(this._inAutoPlay)this._tryIterateToNextItem();else a===this._currentItemInfo.itemObjectId&&this._playHighResItem(a)};a.onHighResImageError=function(a,b){var c=a.getObjectId();Jx.log.info("PlayToController::onHighResImageError  objectId: "+c);this._onItemErrorHelper(a,b)};a.onHighResVideoCanPlayThrough=function(b){var a=b.getObjectId();Jx.log.info("PlayToController::onHighResVideoCanPlayThrough  objectId: "+a);if(this._inAutoPlay)this._tryIterateToNextItem();else a===this._currentItemInfo.itemObjectId&&this._playHighResItem(a)};a.onHighResVideoError=function(a,b){var c=a.getObjectId();Jx.log.info("PlayToController::onHighResVideoError  objectId: "+c);this._onItemErrorHelper(a,b)};a.onHighResVideoEnded=function(a){var c=a.getObjectId();Jx.log.info("PlayToController::onHighResVideoEnded  objectId: "+c);if(a.getObjectId()===this._currentItemInfo.itemObjectId)this._viewEnabled&&this._coordinator.setCommandStage(b.playPause,b.play)};a.onVideoPlay=function(c){PhotoViewer.log.perf("evPhotoViewer_PlayTo_Play_End",{emptyValue:true});var a=c.getObjectId();Jx.log.info("PlayToController::onHighResVideoPlay  objectId: "+a);a===this._currentItemInfo.itemObjectId&&this._viewEnabled&&this._coordinator.setCommandStage(b.playPause,b.pause)};a.onVideoPause=function(c){PhotoViewer.log.perf("evPhotoViewer_PlayTo_Pause_End",{emptyValue:true});var a=c.getObjectId();Jx.log.info("PlayToController::onHighResVideoPause  objectId: "+a);a===this._currentItemInfo.itemObjectId&&this._viewEnabled&&this._coordinator.setCommandStage(b.playPause,b.play)};a._detectAutoIterate=function(a){if(a){if(this._uiInitiatedPlayPausePending){Jx.log.info("PlayToController::_detectAutoIterate resetting uiPlayPausePending state");this._uiInitiatedPlayPausePending=false}var b=a.getObjectId(),c=this._currentItemInfo.itemObjectId;if(b!==c){this._highResItemPrefetcher.releaseItem(c);this._currentItemInfo.set(b);var d=this._dataAdaptor.objectIdToIndex(b);Jx.log.info("PlayToController: Detected autoiteration. setting new currentItem. objectId: "+b+"    index: "+String(d));this._view&&this._view.setActiveItem(b,true);if(a.isVideo()){var e=a.element;if(e.paused||e.ended)this.onVideoPause(a);else this.onVideoPlay(a)}else if(a.isImage()){this._clearIterateTimer();this._setIterateTimer(i)}this._nextIndex=d;this._setNextIndex()}}};a._getDeviceName=function(){var a=this._playToPlaybackManager.getDeviceName();if(!a)a=Jx.res.getString("resid-playTo-backUpDeviceName");return a};a._initPlayToStatus=function(){var a="",c=Jx.res.getString("resid-playTo-statusTruncatedText"),b=this._getDeviceName();if(b)a=Jx.res.loadCompoundString("resid-playTo-headerTitleFmt",b);else a=c;var f=this._coordinator.mode;function e(a){return a!==f}if(!Boolean(this._playToStatusView))this._playToStatusView=new PhotoViewer.PlayToStatusView;var g=this;function d(a){return g._playToStatusView.getStatusFlyoutText(b,a)}this._currentPlayToStatus=this._component.addStatus("PlayTo-1",a,c,e,null,d)};a._onItemErrorHelper=function(a,c){var b=a.getObjectId();this._view&&this._view.setErrorState(b,c);this._knownBadObjectIds[b]=c;if(this._inAutoPlay)if(this._currentItemInfo.itemObjectId===a.getObjectId())this._tryIterateToNextItem();else this._trySkipMediaErrors();else a.getObjectId()===this._currentItemInfo.itemObjectId&&this._beginAutoPlayWhenFirstItemIsReady&&this.startAutoPlay();var d=this._dataAdaptor.objectIdToObject(b);d&&d.getProperties(["sourceType","filename"],function(i,e){var b=PhotoViewer.DataHubHelpers.tryLookupPropertiesInMap(e,["sourceType","filename"]);if(b){var d=b.filename,c=d.lastIndexOf(".");if(c!==-1){var h=d.substring(c),f=b.sourceType,g=a.element.errorCode;Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.Photo.playToItemFailure,h,f,g)}}})};a._playHighResItem=function(a,i){var h=this._dataAdaptor.objectIdToIndex(a),j=this._dataAdaptor.objectIdToObject(a);Jx.log.info("PlayToController::_playHighResItem  index: "+String(h)+"  objectId: "+a);if(a!==this._currentItemInfo.itemObjectId){var f=this._dataAdaptor.objectIdToIndex(this._currentItemInfo.itemObjectId);if(Jx.isValidNumber(f)){var g=this._highResItemPrefetcher.getItem(f,false);if(g.isVideo()){var d=g.element;!d.paused&&d.pause()}}this._currentItemInfo.set(a)}if(this._viewEnabled){this._view.setActiveItem(a,this._inAutoPlay);this._dataAdaptor.setActiveItem(a)}var c=this._highResItemPrefetcher.getItem(h,Boolean(i)),e=c.element;if(c.isLoaded()&&this._connectedToDevice){Jx.log.info("PlayToController::_playHighResItem - item is loaded. Sending to device.");this._playToPlaybackManager.showItem(e);if(this._beginAutoPlayWhenFirstItemIsReady){Jx.log.info("PlayToController::_playHighResItem - first item is ready; begining autoplay");this.startAutoPlay();this._beginAutoPlayWhenFirstItemIsReady=false}if(c.isVideo()){var b=e;(b.paused||b.ended)&&b.play()}}};a._setCommanding=function(){this._coordinator.beginBatchCommandingUpdate();this._setCommand(b.autoPlayButton,d.CommandEnableProperties.viewIsPlayTo,this._toggleAutoPlayHandler);this._coordinator.setCommandStage(b.autoPlayButton,h?b.stopAutoPlay:b.startAutoPlay);this._setCommand(b.playPause,d.CommandEnableProperties.viewIsPlayTo|d.CommandEnableProperties.activeItemIsVideo,this._togglePlayPauseHandler);this._coordinator.setCommandStage(b.playPause,b.pause);this._coordinator.endBatchCommandingUpdate()};a._setCommand=function(b,a,c){this._coordinator.addCommand(b,a,d.CommandEnableProperties.none,d.CommandEnableProperties.none,d.ExpectedActionableItems.none,true,c)};a._toggleAutoPlayHandler=function(a){Jx.log.info("PlayToController::_toggleAutoPlayHandler");if(a===b.startAutoPlay){Jx.log.info("PlayToController::_toggleAutoPlayHandler::startAutoPlay");this.startAutoPlay()}else if(a===b.stopAutoPlay){Jx.log.info("PlayToController::_toggleAutoPlayHandler::stopAutoPlay");this.endAutoPlay(true)}return null};a._togglePlayPauseHandler=function(c){Jx.log.info("PlayToController::_togglePlayPauseHandler");var a=this._playToPlaybackManager.getCurrentItem();if(Boolean(a)&&a.tagName==="VIDEO")if(c===b.play){Jx.log.info("PlayToController::_togglePlayPauseHandler::playVideo");if(a.paused||a.ended){PhotoViewer.log.perf("evPhotoViewer_PlayTo_Play_Start",{emptyValue:true});this._uiInitiatedPlayPausePending=true;a.play()}}else if(c===b.pause){Jx.log.info("PlayToController::_togglePlayPauseHandler::pauseVideo");if(!a.paused){this._uiInitiatedPlayPausePending=true;PhotoViewer.log.perf("evPhotoViewer_PlayTo_Pause_Start",{emptyValue:true});this.endAutoPlay(true)}}return null};a._setIterateTimer=function(a){Jx.log.info("PlayToController::_setIterateTimer   duration: "+String(a));var b=this;if(this._iterateTimerId===e){if(!this._iterateTimerHandler)this._iterateTimerHandler=function(){b._iterateTimerFired()};this._iterateTimerId=window.setTimeout(this._iterateTimerHandler,a)}else Jx.log.info("PlayToController::_setIterateTimer   iterate timer not set because a timer is already active")};a._clearIterateTimer=function(){if(this._iterateTimerId!==e){window.clearTimeout(this._iterateTimerId);this._iterateTimerId=e}};a._iterateTimerFired=function(){Jx.log.info("PlayToController::_iterateTimerFired");this._iterateTimerId=e;this._currentItemInfo.completed=true;this._inAutoPlay&&this._tryIterateToNextItem()};a._setNextIndex=function(){var a=this._dataAdaptor.count;if(!Jx.isValidNumber(this._nextIndex))this._nextIndex=0;else if(this._nextIndex+1>=a)this._nextIndex=0;else this._nextIndex=this._nextIndex+1};a._trySkipMediaErrors=function(){var c=this._dataAdaptor.indexToObject(this._nextIndex),a=this._highResItemPrefetcher.getItem(this._nextIndex,false);Jx.log.info("PlayToController::_trySkipMediaErrors  nextIndex: "+String(this._nextIndex)+"  nextObjectId: "+a.getObjectId());if(this._firstErrorSearchIndex===f){this._firstErrorSearchIndex=this._nextIndex;this._errorSearchWrappedAround=false}if(!a.isPlaceholder()&&a.isError())for(;;){this._setNextIndex();if(this._nextIndex===0)this._errorSearchWrappedAround=true;if(this._errorSearchWrappedAround&&this._nextIndex>=this._firstErrorSearchIndex){Jx.log.info("PlayToController::_trySkipMediaErrors  Every item has errored. Giving up.");this._firstErrorSearchIndex=f;this._errorSearchWrappedAround=false;this.endAutoPlay(false);break}var b=this._dataAdaptor.indexToObjectId(this._nextIndex);if(this._knownBadObjectIds[b])Jx.log.info("PlayToController::_trySkipMediaErrors  Next item ( index: "+String(this._nextIndex)+", objectId: "+b+") is in a known error state. Trying another...");else{this._highResItemPrefetcher.releaseItem(a.getObjectId());a=this._highResItemPrefetcher.getItem(this._nextIndex,false);Jx.log.info("PlayToController::_trySkipMediaErrors   Trying another item.  nextIndex: "+String(this._nextIndex)+"  nextObjectId: "+a.getObjectId());if(a.isError())Jx.log.info("PlayToController::::_trySkipMediaErrors  Next item is in error state. Trying another...");else if(a.isPlaceholder()){Jx.log.info("PlayToController::_trySkipMediaErrors  Next item is a placeholder. Waiting for future status events.");break}else if(a.isLoaded()){Jx.log.info("PlayToController::_trySkipMediaErrors  Next item is loaded. Attempting to itetate to it.");this._tryIterateToNextItem();break}else{Jx.log.info("PlayToController::_trySkipMediaErrors  Next item is not loaded/errored. Waiting for future status events.");break}}}};a._tryIterateToNextItem=function(){Jx.log.info("PlayToController::_tryIterateToNextItem");if(!this._inAutoPlay)return;var p,n,h,a=false,g,m=this._nextIndex,o=this._dataAdaptor.indexToObject(m),c=this._highResItemPrefetcher.getItem(m,false),d=false,l=false;if(this._currentItemInfo.completed)a=true;else{g=this._currentItemInfo.itemObjectId;p=this._dataAdaptor.objectIdToObject(g);n=this._dataAdaptor.objectIdToIndex(g);h=this._highResItemPrefetcher.getItem(n,false)}if(!this._currentItemInfo.completed&&h.isError())a=true;Jx.log.info("PlayToController::_tryIterateToNextItem   curItemId: "+g+"    curHighResElementDone: "+String(a));if(!a&&h.isLoaded())if(h.isImage()&&this._currentItemInfo.imageRendered&&this._iterateTimerId===e)if(p.type==="asset.photo"&&m!==n){Jx.log.info("PlayToController::_tryIterateToNextItem   Cur item has been imageRendered. Setting iterate next timer.");this._setIterateTimer(i)}else Jx.log.info("PlayToController::_tryIterateToNextItem   Not setting iterate next timer because next item is current item (and a photo, as well)");if(c.isLoaded())d=true;else if(c.isError())l=true;var k=o?o.id:"";Jx.log.info("PlayToController::_tryIterateToNextItem   nextItemId: "+k+"    nextHighResElementReady: "+String(d)+"  nextHighResElementError: "+String(l));if(d)if(c.isVideo()&&k===this._currentItemInfo.itemObjectId){var t=c.element;t.loop=true}else this._playToPlaybackManager.setNextItem(c.element);if(a)if(d){var s=this._currentItemInfo.itemObjectId!==k,u=this._currentItemInfo.itemObjectId;this._playHighResItem(k);s&&this._highResItemPrefetcher.releaseItem(u);this._setNextIndex();for(var b=this._nextIndex,v=this._dataAdaptor.count,q=0;q<j;q++){var r=this._dataAdaptor.indexToObjectId(b);!this._knownBadObjectIds[r]&&this._highResItemPrefetcher.getItem(b,false);b=b+1<v?b+1:0}this._firstErrorSearchIndex=f;this._errorSearchWrappedAround=false}else l&&this._trySkipMediaErrors()};a.getIndicesToUpdateAfterNotificationsCompleted=function(){var a=[];if(this._inAutoPlay){a[0]={originalIndex:this._nextIndex,updatedIndex:null};if(this._firstErrorSearchIndex!==f)a[1]={originalIndex:this._firstErrorSearchIndex,updatedIndex:null}}return a};a.updateIndicesAfterNotifications=function(){if(this._inAutoPlay){var c=this._cachedIndexNotificationHelper,d=c.indicesToUpdate,b=d[0];if(Boolean(b)&&this._nextIndex!==b.updatedIndex)this._nextIndex=b.updatedIndex;var a=d[1];if(Boolean(a)&&this._firstErrorSearchIndex!==a.updatedIndex)this._firstErrorSearchIndex=a.updatedIndex;var e=this._dataAdaptor.objectIdToIndex(this._currentItemInfo.itemObjectId);if(!Jx.isValidNumber(e))this._currentItemInfo.completed=true;if(c.removesOccurred){this._view&&this._view.updateItemCount(this._dataAdaptor.count);this._tryIterateToNextItem()}}};a._viewEnabled=false;a._connectedToDevice=false;a._view=null;a._playToPlaybackManager=null;a._dataAdaptor=null;a._dataHub=null;a._component=null;a._coordinator=null;a._view=null;a._currentItemInfo=null;a._uiInitiatedPlayPausePending=false;a._nextIndex=null;a._inAutoPlay=false;a._iterateTimerId=e;a._iterateTimerHandler=null;a._beginAutoPlayWhenFirstItemIsReady=false;a._firstErrorSearchIndex=f;a._errorSearchWrappedAround=false;a._knownBadObjectIds={};a._playToStatusView=null;a._currentPlayToStatus=null;a._enteredManualMode=false})();(function(){var d=window.PhotoViewer,c=Windows.Media.PlayTo.PlayToConnectionState,f="playToSource";d.PlayToConnectionInfo=function(c,f,b){Jx.log.info("PlayToPlaybackManager::PlayToConnectionInfo created connection "+String(c));this.connectionId=c;this._site=f;this.playToSourceElement=b;var e=b,d=e.msPlayToSource;this._playToStateChangedHandler=this._playToStateChangedHandler.bind(this);this._playToTransferredHandler=this._playToTransferredHandler.bind(this);this._playToErrorHandler=this._playToErrorHandler.bind(this);var a=d.connection;a.addEventListener("statechanged",this._playToStateChangedHandler);a.addEventListener("transferred",this._playToTransferredHandler);a.addEventListener("error",this._playToErrorHandler);if(this.isVideo()){this._videoEndedHandler=this._videoEndedHandler.bind(this);b.addEventListener("ended",this._videoEndedHandler,false)}this.msPlayToSource=d};var b=d.PlayToConnectionInfo.prototype;b.destroy=function(){Jx.log.info("PlayToConnectionInfo::destroy - taking down connection "+String(this.connectionId));var a=this.msPlayToSource.connection;a.removeEventListener("statechanged",this._playToStateChangedHandler);a.removeEventListener("transferred",this._playToTransferredHandler);a.removeEventListener("error",this._playToErrorHandler);this.msPlayToSource.next=null;this.msPlayToSource=null;this.nextSet=false;this.pendingTransfer=false;this.isVideo()&&this.playToSourceElement.removeEventListener("ended",this._videoEndedHandler,false);this.playToSourceElement=null;this._site=null};b.setNext=function(a){if(a)this.msPlayToSource.next=a.msPlayToSource;else this.msPlayToSource.next=null;this.nextSet=Boolean(a);this.pendingTransfer=false};b.isVideo=function(){return Boolean(this.playToSourceElement)&&this.playToSourceElement.tagName==="VIDEO"};b.isImage=function(){return Boolean(this.playToSourceElement)&&this.playToSourceElement.tagName==="IMG"};b._playToStateChangedHandler=function(a){this._site&&this._site.playToStateChangedHandler(a,this)};b._playToTransferredHandler=function(a){this._site&&this._site.playToTransferredHandler(a,this)};b._playToErrorHandler=function(a){this._site&&this._site.playToErrorHandler(a,this)};b._videoEndedHandler=function(){if(this.nextSet)this.pendingTransfer=true};b.connectionId=-1;b.playToSourceElement=null;b.msPlayToSource=null;b.rendered=false;b.pendingTransfer=false;b.nextSet=false;b._site=null;d.PlayToPlaybackManager=function(b){this._site=b;var a=Windows.Media.PlayTo.PlayToManager.getForCurrentView();this.playToSourceSelected=this.playToSourceSelected.bind(this);a.addEventListener("sourceselected",this.playToSourceSelected)};var a=d.PlayToPlaybackManager.prototype;a.shutdown=function(){var c=Windows.Media.PlayTo.PlayToManager.getForCurrentView();c.removeEventListener("sourceselected",this.playToSourceSelected);for(var b=Object.keys(this._cachedConnectionInfo),a=0;a<b.length;a++)this._destroyConnectionInfo(this._cachedConnectionInfo[b[a]]);this._curPlayToConnectionInfo=null;this._nextPlayToConnectionInfo=null;this._pendingDestroyConnectionInfo=null;this._lastPlayToConnectionInfoForSourceRequest=null;this._site=null;this._lastConnectionNum=-1;this._isShutdown=true;this._deviceName=""};a.handlePlayTo=function(e){Jx.log.info("PlayToPlaybackManager::handlePlayTo");this._lastConnectionNum++;var c=this._lastConnectionNum,b=document.createElement("video");b.src="";b.id=f+String(c);var a=new d.PlayToConnectionInfo(c,this,b);this._noteConnectionForDestruction(this._lastPlayToConnectionInfoForSourceRequest);this._lastPlayToConnectionInfoForSourceRequest=a;this._cacheConnectionInfo(a);e.sourceRequest.setSource(a.msPlayToSource)};a.setNextItem=function(b){if(Boolean(this._curPlayToConnectionInfo)&&this._curPlayToConnectionInfo.playToSourceElement!==b&&(!this._nextPlayToConnectionInfo||this._nextPlayToConnectionInfo.playToSourceElement!==b)){var a=null;if(b)if(Boolean(this._pendingDestroyConnectionInfo)&&this._pendingDestroyConnectionInfo.playToSourceElement===b){a=this._pendingDestroyConnectionInfo;this._pendingDestroyConnectionInfo=null;Jx.log.info("PlayToPlaybackManager::setNextItem saved connection from pending destruction. id: "+String(a.connectionId))}else{this._lastConnectionNum++;a=new d.PlayToConnectionInfo(this._lastConnectionNum,this,b);this._cacheConnectionInfo(a);Jx.log.info("PlayToPlaybackManager::setNextItem created new connection with id: "+String(a.connectionId))}else Jx.log.info("PlayToPlaybackManager::setNextItem unsetting next for connection with id "+String(this._curPlayToConnectionInfo.connectionId));this._curPlayToConnectionInfo.setNext(a);d.log.perf("evPhotoViewer_PlayTo_SetNextItemOnCurrentSource",{emptyValue:true});if(Boolean(this._nextPlayToConnectionInfo)&&this._nextPlayToConnectionInfo!==this._curPlayToConnectionInfo){Jx.log.info("PlayToPlaybackManager::setNextItem marking next item for destruction. connectionId: "+String(this._nextPlayToConnectionInfo.connectionId));this._noteConnectionForDestruction(this._nextPlayToConnectionInfo)}this._nextPlayToConnectionInfo=a}};a.showItem=function(a){if(Boolean(this._curPlayToConnectionInfo)&&this._curPlayToConnectionInfo.playToSourceElement!==a){Jx.log.info("PlayToPlaybackManager::showItem");d.log.perf("evPhotoViewerPlayTo_ItemTransfer_begin",{emptyValue:true});this.setNextItem(a);Jx.log.info("PlayToPlaybackManager::showItem next connectionId: "+String(this._nextPlayToConnectionInfo.connectionId));this._curPlayToConnectionInfo.msPlayToSource.playNext();this._noteConnectionForDestruction(this._curPlayToConnectionInfo);this._curPlayToConnectionInfo=this._nextPlayToConnectionInfo;this._nextPlayToConnectionInfo=null}};a.getCurrentItem=function(){var a=this._curPlayToConnectionInfo;return a?a.playToSourceElement:null};a.getDeviceName=function(){var a=this._deviceName;return a?this._deviceName:""};a.playToSourceSelected=function(c){Jx.log.info("PlayToPlaybackManager::playToSourceSelected");for(var d=this._lastPlayToConnectionInfoForSourceRequest,f=this._cachedConnectionInfo,e=Object.keys(this._cachedConnectionInfo),a,b=0;b<e.length;b++){a=f[e[b]];a!==d&&this._destroyConnectionInfo(a)}this._curPlayToConnectionInfo=d;this._nextPlayToConnectionInfo=null;this._pendingDestroyConnectionInfo=null;this._lastPlayToConnectionInfoForSourceRequest=null;this._deviceName=c.friendlyName;this._site.playToSourceSelected(c)};var e=function(b){var a;switch(b){case c.connected:a="Connected";break;case c.disconnected:a="Disconnected";break;case c.rendering:a="Rendering";break;default:a="Unknown"}a+=" ("+String(b)+")";return a};a.playToStateChangedHandler=function(b,a){if(this._isShutdown)return;Jx.log.info("PlayToPlaybackManager::playToStateChangedHandler   connectionId: "+String(a.connectionId)+"   previousState: "+e(b.previousState)+"   currentState: "+e(b.currentState));if(!this._curPlayToConnectionInfo&&b.currentState===c.connected)this._curPlayToConnectionInfo=a;if(a!==this._curPlayToConnectionInfo&&b.currentState===c.rendering){this._noteConnectionForDestruction(this._curPlayToConnectionInfo);this._curPlayToConnectionInfo=a}if(a===this._curPlayToConnectionInfo){b.currentState===c.rendering&&d.log.perf("evPhotoViewerPlayTo_ItemTransfer_end",{emptyValue:true});switch(b.currentState){case c.connected:this._detectDMRPause(b,a);this._site.playToConnectionConnected(a.playToSourceElement);break;case c.rendering:this._detectDMRPlay(b,a);a.rendered=true;this._site.playToConnectionRendering(a.playToSourceElement);break;case c.disconnected:this._site.playToConnectionDisconnected(a.playToSourceElement)}}if(Boolean(this._curPlayToConnectionInfo)&&this._curPlayToConnectionInfo===a&&b.currentState===c.disconnected){this._noteConnectionForDestruction(this._curPlayToConnectionInfo);this._curPlayToConnectionInfo=null}};a.playToTransferredHandler=function(e,c){if(this._isShutdown)return;Jx.log.info("PlayToPlaybackManager::playToTransferredHandler connectionId: "+String(c.connectionId));if(Boolean(this._curPlayToConnectionInfo)&&this._curPlayToConnectionInfo===c){Jx.log.info("PlayToPlaybackManager::playToTransferredHandler tearing down old connectionInfo object.");var d=e.currentSource,b=this._nextPlayToConnectionInfo,a=this._pendingDestroyConnectionInfo;if(Boolean(b)&&b.msPlayToSource===d){this._curPlayToConnectionInfo=b;this._nextPlayToConnectionInfo=null}else if(Boolean(a)&&a.msPlayToSource===d){Jx.log.info("Recovered connection from pending destruction. id: "+String(a.connectionId));this._curPlayToConnectionInfo=a;this._pendingDestroyConnectionInfo=null}this._destroyConnectionInfo(c);if(this._curPlayToConnectionInfo){Jx.log.info("Connection transferred to connection with id: "+String(this._curPlayToConnectionInfo.connectionId));this._site.playToConnectionChanged(this._curPlayToConnectionInfo.playToSourceElement)}}};a.playToErrorHandler=function(a,b){if(this._isShutdown)return;Jx.log.info("PlayToPlaybackManager::_playToErrorHandler connectionId: "+String(b.connectionId)+"  errorCode: "+String(a.code)+"   errorMessage: "+a.message);this._site.playToError(a.code,a.message,b.playToSourceElement)};a._noteConnectionForDestruction=function(a){if(Boolean(a)&&this._pendingDestroyConnectionInfo!==a){this._destroyConnectionInfo(this._pendingDestroyConnectionInfo);this._pendingDestroyConnectionInfo=a}};a._detectDMRPlay=function(a,b){if(a.previousState===c.connected&&a.currentState===c.rendering)b.rendered&&this._site.playToConnectionPlay(b.playToSourceElement)};a._detectDMRPause=function(d,a){if(d.currentState===c.connected&&d.previousState===c.rendering){var b=false;if(a.isImage())b=true;else{var e=a.playToSourceElement;if(e.paused&&!a.pendingTransfer)b=true}b&&this._site.playToConnectionPause(a.playToSourceElement)}};a._cacheConnectionInfo=function(a){if(a)this._cachedConnectionInfo[a.connectionId]=a};a._destroyConnectionInfo=function(a){if(a&&this._cachedConnectionInfo[a.connectionId]){Jx.log.info("PlayToPlaybackManager::_destroyConnectionInfo destroyed connection "+String(a.connectionId));delete this._cachedConnectionInfo[a.connectionId];a.destroy()}};a._lastPlayToConnectionInfoForSourceRequest=null;a._curPlayToConnectionInfo=null;a._nextPlayToConnectionInfo=null;a._pendingDestroyConnectionInfo=null;a._site=null;a._lastConnectionNum=-1;a._isShutdown=false;a._deviceName="";a._cachedConnectionInfo={}})();(function(){var b=window.PhotoViewer,h=b.DataHubHelpers,e=b.ViewHelpers,j=WindowsLive.Photo.Viewer.DataModel,k=j.ObjectChangedEventFields,i=j.BlobResultQuality,c={none:"none",thumbnail:"thumbnail",media:"media"},s=465,r=85,n=function(){},d=n.prototype;d.itemType=null;d.itemThumbnailResultErrorCode=null;d.itemThumbnailResult=null;d.itemMediaResultErrorCode=null;d.itemMediaResult=null;d.itemObject=null;d.currentQualityLevel=c.none;d.itemCachedThumbnailResult=null;d.hasMediaCompleteCallback=null;d.renderedElement=null;d.synchronous=false;var t=function(a){if(a)a.placeholder="true"},o=function(a){if(a)a.inLoadedState="true"},g=function(a,b){if(a){a.inErrorState="true";a.errorCode=b}};b.PlayToHighResItemInfo=function(a){this.element=a};var f=b.PlayToHighResItemInfo.prototype;f.setError=function(a){var b=this.element;g(b,a)};f.isPlaceholder=function(){return Boolean(this.element)&&Boolean(this.element.placeholder)};f.isLoaded=function(){return Boolean(this.element)&&Boolean(this.element.inLoadedState)};f.isError=function(){return Boolean(!this.element)||Boolean(this.element.inErrorState)};f.isVideo=function(){return Boolean(this.element)&&this.element.tagName==="VIDEO"};f.isImage=function(){return Boolean(this.element)&&this.element.tagName==="IMG"};f.getObjectId=function(){return this.element?this.element.itemObjectId:null};f.element=null;b.PlayToHighResItemPrefetcher=function(c,b,a){this._dataHub=c;this._callback=b;this._dataAdaptor=a;this._addObjectModifiedHandler()};var a=b.PlayToHighResItemPrefetcher.prototype;a.isEnabled=function(){return Boolean(this._dataAdaptor)&&!this._dataAdaptor.isDeactivated()&&Boolean(this._callback)};a.getItem=function(h,f){var c=this._dataAdaptor.indexToObjectId(h),d=this._cachedItemInfo,a=d[c];if(!a){var g=this._highResItemRenderer(c);a=new b.PlayToHighResItemInfo(g);d[c]=a}if(f){var e;for(e in d)e!==c&&this.releaseItem(e)}return a};a.getItemFromElement=function(d){var b=this._cachedItemInfo,a,c;for(c in b){a=b[c];if(a.element===d)return a}return null};a.releaseItem=function(b){var c=this._cachedItemInfo[b];if(c){var a=c?c.element:null;if(a.tagName==="VIDEO"){a.removeEventListener("canplaythrough",this._videoCanPlayThroughCallback,false);a.removeEventListener("ended",this._videoEndedCallback,false);a.removeEventListener("error",this._videoErrorCallback,false);a.removeEventListener("play",this._videoPlayCallback,false);a.removeEventListener("pause",this._videoPauseCallback,false)}else{a.removeEventListener("error",this._imageErrorCallback,false);a.removeEventListener("load",this._imageLoadCallback,false)}a.src="";var d=this._cachedBlobs[b];if(d){this._cachedBlobs[b]=null;URL.revokeObjectURL(d)}delete this._cachedItemInfo[b]}};a.shutdown=function(){if(this._objectModifiedHandler){this._dataAdaptor.removeObjectModifiedHandler(this._objectModifiedHandler);this._objectModifiedHandler=null}this._dataAdaptor=null;for(a in this._cachedItemInfo)this.releaseItem(a);var b=this._cachedBlobs,a;for(a in b)URL.revokeObjectURL(b[a]);this._cachedBlobs={};this._cachedRenderInfo={};this._dataHub=null;this._callback=null};a._isItemInfoValid=function(a){if(a){var b=a.getObjectId();if(Boolean(b)&&Jx.isValidNumber(this._dataAdaptor.objectIdToIndex(b)))return true}return false};var l=function(a,b){return b.getMediaAsync(j.GetMediaAsyncFlags.largestAvailableLocally).then(function(b){Jx.log.info("PlayToHighResPrefetcher::_highResItemRenderer_getMediaAsyncComplete success");a.itemThumbnailResultErrorCode=0;a.itemThumbnailResult=b;a.currentQualityLevel=c.media}).then(null,function(b){Jx.log.info("PlayToHighResPrefetcher::_highResItemRenderer_getMediaAsyncComplete error");a.itemThumbnailResultErrorCode=b.number||-1})};a._highResItemRenderer=function(d){Jx.log.info("PlayToHighResPrefetcher::_highResItemRenderer");var a=new n;a.renderedElement=null;a.synchronous=true;a.itemObject=this._dataAdaptor.objectIdToObject(d);var e=this;if(a.itemObject){a.itemType=a.itemObject.type;var b=function(){!a.synchronous&&e._highResRendererHelper(a)};if(a.itemType==="asset.photo"){Jx.log.info("PlayToHighResPrefetcher::_highResItemRenderer rendering photo");a.itemObject.getProperties(["hasMedia"],function(k,g){Jx.log.info("PlayToHighResPrefetcher::_highResItemRenderer_hasMediaPropertyAvailable");var j=Boolean(h.tryLookupPropertyInMap(g,"hasMedia"));if(j)l(a,a.itemObject).then(b,b).done();else{var f=function(){Jx.log.info("PlayToHighResPrefetcher::_highResItemRenderer_hasMediaOrTimeout");if(a.currentQualityLevel===c.media){b();return}else{a.itemThumbnailResultErrorCode=0;a.itemThumbnailResult=a.itemCachedThumbnailResult;b()}a.currentQualityLevel=c.none;a.itemCachedThumbnailResult=null;a.hasMediaCompleteCallback=null;if(e._cachedRenderInfo[d])delete e._cachedRenderInfo[d]};a.itemObject.getThumbnailAsync(0,0,null,false).then(function(b){if(a.currentQualityLevel!==c.media){var j="";Jx.log.info("PlayToHighResPrefetcher::_highResItemRenderer_getLargestThumbnailComplete "+j);a.itemCachedThumbnailResult=b;a.currentQualityLevel=b.data?c.thumbnail:c.none;e._cachedRenderInfo[d]=a;if(a.currentQualityLevel===c.thumbnail){var f=b.quality;if(f===i.highQuality||f===i.lowQualityNothingPending)return WinJS.Promise.wrap(0)}var h=WinJS.Promise.timeout(1e4),g=new WinJS.Promise(function(b){Jx.log.info("PlayToHighResPrefetcher::_highResItemRenderer_hasMediaPropertyChangedCallback_initialization");a.hasMediaCompleteCallback=b});return WinJS.Promise.any([h,g])}return WinJS.Promise.wrap(0)}).done(f,f)}})}else if(a.itemType==="asset.video"){Jx.log.info("PlayToHighResPrefetcher::_highResItemRenderer rendering video");a.itemObject.getMediaAsync(j.GetMediaAsyncFlags.largestAvailableLocally).then(function(b){a.itemMediaResultErrorCode=0;a.itemMediaResult=b},function(b){a.itemMediaResultErrorCode=b.number||-1}).done(b,b)}}a.synchronous=false;this._highResRendererHelper(a);return a.renderedElement};a._highResRendererHelper=function(a){var c=null;if(a.itemObject)c=a.itemType;if(c==="asset.photo"){if(!a.renderedElement)a.renderedElement=document.createElement("img");!a.renderedElement.rendered&&Jx.isValidNumber(a.itemThumbnailResultErrorCode)&&this._highResImageRendererHelper(a)}else if(c==="asset.video"){if(!a.renderedElement)a.renderedElement=document.createElement("video");!a.renderedElement.rendered&&Jx.isValidNumber(a.itemMediaResultErrorCode)&&this._highResVideoRendererHelper(a)}if(!a.renderedElement.itemObjectId)a.renderedElement.itemObjectId=a.itemObject.id;if(a.renderedElement.inErrorState){var b=this;window.msSetImmediate(function(){var c=b.getItemFromElement(a.renderedElement);if(b._isItemInfoValid(c)&&Boolean(b._callback))b._callback.onHighResImageError(c,a.renderedElement.errorCode)})}};a._highResImageRendererHelper=function(d){var c=d.renderedElement,j=d.itemThumbnailResultErrorCode,f=d.itemThumbnailResult;if(!this._imageLoadCallback)this._imageLoadCallback=e.createConditionalCallbackProxy(a.isEnabled,function(c){var b=c.target;o(b);var a=this.getItemFromElement(b);if(this._isItemInfoValid(a))this._callback.onHighResImageLoaded(a)},this);if(!this._imageErrorCallback)this._imageErrorCallback=e.createConditionalCallbackProxy(a.isEnabled,function(e){var d=e.target,a=b.PlayToHighResItemError.imgTagError;g(d,a);var c=this.getItemFromElement(d);if(this._isItemInfoValid(c))this._callback.onHighResImageError(c,a)},this);c.addEventListener("error",this._imageErrorCallback,false);c.addEventListener("load",this._imageLoadCallback,false);if(j!==0||f.quality===i.error)g(c,b.PlayToHighResItemError.dataLayerFetchError);else if(!h.isBlobOperationResultValid(f))g(c,b.PlayToHighResItemError.fetchTimeout);else if(f.dimensions.width<=s&&f.dimensions.height<=r)this._determineIfQualityTooLow(d);else this._finalizeItemRender(d);c.rendered="true"};a._finalizeItemRender=function(a){var b=a.itemThumbnailResult,c=a.renderedElement,d="";Jx.log.info("PlayToHighResPrefetcher::_highResImageRendererHelper rendering image   "+d);c.src=h.getSourceFromBlobOperationResult(b,false)};a._determineIfQualityTooLow=function(a){var e=a.itemThumbnailResult.dimensions,i=a.renderedElement,m=e.width,l=e.height,k=a.itemObject,c=this,j=true;function f(f,e){if(m!==f||l!==e){g(i,b.PlayToHighResItemError.qualityTooLow);if(!j){var d=c.getItemFromElement(i);if(c._isItemInfoValid(d))c._callback.onHighResImageError(d,b.PlayToHighResItemError.qualityTooLow)}}else c._finalizeItemRender(a)}var d=k.dimensions;if(d)f(d.width,d.height);else k.getProperties(["width","height"],function(b,a){a&&f(Number(h.tryLookupPropertyInMap(a,"width")),Number(h.tryLookupPropertyInMap(a,"height")))});j=false};a._highResVideoRendererHelper=function(d){var c=d.renderedElement,k=d.itemMediaResultErrorCode,f=d.itemMediaResult;c.preload="auto";c.controls=true;if(!this._videoCanPlayThroughCallback)this._videoCanPlayThroughCallback=e.createConditionalCallbackProxy(a.isEnabled,function(c){var b=c.target;o(b);var a=this.getItemFromElement(b);if(this._isItemInfoValid(a))this._callback.onHighResVideoCanPlayThrough(a)},this);if(!this._videoEndedCallback)this._videoEndedCallback=e.createConditionalCallbackProxy(a.isEnabled,function(c){var a=c.target,b=this.getItemFromElement(a);if(this._isItemInfoValid(b)){a.endedHACK=true;this._callback.onHighResVideoEnded(b);a.endedHACK=false}},this);if(!this._videoErrorCallback)this._videoErrorCallback=e.createConditionalCallbackProxy(a.isEnabled,function(e){var f=e.target,d=this.getItemFromElement(f),h=e.target,a=h.error;if(this._isItemInfoValid(d)&&(!d.isLoaded()||a.code!==a.MEDIA_ERR_SRC_NOT_SUPPORTED)){var c;switch(a.code){case a.MEDIA_ERR_SRC_NOT_SUPPORTED:c=b.PlayToHighResItemError.videoTagSrcNotSupported;break;case a.MEDIA_ERR_ABORTED:c=b.PlayToHighResItemError.videoTagAborted;break;case a.MEDIA_ERR_NETWORK:c=b.PlayToHighResItemError.videoTagNetwork;break;case a.MEDIA_ERR_DECODE:c=b.PlayToHighResItemError.videoTagDecode;break;default:c=b.PlayToHighResItemError.errorUnknown}g(f,c);if(this._isItemInfoValid(d))this._callback.onHighResVideoError(d,c)}},this);if(!this._videoPlayCallback)this._videoPlayCallback=e.createConditionalCallbackProxy(a.isEnabled,function(b){var c=b.target,a=this.getItemFromElement(c);if(this._isItemInfoValid(a))this._callback.onVideoPlay(a)},this);if(!this._videoPauseCallback)this._videoPauseCallback=e.createConditionalCallbackProxy(a.isEnabled,function(b){var c=b.target,a=this.getItemFromElement(c);if(this._isItemInfoValid(a))this._callback.onVideoPause(a)},this);c.addEventListener("canplaythrough",this._videoCanPlayThroughCallback,false);c.addEventListener("ended",this._videoEndedCallback,false);c.addEventListener("error",this._videoErrorCallback,false);c.addEventListener("play",this._videoPlayCallback,false);c.addEventListener("pause",this._videoPauseCallback,false);c.oncontextmenu=e.returnFalse;if(k!==0||f.quality===i.error)g(c,b.PlayToHighResItemError.dataLayerFetchError);else if(!h.isBlobOperationResultValid(f))g(c,b.PlayToHighResItemError.fetchTimeout);else{var j=h.getSourceFromBlobOperationResult(f,true);c.src=j;this._cachedBlobs[d.itemObject.id]=j}c.rendered="true";return c};a._addObjectModifiedHandler=function(){var b=this,a={objectModified:function(d,h){var e=Boolean(h&k.media),f=Boolean(h&k.thumbnail);if(e||f){Jx.log.info("PlayToHighResItemPrefetcher::_objectModifiedHandler Encountered media or thumb change notif");var a=b._cachedRenderInfo[d];if(Boolean(a)){var g=b._dataAdaptor.objectIdToObject(d);e&&q(d,g,a);f&&a.currentQualityLevel!==c.media&&p(d,g,a)}}return false}};this._objectModifiedHandler=a;this._dataAdaptor.addObjectModifiedHandler(a)};var m=function(b){var a=b.hasMediaCompleteCallback;if(a){b.hasMediaCompleteCallback=null;a()}},p=function(d,b,a){b.getThumbnailAsync(0,0,null,false).then(function(b){var e="";Jx.log.info("PlayToHighResPrefetcher::_upgradeCachedThumbAndCompletePromise_getCurrentLargestThumbnailComplete "+e);a.itemCachedThumbnailResult=b;var d=b.quality;if(a.currentQualityLevel!==c.media&&(d===i.highQuality||d===i.lowQualityNothingPending)){a.currentQualityLevel=c.thumbnail;m(a)}}).done(null,function(){})},q=function(d,b,a){l(a,b).done(function(){a.currentQualityLevel===c.media&&m(a)})};a._dataHub=null;a._dataAdaptor=null;a._callback=null;a._cachedRenderInfo={};a._cachedItemInfo={};a._cachedBlobs={};a._objectModifiedHandler=null;a._imageLoadCallback=null;a._imageErrorCallback=null;a._videoCanPlayThroughCallback=null;a._videoEndedCallback=null;a._videoErrorCallback=null;a._videoPlayCallback=null;a._videoPauseCallback=null})();(function(){var c=window.PhotoViewer,b=c.PlayToHighResItemError;c.PlayToCustomItemRenderer=function(a,c,b){this._getActiveItemObjectId=a;this._isObjectIdKnownError=b;this._dataAdaptor=c;this._itemDivs={}};var a=c.PlayToCustomItemRenderer.prototype;a.takeOverRendering=function(d,g){var a=g.id;if(this._itemDivs[a]!==d){var c=document.createElement("div");Jx.addClass(c,"playTo-item");var e=this._getActiveItemObjectId(),b=null;if(e)b=this._dataAdaptor.objectIdToObject(e);Boolean(b)&&a===b.id&&this._styleItemOverlay(b,c,true);d.appendChild(c);this._itemDivs[a]=d;var f=this._isObjectIdKnownError(a);f&&this.setErrorState(a,f)}return WinJS.Promise.wrap(false)};a.itemOutOfScope=function(a){delete this._itemDivs[a]};a.invalidateAll=function(){this._itemDivs={}};a.shutdown=function(){this._getActiveItemObjectId=null;this._isObjectIdKnownError=null;this._itemDivs={};this._dataAdaptor=null};a._styleItemOverlay=function(b,a,c){if(c){Jx.addClass(a,"playTo-currentPlayToItem");b.type==="asset.video"&&Jx.addClass(a,"playTo-currentPlayToVideoItem");a.setAttribute("aria-selected","true")}else{Jx.removeClass(a,"playTo-currentPlayToItem");Jx.removeClass(a,"playTo-currentPlayToVideoItem");a.removeAttribute("aria-selected")}};a.setActiveState=function(b,c){var a=this._getElementFromObjectIdAndClass(b,"playTo-item"),d=this._dataAdaptor.objectIdToObject(b);a&&this._styleItemOverlay(d,a,c)};a.setErrorState=function(h,f){var a=this._getElementFromObjectIdAndClass(h,"playTo-item"),g=f!==PhotoViewer.PlayToHighResItemError.none;if(a)if(g&&a.childElementCount===0){var c;switch(f){case b.fetchTimeout:case b.dataLayerFetchError:case b.videoTagNetwork:c="resid-playTo-fileNotAvailableError";break;case b.errorUnknown:case b.imgTagError:case b.videoTagAborted:c="resid-playTo-genericFileError";break;case b.videoTagDecode:case b.videoTagSrcNotSupported:case b.playToConnectionDeviceError:c="resid-playTo-unableToPlayError"}if(c){Jx.addClass(a,"playTo-errorItem");var d=document.createElement("div");Jx.addClass(d,"playTo-errorMaskOverlay");a.appendChild(d);var e=document.createElement("div");Jx.addClass(e,"playTo-errorTextDiv");e.innerText=Jx.res.getString(c);d.appendChild(e)}}else!g&&a.childElementCount===1&&a.removeChild(a.firstElementChild)};a._getElementFromObjectIdAndClass=function(d,c){var b=this._itemDivs[d];if(b){var a=b.getElementsByClassName(c);if(a.length===1)return a[0]}return null};a._getActiveItemObjectId=null;a._isObjectIdKnownError=null;a._itemDivs=null;a._dataAdaptor=null})();(function(){var b=window.PhotoViewer;b.PlayToViewMode={loading:0,manual:1,autoPlay:2,none:3};var e=["evPhotoViewerPlayTo_ViewModeSwitched_Loading","evPhotoViewerPlayTo_ViewModeSwitched_Manual","evPhotoViewerPlayTo_ViewModeSwitched_AutoPlay"];b.PlayToStatusView=function(){};var c=b.PlayToStatusView.prototype;c.shutdown=function(){this._statusFlyoutHTML=null};c.getStatusFlyoutText=function(f,e){if(!this._statusFlyoutHTML||this._statusFlyoutHTML.childElementCount===0){this._statusFlyoutHTML=document.createElement("div");var b=document.createElement("div");b.innerHTML=Jx.res.loadCompoundString("resid-playTo-headerTitleFmt",f);b.className="status-flyout-header";this._statusFlyoutHTML.appendChild(b);var c=document.createElement("div");c.innerHTML=Jx.res.getString("resid-playTo-statusFlyoutText");c.className="status-flyout-plainText";this._statusFlyoutHTML.appendChild(c);var a=document.createElement("button");a.innerText=Jx.res.getString("resid-playTo-StatusFlyoutButton");a.addEventListener("click",d(e),false);this._statusFlyoutHTML.appendChild(a)}return this._statusFlyoutHTML};var d=function(a){return function(){var b=Windows.Media.PlayTo.PlayToManager;b.getForCurrentView();b.showPlayToUI();a()}};c._statusFlyoutHTML=null;b.PlayToView=function(){};var a=b.PlayToView.prototype;a.getMainViewUI=function(b,a){a.html+='<div id="'+b+'" class="moPho-clientComponent">';a.html+='        <div id="playTo-container" >            <header id="playTo-header" class="photoViewer-headerContainer photoViewer-header" aria-label="playTo-header">                <div id="playTo-header-title" class="photoViewer-headerPrimaryText" role="heading"></div>                <div id="playTo-header-count" class="photoViewer-headerSecondaryText"></div>            </header>            <div id="playTo-contents">                <div id="playTo-thumbsStripContainer" aria-label="playTo-thumbsStripContainer">                </div>            </div>        </div>    ';a.html+="</div>"};a.initialize=function(b,a,c){this._isUIShutdown=false;this._dataAdaptor=a;this._controllerCallbacks=c;this._initializeViewAndHookUpListeners(b);this._addEventListeners();this._activeItemId=null};a._initializeViewAndHookUpListeners=function(g){var c=this._thumbsStripContainer=document.getElementById("playTo-thumbsStripContainer"),e=this._dataAdaptor,a=this;this._customRenderer=new b.PlayToCustomItemRenderer(function(){return a._activeItemId},e,function(b){return a._controllerCallbacks.isObjectIdKnownError(b)});var h=new b.FilmstripLayout(e,b.FilmstripLayout.megastripLayoutOptions),d=this._controllerCallbacks.coordinator,f=function(){var a=d.animationRefCountedPromise;return a.getCompletionPromiseIfPending()};this._thumbsView=new b.ThumbsView(c,e,h,{viewName:"playToMegaStrip",dataContainerId:"playToContext",dontUseLowResThumbnails:true,imgCache:d.imgCache,sizeLevel:b.ImgCache.ImgSizes.megastrip,itemIndex:g,selectionMode:WinJS.UI.SelectionMode.none,showTooltips:true,videoInfoClass:"collections-megastripVideoInfo",videoGlyph:"large",scalingCallback:d.plateauScaleManager.getPhysicalSize,customRenderer:this._customRenderer,getAnimationCompletionPromise:f});this.setMode(b.PlayToViewMode.manual);this._thumbsView.addListViewEventListener("iteminvoked",function(b){a._controllerCallbacks&&a._controllerCallbacks.itemInvoked(b.detail.itemIndex)});c.addEventListener("keydown",function(b){if(a._controllerCallbacks)a._controllerCallbacks.onThumbsStripInput(b)},false);c.addEventListener("mousedown",function(b){if(a._controllerCallbacks)a._controllerCallbacks.onThumbsStripInput(b)},false);c.addEventListener("touchdown",function(b){if(a._controllerCallbacks)a._controllerCallbacks.onThumbsStripInput(b)},false)};a.shutdown=function(){if(this._isUIShutdown)return;this._removeEventListeners();this._controllerCallbacks=null;this._activeItemId=null;if(this._thumbsView){this._thumbsView.beginDeactivate();this._thumbsView.shutdown();this._thumbsView=null}this._customRenderer=null;this._dataAdaptor=null;this._thumbsStripContainer=null;this._exitPlayToButton=null;this._startAutoPlayButton=null;this._endAutoPlayButton=null;this._mode=b.PlayToViewMode.none;this._isUIShutdown=true};a.getEntranceAnimationInfo=function(){var a=document.getElementById("playTo-header");return PhotoViewer.AnimationHelpers.genericComponentAnimationInfo([a,this._thumbsStripContainer],"PlayToView","Entrance",true)};a.getExitAnimationInfo=function(){var a=document.getElementById("playTo-header");return PhotoViewer.AnimationHelpers.genericComponentAnimationInfo([a,this._thumbsStripContainer],"PlayToView","Exit",true)};a.isInitialized=function(){return!this._isUIShutdown};a.setMode=function(a){if(this._isUIShutdown)return;if(this._mode===a)return;var c=false;switch(a){case b.PlayToViewMode.loading:c=true}this._mode=a;b.log.perf(e[a],{emptyValue:true})};a.setErrorState=function(b,a){if(this._isUIShutdown)return;this._customRenderer.setErrorState(b,a)};a.setActiveItem=function(a,d){if(this._isUIShutdown)return;var c=this._customRenderer;this._activeItemId&&c.setActiveState(this._activeItemId,false);this._activeItemId=a;if(a){c.setActiveState(a,true);if(d){var b=this._dataAdaptor.objectIdToIndex(a);if(Jx.isValidNumber(b)){var e=this._controllerCallbacks.coordinator;if(e.isAppBarVisible(PhotoViewer.AppBar.Bars.bottom))this._thumbsView.setScrollToIndex(b,PhotoViewer.ThumbsView.ScrollToItemPosition.leftEdge);else this._thumbsView.setFocusIndex(b,PhotoViewer.ThumbsView.ScrollToItemPosition.leftEdge)}}}};a.updateDeviceName=function(c){if(this._isUIShutdown)return;var b=Jx.res.loadCompoundString("resid-playTo-headerTitleFmt",c),a=document.getElementById("playTo-header-title");a.innerText=b};a.updateItemCount=function(c){if(this._isUIShutdown)return;var a=document.getElementById("playTo-header-count");a.innerText=b.ViewHelpers.getCountString(0,c)};a._addEventListeners=function(){if(!this._keyupKeyHandler){var a=this;this._keyupKeyHandler=function(b){a._onKeyUp(b)}}window.addEventListener("keyup",this._keyupKeyHandler,false)};a._removeEventListeners=function(){this._keyupKeyHandler&&window.removeEventListener("keyup",this._keyupKeyHandler,false)};a._onKeyUp=function(a){this._controllerCallbacks&&this._controllerCallbacks.keyPress(a)};a._thumbsView=null;a._dataAdaptor=null;a._controllerCallbacks=null;a._keyupKeyHandler=null;a._customRenderer=null;a._mode=b.PlayToViewMode.none;a._activeItemId=null;a._isUIShutdown=true;a._thumbsStripContainer=null})()