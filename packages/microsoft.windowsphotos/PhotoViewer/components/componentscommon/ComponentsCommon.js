(function(){var b=Windows.Graphics.Display,c=b.DisplayProperties;PhotoViewer.PlateauScaleManager=function(){this._plateauScaleFactor=0;this._scaleChangeCallbacks=[];this.getPhysicalSize=this.getPhysicalSize.bind(this);this._onLogicalDpiChanged=this._onLogicalDpiChanged.bind(this);this._updateScale();c.addEventListener("logicaldpichanged",this._onLogicalDpiChanged)};var a=PhotoViewer.PlateauScaleManager.prototype;a.shutdown=function(){c.removeEventListener("logicaldpichanged",this._onLogicalDpiChanged);this._scaleChangeCallbacks=[]};a.addScaleChangeCallback=function(a){this._scaleChangeCallbacks.push(a)};a.removeScaleChangeCallback=function(c){var a=this._scaleChangeCallbacks,b=a.indexOf(c);b>=0&&a.splice(b,1)};a.getPhysicalSize=function(a){var b=this._plateauScaleFactor;return b===1?a:Math.round(a*b)};Object.defineProperty(a,"plateauScaleFactor",{"get":function(){return this._plateauScaleFactor}});a._updateScale=function(){switch(c.resolutionScale){case b.ResolutionScale.scale100Percent:this._plateauScaleFactor=1;break;case b.ResolutionScale.scale140Percent:this._plateauScaleFactor=1.4;break;case b.ResolutionScale.scale180Percent:this._plateauScaleFactor=1.8}};a._onLogicalDpiChanged=function(){this._updateScale();for(var b=this._scaleChangeCallbacks,a=0,c=b.length;a<c;a++)b[a]()}})();(function(){var b=Windows.Graphics.Display,c=b.DisplayOrientations,d=b.DisplayProperties;PhotoViewer.DisplayStateManager=function(b,a){this._dataHub=b;this._plateauScaleManager=a;this._sizeChangeCallbacks=[];this._physicalScreenSize=null;this._currentViewState=null;this._onResize=this._onResize.bind(this);this._onScaleChange=this._onScaleChange.bind(this);PhotoViewer.FilmstripLayout.megastripLayoutOptions.displayStateManager=this;PhotoViewer.SourcesStrip.sourcesStripLayoutOptions.displayStateManager=this;PhotoViewer.PuzzleLayout.puzzleViewLayoutOptions.displayStateManager=this;this._updateSizeData();window.addEventListener("resize",this._onResize,false);this._plateauScaleManager.addScaleChangeCallback(this._onScaleChange)};var a=PhotoViewer.DisplayStateManager.prototype;a.shutdown=function(){window.removeEventListener("resize",this._onResize,false);this._sizeChangeCallbacks=[]};a.addSizeChangeCallback=function(a){this._sizeChangeCallbacks.push(a)};a.removeSizeChangeCallback=function(c){var a=this._sizeChangeCallbacks,b=a.indexOf(c);b>=0&&a.splice(b,1)};a.updateScaleFactors=function(){this._updateSizeData(true)};a.isAppSnapped=function(){return this._currentViewState===Windows.UI.ViewManagement.ApplicationViewState.snapped};Object.defineProperty(a,"physicalScreenSize",{"get":function(){return this._physicalScreenSize}});a._onResize=function(){this._updateSizeData()&&this._callCallbacks()};a._onScaleChange=function(){this._updateSizeData();this._callCallbacks()};a._callCallbacks=function(){for(var b=this._sizeChangeCallbacks,c=this._physicalScreenSize,a=0,d=b.length;a<d;a++)b[a](c)};a._updateSizeData=function(h){var a=this._plateauScaleManager,d=this._physicalScreenSize,f=document.body,c=a.getPhysicalSize(f.clientWidth),b=a.getPhysicalSize(f.clientHeight);this._physicalScreenSize={width:c,height:b};this._currentViewState=Windows.UI.ViewManagement.ApplicationView.value;if(h||!d||d.width!==c||d.height!==b){var g=PhotoViewer.FilmstripLayout.megastripLayoutOptions.updateScale();PhotoViewer.SourcesStrip.sourcesStripLayoutOptions.updateScale();var e=a.plateauScaleFactor;this._dataHub.setScreenProperties(c,b,e,e*g);return true}return false}})();(function(){var a=PhotoViewer.ViewHelpers={},e=Windows.Security.Authentication.OnlineId,g=["residSeconds","residMinutes","residHours"],f=null;a.isRtl=function(){if(Jx.isNullOrUndefined(f))f=getComputedStyle(document.body).direction==="rtl";return f};Object.defineProperty(PhotoViewer.ViewHelpers,"left",{"get":function(){return a.isRtl()?"right":"left"}});Object.defineProperty(PhotoViewer.ViewHelpers,"right",{"get":function(){return a.isRtl()?"left":"right"}});a.LeadingAndTrailingMargin={normal:125,snapped:20};a.SourcesStripLeadingAndTrailingMargin={normal:125,snapped:80};a.removeElementFromDOM=function(b){var a=b.parentNode;a&&a.removeChild(b)};a.removeAllButOneChild=function(e,b,d){for(var a=b.length-1;a>=0;a--){var c=b[a];c!==d&&e.removeChild(c)}};a.getFirstElementByClassName=function(b,c){var a=b.getElementsByClassName(c);return Boolean(a)&&a.length>0?a[0]:null};a.createConditionalCallbackProxy=function(c,b,a){return function(){c.apply(a)&&b.apply(a,arguments)}};a.snapToMultiple=function(c,a){return Math.round(c/a)*a};a.showMessageFlyout=function(d,c,b){a.showCustomFlyout(d,c,function(a){a.innerHTML=b;Jx.addClass(a,"photoViewer-messageFlyoutContainer")})};a.showCustomFlyout=function(g,f,d){var c="photoviewer-customFlyout",a=document.createElement("div");a.id=c;d(a);var b=document.getElementById(c);if(b)document.body.replaceChild(a,b);else document.body.appendChild(a);var e=new WinJS.UI.Flyout(a);msSetImmediate(function(){e.show(g,f)})};a.showSelectionSourceErrorFlyout=function(d,c,b){b.getProperties(["sourceTitle"],function(g,e){var b=e.lookup("sourceTitle"),f=Jx.res.loadCompoundString("resid-singleSourceSelectionErrorFmt",b);a.showMessageFlyout(d,c,f)})};a.getItemFailureUX=function(b){var a=document.createElement("div");Jx.addClass(a,"photoViewer-failureText");if(b){var c=this;b.getProperties(["title"],function(d,c){var b=PhotoViewer.DataHubHelpers.tryLookupPropertyInMap(c,"title");if(Jx.isNonEmptyString(b))a.innerText=b;else a.innerText=Jx.res.getString("residFailedThumbnailText")})}else a.innerText=Jx.res.getString("residFailedThumbnailText");return a};a.formatInteger=function(c){var b=a.formatInteger._formatter;if(!b){b=new Windows.Globalization.NumberFormatting.DecimalFormatter;b.fractionDigits=0;a.formatInteger._formatter=b}return b.format(Math.round(c))};a.getCountString=function(f,g){var h=Jx.res,d=function(d,b){var e=d+(b===1?"_1_Fmt":"_N_Fmt"),c=a.formatInteger(b);return h.loadCompoundString(e,c)},b="",c=f>0;if(c)b=d("residAlbumCount",f);if(g>0||!c){var e=d("residItemCount",g);if(c)b=h.loadCompoundString("residAlbumItemCounts_Fmt",b,e);else b=e}return b};a.getDurationAccString=function(f){for(var d=f.split("\u2236"),i=Jx.res,b="",e=0,c=d.length-1;c>=0;c--){var a=parseInt(d[c]);if(Jx.isValidNumber(a)&&a>0){var h=g[e]+(a===1?"_1_Fmt":"_N_Fmt");b=i.loadCompoundString(h,a.toString())+b}e++}return b};a.getUserInfoAsync=function(c,b){if(!b)b=new e.OnlineIdAuthenticator;var f=new e.OnlineIdServiceTicketRequest(a.getLiveProfileDomain(),"mbi_ssl"),d=b.authenticateUserAsync([f],c);return d};a.signOutUser=function(a){if(!a)a=new e.OnlineIdAuthenticator;return a.signOutUserAsync()};a.getLiveProfileDomain=function(){return Jx.app.getEnvironment()==="INT"?"profile.live-int.com":"profile.live.com"};a.returnFalse=function(){return false};a.Point=function(a,b){this.x=a;this.y=b};var c=a.Point.prototype;c.transform=function(b){var c=new a.Point(0,0);c.x=this.x*b.m11+b.m41;c.y=this.y*b.m22+b.m42;return c};c.subtract=function(b){return new a.Point(this.x-b.x,this.y-b.y)};c.x=0;c.y=0;a.getLayoutPosInElement=function(c,d){var b=a.calculateLayoutTransform(c,d);return b?{top:b.f,left:b.e,width:c.offsetWidth,height:c.offsetHeight,transform:b}:null};a.calculateLayoutTransform=function(v,u){var b=new MSCSSMatrix,a=v,r=a,p=[],c;while(a!==u){if(!a)return null;c={element:a,isOffsetParent:a===r};p.push(c);r=a.offsetParent;a=a.parentNode}for(var k,m,f,l,g,j,o,n,s,t,e,q=p.length-1;q>=0;q--){c=p[q];a=c.element;e=getComputedStyle(a,null);s=c.isOffsetParent?a.offsetLeft:0;t=c.isOffsetParent?a.offsetTop:0;k=d(s-a.scrollLeft+parseInt(e.borderLeftWidth,10),t-a.scrollTop+parseInt(e.borderTopWidth,10));if(k)b=b.multiply(k);m=new MSCSSMatrix(e.msTransform);f=h(m);if(f)b=b.multiply(f);g=i(m);if(g){o=a.offsetWidth;n=a.offsetHeight;l=d(o/2,n/2);if(l)b=b.multiply(l);b=b.multiply(g);j=d(-o/2,-n/2);if(j)b=b.multiply(j)}}return b};var i=function(a){return a.a!==1||a.d!==1?(new MSCSSMatrix).scale(a.a,a.d):null},h=function(a){return a.e!==0||a.f!==0?(new MSCSSMatrix).translate(a.e,a.f):null},d=function(a,b){return a!==0||b!==0?(new MSCSSMatrix).translate(a,b):null};a.onRenderComplete=function(b,a,c){return c()?WinJS.Promise.wrap():new WinJS.Promise(function(d){var c=function(){Jx.removeListener(b,a,c);c=null;d()};Jx.addListener(b,a,c)})};a.RefCountedPromise=function(){};var b=a.RefCountedPromise.prototype;b.addRef=function(){this._refCount++};b.decRef=function(){this._refCount--;if(this._refCount===0)if(this._complete){this._completing=true;try{this._complete()}catch(a){}this._complete=null;this._completionPromise=null;this._completing=false}};b.getCompletionPromiseIfPending=function(){if(this._completing)return null;if(this._refCount>0&&!this._completionPromise){var a=this;this._completionPromise=new WinJS.Promise(function(b){a._complete=b})}return this._completionPromise};b._refCount=0;b._completionPromise=null;b._complete=null;b._completing=false})();(function(){var c=PhotoViewer.ViewHelpers,a=PhotoViewer.AnimationHelpers={},b=WinJS.UI.Animation,d=WinJS.Promise;a.pvlEaseInCurve="cubic-bezier(0.1, 0.9, 0.2, 1)";a.pvlEaseOutCurve="cubic-bezier(0, 0, 0.58, 1)";a.pvlExponentialCurve="cubic-bezier(0.1, 0.9, 0.2, 1)";a.customAnimationDelay=32;a.genericComponentAnimationInfoWithLayoutPos=function(d,c,f,e,h,g){var b=a.genericComponentAnimationInfo(d,f,e,h);b.getLayoutPos=g;b.referenceFrameElement=c;return b};a.genericComponentAnimationInfo=function(a,c,b,d){return{orderedElements:a,beginAnimation:function(){Jx.log.info(c+": Triggering "+b+" Animation.")},isClientView:d}};a.genericComponentAnimationInfoById=function(b,d,c,e){var f=document.getElementById(b);return a.genericComponentAnimationInfo([f],d,c,e)};a.addToListAnimation=function(a){return b.createAddToListAnimation(a,[]).execute()};a.slideRepositionAnimation=function(k,c,g,j){for(var h=b.createRepositionAnimation(c),a=0,i=c.length;a<i;a++){var e=c[a];if(e._animating){var f=e.style,d=g[a];f[j?"right":"left"]=String(d.left)+"px";f.top=String(d.top)+"px"}}return h.execute()};a.crossfadeRepositionAnimation=function(f,h,l,o){for(var e=document.createElement("div"),c=document.createElement("div"),a=0,k=h.length;a<k;a++){var g=h[a];if(g._animating){var j=l[a],m=g.cloneNode(true);e.appendChild(m);var i=g.style;i[o?"right":"left"]=String(j.left)+"px";i.top=String(j.top)+"px";var n=g.cloneNode(true);c.appendChild(n);i.opacity="0.0"}}Jx.addClass(e,"photoViewer-temporaryOverlay");Jx.addClass(c,"photoViewer-temporaryOverlay");c.style.opacity="0";f.appendChild(e);f.appendChild(c);return d.timeout().then(function(){return d.any([d.join([b.fadeOut(e),b.fadeIn(c)]),d.timeout(250)])}).then(function(){f.removeChild(e);f.removeChild(c);for(a=0;a<k;a++)h[a].style.opacity=1})};a.animateListReflow=function(h,f,e,g,j,k,l,i){var a,c;for(a=0,c=f.length;a<c;a++)f[a].style.opacity=0;for(a=0,c=e.length;a<c;a++)h.appendChild(e[a]);return d.timeout().then(function(){for(a=0,c=e.length;a<c;a++)e[a].style.opacity=0;return e.length>0?b.createDeleteFromListAnimation(e,[]).execute():null}).then(function(){for(a=0,c=e.length;a<c;a++)h.removeChild(e[a]);return g.length>0?k(h,g,j,l):null}).then(function(){for(a=0,c=g.length;a<c;a++){var b=g[a];if(b._animating)b._animating=false}for(a=0,c=f.length;a<c;a++)f[a].style.opacity=1;return Boolean(i)&&f.length>0?i(f):null})};a.DirectionalItemScalingType={standard:"standard",capIncomingScale:"capIncomingScale",capOutgoingScale:"capOutgoingScale"};var h=a.DirectionalItemScalingType,k=1.35,j=167,l=730;a.directionalItemScalingAnimation=function(q,f,h,o,l,n,p){var a=l.referenceFrameElement,b=n.referenceFrameElement;a.style.visibility="hidden";a.style.opacity="0.0";e(f,"opacity","0.0");var j=f.indexOf(a);f.splice(j,1);var k=h.indexOf(b);h.splice(k,1);return d.timeout(0).then(function(){var r=c.calculateLayoutTransform(a,o),s=c.calculateLayoutTransform(b,o);if(!r||!s)return g(a,f,j,b,h,k);var e=r.inverse().multiply(s),t=e.inverse(),u=l.getLayoutPos(p,a),v=n.getLayoutPos(p,b);return d.join([u,v]).then(function(u){var d=u[0],l=u[1];if(!d||!l)return g(a,f,j,b,h,k);var v=new c.Point(0,0),x=new c.Point(d.width/2,d.height/2),n=x.transform(d.transform),y=new c.Point(l.width/2,l.height/2),r=y.transform(l.transform),p=r.transform(e),o=n.transform(t),z=v.transform(d.transform),B=v.transform(l.transform).transform(e),s=(p.y-B.y)/(n.y-z.y),D=1/s,w=p.subtract(n),A=o.subtract(r),C=i(a,w,n,q,s,false),E=i(b,A,o,q,D,true);return m(a,C,f,b,E,h)})})};var e=function(b,c,e){var a=0,d=b.length;for(a;a<d;a++)b[a].style[c]=e},i=function(l,b,g,m,a,p){var e=a;if(m===h.capOutgoingScale||m===h.capIncomingScale)a=Math.min(a,k);if(e!==a){b.x=b.x/e*a;b.y=b.y/e*a}var i=f(b),d=new c.Point(g.x-l.offsetWidth/2,g.y-l.offsetHeight/2),o=new c.Point(-d.x,-d.y),j=f(d)+n(a)+f(o),q=p?j+i:i+j;return new MSCSSMatrix(q).toString()},n=function(a){return" scale("+String(a)+", "+String(a)+") "},f=function(a){return" translate("+String(a.x)+"px, "+String(a.y)+"px) "},g=function(b,c,d,g,a,f){b.style.visibility="visible";b.style.opacity="1.0";c.splice(d,0,b);a.splice(f,0,g);e(a,"opacity","0.0");return WinJS.UI.Animation.crossFade(c,a).then(function(){e(a,"visibility","hidden")})},m=function(c,h,f,d,i,g){var k=WinJS.Promise.wrap(0);return k.then(function(){PhotoViewer.log.perf("evPhotoViewer_Animations_DirectionalScale_Start",{emptyValue:true});var k=l,m=j;c.style.visibility="visible";c.style.opacity="1.0";var n=WinJS.UI.executeAnimation(c,[{property:"transform",delay:a.customAnimationDelay,duration:k,timing:a.pvlExponentialCurve,from:h,to:"none"},{property:"opacity",delay:a.customAnimationDelay,duration:m,timing:a.pvlExponentialCurve,from:"0",to:"1"}]).then(function(){PhotoViewer.log.perf("evPhotoViewer_Animations_DirectionalScale_End",{emptyValue:true})});d.style.opacity="0.0";var o=WinJS.UI.executeAnimation(d,[{property:"transform",delay:a.customAnimationDelay,duration:k,timing:a.pvlExponentialCurve,from:"none",to:i},{property:"opacity",delay:a.customAnimationDelay,duration:m,timing:a.pvlExponentialCurve,from:"1",to:"0"}]).then(function(){d.style.visibility="hidden"});e(f,"opacity","1.0");var q=b.fadeIn(f);e(g,"opacity","0.0");var p=b.fadeOut(g);return WinJS.Promise.join([n,o,q,p])})},o=160;a.setAsBeginAnimation=function(a){a.setAttribute("aria-hidden","false");return b.fadeIn(a).then(function(){a.style.opacity="1.0"})};a.setAsEndAnimation=function(a){return b.fadeOut(a).then(function(){a.style.opacity="0";a.setAttribute("aria-hidden","true")})};a.mergeArrays=function(b,c){var d=c.length;if(d>0)for(var e=b.length,a=0;a<d;a++)b[e++]=c[a]}})();(function(){var b=window.PhotoViewer,a=b.DataHubHelpers={};a.SourceType={unknown:"Unknown",none:"None",picturesLibrary:"PicturesLibrary",storage:"Storage",device:"Device",phone:"Phone",skyDrive:"SkyDrive",facebook:"Facebook",flickr:"Flickr",youTube:"YouTube",vimeo:"Vimeo",camera:"Camera",genericConnect:"GenericConnect",genericDevice:"GenericDevice"};a.HResults={objectNotFoundError:-2147177727,dataLayerSuspendedError:-2133786619};a.isLocalSourceType=function(b){return b===a.SourceType.picturesLibrary||b===a.SourceType.storage};a.isContainerType=function(a){return a.substr(0,10)==="container."};a.doContainersMatch=function(a,b){return a.id===b.id&&a.searchQuery===b.searchQuery&&a.shape===b.shape};a.isRootContainer=function(a){return Boolean(a)&&a.id===""&&a.searchQuery===""};a.tryLookupPropertyInMap=function(b,a){return b.hasKey(a)?b.lookup(a):""};a.tryLookupPropertiesInMap=function(e,c){var a,d,b;for(a=0,d=c.length;a<d;a++){b=c[a];if(!e.hasKey(b))return null}var f={};for(a=0;a<d;a++){b=c[a];f[b]=e.lookup(b)}return f};a.isBlobOperationResultValid=function(a){return Boolean(a.data)||Boolean(a.uri)||Boolean(a.file)};a.getSourceFromBlobOperationResult=function(a,b){var c=a.data;if(c){var f=MSApp.createBlobFromRandomAccessStream(a.mimeType,c);return URL.createObjectURL(f,{oneTimeOnly:!b})}var e=a.uri;if(e)return e;var d=a.file;return d?URL.createObjectURL(d,{oneTimeOnly:!b}):""};a.getStreamFromBlobOperationResult=function(a){var c=a.file;if(c)return c.openSequentialReadAsync();var b=a.data;if(b)return WinJS.Promise.wrap(b.getInputStreamAt(0));var d=a.uri;if(d){var e=Windows.Storage.Streams.RandomAccessStreamReference.createFromUri(new Windows.Foundation.Uri(d));return e.openReadAsync()}return WinJS.Promise.wrapError(new Error("Blob retrieval completed without file, URI, or stream in results."))}})();(function(){var d=window.PhotoViewer,a=d.SourcesHelpers={},b=d.ViewHelpers,e=d.DataHubHelpers,c=e.SourceType;a.SourceStatus={notInitialized:"NotInitialized",noConnectedUser:"NoConnectedUser",notConnectedProvider:"NotConnectedProvider",connectedProviderOffline:"ConnectedProviderOffline",connectedProviderOnline:"ConnectedProviderOnline",upgradableProvider:"UpgradableProvider",errorProvider:"ErrorProvider",deviceLimitReachedError:"DeviceLimitReachedError",syncServerError:"SyncServerError",providerRemoved:"ProviderRemoved",providerDisabled:"ProviderDisabled"};a.Error={networkUnreachable:-2147023665,resourceNotFound:-2146697211};a.hasError=function(b,c){var d=parseInt(c);return d!==0||b!==a.SourceStatus.connectedProviderOnline&&b!==a.SourceStatus.notInitialized&&b!==a.SourceStatus.providerDisabled};a.hasErrorOnEmptySource=function(b,c){var d=parseInt(c);return d!==0||b===a.SourceStatus.connectedProviderOffline||b===a.SourceStatus.deviceLimitReachedError||b===a.SourceStatus.syncServerError};a.isAuthenticationError=function(a){return a===Microsoft.WindowsLive.ClientAccessLibrary.GeneralError.servicePasswordChanged||a===Microsoft.WindowsLive.ClientAccessLibrary.GeneralError.operationAuthTokensInvalid||a===Microsoft.WindowsLive.ClientAccessLibrary.GeneralError.serviceTimestampInvalid};a.isNetworkError=function(b){return b===a.Error.networkUnreachable||b===a.Error.resourceNotFound};a.showOrHideInlineError=function(f,b,c,d,e){if(f){b.innerText=a.getInlineError(d,e);Jx.removeClass(b,"displayNone");Jx.addClass(c,"collections-megastripContainerTitleOneLine")}else{b.innerText="";Jx.addClass(b,"displayNone");Jx.removeClass(c,"collections-megastripContainerTitleOneLine")}return b.innerText};a.getInlineError=function(b,f){var e=parseInt(f),c=a.SourceStatus,d;if(b===c.noConnectedUser||b===c.errorProvider||a.isAuthenticationError(e))d=Jx.res.getString("residErrorLoginFailureInlineText");else if(b===c.connectedProviderOffline||e===Microsoft.WindowsLive.ClientAccessLibrary.DeviceError.transportShutdown||a.isNetworkError(e)||b===c.syncServerError)d=Jx.res.getString("residErrorDeviceOfflineInlineText");else if(b===c.upgradableProvider)d=Jx.res.getString("residErrorUpgradeableFailureInlineText");else if(b===c.notConnectedProvider||b===c.providerRemoved)d=Jx.res.getString("residServiceUnavailableInlineText");else if(b===c.deviceLimitReachedError)d=Jx.res.getString("residErrorGenericFailureInlineText");else d=Jx.res.getString("residErrorGenericFailureInlineText");return d};a.getErrorFlyoutSpecification=function(b,l,i,e,g){var f=parseInt(l),d=a.SourceStatus;function h(){e.source.executeAsync("deleteSourceData",null).then()}function j(b,a){msSetImmediate(function(){if(b.parentNode)b.parentNode.addEventListener("afterhide",a,false);else a()})}if(b===d.noConnectedUser||b===d.errorProvider||a.isAuthenticationError(f))return f===Microsoft.WindowsLive.ClientAccessLibrary.GeneralError.serviceTimestampInvalid?{hasDefaultMessage:true,innerText:Jx.res.getString("residErrorInvalidTimestampInstructionText")}:{hasDefaultMessage:true,innerText:Jx.res.getString("residErrorLoginFailureInstructionText"),getButton:function(g){var c=a._getButton(Jx.res.getString("residErrorConnectButtonText"));c.addEventListener("click",function(){var c=b===d.errorProvider||f===Microsoft.WindowsLive.ClientAccessLibrary.GeneralError.servicePasswordChanged;a.ensureSignedInAndConnected(e,i,c,g)},false);return c}};else if(b===d.connectedProviderOffline||f===Microsoft.WindowsLive.ClientAccessLibrary.DeviceError.transportShutdown)return e.sourceType===c.device?{hasDefaultMessage:true,innerHTML:Jx.res.loadCompoundString("residErrorDeviceOfflineInstructionText",g)}:{hasDefaultMessage:true,innerText:Jx.res.getString("residErrorGenericFailureInstructionText")};else if(a.isNetworkError(f))return{hasDefaultMessage:false,innerText:Jx.res.getString("residErrorNoNetworkConnectionInstructionText")};else if(b===d.upgradableProvider)return{hasDefaultMessage:false,innerText:Jx.res.getString("residErrorUpgradeableFailureInstructionText"),getButton:function(c){var b=a._getButton(Jx.res.getString("residErrorConnectButtonText"));b.addEventListener("click",function(){a.ensureSignedInAndConnected(e,i,true,c)},false);return b}};else if(b===d.notConnectedProvider)return e.sourceType===c.device?{hasDefaultMessage:false,innerHTML:Jx.res.loadCompoundString("residErrorDeviceOfflineInstructionText",g)}:{hasDefaultMessage:false,innerText:Jx.res.loadCompoundString("residErrorServiceRemovedInstructionFmt",g),getButton:function(d){var b=a._getButton(Jx.res.getString("residErrorConnectButtonText")),c=false;b.addEventListener("click",function(){c=true;a.ensureSignedInAndConnected(e,i,false,d,h)},false);j(b,function(){!c&&h()});return b}};else if(b===d.providerRemoved)return{hasDefaultMessage:false,innerText:Jx.res.loadCompoundString("residErrorTerminatedProviderInstructionFmt",g),getButton:function(c){var b=a._getButton(Jx.res.getString("residErrorRemoveButtonText"));b.addEventListener("click",function(){a._launchProfileManager(c)},false);j(b,h);return b}};else if(b===d.deviceLimitReachedError){var m=Windows.ApplicationModel.Resources.Core.ResourceManager.current.defaultContext.languages[0],n="http://answers.microsoft.com/"+m+"/windows/forum/winapps",k='<a class="photoAppLink" href="'+n+'">'+Jx.res.getString("residDeviceLimitReachedErrorLink")+"</a>";return{hasDefaultMessage:true,innerHtml:Jx.res.loadCompoundString("residDeviceLimitReachedErrorInstructionTextFmt",k)}}else return b===d.syncServerError?{hasDefaultMessage:true,innerText:Jx.res.getString("residErrorGenericFailureInstructionText")}:{hasDefaultMessage:true,innerText:Jx.res.getString("residErrorGenericFailureInstructionText")}};a.showErrorFlyout=function(c,d,e){var f=this;d.getProperties(["errorResult","sourceStatus","dateLastSync","hasSyncedContent","sourceTitle"],function(k,d,l){if(l){var i=d.lookup("sourceStatus"),j=d.lookup("errorResult"),f=d.lookup("sourceTitle"),h=a._timetToDate(d.lookup("dateLastSync")),g=Boolean(d.lookup("hasSyncedContent"));b.showCustomFlyout(c,b.right,function(d){var b=a.getErrorFlyoutSpecification(i,j,e,k,f);Jx.addClass(d,"photoViewer-messageFlyoutContainer");var l=document.createElement("div");l.id="idSourceStatusFlyoutHeader";l.innerText=Jx.res.loadCompoundString("residErrorSourceUnavailableHeaderFmt",f);l.className="collections-sourceStatusFlyoutHeader";d.appendChild(l);b.hasDefaultMessage&&g&&d.appendChild(a._getDefaultMessage(h));if(b.innerText)d.appendChild(a._getInstructions(b.innerText));else b.innerHTML&&d.appendChild(a._getHTMLInstructions(b.innerHTML));b.getButton&&d.appendChild(b.getButton(c))})}})};a.showConnectUpsellFlyout=function(c,a){a.getProperties(["sourceTitle"],function(g,a,e){if(e){var f=a.lookup("sourceTitle"),d=Jx.res.loadCompoundString("residConnectUpsellFlyoutText",f);b.showMessageFlyout(c,b.right,d)}})};a._translateErrorToHexString=function(a){return a>=0?a.toString(16).toUpperCase():(4294967296+a).toString(16).toUpperCase()};a._getButton=function(b){var a=document.createElement("button");a.id="idSourceStatusFlyoutButton";a.className="lightButton collections-sourceStatusFlyoutButton";a.innerText=b;return a};a._getInstructions=function(b){var a=document.createElement("div");a.id="idSourceStatusFlyoutInstructions";a.className="collections-sourceStatusFlyoutText";a.innerText=b;return a};a._getHTMLInstructions=function(b){var a=document.createElement("div");a.id="idSourceStatusFlyoutInstructions";a.className="collections-sourceStatusFlyoutText";a.innerHTML=b;return a};a._getDefaultMessage=function(c){var b=document.createElement("div");b.id="idSourceStatusFlyoutMessage";b.className="collections-sourceStatusFlyoutText";b.innerText=Jx.res.loadCompoundString("residErrorSourceUnavailableMessageFmt",a._getTimeLastSyncText(c));return b};a.checkSignedIn=function(){return b.getUserInfoAsync(Windows.Security.Authentication.OnlineId.CredentialPromptType.doNotPrompt)};a.ensureSignedIn=function(d,c){return new WinJS.Promise(function(e,f){b.getUserInfoAsync(Windows.Security.Authentication.OnlineId.CredentialPromptType.promptIfNeeded).then(function(a){if(c)c.executeAsync("refreshCredentials",null).then(function(){e(a)},function(){e(a)});else e(a)},function(b){var c=b.message==="Canceled";!c&&a._showSignInErrorFlyout(b,d);f(b)})})};a.ensureSignedInAndConnected=function(e,c,f,d,b){a.ensureSignedIn(d,c).then(function(d){a._connectProvider(e,d,c,f,b)},function(c){var a=c.message==="Canceled";a&&Boolean(b)&&b()})};a.logSourceDiagnostics=function(e,c,d,b){try{var g=parseInt(d),f=a._timetToDate(b).toUTCString();PhotoViewer.log.info("Source diagnostics: Source - "+e+", Status - "+c+", Error - 0x"+a._translateErrorToHexString(g)+", Last synced - "+f)}catch(h){}};a.getAppIdForSourceType=function(b){var a;switch(b){case c.facebook:a="fb";break;case c.flickr:a="flkr"}return a};a.hideOrShowSourceAsync=function(b,c){var a=c?"turnSourceOff":"turnSourceOn";return b.executeAsync(a,null)};a._showSignInErrorFlyout=function(h,g){var c,d=h.number;if(a.isNetworkError(d))c=Jx.res.getString("residSignInErrorFlyoutTextNoInternet");else{var f=Windows.ApplicationModel.Resources.Core.ResourceManager.current.defaultContext.languages[0],i="http://answers.microsoft.com/"+f+"/Search/Search?SearchTerm="+d+"&CurrentScope.ForumName=Windows&CurrentScope.Filter=&askingquestion=false",e='<a class="photoAppLink" href="'+i+'">'+Jx.res.getString("residSignInErrorFlyoutLinkGeneric")+"</a>";c=Jx.res.loadCompoundString("residSignInErrorFlyoutTextGenericFmt",e)}b.showMessageFlyout(g,b.right,c)};a._connectProvider=function(p,h,v,q,i){var o=p.sourceType,u=a.getAppIdForSourceType(o),s=Windows.ApplicationModel.Resources.Core.ResourceManager.current.defaultContext.languages[0],f=Windows.Security.Authentication.Web,j=f.WebAuthenticationBroker,l=j.getCurrentApplicationCallbackUri(),g=b.getLiveProfileDomain(),t=h.safeCustomerId,r=Microsoft.WindowsLive.Market.get(Microsoft.WindowsLive.FallbackLogic.countryRegion),e="https://"+g+"/cid-"+t+"/services/connect?view=modern&scenarios=media_agg&brand=Photos&biciID=photoshomescreen&appid="+u+"&mkt="+s+"&ru="+window.encodeURIComponent(l.absoluteUri)+"&psamarket="+r;if(q)e+="&authz=true";for(var c,k=h.tickets,m=k.size;m--;){var d=k[m];if(!d.errorCode&&d.request.policy==="mbi_ssl"&&d.request.service===g)c=d.value}if(Jx.isNonEmptyString(c)){c=c.substr(2);e+="&wlrpsticket="+window.encodeURIComponent(c)}var n=j.authenticateAsync(f.WebAuthenticationOptions.none,new Windows.Foundation.Uri(e),l);n.then(function(a){if(Boolean(i)){var b=Jx.isString(a.responseData)&&a.responseData.lastIndexOf("success=false")!==-1||a.responseStatus===f.WebAuthenticationStatus.userCancel;b&&i()}v.executeAsync("refreshCredentials",null).then()},function(){})};a._launchProfileManager=function(c){a.ensureSignedIn(c).then(function(a){var c="https://"+b.getLiveProfileDomain()+"/cid-"+a.id+"/Services/?view=manage";Windows.System.Launcher.launchUriAsync(new Windows.Foundation.Uri(c)).then()})};a._getTimeLastSyncText=function(d){var a=+new Date-d.getTime(),c=null;if(a<12e4)c=Jx.res.getString("residErrorLastSyncAboutOneMinuteAgo");else if(a<36e5){var e=b.formatInteger(a/6e4);c=Jx.res.loadCompoundString("residErrorLastSyncLessThanOneHourAgoFmt",e)}else if(a<72e5)c=Jx.res.getString("residErrorLastSyncLessThanTwoHoursAgo");else if(a<864e5){var f=b.formatInteger(a/36e5);c=Jx.res.loadCompoundString("residErrorLastSyncNHoursAgoFmt",f)}else if(a<1728e5)c=Jx.res.getString("residErrorLastSyncOneDayAgo");else if(a<2592e6){var g=b.formatInteger(a/864e5);c=Jx.res.loadCompoundString("residErrorLastSyncNDaysAgoFmt",g)}else c=Jx.res.getString("residErrorLastSyncOverOneMonthAgo");return c};a._timetToDate=function(b){var a=parseInt(b,10);a*=1e3;return new Date(a)}})();(function(){var b=window.PhotoViewer,j=b.DataHubHelpers,l=b.Graphics,m=WinJS.Promise,g=WindowsLive.Photo.Viewer.DataModel,d=g.ObjectCollectionChangedEventType,h=g.ObjectChangedEventFields,e=20,f=65536e3,k={puzzle:["megastrip","oneUp"],megastrip:["oneUp","puzzle"],oneUp:["megastrip"]},i={puzzle:["oneUp","megastrip","puzzle"],megastrip:["oneUp","puzzle","megastrip"],oneUp:["megastrip","puzzle","oneUp"]};b.ImgCache=function(d,b){this._dataHub=d;this._objectCollection=d.selection.clone();this._shallowClearCache();this._ignoreNotifications=false;this._currentSizeLevel=null;this._collectionChangedHandler=this._collectionChangedHandler.bind(this);this._objectCollection.addEventListener("changed",this._collectionChangedHandler);var c=b.physicalScreenSize;this._maxPixelCount=Math.min(c.width*c.height*e,f);var a=this;b.addSizeChangeCallback(function(b){a._maxPixelCount=Math.min(b.width*b.height*e,f);a._hitLimit=false;a._makeRoom(0)})};var a=b.ImgCache.prototype;b.ImgCache.ImgSizes={puzzle:"puzzle",megastrip:"megastrip",oneUp:"oneUp"};var c=b.ImgCache.ImgSizes;a.storeImg=function(a,b,e,g,f,d){this._currentSizeLevel=b;var c=this;window.msSetImmediate(function(){var o=g*f;c._makeRoom(o);var m=c._cache,h=m[a];if(!h){h=m[a]={puzzle:null,megastrip:null,oneUp:null};try{c._addObjectToCollection(a)}catch(t){if(t.number===j.HResults.objectNotFoundError)return;else{Jx.promoteOriginalStack(t);throw t}}}else h[b]&&c._releaseImg(a,h,b);var i=e.cloneNode(false);i.id="";i.className="";if(d)for(var n=0,s=d.length;n<s;n++){var l=d[n];if(e.hasOwnProperty(l))i[l]=e[l]}var q={img:i,width:g,height:f,prev:null,next:null};h[b]=q;var p=c._queueData,k=p[b];if(k){var r=k.newest;m[r][b].next=a;q.prev=r;k.newest=a}else p[b]={oldest:a,newest:a};c._totalPixelCount+=o})};a.getImg=function(i,c,j,m){var b=this._cache[i];if(b){var a=b[c],n=this,f=function(d,c){n._makeNewest(i,b);l.removeNonScalingStyle(c);return{img:c,sizeLevel:d,width:a.width,height:a.height}};if(a){var d=a.img;if(m)d=d.cloneNode(false);return f(c,d)}if(j)for(var g=k[c],e=0,o=g.length;e<o;e++){var h=g[e];a=b[h];if(a)return f(h,a.img.cloneNode(false))}}return null};a.releaseImg=function(a,f){var e=this._cache,d=e[a],b=0;for(var g in c)if(d[g])b++;if(b===1){delete e[a];this._removeObjectFromCollection(a)}return this._releaseImg(a,d,f)};a.clearCache=function(){var b=this._cache;this._shallowClearCache();for(var e in b){var d=b[e];for(var f in c){var a=d[f];a&&URL.revokeObjectURL(a.img.src)}}};a._releaseImg=function(i,h,a){var e=this._cache,c=h[a];h[a]=null;URL.revokeObjectURL(c.img.src);this._totalPixelCount-=c.width*c.height;var g=this._queueData,f=g[a],d=c.prev,b=c.next;if(Jx.isNonEmptyString(d)){e[d][a].next=b;if(Jx.isNonEmptyString(b))e[b][a].prev=d;else f.newest=d}else if(Jx.isNonEmptyString(b)){f.oldest=b;e[b][a].prev=null}else{delete g[a];return false}return true};a._releaseImgsForItem=function(b){var e=this._cache,a=e[b];if(a){for(var d in c)a[d]&&this._releaseImg(b,a,d);delete e[b]}};a._makeNewest=function(f,i){var h=this._cache,j=this._queueData;for(var a in i){var b=i[a];if(b){var c=j[a],g=c.newest;if(g!==f){var e=b.prev,d=b.next;h[d][a].prev=e;if(Jx.isNonEmptyString(e))h[e][a].next=d;else c.oldest=d;h[g][a].next=f;b.prev=g;b.next=null;c.newest=f}}}};a._makeRoom=function(e){var c=this._maxPixelCount-e;if(this._totalPixelCount>c){if(!this._hitLimit){this._hitLimit=true;b.log.perf("evPhotoViewer_ImgCache_ReachedLimit",{emptyValue:true})}for(var d=i[this._currentSizeLevel],a=0,f=d.length;a<f;a++)if(this._makeRoomAtSizeLevel(d[a],c))return}};a._makeRoomAtSizeLevel=function(c,d){var a=this._queueData[c];if(a){var b;do{b=this.releaseImg(a.oldest,c);if(this._totalPixelCount<=d)return true}while(b)}return false};a._shallowClearCache=function(){this._cache={};this._queueData={};this._totalPixelCount=0;this._hitLimit=false;this._objectCollection.clear();this._objectIdList=[]};a._addObjectToCollection=function(a){try{this._ignoreNotifications=true;var b=this._objectCollection,c=b.append(a);this._objectIdList.splice(c,0,a)}finally{this._ignoreNotifications=false}};a._removeObjectFromCollection=function(c){var a=this._objectCollection,b=a.lookup(c);try{this._ignoreNotifications=true;a.removeRangeAt(b,1);this._objectIdList.splice(b,1)}finally{this._ignoreNotifications=false}};a._collectionChangedHandler=function(n){if(!this._ignoreNotifications){for(var p=this._dataHub,k=this._objectIdList,o=n.target,m=n.detail[0],l=m.length,c,i,a,g,b,j=[],e=0;e<l;e++){var f=m[e];switch(f.type){case d.modified:if(f.fields&h.thumbnail){c=f.position;g=f.count;i=c+g-1;for(a=c;a<=i;a++){b=k[a];j.push(b)}}break;case d.removed:c=f.position;g=f.count;i=c+g-1;for(a=c;a<=i;a++){b=k[a];this._releaseImgsForItem(b)}k.splice(c,g)}}for(e=0,l=j.length;e<l;e++){b=j[e];this._releaseImgsForItem(b);this._removeObjectFromCollection(b)}}}})();(function(){var e=window.PhotoViewer,d=WinJS.Promise,f=WindowsLive.Photo.Viewer.DataModel,b=f.ObjectCollectionChangedEventType;e.VirtualizedDataSource=WinJS.Class.derive(WinJS.UI.VirtualizedDataSource,function(a){this._baseDataSourceConstructor(a)});e.ObjectCollectionDSA=function(b,a){this._dataHub=b;this._objectCollection=a;this._cachedCount=-1;this._notificationHandlers=[];this._addNotificationsCompletedHandlers=[];this._objectModifiedHandlers=[];this._deactivated=false;this._listeningToNotifications=true;this._deferredModifyNotifications={};this._getCountFromObjectCollection(true);this.dataSource=null;this._invalidateNeeded=this._cachedCount>0;this._invalidatePromise=null;this._collectionChangedHandler=this._collectionChangedHandler.bind(this);this._objectCollection.addEventListener("changed",this._collectionChangedHandler)};var a=e.ObjectCollectionDSA.prototype,c=function(){return d.wrapError(new WinJS.ErrorFromName(WinJS.UI.FetchError.doesNotExist))};a.getCount=function(){!this._deactivated;return d.wrap(this._cachedCount)};a.itemsFromIndex=function(a,h,i){if(this._deactivated)return c();var f=this._cachedCount;if(a>=f)return c();else{for(var e=Math.max(0,a-h),j=Math.min(a+i,f-1),g=[],b=e;b<=j;b++){var k=this.indexToObjectId(b);g[b-e]={key:k,data:{}}}return d.wrap({items:g,offset:a-e,totalCount:f,absoluteIndex:a})}};a.itemsFromKey=function(e,b,d){if(this._deactivated)return c();var a=this.objectIdToIndex(e);return Jx.isValidNumber(a)?this.itemsFromIndex(a,b,d):c()};a.setNotificationHandler=function(a){this._notificationHandlers.push(a)};a.removeNotificationHandler=function(a){this._removeHandlerFromArray(this._notificationHandlers,a)};a.addObjectModifiedHandler=function(a){this._objectModifiedHandlers.push(a)};a.removeObjectModifiedHandler=function(a){this._removeHandlerFromArray(this._objectModifiedHandlers,a)};a.setAddNotificationsCompletedHandler=function(a){this._addNotificationsCompletedHandlers.push(a)};a.removeAddNotificationsCompletedHandler=function(a){this._removeHandlerFromArray(this._addNotificationsCompletedHandlers,a)};a.isDeactivated=function(){return this._deactivated};a.deactivate=function(){this._deactivated=true;var a=this._objectCollection;a&&a.removeEventListener("changed",this._collectionChangedHandler);this._notificationHandlers=[];this._objectModifiedHandlers=[]};a.shutdown=function(){!this._deactivated&&this.deactivate();this._objectCollection=null;this._dataHub=null};a.indexToObjectId=function(a){if(this._getCollectionIndexFromIndex)a=this._getCollectionIndexFromIndex(a);return this._objectCollection.idAt(a)};a.indexToObject=function(a){if(this._getCollectionIndexFromIndex)a=this._getCollectionIndexFromIndex(a);return this._objectCollection.objectAt(a)};a.objectIdToObject=function(a){return this._dataHub.getObject(a)};a.objectIdToIndex=function(b){var a=this._objectCollection.lookup(b);if(this._getIndexFromCollectionIndex)a=this._getIndexFromCollectionIndex(a);return a};a.setActiveItem=function(a){this._dataHub.updateActiveItem(a)};a.setPriorityRange=function(a,b){if(this._getCollectionIndexFromIndex)a=this._getCollectionIndexFromIndex(a);this._objectCollection.setPriorityRange(a,b)};a.reloadView=function(){this._broadcastNotification("reload")};a.resumeHandlingNotifications=function(){this._broadcastNotification("invalidateAll");var a=this;msSetImmediate(function(){var g=a._deferredModifyNotifications,b,e,h=[];for(var c in g)if(Jx.isValidNumber(a.objectIdToIndex(c))){var i=g[c];if(!b){b=a._objectModifiedHandlers;e=b.length}for(var f=false,d=0;d<e;d++)if(b[d].objectModified(c,i))f=true;!f&&h.push({funcName:"changed",args:[{key:c,data:{}}]})}a._broadcastNotifications(h);a._deferredModifyNotifications={};a._listeningToNotifications=true})};a.stopHandlingNotifications=function(){this._listeningToNotifications=false};Object.defineProperty(a,"count",{"get":function(){return this._cachedCount}});Object.defineProperty(a,"hub",{"get":function(){return this._dataHub}});Object.defineProperty(a,"populationComplete",{"get":function(){return this._objectCollection.isPopulationComplete}});a._getCountFromObjectCollection=function(b){var a=this._objectCollection.size;if(b)this._cachedCount=a;return a};a._collectionChangedHandler=function(p){this._getCountFromObjectCollection(true);var j=this;if(this._invalidatePromise){this._invalidatePromise.then(function(){j._collectionChangedHandler(p)});return}var i=p.target,r=p.detail[0],A=r.length,c,e,d,f,a,g,h,o,v=this._addNotificationsCompletedHandlers,u=v.length,w=this._objectModifiedHandlers,l=w.length;if(this._listeningToNotifications){var B=this._notificationHandlers.length>0,q=u>0;if(!(B||l>0||q))return;var z=this._cachedCount,k=[],m=[];for(e=0;e<A;e++){c=r[e];switch(c.type){case b.added:if(this._invalidateNeeded){var s=this.dataSource;if(s){this._invalidatePromise=s.invalidateAll().then(function(){return s.itemFromIndex(0)}).then(function(){j._invalidatePromise=null;j._invalidateNeeded=false;j._collectionChangedHandler(p)});return}else this._invalidateNeeded=false}d=c.position;f=d+c.count-1;var y=f>d,C=y&&f<z-1?i.idAt(f+1):null;for(a=d;a<=f;a++){h=i.idAt(a);if(q)m[m.length]=h;if(this._getIndexFromCollectionIndex)g=this._getIndexFromCollectionIndex(a,true);else g=a;if(g>=0){var n;if(y)n=C;else n=g<z-1?i.idAt(a+1):null;var E=g>0&&typeof n!=="string"?i.idAt(a-1):null;k.push({funcName:"inserted",args:[{key:h,data:{}},E,n,g]})}}break;case b.modified:d=c.position;f=d+c.count-1;o=l>0?c.fields:null;for(a=d;a<=f;a++){h=i.idAt(a);for(var x=false,t=0;t<l;t++)if(w[t].objectModified(h,o))x=true;!x&&k.push({funcName:"changed",args:[{key:h,data:{}}]})}break;case b.removed:d=c.position;f=d+c.count-1;for(a=d;a<=f;a++){if(this._getIndexFromCollectionIndex)g=this._getIndexFromCollectionIndex(a,true);else g=a;g>=0&&k.push({funcName:"removed",args:[null,g]})}break;case b.reset:msSetImmediate(function(){!j._deactivated&&j._broadcastNotification("invalidateAll")});return;case b.populationComplete:k.push({funcName:"populationComplete"})}}this._broadcastNotifications(k);if(q&&m.length>0)for(e=0;e<u;e++)v[e](m)}else{var D=this._deferredModifyNotifications;for(e=0;e<A;e++){c=r[e];if(c.type===b.modified){d=c.position;f=d+c.count-1;o=l>0?c.fields:null;for(a=d;a<=f;a++){h=i.idAt(a);D[h]|=o}}}}};a._broadcastNotifications=function(d){var a=d.length;if(a>0){var c=a>1;c&&this._broadcastNotification("beginNotifications");for(var b=0;b<a;b++){var e=d[b];this._broadcastNotification(e.funcName,e.args)}c&&this._broadcastNotification("endNotifications")}};a._broadcastNotification=function(f,d){for(var b=this._notificationHandlers,a=0,g=b.length;a<g;a++){var c=b[a],e=c[f];Jx.isFunction(e)&&e.apply(c,d?d:[])}};a._removeHandlerFromArray=function(a,c){var b=a.indexOf(c);b!==-1&&a.splice(b,1)}})();(function(){var b=window.PhotoViewer,c=b.ObjectCollectionDSA,e=WinJS.Promise;b.AssetOnlyDSA=function(b,a){c.call(this,b,a);this._cachedFirstAssetPosition=this._objectCollection.firstAssetPosition};var d=b.AssetOnlyDSA;Jx.inherit(d,c);var a=d.prototype;a._getCountFromObjectCollection=function(c){var a=this._objectCollection.firstAssetPosition,b;if(Jx.isValidNumber(a))b=this._objectCollection.size-a;else{a=this._cachedFirstAssetPosition;b=0}if(c){this._cachedFirstAssetPosition=a;this._cachedCount=b}return b};a._getCollectionIndexFromIndex=function(b){return b+this._cachedFirstAssetPosition};a._getIndexFromCollectionIndex=function(a){return Jx.isValidNumber(a)?a-this._cachedFirstAssetPosition:null}})();(function(){var c=window.PhotoViewer,e=c.AnimationHelpers,d=c.DataHubHelpers,b=WinJS.Promise,h=WindowsLive.Photo.Viewer.DataModel.ObjectChangedEventFields,f=48,j=1024,i="itemsLoading";c.ItemExtent=function(d,b,c,a){this.left=d;this.top=b;this.width=c;this.height=null;this.index=a;this.id=null;this.thumbWidth=null;this.thumbHeight=null};function g(a){this._layout=a}var a=g.prototype;a.beginNotifications=function(){this._inBatch=true;this._invalidateFromIndex=null;this._forceLayout=false};a.endNotifications=function(){var a=this._invalidateFromIndex;if(Jx.isValidNumber(a)){var b=this._layout;b._invalidateCachesFromIndex(a);this._invalidateFromIndex=null;if(this._forceLayout){b._updateElementPositionsFromIndex(a+1);this._forceLayout=false}}this._inBatch=false};a.invalidateAll=function(){this._scheduleOrTriggerInvalidate(0)};a.inserted=function(c,b,d,a){this._handleInsertOrRemove(a)};a.removed=function(b,a){this._handleInsertOrRemove(a)};a.populationComplete=function(){this._layout._asyncPopulationNotificationHandler(true)};a.objectModified=function(c,d){if(d&h.dimensions){var b=this._layout,a=b._dataAdaptor.objectIdToIndex(c);if(a<b._count-1)this._forceLayout=true;this._scheduleOrTriggerInvalidate(a)}return false};a._scheduleOrTriggerInvalidate=function(b){var a=this._invalidateFromIndex;if(!Jx.isValidNumber(a)||b<a)this._invalidateFromIndex=b;!this._inBatch&&this.endNotifications()};a._handleInsertOrRemove=function(b){var a=this._layout,c=a._pendingInvalidateFromIndex;if(!Jx.isValidNumber(c)){if(b<a._itemExtents.length)a._pendingInvalidateFromIndex=b}else if(b<c)a._pendingInvalidateFromIndex=b};c.VariableWidthLayoutBase=function(g,a){this._dataAdaptor=g;this._options=a;this._site=null;this._listView=null;this._renderCallback=null;this._invalidateCallback=null;this._viewName=null;this._dataContainerId=null;this._containerItemHeight=a.shortenHeroShot?a.fixedHeight:a.fixedHeight+a.containerTitleHeight;this._onScreenSizeChanged=null;this._rtl=false;this._positionProperty=null;this._viewportSize=null;this._canvasWidth=0;this._canvasWidthNumExtents=0;this._itemExtents=[];this._pendingSizeRequestPromises={};this._pendingRefresh=false;this._firstItemInViewport=-1;this._lastItemInViewport=-1;this._cachedScrollPosition=0;this._lastScrollPositionForRenderUpdate=0;this._pendingScrollPosition=-1;this._pendingItemToScrollTo=null;this._pendingAutoScroll=false;this._scrollAttemptInProgress=false;this._viewportCompletionCallback=null;this._viewportCompletionPromise=null;this._firstLayout=true;this._renderUpdateNeeded=false;this._shutdown=false;this._pendingInvalidateFromIndex=null;this._pendingChangeAnimationInfo=null;this._moveAnimation=e.slideRepositionAnimation;this._insertAnimation=a.disableInsertAnimation?null:e.addToListAnimation;this._layoutNotificationHandler=null;if(a.refreshOnScreenSizeChange){var d=a.displayStateManager;if(d){var b=this;this._onScreenSizeChanged=function(){if(!b._dataAdaptor.isDeactivated()){b._containerItemHeight=a.shortenHeroShot?a.fixedHeight:a.fixedHeight+a.containerTitleHeight;b._invalidateCachesFromIndex(0);b._invalidateCallback()}};d.addSizeChangeCallback(this._onScreenSizeChanged)}}var c=Math.round(a.fixedHeight*4/3);if(!Jx.isValidNumber(a.itemMarginX))a.itemMarginX=0;if(!Jx.isValidNumber(a.containerItemWidth))a.containerItemWidth=c;if(!Jx.isValidNumber(a.failedItemWidth))a.failedItemWidth=c;if(!Jx.isValidNumber(a.averageWidthEstimate))a.averageWidthEstimate=c;if(!Jx.isValidNumber(a.minItemWidth))a.minItemWidth=f;if(!Jx.isValidNumber(a.maxItemWidth))a.maxItemWidth=j;if(!Jx.isValidNumber(a.containerTitleHeight))a.containerTitleHeight=0;if(!Jx.isValidNumber(a.leadingMargin))a.leadingMargin=0;if(!Jx.isValidNumber(a.trailingMargin))a.trailingMargin=0;this._count=this._dataAdaptor.count;this._registerNotificationHandlers()};a=c.VariableWidthLayoutBase.prototype;a.setSite=function(a){this._site=a;this._viewportSize=this._site.viewportSize;var b=this._rtl=a.rtl;this._positionProperty=b?"right":"left"};a.reset=function(){this._invalidateCachesFromIndex(0)};a.startLayout=function(o,j,e){if(this._shutdown)return b.wrap({beginIndex:0,endIndex:0});this._count=e;this._firstItemInViewport=-1;this._lastItemInViewport=-1;var a=this,n=this._firstLayout;if(e>0)try{var g=this._viewName,k=this._dataContainerId;if(n&&typeof g==="string"){c.log.perf("evPhotoViewerCollections_LoadDimensions_begin",{containerID:k,view:g,scrollPos:0});this._getItemExtent(e-1).then(function(){c.log.perf("evPhotoViewerCollections_LoadDimensions_end",{containerID:k,view:g,scrollPos:a._cachedScrollPosition})})}else this._getItemExtent(e-1)}catch(q){if(q.number===d.HResults.objectNotFoundError)Jx.log.warning("VWLB.startLayout object-not-found exception");else{Jx.promoteOriginalStack(q);throw q}}var f=this._viewportSize;this._viewportSize=this._site.viewportSize;if(Boolean(f)&&Boolean(this._onViewportSizeChanged)){var l=this._viewportSize;(f.width!==l.width||f.height!==l.height)&&this._onViewportSizeChanged()}this._canvasWidth=this._calcCanvasWidth(e);var p=this._listView,h=p.scrollPosition,i=this._pendingScrollPosition;if(i>=0&&h===i){this._pendingScrollPosition=-1;this._pendingAutoScroll=false;this._renderUpdateNeeded=true}this._cachedScrollPosition=h;if(j>0){var m=function(){var b=a._renderCallback;b&&b();a._renderUpdateNeeded=false};return this.calculateFirstVisible(o,false).then(function(b){return a.calculateLastVisible(j,false).then(function(c){if(a._shutdown)return{beginIndex:0,endIndex:0};if(!a._pendingAutoScroll)if(n||a._renderUpdateNeeded)m();else a.isRenderUpdateNeeded().then(function(a){a&&m()});a._firstLayout=false;return{beginIndex:b,endIndex:c+1}})})}else return b.wrap({beginIndex:0,endIndex:0})};a.prepareItem=function(){};a.releaseItem=function(){},a.layoutItem=function(b,a){if(this._shutdown)return;var c=this;this.getItemPosition(b).then(function(b){if(!a._animating)a.style.cssText+=";"+c._positionProperty+":"+String(b.left)+"px;top:"+String(b.top)+"px;width:"+String(b.contentWidth)+"px;height:"+String(b.contentHeight)+"px"})};a.endLayout=function(){if(this._shutdown)return b.wrap(null);var c=this._pendingChangeAnimationInfo;if(!c)return;var d,f=new b(function(a){d=a}),h=c.insertedElements,i=c.removedElements,g=c.oldPositionsByUniqueID;this._pendingChangeAnimationInfo=null;var a=this,j=this._listView;this._calcPrefetchRange().then(function(r){if(a._shutdown){d();return}for(var u=r.lastIndex,q=[],p=[],f=a._positionProperty,o=r.firstIndex;o<=u;o++){var l=j.elementFromIndex(o);if(l){var v=l.uniqueID,c=g[v],k=l.parentNode,b=k.style,m=parseInt(b[f],10),n=parseInt(b.top,10),s=c?c.left:null,t=c?c.top:null;if(Boolean(c)&&(m!==s||n!==t)){q.push(k);p.push({left:m,top:n});b[f]=String(s)+"px";b.top=String(t)+"px";k._animating=true}else if(!c){b[f]=String(m)+"px";b.top=String(n)+"px";b.opacity="1"}}}e.animateListReflow(a._site.surface,h,i,q,p,a._moveAnimation,a._rtl,a._insertAnimation).then(d,d)});return{animationPromise:f}};a.getScrollbarRange=function(c){if(this._shutdown)return b.wrap({beginScrollPosition:0,endScrollPosition:0});var d=this,a;if(c===this._count&&this._itemExtents.length===this._canvasWidthNumExtents)a=b.wrap(this._canvasWidth);else{this._count=c;a=this.calculateLastVisible(this._cachedScrollPosition+this._viewportSize.width-1,false).then(function(){return d._shutdown?0:d._canvasWidth=d._calcCanvasWidth(c)})}return a.then(function(a){return{beginScrollPosition:0,endScrollPosition:a}})};a.getItemPosition=function(c){if(this._shutdown)return b.wrap({left:0,top:0,contentWidth:0,contentHeight:0,offsetWidth:0,offsetHeight:0,totalWidth:0,totalHeight:0});if(this._canvasWidth===0&&this._count>0)this._canvasWidth=this._calcCanvasWidth(this._count);var a=this;return this._getItemExtent(c).then(function(c){var b={left:c.left,top:c.top||0},e=c.thumbWidth,d=c.thumbHeight;if(Jx.isValidNumber(e)){b.contentWidth=e;b.left+=Math.floor((c.width-e)/2)}else b.contentWidth=c.width;if(Jx.isValidNumber(d)){b.contentHeight=d;b.top+=Math.floor((a._options.fixedHeight-d)/2)}else if(Jx.isValidNumber(c.height))b.contentHeight=c.height;else b.contentHeight=a._options.fixedHeight;b.totalWidth=b.contentWidth;b.totalHeight=b.contentHeight;b.offsetWidth=b.contentWidth;b.offsetHeight=b.contentHeight;return b})};a.calculateFirstVisible=function(a,e){if(this._shutdown)return b.wrap(0);if(this._count===0){this._firstItemInViewport=0;return b.wrap(0)}else if(a===0)return b.wrap(0);var c=!e&&a===this._scrollPosition();if(c&&this._firstItemInViewport>=0)return b.wrap(this._firstItemInViewport);else try{var f=this;return this._calculateFirstVisible(a,e).then(function(a){if(c)f._firstItemInViewport=a;return a})}catch(g){if(g.number===d.HResults.objectNotFoundError){Jx.log.warning("VWLB.calculateFirstVisible object-not-found exception");return b.wrap(0)}else{Jx.promoteOriginalStack(g);throw g}}};a.calculateLastVisible=function(a,e){if(this._shutdown)return b.wrap(0);if(this._count===0){this._lastItemInViewport=0;return b.wrap(0)}else if(a===0)return b.wrap(0);var c=!e&&a===this._scrollPosition()+this._viewportSize.width-1;if(c&&this._lastItemInViewport>=0)return b.wrap(this._lastItemInViewport);else try{var f=this;return this._calculateLastVisible(a,e).then(function(a){if(c)f._lastItemInViewport=a;return a})}catch(g){if(g.number===d.HResults.objectNotFoundError){Jx.log.warning("VWLB.calculateLastVisible object-not-found exception");return b.wrap(0)}else{Jx.promoteOriginalStack(g);throw g}}};a.itemsAdded=function(a){this._dataModified(a,[],false)};a.itemsRemoved=function(a){this._dataModified([],a,false)};a.itemsMoved=function(){this._dataModified([],[],true)};Object.defineProperty(a,"horizontal",{"get":function(){return true}});a.setViewportSize=function(b,a){this._viewportSize={width:b,height:a};this._onViewportSizeChanged&&this._onViewportSizeChanged()};a.setLeadingMargin=function(a){this._options.leadingMargin=a;this.reset()};a.setListView=function(a){this._listView=a;this._onLoadingStateChanged=this._onLoadingStateChanged.bind(this);a.addEventListener("loadingstatechanged",this._onLoadingStateChanged,false)};a.setCallbacks=function(b,a){this._renderCallback=b;this._invalidateCallback=a};a.setLoggingInfo=function(b,a){this._viewName=b;this._dataContainerId=a};a.scrollToItem=function(a,b){if(this._shutdown)return;if(a===0){this.scrollToViewport(0);return}this._pendingAutoScroll=true;if(a>=this._count)this._pendingItemToScrollTo={itemIndex:a,centerItem:b};else{var c=this;this._getItemExtent(a).then(function(d){var a=Math.floor(c._scrollToItem(d,b));c.scrollToViewport(a)})}};a.scrollToViewport=function(b){if(this._shutdown)return;var a=this,c=function(c){var b=0,d=a._site;if(d)b=a._cachedScrollPosition=d.scrollbarPos;if(c!==b){a._pendingAutoScroll=true;a._pendingScrollPosition=c;a._firstItemInViewport=-1;a._lastItemInViewport=-1;return true}else a._pendingAutoScroll&&a._cancelAutoScroll();return false},d=c(b);this._ensureLayoutForCurrentViewport().then(function(){var f=a._canvasWidth=a._calcCanvasWidth(a._count),e=Math.max(f-a._viewportSize.width,0);if(b>e){b=e;d=c(e)}d&&Boolean(a._listView)&&a._tryScroll(b)})};a.forEachItemInViewport=function(c,f){if(this._shutdown||this._count===0)return b.wrap();var d=this._site;if(d)this._cachedScrollPosition=d.scrollbarPos;var e=this._scrollPosition(),a=this;return this._ensureLayoutForCurrentViewport().then(function(){return a.calculateFirstVisible(e,false).then(function(b){if(a._shutdown||a._count===0)return;var d=a._lastItemInViewport;Boolean(c)&&c(b,d);a._forEachItemInViewport(f,b,d)})})};a.forEachItemInPrefetchRange=function(c){if(this._shutdown||this._count===0)return b.wrap();this._cachedScrollPosition=this._site.scrollbarPos;var a=this._itemExtents;return this._calcPrefetchRange().then(function(d){for(var e=d.lastIndex,b=d.firstIndex;b<=e;b++)c(b,a[b].id)})};a.isItemInViewport=function(b){if(this._shutdown)return false;var c=this._scrollPosition(),f=this._itemExtents,a=f[b];if(!a){this._getItemExtent(b);a=f[b];if(!a){var d,e;this.calculateFirstVisible(c,false).then(function(a){d=a});this.calculateLastVisible(c+this._viewportSize.width-1,false).then(function(a){e=a});return Jx.isValidNumber(d)&&Jx.isValidNumber(e)?b>=d&&b<=e:true}}return a.left+a.width>c&&a.left<c+this._viewportSize.width};a.isRenderUpdateNeeded=function(){if(this._shutdown)return b.wrap(false);if(this._firstLayout||this._renderUpdateNeeded)return b.wrap(true);var a=this._cachedScrollPosition=this._site.scrollbarPos,c=this._lastScrollPositionForRenderUpdate;if(a!==c){this._lastScrollPositionForRenderUpdate=a;this._firstItemInViewport=-1;this._lastItemInViewport=-1;var d=this;return this._haveItemsScrolledIntoView(c).then(function(a){d._renderUpdateNeeded=a;return a})}return b.wrap(false)};a.shutdown=function(){this._shutdown=true;this._site=null;var c=this._listView;c&&c.removeEventListener("loadingstatechanged",this._onLoadingStateChanged,false);this._listView=null;if(this._onScreenSizeChanged){var d=this._options.displayStateManager;d.removeSizeChangeCallback(this._onScreenSizeChanged);this._onScreenSizeChanged=null}var b=this._dataAdaptor,a=this._layoutNotificationHandler;if(a){b.removeNotificationHandler(a);b.removeObjectModifiedHandler(a);b.removeAddNotificationsCompletedHandler(this._onAddNotificationsComplete)}this._renderCallback=null;this._invalidateCallback=null};Object.defineProperty(a,"viewportWidth",{"get":function(){return this._viewportSize.width}});Object.defineProperty(a,"pendingAutoScroll",{"get":function(){return this._pendingAutoScroll}});a._binarySearch=function(e,g,f){var c=0,b=e.length-1;while(c<=b){var a=Math.floor((c+b)/2),d=f(g,e[a]);if(d<0){b=a-1;continue}else if(d>0){c=a+1;continue}return a}return-1};a._ensureLayoutForCurrentViewport=function(){var c=this._viewportCompletionPromise;if(this._scrollAttemptInProgress)return c;var a=this,d=function(){if(a._viewportCompletionCallback){a._viewportCompletionCallback();a._viewportCompletionCallback=null;a._viewportCompletionPromise=null}a._scrollAttemptInProgress=false},e=this._count===0;if(this._lastItemInViewport>=0||e&&this._dataAdaptor.populationComplete){d();return b.wrap()}if(!c)c=this._viewportCompletionPromise=new b(function(b){a._viewportCompletionCallback=b});if(!e){this._scrollAttemptInProgress=true;var f=this._scrollPosition()+this._viewportSize.width-1;this.calculateLastVisible(f,false).then(function(b){a._getItemExtent(b).then(function(b){if(a._dataAdaptor.populationComplete||a._doesExtentCompleteViewport(b,f))d();else{a._lastItemInViewport=-1;a._scrollAttemptInProgress=false}})})}return c};a._invalidateCachesFromIndex=function(a){if(this._shutdown)return;var c=this._itemExtents,d=c.length;a<d&&c.splice(a,d-a);function e(e){for(var c=Object.keys(e),b=0,f=c.length;b<f;b++){var d=c[b];if(parseInt(d,10)>=a)delete e[d]}}e(this._pendingSizeRequestPromises);this._canvasWidthNumExtents=0;var b=this._lastItemInViewport;if(a<=b||b<0){this._firstItemInViewport=-1;this._lastItemInViewport=-1;this._renderUpdateNeeded=true}};a._updateElementPositionsFromIndex=function(a){var c=this,b=this._listView;this._calcPrefetchRange().then(function(g){var e=g.lastIndex;if(a<=e)for(var d=Math.max(a,g.firstIndex);d<=e;d++){var h=b.elementFromIndex(d);if(h){var f=h.parentNode;f._animating=false;c.layoutItem(d,f)}}})};a._getSizeData=function(e,l){var c=this,g=this._options,n=this._itemExtents,a,i=function(k,j){var d,h;if(!Jx.isValidNumber(k)||!Jx.isValidNumber(j)||k<=0||j<=0)h=g.failedItemWidth;else{d=c._calcDesiredItemSize(k,j);d.width=Math.max(d.width,f);d.height=Math.max(d.height,f);h=Math.max(d.width,g.minItemWidth)}var m=function(){if(d){if(d.width<h)a.thumbWidth=d.width;if(d.height<g.fixedHeight)a.thumbHeight=d.height}a.id=l.id;c._addItemExtent(a)};if(e===0)a=c._calcFirstExtent(h);else{var o=n[e-1];if(!o){var i=c._pendingSizeRequestPromises[e-1];if(!i)i=c._getItemExtent(e-1);return i.then(function(b){a=c._calcNextExtent(b,h);m();return a})}a=c._calcNextExtent(o,h)}m();return b.wrap(a)},j=this._pendingSizeRequestPromises,m=j[e];if(m)return m;var k=l.dimensions,h;if(k)h=i(k.width,k.height);else h=new b(function(a,b){l.getProperties(["width","height"],function(n,l,m){if(c._dataAdaptor.isDeactivated()){Jx.log.warning("_getSizeData_sizeCallback async callback after dsa was deactivated");b();return}delete j[e];var f=d.tryLookupPropertiesInMap(l,["width","height"]);if(f){var k=parseInt(f.width,10),h=parseInt(f.height,10);i(k,h).then(a)}else m&&i(g.failedItemWidth,g.fixedHeight).then(a)})});if(!a)j[e]=h;return h};a._getItemExtent=function(g){var e=this._itemExtents,j=e.length;if(g>=j){for(var l=this._dataAdaptor,i=this._options.containerItemWidth,k=this._containerItemHeight,h,a=j;a<=g;a++){var f=l.indexToObject(a);if(d.isContainerType(f.type)){var c;if(a===0)c=this._calcFirstExtent(i);else c=this._calcNextExtent(e[a-1],i);c.height=k;c.id=f.id;this._addItemExtent(c)}else h=this._getSizeData(a,f)}if(h)return h}return b.wrap(e[g])};a._lastItemExtent=function(){var a=this._itemExtents,b=a.length;return b===0?null:a[b-1]};a._scrollPosition=function(){var a=this._pendingScrollPosition;return a>=0?a:this._cachedScrollPosition};a._tryScroll=function(b){var a=this._listView;if(a.loadingState!==i)a.scrollPosition=b};a._cancelAutoScroll=function(){this._pendingAutoScroll=false;this._pendingItemToScrollTo=null;this._pendingScrollPosition=-1;var a=this._renderCallback;Boolean(this._site)&&Boolean(a)&&a()};a._registerNotificationHandlers=function(){var a=this._dataAdaptor,c=a.setNotificationHandler;if(c){var b=this._layoutNotificationHandler=new g(this);a.setNotificationHandler(b);a.addObjectModifiedHandler(b);this._onAddNotificationsComplete=this._onAddNotificationsComplete.bind(this);a.setAddNotificationsCompletedHandler(this._onAddNotificationsComplete)}};a._calcPrefetchRange=function(){var a=this._cachedScrollPosition,b=this._viewportSize.width,c=this.calculateFirstVisible(Math.max(0,a-b),false),d=this.calculateLastVisible(a+2*b-1,false);return WinJS.Promise.join({firstIndex:c,lastIndex:d})};a._getExtentsUntilCondition=function(l,i,f){for(var e=this,a=l,j=this._itemExtents,k=j.length,g,c;a<k;a++){g=j[a];c=i(g);if(c)return b.wrap(c)}var d=Math.min(this._count,this._dataAdaptor.count);if(a>=d)return b.wrap(f);do{this._getItemExtent(a);g=j[a];if(!g)break;c=i(g);if(c)return b.wrap(c)}while(++a<d);if(a>=d)return b.wrap(f);for(var h=b.wrap(a);!c&&a<d;a++)h=h.then(function(a){return e._getItemExtent(a).then(function(d){if(e._shutdown){c=f;return b.wrapError({name:"BreakLoop"})}c=i(d);return c?b.wrapError({name:"BreakLoop"}):a+1})});h=h.then(function(){return!e._shutdown&&d<Math.min(e._count,e._dataAdaptor.count)?e._getExtentsUntilCondition(d,i,f):f},function(a){return a.name==="BreakLoop"?b.wrap(c):b.wrapError(a)});return h};a._addItemExtent=function(a){var b=a.index;this._itemExtents[b]=a};a._dataModified=function(c,g,n){if(this._shutdown)return;try{if(c.length>0||g.length>0||n){var b=this._pendingChangeAnimationInfo;if(b){e.mergeArrays(b.insertedElements,c);e.mergeArrays(b.removedElements,g)}else{b=this._pendingChangeAnimationInfo={insertedElements:c,removedElements:g,oldPositionsByUniqueID:{}};var l=b.oldPositionsByUniqueID,i={},a,k,f;for(a=0,k=c.length;a<k;a++){f=c[a].uniqueID;i[f]=true}var j=this,o=this._listView,m=false;this._calcPrefetchRange().then(function(c){if(j._shutdown)return;m=true;var d=c.lastIndex,k=j._positionProperty;for(a=c.firstIndex;a<=d;a++){var b=o.elementFromIndex(a);if(b){var n=b.parentNode,h=n.style,e=parseInt(h[k]),g=parseInt(h.top);f=b.uniqueID;if(Jx.isValidNumber(e)||Jx.isValidNumber(g))l[f]={left:e,top:g};else if(i[f])d++}}})}var h=this._pendingInvalidateFromIndex;if(Jx.isValidNumber(h)){this._invalidateCachesFromIndex(h);this._pendingInvalidateFromIndex=null}}}catch(p){p.number!==d.HResults.objectNotFoundError}};a._onAddNotificationsComplete=function(){this._asyncPopulationNotificationHandler(false)};a._asyncPopulationNotificationHandler=function(b){var c=this._count=this._dataAdaptor.count,a=this._pendingItemToScrollTo;if(a)if(a.itemIndex<c){this.scrollToItem(a.itemIndex,a.centerItem);this._pendingItemToScrollTo=null}else b&&this._cancelAutoScroll();this._viewportCompletionPromise&&this._ensureLayoutForCurrentViewport()};a._onLoadingStateChanged=function(){var a=this._pendingScrollPosition;a>=0&&this._tryScroll(a)}})();(function(){var c=window.PhotoViewer,g=c.Graphics,f=PhotoViewer.ViewHelpers,d=WinJS.Promise,b={defaultHeight:455,fractionOfScreenHeight:.59,maxHeight:720,snapToMultiple:5,containerAndFailedItemAspectRatio:270/455,averageAspectRatioEstimate:4/3,maxAspectRatio:1024/455,headerHeight:137},e={fractionOfScreenHeight:.64,headerHeight:73,overrideApplied:false};c.FilmstripLayout=function(b,a){c.VariableWidthLayoutBase.call(this,b,a);if(!Jx.isValidNumber(a.topMargin))a.topMargin=0};Jx.inherit(c.FilmstripLayout,c.VariableWidthLayoutBase);var a=c.FilmstripLayout.prototype;c.FilmstripLayout.megastripLayoutOptions={itemMarginX:10,containerTitleHeight:80,shortenHeroShot:false,refreshOnScreenSizeChange:true,displayStateManager:null,updateScale:function(){if(PhotoViewer.Coordinator.filePickerMode&&!e.overrideApplied){for(var c in e)if(c!=="overrideApplied")b[c]=e[c];e.overrideApplied=true}if(this.displayStateManager.isAppSnapped())this.leadingMargin=this.trailingMargin=f.LeadingAndTrailingMargin.snapped;else this.leadingMargin=this.trailingMargin=f.LeadingAndTrailingMargin.normal;var i=b.maxHeight,g=b.snapToMultiple,h=document.body.clientHeight,d=h*b.fractionOfScreenHeight,a;if(d>i){a=this.fixedHeight=i;var j=b.headerHeight;this.topMargin=f.snapToMultiple((h-a-this.containerTitleHeight)/2-j,g)}else{a=this.fixedHeight=f.snapToMultiple(d,g);this.topMargin=0}this.containerItemWidth=this.failedItemWidth=Math.round(a*b.containerAndFailedItemAspectRatio);this.averageWidthEstimate=Math.round(a*b.averageAspectRatioEstimate);this.maxItemWidth=Math.round(a*b.maxAspectRatio);return a/b.defaultHeight}};a.getKeyboardNavigatedItem=function(g,j,i){if(this._shutdown)return d.wrap(0);var f=this._options,a=WinJS.Utilities.Key,e=i;if(this._rtl)switch(i){case a.leftArrow:e=a.rightArrow;break;case a.rightArrow:e=a.leftArrow}var b;switch(e){case a.leftArrow:case a.upArrow:b=g-1;break;case a.rightArrow:case a.downArrow:b=g+1;if(b===this._count)b=-1;break;case a.pageUp:case a.pageDown:var h=this._itemExtents[g],c=h.left;if(e===a.pageUp){c-=this._viewportSize.width;if(c<=f.leadingMargin)return d.wrap(0)}else{c+=Math.max(this._viewportSize.width,h.width+f.itemMarginX);if(c>=this._canvasWidth-f.trailingMargin)return d.wrap(this._count-1)}return this._hitTestAsync(c,0);default:throw new Error("Unexpected key: "+String(e))}return d.wrap(b)};a.hitTest=function(a){if(this._shutdown)return 0;if(this._rtl)a=this._canvasWidth-a;var b=this._lastItemExtent(),d=b?this._calcNextLeft(b):0,c=this._options.itemMarginX/2;return this._hitTestSync(a,d,true,c)};a._calculateFirstVisible=function(a,d){var b=this,c=this._options.itemMarginX;return this._hitTestAsync(a,c).then(function(c){if(b._shutdown)return 0;if(c===-1)c=0;var e=b._itemExtents[c];if(d&&a>e.left)c++;return c})};a._calculateLastVisible=function(b,c){var a=this;return this._hitTestAsync(b,0).then(function(d){if(a._shutdown)return 0;if(d===-1)d=Math.max(a._count-1,0);return c?a._getItemExtent(d).then(function(a){if(a.left+a.width>b)d--;return d}):d})};a._scrollToItem=function(b,c){var a;if(c)a=b.left-this._viewportSize.width/2+b.width/2;else a=b.left-this._options.leadingMargin;return Math.max(a,0)};a._forEachItemInViewport=function(e,c,d){for(var b=this._itemExtents,a=c;a<=d;a++)if(!e(a,b[a].id))break};a._haveItemsScrolledIntoView=function(b){var a=this._cachedScrollPosition,d=this;if(a<b)return this.calculateFirstVisible(a,false).then(function(c){var a=d._itemExtents[c];return a.left+a.width<=b});else{var c=this._viewportSize.width;return this.calculateLastVisible(a+c-1,false).then(function(a){return d._itemExtents[a].left>=b+c})}};a._calcNextLeft=function(a){return a.left+a.width+this._options.itemMarginX};a._calcFirstExtent=function(b){var a=this._options;return new c.ItemExtent(a.leadingMargin,a.topMargin,b,0)};a._calcNextExtent=function(a,b){var e=this._options,d=this._calcNextLeft(a);return new c.ItemExtent(d,e.topMargin,b,a.index+1)};a._calcDesiredItemSize=function(a,b){var d=this._options,c=d.fixedHeight,f=d.minItemWidth,e=d.maxItemWidth;return b>c||a>e?g.scaleAspect(e,c,false,a,b):a<f?g.scaleAspect(f,c,false,a,b):{width:a,height:b}};a._calcCanvasWidth=function(e){if(e===0)return 0;var b=this._options,a=this._lastItemExtent(),d=a?a.index:-1,f=a?this._calcNextLeft(a):this._calcFirstExtent(0).left,c=f;c+=Math.max(e-d-1,0)*(b.averageWidthEstimate+b.itemMarginX);c+=b.trailingMargin;this._canvasWidthNumExtents=d+1;return c};a._doesExtentCompleteViewport=function(a,b){return a.left+a.width+this._options.itemMarginX>b};a._hitTestAsync=function(b,c){var a=this._lastItemExtent(),e=a?a.index:-1,f=a?this._calcNextLeft(a):0;if(b<f||e===this._count-1){var i=this._hitTestSync(b,f,false,c);return d.wrap(i)}else{var j=this,h=b+c,g=function(a){return j._calcNextLeft(a)>h?a.index:null};return this._getExtentsUntilCondition(e+1,g,-1)}};a._hitTestSync=function(a,e,b,d){var c=this._count;if(c===0||a<this._options.leadingMargin)return b?0:-1;else if(e<=a)return b?c-1:-1;var f=this;return this._binarySearch(this._itemExtents,a,function(b,a){return b+d<a.left?-1:b>=f._calcNextLeft(a)?1:0})}})();(function(){var c=window.PhotoViewer,m=c.AnimationHelpers,k=c.ViewHelpers,l=c.Graphics,b=WinJS.Promise,d=[85,180,275,370,465],i=d[1],f={pillarboxingCutoff:.5,itemWidthCutoffs:[1,1.854,2.658,3.457],letterboxingCutoff:4},j={appMode:114,filePickerMode:30};function g(f,d,e,b,a){c.ItemExtent.call(this,f,d,e,b);this.pageNumber=a}Jx.inherit(g,c.ItemExtent);c.PuzzleLayout=function(d,b){var a=e.puzzleViewLayoutOptions;if(Jx.isValidNumber(b))a.bottomMargin=b;else a.bottomMargin=c.Coordinator.filePickerMode?j.filePickerMode:j.appMode;c.VariableWidthLayoutBase.call(this,d,a);this._pageStartIndices=[0];this._pageWidth=0;this._rowCount=0;this._topOfLastRow=0;this._cachedKeyFocusLeftPos=-1;this._lastKeyboardNavigationResult=-1;this._moveAnimation=m.crossfadeRepositionAnimation};var e=c.PuzzleLayout;Jx.inherit(e,c.VariableWidthLayoutBase);var a=e.prototype,h=c.VariableWidthLayoutBase.prototype;e.puzzleViewLayoutOptions={fixedHeight:120,itemMarginX:10,containerItemWidth:i,failedItemWidth:i,minItemWidth:d[0],maxItemWidth:d[d.length-1],containerTitleHeight:30,shortenHeroShot:true,trailingMargin:30,itemMarginY:10,refreshOnScreenSizeChange:false};a.setSite=function(){h.setSite.apply(this,arguments);this._updateViewportSizeDependents()};a.getKeyboardNavigatedItem=function(d,g,f){if(this._shutdown)return b.wrap(0);var c=WinJS.Utilities.Key,e=f;if(this._rtl)switch(f){case c.leftArrow:e=c.rightArrow;break;case c.rightArrow:e=c.leftArrow}var a=this;switch(e){case c.leftArrow:case c.rightArrow:this._cachedKeyFocusLeftPos=-1;return b.wrap(this._lastKeyboardNavigationResult=e===c.leftArrow?d-1:d+1);case c.upArrow:case c.downArrow:return this._getItemExtent(d).then(function(h){var k=a._options,j=k.fixedHeight+k.itemMarginY,g=h.top;if(e===c.upArrow&&g===0||e===c.downArrow&&g===a._topOfLastRow)return a._lastKeyboardNavigationResult=d;else{var b;if(d===a._lastKeyboardNavigationResult&&a._cachedKeyFocusLeftPos>=0)b=a._cachedKeyFocusLeftPos;else{b=h.left;a._cachedKeyFocusLeftPos=b}var f;if(e===c.upArrow){for(f=d-1;f>=0;f--){var i=a._itemExtents[f];if(i.top<g&&i.left<=b)break}return a._lastKeyboardNavigationResult=f}else{var m=h.pageNumber,l=function(c){var d=c.top-g;return d===j&&c.left>b||d>j||c.pageNumber>m?a._lastKeyboardNavigationResult=c.index-1:null};return a._getExtentsUntilCondition(d+1,l,a._count-1)}}});case c.pageUp:return this._getItemExtent(d).then(function(e){if(a._shutdown)return 0;var c=e.pageNumber;return c===0?a._lastKeyboardNavigationResult=0:b.join({firstItemOnPrevPage:a._calcFirstItemOnPage(c-1),firstItemOnPage:a._calcFirstItemOnPage(c)}).then(function(c){var e=c.firstItemOnPrevPage,b=c.firstItemOnPage;return a._lastKeyboardNavigationResult=Math.min(e+(d-b),b-1)})});case c.pageDown:return this._getItemExtent(d).then(function(e){if(a._shutdown)return 0;var c=e.pageNumber;return a._calcFirstItemOnPage(c+1).then(function(e){return e===-1?a._lastKeyboardNavigationResult=a._count-1:b.join({firstItemOnPage:a._calcFirstItemOnPage(c),firstItemTwoPagesOut:a._calcFirstItemOnPage(c+2)}).then(function(c){var f=c.firstItemOnPage,b=c.firstItemTwoPagesOut;if(b===-1)b=a._count;return a._lastKeyboardNavigationResult=Math.min(e+(d-f),b-1)})})});default:throw new Error("Unexpected key: "+String(e))}};a.hitTest=function(a,m){if(this._shutdown)return 0;var d=this._options,f=d.leadingMargin,j=this._count;if(this._rtl)a=this._canvasWidth-a;if(j===0||a<f)return 0;var g=this._itemExtents,e=this._pageStartIndices,l=this._pageWidth,h=Math.floor((a-f)/l),b=e.length>h+1?e[h+1]-1:j-1,c=g[b],i=d.fixedHeight+d.itemMarginY,k=(Math.floor(m/i)+1)*i;while(c.top>=k||c.left>a){b--;c=g[b]}return b};a._calculateFirstVisible=function(a,g){var e=this._options,j=this._count,f=this._pageWidth,d=e.leadingMargin+f-e.pageGap;if(g)d-=e.minItemWidth;var c;if(a>=d){var i=Math.floor((a-d)/f)+1;c=this._calcFirstItemOnPage(i)}else c=b.wrap(0);var h=this;return c.then(function(c){if(h._shutdown)return 0;var b=function(b){return g?b.left>=a:b.left+b.width>a?b.index:null};return h._getExtentsUntilCondition(c,b,j-1)})};a._calculateLastVisible=function(d,g){var h=this._options,f=this._pageWidth,c=d+1,e=0,b=h.leadingMargin+f;if(g)b+=h.minItemWidth;if(c>b)e=Math.ceil((c-b)/f);var a=this;return this._calcFirstItemOnPage(e+1).then(function(b){if(a._shutdown)return 0;if(b<0)b=Math.min(a._count,a._dataAdaptor.count)-1;else b--;var f=a._itemExtents,e=f[b];while(g?e.left+e.width>c:e.left>d){b--;e=f[b]}return b})};a._scrollToItem=function(b,c){var a;if(c)a=Math.max(b.left-this._viewportSize.width/2+b.width/2,0);else a=b.pageNumber*this._pageWidth;return a};a._forEachItemInViewport=function(f,c,h){var e=this._itemExtents;if(f(c,e[c].id))for(var d=this._scrollPosition(),g=d+this._viewportSize.width,b=c+1;b<=h;b++){var a=e[b];if(a.left+a.width>d&&a.left<g)if(!f(b,a.id))return}};a._haveItemsScrolledIntoView=function(r){var q=this._cachedScrollPosition,i=this._options,m=i.leadingMargin,c=r-m,a=q-m;if(a>c){var n=this._viewportSize.width;c+=n;a+=n}else{c=Math.max(c,0);a=Math.max(a,0)}if(c===a)return b.wrap(false);var d=this._pageWidth,p=Math.floor(c/d),o=Math.floor(a/d),k=o-p;if(k>0||k<-1)return b.wrap(true);var g=d-i.pageGap,s=i.minItemWidth,j=i.itemMarginX,h=s+j,f=c-p*d,e=a-o*d;if(k===0){var l=function(b,a,e){if(a>=g)return false;else if(b>=g)return!e||a<g-h;else{var c=Math.floor(b/h),d=Math.floor(a/h);return c>d}};return e<f?b.wrap(l(f+j,e+j,false)):b.wrap(l(e,f,true))}else if(f<h&&e>=g)return b.wrap(false);return b.wrap(true)};a._onViewportSizeChanged=function(){this._updateViewportSizeDependents();this._invalidateCachesFromIndex(0)};a._updateViewportSizeDependents=function(){var a=this._options,b=this._viewportSize,f=a.displayStateManager;if(f.isAppSnapped())a.leadingMargin=a.pageGap=k.LeadingAndTrailingMargin.snapped;else a.leadingMargin=a.pageGap=k.LeadingAndTrailingMargin.normal;this._pageWidth=b.width-a.leadingMargin-a.trailingMargin+a.pageGap;if(this._site){var c=this._site.viewport.style;c["-ms-scroll-snap-type"]="proximity";c["-ms-scroll-snap-points-x"]="snapInterval(0px, "+this._pageWidth.toString()+"px)"}var d=a.itemMarginY,e=a.fixedHeight+d;this._rowCount=Math.floor((b.height-a.bottomMargin+d)/e);this._topOfLastRow=(this._rowCount-1)*e};a._calcFirstExtent=function(a){return new g(this._options.leadingMargin,0,a,0,0)};a._calcNextExtent=function(b,f){var c=this._options,d=this._pageWidth,e=c.leadingMargin+b.pageNumber*d,a=new g(b.left+b.width+c.itemMarginX,b.top,f,b.index+1,b.pageNumber);if(a.left+f>e+d-c.pageGap)if(a.top<this._topOfLastRow){a.left=e;a.top+=c.fixedHeight+c.itemMarginY}else{a.left=e+d;a.top=0;a.pageNumber++}return a};a._calcDesiredItemSize=function(b,c){var h=this._options,g=h.fixedHeight,j=h.minItemWidth,e=b/c;if(e<f.pillarboxingCutoff||b<j)return l.scaleAspect(j,g,false,b,c);else if(e>f.letterboxingCutoff)return l.scaleAspect(h.maxItemWidth,g,false,b,c);else{var i=f.itemWidthCutoffs,a=0,k=i.length;while(a<k&&i[a]<=e)a++;return{width:d[a],height:g}}};a._calcCanvasWidth=function(c){if(c===0)return 0;var b=this._options,h=this._pageWidth,g=h-b.pageGap,d=b.averageWidthEstimate,a=this._lastItemExtent()||this._calcFirstExtent(d),e=a.pageNumber;if(a.index<c-1)for(var f=a.index;f<c;f++){a=this._calcNextExtent(a,d);if(a.pageNumber>e){var i=Math.floor((g+b.itemMarginX)/(d+b.itemMarginX))*this._rowCount;e+=Math.ceil((c-f)/i);break}}this._canvasWidthNumExtents=a.index+1;return b.leadingMargin+e*h+g+b.trailingMargin};a._calcFirstItemOnPage=function(a){var c=this._pageStartIndices[a];if(typeof c==="number")return b.wrap(c);else{var d=function(b){return b.pageNumber===a?b.index:null};return this._getExtentsUntilCondition(this._itemExtents.length,d,-1)}};a._invalidateCachesFromIndex=function(d){h._invalidateCachesFromIndex.apply(this,arguments);var b=this._pageStartIndices;if(b)for(var a=0,c=b.length;a<c;a++)if(b[a]>=d){b.splice(a,c-a);break}};a._addItemExtent=function(b){h._addItemExtent.apply(this,arguments);var a=this._pageStartIndices;b.pageNumber===a.length&&a.push(b.index)};a._doesExtentCompleteViewport=function(a,c){var e=this._options,b=a.pageNumber+1;if(c>=e.leadingMargin+b*this._pageWidth)return false;var f=this._pageStartIndices[b];if(typeof f==="number")return true;if(a.top<this._topOfLastRow)return false;var d=this._calcNextExtent(a,e.minItemWidth);return d.pageNumber===b||d.left>c}})();(function(){var d=window.PhotoViewer,c=d.DataHubHelpers,l=d.Graphics,v=WinJS.Promise,h=d.ViewHelpers,m=d.SourcesHelpers,u=c.SourceType,p=WindowsLive.Photo.Viewer.DataModel,e=p.BlobResultQuality,f=p.ObjectChangedEventFields,q=d.ImgCache.ImgSizes;l.enableFadeIns=true;var b={removed:-1,none:0,custom:1,partialPlaceholder:2,placeholder:3,lowResThumbnail:4,completed:5},g={succeeded:0,failed:1,canceled:2,postponed:3,partial:4,lowQuality:5},o={large:{cssClass:"thumbsView-largePlayGlyph",size:36}},n={metadataOnly:"metadataOnly",reloadAll:"reloadAll"},r=150,t=500,s="Canceled",j={itemsLoading:"itemsLoading",viewPortLoaded:"viewPortLoaded",itemsLoaded:"itemsLoaded",complete:"complete"};d.ThumbsView=function(f,e,c,a){this._hostElement=f;this._dataAdaptor=e;this._customLayout=c;this._options=a;this._doEtwLogging=Jx.isNonEmptyString(a.viewName);this._disabled=a.deactivated;this._progressBar=new PhotoViewer.ProgressBarTimer(this._options.progressBarContainerId);if(!Jx.isValidNumber(a.containerTitleHeight))a.containerTitleHeight=0;if(!a.scalingCallback)a.scalingCallback=function(a){return a};this._setFocusPendingAnimationCompletion=false;this._cachedItemDivs={};this._videoGlyphWidthPlusMargins=null;this._pendingEndEvents={};this._pendingThumbnailPromises={};this._postponedThumbnailResults={};this._pendingImgsToAdd={};this._remainingBatchableItems=0;this._thumbnailUpdatesToSkip={};this._runEntranceAnimationPromise=null;this._runEntranceAnimation=null;this._onEntranceAnimationRunning=null;this._attemptedToRunEntranceAnimation=false;c.setViewportSize(f.offsetWidth,f.offsetHeight);c.setCallbacks(this._finishRenderingItemsInViewport.bind(this),this._invalidateAll.bind(this));if(this._doEtwLogging){c.setLoggingInfo(a.viewName,a.dataContainerId);if(!a.deactivated)this._pendingEndEvents[a.dataContainerId]={endEventName:"evPhotoViewerCollections_RenderNewView_end"}}this.enterView();this._addObjectModifiedHandler();var o=this,i=a.customRenderer;if(i)i.setSite&&i.setSite({onCustomItemRenderComplete:function(c,d){d.msLoadingCount=0;var a=e.objectIdToIndex(c);a>=0&&o._updateItemRenderState(a,c,d,b.completed)}});var g=a.itemIndex,j=a.scrollbarPosition,k=Jx.isValidNumber(j);if(Jx.isValidNumber(g)){this._pendingItemToFocus=g;g>0&&!k&&c.scrollToItem(g,a.centerActiveItem)}k&&j>0&&c.scrollToViewport(j);if(!a.deactivated){var l=this._cachedItemDivs;c.forEachItemInViewport(null,function(d,a){if(!l[a]){var c=e.objectIdToObject(a),f=c.type,b=document.createElement("div");b.msLoadingCount=0;b.msObjectId=a;l[a]=b;o._startRenderingItem({object:c,id:a,type:f},d,b,false)}return true})}var p=WinJS.UI.simpleItemRenderer(this._itemRendererCallback.bind(this)),m=new d.VirtualizedDataSource(e);e.dataSource=m;var n=this._listView=new WinJS.UI.ListView(f,{itemDataSource:m,itemTemplate:p,layout:c,selectionMode:a.selectionMode,tapBehavior:a.tapBehavior||WinJS.UI.TapBehavior.invokeOnly});Jx.addClass(f,"win-selectionstylefilled");c.setListView(n);if(a.disableEntranceAnimation||a.delayEntranceAnimation){this._onListViewContentAnimation=this._onListViewContentAnimation.bind(this);this.addListViewEventListener("contentanimating",this._onListViewContentAnimation)}this._onLoadingStateChanged=this._onLoadingStateChanged.bind(this);this.addListViewEventListener("loadingstatechanged",this._onLoadingStateChanged);n.resetItem=this._onResetItem.bind(this);var h=Jx.activation;h.addListener(h.suspending,this._onAppSuspend,this);h.addListener(h.resuming,this._onAppResume,this)};var i=d.ThumbsView;i.Events={initialViewPlaceholderRenderComplete:"initialViewPlaceholderRenderComplete",viewportFullyRendered:"viewportFullyRendered"};Jx.augment(i,Jx.Events);i.ScrollToItemPosition={noDesiredPosition:"noDesiredPosition",leftEdge:"leftEdge",center:"center"};var k=i.ScrollToItemPosition,a=d.ThumbsView.prototype;a.enterView=function(){var a=this._options;this._doEtwLogging&&d.log.perf("evPhotoViewerCollections_EnterView",{containerID:a.dataContainerId,view:a.viewName,scrollPos:0});a.customRenderer&&a.customRenderer.invalidateAll();this._enteringView=true;this._viewportRenderLevel=b.none;this._pendingItemToFocus=null;this._pendingViewportRenderLevelUpdate=false;this._doRenderUpdate=true};a.getFirstVisibleIndexAsync=function(a){return this._customLayout.calculateFirstVisible(this.scrollbarPosition,a)};a.elementFromIndex=function(b){var a=this._listView;if(!a)a=this._hostElement.winControl;return a.elementFromIndex(b,true)};a.indexOfElement=function(a){return this._listView.indexOfElement(a)};a.addListViewEventListener=function(b,a){this._listView.addEventListener(b,a,false)};a.removeListViewEventListener=function(b,a){this._listView.removeEventListener(b,a,false)};a.forceLayout=function(){this._listView.forceLayout()};a.setFocusIndex=function(b,a){return this._scrollOrSetFocusIndex(b,a,true)};a.setScrollToIndex=function(b,a){this._scrollOrSetFocusIndex(b,a,false)};a.updateItemThumbnail=function(c,a,d){var e=this._getObjectInfo(a.msObjectId);if(a.msRenderState>=b.placeholder)if(Jx.isValidNumber(a.msThumbnailVersion))a.msThumbnailVersion++;else a.msThumbnailVersion=0;var f=this;this._customLayout.getItemPosition(c).then(function(b){f._loadThumbnail(e,c,b,a,a.msThumbnailVersion,d)})};a.beginDeactivate=function(){this._disabled=true;this._cancelAnyPendingThumbnails();this._cachedItemDivs={};if(this._doEtwLogging){var f=this._options,h=f.dataContainerId,e=f.viewName,b=this._pendingEndEvents;for(var a in b)if(a===h)d.log.perf(b[a].endEventName,{containerID:a,view:e,scrollPos:this._listView.scrollPosition,status:g.canceled});else{var c=b[a];d.log.perf(c.endEventName,{itemID:a,index:c.index,view:e,status:g.canceled})}}this._progressBar.suppressProgressBarIfNecessary()};a.cancelDeactivate=function(){this._disabled=false;var a=this._options;if(this._viewportRenderLevel<b.completed){this._progressBar.scheduleProgressBarIfNecessary();if(this._doEtwLogging)this._pendingEndEvents[a.dataContainerId]={endEventName:"evPhotoViewerCollections_RenderNewView_end"};this._doRenderUpdate=true;this._finishRenderingItemsInViewport()}else this._doEtwLogging&&d.log.perf("evPhotoViewerCollections_RenderNewView_end",{containerID:a.dataContainerId,view:a.viewName,scrollPos:this._listView.scrollPosition,status:g.succeeded})};a.shutdown=function(){this._doEtwLogging;!this._disabled&&this.beginDeactivate();var c=this._objectModifiedHandler;if(c){this._dataAdaptor.removeObjectModifiedHandler(c);this._objectModifiedHandler=null}var a=this._options;(a.disableEntranceAnimation||a.delayEntranceAnimation)&&this.removeListViewEventListener("contentanimating",this._onListViewContentAnimation);this.removeListViewEventListener("loadingstatechanged",this._onLoadingStateChanged);var b=Jx.activation;b.removeListener(b.suspending,this._onAppSuspend,this);b.removeListener(b.resuming,this._onAppResume,this);if(a.customRenderer){a.customRenderer.invalidateAll();a.customRenderer.shutdown&&a.customRenderer.shutdown();a.customRenderer=null}var d=this._customLayout;if(d){d.shutdown();this._customLayout=null}};a.isInitialViewPlaceholderRenderComplete=function(){return this._viewportRenderLevel>b.none&&!this._customLayout.pendingAutoScroll};a.isViewportFullyRendered=function(){return this._viewportRenderLevel===b.completed};a.isItemInViewport=function(b){var a=this._customLayout;return Boolean(a)&&a.isItemInViewport(b)};a.delayEntranceAnimation=function(){var a=this._options;if(a){a.delayEntranceAnimation=true;a.disableEntranceAnimation=false}};a.runEntranceAnimation=function(){var a;if(this._runEntranceAnimation){this._runEntranceAnimation();this._runEntranceAnimation=null}else{this._attemptedToRunEntranceAnimation=true;var b=this;a=new WinJS.Promise(function(a){b._onEntranceAnimationRunning=a})}if(!a)a=WinJS.Promise.wrap();return a};Object.defineProperty(a,"disabled",{"get":function(){return this._disabled}});Object.defineProperty(a,"loadingState",{"get":function(){return this._listView.loadingState}});Object.defineProperty(a,"selection",{"get":function(){return this._listView.selection}});Object.defineProperty(a,"itemDataSource",{"get":function(){return this._listView.itemDataSource}});Object.defineProperty(a,"scrollbarPosition",{"get":function(){return this._listView.scrollPosition},"set":function(a){this._customLayout.scrollToViewport(a)}});Object.defineProperty(a,"focusedIndex",{"get":function(){var a=this._listView.currentItem;return a.hasFocus?a.index:null}});a._invalidateAll=function(){this._cachedItemDivs={};this._dataAdaptor.reloadView()};a._scrollOrSetFocusIndex=function(c,e,f){if(e!==k.noDesiredPosition){this._customLayout.scrollToItem(c,e===k.center);if(!f)this._pendingItemToFocus=null}if(f){var b=false;if(!Boolean(this._listView)||this._setFocusPendingAnimationCompletion)b=true;else if(this._options.getAnimationCompletionPromise){var d=this._options.getAnimationCompletionPromise();if(d){var a=this;d.then(function(){a._setFocusPendingAnimationCompletion=false;var b=a._pendingItemToFocus;!a._disabled&&Jx.isValidNumber(b)&&a._scrollOrSetFocusIndex(b,k.noDesiredPosition,true)});this._setFocusPendingAnimationCompletion=true;b=true}}if(b)this._pendingItemToFocus=c;else{this._listView.currentItem={index:c,hasFocus:true};this._pendingItemToFocus=null;return true}}return false};a._onAppSuspend=function(){this._postponedThumbnailResults={}};a._onAppResume=function(){try{var e=this._dataAdaptor;if(!this._disabled&&!e.isDeactivated()){var a=this,c=this._customLayout,d=this._viewportRenderLevel===b.completed;c.forEachItemInPrefetchRange(function(f,g){var e=a._cachedItemDivs[g]||a.elementFromIndex(f);if(e){var h=e.msLoadingCount;if(h>0){var i=e.msLoadingImg;if(!i||h>1){e.msLoadingCount=i?1:0;a._finishRenderingItem(f,g,e,true)}}else e.msRenderState<b.completed&&e.msRenderState>=b.partialPlaceholder&&(d||c.isItemInViewport(f))&&a._finishRenderingItem(f,g,e)}})}}catch(f){Jx.log.error("Hit an exception while running the app-resume handlers: "+String(f))}};a._itemRendererCallback=function(v,q,u){var d=v.key;if(this._disabled){var g=document.createElement("div");Jx.addClass(g,"photoViewer-placeholder");g.msObjectId=d;g.msRenderState=b.partialPlaceholder;g.msLoadingCount=0;return g}var t=this._dataAdaptor,e=v.index;if(!Jx.isValidNumber(e))e=t.objectIdToIndex(d);var o,p,k,j=function(){o=t.objectIdToObject(d);p=o.type;k=c.isContainerType(p)},i=false,m=false,l=this._cachedItemDivs,r=l[d],a=r||this.elementFromIndex(e);if(Boolean(a)&&a.msReusable&&a.msObjectId===d){i=true;if(document.activeElement===a)this._pendingItemToFocus=e}else{if(Boolean(a)&&a.msObjectId!==d)a=null;if(!Boolean(a)&&Boolean(q)){a=q;m=true;a.msObjectId=d}if(a){j();a.className="win-item";var f=k?a.msContainerPlaceholder:null;if(Boolean(f)&&f.parentNode===a){h.removeAllButOneChild(a,a.childNodes,f);f.innerHTML="";f.className=""}else{a.innerHTML="";a.msContainerPlaceholder=null}a.msRenderState=b.partialPlaceholder}else{a=document.createElement("div");m=true;a.msObjectId=d;a.msLoadingCount=0}}if(m)l[d]=a;else if(a!==r)delete l[d];var s=this._customLayout;if(!(i&&(a.msLoadingCount>0||a.msRenderState===b.completed)&&!Jx.isNonEmptyString(u))&&!s.pendingAutoScroll&&(this._viewportRenderLevel===b.completed||s.isItemInViewport(e))){j();var w={object:o,id:d,type:p};this._startRenderingItem(w,e,a,i,u===n.metadataOnly)}else if(!i){j();a.msRenderState=b.partialPlaceholder;this._setPlaceholderStyle(a,k)}return a};a._startRenderingItem=function(f,j,a,h,g){a.msLoadingCount++;if(!g)if(h&&Jx.isValidNumber(a.msThumbnailVersion))a.msThumbnailVersion++;else a.msThumbnailVersion=0;var k=this._options,e=k.customRenderer;if(e){var d=a.msContainerPlaceholder;if(d){var i=k.containerTitleBackgroundClass;Jx.isNonEmptyString(i)&&Jx.removeClass(a,i);if(e.useContainerPlaceholderDiv){Jx.removeClass(d,"photoViewer-thumbContainer");Jx.removeClass(d,"photoViewer-placeholder")}else{a.removeChild(d);a.msContainerPlaceholder=null}}else{Jx.removeClass(a,"photoViewer-thumbContainer");Jx.removeClass(a,"photoViewer-placeholder");e.useContainerPlaceholderDiv&&c.isContainerType(f.type)&&this._addContainerPlaceholderDivIfAppropriate(a)}var l=e.takeOverRendering(a,f),m=this;l.then(function(c){if(c){if(a.msRenderState!==b.completed)a.msRenderState=b.custom;a.msReusable=false}else m._startNormalItemRender(f,j,a,h,g)});if(typeof a.msRenderState!=="number")a.msRenderState=b.custom}else this._startNormalItemRender(f,j,a,h,g)};a._startNormalItemRender=function(j,k,a,D,I){var e=this._options,p=j.id,E=j.type,i=c.isContainerType(E),B=E==="container.source";if(!D){a.msReusable=true;a.msRenderState=b.partialPlaceholder}this._setPlaceholderStyle(a,i,a.msRenderState>=b.lowResThumbnail);var h=["title"];!I&&h.push("height");var d={mainDiv:a},x=e.containerTitleClass,A=e.itemCountClass,y=e.sourceStatusClass,H=e.videoInfoClass,G=e.videoGlyph;if(i&&Jx.isNonEmptyString(x)||E==="asset.video"&&Jx.isNonEmptyString(H)){var v=i&&Jx.isNonEmptyString(A),z=!i&&!e.videoGlyphOnly,F=B&&Jx.isNonEmptyString(y);if(v)if(B)if(j.object.sourceType===u.device)v=false;else h.push("recursiveAssetCount");else h.push("assetCount","containerCount");else z&&h.push("duration");F&&h.push("errorResult","sourceStatus","dateLastSync");var r=this._hostElement.id,m=k.toString(),g;if(D){d.title=a.msTitleElement;if(i){d.titleContainer=a.getElementsByClassName(x)[0];if(v)d.itemCount=a.getElementsByClassName(A)[0];if(F)d.sourceStatus=a.getElementsByClassName(y)[0]}else if(z){g=a.getElementsByClassName("thumbsView-videoDuration")[0];if(!g){g=document.createElement("span");g.id=r+"VideoDuration"+m;Jx.addClass(g,"thumbsView-videoDuration")}d.videoDuration=g}}else{var f=document.createElement("div");f.setAttribute("aria-hidden","true");a.appendChild(f);if(i){Jx.addClass(f,x);d.titleContainer=f;if(v){var t=document.createElement("span");t.id=r+"ContainerItemCount"+m;Jx.addClass(t,A);f.appendChild(t);d.itemCount=t}var w=document.createElement("div");w.id=r+"ContainerTitle"+m;w.className="thumbsView-containerTitleText";f.appendChild(w);d.title=a.msTitleElement=w;if(B){var n=document.createElement("div");Jx.addClass(n,y);n.id=r+"ContainerStatus"+m;e.addSourceStatusHandlers(n,j.id);f.appendChild(n);d.sourceStatus=n}}else{Jx.addClass(f,"thumbsView-videoInfo");Jx.addClass(f,H);d.title=a.msTitleElement=f;if(Jx.isNonEmptyString(G)){var K=document.createElement("div");Jx.addClass(K,"thumbsView-videoPlayGlyph "+o[G].cssClass);f.appendChild(K)}if(z){g=document.createElement("span");g.id=r+"VideoDuration"+m;Jx.addClass(g,"thumbsView-videoDuration");d.videoDuration=g}var J=document.createElement("div");Jx.addClass(J,"thumbsView-videoOverlay");a.appendChild(J)}}}var s=this,C=true;this._customLayout.getItemPosition(k).then(function(o){if(!I){var t=e.imgCache;if(!D&&Boolean(t)){var m=e.sizeLevel,f=t.getImg(p,m,!i);if(f){var g=f.img,w=a.msContainerPlaceholder||a;w.appendChild(g);a.msCurrentImg=g;g.style.opacity="1";var u=o.contentHeight-(i?e.containerTitleHeight:0),n=i||f.sizeLevel===m,v=n&&g.msPhysicalHeight===e.scalingCallback(u),r=v||!n&&!(m===q.megastrip&&f.sizeLevel===q.puzzle);if(!e.dontUseLowResThumbnails||r){if(!C)k=s._dataAdaptor.objectIdToIndex(p);s._updateItemRenderState(k,p,a,r?b.completed:b.lowResThumbnail);if(r){var x=h.indexOf("height");h.splice(x,1)}if(!v){l.scaleAndCenter(g,f.width,f.height,o.contentWidth,u,true);n&&t.releaseImg(p,m)}}}}}try{j.object.getProperties(h,s._getDataCallback(j,d,h,o,a.msThumbnailVersion))}catch(y){if(y.number!==c.HResults.objectNotFoundError){if(!C)k=s._dataAdaptor.objectIdToIndex(p);s._renderFailedItem(j,k,a,true)}}});C=false};a._setPlaceholderStyle=function(a,e,d){var b;if(e){this._addContainerPlaceholderDivIfAppropriate(a);b=a.msContainerPlaceholder}if(b){Jx.addClass(b,"photoViewer-thumbContainer");!d&&Jx.addClass(b,"photoViewer-placeholder");var c=this._options.containerTitleBackgroundClass;Jx.isNonEmptyString(c)&&Jx.addClass(a,c)}else{Jx.addClass(a,"photoViewer-thumbContainer");!d&&Jx.addClass(a,"photoViewer-placeholder")}};a._addContainerPlaceholderDivIfAppropriate=function(c){if(!c.msContainerPlaceholder){var b=this._options.containerTitleHeight;if(Jx.isValidNumber(b)&&b>0){var a=document.createElement("div");a.style.width="100%";a.style.height="calc(100% - "+b.toString()+"px)";c.appendChild(a);c.msContainerPlaceholder=a}}};a._finishRenderingItemsInViewport=function(){if(this._disabled||this._dataAdaptor.isDeactivated())return;if(!this._doRenderUpdate){this._doRenderUpdate=true;if(!this._enteringView){this._doEtwLogging&&!this._pendingEndEvents[this._options.dataContainerId]&&this._logStartEvent("evPhotoViewerCollections_RenderUpdatedView");this._viewportRenderLevel=b.none}}var a=this,c=false;this._customLayout.forEachItemInViewport(this._options.setPriorityRange?function(b,c){a._dataAdaptor.setPriorityRange(b,c-b+1)}:null,function(b,d){if(a._finishRenderingItem(b,d))c=true;return true}).then(function(){!c&&a._updateViewportRenderLevel()})};a._finishRenderingItem=function(c,d,a,f){var g=this._dataAdaptor;if(g.isDeactivated())return false;if(!a)a=this._cachedItemDivs[d]||this.elementFromIndex(c);if(Boolean(a)&&a.msRenderState!==b.completed&&(f||a.msLoadingCount===0)){if(a.msRenderState===b.partialPlaceholder){var e=a.msContainerPlaceholder?1:0,i=a.childNodes.length>e,h=this._getObjectInfo(d);this._startRenderingItem(h,c,a,i)}else this.updateItemThumbnail(c,a,false);return true}return false};a._getDataCallback=function(i,d,o,k,l){var f=this,j=i.id,e=d.mainDiv,a={height:false,title:false,counts:false,duration:false,sourceStatusInfo:false},g={},n=o.indexOf("height")!==-1;return function(J,q,H){try{var p=f._tryGetItemIndex(j,e);if(p>=0){var s=i.type,v=c.isContainerType(s);if(n&&!a.height){var x=c.tryLookupPropertyInMap(q,"height");if(H||Jx.isNonEmptyString(x)){if(v&&x==="")f._updateItemRenderState(p,j,e,b.completed);else{var G=parseInt(x);if(!Jx.isValidNumber(G)||G<=0)f._renderFailedItem(i,p,e,false);else!f._postponeThumbnailLoadingIfOutOfView(p,j,e)&&f._loadThumbnail(i,p,k,e,l)}a.height=true}}if(!a.title){var y=c.tryLookupPropertyInMap(q,"title");if(Jx.isNonEmptyString(y)){var F=d.title;if(v&&Boolean(F))F.innerText=y;g.title=y;a.title=true}}if(v){var t=d.itemCount;if(Boolean(t)&&!a.counts){var o;if(s==="container.source"){var D=c.tryLookupPropertyInMap(q,"recursiveAssetCount");if(Jx.isNonEmptyString(D)){o=parseInt(D,10);if(Jx.isValidNumber(o)&&o>0){t.innerText=h.formatInteger(o);g.totalCount=o}a.counts=true}}else{var u=c.tryLookupPropertiesInMap(q,["assetCount","containerCount"]);if(u){o=parseInt(u.assetCount,10);var w=parseInt(u.containerCount,10);if(!Jx.isValidNumber(o))o=0;if(!Jx.isValidNumber(w))w=0;var B=o+w;if(B>0){t.innerText=h.formatInteger(B);g.totalCount=B}a.counts=true}}}if(Boolean(d.sourceStatus)&&!a.sourceStatusInfo){var r=c.tryLookupPropertiesInMap(q,["errorResult","sourceStatus","dateLastSync"]);if(r){var z=r.sourceStatus,A=r.errorResult,I=r.dateLastSync;g.sourceStatus=m.showOrHideInlineError(m.hasError(z,A),d.sourceStatus,d.titleContainer,z,A);m.logSourceDiagnostics(i.object.sourceType,z,A,I);a.sourceStatusInfo=true}}}else if(s==="asset.video"&&Boolean(d.videoDuration)&&!a.duration){var C=c.tryLookupPropertyInMap(q,"duration");if(Jx.isNonEmptyString(C)){var E=d.videoDuration;E.innerText=g.videoDuration=C;f._addVideoDurationIfItFits(E,d.title,k.contentWidth);a.duration=true}}if(H){e.msLoadingCount--;f._addAccessibilityString(p,s,e,g);e.msRenderState===b.partialPlaceholder&&f._updateItemRenderState(p,j,e,b.placeholder)}}}catch(K){}}};a._addVideoDurationIfItFits=function(a,b,h){var c=this._videoGlyphWidthPlusMargins;if(!Jx.isValidNumber(c)){var f=window.getComputedStyle(b,null),e=o[this._options.videoGlyph];c=this._videoGlyphWidthPlusMargins=parseInt(f.marginLeft)+parseInt(f.marginRight)+(e?e.size:0)}var d=h-c;if(d>0){var g=function(){document.body.appendChild(a);var b=a.offsetWidth<=d;document.body.removeChild(a);return b};if(d>=r||g()){!a.parentNode&&b.insertBefore(a,b.childNodes[0]);return}}a.parentNode&&b.removeChild(a)};a._addAccessibilityString=function(e,c,d,a){var b=a.title;if(c==="asset.video"){b+=": "+Jx.res.getString("residVideo");if(Jx.isNonEmptyString(a.videoDuration))b+=", "+h.getDurationAccString(a.videoDuration)}else{if(Jx.isValidNumber(a.totalCount))b+=": "+a.totalCount.toString();if(Jx.isNonEmptyString(a.sourceStatus))b+=": "+a.sourceStatus}d.setAttribute("aria-label",b)};a._loadThumbnail=function(h,g,A,a,j,r){if(a.msRenderState===b.removed)return;var d=this,p=this._options,z=p.dontUseLowResThumbnails,x=p.scalingCallback,C=this._doEtwLogging,D,f=h.id,o=A.contentWidth,m=A.contentHeight-(c.isContainerType(h.type)?p.containerTitleHeight:0),B=x(o),y=x(m),i=this._pendingThumbnailPromises;if(i[f])return;function k(q,r){var n=q.quality;if(n===e.error)d._renderFailedItem(h,g,a,true);else{var G=p.imgCache,B=Boolean(G)&&n===e.highQuality,u=q.dimensions,A=u.width,x=u.height;if(A>=o&&x>=m){if(n===e.lowQualityBetterPending)d._thumbnailUpdatesToSkip[f]=true;n=e.highQuality}var D=c.isBlobOperationResultValid(q),s=Boolean(a.msCurrentImg);if(!D||s&&n===e.lowQualityBetterPending||z&&n!==e.highQuality){a.msLoadingCount--;if(!D&&n===e.lowQualityNothingPending)d._renderFailedItem(h,g,a,false);else z&&n===e.lowQualityNothingPending&&d._updateItemRenderState(g,f,a,b.completed)}else{var i=document.createElement("img");i.id=d._hostElement.id+"Image"+g.toString();i.setAttribute("aria-hidden","true");i.msPhysicalHeight=y;var E=q.thumbnailId;if(Jx.isNonEmptyString(E))i.msCurrentThumbnailId=E;var w,v=function(){g=d._tryGetItemIndex(f,a,j);Jx.log.error("Img tag failed to load for item "+f+" at index "+g.toString());i.removeEventListener("load",w,false);i.removeEventListener("error",v,false);if(g<0)d._decrementLoadingCountIfAppropriate(a,f);else if(!a.msHitImgError){a.msHitImgError=true;var b=a.msContainerPlaceholder||a;b.removeChild(i);a.msCurrentImg=a.msPreviousImg;k(q,r)}else d._renderFailedItem(h,g,a,true)};w=d._getImgLoadCallback(h,a,i,v,n,s,r,j);i.addEventListener("load",w,false);i.addEventListener("error",v,false);a.msLoadingImg=true;(x!==m||A!==o)&&l.scaleAndCenter(i,A,x,o,m,true);var H=c.getSourceFromBlobOperationResult(q,B),C=d._remainingBatchableItems;if(!r&&C>0&&d._viewportRenderLevel===b.completed){var F=d._pendingImgsToAdd;Object.keys(F).length===0&&setTimeout(function(){d._addImgBatch()},t);F[f]={div:a,img:i,src:H,hasOldImg:s,thumbnailVersion:j,dimensions:B?u:null};C===1&&d._addImgBatch();d._remainingBatchableItems--}else d._addThumbnail(f,a,i,H,s,G,B?u:null,r)}}}function v(b){delete i[f];if(b.number!==c.HResults.dataLayerSuspendedError)if(b.name===s)d._decrementLoadingCountIfAppropriate(a,f);else{Jx.log.error("Thumbnail retrieval error for item ID "+f+": "+b.toString());g=d._tryGetItemIndex(f,a,j);g>=0&&d._renderFailedItem(h,g,a,true)}}a.msLoadingCount++;var w=this._postponedThumbnailResults[f];if(w){k(w,false);delete this._postponedThumbnailResults[f]}else{var u=a.msCurrentImg,n=Boolean(u)&&Boolean(u.msCurrentThumbnailId)?u.msCurrentThumbnailId:"",q=h.object.getThumbnailAsync(B,y,n,r);i[f]=q;q.then(function(b){try{g=d._tryGetItemIndex(f,a,j);if(i[f]===q)delete i[f];if(g<0)d._decrementLoadingCountIfAppropriate(a,f);else if(d._postponeThumbnailLoadingIfOutOfView(g,f,a)){d._decrementLoadingCountIfAppropriate(a,f);if(b.quality===e.highQuality)d._postponedThumbnailResults[f]=b}else if(h.type==="container.source"){var l=n===b.thumbnailId;if(l){if(r)a.msIsRotationPending=true}else if(!a.msLoadingImg||!Boolean(n)&&Boolean(b.thumbnailId)){var c=r||Boolean(n);a.msIsRotationPending=c;k(b,c)}}else k(b,false)}catch(m){v(m)}}).done(null,v)}};a._addImgBatch=function(){for(var h=this._options.imgCache,f=this._pendingImgsToAdd,g=Object.keys(f),i=g.length,e=0;e<i;e++){var d=g[e],a=f[d],c=a.div;if(c.msRenderState>=b.partialPlaceholder&&c.msObjectId===d&&c.msThumbnailVersion===a.thumbnailVersion)this._addThumbnail(d,c,a.img,a.src,a.hasOldImg,h,a.dimensions,false);else this._decrementLoadingCountIfAppropriate(c,d)}this._pendingImgsToAdd={}};a._addThumbnail=function(h,b,a,i,f,g,c,d){var e=b.msContainerPlaceholder||b;e.appendChild(a);b.msPreviousImg=b.msCurrentImg;b.msCurrentImg=a;a.src=i;f&&!d&&Jx.addClass(a,"photoViewer-temporaryOverlay");c&&g.storeImg(h,this._options.sizeLevel,a,c.width,c.height,["msPhysicalHeight","msCurrentThumbnailId"]);if(!d)a.style.opacity="0.01"};a._getImgLoadCallback=function(k,c,a,i,n,m,j){var d=this,f=k.id,g=c.msContainerPlaceholder||c,h=function(){var o=d._tryGetItemIndex(f,c);a.removeEventListener("load",h,false);a.removeEventListener("error",i,false);c.msHitImgError=false;if(o<0||a!==c.msCurrentImg)d._decrementLoadingCountIfAppropriate(c,f);else{var p,q=function(){if(p){o=d._tryGetItemIndex(f,c);if(o<0||a!==c.msCurrentImg){d._decrementLoadingCountIfAppropriate(c,f);return}}a.style.opacity="1";c.msLoadingCount--;c.msLoadingImg=false;c.msIsRotationPending=false;if(m){d._removeOldImgs(g,a);Jx.removeClass(a,"photoViewer-temporaryOverlay")}Jx.removeClass(g,"photoViewer-placeholder");d._updateItemRenderState(o,f,c,n===e.lowQualityBetterPending?b.lowResThumbnail:b.completed)};if(j){var k=c.msPreviousImg;if(k&&a){var r=Math.round((g.scrollHeight-a.height-k.height)/2);a.style.position=k.style.position="relative";a.style.top="-"+String(r)+"px";k.style.top="";var s=WinJS.UI.Animation.createPeekAnimation([k,a]);a.style.top="-"+String(k.height+r)+"px";k.style.top="-"+String(k.height)+"px";s.execute().then(function(){k.style.position=a.style.position="";p=true;q()})}}else{p=l.enableFadeIns&&d._customLayout.isItemInViewport(o);if(p)WinJS.UI.Animation.fadeIn(a).then(q);else q()}}};return h};a._renderFailedItem=function(f,g,a,i){var e=a.msContainerPlaceholder||a;this._removeOldImgs(e,null);if(a.msCurrentImg||a.msPreviousImg){a.msCurrentImg=null;a.msPreviousImg=null}a.msReusable=false;var d=this._options.customRenderer;if(d&&d.renderFailedItem){a.className="win-item";a.msRenderState=b.custom;if(Boolean(a.msContainerPlaceholder)&&!d.useContainerPlaceholderDiv){a.removeChild(e);a.msContainerPlaceholder=null}d.renderFailedItem(f,g,a)}else{Jx.addClass(e,"photoViewer-placeholder");var l=f.id,k=!c.isContainerType(f.type),j=h.getItemFailureUX(k?f.object:null);e.appendChild(j);if(i)a.msLoadingCount--;this._updateItemRenderState(g,l,a,b.completed)}};a._removeOldImgs=function(a,b){var c=a.getElementsByTagName("img");h.removeAllButOneChild(a,c,b)};a._updateItemRenderState=function(e,f,c,a){if(c.msRenderState!==a){if(a===b.completed&&Boolean(c.parentNode))delete this._cachedItemDivs[f];c.msRenderState=a;var d=this._listView;Boolean(d)&&d.loadingState!==j.itemsLoading&&this._customLayout.isItemInViewport(e)&&this._updateViewportRenderLevel()}};a._updateViewportRenderLevel=function(){var c=b.completed,a=this;return this._customLayout.forEachItemInViewport(null,function(f){var e=a.elementFromIndex(f),d=e?e.msRenderState:null;if(typeof d!=="number"||d<=b.none){c=b.none;return false}else if(d<c)c=d;return true}).then(function(){var d=a._viewportRenderLevel;a._viewportRenderLevel=c;if(d<c)a._onVisibleRenderLevelIncrease(d);else d===b.completed&&c<b.completed&&!a._enteringView&&a._doEtwLogging&&!a._pendingEndEvents[a._options.dataContainerId]&&a._logStartEvent("evPhotoViewerCollections_RenderUpdatedView")})};a._tryGetItemIndex=function(f,a,c){var d=this._dataAdaptor;if(this._disabled||d.isDeactivated()||a.msRenderState===b.removed||a.msObjectId!==f||Jx.isValidNumber(c)&&a.msThumbnailVersion>c)return-1;var e=d.objectIdToIndex(f);return Jx.isValidNumber(e)?e:-1};a._decrementLoadingCountIfAppropriate=function(a,b){if(a.msLoadingCount>0&&a.msObjectId===b)a.msLoadingCount--};a._postponeThumbnailLoadingIfOutOfView=function(a){return this._viewportRenderLevel===b.completed?false:!this._customLayout.isItemInViewport(a)?true:false};a._onVisibleRenderLevelIncrease=function(e){var c=this._viewportRenderLevel;e===b.none&&!this._customLayout.pendingAutoScroll&&Jx.raiseEvent(this,i.Events.initialViewPlaceholderRenderComplete);if(this._doEtwLogging&&c>=b.placeholder){var j=this._options,a=j.dataContainerId,h=j.viewName,f=this._listView.scrollPosition;e<b.placeholder&&d.log.perf("evPhotoViewerCollections_PlaceholdersVisible",{containerID:a,view:h,scrollPos:f,status:g.succeeded});if(c===b.lowResThumbnail)d.log.perf("evPhotoViewerCollections_LowResThumbsVisible",{containerID:a,view:h,scrollPos:f,status:g.succeeded});else if(c===b.completed){d.log.perf(this._pendingEndEvents[a].endEventName,{containerID:a,view:h,scrollPos:f,status:g.succeeded});delete this._pendingEndEvents[a]}}if(c===b.completed){this._enteringView=false;this._progressBar.suppressProgressBarIfNecessary();this._finishRenderingItemsInPrefetchRange();Jx.raiseEvent(this,i.Events.viewportFullyRendered)}else e===b.none&&this._progressBar.scheduleProgressBarIfNecessary()};a._onLoadingStateChanged=function(){if(this._disabled)return;var a=this;switch(this._listView.loadingState){case j.itemsLoading:this._doRenderUpdate=true;if(!this._enteringView)this._customLayout.isRenderUpdateNeeded().then(function(c){a._doRenderUpdate=c;if(c){a._doEtwLogging&&!a._pendingEndEvents[a._options.dataContainerId]&&a._logStartEvent("evPhotoViewerCollections_RenderUpdatedView");a._viewportRenderLevel=b.none;a._pendingViewportRenderLevelUpdate=true}});else{this._viewportRenderLevel=b.none;this._pendingViewportRenderLevelUpdate=true}break;case j.viewPortLoaded:case j.itemsLoaded:var c=this._pendingItemToFocus;Jx.isValidNumber(c)&&this._scrollOrSetFocusIndex(c,k.noDesiredPosition,true);if(this._doRenderUpdate&&!this._customLayout.pendingAutoScroll&&(this._pendingViewportRenderLevelUpdate||this._viewportRenderLevel===b.none)){this._updateViewportRenderLevel();this._pendingViewportRenderLevelUpdate=false}}};a._onResetItem=function(i,a){var c=i.key,k=i.index,d=this.elementFromIndex(k),h=this._dataAdaptor,j=!Boolean(d)||h.isDeactivated()||!Jx.isValidNumber(h.objectIdToIndex(c));if(j){a.msRenderState=b.removed;a.msLoadingCount=0;if(Jx.isValidNumber(a.msThumbnailVersion))a.msThumbnailVersion++;a.msCurrentImg=null;a.msPreviousImg=null;a.msTitleElement=null;a.msReusable=false;delete this._cachedItemDivs[c];this._cancelPendingThumbnailForItem(c);var f=this._options.customRenderer;f&&f.itemOutOfScope(c)}else if(d){var e=this._cachedItemDivs,g=e[c];if(Boolean(g)&&g!==d)delete e[c]}};a._onListViewContentAnimation=function(b){if(b.detail.type===WinJS.UI.ListViewAnimationType.entrance){var d=this._options;if(d.disableEntranceAnimation)b.preventDefault();else if(d.delayEntranceAnimation){var a=this;if(!this._attemptedToRunEntranceAnimation){if(!this._runEntranceAnimationPromise)this._runEntranceAnimationPromise=new WinJS.Promise(function(b){a._runEntranceAnimation=b});var c,e=new WinJS.Promise(function(a){c=a});this._runEntranceAnimationPromise.then(function(){c()});b.detail.setPromise(e)}else if(a._onEntranceAnimationRunning){a._onEntranceAnimationRunning();a._onEntranceAnimationRunning=null}}}};a._finishRenderingItemsInPrefetchRange=function(){var b=this,a=0;this._customLayout.forEachItemInPrefetchRange(function(c,d){if(b._finishRenderingItem(c,d))a++});this._remainingBatchableItems+=a};a._logStartEvent=function(b,a,f){var c=this._options,e=c.dataContainerId;if(!Jx.isNonEmptyString(a))a=e;this._pendingEndEvents[a]={endEventName:b+"_end"};if(a===e)d.log.perf(b+"_begin",{containerID:a,view:c.viewName,scrollPos:this._listView.scrollPosition});else{this._pendingEndEvents[a].index=f;d.log.perf(b+"_begin",{itemID:a,index:f,view:c.viewName})}};a._cancelPendingThumbnailForItem=function(a){var b=this._pendingThumbnailPromises,c=b[a];if(c){c.cancel();delete b[a]}delete this._postponedThumbnailResults[a]};a._cancelAnyPendingThumbnails=function(){var a=this._pendingThumbnailPromises;for(var c in a){var b=a[c];b.cancel()}this._pendingThumbnailPromises={};this._postponedThumbnailResults={}};a._getObjectInfo=function(a){var b=this._dataAdaptor.objectIdToObject(a);return{object:b,id:a,type:b.type}};a._addObjectModifiedHandler=function(){var a=this,d=this._thumbnailUpdatesToSkip,e=this._objectModifiedHandler={objectModified:function(g,h){var r=f.selection|f.media|f.subAlbumCount;if((h&~r)===0)return true;var i=Boolean(h&f.thumbnail),l=Boolean(h&f.thumbnailStatus),k=false;if(i){a._cancelPendingThumbnailForItem(g);if(d[g]){i=false;delete d[g]}}else if(l)k=true;var j=a._dataAdaptor.objectIdToIndex(g),e=a._cachedItemDivs[g]||a.elementFromIndex(j),p=a._disabled,q=Boolean(h&f.dimensions);if((p||q)&&Boolean(e)){e.msRenderState=b.partialPlaceholder;if(p){a._viewportRenderLevel=b.partialPlaceholder;return true}else return false}if(!e)return true;if(!e.msReusable)return false;if(k){var o=a._getObjectInfo(g);if(!c.isContainerType(o.type)){a._renderFailedItem(o,j,e,false);return true}}var m=Boolean(h&f.other);if((i||l)&&!m)a.updateItemThumbnail(j,e,e.msIsRotationPending||false);else if(m)var s={key:g,index:j},t=a._itemRendererCallback(s,null,i?n.reloadAll:n.metadataOnly);return true}};this._dataAdaptor.addObjectModifiedHandler(e)}})();(function(){PhotoViewer.CachedIndexNotificationHelper=function(b,a){this._site=b;this._dataAdaptor=a;a.setNotificationHandler(this)};var a=PhotoViewer.CachedIndexNotificationHelper.prototype;a.shutdown=function(){this._dataAdaptor.removeNotificationHandler(this);this._dataAdaptor=null;this._site=null};a.beginNotifications=function(){this._initIndices();this._inBatch=true};a.endNotifications=function(){this._finalizeIndices()};a.invalidateAll=function(){!this._inBatch&&this._initIndices();this.invalidateAllOccurred=true;!this._inBatch&&this._finalizeIndices()};a.inserted=function(h,g,i,e){!this._inBatch&&this._initIndices();for(var b=this.indicesToUpdate,f=b.length,a=0;a<f;a++){var c=b[a],d=c.updatedIndex;if(d>=e)c.updatedIndex++}this.addsOccurred=true;!this._inBatch&&this._finalizeIndices()};a.changed=function(){};a.removed=function(g,e){!this._inBatch&&this._initIndices();for(var b=this.indicesToUpdate,f=b.length,a=0;a<f;a++){var c=b[a],d=c.updatedIndex;if(d>e)c.updatedIndex--}this.removesOccurred=true;!this._inBatch&&this._finalizeIndices()};a._initIndices=function(){var a=this._site.getIndicesToUpdateAfterNotificationsCompleted();this.indicesToUpdate=a;for(var d=a.length,b=0;b<d;b++){var c=a[b];c.updatedIndex=c.originalIndex}};a._finalizeIndices=function(){for(var d=this._dataAdaptor.count,b=this.indicesToUpdate,e=b.length,a=0;a<e;a++){var c=b[a];if(c.updatedIndex>=d)c.updatedIndex=0}(this.addsOccurred||this.removesOccurred)&&this._site.updateIndicesAfterNotifications();this._inBatch=false;this.indicesToUpdate=null;this.removesOccurred=false;this.addsOccurred=false;this.invalidateAllOccurred=false};a.indicesToUpdate=null;a.removesOccurred=false;a.addsOccurred=false;a.invalidateAllOccurred=false;a._site=null;a._dataAdaptor=null;a._inBatch=false})();(function(){var a=PhotoViewer.Graphics,b=2,c=3;a.scaleAspect=function(d,c,e,b,a){if(b>0&&a>0&&d>0&&c>0){var f=b*c>d*a;if(e&&f||!e&&!f){b=Math.round(c*b/a);a=c;if(b<1)b=1}else{a=Math.round(d*a/b);b=d;if(a<1)a=1}}else{b=0;a=0}return{width:b,height:a}};a.centerElement=function(k,h,d,i){var a=k.style,j=i.width,e=i.height;if(h!==j){var f=(h-j)/b;a.marginLeft=Math.floor(f).toString()+"px";a.marginRight=Math.ceil(f).toString()+"px"}else{a.marginLeft="";a.marginRight=""}if(d!==e){var g=(d-e)/(e>d?c:b);a.marginTop=Math.floor(g).toString()+"px";a.marginBottom=Math.ceil(g).toString()+"px"}else{a.marginTop="";a.marginBottom=""}};a.scaleAndCenter=function(b,h,f,e,d,g){var c=a.scaleAspect(e,d,g,h,f);b.style.width=String(c.width)+"px";b.style.height=String(c.height)+"px";a.centerElement(b,e,d,c)};a.removeNonScalingStyle=function(e){var a=e.style;if(a.cssText!==""){var b={width:a.width,height:a.height,"margin-left":a.marginLeft,"margin-right":a.marginRight,"margin-top":a.marginTop,"margin-bottom":a.marginBottom},c="";for(var d in b)c+=d+":"+b[d]+";";a.cssText=c}};a.areDimensionsValid=function(b,a){return Jx.isValidNumber(b)&&b>0&&Jx.isValidNumber(a)&&a>0}})();(function(){var b={isZoomedOut:0,isCurrentView:1,triggerZoom:2,pagesToPrefetch:3};PhotoViewer.SeZoZoomableProxy=function(a,b){this._hostElement=a;this._site=b;a.winControl=this};var a=PhotoViewer.SeZoZoomableProxy.prototype;a.takeOverHostElement=function(){var a=this._hostElement.winControl;if(this!==a){this._hostControl=a;this._hostZoomableView=a.zoomableView;this._hostElement.winControl=this;if(this._configureForZoomArguments){var b=this._hostZoomableView.configureForZoom;b.apply(this._hostZoomableView,this._configureForZoomArguments)}}};a.releaseHostControl=function(){this._hostControl=null;this._hostZoomableView=null};a.shutdown=function(){this._hostElement.winControl=null;this._hostElement=null;this._hostControl=null;this._hostZoomableView=null;this._site=null};a.getPanAxis=function(){var a=this._callbackEventDispatcher("getPanAxis",arguments);if(!a)a="horizontal";return a};a.configureForZoom=function(){this._configureForZoomArguments=arguments;return this._callbackEventDispatcher("configureForZoom",arguments)};a.setCurrentItem=function(){return this._callbackEventDispatcher("setCurrentItem",arguments)};a.getCurrentItem=function(){return this._callbackEventDispatcher("getCurrentItem",arguments)};a.beginZoom=function(){this._site&&this._site.beginSemanticZoom();return this._callbackEventDispatcher("beginZoom",arguments)};a.positionItem=function(){return this._callbackEventDispatcher("positionItem",arguments)};a.endZoom=function(a){var c=this._configureForZoomArguments[b.isZoomedOut]?a:!a;this._site&&this._site.endSemanticZoom(c);this._configureForZoomArguments[b.isCurrentView]=a;return this._callbackEventDispatcher("endZoom",arguments)};a.handlePointer=function(){return this._callbackEventDispatcher("handlePointer",arguments)};Object.defineProperty(a,"zoomableView",{"get":function(){return this}});Object.defineProperty(a,"hostElement",{"get":function(){return this._hostElement}});a._callbackEventDispatcher=function(d,c){var a=this._hostZoomableView;if(a){var b=a[d];if(b)return b.apply(a,c)}};a._hostElement=null;a._hostControl=null;a._hostZoomableView=null;a._configureForZoomArguments=null;a._site=null})();(function(){var c=window.PhotoViewer;c.ProgressBarTimer=function(b){this._progressBarId=b;this._progressBarState=a.off};var a={off:"off",pending:"pending",showing:"showing"},d={progressBarDelay:2e3},b=c.ProgressBarTimer.prototype;b.scheduleProgressBarIfNecessary=function(){Jx.log.info("ProgressBarTimer -- "+this._progressBarId+" -- Schedule progress bar if necessary with "+this._progressBarState+" state");if(Boolean(this._progressBarId)&&this._progressBarState!==a.showing){Jx.log.info("ProgressBarTimer -- "+this._progressBarId+" -- Progress bar is pending");this._progressBarState=a.pending;if(!this._progressBarTimerSet){this._progressBarTimerSet=true;var b=this;setTimeout(function(){Jx.log.info("ProgressBarTimer -- "+b._progressBarId+" -- timer fired with "+b._progressBarState+" state");b._progressBarTimerSet=false;if(b._progressBarState===a.pending){Jx.log.info("ProgressBarTimer -- Progress bar is showing for "+b._progressBarId);b._showHeaderProgressBar(true);b._progressBarState=a.showing}},d.progressBarDelay)}}};b.suppressProgressBarIfNecessary=function(){Jx.log.info("ProgressBarTimer -- "+this._progressBarId+" -- Suppress progress bar if necessary with "+this._progressBarState+" state");if(this._progressBarState===a.showing){Jx.log.info("ProgressBarTimer -- "+this._progressBarId+" -- Progress bar is now hiding");this._showHeaderProgressBar(false)}this._progressBarState=a.off};b._showHeaderProgressBar=function(d){var c="headerProgressBar",a,b=document.getElementById(this._progressBarId);if(d){a=document.createElement("progress");a.id=c;a.className="header-progress-bar";b.appendChild(a)}else{a=document.getElementById(c);b.removeChild(a)}};b._progressBarId=null;b._progressBarTimerSet=false;b._progressBarState=a.off})();(function(){var d=window.PhotoViewer,e=window.WinJS.UI.Animation,c=3e3,f=2;d.ZoomButtons=function(g,j,k,h,i,l){this._hostElement=g;this._zoomOutHandler=j;this._zoomInHandler=k;this._updateStateCallback=h;this._mouseMoveThreshold=i;this._enabled=false;this._visible=false;this._state=b.both;this._hideTimerID=0;this._lastMouseMoveTime=0;this._lastMouseX=0;this._lastMouseY=0;var d=document.createElement("div");d.className="photoViewer-zoomButtonContainer hidden";g.appendChild(d);var a=document.createElement("button");a.className="photoViewer-zoomButton photoViewer-zoomOutButton";a.tabIndex=-1;a.setAttribute("aria-label",Jx.res.getString("residZoomOut"));var e=this._getClickHandler(false);a.addEventListener("click",e,true);d.appendChild(a);var c=document.createElement("button");c.className="photoViewer-zoomButton photoViewer-zoomInButton";c.tabIndex=-1;c.setAttribute("aria-label",Jx.res.getString("residZoomIn"));var f=this._getClickHandler(true);c.addEventListener("click",f,true);d.appendChild(c);this._buttonContainer=d;this._zoomOutButton=a;this._zoomInButton=c;this._zoomOutClickHandler=e;this._zoomInClickHandler=f;this._onPointerMove=this._onPointerMove.bind(this);this._fadeOut=this._fadeOut.bind(this);this._hideButtons=this._hideButtons.bind(this);if(!l)this.enabled=true};var b=d.ZoomButtons.State={both:"both",zoomInOnly:"zoomInOnly",zoomOutOnly:"zoomOutOnly"},a=d.ZoomButtons.prototype;a.setState=function(a){var c=this._state;if(a!==c){this._state=a;if(a===b.zoomInOnly)Jx.addClass(this._zoomOutButton,"hidden");else c===b.zoomInOnly&&Jx.removeClass(this._zoomOutButton,"hidden");if(a===b.zoomOutOnly)Jx.addClass(this._zoomInButton,"hidden");else c===b.zoomOutOnly&&Jx.removeClass(this._zoomInButton,"hidden")}};a.shutdown=function(){this.enabled=false;this._zoomOutButton.removeEventListener("click",this._zoomOutClickHandler,true);this._zoomInButton.removeEventListener("click",this._zoomInClickHandler,true);this._hostElement=null;this._zoomOutHandler=null;this._zoomInHandler=null;this._updateStateCallback=null;this._buttonContainer=null;this._zoomOutButton=null;this._zoomInButton=null};Object.defineProperty(a,"enabled",{"set":function(a){if(this._enabled!==a){this._enabled=a;if(a)this._hostElement.addEventListener("MSPointerMove",this._onPointerMove,false);else{this._visible&&window.clearTimeout(this._hideTimerID);this._hostElement.removeEventListener("MSPointerMove",this._onPointerMove,false);this._hideButtons()}}}});Object.defineProperty(a,"visible",{"get":function(){return this._visible}});a._onPointerMove=function(g){var k=g.pointerType;if(k===f)return;var b=g.screenX,d=g.screenY,i=this._lastMouseX,j=this._lastMouseY;if(b===i&&d===j)return;var a=this._mouseMoveThreshold;if(a>0)if(Math.abs(b-i)<=a&&Math.abs(d-j)<=a)return;this._lastMouseX=b;this._lastMouseY=d;if(!this._visible){this._updateStateCallback();if(!this._enabled)return;var h=this._buttonContainer;Jx.removeClass(h,"hidden");this._visible=true;e.fadeIn(h);this._hideTimerID=window.setTimeout(this._fadeOut,c)}else this._lastMouseMoveTime=Date.now()};a._fadeOut=function(){if(this._visible){var b=this._lastMouseMoveTime;if(b>0){var a=Date.now()-b;if(a<c){this._lastMouseMoveTime=0;this._hideTimerID=window.setTimeout(this._fadeOut,c-a);return}}e.fadeOut(this._buttonContainer).done(this._hideButtons)}};a._hideButtons=function(){if(this._visible){Jx.addClass(this._buttonContainer,"hidden");this._visible=false}};a._getClickHandler=function(b){var a=this;return function(){a._lastMouseMoveTime=Date.now();if(b)a._zoomInHandler();else a._zoomOutHandler()}}})();(function(){var b=window.PhotoViewer;b.BackShortcutsListener=function(a,b){this._keyUp=this._keyUp.bind(this);this._keyPress=this._keyPress.bind(this);this._MSPointerUp=this._MSPointerUp.bind(this);this._element=a;this._callback=b;a.addEventListener("keypress",this._keyPress,false);a.addEventListener("keyup",this._keyUp,false);a.addEventListener("MSPointerUp",this._MSPointerUp,false)};var a=b.BackShortcutsListener.prototype;a.removeListeners=function(){var a=this._element;a.removeEventListener("keypress",this._keyPress,false);a.removeEventListener("keyup",this._keyUp,false);a.removeEventListener("MSPointerUp",this._MSPointerUp,false)};a._keyUp=function(a){(a.key==="Left"&&a.altKey||a.key==="BrowserBack")&&this._callback(a)};a._keyPress=function(a){a.key==="Backspace"&&this._callback(a)};a._MSPointerUp=function(a){a.button===3&&this._callback(a)}})();(function(){var e="appBar-deleteFlyout",d="appBar-deleteFlyout-button",c="appBar-deleteFlyout-div";function b(){PhotoViewer.log.perf("evPhotoViewer_AppBar_DeleteFlyoutVisible",{emptyValue:true})}PhotoViewer.ConfirmDeleteFlyout=function(g){this._deleteHandler=null;this._onClick=this._onClick.bind(this);var a=document.createElement("div");a.innerHTML='<div id="'+c+'"></div><button type="button" class="lightButton" id="'+d+'"/>';a.id=e;var f=a.getElementsByClassName("lightButton")[0];f.innerHTML=Jx.res.getString("resid-ab-DeleteFlyoutButton");this._deleteFlyoutControl=new WinJS.UI.Flyout(a);f.addEventListener("click",this._onClick,false);this._deleteFlyoutControl.addEventListener("aftershow",b,false);g.appendChild(a)};var a=PhotoViewer.ConfirmDeleteFlyout.prototype;a.deactivateUI=function(){var a=document.getElementById(d);a&&a.removeEventListener("click",this._onClick,false);if(this._deleteFlyoutControl){this._deleteFlyoutControl.removeEventListener("aftershow",b,false);this._deleteFlyoutControl=null}};a.show=function(b,h,g,f,e){var a=document.getElementById(c);if(b===1){var i=Jx.res.getString("resid-ab-DeleteFlyoutSingleItem"),j=PhotoViewer.ViewHelpers.formatInteger(1);a.innerHTML=i.replace("1",j)}else{var d=PhotoViewer.ViewHelpers.formatInteger(b);a.innerHTML=Jx.res.loadCompoundString("resid-ab-DeleteFlyoutMultiItemFmt",d)}this._deleteHandler=h;this._deleteFlyoutControl.show(g,f,e)};a._onClick=function(){this._deleteFlyoutControl.hide();this._deleteHandler()}})()