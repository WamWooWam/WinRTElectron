(function(){var c=WindowsLive.Photo.Viewer.Commanding,g=PhotoViewer.AnimationHelpers,d=PhotoViewer.ViewHelpers,f=PhotoViewer.DataHubHelpers,e="sourceTitle";PhotoViewer.AppBar=function(f,e,d){this.initComponent();this._appBarHidden=this._appBarHidden.bind(this);this._appBarShown=this._appBarShown.bind(this);this._basicCommandStateChange=this._basicCommandStateChange.bind(this);this._batchCommandingUpdates=this._batchCommandingUpdates.bind(this);this._clearStateChangeHandler=this._clearStateChangeHandler.bind(this);this._deleteStateChangeHandler=this._deleteStateChangeHandler.bind(this);this._invokeAndDismiss=this._invokeAndDismiss.bind(this);this._invokeAndKeepAppBar=this._invokeAndKeepAppBar.bind(this);this._invokeDelete=this._invokeDelete.bind(this);this._invokePlayPause=this._invokePlayPause.bind(this);this._invokeSelectAll=this._invokeSelectAll.bind(this);this._setAsStateChangeHandler=this._setAsStateChangeHandler.bind(this);this._toggleCommandStateChange=this._toggleCommandStateChange.bind(this);this._updateViewOnlineStrings=this._updateViewOnlineStrings.bind(this);var b=Jx.res.getString.bind(Jx.res);this._setAsIndex=2;this._appBarCommandArray=[{id:a.Commands.clearCmd,label:b("resid-ab-ClearLabel"),icon:"clearselection",onclick:this._invokeAndDismiss,section:"selection",tooltip:b("resid-ab-ClearTooltip")},{id:a.Commands.basket,label:"Basket",icon:"placeholder",onclick:this._doNothing,section:"selection",tooltip:b("resid-ab-BasketTooltip")},{id:a.Commands.setAs,label:b("resid-ab-SetAsButton"),icon:"setlockscreen",type:"flyout",section:"selection",tooltip:b("resid-ab-SetAsTooltip")},{type:"separator",id:a.Commands.deleteSeparator,section:"selection"},{id:a.Commands.deleteCmd,label:b("resid-ab-DeleteLabel"),icon:"delete",onclick:this._invokeDelete,section:"selection",tooltip:b("resid-ab-DeleteTooltip")},{id:a.Commands.viewOnline,label:"View Online",icon:"world",onclick:this._invokeAndDismiss,section:"selection",tooltip:"View Online",extraClass:"noHyphens"},{id:a.Commands.playPause,label:"Play - Pause button",icon:"placeholder",onclick:this._invokePlayPause,section:"selection",tooltip:"Play - Pause toggle."},{id:a.Commands.sas,label:"Send a smile!",icon:"placeholder",onclick:this._doNothing,section:"global",hidden:true},{id:a.Commands.albumDateToggle,label:"Album - date toggle",icon:"placeholder",onclick:this._invokeAndDismiss,section:"global",tooltip:"album - date toggle"},{id:a.Commands.autoPlayButton,label:"Slideshow Autoplay",icon:"placeholder",onclick:this._invokeAndDismiss,section:"global",tooltip:"Slideshow in Playto"},{id:a.Commands.launchSlideshow,label:b("resid-ab-AutoAdvanceLabel"),icon:"slideshow",onclick:this._invokeAndDismiss,section:"global",tooltip:b("resid-ab-AutoAdvanceTooltip")},];(!d||!d.disableSelection)&&this._appBarCommandArray.push({id:a.Commands.selectAll,label:b("resid-ab-SelectAllLabel"),icon:"selectall",onclick:this._invokeSelectAll,section:"global",tooltip:b("resid-ab-SelectAllTooltip")});this._appBarCommandArray.push({id:a.Commands.launchImport,label:b("resid-ab-ImportButton"),icon:"attachcamera",onclick:this._invokeAndKeepAppBar,section:"global",type:"flyout"});this._setAsCommandArray=[{id:a.Commands.lockScreen,label:b("resid-ab-SetAsLockScreenMenuButton"),onclick:this._invokeAndDismiss,tooltip:b("resid-ab-SetAsLockScreenMenuTooltip")},{id:a.Commands.setTile,label:b("resid-ab-SetAsTileMenuButton"),onclick:this._invokeAndDismiss,tooltip:b("resid-ab-SetAsTileMenuTooltip")},{id:a.Commands.setBackground,label:b("resid-ab-SetAsBackgroundMenuButton"),onclick:this._invokeAndDismiss,tooltip:b("resid-ab-SetAsBackgroundMenuTooltip")},];this._toggleButtonInfo={};this._toggleButtonInfo[a.Commands.playPause]={active:a.Commands.playPause};this._toggleButtonInfo[a.Commands.playPause][a.Commands.play]={label:b("resid-ab-PlayVideoLabel"),icon:"play",tooltip:b("resid-ab-PlayVideoTooltip")};this._toggleButtonInfo[a.Commands.playPause][a.Commands.pause]={label:b("resid-ab-PauseVideoLabel"),icon:"pause",tooltip:b("resid-ab-PauseVideoTooltip")};this._toggleButtonInfo[a.Commands.autoPlayButton]={active:a.Commands.autoPlayButton};this._toggleButtonInfo[a.Commands.autoPlayButton][a.Commands.stopAutoPlay]={label:b("resid-ab-StopAutoAdvanceLabel"),icon:"stopslideshow",tooltip:b("resid-ab-StopAutoAdvanceTooltip")};this._toggleButtonInfo[a.Commands.autoPlayButton][a.Commands.startAutoPlay]={label:b("resid-ab-AutoAdvanceLabel"),icon:"slideshow",tooltip:b("resid-ab-AutoAdvanceTooltip")};this._toggleButtonInfo[a.Commands.albumDateToggle]={active:a.Commands.albumDateToggle};this._toggleButtonInfo[a.Commands.albumDateToggle][a.Commands.viewByAlbum]={label:b("resid-ab-ByAlbumLabel"),icon:"folder",tooltip:b("resid-ab-ByAlbumTooltip")};this._toggleButtonInfo[a.Commands.albumDateToggle][a.Commands.viewByDate]={label:b("resid-ab-ByDateLabel"),icon:"calendar",tooltip:b("resid-ab-ByDateTooltip")};var c=PhotoViewer.Coordinator.Mode;this._modeLogic={};this._modeLogic[c.none]={bottomBar:false,topBar:false,hideBars:true};this._modeLogic[c.megastrip]={bottomBar:true,topBar:false,hideBars:false};this._modeLogic[c.puzzle]={bottomBar:true,topBar:false,hideBars:false};this._modeLogic[c.oneUp]={bottomBar:true,topBar:true,hideBars:true};this._modeLogic[c.openWith]={bottomBar:true,topBar:true,hideBars:true};this._modeLogic[c.slideshow]={bottomBar:false,topBar:false,hideBars:true};this._modeLogic[c.multiUpSlideshow]={bottomBar:false,topBar:true,hideBars:true};this._modeLogic[c.playTo]={bottomBar:true,topBar:false,hideBars:true};this._modeLogic[c.importView]={bottomBar:false,topBar:false,hideBars:true};this._site=f;this._dataHub=e;this._appBarOpenWhileSticky=true;this._currentMode=c.none;this._batchCommandUpdates=true;this._commandsToShow=[];this._commandsToHide=[];this._isCommandHidden=[]};var a=PhotoViewer.AppBar,b=a.prototype;Jx.augment(a,Jx.Component);a.Bars={top:"top",bottom:"bottom",all:"all"};a.Commands={playPause:"playPauseToggle",play:"PlayVideo",pause:"PauseVideo",autoPlayButton:"playto_AutoPlayToggle",stopAutoPlay:"StopAutoAdvance",startAutoPlay:"StartAutoAdvance",albumDateToggle:"collections_albumDateToggle",viewByAlbum:"BrowseByAlbum",viewByDate:"BrowseByDate",launchSlideshow:"Slideshow",clearCmd:"Clear",basket:"Basket",deleteCmd:"Delete",deleteSeparator:"deleteSeparator",viewOnline:"ViewOnline",setTile:"SetAsTile",lockScreen:"SetAsLockScreen",setBackground:"SetAsBackground",selectAll:"SelectAll",print:"Print",setAs:"SetAs",launchOneUp:"OneUp",launchOpenWith:"OpenWith",launchPlayTo:"PlayTo",launchImport:"launchImport",launchMultiUpSlideshow:"launchMultiUpSlideshow",returnToMegastripFromOneUp:"returnToMegastripFromOneUp",navigateBack:"Back",sas:"PhotoViewerSasButton"};b.getUI=function(a){a.html='<div id="'+this._id+'"><div id="TopAppBar"><div id="backButton-backing"></div><div id="TopBarBackButton"></div></div><div id="setAsFlyoutDiv"></div></div>'};b.activateUI=function(){var b=this;this._site.addPostApplicationLaunchWorkItem(function(){b._createBottomAppbar();b._createTopAppBar();b.updateForMode(b._currentMode);window.setTimeout(function(){if(b._appBarControl)if(b._appBarControl.hidden)SasManager.init(Jx.res.getString("resid-app-name"),a.Commands.sas);else b._initOnHide=true},1e4);var c=b._appBarInitializationPromiseComplete;if(c){c();b._appBarInitializationPromiseComplete=null}});this._registerEvents();Jx.Component.prototype.activateUI.call(this)};b.deactivateUI=function(){if(this.hasUI()){this._tearDownCommandListeners();this._unregisterEvents();this._setAsMenu=null;this._appBarCommandArray[this._setAsIndex].flyout=null;if(this._appBarElement){d.removeElementFromDOM(this._appBarElement);this._appBarElement=null}this._appBarControl=null;this._topBarControl=null;if(this._topBarElement){d.removeElementFromDOM(this._topBarElement);this._topBarElement=null}this._basketThumb=null}Jx.Component.prototype.deactivateUI.call(this)};b.onAppBarInitialized=function(){if(this._appBarControl)return WinJS.Promise.wrap();else if(this._appBarInitializationPromise)return this._appBarInitializationPromise;var a=this;this._appBarInitializationPromise=new WinJS.Promise(function(b){a._appBarInitializationPromiseComplete=b});return this._appBarInitializationPromise};b.updateForMode=function(f){var c=this._appBarControl,g=PhotoViewer.Coordinator.Mode,b;if(c){b=this._modeLogic[f];if(!b)b=this._modeLogic[g.none];this._setAppBarDisabled(!b.bottomBar||this._numActiveCommandElements===0)}var e=this._topBarControl;if(e){var d=!b.topBar;this._ensureTopBarComponents(d);this._topBarControl.disabled=d}if(c||e)if(b.hideBars)this.hideBars(a.Bars.all);else this._showHideAppBarIfRequired();this._currentMode=f};b.showBars=function(c){var b=this;msSetImmediate(function(){switch(c){case a.Bars.all:b._createBottomAppbar();b._createTopAppBar();b._appBarControl.show();b._topBarControl.show();break;case a.Bars.top:b._createTopAppBar();b._topBarControl.show();break;case a.Bars.bottom:b._createBottomAppbar();b._appBarControl.show()}})};b.hideBars=function(b){(b===a.Bars.all||b===a.Bars.bottom)&&Boolean(this._appBarControl)&&this._appBarControl.hide();(b===a.Bars.all||b===a.Bars.top)&&Boolean(this._topBarControl)&&this._topBarControl.hide()};b.isBarVisible=function(b){var c;switch(b){case a.Bars.all:return Boolean(this._topBarControl)&&!this._topBarControl.hidden||Boolean(this._appBarControl)&&!this._appBarControl.hidden;case a.Bars.top:return Boolean(this._topBarControl)&&!this._topBarControl.hidden;case a.Bars.bottom:return Boolean(this._appBarControl)&&!this._appBarControl.hidden}return false};b._updateElementState=function(a,c){var d=this._isCommandHidden[a],b=this._appBarControl;if(c&&d)if(!this._batchCommandUpdates){b.showCommands([a]);this._numActiveCommandElements++;this._isCommandHidden[a]=false}else this._deferShowHideCommand(this._commandsToShow,this._commandsToHide,a);else if(!c&&!d)if(!this._batchCommandUpdates){b&&b.hideCommands([a]);this._numActiveCommandElements--;this._isCommandHidden[a]=true}else this._deferShowHideCommand(this._commandsToHide,this._commandsToShow,a);this._updateAppbarDisabledProperty()};b._deferShowHideCommand=function(f,b,e){for(var d=f.length,c=false,a=0;a<d;a++)if(f[a]===e){c=true;break}!c&&f.push(e);d=b.length;c=false;for(a=0;a<d;a++)if(b[a]===e){b.splice(a,1);break}};b._updateBatchedCommands=function(){var e=this._commandsToShow,d=this._commandsToHide,c=this._appBarControl,a,b;if(this._commandsToHide.length){c&&c.hideCommands(this._commandsToHide);b=this._commandsToHide.length;this._numActiveCommandElements-=b;for(a=0;a<b;a++)this._isCommandHidden[this._commandsToHide[a]]=true}if(this._commandsToShow.length){c&&c.showCommands(this._commandsToShow);b=this._commandsToShow.length;this._numActiveCommandElements+=b;for(a=0;a<b;a++)this._isCommandHidden[this._commandsToShow[a]]=false}this._updateAppbarDisabledProperty();this._commandsToShow=[];this._commandsToHide=[];this._batchCommandUpdates=false};b._updateAppbarDisabledProperty=function(){if(this._appBarControl)if(this._modeLogic[this._currentMode].bottomBar&&this._numActiveCommandElements>0)this._setAppBarDisabled(false);else this._setAppBarDisabled(true)};b._basicCommandStateChange=function(a){a.stateChangeFlags&c.CommandStateChangeFlags.enableState&&this._updateElementState(a.commandName,a.enabled)};b._clearStateChangeHandler=function(a){a.stateChangeFlags&c.CommandStateChangeFlags.enableState&&this._updateClearVisibility(a.enabled)};b._updateClearVisibility=function(b){if(b){this._appBarControl.sticky=true;this._showHideAppBarIfRequired()}else{this._appBarControl.sticky=false;if(this._dataHub.selection.size===0){this._appBarOpenWhileSticky=true;this.hideBars(a.Bars.bottom)}}this._updateElementState(a.Commands.clearCmd,b);this._updateElementState(a.Commands.basket,b)};b._showHideAppBarIfRequired=function(){if(this._appBarOpenWhileSticky&&(Boolean(this._appBarControl)&&this._appBarControl.sticky||this._dataHub.selection.size>0))this.showBars(a.Bars.bottom);else this.hideBars(a.Bars.all)};b._deleteStateChangeHandler=function(a){a.stateChangeFlags&c.CommandStateChangeFlags.enableState&&this._updateDeleteVisibility(a.enabled)};b._updateDeleteVisibility=function(b){this._updateElementState(a.Commands.deleteCmd,b);(!b||this._site.isCommandEnabled(a.Commands.clearCmd))&&this._updateElementState(a.Commands.deleteSeparator,b)};b._setAsStateChangeHandler=function(a){if(a.stateChangeFlags&c.CommandStateChangeFlags.enableState){if(a.enabled)this._numSetAsCommandsEnabled++;else if(this._numSetAsCommandsEnabled>0)this._numSetAsCommandsEnabled--;this._updateSetAsVisibility(this._numSetAsCommandsEnabled)}};b._updateSetAsVisibility=function(b){this._updateElementState(a.Commands.setAs,b>0)};b._updateViewOnlineStrings=function(d){var a=d.commandName,c=d.enabled;if(c){var b=this._appBarControl.getCommandById(a),g=this._dataHub.activeItem.objectAt(0),h=this;g.getProperties([e],function(d,c){var a=f.tryLookupPropertyInMap(c,e);if(Jx.isNonEmptyString(a)){b.label=Jx.res.loadCompoundString("resid-ab-ViewOnlineLabel",a);b.tooltip=Jx.res.loadCompoundString("resid-ab-ViewOnlineTooltip",a)}})}this._updateElementState(a,c)};b._toggleCommandStateChange=function(a){var e=Boolean(a.stateChangeFlags&c.CommandStateChangeFlags.enableState),d=e&&!a.enabled,b=a.commandName;d&&this._updateElementState(b,a.enabled);a.stateChangeFlags&c.CommandStateChangeFlags.stage&&this._updateCommandToStage(b,a.commandStage);e&&!d&&this._updateElementState(b,a.enabled)};b._updateCommandToStage=function(b,d){var c=this._appBarControl.getCommandById(b),a=this._toggleButtonInfo[b][d];if(a){c.icon=a.icon;c.label=a.label;c.tooltip=a.tooltip;this._toggleButtonInfo[b].active=d}};b._invokeCommand=function(b,e,g){PhotoViewer.log.perf("evPhotoViewerCommanding_AppBarCommandInvoked",{commandName:b});var f=e&&Boolean(this._appBarControl)&&!this._appBarControl.sticky;f&&this.hideBars(a.Bars.all);var d=this._site;if(d.isCommandEnabled(b))if(g)return d.doCommand(b,c.CommandSurface.appBar,null,null);else msSetImmediate(function(){d.doCommand(b,c.CommandSurface.appBar,null,null)});return null};b._invokeAndDismiss=function(a){this._invokeCommand(a.target.id,true,false)};b._invokeAndKeepAppBar=function(a){this._invokeCommand(a.target.id,false,false)};b._invokeSelectAll=function(a){if(!this._invokeCommand(a.target.id,false,true)){var b=this._dataHub.selection.objectAt(0);d.showSelectionSourceErrorFlyout(a.target,"top",b)}};b._doNothing=function(){};b._invokePlayPause=function(c){var b=false;if(this._toggleButtonInfo[a.Commands.playPause].active===a.Commands.stopAutoPlay)b=true;this._invokeCommand(c.target.id,b,false)};b._invokeDelete=function(){var b=this;this._site.confirmDelete(function(){b._invokeCommand(a.Commands.deleteCmd,true,false)})};b._createBottomAppbar=function(){if(!this._setAsMenu){this._setAsMenu=new WinJS.UI.Menu(document.getElementById("setAsFlyoutDiv"),{commands:this._setAsCommandArray});this._appBarCommandArray[this._setAsIndex].flyout=this._setAsMenu}if(!this._appBarControl){var a=document.createElement("div");a.id="BottomAppBar";var b=new WinJS.UI.AppBar(a,{commands:this._appBarCommandArray,disabled:true,placement:"bottom"});this._appBarElement=a;this._appBarControl=b;b.addEventListener("afterhide",this._appBarHidden,false);b.addEventListener("aftershow",this._appBarShown,false);document.getElementById(this._id).appendChild(a);this._setupCommandListeners();this._updateAppbarDisabledProperty()}};b._createTopAppBar=function(){if(!this._topBarControl){this._topBarElement=document.getElementById("TopAppBar");this._topBarControl=new WinJS.UI.AppBar(this._topBarElement,{disabled:true,layout:"custom",placement:"custom"})}};b._setupCommandListeners=function(){var f=this._site,m=this._appBarCommandArray,l=m.length,h=this._appBarControl,n=Boolean(h)&&h.disabled;this._setAppBarDisabled(true);this._numActiveCommandElements=l;for(var i=0;i<l;i++){var p=m[i],b=p.id,e=f.isCommandEnabled(b),d=f.getCommandStateRegistrar(b);if(b!==a.Commands.deleteSeparator)this._isCommandHidden[b]=false;var c=false;if(b===a.Commands.clearCmd){this._updateClearVisibility(e);c=true;d.addEventListener("statechanged",this._clearStateChangeHandler)}else if(b===a.Commands.deleteCmd){this._isCommandHidden[a.Commands.deleteSeparator]=false;this._updateDeleteVisibility(e);c=true;d.addEventListener("statechanged",this._deleteStateChangeHandler)}else if(b===a.Commands.setAs){for(var k=this._setAsCommandArray,o=k.length,g=0,j=0;j<o;j++){b=k[j].id;e=f.isCommandEnabled(b);d=f.getCommandStateRegistrar(b);if(e)g++;d.addEventListener("statechanged",this._setAsStateChangeHandler)}this._updateSetAsVisibility(g);c=true;this._numSetAsCommandsEnabled=g}else if(this._toggleButtonInfo[b]){this._updateCommandToStage(b,f.getCommandStage(b));d.addEventListener("statechanged",this._toggleCommandStateChange)}else if(b===a.Commands.basket){c=true;this._basketThumb=new PhotoViewer.BasketThumb(this._dataHub,this,h.getCommandById(a.Commands.basket));this._basketThumb.activateUI()}else if(b===a.Commands.deleteSeparator)c=true;else if(b===a.Commands.viewOnline)d.addEventListener("statechanged",this._updateViewOnlineStrings);else if(b===a.Commands.sas)c=true;else d.addEventListener("statechanged",this._toggleCommandStateChange);!c&&this._updateElementState(b,e)}this._updateBatchedCommands();this._setAppBarDisabled(n);this.updateForMode(this._currentMode)};b._tearDownCommandListeners=function(){for(var g=this._appBarCommandArray,j=g.length,h=this._site,d=0;d<j;d++){var b=g[d].id,c=h.getCommandStateRegistrar(b);if(c)if(b===a.Commands.clearCmd)c.removeEventListener("statechanged",this._clearStateChangeHandler);else if(b===a.Commands.deleteCmd)c.removeEventListener("statechanged",this._deleteStateChangeHandler);else if(b===a.Commands.setAs)for(var f=this._setAsCommandArray,i=f.length,e=0;e<i;e++){b=f[e].id;c=h.getCommandStateRegistrar(b);c.removeEventListener("statechanged",this._setAsStateChangeHandler)}else if(this._toggleButtonInfo[b])c.removeEventListener("statechanged",this._toggleCommandStateChange);else if(b===a.Commands.basket||b===a.Commands.deleteSeparator||b===a.Commands.sas)continue;else if(b===a.Commands.viewOnline)c.removeEventListener("statechanged",this._updateViewOnlineStrings);else c.removeEventListener("statechanged",this._toggleCommandStateChange)}};b._registerEvents=function(){this._site.registerForCommandingBatches(this._batchCommandingUpdates,false)};b._unregisterEvents=function(){this._site.registerForCommandingBatches(this._batchCommandingUpdates,true);var a=this._appBarControl;if(a){a.removeEventListener("afterhide",this._appBarHidden,false);a.removeEventListener("aftershow",this._appBarShown,false)}};b._ensureTopBarComponents=function(a){if(a)Boolean(this._backButtonComponent)&&this._backButtonComponent.hasUI()&&this._backButtonComponent.shutdownUI();else{if(!this._backButtonComponent){this._backButtonComponent=new PhotoViewer.BackButton(this._site);this._backButtonComponent.setExistsInAppBar();this.appendChild(this._backButtonComponent)}!this._backButtonComponent.hasUI()&&this._backButtonComponent.initUI(document.getElementById("TopBarBackButton"))}};b._batchCommandingUpdates=function(b){var a=b.starting;this._batchCommandUpdates=a;!a&&this._updateBatchedCommands()};b._appBarHidden=function(){this._appBarVisibilityChanged(false);if(this._initOnHide&&this.hasUI()){SasManager.init(Jx.res.getString("resid-app-name"),a.Commands.sas);this._initOnHide=false}};b._appBarShown=function(){this._appBarVisibilityChanged(true);PhotoViewer.log.perf("evPhotoViewer_AppBar_Visible",{emptyValue:true})};b._appBarVisibilityChanged=function(a){if(this._appBarControl.sticky)this._appBarOpenWhileSticky=a};b._setAppBarDisabled=function(b){var a=this._appBarControl;if(a.disabled!==b)a.disabled=b};b._site=null;b._backButtonComponent=null;b._commandMapLeft=null;b._appBarElement=null;b._appBarControl=null;b._topBarElement=null;b._topBarControl=null;b._commandsToShow=null;b._commandsToHide=null;b._isCommandHidden=null;b._numActiveCommandElements=0;b._basketThumb=null;b._setAsMenu=null;b._numSetAsCommandsEnabled=0;b._initOnHide=false;b._appBarInitializationPromise=null;b._appBarInitializationPromiseComplete=null})()