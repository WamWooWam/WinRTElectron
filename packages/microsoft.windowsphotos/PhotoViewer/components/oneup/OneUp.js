(function(){var c=15,e=35,d=5,b=4;PhotoViewer.KBAndMousePZHandler=function(a,b){this._element=a;this._pzView=b;this._onMouseWheel=this._onMouseWheel.bind(this);this._onKeyDown=this._onKeyDown.bind(this);this._onKeyUp=this._onKeyUp.bind(this);this._onDoubleClick=this._onDoubleClick.bind(this);this._onPointerDown=this._onPointerDown.bind(this);this._onPointerUp=this._onPointerUp.bind(this);this._onDragStart=this._onDragStart.bind(this);a.addEventListener("wheel",this._onMouseWheel,true);a.addEventListener("keydown",this._onKeyDown,true);a.addEventListener("keyup",this._onKeyUp,true);a.addEventListener("dblclick",this._onDoubleClick,true);a.addEventListener("MSPointerDown",this._onPointerDown,true);a.addEventListener("MSPointerUp",this._onPointerUp,true);a.addEventListener("dragstart",this._onDragStart,true)};var a=PhotoViewer.KBAndMousePZHandler.prototype;a.shutdown=function(){var a=this._element;a.removeEventListener("wheel",this._onMouseWheel,true);a.removeEventListener("keydown",this._onKeyDown,true);a.removeEventListener("keyup",this._onKeyUp,true);a.removeEventListener("dblclick",this._onDoubleClick,true);a.removeEventListener("MSPointerDown",this._onPointerDown,true);a.removeEventListener("MSPointerUp",this._onPointerUp,true);a.removeEventListener("dragstart",this._onDragStart,true);if(this._mouseMoveEventAdded){this._element.removeEventListener("MSPointerMove",this._onPointerMove,true);this._mouseMoveEventAdded=false}this._pzView=null;this._element=null};a._onMouseWheel=function(a){var b=this._pzView;if(b&&a.ctrlKey){b.handleKeyboardOrMouseWheelZoom(a.deltaY>0);a.stopPropagation();a.preventDefault()}};a._onDragStart=function(a){if(this._pzView){a.cancelBubble=true;a.stopPropagation();a.preventDefault()}return false};a._getKeyboardPanDelta=function(b){var a=c;if(b){this._keyPressRepeatVelocity+=a;a=this._keyPressRepeatVelocity}else this._keyPressRepeatVelocity=c;a=Math.min(e,a);return a};a._onKeyDown=function(b){var a=this._pzView;if(a){var c=false,d=WinJS.Utilities.Key;if(b.ctrlKey)switch(b.keyCode){case d.add:case d.equal:a.handleKeyboardOrMouseWheelZoom(false);c=true;break;case d.subtract:case d.dash:a.handleKeyboardOrMouseWheelZoom(true);c=true}else if(a.shouldAllowPan()){switch(b.keyCode){case d.leftArrow:var f=a.isRTL()?1:-1;c=a.handleKeyboardOrMousePan(f*this._getKeyboardPanDelta(b.repeat),0);break;case d.upArrow:c=a.handleKeyboardOrMousePan(0,-1*this._getKeyboardPanDelta(b.repeat));break;case d.rightArrow:var e=a.isRTL()?-1:1;c=a.handleKeyboardOrMousePan(e*this._getKeyboardPanDelta(b.repeat),0);break;case d.downArrow:c=a.handleKeyboardOrMousePan(0,this._getKeyboardPanDelta(b.repeat))}this._keyDownTriggeredPan=c}if(c){b.stopPropagation();b.preventDefault()}}};a._onKeyUp=function(a){if(this._pzView){if(this._keyDownTriggeredPan){a.stopPropagation();a.preventDefault()}this._keyDownTriggeredPan=false}};a._onPointerDown=function(a){if(this._pzView&&a.pointerType===b){this._mouseRecord={x:a.screenX,y:a.screenY};if(!this._mouseMoveEventAdded){this._element.addEventListener("MSPointerMove",this._onPointerMove.bind(this),true);this._mouseMoveEventAdded=true}}};a._onPointerUp=function(c){var a=this._pzView;if(a&&c.pointerType===b){this._mouseRecord=null;this._element.removeEventListener("MSPointerMove",this._onPointerMove,true);this._mouseMoveEventAdded=false;this._panned=false}};a._onPointerMove=function(c){if(this._mouseMoveEventAdded&&c.pointerType===b){var f=this._pzView;if(this._mouseRecord)if(f.shouldAllowPan()){var a={x:c.screenX,y:c.screenY},e=this._mouseRecord,g=e.x-a.x,h=e.y-a.y;if(Math.abs(g)>d||Math.abs(h)>d){f.handleKeyboardOrMousePan(g,h);this._mouseRecord=a;this._panned=true}}else{this._mouseRecord=null;this._element.removeEventListener("MSPointerMove",this._onPointerMove,true)}}};a._onDoubleClick=function(b){var a=this._pzView;a&&a.shouldAllowDoubleClick(b.target)&&a.goToMaxZoomLevel()};a._element=null;a._pzView=null;a._mouseMoveEventAdded=false;a._keyPressRepeatVelocity=c;a._keyDownTriggeredPan=false;a._panned=false})();(function(){var d=window.PhotoViewer,c=d.ViewHelpers,j=WinJS.Promise,h=WinJS.UI.Animation,i=WinJS.Utilities,g=0,f=4,e="videoScrubber-videoScrubberBar",b=function(a,c,b){a=Math.max(a,c);a=Math.min(a,b);return a};PhotoViewer.VideoScrubber=function(b,a){this._pointerMoveEventAdded=false;this._videoEventSubscriptions=[];this._onPointerDown=this._onPointerDown.bind(this);this._onPointerMove=this._onPointerMove.bind(this);this._onPointerUp=this._onPointerUp.bind(this);this._onLostPointerCapture=this._onLostPointerCapture.bind(this);this._onVideoDurationChanged=this._onVideoDurationChanged.bind(this);this._onVideoError=this._onVideoError.bind(this);this._onVideoTimeUpdate=this._onVideoTimeUpdate.bind(this);this._onScrubberBarResize=this._onScrubberBarResize.bind(this);this._afterVideoAppBarShow=this._afterVideoAppBarShow.bind(this);this._activateUI(b,a)};var a=d.VideoScrubber.prototype;a.updateCurrentVideoElementNotifications=function(a,g){if(a){this._updateVideoTimeDuringScrub=g;var f=this._currentMediaElement!==a;if(f){this.teardownMediaElement();this._currentMediaElement=a;this._addVideoEventListener("durationchange",this._onVideoDurationChanged);this._addVideoEventListener("error",this._onVideoError)}var b=a.duration;if(Jx.isValidNumber(b)&&b!==0){if(b!==this._currentVideoDuration){var d=true;if(!f)for(var e=this._videoEventSubscriptions,h=e.length,c=0;c<h;c++)if(e[c].eventName==="timeupdate")d=false;if(d){this._addVideoEventListener("timeupdate",this._onVideoTimeUpdate);this._addVideoEventListener("seeked",this._onVideoTimeUpdate)}Jx.removeClass(this._thumbElement,"displayNone");Jx.removeClass(this._currentTimeIndicator,"displayNone");this._currentVideoDuration=b}}else{Jx.addClass(this._thumbElement,"displayNone");Jx.addClass(this._currentTimeIndicator,"displayNone")}this._updateTimeDisplay(false)}};a.hideVideoScrubber=function(){this._videoScrubberEdgeControl.hide()};a.showVideoScrubber=function(){this._videoScrubberEdgeControl.show()};Object.defineProperty(a,"enabled",{"get":function(){return!this._videoScrubberEdgeControl.disabled},"set":function(b){var a=!b;if(a!==this._videoScrubberEdgeControl.disabled){this._videoScrubberEdgeControl.disabled=a;!a&&this._updateVideoAppBarPosition()}}});a.shutdown=function(){this.teardownMediaElement();this._thumbElement.removeEventListener("MSPointerDown",this._onPointerDown,false);this._thumbElement.removeEventListener("MSPointerUp",this._onPointerUp,false);this._thumbElement.removeEventListener("MSLostPointerCapture",this._onLostPointerCapture,false);if(this._pointerMoveEventAdded){this._thumbElement.removeEventListener("MSPointerMove",this._onPointerMove,false);this._pointerMoveEventAdded=false}this._videoScrubberBar.detachEvent("onresize",this._onScrubberBarResize);this._appBarControl&&this._appBarControl.removeEventListener("aftershow",this._afterVideoAppBarShow,false);c.removeElementFromDOM(this._videoScrubberBar);this.enabled=false};a._activateUI=function(k,j){var a=document.createElement("div");this._videoScrubberBar=a;a.id=e;var d=this;a.innerHTML='    <div class="videoScrubber-content">        <div class="mediaPlaybackControlsLayer" role="group">            <div class="mediaPlaybackControlsTapEater"></div>            <div class="mediaPlaybackControlsBackdrop"></div>            <!--This is the seek bar, it has an invisible area on both sides of the actual visual to aid touch events-->            <div class="mediaPlaybackSeekBar" role="progressbar">                <div class="mediaPlaybackSeekBarRail"></div>                <div class="mediaPlaybackSeekBarProgress"></div>                <div class="mediaPlaybackCurrentTimeIndicator"></div>                <div class="mediaPlaybackTotalTimeIndicator"></div>            </div>            <img class="mediaPlaybackSeekBarThumb" role="slider" src="/PhotoViewer/Images/gripper_default.svg">            <div class="mediaPlaybackSeekBarThumbToolTip"></div>        </div> <!--mediaPlaybackControlsLayer -->    </div> <!--videoScrubber-content -->';k.appendChild(a);this._videoScrubberEdgeControl=new WinJS.UI.AppBar(a,{disabled:true,layout:"custom",placement:"custom"});j.onAppBarInitialized().done(function(){d._appBarElement=document.getElementById("BottomAppBar");d._appBarControl=d._appBarElement.winControl;d._appBarControl.addEventListener("aftershow",d._afterVideoAppBarShow,false);d._updateVideoAppBarPosition()});var b=c.getFirstElementByClassName;this._thumbElement=b(a,"mediaPlaybackSeekBarThumb");this._thumbElementToolTip=b(a,"mediaPlaybackSeekBarThumbToolTip");this._seekBar=b(a,"mediaPlaybackSeekBar");this._seekBarRail=b(a,"mediaPlaybackSeekBarRail");this._progress=b(a,"mediaPlaybackSeekBarProgress");this._currentTimeIndicator=b(a,"mediaPlaybackCurrentTimeIndicator");this._totalTimeIndicator=b(a,"mediaPlaybackTotalTimeIndicator");var f=this._thumbElement;f.draggable=false;f.addEventListener("MSPointerDown",this._onPointerDown,false);f.addEventListener("MSPointerUp",this._onPointerUp,false);f.addEventListener("MSLostPointerCapture",this._onLostPointerCapture,false);a.attachEvent("onresize",this._onScrubberBarResize);var g=9,i=60,h=(this._seekBar.offsetTop-this._seekBarRail.offsetHeight-this._thumbElementToolTip.clientHeight-g-i).toString();this._thumbElementToolTip.style.top=h+"px";this._moveThumbToBeginning()};a._addVideoEventListener=function(a,b){this._currentMediaElement.addEventListener(a,b,false);var c={eventName:a,handler:b};this._videoEventSubscriptions.push(c)};a.teardownMediaElement=function(){var b=this._videoEventSubscriptions,d=b.length,c=this._currentMediaElement;if(d>0&&Boolean(c))for(var a=0;a<d;a++)c.removeEventListener(b[a].eventName,b[a].handler,false);this._videoEventSubscriptions=[];this._currentMediaElement=null;this._currentVideoDuration=null;this._currentPlaybackRate=0;this._lastScrubbedTime=0;this._wasPausedBeforeScrubbing=false};a._moveThumbToBeginning=function(){var b=-180,a=this._seekBar.offsetLeft;this._thumbElement.style.transform="translateX("+a.toString()+"px) rotate("+b.toString()+"deg) ";this._progress.style.width="0px"};a._onScrubberBarResize=function(a){this._updateVideoProgressAndTime(a)};a._onVideoError=function(){this.enabled=false};a._onVideoDurationChanged=function(a){this.updateCurrentVideoElementNotifications(this._currentMediaElement,this._updateVideoTimeDuringScrub);this._updateVideoProgressAndTime(a)};a._onVideoTimeUpdate=function(a){!this._isThumbPressed&&!this._currentMediaElement.seeking&&this._updateVideoProgressAndTime(a)};a._getTotalThumbTravelDistanceOnSeekBar=function(){var a=this._seekBar.clientWidth,b=this._thumbElement.clientWidth;return a-b};a._getSeekbarThumbStartOffset=function(){return this._seekBar.offsetLeft+this._thumbElement.clientWidth/2};a._updateTimeDisplay=function(f){var e=this._getDuration(),c=f?this._lastScrubbedTime:this._currentMediaElement.currentTime;c=b(c,0,e);var a=this._formatTime(c,"_currentTimeIndicatorValue"),d=this._formatTime(e,"_totalTimeIndicatorValue");if(a){this._currentTimeIndicator.innerText=a;this._thumbElementToolTip.innerText=a}if(d)this._totalTimeIndicator.innerText=d};a._formatTime=function(a,b){a=Math.floor(a);var c=this[b];if(c!==a){this[b]=a;return WindowsLive.Photo.Viewer.DataModel.Formatting.formatDuration(a)}else return null};a._onPointerDown=function(a){if(this._videoScrubberEdgeControl.hidden)return;else if(a.pointerType===f&&a.button!==g)return;else{try{this._thumbElement.msSetPointerCapture(a.pointerId)}catch(b){Jx.log.info("Caught exception using msSetPointerCapture. e: "+b.toString())}a.preventDefault()}this._onThumbStartDrag();if(!this._pointerMoveEventAdded){this._thumbElement.addEventListener("MSPointerMove",this._onPointerMove,false);this._pointerMoveEventAdded=true}this._isThumbPressed=true;return true};a._onPointerMove=function(a){if(this._isThumbPressed){a.preventDefault();this._updateVideoProgressAndTime(a)}return true};a._onLostPointerCapture=function(a){this._isThumbPressed&&this._onPointerUp(a)};a._onPointerUp=function(a){this._onThumbStopDrag();if(this._isThumbPressed){this._thumbElement.removeEventListener("MSPointerMove",this._onPointerMove,false);this._pointerMoveEventAdded=false;this._isThumbPressed=false}this._thumbElement.msReleasePointerCapture(a.pointerId);return true};a._onThumbStartDrag=function(){this._wasPausedBeforeScrubbing=this._currentMediaElement.paused;this._currentPlaybackRate=this._currentMediaElement.playbackRate;this._lastScrubbedTime=this._currentMediaElement.currentTime;this._currentMediaElement.playbackRate=0;return true};a._onThumbStopDrag=function(){if(!this._updateVideoTimeDuringScrub){var c=this._currentMediaElement.currentTime,a=this._lastScrubbedTime,b=this._currentMediaElement;if(Jx.isValidNumber(c)&&Jx.isValidNumber(a)&&c!==a&&b.readyState!==b.HAVE_NOTHING)b.currentTime=a}if(!this._wasPausedBeforeScrubbing){this._currentMediaElement.playbackRate=this._currentPlaybackRate;this._currentMediaElement.play()}this._thumbElementToolTip.style.opacity="0";return true};a._afterVideoAppBarShow=function(){this._updateVideoAppBarPosition()};a._updateVideoProgressAndTime=function(h){var l=this._seekBar.clientWidth,m=this._getTotalThumbTravelDistanceOnSeekBar(),f=this._currentMediaElement.currentTime,c=this._getDuration(),a=this._seekBar.offsetLeft,g,d;if(this._isThumbPressed){if(this._videoScrubberEdgeControl.hidden)return;var o=l+a,u=this._getSeekbarThumbStartOffset(),n=this._thumbElement.clientWidth/2,z=o-n,v=h.clientX,r=Math.min(Math.max(v,a+n),z);g=r-u;var e=g/m*c;d=c>0?e/c:0;if(Jx.isValidNumber(f)&&Jx.isValidNumber(e)&&f!==e){this._lastScrubbedTime=e;if(this._updateVideoTimeDuringScrub)this._currentMediaElement.currentTime=e;var y=this._thumbElementToolTip.clientWidth,i=y/2,p=o-i,s=a+i,q=Math.min(Math.max(h.clientX,a+i),p),w=q-s,k=a+w;k=b(k,a,p);this._thumbElementToolTip.style.opacity="1";this._thumbElementToolTip.style.transform="translateX("+k.toString()+"px) "}}else{if(h.type==="timeupdate"||h.type==="seeked")this.enabled=true;f=b(f,0,c);d=c>0?f/c:0;g=d*m}var x=a+g,A=-180-d*90;this._thumbElement.style.transform="translateX("+x.toString()+"px) rotate("+A.toString()+"deg) ";var j=d*l;j=b(j,0,l);this._progress.style.width=j.toString()+"px";var t=this._isThumbPressed;this._updateTimeDisplay(t);return true};a._updateVideoAppBarPosition=function(){if(this._appBarElement){var a=this._appBarElement.offsetHeight;this._videoScrubberBar.style.bottom=a.toString()+"px"}};a._getDuration=function(){var a=this._currentMediaElement.duration;if(!Jx.isValidNumber(a)||a<0)a=0;return a};a._videoScrubberBar=null;a._appBarElement=null;a._appBarControl=null;a._thumbElement=null;a._thumbElementToolTip=null;a._seekBar=null;a._seekBarRail=null;a._progress=null;a._currentTimeIndicatorValue=null;a._currentTimeIndicator=null;a._totalTimeIndicatorValue=null;a._totalTimeIndicator=null;a._pointerMoveEventAdded=false;a._isThumbPressed=false;a._currentMediaElement=null;a._videoEventSubscriptions=null;a._currentVideoDuration=null;a._currentPlaybackRate=0;a._lastScrubbedTime=0;a._wasPausedBeforeScrubbing=false})();(function(){var d=window.PhotoViewer,g=d.DataHubHelpers,c=d.AppBar.Commands,h=d.ViewHelpers,i=Windows.System;d.OneUpCurrentItemInfo=function(){};var e=d.OneUpCurrentItemInfo.prototype;e.itemObjectId=null;e.hasItemBeenPaused=false;e.hasItemEnded=false;var b=WindowsLive.Photo.Viewer.Commanding,f="viewOnlineUrl";d.OneUpController=function(b,c,a){this._component=b;this._dataHub=c;this._coordinator=a;this._modeSwapPending=false;this._currentItemInfo=new d.OneUpCurrentItemInfo;this._togglePlayPauseHandler=this._togglePlayPauseHandler.bind(this);this._deleteCurrentAsset=this._deleteCurrentAsset.bind(this);this._viewAssetOnline=this._viewAssetOnline.bind(this);this._setAsHandler=this._setAsHandler.bind(this)};var a=d.OneUpController.prototype;a.getMainViewUI=function(a,b){if(!this._view)this._view=new d.OneUpView(this._component.id);this._view.getMainViewUI(a,b)};a.activateUI=function(a){this._setupCommanding();if(Boolean(this._pendingNavState))var c=this._restorePendingNavState(a);else if(!this._component.coordinator.navStack.navigating){var b=this._dataHub.contentContainer;if(Boolean(a)&&Boolean(a.container))b=a.container;this.initializeUI(a,b,-1,null)}};a.initializeUI=function(e,m,j,a){var c=this._dataHub;c.contentContainer=m;var l=c.content,h=PhotoViewer.OneUpViewMode.oneUpViewer;if(Boolean(e)&&e.mode===PhotoViewer.Coordinator.Mode.slideshow)h=PhotoViewer.OneUpViewMode.slideshow;var k=Jx.isValidNumber(j)&&j>=0;this._loadPage=k?j:0;var b=this._assetOnlyDSA=new d.AssetOnlyDSA(c,l),i=b.count;this._viewerBehavior=new d.OneUpViewerBehavior(b,this);this._slideshowBehavior=new d.OneUpSlideshowBehavior(b,this);this._behaviorNotificationProxy=new d.OneUpBehaviorNotificationProxy(this);if(Boolean(e)&&Boolean(e.activeItemId)){a=e.activeItemId;Boolean(a)&&i>0&&b.setActiveItem(a)}!k&&this._getLoadPageFromActiveItem();if(!Jx.isValidNumber(this._loadPage)||this._loadPage<0)this._loadPage=0;var g=false;try{if(!a&&this._loadPage<i)a=b.indexToObjectId(this._loadPage);if(i===0&&b.populationComplete)g=true;else{c.updateActiveItem(a);this._singleActiveItemDSA=new d.AssetOnlyDSA(c,c.activeItem)}}catch(p){g=true;Jx.log.error("OneUpController.initializeUI: caught exception: "+String(p))}finally{if(g){this._activationFailed=true;var o=this;window.msSetImmediate(function(){o.navigateBackFromOneUp()})}}if(!g){if(!this._view)this._view=new d.OneUpView(this._component.id);if(Boolean(this._singleActiveItemDSA)&&this.mode===PhotoViewer.Coordinator.Mode.openWith){b.deactivate();this._assetOnlyDSA=b=this._singleActiveItemDSA;this._singleActiveItemDSA=null}this._view.initialize(b,this._singleActiveItemDSA,this._behaviorNotificationProxy,this,this._coordinator.imgCache,this._loadPage,a,h);var f={};if(h===PhotoViewer.OneUpViewMode.slideshow){this._behaviorNotificationProxy.currentBehavior=this._slideshowBehavior;f.skipInitialTransition=true;f.delayInitUntilInitialPageCompleted=true;this._slideshowBehavior.enable(f)}else{this._behaviorNotificationProxy.currentBehavior=this._viewerBehavior;this._viewerBehavior.enable(f)}this.updateCurrentItemInfo(a);Jx.log.info("OneUpController: Prefetching item during init. id: "+a+"   index: "+String(this._loadPage));var n=this._view.getPrefetcher();n.prefetchItem(a)}d.log.perf("evPhotoViewerOneUp_InitializeComplete",{emptyValue:true})};a.beginShutdown=function(){var a=this._view.getLatestMediaElementForObjectId(this._currentItemInfo.itemObjectId);Boolean(a)&&a.tagName==="VIDEO"&&!a.paused&&a.pause();this._view&&this._view.deactivate();this._assetOnlyDSA&&this._assetOnlyDSA.deactivate();this._singleActiveItemDSA&&this._singleActiveItemDSA.deactivate()};a.shutdown=function(){if(this._view){this._view.shutdown();this._view=null}if(this._assetOnlyDSA){this._assetOnlyDSA.shutdown();this._assetOnlyDSA=null}if(this._singleActiveItemDSA){this._singleActiveItemDSA.shutdown();this._singleActiveItemDSA=null}this._pendingNavState=null;this._activationFailed=false};a.postActivateUI=function(){if(!this._activationFailed){this._view.postActivateUI();this._coordinator.addCommand(c.deleteCmd,b.CommandEnableProperties.activeItemExists|b.CommandEnableProperties.sourceAllowsDelete,b.CommandEnableProperties.viewIs1Up|b.CommandEnableProperties.viewIsOpenWith,b.CommandEnableProperties.none,b.ExpectedActionableItems.singleActiveItem,true,this._deleteCurrentAsset);var a=this,e=function(){var b=a._view.getFlipViewContainer();try{b.focus()}catch(c){}},f=this._coordinator.animationRefCountedPromise,d=f.getCompletionPromiseIfPending();if(d)d.then(function(){Boolean(a._view)&&a._view.isInitialized()&&e()});else e()}};a.getEntranceAnimationInfo=function(){return this._activationFailed?null:this._view.getEntranceAnimationInfo()};a.getExitAnimationInfo=function(){return this._activationFailed?null:this._view.getExitAnimationInfo()};a.zoomOutOfOneUp=function(){if(this.canZoomOutOfOneUp()){var a=this._component.coordinator;a.doCommand(PhotoViewer.AppBar.Commands.returnToMegastripFromOneUp,WindowsLive.Photo.Viewer.Commanding.CommandSurface.canvas,null,null)}};a.canZoomOutOfOneUp=function(){return this._coordinator.mode!==PhotoViewer.Coordinator.Mode.openWith};a.showAppBars=function(a){this._coordinator.showAppBars(true,a?PhotoViewer.AppBar.Bars.top:PhotoViewer.AppBar.Bars.all)};a.changeMode=function(a){this._component.changeMode(a)};a.switchToViewMode=function(b){if(!this._modeSwapPending&&b!==this._view.getViewerMode()){this._modeSwapPending=true;var a=this,c=this._behaviorNotificationProxy.currentBehavior;c&&c.disable();window.msSetImmediate(function(){a._modeSwapPending=false;var c=null;if(b===d.OneUpViewMode.oneUpViewer)c=a._viewerBehavior;else if(b===d.OneUpViewMode.slideshow)c=a._slideshowBehavior;a._view.setViewerMode(b);a._behaviorNotificationProxy.currentBehavior=c;c&&c.enable(null)})}};a.getView=function(){return this._view};a.updateCurrentItemInfo=function(a){if(this._currentItemInfo.itemObjectId!==a){this._currentItemInfo.itemObjectId=a;this._currentItemInfo.hasItemEnded=false;this.setCurrentItemHasBeenPaused()}};a.getCurrentItemObjectId=function(){return this._currentItemInfo.itemObjectId};a.hasCurrentItemBeenPaused=function(){return this._currentItemInfo.hasItemBeenPaused};a.setCurrentItemHasBeenPaused=function(){this._currentItemInfo.hasItemBeenPaused=true;this._setPlayPauseCommandState(c.play)};a.hasCurrentItemEnded=function(){return this._currentItemInfo.hasItemEnded};a.setCurrentItemEnded=function(a){this._currentItemInfo.hasItemEnded=a;var b=a?c.play:c.pause;this._setPlayPauseCommandState(b)};a.videoPlay=function(a){this.getCurrentItemObjectId()===a.objectId&&this.setCurrentItemEnded(false)};a.videoPause=function(a){this.getCurrentItemObjectId()===a.objectId&&this.setCurrentItemHasBeenPaused()};a.videoSeeked=function(b){if(this.getCurrentItemObjectId()===b.objectId){var a=b.mediaElement;!a.paused&&this.hasCurrentItemBeenPaused()&&a.currentTime===0&&this._setPlayPauseCommandState(c.pause,false)}};a.videoEnded=function(a){if(this.getCurrentItemObjectId()===a.objectId){this.setCurrentItemEnded(true);a.mediaElement.pause()}};a.getNavState=function(){if(!this._component.isActive())return null;var a=0,b=null;if(Boolean(this._view)&&this._view.isInitialized())a=this._view.getCurrentPage();if(this._assetOnlyDSA.count>0)b=this._assetOnlyDSA.indexToObjectId(a);return{loadPage:a,loadPageObjectId:b}};a.setNavState=function(a){if(a)try{this._dataHub.updateActiveItem(a.loadPageObjectId)}catch(d){this._activationFailed=true;return WinJS.Promise.wrap(false)}this._pendingNavState=a;if(this._component.hasUI()){var b=this._restorePendingNavState(null);if(!b)this._activationFailed=true;return WinJS.Promise.wrap(b)}return WinJS.Promise.wrap(true)};a.clearNavState=function(){this._pendingNavState=null};a.slideshowDisablingCharmInvoked=function(){this._view.getViewerMode()===d.OneUpViewMode.slideshow&&this._slideshowBehavior.slideshowDisablingCharmInvoked()};a.navigateBackFromOneUp=function(){if(this._userInputDisable)this._navigateBackWhenInputIsEnabled=true;else this._coordinator.doCommand(c.navigateBack,WindowsLive.Photo.Viewer.Commanding.CommandSurface.canvas,null,null)};a.getPlateauScalingCallback=function(){return this._coordinator.plateauScaleManager.getPhysicalSize};a.onRenderComplete=function(){var b=this,a=this._view;return h.onRenderComplete(a,d.OneUpView.Events.initialViewRenderComplete,function(){return b._activationFailed||a.isViewportInitialRenderComplete()})};a._restorePendingNavState=function(b){var a=this._pendingNavState,c=this._dataHub.contentContainer;this.initializeUI(b,c,a.loadPage,a.loadPageObjectId);this._pendingNavState=null;return true};a._getLoadPageFromActiveItem=function(){var a=this._dataHub.activeItem;if(a.size>0){var b=a.idAt(0);if(b)this._loadPage=this._assetOnlyDSA.objectIdToIndex(b);if(!Jx.isValidNumber(this._loadPage))this._loadPage=0}};a._setupCommanding=function(){this._coordinator.beginBatchCommandingUpdate();this._coordinator.addCommand(c.playPause,b.CommandEnableProperties.activeItemIsVideo,b.CommandEnableProperties.viewIs1Up|b.CommandEnableProperties.viewIsOpenWith,b.CommandEnableProperties.none,b.ExpectedActionableItems.none,true,this._togglePlayPauseHandler);var a=this.hasCurrentItemBeenPaused()||this.hasCurrentItemEnded()?c.pause:c.play;this._setPlayPauseCommandState(a);this._coordinator.addCommand(c.viewOnline,b.CommandEnableProperties.viewIs1Up|b.CommandEnableProperties.sourceAllowsViewOnSource|b.CommandEnableProperties.activeItemExists,b.CommandEnableProperties.none,b.CommandEnableProperties.none,b.ExpectedActionableItems.singleActiveItem,true,this._viewAssetOnline);this._coordinator.addCommand(c.setTile,b.CommandEnableProperties.activeItemExists|b.CommandEnableProperties.sourceAllowsSetAsTile,b.CommandEnableProperties.viewIs1Up|b.CommandEnableProperties.viewIsOpenWith,b.CommandEnableProperties.activeItemIsVideo,b.ExpectedActionableItems.singleActiveItem,true,this._setAsHandler);this._coordinator.addCommand(c.lockScreen,b.CommandEnableProperties.activeItemExists|b.CommandEnableProperties.sourceAllowsLockScreen,b.CommandEnableProperties.viewIs1Up|b.CommandEnableProperties.viewIsOpenWith,b.CommandEnableProperties.activeItemIsVideo,b.ExpectedActionableItems.singleActiveItem,true,this._setAsHandler);this._coordinator.addCommand(c.setBackground,b.CommandEnableProperties.activeItemExists|b.CommandEnableProperties.sourceAllowsLockScreen,b.CommandEnableProperties.viewIs1Up|b.CommandEnableProperties.viewIsOpenWith,b.CommandEnableProperties.activeItemIsVideo,b.ExpectedActionableItems.singleActiveItem,true,this._setAsHandler);this._coordinator.endBatchCommandingUpdate()};a._togglePlayPauseHandler=function(b){var a=this._view.getLatestMediaElementForObjectId(this._currentItemInfo.itemObjectId);if(a&&a.tagName==="VIDEO")if(b===c.play){a.play();this._setPlayPauseCommandState(c.pause,false)}else b===c.pause&&a.pause();return null};a._deleteCurrentAsset=function(c,b){d.log.perf("evPhotoViewerCommanding_Delete_Start",{emptyValue:true});var a=this;this._disableUserInput(true,false);this._coordinator.updateCurrentlyDeleting(true);b.executeAsync("deleteAssets",null).then(function(b){a._disableUserInput(false,true);d.log.perf("evPhotoViewerCommanding_Delete_Stop",{emptyValue:true});if(b)var c=new Windows.UI.Popups.MessageDialog(Jx.res.getString("resid-delete-DeleteSingleFailureMessage"),Jx.res.getString("resid-delete-DeleteSingleItemFailureTitle")).showAsync().done();a._coordinator.updateCurrentlyDeleting(false)},function(){a._disableUserInput(false,true);d.log.perf("evPhotoViewerCommanding_Delete_Stop",{emptyValue:true});a._coordinator.updateCurrentlyDeleting(false)});return null};a._setAsHandler=function(f,j){this._coordinator.disableUserInput(true,false);var a=false,e=false,h,i=this,g=function(){try{if(h){var b="";switch(f){case c.setTile:b="resid-SetAs-Error-TileTitle";break;case c.setBackground:b="resid-SetAs-Error-BackgroundTitle";break;case c.lockScreen:b="resid-SetAs-Error-LockScreenTitle"}var a;switch(h){case 2147942405:a="resid-SetAs-Error-UnauthorizedCopyOfWindows";break;case 2147942402:a="resid-SetAs-Error-FileDoesntExist";break;case 2147942414:a="resid-SetAs-Error-OutOfMemory";break;case 2147943560:a="resid-SetAs-Error-NoPixels";break;default:a="resid-SetAs-Error-Generic"}new Windows.UI.Popups.MessageDialog(Jx.res.getString(a),Jx.res.getString(b)).showAsync().done()}else if(f===c.setBackground){var d=i._coordinator.applicationSettings.localSettingsContainer,e=d.get("useCustomBackground")||0;d.set("useCustomBackground",++e)}}finally{i._coordinator.disableUserInput(false,true)}},b=function(){if(e&&!a)try{i._view.hideSetAsOverlay().done(function(){g()},function(){g()})}catch(b){g()}};try{j.executeAsync(f,null).then(function(a){e=true;h=a;b()},function(){e=true;b()});a=true;var d="";switch(f){case c.setTile:d="resid-SetAs-TileProgress";break;case c.setBackground:d="resid-SetAs-BackgroundProgress";break;case c.lockScreen:d="resid-SetAs-LockScreenProgress"}this._view.showSetAsOverlay(Jx.res.getString(d)).done(function(){window.setTimeout(function(){a=false;b()},1e3)})}catch(k){e=true;a=false;b()}return null};a._setPlayPauseCommandState=function(a){this._coordinator.setCommandStage(c.playPause,a)};a._disableUserInput=function(a,b){this._coordinator.disableUserInput(a,b);this._userInputDisable=a;if(!a&&this._navigateBackWhenInputIsEnabled){this._navigateBackWhenInputIsEnabled=false;this._coordinator.doCommand(c.navigateBack,WindowsLive.Photo.Viewer.Commanding.CommandSurface.canvas,null,null)}};a._viewAssetOnline=function(){var a=this._assetOnlyDSA.indexToObject(this._view.getCurrentPage());a&&a.getProperties([f],function(d,b){var a=g.tryLookupPropertyInMap(b,f);try{if(Jx.isNonEmptyString(a)){var c=new Windows.Foundation.Uri(a);i.Launcher.launchUriAsync(c).done()}}catch(e){}});return null};Object.defineProperty(a,"mode",{"get":function(){return this._coordinator.mode}});Object.defineProperty(a,"coordinator",{"get":function(){return this._coordinator}});a._component=null;a._dataHub=null;a._coordinator=null;a._viewerBehavior=null;a._behaviorNotificationProxy=null;a._view=null;a._slideshowBehavior=null;a._assetOnlyDSA=null;a._singleActiveItemDSA=null;a._modeSwapPending=false;a._loadPage=0;a._currentItemInfo=null;a._pendingNavState=null;a._activationFailed=false;a._userInputDisable=false;a._navigateBackWhenInputIsEnabled=false})();(function(){PhotoViewer.OneUpViewItemInfo=function(a,d,b){this.objectId=d;this._mediaElement=null;this.mediaType=PhotoViewer.OneUpViewItemInfo.MediaType.unknown;this.itemType=b;this.itemSQMReported=false;this.itemWidth=-1;this.itemHeight=-1;this.itemTitle="";this.itemDiv=null;this.gridDiv=null;this.resizeToken=0;this.retrievingMedia=false;this.mediaUnloaded=true;this.zoomEventAdded=false;this.zoomMode=c.ZoomMode.none;this.manipulationState=0;this.zoomFactor=1;this.cachedScrollLimitsX=null;this.cachedScrollLimitsY=null;this.itemSynchronousCreationCompleted=false;this.fullResolutionImage=false;this.inTransition=false;this.waitingForImageLoad=false;this.setMediaElement(a)};var c=PhotoViewer.OneUpViewItemInfo;c.MediaType={unknown:0,image:1,video:2,error:3};c.ZoomMode={determineBehavior:"determineBehavior",sezo:"sezo",oz:"oz",none:"none"};var d=WindowsLive.Photo.Viewer.DataModel.BlobResultQuality,a=PhotoViewer.OneUpViewItemInfo.MediaType,b=PhotoViewer.OneUpViewItemInfo.prototype;b.setMediaElement=function(b){this._mediaElement=b;this.mediaType=a.unknown;if(b)if(b.tagName==="IMG")this.mediaType=a.image;else if(b.tagName==="VIDEO")this.mediaType=a.video;else if(Jx.hasClass(b,"oneUp-failureElement"))this.mediaType=a.error;else if(Jx.hasClass(b,"oneUp-item-placeholder"))this.mediaType=a.image};b.isLoaded=function(){return this._isLoadedHelper(false)};b.isFullyLoaded=function(){return this._isLoadedHelper(true)};b.isError=function(){if(this._mediaElement)if(this.mediaType===a.image)return!Jx.isNullOrUndefined(this._mediaElement.errorStatus)&&this._mediaElement.errorStatus!==PhotoViewer.OneUpErrorStatus.success;else if(this.mediaType===a.video){var b=this._mediaElement;if(b.error&&!this.mediaUnloaded)return b.error.code!==0}else if(this.mediaType===a.error)return true;return false};b.isImage=function(){return this.mediaType===a.image};b.isVideo=function(){return this.mediaType===a.video};b.haveDimensions=function(){return this.itemHeight!==-1&&this.itemWidth!==-1};b.getPage=function(a){return a.objectIdToIndex(this.objectId)};b.setZoomMode=function(a){if(a!==this.zoomMode){Jx.log.info("OneUpViewItemInfo: setting zoomMode to: "+a+"  for object: "+this.objectId);this.zoomMode=a;this.itemDiv.setAttribute("zoomMode",a)}};Object.defineProperty(b,"mediaElement",{"get":function(){return this._mediaElement},"set":function(a){this.setMediaElement(a)}});b._isLoadedHelper=function(c){if(Boolean(this._mediaElement)&&!this.isError()){var b=this._mediaElement;if(this.mediaType===a.image){if(c)if(b.thumbnailCurrentQuality===d.lowQualityBetterPending)return false;return b.readyState==="complete"}else if(this.mediaType===a.video)return b.readyState===b.HAVE_ENOUGH_DATA}return false}})();(function(){var d=PhotoViewer.DataHubHelpers,u=d.SourceType,h=PhotoViewer.ViewHelpers,n=PhotoViewer.Graphics,o=PhotoViewer.ZoomButtons,p=WindowsLive.Photo.Viewer.DataModel,c=p.BlobResultQuality,l=p.ObjectChangedEventFields,f=PhotoViewer.OneUpViewItemInfo.ZoomMode,O=PhotoViewer.SourcesHelpers;PhotoViewer.OneUpViewMode={none:"none",oneUpViewer:"oneUpViewer",slideshow:"slideshow"};var g={rest:0,manipulating:1,inertia:2},t="oneUp-componentDiv",L="oneUp-flipViewContainer",k="oneUp-fillContainerDiv",G="oneUp-enterExitDiv",x="oneUp-slideshowInputCaptureDiv",E="oneUp-setAsOverlayDiv",C="oneUp-setAsOverlayText",F="oneUp-flipView-leftNav",D="oneUp-flipView-rightNav",M="oneUp-mediaItem-",S="oneUp-item-",Q="oneUp-grid-item",y="oneUp-videoScrubberContainer",N="oneUp-gridElement",R="oneUp-itemContainer",s="oneup-transition-waitingForLoad",r=.1,A=2,m=PhotoViewer.ImgCache.ImgSizes.oneUp,K=1.05,I=.99,U=.98,P=3,i=1,H=0;PhotoViewer.OneUpWLI={AttemptVideoPlay:{failure:0,success:1}};function e(b){return b.itemInfo}var b=PhotoViewer.OneUpErrorStatus={success:0,genericError:1,noInternet:2,deviceOffline:3,mediaErrNetwork:4,mediaErrDecode:5,mediaErrSrcNotSupported:6,mediaErrAborted:7},w=function(a){if(a)switch(a.code){case a.MEDIA_ERR_ABORTED:return b.mediaErrAborted;case a.MEDIA_ERR_DECODE:return b.mediaErrDecode;case a.MEDIA_ERR_NETWORK:return b.mediaErrNetwork;case a.MEDIA_ERR_SRC_NOT_SUPPORTED:return b.mediaErrSrcNotSupported}return b.genericError},J=function(){var a=Windows.Networking.Connectivity,b=a.NetworkInformation.getInternetConnectionProfile();if(b){var c=b.getNetworkConnectivityLevel();return c===a.NetworkConnectivityLevel.internetAccess}else return false};PhotoViewer.OneUpRenderInfo=function(){};var j=PhotoViewer.OneUpRenderInfo.prototype;j.itemThumbnailResult=null;j.itemMediaResult=null;j.itemCurrentThumbnailQuality=c.lowQualityBetterPending;j.errorStatus=b.success;j.errorElement=null;j.errorElementCreated=false;PhotoViewer.TransitionItemInfo=function(){};var v=PhotoViewer.TransitionItemInfo.prototype;v.itemDiv=null;v.gridDiv=null;v.htmlMediaElement=null;PhotoViewer.OneUpView=function(d){this._callback=null;this._prefetcher=null;this._newTransitionInfo={};this._progressBar=new PhotoViewer.ProgressBarTimer(d);this._onKeyDown=this._onKeyDown.bind(this);this._onKeyUp=this._onKeyUp.bind(this);this._onBlur=this._onBlur.bind(this);this._onMouseWheel=this._onMouseWheel.bind(this);this._onMSContentZoom=this._onMSContentZoom.bind(this);this._onManipulationStateChanged=this._onManipulationStateChanged.bind(this);this._onMSPointerDown=this._onMSPointerDown.bind(this);this._onMSGestureTap=this._onMSGestureTap.bind(this);for(var b=["_pageVisibilityChangedCallback","_pageCompletedCallback","_onResize","_onSlideshowPointerDown"],a=0,e=b.length;a<e;a++){var c=b[a];this[c]=h.createConditionalCallbackProxy(this.isInitialized,this[c],this)}this._loadListeners={}};var q=PhotoViewer.OneUpView;q.Events={initialViewRenderComplete:"initialViewRenderComplete"};Jx.augment(q,Jx.Events);var a=q.prototype;a.initialize=function(b,c,n,f,o,g,e,l){this._callback=n;this._controller=f;this._imgCache=o;this._convertPixelsPhysicalToLogicalCallback=f.getPlateauScalingCallback();this._isInitialized=true;this._dataAdaptorCallback=new PhotoViewer.OneUpViewChangeNotificationHelper({singleItemInserted:this._singleItemInserted.bind(this),singleItemRemoved:this._singleItemRemoved.bind(this)},{allItemsRemoved:this._allItemsRemoved.bind(this)},b,e);b.addObjectModifiedHandler(this);if(c)if(g<b.count){this._dataAdaptor=b;c.deactivate()}else{this._dataAdaptor=c;this._contentDataAdaptor=b}else this._dataAdaptor=b;var i=this._componentDiv=document.getElementById(t);this._enterExitDiv=document.getElementById(G);var h=this._slideshowInputDiv=document.getElementById(x);this._setAsOverlayDiv=document.getElementById(E);this._setAsOverlayText=document.getElementById(C);this._setAsOverlayDiv.setAttribute("aria-hidden","true");var a=document.createElement("div");a.id=L;a.className=k;i.insertBefore(a,h);this._flipViewContainer=a;this._flipView=new WinJS.UI.FlipView(a,{axis:"horizontal",currentPage:g,itemDataSource:new PhotoViewer.VirtualizedDataSource(this._dataAdaptor),itemTemplate:WinJS.UI.simpleItemRenderer(this._itemRendererCallback.bind(this)),prefetchAmount:3});if(this._contentDataAdaptor){var d=this._contentDataAdaptor.objectIdToIndex(e);Jx.isValidNumber(d)&&d>=0&&this._switchFlipViewDataSource(d)}this._addEventListeners();this.setViewerMode(l);var m=a.getElementsByClassName("win-navleft"),j=a.getElementsByClassName("win-navright");m[0].id=F;j[0].id=D;this._pzKBAndMouseHandler=new PhotoViewer.KBAndMousePZHandler(a,{handleKeyboardOrMouseWheelZoom:function(a){return this._handleKeyboardOrMouseZoom(a)}.bind(this),handleKeyboardOrMousePan:function(a,b){return this._handleKeyboardOrMousePan(a,b)}.bind(this),shouldAllowDoubleClick:function(a){return this._shouldAllowDoubleClick(a)}.bind(this),goToMaxZoomLevel:function(){return this._goToMaxZoomLevel()}.bind(this),shouldAllowPan:function(){return this.isCurrentItemZoomed()}.bind(this),isRTL:function(){return this.isRTL()}.bind(this)})};a.isInitialized=function(){return this._isInitialized};a.postActivateUI=function(){this._isActivated=true};a.deactivate=function(){this._progressBar.suppressProgressBarIfNecessary();this._removeEventListeners();this._cleanUpCurrentPage(true);this._currentPageItemDiv=null;this._enterExitDiv=null;this._slideshowInputDiv=null;this._setAsOverlayDiv=null;this._setAsOverlayText=null;if(this._flipViewContainer){h.removeElementFromDOM(this._flipViewContainer);this._flipViewContainer=null}if(this._pzKBAndMouseHandler){this._pzKBAndMouseHandler.shutdown();this._pzKBAndMouseHandler=null}if(this._dataAdaptorCallback){this._dataAdaptorCallback.shutdown();this._dataAdaptorCallback=null}this._convertPixelsPhysicalToLogicalCallback=null;if(this._videoScrubberControl){this._videoScrubberControl.shutdown();this._videoScrubberControl=null;var a=this._videoScrubberContainer;if(Boolean(a)&&Boolean(a.firstElementChild))for(var c=a.children,b=c.length-1;b>=0;b--)this._videoScrubberContainer.removeChild(c[b])}var d=this._zoomButtons;if(d){d.shutdown();this._zoomButtons=null}this._isInitialized=false;this._isActivated=false};a.shutdown=function(){this.isInitialized()&&this.deactivate();this._componentDiv=null;this._mode=PhotoViewer.OneUpViewMode.none;this._prefetcher=null};a.getMainViewUI=function(a,b){b.html='<div id="'+a+'" class="moPho-clientComponent">  <div id="'+t+'" class="'+k+'">    <div id="'+x+'" class="oneUp-flipViewContainer '+k+'" aria-hidden="true"></div>    <div id="'+E+'" class="'+k+'" aria-hidden="true">        <div id="'+C+'"></div>    </div>    <div id="'+G+'" class="oneUp-flipViewContainer oneUp-fadeInOutTransition '+k+' oneUp-noOpaque" aria-hidden="true"></div>  </div>  <div id="'+y+'"></div></div>'};a.getViewerMode=function(){return this._mode};a.setViewerMode=function(e){if(this._mode!==e){this._mode=e;var b=this._mode===PhotoViewer.OneUpViewMode.slideshow;this._slideshowInputDiv.setAttribute("aria-hidden",b?"false":"true");this._enterExitDiv.setAttribute("aria-hidden","true");var f=this.getViewItemInfoForCurrentPage();if(f)if(Boolean(this._videoScrubberControl)&&f.isVideo())this._videoScrubberControl.enabled=!b;var a;if(!b){a=this._ensureZoomButtons();a.enabled=true}else{a=this._zoomButtons;if(a)a.enabled=false}this._flipViewContainer.setAttribute("mode",e);var d;if(b){var c=function(b,a){a.style.left="0px";a.style.top="0px";a.style.opacity="0.0";b.style.opacity="1.0";return WinJS.UI.Animation.crossFade(a,b)};d={next:c,previous:c,jump:c}}else d={next:null,previous:null,jump:null};this._flipView.setCustomAnimations(d)}};a.getEntranceAnimationInfo=function(){var a=this._componentDiv||document.getElementById(t);return PhotoViewer.AnimationHelpers.genericComponentAnimationInfoWithLayoutPos(a?[a]:[],a,"OneUpView","Entrance",true,this._getLayoutPosFn())};a.getExitAnimationInfo=function(){var a=this._componentDiv,b=this;return{orderedElements:[a],beginAnimation:function(){var b=document.getElementById(F);if(b)b.style.visibility="hidden";var a=document.getElementById(D);if(a)a.style.visibility="hidden"},isClientView:true,referenceFrameElement:a,getLayoutPos:this._getLayoutPosFn()}};a.playEnterExitTransition=function(c){var a=this._enterExitDiv;a.setAttribute("aria-hidden","false");Jx.removeClass(a,"oneUp-noOpaque");var b=282;window.setTimeout(function(){Jx.addClass(a,"oneUp-noOpaque");window.setTimeout(function(){a.setAttribute("aria-hidden","true");c()},b)},b*2)};a.iterateNext=function(){this._flipView.next()};a.iteratePrevious=function(){this._flipView.previous()};a.getPrefetcher=function(){if(!this._prefetcher)this._prefetcher=new PhotoViewer.OneUpViewPrefetcher(this._dataAdaptor,this._itemRendererCallback.bind(this));return this._prefetcher};a.getCurrentPage=function(){return this._flipView.currentPage};a.setCurrentPage=function(a){this._flipView.currentPage=a};a.getItemDivIdForObjectId=function(a){return S+a};a.getGridDivIdForObjectId=function(a){return Q+a};a.getGridDivForObjectId=function(a){var b=this.getGridDivIdForObjectId(a);return document.getElementById(b)};a.getLatestMediaElementForObjectId=function(b){var a=this.getGridDivForObjectId(b),c=a?a.firstElementChild:null;return c};a.getAllMediaElementsForObjectId=function(b){var a=this.getGridDivForObjectId(b);return a?a.children:null};a.getViewItemInfoForCurrentPage=function(){return this.getViewItemInfoForPage(this.getCurrentPage())};a.getViewItemInfoForPage=function(a){var c=this._dataAdaptor.count;if(!Jx.isValidNumber(a)||a>=c)return null;var b=this._dataAdaptor.indexToObjectId(a);return this._getViewItemForObjectId(b)};a._getViewItemInfoForMediaElement=function(c){var a=null,b=c.parentNode;if(b){var d=b.parentNode;a=e(d)}return a};a._getPageForItemInfo=function(a){return this._dataAdaptor.objectIdToIndex(a.objectId)};a._swapRenderedItemForObjectId=function(f,a){var c;if(a.mediaElement)c=a.mediaElement;if(c){var b,d=a.itemDiv;if(d)b=d.getAttribute("aria-hidden");else b="true";var e=this._createHtmlMediaElementForObjectId(a,f,b);this._swapHtmlElements(a,e)}};a.getFlipViewContainer=function(){return this._flipViewContainer};a.isRTL=function(){var a=window.getComputedStyle(this._flipViewContainer,null);return a?a.direction==="rtl":false};a.showSetAsOverlay=function(a){this._setAsOverlayText.innerHTML=a;return PhotoViewer.AnimationHelpers.setAsBeginAnimation(this._setAsOverlayDiv)};a.hideSetAsOverlay=function(){return PhotoViewer.AnimationHelpers.setAsEndAnimation(this._setAsOverlayDiv)};a.isViewportInitialRenderComplete=function(){return this._hasItemFinishedInitialRender(this.getViewItemInfoForCurrentPage())};a.isCurrentItemZoomed=function(){var a=this._currentPageItemDiv;if(a){var b=this._getDivZoomFactor(a);return b!==i}return false};a._getMediaElementDomId=function(a){return M+a};a._cleanUpCurrentPage=function(k){var d=this._currentPageItemDiv;if(d){var b=e(d),j=b.objectId,c=k||this._dataAdaptor.isDeactivated();if(!c)try{var i=this._dataAdaptor.objectIdToObject(j);c=i&&i.sourceType===u.device}catch(m){c=true}if(c)b.mediaUnloaded=true;if(!k&&b.zoomEventAdded){b.setZoomMode(f.determineBehavior);d.msContentZoomFactor=1;this._handleMSContentZoom(b,true)}var g=this.getAllMediaElementsForObjectId(j);if(g)for(var h=0,l=g.length;h<l;h++){var a=g[h];if(a&&a.tagName==="VIDEO")if(c)a.src="";else if(a.readyState!==a.HAVE_NOTHING)a.currentTime=0}}};a._checkLoadVideo=function(){var b=this._currentPageItemDiv;if(b){var a=e(b),c=a.objectId;if(a.mediaUnloaded)!a.retrievingMedia&&this._updateMediaForItem(a)}};a._getCurrentPageObjectId=function(){var a=this.getCurrentPage();return a>=this._dataAdaptor.count?null:this._dataAdaptor.indexToObjectId(a)};a._getItemDivForObjectId=function(a){var b=this.getItemDivIdForObjectId(a);return document.getElementById(b)};a._getItemDivFromWrapperElement=function(a){return a?a.firstElementChild:null};a._getViewItemForObjectId=function(b){var a=this._getItemDivForObjectId(b);if(!a&&Boolean(this._prefetcher))a=this._prefetcher.getPrefetchedItem(b);var c=a?e(a):null;return c};a._getLayoutPosFn=function(){return function(d,a){var b=this.getLatestMediaElementForObjectId(d);if(!b||!a)return WinJS.Promise.wrap(null);var c=PhotoViewer.ViewHelpers.getLayoutPosInElement(b,a);return WinJS.Promise.wrap(c)}.bind(this)};a._sizeItem=function(g,f){var c=this._flipViewContainer.offsetWidth,b=this._flipViewContainer.offsetHeight;if(c<=0||b<=0){c=this._flipViewContainer.clientWidth;b=this._flipViewContainer.clientHeight}var h=g.itemDiv;h.style.width=String(c)+"px";h.style.height=String(b)+"px";if(f&&f.tagName!=="VIDEO"){var e=g.itemWidth,d=g.itemHeight;if(!n.areDimensionsValid(e,d))e=d=Math.min(c,b);var a=n.scaleAspect(c,b,false,e,d);if(a.width>e*2||a.height>d*2){a.width=e*2;a.height=d*2}f.style.width=String(a.width)+"px";f.style.height=String(a.height)+"px"}g.resizeToken=this._resizeToken};a._tryUpdateItemSizeUsingCache=function(a){var f=a.objectId;if(a.itemType==="asset.photo"){var b=this._imgCache.getImg(f,m,true,true);if(Boolean(b)&&b.sizeLevel===m){var d=b.img,e=a.itemDiv.getAttribute("aria-hidden");this._prepareHtmlMediaElement(d,a,c.highQuality,e);this._swapHtmlElements(a,d);this._sendFakeLoadEventForCachedImg(a);return true}}return false};a._checkUseDecodedSize=function(a){if(a.mediaType===PhotoViewer.OneUpViewItemInfo.MediaType.image&&a.isLoaded())if(!n.areDimensionsValid(a.itemWidth,a.itemHeight)){var b=a.mediaElement;a.itemWidth=b.naturalWidth;a.itemHeight=b.naturalHeight;this._sizeItem(a,a.mediaElement)}};a.objectModified=function(d,c){var a=false;if(c&l.thumbnail)a=this._updateThumbnailForObjectId(d);else if(c&l.thumbnailStatus){var e=this._getViewItemForObjectId(d);if(e){this._showErrorElementForItem(e,b.genericError);a=true}}else if(c&l.dimensions)a=this._updateDimensionsForObjectId(d);else if(Boolean(c&l.selection)||Boolean(c&l.other))a=true;if(!a&&d===this._getCurrentPageObjectId()){this._cleanUpCurrentPage(false);this._currentPageItemDiv=null}return a};a._updateThumbnailForObjectId=function(c){var a=this._getViewItemForObjectId(c),b;if(a){var d=new PhotoViewer.OneUpRenderInfo;if(a.itemType==="asset.photo"){if(!a.fullResolutionImage){b=this._dataAdaptor.objectIdToObject(c);this._getImageThumbnail(b,d,a)}}else if(a.itemType==="asset.video"){b=this._dataAdaptor.objectIdToObject(c);this._getVideoThumbnail(b,d,a)}return true}return false};a._updateDimensionsForObjectId=function(a){var c=this._dataAdaptor.objectIdToObject(a);if(c){var b=this._getViewItemForObjectId(a);if(b)return this._tryUpdateItemSizeUsingCache(b)}return false};a._updateMediaForItem=function(a){var b=this._dataAdaptor.objectIdToObject(a.objectId),c=new PhotoViewer.OneUpRenderInfo;if(a.itemType==="asset.photo")a.fullResolutionImage&&this._getImageMedia(b,c,a);else a.itemType==="asset.video"&&this._getVideoMedia(b,c,a)};function B(d){var b=new PhotoViewer.OneUpViewItemInfo(null,d,""),a=document.createElement("div");a.className="dummyItemDiv";var c=document.createElement("div");c.className="dummyGridDiv";a.appendChild(c);b.gridDiv=c;b.itemDiv=a;a.itemInfo=b;return a}a._itemRendererCallback=function(s){var d=s.key;Jx.log.info("OneUpView::_itemRendererCallback: "+d);var t=this,b;if(!this.isInitialized())b=B(d);var h=this._currentPageItemDiv;if(!b&&h){var j=e(h);if(Boolean(j)&&j.objectId===d){b=h;j.itemType==="asset.photo"&&j.isFullyLoaded()&&PhotoViewer.log.perf("evPhotoViewerOneUp_ThumbnailLoaded",{itemID:d,thumbnailQuality:c.highQuality})}}if(!b&&this._prefetcher){b=this._prefetcher.getPrefetchedItem(d);if(b){Jx.log.info("OneUpView::_itemRendererCallback  using prefetched item.");var l=b.itemInfo;Boolean(l)&&l.itemType==="asset.photo"&&l.isFullyLoaded()&&PhotoViewer.log.perf("evPhotoViewerOneUp_ThumbnailLoaded",{itemID:d,thumbnailQuality:c.highQuality})}}var o=s.index===this.getCurrentPage();if(!b){var f=new PhotoViewer.OneUpRenderInfo,g;try{g=this._dataAdaptor.objectIdToObject(d)}catch(u){}var p=o?"false":"true";if(g){var a=new PhotoViewer.OneUpViewItemInfo(null,d,g.type);b=document.createElement("div");b.itemInfo=a;b.id=this.getItemDivIdForObjectId(d);Jx.addClass(b,R);var k=document.createElement("div");k.id=this.getGridDivIdForObjectId(d);Jx.addClass(k,N);if(this._flipView)try{if(o)if(a.itemType==="asset.photo")if(h)try{if(b.msContentZoomFactor!==h.msContentZoomFactor)b.msContentZoomFactor=h.msContentZoomFactor}catch(v){}}catch(v){}a.itemDiv=b;a.gridDiv=k;b.appendChild(k);this._getItemRenderProperties(g,f,a);var i=this._imgCache.getImg(d,m,true,true),q=i?i.img:null,r=Boolean(i)&&i.sizeLevel===m,n=false;if(!r&&a.itemType==="asset.photo")n=this._getImageThumbnail(g,f,a);else if(a.itemType==="asset.video"){n=this._getVideoThumbnail(g,f,a);this._getVideoMedia(g,f,a)}if(a.itemType==="asset.photo"&&Boolean(i)&&!n){if(r){f.itemCurrentThumbnailQuality=c.highQuality;PhotoViewer.log.perf("evPhotoViewerOneUp_ThumbnailLoaded",{itemID:d,thumbnailQuality:c.highQuality})}else f.itemCurrentThumbnailQuality=c.lowQualityBetterPending;a.mediaElement=q;this._prepareHtmlMediaElement(q,a,f.itemCurrentThumbnailQuality,p);this._sendFakeLoadEventForCachedImg(a)}if(!a.mediaElement)a.mediaElement=this._createHtmlMediaElementForObjectId(a,f,p);this._setUpOpticalZoomForItem(a,false);a.gridDiv.appendChild(a.mediaElement);a.itemSynchronousCreationCompleted=true}else b=B(d)}if(o)this._currentPageItemDiv=b;return b};a._getItemRenderProperties=function(e,f,a){var c=this;e.getProperties(["width","height","title"],function(m,e){if(!c.isInitialized()){Jx.log.warning("_getItemRenderProperties::getProperties: Async callback after uninitialized.");return}var h=false;if(e.hasKey("width")&&e.hasKey("height")){var k=parseInt(d.tryLookupPropertyInMap(e,"width"),10),i=parseInt(d.tryLookupPropertyInMap(e,"height"),10);h=n.areDimensionsValid(k,i)&&(k!==a.itemWidth||i!==a.itemHeight);if(h){a.itemWidth=k;a.itemHeight=i}}var j=d.tryLookupPropertyInMap(e,"title"),l=j!==a.itemTitle;a.itemTitle=j;if(a.itemSynchronousCreationCompleted){var g=false;if(h&&f.errorStatus===b.success){g=c._tryUpdateItemSizeUsingCache(a);!g&&c._sizeItem(a,a.mediaElement)}l&&!g&&c._updateElementsTitle(c.getAllMediaElementsForObjectId(a.objectId),j)}})};a._sendFakeLoadEventForCachedImg=function(a){window.msSetImmediate(function(){if(this._dataAdaptor.isDeactivated()){Jx.log.warning("_sendFakeLoadEventForCachedImg_msSetImmediate async callback after dsa was deactivated");return}Jx.log.info("OneUpView::_sendFakeLoadEventForCachedImg using img from image cache. Sending fake load event to callback");this._callback.imageLoad(a,null)}.bind(this))};a._getRequiredThumbnailSize=function(){var b=this._flipViewContainer.offsetWidth,a=this._flipViewContainer.offsetHeight;if(this._convertPixelsPhysicalToLogicalCallback){b=this._convertPixelsPhysicalToLogicalCallback(b);a=this._convertPixelsPhysicalToLogicalCallback(a)}return{width:b,height:a}};a._getImageThumbnail=function(g,a,b){var f=this,d=false,e=this._getRequiredThumbnailSize();b.mediaUnloaded=false;g.getThumbnailAsync(e.width,e.height,null,false).then(function(e){var g=e.quality;a.itemCurrentThumbnailQuality=g;if(g===c.error)e=null;d=f._getThumbnailCallback(e,a,b)}).done(null,function(){a.itemCurrentThumbnailQuality=c.error;f._getThumbnailCallback(null,a,b)});return d};a._getVideoThumbnail=function(g,a,e){var f=this,b=false,d=this._getRequiredThumbnailSize();g.getThumbnailAsync(d.width,d.height,null,false).then(function(d){var g=d.quality;a.itemCurrentThumbnailQuality=g;if(g===c.error)d=null;b=f._getVideoThumbnailCallback(d,a,e)}).done(null,function(){a.itemCurrentThumbnailQuality=c.error;f._getVideoThumbnailCallback(null,a,e)});return b};a._getImageMedia=function(b,c,a){var d=this;if(!a.retrievingMedia){a.retrievingMedia=true;a.mediaUnloaded=false;b.getMediaAsync(p.GetMediaAsyncFlags.none).then(function(b){a.retrievingMedia=false;d._getImageMediaCallback(b,c,a)}).done(null,function(){a.retrievingMedia=false})}};a._getVideoMedia=function(d,e,a){var b=this,g=a.itemDiv,f=a.objectId;function c(){var c=false;if(!a.retrievingMedia){var e=b.getViewItemInfoForCurrentPage();if(Boolean(e)&&e.objectId===f)c=true;else if(d.sourceType!==u.device)c=true}return c}if(c()){a.retrievingMedia=true;a.mediaUnloaded=false;d.getMediaAsync(p.GetMediaAsyncFlags.none).then(function(d){a.retrievingMedia=false;c()&&b._getMediaCallback(d,e,a)}).done(null,function(){a.retrievingMedia=false;b._getMediaCallback(null,e,a)})}};a._validateThumbnailResult=function(a,b,c){if(d.isBlobOperationResultValid(a))b.itemThumbnailResult=a;else if(c.itemSynchronousCreationCompleted)return false;else b.itemThumbnailResult=null;return true};a._getThumbnailCallback=function(d,a,c){if(this.isInitialized()){if(d){if(!this._validateThumbnailResult(d,a,c))return false}else a.errorStatus=b.genericError;c.itemSynchronousCreationCompleted&&this._swapRenderedItemForObjectId(a,c);return true}return false};a._getVideoThumbnailCallback=function(f,b,a){var e=false;if(this.isInitialized())if(f)if(this._validateThumbnailResult(f,b,a)){if(a.itemSynchronousCreationCompleted){var c=a.mediaElement;if(c.tagName==="VIDEO"){c.thumbnailCurrentQuality=b.itemCurrentThumbnailQuality;c.poster=d.getSourceFromBlobOperationResult(b.itemThumbnailResult,false);b.itemThumbnailResult=null;this._checkInitialViewRenderComplete(a.objectId)}else this._swapRenderedItemForObjectId(b,a)}e=true}!e&&this._checkInitialViewRenderComplete(a.objectId);return e};a._getMediaCallback=function(f,c,a){if(this.isInitialized())if(f){c.itemMediaResult=f;if(a.itemSynchronousCreationCompleted){var e=a.mediaElement;if(e.tagName==="VIDEO"){e.src=d.getSourceFromBlobOperationResult(c.itemMediaResult,false);c.itemMediaResult=null;PhotoViewer.log.perf("evPhotoViewer_OneUp_VideoSrcSet",{emptyValue:true})}else this._swapRenderedItemForObjectId(c,a)}}else{if(a.itemType==="asset.video"&&!a.itemSQMReported){Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.Photo.attemptVideoPlay,PhotoViewer.OneUpWLI.AttemptVideoPlay.failure);a.itemSQMReported=true}c.errorStatus=b.genericError;a.itemSynchronousCreationCompleted&&this._swapRenderedItemForObjectId(c,a)}};a._getImageMediaCallback=function(a,b,c){if(this.isInitialized())if(a){b.itemMediaResult=a;c.itemSynchronousCreationCompleted&&this._swapRenderedItemForObjectId(b,c)}};a._prepareHtmlMediaElement=function(a,b,c,e){var d=b.objectId;a.id=this._getMediaElementDomId(d);this._updateElementsTitle([a],b.itemTitle);this._sizeItem(b,a);a.thumbnailCurrentQuality=c;Jx.addClass(a,"oneUp-item");b.itemDiv.setAttribute("aria-hidden",e)};a._updateElementsTitle=function(a,c){if(c)if(a)for(var b=0,d=a.length;b<d;b++)a[b].setAttribute("aria-label",c)};a._createHtmlMediaElementForObjectId=function(e,d,h){var a,g=false;try{if(d.errorStatus===b.success)if(e.itemType==="asset.photo"){a=this._createImage(d,e);if(!Jx.isNullOrUndefined(a.errorStatus)&&a.errorStatus!==b.success)d.errorStatus=a.errorStatus;else if(!e.fullResolutionImage&&d.itemCurrentThumbnailQuality===c.highQuality)g=true}else if(e.itemType==="asset.video"){a=this._createVideo(d,e);if(a.error)d.errorStatus=w(a.error)}else d.errorStatus=b.genericError}catch(i){d.showItemErrorElement=true}if(d.errorStatus!==b.success)a=this._createErrorElement(e.objectId,d.errorStatus);this._prepareHtmlMediaElement(a,e,d.itemCurrentThumbnailQuality,h);if(a.msReusableBlob){var f=d.itemThumbnailResult.dimensions;this._imgCache.storeImg(e.objectId,m,a,f.width,f.height,null)}return a};a._addImageLoadCallback=function(e,b){var a=this;function d(f){var d=f.target;a._removeMediaLoadListeners(d);if(a.isInitialized()){if(b.mediaElement!==d||!a._isInDOM(d))return;try{if(a.getCurrentPage()===a._getPageForItemInfo(b)){var e=d.thumbnailCurrentQuality;e!==c.lowQualityBetterPending&&a._progressBar.suppressProgressBarIfNecessary();PhotoViewer.log.perf("evPhotoViewerOneUp_ThumbnailLoaded",{itemID:b.objectId,thumbnailQuality:e})}}catch(g){Jx.log.warning("Caught exception in oneUpView image load handler. ("+String(g)+")");a._progressBar.suppressProgressBarIfNecessary()}a._checkUseDecodedSize(b);a._callback.imageLoad(b,f)}}this._addMediaLoadListener(e,"load",d)};a._createImage=function(a,h){var b,g=null,e=a.itemThumbnailResult,f=a.itemMediaResult;if(e||f){b=document.createElement("img");this._addMediaElementErrorCallback(b,this._callback.imageError.bind(this._callback),a);this._addImageLoadCallback(b,h);if(f){a.itemCurrentThumbnailQuality=c.highQuality;g=d.getSourceFromBlobOperationResult(f,false);h.fullResolutionImage=true}else{h.fullResolutionImage=false;if(e){var j=a.itemThumbnailResult.dimensions,l=j.width,k=j.height,i=n.areDimensionsValid(l,k)&&a.itemCurrentThumbnailQuality===c.highQuality&&this._controller.mode!==PhotoViewer.Coordinator.Mode.openWith;g=d.getSourceFromBlobOperationResult(e,i);if(i)b.msReusableBlob=true}}b.src=g}else{b=document.createElement("div");Jx.addClass(b,"oneUp-item-placeholder")}return!a.errorElementCreated?b:a.errorElement};a._addVideoListeners=function(c,b){c.addEventListener("canplaythrough",h.createConditionalCallbackProxy(a.isInitialized,function(c){var a=c.target;if(a!==b.mediaElement||!this._isInDOM(a))return;if(this.getCurrentPage()===this._getPageForItemInfo(b)){this._progressBar.suppressProgressBarIfNecessary();PhotoViewer.log.perf("evPhotoViewerOneUp_VideoCanPlayThrough",{emptyValue:true})}if(!b.itemSQMReported){Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.Photo.attemptVideoPlay,PhotoViewer.OneUpWLI.AttemptVideoPlay.success);b.itemSQMReported=true}this._callback.videoCanPlayThrough(b,c)},this),false);c.addEventListener("ended",h.createConditionalCallbackProxy(a.isInitialized,function(c){var a=c.target;if(a!==b.mediaElement||!this._isInDOM(a))return;this._callback.videoEnded(b,c)},this),false);c.addEventListener("play",h.createConditionalCallbackProxy(a.isInitialized,function(c){var a=c.target;if(a!==b.mediaElement||!this._isInDOM(a))return;this.getCurrentPage()===this._getPageForItemInfo(b)&&PhotoViewer.log.perf("evPhotoViewerOneUp_VideoPlay",{emptyValue:true});this._callback.videoPlay(b,c)},this),false);c.addEventListener("pause",h.createConditionalCallbackProxy(a.isInitialized,function(c){var a=c.target;if(a!==b.mediaElement||!this._isInDOM(a))return;this._callback.videoPause(b,c)},this),false);c.addEventListener("seeked",h.createConditionalCallbackProxy(a.isInitialized,function(c){var a=c.target;if(a!==b.mediaElement||!this._isInDOM(a))return;this._callback.videoSeeked(b,c)},this),false)};a._createVideo=function(a,e){var b=document.createElement("video");b.preload="auto";b.controls=false;this._addVideoListeners(b,e);this._addMediaElementErrorCallback(b,this._callback.videoError.bind(this._callback),a);b.oncontextmenu=this._videoContextMenuReplacement.bind(this);var c=null,f=a.itemThumbnailResult;if(a.itemThumbnailResult){c=d.getSourceFromBlobOperationResult(f,false);a.itemThumbnailResult=null}if(!c)c="/Resources/PhotoViewer/Images/DefaultLoadingImage.png";b.poster=c;if(Boolean(a.itemMediaResult)&&e.haveDimensions()){b.src=d.getSourceFromBlobOperationResult(a.itemMediaResult,false);a.itemMediaResult=null;PhotoViewer.log.perf("evPhotoViewer_OneUp_VideoSrcSet",{emptyValue:true})}return!a.errorElementCreated?b:a.errorElement};a._addMediaElementErrorCallback=function(e,c,b){var a=this;function d(g){var e=g.target;a._removeMediaLoadListeners(e);if(a.isInitialized()){var d=a._getViewItemInfoForMediaElement(e);if(!d||e!==d.mediaElement)return;if(d.mediaUnloaded)return;var f=w(e.error);e.errorStatus=f;!d.mediaElement&&d.setMediaElement(e);if(d.itemType==="asset.video"&&!d.itemSQMReported){Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.Photo.attemptVideoPlay,PhotoViewer.OneUpWLI.AttemptVideoPlay.failure);d.itemSQMReported=true}c(d,g);if(d.itemSynchronousCreationCompleted)a._showErrorElementForItem(d,f);else{b.errorElement=a._createErrorElement(d.objectId,f);b.errorElementCreated=true}}}this._addMediaLoadListener(e,"error",d)};a._addMediaLoadListener=function(b,d,e){b.addEventListener(d,e,false);if(b.tagName!=="VIDEO"){var f=b.uniqueID,c=this._loadListeners,a=c[f];if(!a)a=c[f]={};a[d]=e}};a._removeMediaLoadListeners=function(c){var e=c.uniqueID,b=this._loadListeners,a=b[e];if(a){for(var d in a)c.removeEventListener(d,a[d],false);delete b[e]}};a._createErrorElement=function(e,c){var a=document.createElement("div");Jx.addClass(a,"oneUp-failureElement photoViewer-failureText oneUp-item-placeholder");try{this._dataAdaptor.objectIdToObject(e).getProperties(["title","sourceTitle","sourceStatus"],function(i,f,j){if(j){if(!d.isLocalSourceType(i.sourceType))if(!J())c=b.noInternet;else{var g=f.lookup("sourceStatus");if(g!==O.SourceStatus.connectedProviderOnline)c=b.deviceOffline}var k=f.lookup("title"),h=f.lookup("sourceTitle"),e="";switch(c){case b.noInternet:e=Jx.res.getString("resid-oneup-errorNoInternet");break;case b.deviceOffline:e=Jx.res.loadCompoundString("resid-oneup-errorDeviceOffline",h);break;case b.mediaErrNetwork:e=Jx.res.getString("resid-oneup-errorMediaErrNetwork");break;case b.mediaErrDecode:e=Jx.res.getString("resid-oneup-errorMediaErrDecode");break;case b.mediaErrSrcNotSupported:e=Jx.res.getString("resid-oneup-errorMediaErrSrcNotSupported")}a.innerHTML=k+"<br>"+e}})}catch(f){Jx.log.warning("_createErrorElement: Failed to retrieve object for: "+e);a.innerText=Jx.res.getString("residFailedThumbnailText")}return a};a._showErrorElementForItem=function(a,d){var e=a.gridDiv,c=a.itemDiv;if(c){c.msContentZoomFactor=1;var b=new PhotoViewer.OneUpRenderInfo;b.errorStatus=d;this._swapRenderedItemForObjectId(b,a);this.getCurrentPage()===this._getPageForItemInfo(a)&&this._progressBar.suppressProgressBarIfNecessary()}};a._doProgressiveLoad=function(b,a){var j=b.itemDiv,d=b.gridDiv,c=b.objectId,e=d.firstElementChild;if(b.inTransition){var g=new PhotoViewer.TransitionItemInfo;g.itemDiv=j;g.gridDiv=d;g.htmlMediaElement=a;this._newTransitionInfo[c]=g;return}var h=new PhotoViewer.OneUpViewItemInfo(a,c,b.itemType),f=this;function i(){d===e.parentNode&&d.removeChild(e)}function n(){if(f._isInDOM(a))if(j.getAttribute("aria-hidden")!=="true"){b.inTransition=true;WinJS.UI.Animation.fadeOut(e).done(function(){p()})}else{i();f._checkInitialViewRenderComplete(c)}else i();b.waitingForImageLoad=false}function k(){a.removeEventListener("load",m,false);a.removeEventListener("error",l,false)}function m(){k();Jx.removeClass(a,s);n()}function l(){k()}function p(){i();b.inTransition=false;var g=f._newTransitionInfo[c];if(g){j=g.itemDiv;d=g.gridDiv;a=g.htmlMediaElement;h=new PhotoViewer.OneUpViewItemInfo(g.htmlMediaElement,c,b.itemType);e=d.firstElementChild;if(f._isInDOM(e)){delete f._newTransitionInfo[c];o()}}else f._checkInitialViewRenderComplete(c)}function o(){if(e){d.insertBefore(a,e);if(h.isVideo()||h.isLoaded()||h.isError())n();else{b.waitingForImageLoad=true;Jx.addClass(a,s);a.addEventListener("load",m,false);a.addEventListener("error",l,false)}}else{d.appendChild(a);f._checkInitialViewRenderComplete(c)}}o()};a._swapHtmlElements=function(a,d){var f=a.itemDiv,c=a.gridDiv;if(a.waitingForImageLoad){for(var b=c.firstChild;b;){var e=b.nextSibling;Jx.hasClass(b,s)&&c.removeChild(b);b=e}a.waitingForImageLoad=false}a.mediaElement=d;if(c.firstElementChild)this._doProgressiveLoad(a,d);else{c.appendChild(d);this._checkInitialViewRenderComplete(a.objectId)}};a._checkInitialViewRenderComplete=function(b){if(!this.isInitialized()){Jx.log.warning("_checkInitialViewRenderComplete: Async callback after uninitialized.");return}var a=this.getViewItemInfoForCurrentPage();if(a&&a.objectId===b&&this._hasItemFinishedInitialRender(a)){Jx.raiseEvent(this,q.Events.initialViewRenderComplete);if(!this._firedItemFullyLoadedEvent&&a.isFullyLoaded()){this._firedItemFullyLoadedEvent=true;PhotoViewer.log.perf("evPhotoViewerOneUp_ItemFullyLoadedOnIterate",{emptyValue:true})}}};a._hasItemFinishedInitialRender=function(a){if(a&&(a.isError()||a.isFullyLoaded()||a.isVideo()&&a.mediaElement&&a.mediaElement.thumbnailCurrentQuality!==c.lowQualityBetterPending)){var b=this.getAllMediaElementsForObjectId(a.objectId);if(b&&b.length===1)return true}return false};a._pageVisibilityChangedCallback=function(b){var f=b.target,g=f.children.length;if(g>0){var c=this._getItemDivFromWrapperElement(f);if(c){var a=e(c),h=a.objectId,d=b.detail.visible;if(d)this._resizeToken>a.resizeToken&&this._sizeItem(a,a.mediaElement);c.setAttribute("aria-hidden",d?"false":"true");this._callback.itemVisibilityChanged(a,d,b)}}};a._setUpOpticalZoomForItem=function(a,b){if(b){if(a.zoomEventAdded){Jx.removeClass(a.itemDiv,"oneUp-zoomElement");a.itemDiv.removeEventListener("MSContentZoom",this._onMSContentZoom,true);a.itemDiv.removeEventListener("MSManipulationStateChanged",this._onManipulationStateChanged,true);a.setZoomMode(f.none);a.zoomEventAdded=false}}else if(!a.zoomEventAdded){Jx.addClass(a.itemDiv,"oneUp-zoomElement");a.itemDiv.addEventListener("MSContentZoom",this._onMSContentZoom,true);a.itemDiv.addEventListener("MSManipulationStateChanged",this._onManipulationStateChanged,true);a.setZoomMode(f.determineBehavior);a.zoomEventAdded=true;this._handleMSContentZoom(a,true)}};a._pageCompletedCallback=function(f){if(!this.isInitialized())return;this._firedItemFullyLoadedEvent=false;this._resizePrevCurNext();var j=this.getCurrentPage();Jx.log.info("OneUpView::_pageCompletedCallback currentPage: "+String(j));var h=f.target,c=this._getItemDivFromWrapperElement(h),a;if(c)a=e(c);if(a){var b=a.objectId;this._currentPageItemDiv!==c&&this._cleanUpCurrentPage();this._currentPageItemDiv=c;h.setAttribute("aria-labelledby",this._getMediaElementDomId(b));this._controller.updateCurrentItemInfo(b);this._dataAdaptor.setActiveItem(b);this._setPriorityRange(a);this._callback.pageCompleted(a,f);Jx.log.info("OneUpView -- item page: "+String(j)+" -- isFullyLoaded: "+String(a.isFullyLoaded())+" isError: "+String(a.isError()));if(a.isFullyLoaded())this._progressBar.suppressProgressBarIfNecessary();else if(!a.isError())this._progressBar.scheduleProgressBarIfNecessary();else this._progressBar.suppressProgressBarIfNecessary();this._checkLoadVideo();var k=a.isVideo(),g=this._mode===PhotoViewer.OneUpViewMode.slideshow;this._setUpOpticalZoomForItem(a,false);var d=a.mediaElement;if(d)if(k){if(!this._videoScrubberControl){this._videoScrubberContainer=document.getElementById(y);this._videoScrubberControl=new PhotoViewer.VideoScrubber(this._videoScrubberContainer,this._controller.coordinator)}var i=this._dataAdaptor.objectIdToObject(b),l=i?i.sourceType!==u.device:true;this._videoScrubberControl.updateCurrentVideoElementNotifications(d,l);this._videoScrubberControl.enabled=!g}else if(this._videoScrubberControl){this._videoScrubberControl.teardownMediaElement();this._videoScrubberControl.enabled=false}if(!k&&!g){var m=this._ensureZoomButtons();m.enabled=true}this._updateZoomButtonsStateIfVisible();this._checkInitialViewRenderComplete(b)}};a._onSlideshowPointerDown=function(){this._callback.slideshowPointerDown.apply(this._callback,arguments)};a._onResize=function(){this._resizeToken++;this._resizePrevCurNext()};a._resizePrevCurNext=function(){for(var c=this.getCurrentPage(),e=Math.max(c-1,0),d=Math.max(c+1,this._dataAdaptor.count),a,b=e;b<=d;b++){a=this.getViewItemInfoForPage(b);Boolean(a)&&this._resizeToken>a.resizeToken&&this._sizeItem(a,a.mediaElement)}};a._addEventListeners=function(){var c=this._flipView;c.addEventListener("pagevisibilitychanged",this._pageVisibilityChangedCallback,false);c.addEventListener("pagecompleted",this._pageCompletedCallback,false);var d=this._slideshowInputDiv;d.addEventListener("MSPointerDown",this._onSlideshowPointerDown,false);var b=this._componentDiv;b.attachEvent("onresize",this._onResize);var a=this._flipViewContainer;if(a){a.addEventListener("MSPointerDown",this._onMSPointerDown,false);a.addEventListener("MSGestureTap",this._onMSGestureTap,false)}window.addEventListener("keydown",this._onKeyDown,true);window.addEventListener("keyup",this._onKeyUp,false);window.addEventListener("blur",this._onBlur,false);b.addEventListener("wheel",this._onMouseWheel,true)};a._removeEventListeners=function(){var c=this._flipView;if(c){c.removeEventListener("pagevisibilitychanged",this._pageVisibilityChangedCallback,false);c.removeEventListener("pagecompleted",this._pageCompletedCallback,false)}var d=this._slideshowInputDiv;d&&d.removeEventListener("MSPointerDown",this._onSlideshowPointerDown,false);var b=this._componentDiv;b&&b.detachEvent("onresize",this._onResize);var a=this._flipViewContainer;if(a){a.removeEventListener("MSPointerDown",this._onMSPointerDown,false);a.removeEventListener("MSGestureTap",this._onMSGestureTap,false)}window.removeEventListener("keydown",this._onKeyDown,true);window.removeEventListener("keyup",this._onKeyUp,false);window.removeEventListener("blur",this._onBlur,false);b.removeEventListener("wheel",this._onMouseWheel,true)};a._onKeyDown=function(a){this._callback.keyDown(a)};a._onKeyUp=function(a){this._callback.keyUp(a)};a._onBlur=function(a){this._callback.onBlur(a)};a._onMouseWheel=function(a){this._callback.mouseWheel(a)};a._isInDOM=function(a){if(a){while(a.parentNode)a=a.parentNode;return a.nodeType===Node.DOCUMENT_NODE}return false};a._getDivZoomFactor=function(a){return Boolean(a)&&Boolean(a.msContentZoomFactor)?a.msContentZoomFactor:i};a._onMSPointerDown=function(c){var b=c.target;if(Jx.hasClass(b,"win-navbutton"))return;var a=this._tapGesture,d=c.pointerType;if(!a||this._tapGesturePointerType!==d){a=this._tapGesture=new MSGesture;this._tapGesturePointerType=d}if(a.target!==b){a.stop();a.target=b}try{a.addPointer(c.pointerId)}catch(e){}};a._onMSGestureTap=function(a){this._handleTap(a.target)};a._handleTap=function(a){if(Boolean(a)&&a.nodeName==="BUTTON")return;this._controller.showAppBars(true);this._showVideoScrubber()};a._onManipulationStateChanged=function(c){var d=c.target,f=d.msContentZoomFactor,b=e(d),i=b.objectId,a=c.currentState,h=c.lastState;b.manipulationState=a;(a===g.inertia||a===g.rest)&&this._handleMSContentZoom(b,true)};var z=function(b,j,d,h,f){var a,c,e=b/f,i=b/d,g=Math.floor((h-b)/2);if(f<i){a=g+Math.floor((b-e)/2);c=a}else{a=g+Math.floor((b-d)/2);c=a+d-e}a=Math.round(a);c=Math.round(c);a=Math.max(0,a-1);return{low:a,high:c}};a._onMSContentZoom=function(a){if(!this._isInitialized)return;var b=e(a.target);this._handleMSContentZoom(b,false)};a._handleMSContentZoom=function(a,k){var c=a.itemDiv,b=c.msContentZoomFactor;if(!this._isActivated)return;if(!k&&b===a.zoomFactor)return;if(a.zoomMode===f.sezo)return;this._updateZoomButtonsStateIfVisible();a.zoomFactor=b;var x=a.objectId,j=a.mediaElement,w=j.offsetWidth,v=j.offsetHeight,p=a.gridDiv,n=p.offsetWidth,l=p.offsetHeight,u=this._flipViewContainer.offsetWidth,t=this._flipViewContainer.offsetHeight,o=c.offsetWidth,m=c.offsetHeight;if(n===0||l===0||o===0||m===0)return;if((k||a.manipulationState===g.manipulating)&&a.zoomMode===f.determineBehavior){if(b>K&&a.itemType==="asset.photo"&&!a.isError())a.setZoomMode(f.oz);else if(b<I&&Boolean(this._controller)&&this._controller.canZoomOutOfOneUp()){a.setZoomMode(f.sezo);var h=String(b*100)+"%",q=h+" "+h;a.itemDiv.style.msContentZoomLimit=q;this._animateModeTransition(a)}}else if(a.manipulationState===g.rest&&a.zoomMode===f.oz)b===i&&a.setZoomMode(f.determineBehavior);var s=a.manipulationState!==g.manipulating||a.zoomMode===f.sezo;if(s){var d=z(u,o,w,n,b),e=z(t,m,v,l,b),r=!a.cachedScrollLimitsX||a.cachedScrollLimitsX.low!==d.low||a.cachedScrollLimitsX.high!==d.high||!a.cachedScrollLimitsY||a.cachedScrollLimitsY.low!==e.low||a.cachedScrollLimitsY.high!==e.high;if(r){c.style["-ms-scroll-limit-y-min"]=String(e.low)+"px";c.style["-ms-scroll-limit-x-max"]=String(d.high)+"px";c.style["-ms-scroll-limit-y-max"]=String(e.high)+"px";c.style["-ms-scroll-limit-x-min"]=String(d.low)+"px";a.cachedScrollLimitsX=d;a.cachedScrollLimitsY=e}}};a._animateModeTransition=function(a){if(Boolean(a)&&Boolean(a.gridDiv)){var b=this;WinJS.UI.Animation.fadeOut(a.gridDiv).done(function(){b.isInitialized()&&b._controller.zoomOutOfOneUp()})}};a._handleKeyboardOrMouseZoom=function(f){var a=this._currentPageItemDiv;if(a){var d=e(a),b=this._getDivZoomFactor(a),c=b;if(f){if(b<=i){this._controller.zoomOutOfOneUp();return}c=b-r}else c=b+r;this._setUpOpticalZoomForItem(d,false);a.msContentZoomFactor=c;this._handleMSContentZoom(d,true)}};a._handleKeyboardOrMousePan=function(c,d){var a=this._currentPageItemDiv;if(a){var b=this._getDivZoomFactor(a);if(b!==i){a.scrollTop=a.scrollTop+d/b;a.scrollLeft=a.scrollLeft+c/b;return true}}return false};a._shouldAllowDoubleClick=function(){return false};a._goToMaxZoomLevel=function(){};a._log=function(b,a){if(!Jx.isValidNumber(a))a=LoggingCategory.logNothing;(this._loggingCategories===LoggingCategory.logEverything||(this._loggingCategories&a)>0)&&Jx.log.info("OneUpView::"+b)};a._singleItemInserted=function(a){if(this._contentDataAdaptor)this._flipView&&this._switchFlipViewDataSource(a)};a._singleItemRemoved=function(){if(this._contentDataAdaptor)this._flipView&&this._switchFlipViewDataSource(0)};a._switchFlipViewDataSource=function(a){this._dataAdaptor=this._contentDataAdaptor;this._flipView.itemDataSource=new PhotoViewer.VirtualizedDataSource(this._dataAdaptor);this._flipView.currentPage=a;this._prefetcher&&this._prefetcher.setDataAdaptor(this._dataAdaptor);this._contentDataAdaptor=null};a._allItemsRemoved=function(){var a=this;WinJS.Promise.timeout(0).done(function(){a._controller.navigateBackFromOneUp()})};a._setPriorityRange=function(b){if(!this._contentDataAdaptor&&this._controller.mode!==PhotoViewer.Coordinator.Mode.openWith){var c=this._getPageForItemInfo(b),a=Math.max(c-A,0);this._dataAdaptor.setPriorityRange(a,A*2+1)}};a._showVideoScrubber=function(){if(this._videoScrubberControl)this._videoScrubberControl.enabled&&this._videoScrubberControl.showVideoScrubber()};a._videoContextMenuReplacement=function(){if(this.isInitialized()){this._controller.showAppBars(false);this._showVideoScrubber()}return false};a._ensureZoomButtons=function(){var a=this._zoomButtons;if(!a){var b=this;a=this._zoomButtons=new o(this._flipViewContainer,function(){b._handleKeyboardOrMouseZoom(true)},function(){b._handleKeyboardOrMouseZoom(false)},this._updateZoomButtonsState.bind(this),H,false)}return a};a._updateZoomButtonsState=function(){var f=this._zoomButtons,d=this._currentPageItemDiv;if(d){var h=e(d),c=false,a=false;if(h.isVideo())a=this._controller.canZoomOutOfOneUp();else{var g=this._getDivZoomFactor(d);if(g===i){a=this._controller.canZoomOutOfOneUp();c=true}else{c=g+r<=P;a=true}}var b;if(c&&a)b=o.State.both;else if(c)b=o.State.zoomInOnly;else if(a)b=o.State.zoomOutOnly;if(Jx.isString(b))f.setState(b);else f.enabled=false}else Jx.log.warning("OneUpView._updateZoomButtonsState: no current item div available; leaving state as-is")};a._updateZoomButtonsStateIfVisible=function(){var a=this._zoomButtons;a&&a.visible&&this._updateZoomButtonsState()};a._flipView=null;a._flipViewContainer=null;a._flipViewScrollingElement=null;a._pzKBAndMouseHandler=null;a._currentPageItemDiv=null;a._dataAdaptor=null;a._contentDataAdaptor=null;a._mode=PhotoViewer.OneUpViewMode.none;a._callback=null;a._resizeToken=0;a._prefetcher=null;a._componentDiv=null;a._enterExitDiv=null;a._slideshowInputDiv=null;a._setAsOverlayDiv=null;a._setAsOverlayText=null;a._controller=null;a._imgCache=null;a._isInitialized=false;a._isActivated=false;a._newTransitionInfo=null;a._dataAdaptorCallback=null;a._convertPixelsPhysicalToLogicalCallback=null;a._progressBar=null;a._videoScrubberControl=null;a._videoScrubberContainer=null;a._zoomButtons=null;a._tapGesture=null;a._tapGesturePointerType=0;a._firedItemFullyLoadedEvent=true;a._loadListeners=null})();(function(){var b=window.PhotoViewer;b.OneUpViewPrefetcher=function(b,a){this._dataAdaptor=b;this._itemsRenderer=a};var a=b.OneUpViewPrefetcher.prototype;a.prefetchItem=function(b){var a=this._dataAdaptor.objectIdToIndex(b);Jx.isValidNumber(a)&&this.prefetchItemForPage(a)};a.prefetchItemForPage=function(b){var d=this._dataAdaptor.count;if(Jx.isValidNumber(b)&&b<d)try{var c=this._dataAdaptor.indexToObjectId(b);this._prefetchObjectId=c;this._prefetchElement=null;var a=this;this._dataAdaptor.itemsFromIndex(b,0,0).then(function(f){var d=f.items;if(d.length===1){var e=d[0];if(a._prefetchObjectId===c){a._reentrant=true;e.index=b;try{a._prefetchElement=a._itemsRenderer(e)}catch(g){a._prefetchObjectId=null;Jx.promoteOriginalStack(g);throw g}finally{a._reentrant=false}}}})}catch(e){this._prefetchElement=null;this._prefetchObjectId=null;this._reentrant=false}};a.getPrefetchedItem=function(a){return this._reentrant?null:Boolean(this._prefetchObjectId)&&a===this._prefetchObjectId?this._prefetchElement:null};a.clearPrefetchedItem=function(a){if(this._reentrant)return;if(Boolean(this._prefetchObjectId)&&a===this._prefetchObjectId){this._prefetchElement=null;this._prefetchObjectId=null}};a.setDataAdaptor=function(a){this._dataAdaptor=a};a._dataAdaptor=null;a._itemsRenderer=null;a._reentrant=false;a._prefetchObjectId=null;a._prefetchElement=null})();(function(){var b=window.PhotoViewer;b.OneUpBehaviorNotificationProxy=function(a){this.currentBehavior=null;this._controller=a};var a=b.OneUpBehaviorNotificationProxy.prototype;a.slideshowPointerDown=function(){this._callbackEventDispatcher("slideshowPointerDown",arguments)};a.itemVisibilityChanged=function(){this._callbackEventDispatcher("itemVisibilityChanged",arguments)};a.pageCompleted=function(){this._callbackEventDispatcher("pageCompleted",arguments)};a.keyDown=function(){this._callbackEventDispatcher("keyDown",arguments)};a.keyUp=function(){this._callbackEventDispatcher("keyUp",arguments)};a.onBlur=function(){this._callbackEventDispatcher("onBlur",arguments)};a.mouseWheel=function(){this._callbackEventDispatcher("mouseWheel",arguments)};a.videoCanPlayThrough=function(){this._callbackEventDispatcher("videoCanPlayThrough",arguments)};a.videoEnded=function(){this._callbackEventDispatcher("videoEnded",arguments)};a.videoPlay=function(){this._callbackEventDispatcher("videoPlay",arguments)};a.videoPause=function(){this._callbackEventDispatcher("videoPause",arguments)};a.videoSeeked=function(){this._callbackEventDispatcher("videoSeeked",arguments)};a.videoError=function(){this._callbackEventDispatcher("videoError",arguments)};a.imageLoad=function(){this._callbackEventDispatcher("imageLoad",arguments)};a.imageError=function(){this._callbackEventDispatcher("imageError",arguments)};a._callbackEventDispatcher=function(a,b){this._controller[a]&&this._controller[a].apply(this._controller,b);this.currentBehavior&&this.currentBehavior[a]&&this.currentBehavior[a].apply(this.currentBehavior,b)};a.currentBehavior=null;a._controller=null})();(function(){var b=window.PhotoViewer;b.OneUpControllerBehaviorBase=function(){};var a=b.OneUpControllerBehaviorBase.prototype;a.enable=function(){this._enabled=true};a.disable=function(){this._enabled=false};a._controller=null;a._enabled=false})();(function(){var c=0,d={firstItem:2e3,nextItem:4e3},e=1e3,b=window.PhotoViewer;b.OneUpSlideshowBehavior=function(a,b){this._dataAdaptor=a;this._controller=b};Jx.augment(b.OneUpSlideshowBehavior,b.OneUpControllerBehaviorBase);var a=b.OneUpSlideshowBehavior.prototype;a.enable=function(a){this._options=a;if(Boolean(a)&&a.delayInitUntilInitialPageCompleted)return;b.OneUpControllerBehaviorBase.prototype.enable.call(this,a);this._enabledTime=Date.now();this._cachedIndexNotificationHelper=new PhotoViewer.CachedIndexNotificationHelper(this,this._dataAdaptor);var d=this._controller.getView();this._waitingForVisibiltyChangeEventToContinue=false;this._slideshowWrappedAround=false;this._startingPage=d.getCurrentPage();this._nextPage=this._startingPage;this._setNextPageVal();this._displayRequest=new Windows.System.Display.DisplayRequest;this._displayRequest.requestActive();var c=this,e=function(){var a=d.getViewItemInfoForCurrentPage();if(a){a.isLoaded()&&c._continueSlideshowAfterInitialItemLoad();c._nextPage===0&&c._getViewPrefetcher().prefetchItemForPage(c._nextPage)}b.log.perf("evPhotoViewerSlideshow_Launch_end",{emptyValue:true})};if(Boolean(a)&&a.skipInitialTransition)e();else d.playEnterExitTransition(e)};a.disable=function(){b.OneUpControllerBehaviorBase.prototype.disable.call(this);if(this._displayRequest){this._displayRequest.requestRelease();this._displayRequest=null}this._clearIterateTimer();var c=this._controller.getView(),a=c.getViewItemInfoForCurrentPage();Boolean(a)&&a.isVideo()&&a.mediaElement.pause();this._cachedIndexNotificationHelper.shutdown();this._cachedIndexNotificationHelper=null};a.slideshowPointerDown=function(){if(!this._hasPassedEnabledTimeThreshold())return;this._endSlideshow()};a.itemVisibilityChanged=function(a,b){if(b){this._waitingForVisibiltyChangeEventToContinue=false;this._continueSlideshow(a);this._getViewPrefetcher().clearPrefetchedItem(a.objectId)}};a.pageCompleted=function(a){Jx.log.info("OneUpSlideshowBehavior::pageCompleted");var b=this._options;if(Boolean(b)&&b.delayInitUntilInitialPageCompleted){b.delayInitUntilInitialPageCompleted=false;this.enable(b)}var c=a.mediaElement;if(c)if(a.isVideo()&&a.isFullyLoaded())c.paused&&!c.ended&&a.mediaElement.play()};a.keyDown=function(a){this._tryEndSlideshow(a)};a.keyUp=function(a){this._tryEndSlideshow(a)};a.mouseWheel=function(){this._endSlideshow()};a.onBlur=function(){this._endSlideshow()};a.slideshowDisablingCharmInvoked=function(){this._endSlideshow()};a.videoCanPlayThrough=function(b){var a=b.getPage(this._dataAdaptor);if(a===this._nextPage)this._tryIterateToNextItem();else a===this._controller.getView().getCurrentPage()&&this._continueSlideshowAfterInitialItemLoad()};a.videoEnded=function(){this._tryIterateToNextItem()};a.videoPlay=function(){};a.videoPause=function(){};a.videoError=function(b,a){this._handleErrorEvent(b,a)};a.imageLoad=function(a){var b=a.getPage(this._dataAdaptor);Jx.log.info("OneUpSlideshowBehavior::imageLoad received image load event for object: "+a.objectId+" (page: "+String(b)+")");if(a.isFullyLoaded())if(b===this._nextPage)this._tryIterateToNextItem();else b===this._controller.getView().getCurrentPage()&&this._continueSlideshowAfterInitialItemLoad()};a.imageError=function(b,a){this._handleErrorEvent(b,a)};a.getIndicesToUpdateAfterNotificationsCompleted=function(){var a=[];a.push({originalIndex:this._startingPage,updatedIndex:null});a.push({originalIndex:this._nextPage,updatedIndex:null});return a};a.updateIndicesAfterNotifications=function(){var a=this._cachedIndexNotificationHelper;if(a.invalidateAllOccurred){this._endSlideshow();return}var c=a.indicesToUpdate,b=c[0];if(b)this._startingPage=b.updatedIndex;var d=c[1];if(d)this._nextPage=d.updatedIndex;(a.removesOccurred||a.addsOccurred)&&this._tryIterateToNextItem()};a._tryEndSlideshow=function(a){if(!this._hasPassedEnabledTimeThreshold())return;switch(a.key){case"VolumeUp":case"VolumeDown":case"VolumeMute":break;default:this._endSlideshow()}};a._handleErrorEvent=function(a){var b=a.getPage(this._dataAdaptor);b===this._nextPage&&this._skipMediaErrors()};a._continueSlideshowAfterInitialItemLoad=function(){Jx.log.info("OneUpSlideshowBehavior::_continueSlideshowAfterInitialItemLoad");var c=this._controller.getView(),a=c.getViewItemInfoForCurrentPage(),b=Boolean(this._options)&&this._options.useNextItemIterateDelayForFirstItem?d.nextItem:d.firstItem;if(a.isError()||a.isImage())this._setIterateTimer(b);else if(a.isVideo())if(a.mediaElement.ended)this._setIterateTimer(b);else a.mediaElement.play()};a._skipMediaErrors=function(){var b=this._controller.getView(),a=b.getViewItemInfoForPage(this._nextPage);if(!a||a.isError())for(;;){if(this._nextPage===0)this._slideshowWrappedAround=true;this._setNextPageVal();if(this._slideshowWrappedAround&&this._nextPage>=this._startingPage){this._endSlideshow();break}a=b.getViewItemInfoForPage(this._nextPage);if(!a||!a.mediaElement){this._getViewPrefetcher().prefetchItemForPage(this._nextPage);break}else if(a.isFullyLoaded()){this._tryIterateToNextItem();break}else if(!a.isError())break}};a._setNextPageVal=function(){this._nextPage=this._nextPage+1;if(this._nextPage>=this._dataAdaptor.count)this._nextPage=0};a._tryIterateToNextItem=function(){if(!this._enabled)return;Jx.log.info("OneUpSlideshowBehavior::_tryIterateToNextItem");var e=this._controller.getView(),i=e.getCurrentPage(),d=e.getViewItemInfoForPage(i),b=false;if(!d)b=true;else if(d.isImage()&&this._iterateTimerId===c&&d.isFullyLoaded()&&!this._waitingForVisibiltyChangeEventToContinue)b=true;else if(d.isVideo()&&this._controller.hasCurrentItemEnded()&&!this._waitingForVisibiltyChangeEventToContinue)b=true;else if(d.isError())b=true;var f=this._nextPage,a=e.getViewItemInfoForPage(f),h=false,g=false;if(a){if(a.isFullyLoaded()||a.mediaUnloaded)h=true;else if(a.isError())g=true}else g=true;Jx.log.info("OneUpSlideshowBehavior::_tryIterateToNextItem currentPage: "+d.objectId+"  currentElementDone: "+String(b));Jx.log.info("OneUpSlideshowBehavior::_tryIterateToNextItem nextPage: "+(a?a.objectId:"??")+"  nextElementReady: "+String(h));if(b)if(h){if(f===0)this._slideshowWrappedAround=true;if(f!==i+1){e.setCurrentPage(f);this._continueSlideshow(a)}else{e.iterateNext();this._continueSlideshow(a)}this._setNextPageVal();this._nextPage===0&&this._getViewPrefetcher().prefetchItemForPage(this._nextPage)}else g&&this._skipMediaErrors()};a._continueSlideshow=function(a){if(!this._enabled)return;if(a.mediaElement)if(a.isVideo()&&a.isFullyLoaded())a.mediaElement.play();else a.isImage()&&a.isFullyLoaded()&&this._iterateTimerId===c&&this._setIterateTimer(d.nextItem)};a._endSlideshow=function(){if(this._enabled){b.log.perf("evPhotoViewerSlideshow_Exit_begin",{emptyValue:true});var c=this._controller.getView(),a=c.getViewItemInfoForCurrentPage();if(a)if(a.isVideo()){a.mediaElement.pause();this._clearIterateTimer()}else a.isImage()&&this._clearIterateTimer();this._controller.changeMode(b.OneUpViewMode.oneUpViewer);b.log.perf("evPhotoViewerSlideshow_Exit_end",{emptyValue:true})}};a._setIterateTimer=function(a){var b=this;if(this._iterateTimerId===c){if(!this._iterateTimerHandler)this._iterateTimerHandler=function(){b._iterateTimerFired()};this._iterateTimerId=window.setTimeout(this._iterateTimerHandler,a);Jx.log.info("OneUpSlideshowBehavior::_setIterateTimer set new timer.")}};a._clearIterateTimer=function(){if(this._iterateTimerId!==c){window.clearTimeout(this._iterateTimerId);this._iterateTimerId=c;Jx.log.info("OneUpSlideshowBehavior::_clearIterateTimer cleared timer.")}};a._iterateTimerFired=function(){Jx.log.info("OneUpSlideshowBehavior::_iterateTimerFired");this._iterateTimerId=c;this._enabled&&this._tryIterateToNextItem()};a._getViewPrefetcher=function(){return this._controller.getView().getPrefetcher()};a._hasPassedEnabledTimeThreshold=function(){var a=Date.now();return a-this._enabledTime>e?true:false};a._dataAdaptor=null;a._controller=null;a._iterateTimerHandler=null;a._waitingForVisibiltyChangeEventToContinue=false;a._slideshowWrappedAround=false;a._startingPage=-1;a._nextPage=-1;a._iterateTimerId=c;a._options=null;a._displayRequest=null;a._enabledTime=0;a._cachedIndexNotificationHelper=null})();(function(){var b=window.PhotoViewer,c=200,d=120;b.OneUpViewerBehavior=function(a,b){this._dataAdaptor=a;this._controller=b};Jx.augment(b.OneUpViewerBehavior,b.OneUpControllerBehaviorBase);var a=b.OneUpViewerBehavior.prototype;a.itemVisibilityChanged=function(a,b){if(a.isVideo())!b&&a.mediaElement.pause()};a.pageCompleted=function(b){if(b.isVideo()&&b.isFullyLoaded()){var a=b.mediaElement;(a.paused||a.ended)&&a.play()}};a.videoCanPlayThrough=function(a){if(a.isVideo()){var c=a.getPage(this._dataAdaptor);if(this._controller.getView().getCurrentPage()===c){var b=a.mediaElement;b.play()}}};a.keyUp=function(b){if(this._enabled){var a,c=WinJS.Utilities.Key,f=true,h=b.key,e=this._controller.getView();if(!e)return;switch(b.keyCode){case c.home:a=this._dataAdaptor.count;a>0&&e.setCurrentPage(0);break;case c.end:a=this._dataAdaptor.count;a>0&&e.setCurrentPage(a-1);break;case c.escape:this._controller.navigateBackFromOneUp();break;case c.p:b.ctrlKey&&!b.shiftKey&&this._playPauseKeyboardShortcutHelper();break;default:f=false}if(!f)switch(h){case"MediaPlayPause":this._playPauseKeyboardShortcutHelper();break;case"MediaStop":var d=this._controller.getView().getViewItemInfoForCurrentPage();if(Boolean(d)&&Boolean(d.isVideo())){var g=d.mediaElement;g.pause()}}}};a.mouseWheel=function(a){if(!a.ctrlKey&&!a.shiftKey){var b=Date.now(),e=this._controller.getView();if(Boolean(e)&&!e.isCurrentItemZoomed()){if(b-this._timeOfLastMouseWheelEvent>c)this._accumulatedMouseWheelDelta=0;this._timeOfLastMouseWheelEvent=b;this._accumulatedMouseWheelDelta-=a.deltaY;var f=this._accumulatedMouseWheelDelta;if(Math.abs(f)>=d&&b-this._timeOfLastMouseWheelIterate>c){this._timeOfLastMouseWheelIterate=b;var g=f>0;this._accumulatedMouseWheelDelta=f%d;if(g)e.iteratePrevious();else e.iterateNext()}}a.preventDefault()}};a._playPauseKeyboardShortcutHelper=function(){var b=this._controller.getView().getViewItemInfoForCurrentPage();if(Boolean(b)&&Boolean(b.isVideo())){var a=b.mediaElement;if(a.paused||a.ended)a.play();else a.pause()}};a._dataAdaptor=null;a._controller=null;a._timeOfLastMouseWheelEvent=0;a._timeOfLastMouseWheelIterate=0;a._accumulatedMouseWheelDelta=0})();(function(){var b=window.PhotoViewer,c=b.AppBar.Commands;b.OneUpComponent=function(a,c){this.initComponent();this._site=a;this._controller=new b.OneUpController(this,c,a)};Jx.augment(b.OneUpComponent,Jx.Component);var a=b.OneUpComponent.prototype;a.preDeactivateUI=function(){this._controller.beginShutdown()};a.postActivateUI=function(){this._controller.postActivateUI()};a.deactivateUI=function(){this._controller.shutdown();this._active=false;Jx.Component.prototype.deactivateUI.call(this)};a.getUI=function(a){this._controller.getMainViewUI(this._id,a)};a.activateUI=function(){Jx.Component.prototype.activateUI.call(this);this._controller.activateUI(this._initParams);this._initParams=null;this._active=true};a.setInitializationParameters=function(b){this._initParams=b;if(this._active){var a=this._controller;if(Boolean(b)&&Boolean(b.container)){a.beginShutdown();a.shutdown();a.initializeUI(b,b.container,-1,null);a.postActivateUI()}else{var c=PhotoViewer.Coordinator.Mode;switch(b.mode){case c.oneUp:case c.openWith:a.switchToViewMode(PhotoViewer.OneUpViewMode.oneUpViewer);break;case c.slideshow:a.switchToViewMode(PhotoViewer.OneUpViewMode.slideshow)}}}};a.onFinishedLaunching=function(){return this._controller.onRenderComplete()};a.slideshowDisablingCharmInvoked=function(){this._controller.slideshowDisablingCharmInvoked()};a.getEntranceAnimationInfo=function(){return this._controller.getEntranceAnimationInfo()};a.getExitAnimationInfo=function(){return this._controller.getExitAnimationInfo()};a.changeMode=function(a){switch(a){case PhotoViewer.OneUpViewMode.slideshow:this._site.doCommand(c.launchSlideshow,WindowsLive.Photo.Viewer.Commanding.CommandSurface.canvas,null,null);break;case PhotoViewer.OneUpViewMode.oneUpViewer:this._site.doCommand(c.launchOneUp,WindowsLive.Photo.Viewer.Commanding.CommandSurface.canvas,null,null)}};a.getNavId=function(){return"OneUp"};a.getNavState=function(){return this._controller?this._controller.getNavState():null};a.setNavState=function(a,b){return!a?WinJS.Promise.wrap(true):this._controller?this._controller.setNavState(a,b):WinJS.Promise.wrap(false)};a.clearNavState=function(){this._controller&&this._controller.clearNavState()};a.isActive=function(){return this._active};Object.defineProperty(a,"coordinator",{"get":function(){return this._site}});Object.defineProperty(a,"id",{"get":function(){return this._id}});a._site=null;a._controller=null;a._active=false;a._initParams=null})();(function(){PhotoViewer.OneUpViewChangeNotificationHelper=function(c,b,a,d){this._singleItemSite=c;this._allItemsRemovedSite=b;this._dataAdaptor=a;this._singleItemObjectId=d;a.setNotificationHandler(this)};var a=PhotoViewer.OneUpViewChangeNotificationHelper.prototype;a.shutdown=function(){this._dataAdaptor.removeNotificationHandler(this);this._dataAdaptor=null;this._singleItemSite=null;this._allItemsRemovedSite=null};a.beginNotifications=function(){this._inBatch=true};a.endNotifications=function(){if(this._allItemsRemoved)this._dataAdaptor.count===0&&this._notifyAllItemsRemoved();if(this._itemRemoved)this._notifySiteItemRemoved();else this._itemInserted&&this._notifySiteItemInserted(this._itemInsertedIndex);this._inBatch=false;this._itemRemoved=false;this._itemInserted=false;this._allItemsRemoved=false};a.invalidateAll=function(){if(this._singleItemObjectId){var a=this._dataAdaptor.objectIdToIndex(this._singleItemObjectId);Jx.isValidNumber(a)&&a>=0&&this._notifySiteItemInserted(a)}};a.inserted=function(c,d,e,a){var b=c.key;if(b===this._singleItemObjectId)if(this._inBatch){this._itemInserted=true;this._itemRemoved=false;this._allItemsRemoved=false;this._itemInsertedIndex=a}else this._notifySiteItemInserted(a)};a.changed=function(){};a.removed=function(a){if(this._dataAdaptor.count===0)if(this._inBatch)this._allItemsRemoved=true;else this._notifyAllItemsRemoved();else if(a===this._singleItemObjectId)if(this._inBatch){this._itemRemoved=true;this._itemInserted=false}else this._notifySiteItemRemoved()};a.populationComplete=function(){if(this._dataAdaptor.count===0)if(this._inBatch)this._allItemsRemoved=true;else this._notifyAllItemsRemoved()};a._notifySiteItemInserted=function(a){this._singleItemSite&&this._singleItemSite.singleItemInserted(a)};a._notifySiteItemRemoved=function(){this._singleItemSite&&this._singleItemSite.singleItemRemoved()};a._notifyAllItemsRemoved=function(){this._allItemsRemovedSite&&this._allItemsRemovedSite.allItemsRemoved()};a._singleItemSite=null;a._allItemsRemovedSite=null;a._dataAdaptor=null;a._singleItemObjectId=null;a._inBatch=false;a._itemInserted=false;a._itemInsertedIndex=-1;a._itemRemoved=false;a._allItemsRemoved=false})()