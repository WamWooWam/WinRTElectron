(function(){var b=window.PhotoViewer;b.ImportComponent=function(a){this.initComponent();this._site=a};Jx.augment(b.ImportComponent,Jx.Component);var a=b.ImportComponent.prototype;a.getUI=function(a){this._controller=new b.ImportController(this._site);this._controller.getMainViewUI(this._id,a)};a.activateUI=function(){Jx.res.processAll(document.getElementById(this._id));var a=this._initParams.additionalData;this._controller.activateUI(a.deviceFolder,a.deviceId);Jx.Component.prototype.activateUI.call(this)};a.deactivateUI=function(){if(this._controller){this._controller.shutdown();this._controller=null}Jx.Component.prototype.deactivateUI.call(this)};a.setInitializationParameters=function(a){this._initParams=a};a.getEntranceAnimationInfo=function(){return this._controller.getEntranceAnimationInfo()};a.getExitAnimationInfo=function(){return this._controller.getExitAnimationInfo()};a.isImportInProgress=function(){return this._controller.importModalActive};a.onSuspend=function(){this._controller.onSuspend()};a.onResume=function(){this._controller.onResume()};a._site=null;a._controller=null;a._initParams=null})();(function(){var b=window.PhotoViewer,f=WindowsLive.Photo.Viewer.Commanding,e=b.ViewHelpers,d=200,c=/(\\|\/|:|;|\*|"|<|>|\||\?|^[\s\.]+|[\s\.]+$)/gi,g='\\/:;*"<>|?';b.ImportController=function(a){this._coordinator=a;this._view=new b.ImportView;this._selectionExists=false;this._deferredIndicesToAddToSelection=[];this._onViewSelectionChanged=this._onViewSelectionChanged.bind(this);this._onViewLoadingStateChanged=this._onViewLoadingStateChanged.bind(this);this._onAddNotificationsCompleted=this._onAddNotificationsCompleted.bind(this);this._cancelCommandHandler=this._cancelCommandHandler.bind(this);this._importCommandHandler=this._importCommandHandler.bind(this);this._onFolderInputKeyDown=this._onFolderInputKeyDown.bind(this);this._onFolderInputKeyPress=this._onFolderInputKeyPress.bind(this);this._onFolderInputKeyUp=this._onFolderInputKeyUp.bind(this);this._onFolderInputLoseFocus=this._onFolderInputLoseFocus.bind(this);this._toggleSelection=this._toggleSelection.bind(this);this._onInputPaneUp=this._onInputPaneUp.bind(this);this._onInputPaneDown=this._onInputPaneDown.bind(this);this._onNavigateToImportFolder=this._onNavigateToImportFolder.bind(this);this._onImportStop=this._onImportStop.bind(this);this._onImportComplete=this._onImportComplete.bind(this);this._onImportCollectionChanged=this._onImportCollectionChanged.bind(this)};var a=b.ImportController.prototype;a.getMainViewUI=function(a,b){this._view.getMainViewUI(a,b)};a.activateUI=function(a,c){var d=new WindowsLive.Photo.App.Import.ImportDataProvider(a);this._dataHub=new WindowsLive.Photo.Viewer.DataModel.Hub(d);this._dataHub.contentContainer=this._dataHub.createRootContainer();this._dataAdaptor=new b.ObjectCollectionDSA(this._dataHub,this._dataHub.content);document.getElementById("importDeviceName").innerText=a.displayName;this._importProgressBar=document.getElementById("importEnumerationProgressBar");this._folderNameLabel=document.getElementById("importFolderInputLabel");this._invalidCharacterErrorLabel=document.getElementById("importFolderInputError");this._folderNameInput=document.getElementById("importFolderInputBox");this._folderNameInput.value="";this._folderNameInput.addEventListener("keydown",this._onFolderInputKeyDown,false);this._folderNameInput.addEventListener("keypress",this._onFolderInputKeyPress,false);this._folderNameInput.addEventListener("blur",this._onFolderInputLoseFocus,false);this._folderNameInput.addEventListener("keyup",this._onFolderInputKeyUp,false);this._view.initialize(this._dataAdaptor);this._view.addListViewEventListener("loadingstatechanged",this._onViewLoadingStateChanged);this._view.addListViewEventListener("selectionchanged",this._onViewSelectionChanged);this._selectionCommand=document.getElementById("importSelectionCommand");this._selectionCommand.innerText=Jx.res.getString("resid-import-SelectAll");this._selectionCommand.addEventListener("click",this._toggleSelection,false);this._importElement=document.getElementById("cmdImport");this._importElement.addEventListener("click",this._importCommandHandler,false);this._cancelElement=document.getElementById("cmdImportCancel");this._cancelElement.addEventListener("click",this._cancelCommandHandler,false);this._dataAdaptor.setAddNotificationsCompletedHandler(this._onAddNotificationsCompleted);document.getElementById("importCount").innerText=e.getCountString(0,0);this._selectionCommand.setAttribute("disabled","disabled");this._folderNameInput.setAttribute("disabled","disabled");this._dataHub.executeAsync("SessionInfo","").done(this._onGetSessionInfoCallback.bind(this),function(a){Jx.log.error("Error getting recent date: "+a)});this._updateCommandStates();this._onViewSelectionChanged();this._commandBarElement=document.getElementById("importCommandBar");this._inputPaneHandle=Windows.UI.ViewManagement.InputPane.getForCurrentView();this._inputPaneHandle.addEventListener("showing",this._onInputPaneUp);this._inputPaneHandle.addEventListener("hiding",this._onInputPaneDown);if(c){this._onDeviceRemoved=this._onDeviceRemoved.bind(this);this._currentDeviceId=c;this._deviceWatcher=Windows.Devices.Enumeration.DeviceInformation.createWatcher(Windows.Devices.Portable.StorageDevice.getDeviceSelector(),null);this._deviceWatcher.addEventListener("removed",this._onDeviceRemoved);this._deviceWatcher.start()}if(Windows.UI.ViewManagement.ApplicationView.value===Windows.UI.ViewManagement.ApplicationViewState.snapped){var f=Windows.UI.ViewManagement.ApplicationView.tryUnsnap();Jx.log.info("Tried to unsnap, result: "+String(f))}};a.shutdown=function(){document.body.focus();this._importProgressBar.setAttribute("aria-hidden","true");if(this._deviceWatcher){this._deviceWatcher.stop();this._deviceWatcher.removeEventListener("removed",this._onDeviceRemoved);this._deviceWatcher=null}if(this._importCollection){this._importCollection.removeEventListener("changed",this._onImportCollectionChanged);this._importCollection=null}if(this._importElement){this._importElement.removeEventListener("click",this._importCommandHandler,false);this._importElement=null}if(this._cancelElement){this._cancelElement.removeEventListener("click",this._cancelCommandHandler,false);this._cancelElement=null}if(this._folderNameInput){this._folderNameInput.removeEventListener("keydown",this._onFolderInputKeyDown,false);this._folderNameInput.removeEventListener("keypress",this._onFolderInputKeyPress,false);this._folderNameInput.removeEventListener("keyup",this._onFolderInputKeyUp,false);this._folderNameInput.removeEventListener("blur",this._onFolderInputLoseFocus,false);this._folderNameInput=null}if(this._selectionCommand){this._selectionCommand.removeEventListener("click",this._toggleSelection,false);this._selectionCommand=null}if(this._inputPaneHandle){this._inputPaneHandle.removeEventListener("showing",this._onInputPaneUp);this._inputPaneHandle.removeEventListener("hiding",this._onInputPaneDown);this._inputPaneHandle=null}this._dataAdaptor.removeAddNotificationsCompletedHandler(this._onAddNotificationsCompleted);this._dataAdaptor.deactivate();this._view.removeListViewEventListener("selectionchanged",this._onViewSelectionChanged);this._view.removeListViewEventListener("loadingstatechanged",this._onViewLoadingStateChanged);this._view.shutdown();this._view=null;this._dataAdaptor.shutdown()};a.getEntranceAnimationInfo=function(){return this._view.getEntranceAnimationInfo()};a.getExitAnimationInfo=function(){return this._view.getExitAnimationInfo()};a.onSuspend=function(){return this._dataHub.applicationSuspend()};a.onResume=function(){return this._dataHub.applicationResume()};a._cancelCommandHandler=function(){this._coordinator.doCommand(PhotoViewer.AppBar.Commands.navigateBack,f.CommandSurface.appBar)};a._importCommandHandler=function(){if(this._isKeyboardUp){document.body.focus();window.setTimeout(this._createImportFolder.bind(this),100)}else this._createImportFolder()};a._createImportFolder=function(){if(this._importInProgress)return;this._importInProgress=true;this._onFolderNameChanged(true);var c=this._folderNameInput.value,a=this,b=function(b){a._importInProgress=false;if(b.number===-2147024690)a._onAlbumCreationError("resid-import-albumNameTooLongError");else a._onAlbumCreationError("resid-import-genericAlbumCreationError")};try{Windows.Storage.KnownFolders.picturesLibrary.createFolderAsync(c,Windows.Storage.CreationCollisionOption.openIfExists).done(function(){a._startImport(c)},b)}catch(d){b(d)}};a._startImport=function(b){PhotoViewer.log.perf("evPhotoViewer_Import_start",{emptyValue:true});this._pushSelectionToHub();var a=this._dataHub.selection,c=a.size;if(c>0&&b.length>0){this._importModalActive=true;this._statusDialog=new PhotoViewer.ImportStatusDialog(this,c,b);this._statusDialog.on("close",this._onImportComplete,this);this._statusDialog.on("gotoFolder",this._onNavigateToImportFolder,this);this._statusDialog.on("stopImport",this._onImportStop,this);this._statusDialog.show();this._importCollection=a;this._importCollection.addEventListener("changed",this._onImportCollectionChanged);this._importOperationPromise=a.executeAsync("Import",b);var d=this;this._importOperationPromise.done(function(){PhotoViewer.log.perf("evPhotoViewer_Import_end",{emptyValue:true})},function(a){PhotoViewer.log.perf("evPhotoViewer_Import_end",{emptyValue:true});if(!a.name||a.name!=="Canceled"){Jx.log.error("Error Importing; message: "+a);d._statusDialog.reportFatalFailure(a.number)}})}};a._onAlbumCreationError=function(a){var b=this;try{Windows.UI.Popups.MessageDialog(Jx.res.getString(a)).showAsync().done(function(){b._folderNameInput.focus()})}catch(c){Jx.log.error("Exception while showing album creation error dialog, "+String(c))}};a._onGetSessionInfoCallback=function(b){if(this._view){var a=b.itemCount;if(a){this._folderNameInput.value=Windows.Globalization.DateTimeFormatting.DateTimeFormatter("{year.full}-{month.integer(2)}-{day.integer(2)}").format(b.recentDate);document.getElementById("importCount").innerText=e.getCountString(0,a);this._enumerationComplete=true;this._countTotalItems=a}else try{var c=this;Windows.UI.Popups.MessageDialog(Jx.res.getString("resid-import-deviceEmptyError")).showAsync().done(function(){c._coordinator.doCommand(PhotoViewer.AppBar.Commands.navigateBack,f.CommandSurface.appBar)})}catch(d){Jx.log.error("Exception while showing empty device error dialog, "+String(d))}this._folderNameInput.removeAttribute("disabled");this._enableCommandsAfterEnumerationComplete()}};a._onInputPaneDown=function(){this._commandBarElement.style.bottom="0";this._commandBarElement.removeAttribute("data-keyboard-up");this._isKeyboardUp=false};a._onInputPaneUp=function(b){b.ensuredFocusedElementInView=true;this._isKeyboardUp=true;var a=b.occludedRect.height+"px";this._commandBarElement.style.bottom=a;this._commandBarElement.setAttribute("data-keyboard-up","true");WinJS.UI.Animation.showEdgeUI(this._commandBarElement,{top:a,left:"0px"}).done()};a._onFolderInputKeyDown=function(a){a.keyCode===WinJS.Utilities.Key.enter&&a.preventDefault()};a._onFolderInputKeyPress=function(a){this._folderNameInput.value.length>=d&&a.preventDefault();if(g.indexOf(String.fromCharCode(a.keyCode))>=0){a.preventDefault();this._showInvalidCharacterError(true)}else this._showInvalidCharacterError(false)};a._onFolderInputKeyUp=function(){this._onFolderNameChanged(false)};a._onFolderInputLoseFocus=function(){this._onFolderNameChanged(true);this._showInvalidCharacterError(false)};a._addDeferredIndicesToSelection=function(){if(this._deferredIndicesToAddToSelection.length>0){var a=this._deferredIndicesToAddToSelection;this._deferredIndicesToAddToSelection=[];this._view._thumbsView.selection.add(a);if(!this._scrolledToFirstSelection){this._scrolledToFirstSelection=true;this._view.scrollToItemIndex(a[0])}}};a._onAddNotificationsCompleted=function(a){for(var b=0,c=a.length;b<c;b++)this._checkAndAddObjectToDeferredSelection(a[b]);this._countItemsInserted+=a.length;this._enableCommandsAfterEnumerationComplete()};a._onViewSelectionChanged=function(){var b=this._view._thumbsView.selection.count(),c=e.formatInteger(b),a;if(b===1){a=Jx.res.getString("resid-import-folderLabelSingle");a=a.replace("1",c)}else a=Jx.res.loadCompoundString("resid-import-folderLabelMultiple",c);this._folderNameLabel.innerText=a;if(b===0&&this._selectionExists){this._selectionCommand.innerText=Jx.res.getString("resid-import-SelectAll");this._selectionExists=false;this._updateCommandStates()}else if(b!==0&&!this._selectionExists){this._selectionCommand.innerText=Jx.res.getString("resid-import-ClearSelection");this._selectionExists=true;this._updateCommandStates()}};a._onViewLoadingStateChanged=function(){this._view._thumbsView.loadingState==="complete"&&this._addDeferredIndicesToSelection()};a._checkAndAddObjectToDeferredSelection=function(b){var c=this._dataAdaptor.objectIdToObject(b),a=this;c.getProperties(["isDuplicate"],function(f,d){var c=d.lookup("isDuplicate");if(!c){var e=a._dataAdaptor.objectIdToIndex(b);a._deferredIndicesToAddToSelection[a._deferredIndicesToAddToSelection.length]=e}})};a._showInvalidCharacterError=function(a){if(a){this._folderNameLabel.setAttribute("aria-hidden","true");this._invalidCharacterErrorLabel.removeAttribute("aria-hidden")}else{this._folderNameLabel.removeAttribute("aria-hidden");this._invalidCharacterErrorLabel.setAttribute("aria-hidden","true")}};a._toggleSelection=function(){if(this._selectionExists)this._view._thumbsView.selection.clear();else this._view._thumbsView.selection.selectAll()};a._onNavigateToImportFolder=function(){this._importModalActive=false;var b=this._folderNameInput.value,a=this;Windows.Storage.KnownFolders.picturesLibrary.getFolderAsync(b).done(function(c){var b=c.path;!a._coordinator.navigateToFolder(b)&&a._coordinator.doCommand(PhotoViewer.AppBar.Commands.navigateBack,WindowsLive.Photo.Viewer.Commanding.CommandSurface.appBar)})};a._onImportStop=function(){if(this._importCollection){this._importCollection.removeEventListener("changed",this._onImportCollectionChanged);this._importCollection=null}this._importOperationPromise.cancel()};a._onImportComplete=function(){this._importModalActive=false;this._coordinator.doCommand(PhotoViewer.AppBar.Commands.navigateBack,WindowsLive.Photo.Viewer.Commanding.CommandSurface.appBar)};a._onImportCollectionChanged=function(e){for(var f=e.target,c=e.detail[0],h=c.length,d=this,a=0;a<h;a++){var b=c[a];switch(b.type){case WindowsLive.Photo.Viewer.DataModel.ObjectCollectionChangedEventType.modified:var g=f.objectAt(b.position);g.getProperties(["importStatus","title"],function(f,a){if(d._statusDialog){var b=a.lookup("importStatus"),e=a.lookup("title"),c={name:e,code:b};d._statusDialog.updateItemImportStatus(c)}})}}};a._pushSelectionToHub=function(){for(var d=this._view._thumbsView.selection.getRanges(),f=this._dataHub.selection,c=[],a=0,i=d.length;a<i;a++)for(var e=d[a],b=e.firstIndex,g=e.lastIndex;b<=g;b++){var h=this._dataAdaptor.indexToObjectId(b);c.push(h)}f.appendRange(c)};a._updateCommandStates=function(){var a=this._selectionExists&&this._folderNameInput.value.length>0;if(a&&this._itemsLoaded)this._importElement.removeAttribute("disabled");else this._importElement.setAttribute("disabled","disabled")};a._enableCommandsAfterEnumerationComplete=function(){if(this._enumerationComplete&&this._countItemsInserted===this._countTotalItems){this._itemsLoaded=true;this._importProgressBar.setAttribute("aria-hidden","true");this._selectionCommand.removeAttribute("disabled");this._updateCommandStates();this._importElement.focus()}};a._onFolderNameChanged=function(b){if(b){var a=this._folderNameInput.value;a=a.replace(c,"");a=a.replace(c,"");if(a.length>d){a=a.substr(0,d);a=a.replace(c,"")}this._folderNameInput.value=a}this._updateCommandStates()};a._onDeviceRemoved=function(c){var a=c.detail[0];if(a.id===this._currentDeviceId){Jx.log.info("Device removed: "+a.id);if(this._importOperationPromise&&this._statusDialog){this._importOperationPromise.cancel();this._statusDialog.reportFatalFailure(1)}else{var b=this;try{Windows.UI.Popups.MessageDialog(Jx.res.getString("resid-import-deviceNotPresentError")).showAsync().done(function(){b._coordinator.doCommand(PhotoViewer.AppBar.Commands.navigateBack,f.CommandSurface.appBar)})}catch(d){Jx.log.error("Exception while showing device not present dialog, "+String(d))}}}};Object.defineProperty(a,"importModalActive",{"get":function(){return this._importModalActive}});a._coordinator=null;a._dataHub=null;a._view=null;a._dataAdaptor=null;a._selectionExists=false;a._scrolledToFirstSelection=false;a._importProgressBar=null;a._importElement=null;a._selectionCommand=null;a._cancelElement=null;a._folderNameInput=null;a._folderNameLabel=null;a._invalidCharacterErrorLabel=null;a._inputPaneHandle=null;a._isKeyboardUp=false;a._commandBarElement=null;a._statusDialog=null;a._importCollection=null;a._importOperationPromise=null;a._currentDeviceId=null;a._deviceWatcher=null;a._importModalActive=false;a._deferredIndicesToAddToSelection=null;a._enumerationComplete=false;a._itemsLoaded=false;a._countItemsInserted=0;a._countTotalItems=0;a._importInProgress=false})();(function(){var b=window.PhotoViewer,c=10;b.ImportView=function(){};var a=b.ImportView.prototype;a.getMainViewUI=function(b,a){a.html+='<div id="'+b+'">';a.html+='        <div id="importViewFrame">                        <progress id="importEnumerationProgressBar" class="header-progress-bar"></progress>            <div id="importHeaderContainer">                <header id="importHeader" class="photoViewer-headerContainer photoViewer-header">                    <div id="importDeviceName" class="photoViewer-headerPrimaryText"></div>                    <div id="importCount" class="photoViewer-headerSecondaryText"></div>                    <button id="importSelectionCommand" class="photoViewer-headerSecondaryText"></button>                </header>            </div>            <div id="importContents">                <div id="importThumbsViewContainer"></div>            </div>            <div id="importCommandBar">                <div id="importFolderInput">                    <div id="importFolderInputError" aria-hidden="true" data-win-res="innerText:resid-import-folderInputError"></div>                    <label id="importFolderInputLabel" class="import-folder-label" data-win-res="innerText:resid-import-folderInputLabel"></label>                    <input id="importFolderInputBox" aria-describedby="importFolderInputLabel" aria-labelledby="importFolderInputLabel" type="text" />                </div>                <div id="cmdButtonArea">                    <button id="cmdImport" data-win-res="innerText:resid-import-importCommand" role="menuitem"></button>                    <button id="cmdImportCancel" data-win-res="innerText:resid-import-cancel" role="menuitem"></button>                </div>            </div>        </div>    ';a.html+="</div>"};a.initialize=function(a){this._thumbsViewElement=document.getElementById("importThumbsViewContainer");var d=b.PuzzleLayout,e=this;this._thumbsView=new PhotoViewer.ThumbsView(this._thumbsViewElement,a,new PhotoViewer.PuzzleLayout(a,c),{viewName:"ImportView",dataContainerId:"ImportView",selectionMode:WinJS.UI.SelectionMode.multi,tapBehavior:WinJS.UI.TapBehavior.toggleSelect,videoInfoClass:"collections-puzzleVideoInfo",videoGlyphOnly:true,videoGlyph:"large"})};a.shutdown=function(){this._thumbsView.beginDeactivate();this._thumbsView.shutdown();this._thumbsViewElement=null};a.getEntranceAnimationInfo=function(){var a=document.getElementById("importHeader");return PhotoViewer.AnimationHelpers.genericComponentAnimationInfo([a,this._thumbsViewElement],"ImportView","Entrance",true)};a.getExitAnimationInfo=function(){var a=document.getElementById("importHeader");return PhotoViewer.AnimationHelpers.genericComponentAnimationInfo([a,this._thumbsViewElement],"ImportView","Exit",true)};a.addListViewEventListener=function(b,a){this._thumbsView.addListViewEventListener(b,a)};a.removeListViewEventListener=function(b,a){this._thumbsView.removeListViewEventListener(b,a)};a.scrollToItemIndex=function(a){this._thumbsView.setScrollToIndex(a,b.ThumbsView.ScrollToItemPosition.leftEdge)};a._thumbsView=null;a._thumbsViewElement=null})();(function(){var a=PhotoViewer.ImportHelpers={},b=Windows.Devices.Portable.StorageDevice;a.enumerateAndPickDeviceAsync=function(){return new WinJS.Promise(function(e,c){try{var d=b.getDeviceSelector();Windows.Devices.Enumeration.DeviceInformation.findAllAsync(d,null).then(function(b){a._showDeviceSelectionFlyout(b,e)},function(a){Jx.log.error("Failed to find all storage devices, error: "+a.message);c(a)})}catch(f){Jx.log.error("Failed to find all storage devices, error: "+f.message);c(f)}})};a._showDeviceSelectionFlyout=function(h,o){var k=h.length,d=a._getDeviceSelectionFlyout(),c=d.querySelector(".import-device-list-wrapper");if(!c){c=document.createElement("div");c.className="import-device-list-wrapper";d.appendChild(c)}c.innerHTML="";var e=d.winControl;if(!e)e=new WinJS.UI.Flyout(d);var m=d.querySelector(".import-device-header"),l=d.querySelector(".import-device-subheader");if(k>0){m.innerText=Jx.res.getString("resid-import-deviceFlyoutTitle");l.innerText=Jx.res.getString("resid-import-deviceFlyoutDescription");for(var n=function(k){var j=k.target,d=j["data-deviceIndex"];if(Number(d)>=0){e.hide();c.innerHTML="";try{var a=h[d].id,f=b.fromId(a),i={folder:f,id:a};o(i)}catch(l){Jx.log.error("Exception while picking the device for import, "+l.toString());var g=Jx.res.getString("resid-import-deviceNotPresentError");Windows.UI.Popups.MessageDialog(g).showAsync().done()}}},i,f,g=0;g<k;g++){i=h[g];if(i){f=a._createDeviceEntryElement(i,g);if(f){c.appendChild(f);f.addEventListener("click",n,false)}}}var j=function(){PhotoViewer.log.perf("evPhotoViewer_Import_DeviceSelectionFlyoutVisible",{emptyValue:true});var a=c.querySelector(".import-device-entry");Boolean(a)&&a.focus();e.removeEventListener("aftershow",j,false)};e.addEventListener("aftershow",j,false)}else{m.innerText=Jx.res.getString("resid-import-deviceFlyoutTitleNoDevices");l.innerText=Jx.res.getString("resid-import-deviceFlyoutDescriptionNoDevices")}e.show(document.getElementById("launchImport"),"top")};a._createDeviceEntryElement=function(d,i){var g;try{g=b.fromId(d.id)}catch(j){Jx.log.error("Error accessing device with Id: "+d.id+" , error: "+String(j));return null}var c=document.createElement("button");c.className="import-device-entry";c.setAttribute("role","menuitem");c["data-deviceIndex"]=i;var f=document.createElement("div");f.className="import-device-icon";c.appendChild(f);var h=document.createElement("img");a._loadDeviceIcon(d,h);f.appendChild(h);var e=document.createElement("div");e.className="import-device-text";e.innerText=g.displayName;c.appendChild(e);return c};a._loadDeviceIcon=function(a,b){a.getGlyphThumbnailAsync().then(function(a){if(Boolean(a)){var c=a.contentType,d=window.MSApp.createBlobFromRandomAccessStream(c,a),e=URL.createObjectURL(d,{oneTimeOnly:true});b.src=e}})};a._getDeviceSelectionFlyout=function(){var a=document.getElementById("deviceSelectionFlyout");if(!a){a=document.createElement("div");a.setAttribute("id","deviceSelectionFlyout");document.body.appendChild(a);var c=document.createElement("div");c.className="import-device-header";a.appendChild(c);var b=document.createElement("div");b.className="import-device-subheader";a.appendChild(b)}return a}})();(function(){var a=window.PhotoViewer;a.OverlayDialog=function(a){this._content=a;this._onNodeInsertedListener=this._onNodeAdded.bind(this);this.appendChild(a);this.initComponent()};Jx.inherit(a.OverlayDialog,Jx.Events);Jx.augment(a.OverlayDialog,Jx.Component);var b=a.OverlayDialog.prototype;b.show=function(){var c=this._root=document.createElement("div"),d=document.createElement("div"),b=document.body.firstElementChild;c.className="import-modal-overlay-root";d.className="import-modal-overlay-fill";c.appendChild(d);msSetImmediate(function(){this._restore=[];while(b!==null){if(!b.disabled&&c!==b){b.disabled=true;b.setAttribute("disabled","disabled");this._restore.push(b)}b=b.nextElementSibling}document.body.addEventListener("DOMNodeInserted",this._onNodeInsertedListener,true)}.bind(this));document.documentElement.addEventListener("keydown",a.OverlayDialog._trap,false);document.documentElement.addEventListener("contextmenu",a.OverlayDialog._trap,false);document.body.appendChild(c);this.initUI(d)};b.close=function(){this.shutdownUI();document.body.removeChild(this._root);document.documentElement.removeEventListener("keydown",a.OverlayDialog._trap,false);document.documentElement.removeEventListener("contextmenu",a.OverlayDialog._trap,false);document.body.removeEventListener("DOMNodeInserted",this._onNodeInsertedListener,true);this._restore.forEach(function(a){a.disabled=false;a.removeAttribute("disabled")})};b.getUI=function(a){a.html="<div id='importModalDlgBox'><div class='import-modal-dlg-band'></div><div id='importModalDlgContentPanel' class='import-modal-dlg-content'>"+Jx.getUI(this._content).html+"</div><div class='import-modal-dlg-band'></div></div>"};b.activateUI=function(){Jx.Component.prototype.activateUI.call(this);Jx.res.processAll(this._root)};b._onNodeAdded=function(b){var a=b.target;if(a.parentNode===document.body)if(!a.disabled){this._restore.push(a);a.disabled=true;a.setAttribute("disabled","disabled")}};a.OverlayDialog._trap=function(a){a.stopPropagation()};b._root=null;b._content=null;b._restore=null})();(function(){var d=window.PhotoViewer,c=d.ViewHelpers;d.ImportStatusDialog=function(d,a,b){this.initComponent();this._controller=d;this._totalItemCount=a;this._totalItemCountString=c.formatInteger(a);this._outputFolderName=b;this._failedItemInfo=[]};Jx.augment(d.ImportStatusDialog,Jx.Component);var a=d.ImportStatusDialog.prototype;a.getUI=function(a){a.html+='        <div id="importStatusDialog" aria-labelledby="importStatusHeader" data-import-state="progress" role="dialog">                        <div id="importDlgUpper">                <div id="importStatusHeader" aria-live="assertive" role="heading"></div>                <progress id="importProgressBar" class="import-progress-bar" value="0"></progress>                <div id="importStatusProgressText" aria-live="polite"></div>                <div id="importStatusText" aria-live="polite"></div>                <button id="cmdImportMoreDetails" data-win-res="innerText:resid-import-moreDetailButton" role="menuitem"></button>            </div>            <div id="importStatusDetails" aria-hidden="true" aria-live="polite"></div>            <div id="cmdDlgButtonArea">                <button id="cmdImportGotoFolder" class="default-button-light" data-win-res="innerText:resid-import-gotoFolderButton" role="menuitem"></button>                <button id="cmdImportClose" data-win-res="innerText:resid-import-closeButton" role="menuitem"></button>                <button id="cmdImportStop" class="default-button-light" data-win-res="innerText:resid-import-stopButton" role="menuitem"></button>            </div>        </div>    '};a.activateUI=function(){Jx.Component.prototype.activateUI.call(this);this._contentElement=document.getElementById("importStatusDialog");this._headerElement=document.getElementById("importStatusHeader");this._progressElement=document.getElementById("importProgressBar");this._progressLabelElement=document.getElementById("importStatusProgressText");this._failedStatusElement=document.getElementById("importStatusText");this._failedListElement=document.getElementById("importStatusDetails");document.getElementById("cmdImportGotoFolder").addEventListener("click",this._onGotoFolder.bind(this),false);document.getElementById("cmdImportClose").addEventListener("click",this._onClose.bind(this),false);var a=document.getElementById("cmdImportStop");a.addEventListener("click",this._onStop.bind(this),false);a.focus();document.getElementById("cmdImportMoreDetails").addEventListener("click",function(){var c=document.getElementById("importDlgUpper").offsetHeight,b=document.getElementById("cmdDlgButtonArea").offsetHeight,a=document.getElementById("importStatusDetails");document.getElementById("cmdImportMoreDetails").setAttribute("aria-hidden","true");a.removeAttribute("aria-hidden");a.style.maxHeight=String(window.innerHeight-(c+b)-80)+"px"},false);this._progressElement.value=0;this._progressElement.max=this._totalItemCount;var b=Jx.res;this._headerElement.innerText=b.getString("resid-import-statusHeader");var d=c.formatInteger(0);this._progressLabelElement.innerText=b.loadCompoundString("resid-import-statusLabel",d,this._totalItemCountString);this._showHideElementsForState("progress");WinJS.UI.Animation.enterContent([this._contentElement]).then()};a.show=function(){if(!this._overlayDialog){this._overlayDialog=new d.OverlayDialog(this);this._overlayDialog.show()}};a._close=function(){if(this._overlayDialog){this._overlayDialog.close();this._overlayDialog=null}};a.reportFatalFailure=function(d){if(this._fatalFailure||this._completionUIShown)return;var b,a=this;if(d===1)b="resid-import-deviceNotPresentError";else if(d===2147942405)b="resid-import-deviceInUseError";else if(d===2147942439)b="resid-import-errorDiskSpace";this._fatalFailure=true;WinJS.UI.Animation.exitContent([this._contentElement]).then(function(){var d=Jx.res;a._headerElement.innerText=d.getString("resid-import-fatalHeader");var e=c.formatInteger(a._succeededItemCount);a._progressLabelElement.innerText=d.loadCompoundString("resid-import-stoppedLabel",e,a._totalItemCountString,a._outputFolderName);a._showHideElementsForState("fatal");if(b)a._failedStatusElement.innerText=d.getString(b);else a._failedStatusElement.setAttribute("aria-hidden","true");return WinJS.UI.Animation.enterContent([a._contentElement])})};a.updateItemImportStatus=function(b){if(this._fatalFailure)return;if(Number(b.code)!==0)this._failedItemInfo.push(b);else this._succeededItemCount++;var a=this._succeededItemCount+this._failedItemInfo.length;this._progressElement.value=a;if(a===this._totalItemCount){var d=this;WinJS.UI.Animation.exitContent([this._contentElement]).then(function(){d._updateUIForCompletion(false);return WinJS.UI.Animation.enterContent([d._contentElement])})}else{var e=c.formatInteger(a);this._progressLabelElement.innerText=Jx.res.loadCompoundString("resid-import-statusLabel",e,this._totalItemCountString)}};a._updateUIForCompletion=function(i){var a=Jx.res,d=this._failedItemInfo.length,f=c.formatInteger(this._succeededItemCount),b="completed";if(i){this._headerElement.innerText=a.getString("resid-import-stoppedHeader");this._progressLabelElement.innerText=a.loadCompoundString("resid-import-stoppedLabel",f,this._totalItemCountString,this._outputFolderName);b="stopped"}else if(d>0){this._headerElement.innerText=a.getString("resid-import-errorHeader");this._progressLabelElement.innerText=a.loadCompoundString("resid-import-stoppedLabel",f,this._totalItemCountString,this._outputFolderName);var h=c.formatInteger(d);this._failedStatusElement.innerText=a.loadCompoundString("resid-import-errorLabel",h);for(var g="",e=0;e<d;e++)g+=this._failedItemInfo[e].name+"\r\n";this._failedListElement.innerText=g;b="failed"}else{this._headerElement.innerText=a.getString("resid-import-completeHeader");this._progressLabelElement.innerText=a.loadCompoundString("resid-import-completeLabel",this._totalItemCountString,this._outputFolderName)}this._showHideElementsForState(b);if(this._succeededItemCount===0&&b==="failed"){document.getElementById("cmdImportGotoFolder").setAttribute("aria-hidden","true");document.getElementById("cmdImportClose").focus()}else document.getElementById("cmdImportGotoFolder").focus();this._completionUIShown=true};a._onGotoFolder=function(){this._close();this.fire("gotoFolder",{})};a._onClose=function(){this._close();this.fire("close",{})};a._onStop=function(){this.fire("stopImport",{});var a=this;WinJS.UI.Animation.exitContent([this._contentElement]).then(function(){a._updateUIForCompletion(true);return WinJS.UI.Animation.enterContent([a._contentElement])})};var b=[];b.progress="#importStatusText, #cmdImportMoreDetails, #importStatusDetails, #cmdImportGotoFolder, #cmdImportClose";b.stopped="#importStatusText, #cmdImportMoreDetails, #importStatusDetails, #cmdImportStop";b.failed="#cmdImportStop, #importStatusDetails";b.fatal="#cmdImportMoreDetails, #importStatusDetails, #cmdImportStop";b.completed="#importStatusText, #cmdImportMoreDetails, #importStatusDetails, #cmdImportStop, #cmdImportClose";b.all="#importProgressBar, #importStatusText, #cmdImportMoreDetails, #importStatusDetails, #cmdImportGotoFolder, #cmdImportClose, #cmdImportStop";a._showHideElementsForState=function(a){var e=b[a];if(e){for(var d=this._contentElement.querySelectorAll(b.all),g=d.length;g--;)d[g].removeAttribute("aria-hidden");for(var c=this._contentElement.querySelectorAll(e),f=c.length;f--;)c[f].setAttribute("aria-hidden","true")}if(this._succeededItemCount===0&&(a==="stopped"||a==="failed"||a==="fatal")){document.getElementById("cmdImportGotoFolder").setAttribute("aria-hidden","true");document.getElementById("cmdImportClose").removeAttribute("aria-hidden")}};a._controller=null;a._overlayDialog=null;a._totalItemCount=0;a._totalItemCountString=null;a._outputFolderName=null;a._succeededItemCount=0;a._failedItemInfo=null;a._contentElement=null;a._headerElement=null;a._progressElement=null;a._progressLabelElement=null;a._failedStatusElement=null;a._failedListElement=null;a._fatalFailure=false;a._completionUIShown=false})()