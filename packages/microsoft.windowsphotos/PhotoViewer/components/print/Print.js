(function(){var c=window.PhotoViewer,d=c.DataHubHelpers,f=c.AppBar.Commands,i=c.ImgCache.ImgSizes,e=WindowsLive.Photo.Viewer.Commanding,g=Windows.Graphics.Printing,b=g.StandardPrintTaskOptions,h="print-image-div";c.Print=function(b,d,c,a){this._coordinator=b;this._dataHub=d;this._imgCache=c;this._printImageDiv=a;this._cachedBlobs=[];this._enableCommanding()};var a=c.Print.prototype;a.deactivate=function(){this._coordinator.removeCommand(f.print)};a.initializePrintTask=function(d){Jx.log.info("Print: Devices charm invoked -- initialize print");var c=d.request,e=c.getDeferral(),b=this._dataHub.activeItem.objectAt(0),a=this;this._getPrintTitleAsync(b,function(g){var d=c.createPrintTask(g,function(c){a._sendImageToPrint(b,c)});d.addEventListener("completed",function f(){a._printImageDiv.innerHTML="";a._clearCachedBlob(b.id);d.removeEventListener("completed",f)});a._applyPrintTaskOptions(d);e.complete()})};a._sendImageToPrint=function(b,e){var a=this,f=e.getDeferral(),g=b.id,c=function(){a._printImageDiv.innerHTML="";a._clearCachedBlob(g);f.complete()};b.getMediaAsync(WindowsLive.Photo.Viewer.DataModel.GetMediaAsyncFlags.largestAvailableLocally).then(function(l){var i=d.getSourceFromBlobOperationResult(l,true);a._cachedBlobs[g]=i;if(Jx.isNonEmptyString(i)){var h=document.createElement("img");h.addEventListener("load",function k(){h.removeEventListener("load",k,true);a._setImageToPrint(h,e,b.dimensions);f.complete()},true);h.addEventListener("error",function j(){h.removeEventListener("error",j,false);c()},false);h.src=i}else c()}).done(null,c)};a._setImageToPrint=function(a,c,b){this._printImageDiv.innerHTML="";this._printImageDiv.appendChild(a);if(b.width>=b.height){a.style.width="100%";a.style.height="auto";a.style.maxWidth=b.width.toString()+"px"}else{a.style.height="100%";a.style.width="auto";a.style.maxHeight=b.height.toString()+"px"}c.setSource(MSApp.getHtmlPrintDocumentSource(document))};a._getPrintTitleAsync=function(b,c){var a="title";b.getProperties([a],function(f,b){var e=d.tryLookupPropertyInMap(b,a)||"";c(e)})};a._applyPrintTaskOptions=function(c){var d=c.options,a=c.options.displayedOptions;a.clear();a.append(b.copies);a.append(b.orientation);a.append(b.colorMode);a.append(b.mediaSize);a.append(b.printQuality);a.append(b.nup)};a._clearCachedBlob=function(a){var b=this._cachedBlobs[a];if(b){Jx.log.info("Print: Releasing blob "+a);URL.revokeObjectURL(b);delete this._cachedBlobs[a]}};a._enableCommanding=function(){var a=e.CommandEnableProperties;this._coordinator.addCommand(f.print,a.sourceAllowsPrinting,a.viewIs1Up|a.viewIsOpenWith,a.activeItemIsVideo,e.ExpectedActionableItems.singleActiveItem,true,this.initializePrintTask)};a._printImageDiv=null})()