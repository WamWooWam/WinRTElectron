(function(){var f=PhotoViewer.DataHubHelpers,c=PhotoViewer.ViewHelpers,g=WindowsLive.Photo.Viewer.DataModel,d=g.ObjectCollectionChangedEventType,b=WinJS.Promise,e=WinJS.UI.SelectionMode;PhotoViewer.CollectionsControllerBase=function(j,h,c,a){this._site=j;this._fileOpenPickerUI=j.coordinator.fileOpenPickerUI;this._contentContainer=h;var g=this._deactivated=a?a.deactivated:false;this._deactivationCanBeCanceled=true;this._changingViewSelectionCount=0;var p=a&&a.usingSeZo,b;if(p)if(c.hasChildNodes())b=this._hostElement=c.childNodes[0];else{var n="-SeZoProxy",d=c.id,r=d.lastIndexOf(n),f;if(r!==-1)f=d.substring(0,r);else{f=d;d=d+n}b=this._hostElement=document.createElement("div");b.id=f;Jx.addClass(b,"collections-viewElement");c.id=d;c.appendChild(b)}else b=this._hostElement=c;this._dataHub=j.dataHub;var o=this._selectionMode!==e.none;if(o){this._onViewSelectionChanging=this._onViewSelectionChanging.bind(this);this._onViewSelectionChanged=this._onViewSelectionChanged.bind(this);this._hubSelectionChangedHandler=this._hubSelectionChangedHandler.bind(this)}this._addNotificationsCompletedHandler=this._addNotificationsCompletedHandler.bind(this);var x=this,s=function(c){var b=0;if(a)if(a.itemId!==undefined){b=c.objectIdToIndex(a.itemId);!Jx.isValidNumber(b)&&x.setActiveItemId(a.itemId)}else if(a.itemIndex!==undefined)b=a.itemIndex;else if(g||a.scrollbarPosition!==undefined)b=null;return b},i=this._dataHub;i.contentContainer=h;this._dataAdaptor=new PhotoViewer.ObjectCollectionDSA(i,i.content);var w=s(this._dataAdaptor),t=a?a.scrollbarPosition:null,v=a?a.centerActiveItem:false,l=a?a.disableEntranceAnimation:false,m=a?a.delayEntranceAnimation:false,u={deactivated:g,scrollbarPosition:t,centerActiveItem:v,itemIndex:w,dataContainerId:h.id,disableEntranceAnimation:l,delayEntranceAnimation:m};this._createView(u);if(p)c.winControl=b.winControl;if(l)this._entranceAnimationRunningPromise=WinJS.Promise.wrap();m&&this._setUpEntranceAnimationRunningPromise();var k=this._view;k.addListViewEventListener("iteminvoked",this._onItemInvoked);Jx.removeClass(b,"displayNone");if(o){k.addListViewEventListener("selectionchanging",this._onViewSelectionChanging);k.addListViewEventListener("selectionchanged",this._onViewSelectionChanged);var q=this._dataHub.selection;q.addEventListener("changed",this._hubSelectionChangedHandler);this._hubSelection=q;this._pullSelectionFromHub()}this._dataAdaptor.setAddNotificationsCompletedHandler(this._addNotificationsCompletedHandler);!g&&Boolean(this._addEventListeners)&&this._addEventListeners()};var a=PhotoViewer.CollectionsControllerBase.prototype;a.forceLayout=function(){var a=this._view;if(a)a.forceLayout();else Jx.log.warning("Ignoring forceLayout call after view shutdown; should be rare")};a.isActivated=function(){return!this._deactivated&&Boolean(this._dataAdaptor)&&!this._dataAdaptor.isDeactivated()};a.beginDeactivate=function(a){this._deactivated=true;this._deactivationCanBeCanceled=a.cancelable;this._pendingActiveItemId=null;this._view.beginDeactivate();this._removeEventListeners&&this._removeEventListeners();this._beginDeactivate&&this._beginDeactivate(a);!this._deactivationCanBeCanceled&&this._performUnrevokableDeactivationSteps()};a.cancelDeactivate=function(){this._deactivated=false;this._deactivationCanBeCanceled=false;this._view.cancelDeactivate();this._cancelDeactivate&&this._cancelDeactivate();this._addEventListeners&&this._addEventListeners();this._cachedActiveItem=null};a.endDeactivate=function(){Jx.addClass(this._hostElement,"displayNone");this._deactivationCanBeCanceled&&this._performUnrevokableDeactivationSteps();this._deactivationCanBeCanceled=false;this._cachedActiveItem=null};a.shutdown=function(){if(!this._view)return;if(!this._deactivated){var d={componentDeactivating:false,cancelable:false,preserveActiveItem:false};this.beginDeactivate(d);this.endDeactivate()}else this._deactivationCanBeCanceled&&this.endDeactivate();var c=this._dataAdaptor;if(c){c.shutdown();this._dataAdaptor=null}var a=this._hostElement;if(a){var b=a.parentNode;b&&b.removeChild(a);this._hostElement=null}};a.delayEntranceAnimation=function(){var a=this._view;if(a){this._setUpEntranceAnimationRunningPromise();a.delayEntranceAnimation()}};a.runEntranceAnimation=function(){var b=this._view;if(b){var a=this,c=b.runEntranceAnimation();this._onEntranceAnimationRunningComplete&&c.then(function(){a._onEntranceAnimationRunningComplete();a._onEntranceAnimationRunningComplete=null})}};a.getItemInViewAsync=function(e){var d=this._view;if(!d){Jx.log.warning("Ignoring getItemInViewAsync call after view shutdown; should be rare");return b.wrap(null)}var c=this._getItemInView(e);if(c)return b.wrap(c);if(d.isInitialViewPlaceholderRenderComplete()){Jx.log.info("ControllerBase::getItemInViewAsync isInitialViewPlaceholderRenderComplete, returning null for element.");return b.wrap(null)}var g=this,a;function f(){Jx.removeListener(d,PhotoViewer.ThumbsView.Events.initialViewPlaceholderRenderComplete,a);a=null}var h=new WinJS.Promise(function(b){a=function(){f();c=g._getItemInView(e);b()};Jx.addListener(d,PhotoViewer.ThumbsView.Events.initialViewPlaceholderRenderComplete,a)}),i=b.timeout(500);return b.any([h,i]).then(function(){if(a){Jx.log.info("ControllerBase::getItemInViewAsync_cleanup timed out waiting for initialViewRenderCompleteCallback");f();c=g._getItemInView(e)}return c})};a.getViewPortFullyRenderedPromise=function(){var a,d=this;if(this._view.isViewportFullyRendered())return b.wrap();else{var c=function(){a&&a()};Jx.addListener(this._view,PhotoViewer.ThumbsView.Events.viewportFullyRendered,c);var e=new WinJS.Promise(function(b){a=b});return e.then(function(){d._view&&Jx.removeListener(d._view,PhotoViewer.ThumbsView.Events.viewportFullyRendered,c);a=null})}};a.setActiveItemId=function(b){var c=this._dataAdaptor,a=c.objectIdToIndex(b);if(Jx.isValidNumber(a)){var d=this;msSetImmediate(function(){var b=d._view;b&&b.setFocusIndex(a,PhotoViewer.ThumbsView.ScrollToItemPosition.center)});this._pendingActiveItemId=null}else this._pendingActiveItemId=b};a.onInitialViewPlaceholderRenderComplete=function(){var a=this._view;return c.onRenderComplete(a,PhotoViewer.ThumbsView.Events.initialViewPlaceholderRenderComplete,function(){return a.isInitialViewPlaceholderRenderComplete()})};a.stopHandlingNotifications=function(){this._dataAdaptor.stopHandlingNotifications();this._hubSelection&&this._hubSelection.removeEventListener("changed",this._hubSelectionChangedHandler)};a.resumeHandlingNotifications=function(){this._dataAdaptor.resumeHandlingNotifications();if(this._hubSelection){this._hubSelection.addEventListener("changed",this._hubSelectionChangedHandler);this._pullSelectionFromHub()}};Object.defineProperty(a,"scrollbarPosition",{"get":function(){return this._view.scrollbarPosition},"set":function(a){this._view.scrollbarPosition=a}});Object.defineProperty(a,"focusedIndex",{"get":function(){return this._view.focusedIndex}});Object.defineProperty(a,"contentContainer",{"get":function(){return this._contentContainer}});a._setUpEntranceAnimationRunningPromise=function(){var a=this;this._entranceAnimationRunningPromise=new WinJS.Promise(function(b){a._onEntranceAnimationRunningComplete=b})};a._onViewSelectionChanging=function(o){if(this._changingViewSelectionCount>0||this._deactivated||this._view.disabled)return;var d={},k=this._view.selection.getRanges(),b,g,a,e,c;for(b=0,g=k.length;b<g;b++){c=k[b];for(a=c.firstIndex,e=c.lastIndex;a<=e;a++)d[a]=true}this._pendingSelectedIndices=[];this._pendingDeselectedIndices=[];var i=this._pendingSelectedIndices,h=this._pendingDeselectedIndices,n=this._dataAdaptor,l=o.detail.newSelection,j=l.getRanges();for(b=0,g=j.length;b<g;b++){c=j[b];for(a=c.firstIndex,e=c.lastIndex;a<=e;a++)if(d[a])delete d[a];else{var q=false,p=n.indexToObject(a);if(f.isContainerType(p.type))l.remove(a);else i[i.length]=a}}for(var m in d)if(d.hasOwnProperty(m))h[h.length]=parseInt(m,10)};a._onViewSelectionChanged=function(){if(this._changingViewSelectionCount>0||this._deactivated||this._view.disabled)return;var a=this._pendingSelectedIndices,h=this._pendingDeselectedIndices,s=a.length>0,z=h.length>0;if(s||z){var f=this,i=this._hubSelection,m,j=[],u=this._selectionMode===e.single,d,y;if(s){var w=this._fileOpenPickerUI,g;if(!w){if(i.size>0&&i.sourceType!==this._dataHub.content.sourceType){this._changeViewSelection("remove",a);var D=i.objectAt(0);g=this._view.elementFromIndex(a[0]);var q;if(!g){g=this._hostElement;q="top"}else q=c.right;c.showSelectionSourceErrorFlyout(g,q,D);return}}else{var v=w.allowedFileTypes,B=v.indexOf("*").returnValue,t=[],p=false,o,C=this._dataAdaptor,E=this._view,A=PhotoViewer.FileOpenPickerExtension;for(d=0,y=a.length;d<y;d++){var k=a[d],r=C.indexToObject(k),l;if(B)l=b.wrap(null);else l=A.getFilenameForPicker(r).then(function(b){var c=b.lastIndexOf("."),a=b.substr(c).toLowerCase(),d=!v.indexOf(a).returnValue;return d?a:null});t.push(l.then(function(h){var a=Jx.isNonEmptyString(h),i=!a&&r.type==="asset.video"&&r.sourceType==="Device";if(a||i){j.push(k);var e=!p&&E.isItemInViewport(k),b=!e&&!Jx.isNonEmptyString(o);if(e||b){var d=a?Jx.res.loadCompoundString("resid-picker-unsupportedType",h):Jx.res.getString("resid-picker-deviceVideo");if(b)o=d;else{g=f._view.elementFromIndex(k);c.showMessageFlyout(g,c.right,d);p=true}}}}))}m=b.join(t).then(function(){var b=j.length;if(b>0){for(d=0;d<b;d++)a.splice(a.indexOf(j[d]),1);f._changeViewSelection("remove",j);if(u&&h.length===1){f._changeViewSelection("add",[h[0]]);h.splice(0,1)}!p&&c.showMessageFlyout(f._hostElement,"top",o)}})}}var x=b.timeout(0),n;if(m)n=b.join([m,x]);else n=x;n.done(function(){if(u)if(a.length===1&&i.size>0){f._changingHubSelection=true;try{i.clear()}finally{f._changingHubSelection=false}}f._pushSelectionToHub(a,h)})}};a._pullSelectionFromHub=function(){for(var c=this._hubSelection,b=[],e=0,a=0,f=c.size;a<f;a++){var g=c.idAt(a),d=this._dataAdaptor.objectIdToIndex(g);if(Jx.isValidNumber(d))b[e++]=d}this._changeViewSelection("set",b)};a._pushSelectionToHub=function(k,j){var f=k.length,e=j.length;if(f===0&&e===0)return;this._changingHubSelection=true;try{for(var i=this._dataAdaptor,l=i.count,d=this._hubSelection,c,b,g=[],a=0;a<e;a++){c=j[a];if(c<l){b=i.indexToObjectId(c);if(e===1)d.remove(b);else g.push(b)}}g.length>0&&d.removeSet(g);var h=[];for(a=0;a<f;a++){c=k[a];b=i.indexToObjectId(c);if(f===1)d.append(b);else h.push(b)}h.length>0&&d.appendRange(h)}finally{this._changingHubSelection=false}};a._hubSelectionChangedHandler=function(j){var k=j.target,i=j.detail[0];if(this._changingHubSelection)return;for(var a=[],b=false,f=0,m=i.length;f<m&&!b;f++){var e=i[f];switch(e.type){case d.added:for(var h=e.position,l=e.count,c=h;c<h+l;c++){var n=k.idAt(c),g=this._dataAdaptor.objectIdToIndex(n);if(Jx.isValidNumber(g))a[a.length]=g}break;case d.removed:case d.reset:b=true}}if(b)this._pullSelectionFromHub();else a.length>0&&this._changeViewSelection("add",a)};a._addNotificationsCompletedHandler=function(c){if(this._selectionMode!==e.none){var f=this._hubSelection;if(f.size>0){for(var a=[],d=0,i=c.length;d<i;d++){var h=c[d];if(Jx.isValidNumber(f.lookup(h))){var g=this._dataAdaptor.objectIdToIndex(h);if(Jx.isValidNumber(g))a[a.length]=g}}a.length>0&&this._changeViewSelection("add",a)}}var b=this._pendingActiveItemId;Boolean(b)&&c.indexOf(b)!==-1&&this.setActiveItemId(b)};a._changeViewSelection=function(c,b){this._changingViewSelectionCount++;var a=this,d=this._view.selection;d[c](b).then(function(){a._changingViewSelectionCount--},function(){a._changingViewSelectionCount--})};a._switchToModeOnFirstVisibleItem=function(b){var a=this;this._view.getFirstVisibleIndexAsync(true).then(function(c){a._site.activateMode(b,a._contentContainer,{itemIndex:c})})};a._performUnrevokableDeactivationSteps=function(){if(this._hubSelection){this._hubSelection.removeEventListener("changed",this._hubSelectionChangedHandler);this._hubSelection=null}var a=this._dataAdaptor;if(a){a.removeAddNotificationsCompletedHandler(this._addNotificationsCompletedHandler);a.deactivate()}var b=this._view;if(b){b.shutdown();this._view=null}};a._getItemInView=function(b){if(!this._view){Jx.log.warning("Ignoring _getItemInView call after view shutdown; should be rare");return null}var a;if(Boolean(this._cachedActiveItem)&&this._cachedActiveItem.objectId===b)a=this._cachedActiveItem.index;else if(!this._dataAdaptor.isDeactivated())a=this._dataAdaptor.objectIdToIndex(b);return!Jx.isValidNumber(a)?null:this._view.elementFromIndex(a)};a._getAnimationCompletionPromise=function(){var a=this._site.coordinator.animationRefCountedPromise;return a.getCompletionPromiseIfPending()};a._site=null;a._fileOpenPickerUI=null;a._dataHub=null;a._contentContainer=null;a._hostElement=null;a._selectionMode=e.none;a._view=null;a._dataAdaptor=null;a._hubSelection=null;a._changingViewSelectionCount=0;a._changingHubSelection=false;a._pendingSelectedIndices=null;a._pendingDeselectedIndices=null;a._deactivated=false;a._deactivationCanBeCanceled=false;a._pendingActiveItemId=null;a._cachedActiveItem=null;a._entranceAnimationRunningPromise=null;a._onEntranceAnimationRunningComplete=null})();(function(){var b=PhotoViewer.DataHubHelpers,d=WindowsLive.Photo.Viewer.DataModel,c=PhotoViewer.AppBar.Commands;PhotoViewer.FilteredObjectsControllerBase=function(d,f,e,c){var b=true;if(c)b=!Boolean(c.disableSelection);if(b){var a=d.coordinator.fileOpenPickerUI;if(Boolean(a)&&a.selectionMode===Windows.Storage.Pickers.Provider.FileSelectionMode.single)this._selectionMode=WinJS.UI.SelectionMode.single;else this._selectionMode=WinJS.UI.SelectionMode.multi}this._onItemInvoked=this._onItemInvoked.bind(this);PhotoViewer.CollectionsControllerBase.apply(this,arguments)};Jx.inherit(PhotoViewer.FilteredObjectsControllerBase,PhotoViewer.CollectionsControllerBase);var a=PhotoViewer.FilteredObjectsControllerBase.prototype;a.setItemToZoomOn=function(e){var d=this,a=this._view;if(a){var c=true;a.getFirstVisibleIndexAsync(true).then(function(f){if(!e){var g=d._dataAdaptor.indexToObject(f);if(b.isContainerType(g.type)){f=d._site.dataHub.content.firstAssetPosition;if(!Jx.isValidNumber(f))return}}c=a.setFocusIndex(f,PhotoViewer.ThumbsView.ScrollToItemPosition.noDesiredPosition)});c=false}else Jx.log.warning("Ignoring setItemToZoomOn call after view shutdown; should be rare")};a._beginDeactivate=function(e){var a,c;if(e.componentDeactivating&&!(this._preserveActiveItem||e.preserveActiveItem))if(this._dataAdaptor.count>0){var g=false,d=this;this._view.getFirstVisibleIndexAsync(true).then(function(e){g=true;var f=d._dataAdaptor.indexToObject(e);if(b.isContainerType(f.type))d._site.dataHub.activeItem.clear();else{c=f.id;d._site.dataHub.updateActiveItem(c);a=e}})}if(Jx.isNullOrUndefined(a)){var f=this._site._dataHub.activeItem;if(f.size===1){c=f.idAt(0);a=this._dataAdaptor.objectIdToIndex(c)}}if(!Jx.isNullOrUndefined(a))this._cachedActiveItem={index:a,objectId:c};else this._cachedActiveItem=null};a._cancelDeactivate=function(){this._zoomTriggered=false};a._onItemInvoked=function(g){if(this.isActivated()){var a=g.detail.itemIndex,e=this._dataAdaptor.indexToObject(a),f=this._site;if(b.isContainerType(e.type)){var j=this._fileOpenPickerUI?PhotoViewer.Collections.SupportedModes.filteredObjectsPuzzle:PhotoViewer.Collections.SupportedModes.filteredObjectsStrip,k=this;window.msSetImmediate(function(){k.isActivated()&&f.activateMode(j,e,{itemIndex:0,recordNavStackEntry:true})})}else if(this._fileOpenPickerUI){var d=this._view.selection,h=d.getIndices();if(h.indexOf(a)===-1)if(this._selectionMode===WinJS.UI.SelectionMode.single)d.set(a);else d.add(a);else d.remove(a)}else{PhotoViewer.log.perf("evPhotoViewerCollections_LaunchOneUpView",{emptyValue:true});var i=e.id;f.dataHub.updateActiveItem(i);this._preserveActiveItem=true;try{f.coordinator.doCommand(c.launchOneUp,WindowsLive.Photo.Viewer.Commanding.CommandSurface.canvas,null,null)}finally{this._preserveActiveItem=false}}}g.preventDefault()};a._triggerZoom=function(b,c){if(!this._zoomTriggered&&!this._deactivated){this._zoomTriggered=true;var a=this;window.msSetImmediate(function(){var d=a._site;d&&d.triggerZoom(b,c).done(function(b){if(!b)a._zoomTriggered=false})})}};a._showTooltips=false;a._preserveActiveItem=false;a._zoomTriggered=false})();(function(){var c=PhotoViewer.FilmstripLayout,d=PhotoViewer.DataHubHelpers,e=d.SourceType,b=WinJS.Utilities.Key;PhotoViewer.FilteredObjectsStrip=function(){this._onKeyDownBubbled=this._onKeyDownBubbled.bind(this);this._onKeyDownRouted=this._onKeyDownRouted.bind(this);this._onMouseWheel=this._onMouseWheel.bind(this);PhotoViewer.FilteredObjectsControllerBase.apply(this,arguments)};Jx.inherit(PhotoViewer.FilteredObjectsStrip,PhotoViewer.FilteredObjectsControllerBase);var a=PhotoViewer.FilteredObjectsStrip.prototype;a._createView=function(g){var h=this._contentContainer.sourceType!==e.device,f=this._dataAdaptor,d=this._site.coordinator,b=c.megastripLayoutOptions,a={imgCache:d.imgCache,sizeLevel:PhotoViewer.ImgCache.ImgSizes.megastrip,viewName:PhotoViewer.Collections.SupportedModes.filteredObjectsStrip,selectionMode:this._selectionMode,setPriorityRange:true,showTooltips:this._showTooltips,containerTitleHeight:b.containerTitleHeight,containerTitleClass:"collections-megastripContainerTitle",itemCountClass:h?"collections-itemCount collections-megastripCount":null,videoInfoClass:"collections-megastripVideoInfo",videoGlyph:"large",scalingCallback:d.plateauScaleManager.getPhysicalSize,progressBarContainerId:this._site.id,getAnimationCompletionPromise:this._getAnimationCompletionPromise.bind(this)};Jx.mix(a,g);this._view=new PhotoViewer.ThumbsView(this._hostElement,f,new c(f,b),a)};a._addEventListeners=function(){window.addEventListener("keydown",this._onKeyDownBubbled,false);window.addEventListener("keydown",this._onKeyDownRouted,true);window.addEventListener("mousewheel",this._onMouseWheel,true)};a._removeEventListeners=function(){window.removeEventListener("keydown",this._onKeyDownBubbled,false);window.removeEventListener("keydown",this._onKeyDownRouted,true);window.removeEventListener("mousewheel",this._onMouseWheel,true)};a._onKeyDownRouted=function(a){if((a.keyCode===b.add||a.keyCode===b.equal)&&a.ctrlKey){this._triggerZoom(true);a.stopPropagation();a.preventDefault()}};a._onKeyDownBubbled=function(a){(a.keyCode===b.dash||a.keyCode===b.subtract)&&a.ctrlKey&&this._triggerZoom(false)};a._onMouseWheel=function(a){if(a.ctrlKey&&a.wheelDelta>0){var e=a.target,d=this._hostElement,b={x:a.clientX,y:a.clientY},c=d.getBoundingClientRect();if(b.x>=c.left&&b.x<c.right&&b.y>=c.top&&b.y<c.bottom){b.x-=c.left;b.y-=c.top;this._triggerZoom(true,b);a.stopPropagation();a.preventDefault()}}}})();(function(){var b=PhotoViewer.PuzzleLayout;PhotoViewer.FilteredObjectsPuzzle=function(){this._onKeyDown=this._onKeyDown.bind(this);PhotoViewer.FilteredObjectsControllerBase.apply(this,arguments)};Jx.inherit(PhotoViewer.FilteredObjectsPuzzle,PhotoViewer.FilteredObjectsControllerBase);var a=PhotoViewer.FilteredObjectsPuzzle.prototype;a._createView=function(e){var d=this._dataAdaptor,c=this._site.coordinator,a={imgCache:c.imgCache,sizeLevel:PhotoViewer.ImgCache.ImgSizes.puzzle,viewName:PhotoViewer.Collections.SupportedModes.filteredObjectsPuzzle,selectionMode:this._selectionMode,setPriorityRange:true,showTooltips:this._showTooltips,containerTitleHeight:b.puzzleViewLayoutOptions.containerTitleHeight,containerTitleClass:"collections-puzzleAlbumTitle",containerTitleBackgroundClass:"collections-puzzleAlbumTitleBackground",videoInfoClass:"collections-puzzleVideoInfo",videoGlyphOnly:true,videoGlyph:"large",scalingCallback:c.plateauScaleManager.getPhysicalSize,progressBarContainerId:this._site.id,getAnimationCompletionPromise:this._getAnimationCompletionPromise.bind(this)};Jx.mix(a,e);this._view=new PhotoViewer.ThumbsView(this._hostElement,d,new b(d),a)};a._addEventListeners=function(){window.addEventListener("keydown",this._onKeyDown,false)};a._removeEventListeners=function(){window.removeEventListener("keydown",this._onKeyDown,false)};a._onKeyDown=function(a){var b=WinJS.Utilities.Key;if((a.keyCode===b.add||a.keyCode===b.equal)&&a.ctrlKey){a.stopPropagation();a.preventDefault();this._triggerZoom(true)}}})();(function(){var c=PhotoViewer.DataHubHelpers,e=PhotoViewer.ViewHelpers,a=c.SourceType,f=WinJS.Promise,d=PhotoViewer.SourcesHelpers;PhotoViewer.SourcesCustomRenderer=function(a,b){this._dataAdaptor=a;this._options=b};var b=PhotoViewer.SourcesCustomRenderer.prototype;b.setSite=function(a){this._rendererSite=a};b.takeOverRendering=function(b,a){var e=a.id,g=this._itemDivs;g[e]=b;var d=this;return new f(function(g,h){var f=a.object;f.getProperties(["recursiveAssetCount"],function(l,j){if(d._dataAdaptor.isDeactivated()){Jx.log.warning("takeOverRendering_countsAvailable async callback after dsa was deactivated");h();return}var i=c.tryLookupPropertyInMap(j,"recursiveAssetCount"),k=parseInt(i,10),f=k===0;if(f)d._customRenderSource(a,b);else{d.itemOutOfScope(e);b.msContainerPlaceholder.style.backgroundColor=""}g(f)})})};b.itemOutOfScope=function(a){delete this._itemDivs[a]};b.isItemAnEmptySourceTile=function(a){return Boolean(this._itemDivs[a])};b.invalidateAll=function(){this._itemDivs={}};Object.defineProperty(b,"useContainerPlaceholderDiv",{"get":function(){return true}});b._customRenderSource=function(m,h){var o=m.id;if(!this._itemDivs[o])return;var l=h.msContainerPlaceholder;e.removeAllButOneChild(h,h.childNodes,l);var a={},f=document.createElement("div");Jx.addClass(f,"collections-megastripContainerTitle");f.setAttribute("aria-hidden","true");h.appendChild(f);a.titleContainer=f;var p=document.createElement("div");p.className="thumbsView-containerTitleText";f.appendChild(p);a.title=p;var b=document.createElement("button");b.className="collections-emptySourceHideButton win-interactive";b.innerText=Jx.res.getString("residHideSourcesLinkText");b.addEventListener("click",function(){d.hideOrShowSourceAsync(m.object,true)},true);l.appendChild(b);var i=document.createElement("div");i.setAttribute("aria-hidden","true");Jx.addClass(i,"collections-emptySourceIconAndMessage");l.appendChild(i);var g=document.createElement("img");Jx.addClass(g,"collections-emptySourceIcon");i.appendChild(g);var n=document.createElement("div");Jx.addClass(n,"collections-emptySourceMessage");i.appendChild(n);Jx.addClass(g,"hidden");g.addEventListener("load",function(){Jx.removeClass(g,"hidden")},false);var k=this,j=["title","brandColor","brandIcon","sourceType","sourceStatus","errorResult","dateLastSync"],q,r;m.object.getProperties(j,function(A,v){if(k._dataAdaptor.isDeactivated()){Jx.log.warning("_customRenderSource_propertiesAvailable async callback after dsa was deactivated");return}for(var s=j.length-1;s>=0;s--){var w=j[s],e=c.tryLookupPropertyInMap(v,w);if(Jx.isNonEmptyString(e)){switch(w){case"title":var y=c.tryLookupPropertyInMap(v,"sourceType");if(!Jx.isNonEmptyString(y))continue;a.title.innerText=q=k._getAugmentedTitle(y,e);var x=Jx.res.loadCompoundString("residHideSourcesLinkNarratorText",e);b.setAttribute("aria-label",x);b.setAttribute("title",x);break;case"brandColor":l.style.backgroundColor=e;break;case"brandIcon":g.src=e;break;case"sourceType":n.innerText=r=k._getInlineUpsellMessage(e);break;case"sourceStatus":case"errorResult":case"dateLastSync":var i=c.tryLookupPropertiesInMap(v,["sourceStatus","errorResult","dateLastSync"]);if(Boolean(i)&&!Boolean(a.sourceStatusDiv)){var t=i.sourceStatus,u=i.errorResult,z=i.dateLastSync;if(d.hasErrorOnEmptySource(t,u)){var p=document.createElement("div");Jx.addClass(p,"collections-sourceStatusText");f.appendChild(p);a.sourceStatusDiv=p;d.showOrHideInlineError(true,a.sourceStatusDiv,a.title,t,u);k._options.addSourceStatusHandlers(p,o)}d.logSourceDiagnostics(m.object.sourceType,t,u,z)}}j.splice(s,1)}}if(j.length===0){h.setAttribute("aria-label",q+": "+r);k._rendererSite.onCustomItemRenderComplete(o,h)}})};b._getAugmentedTitle=function(d,c){var b;switch(d){case a.youTube:case a.vimeo:b="residInactiveSourceTitle_Videos";break;case a.skyDrive:case a.facebook:case a.flickr:b="residInactiveSourceTitle_Photos";break;case a.picturesLibrary:case a.device:case a.genericConnect:case a.genericDevice:case a.phone:case a.camera:case a.unknown:return c;default:return c}return Jx.res.loadCompoundString(b,c)};b._getInlineUpsellMessage=function(c){var b;switch(c){case a.picturesLibrary:b="residInlineUpsell_PicturesLibrary";break;case a.genericConnect:b="residInlineUpsell_GenericConnect";break;case a.genericDevice:b="residInlineUpsell_GenericDevice";break;case a.device:b="residInlineUpsell_Device";break;default:b="residInlineUpsell_ServiceOrPhone"}return Jx.res.getString(b)};b._dataAdaptor=null;b._rendererSite=null;b._itemDivs=null;b._options=null})();(function(){PhotoViewer.MultiUpSlideshowButton=function(c,b){this._site=c;this._inputParam=b;this._onClick=this._onClick.bind(this);this._onKeyDown=this._onKeyDown.bind(this);var a=document.createElement("button");a.id="collections-sourcesStrip-multiUpSlideshowButton";Jx.addClass(a,"multiUpSlideshowButton-button");this._buttonElement=a;this._buttonElement.setAttribute("aria-label",Jx.res.getString("residPhotoMix"));this._buttonElement.addEventListener("click",this._onClick,false);this._buttonElement.addEventListener("keydown",this._onKeyDown,false)};var a=PhotoViewer.MultiUpSlideshowButton.prototype;a.getElement=function(){return this._buttonElement};a._onClick=function(){this._execute()};a._onKeyDown=function(b){var a=b;a.stopPropagation()};a._execute=function(){this._site.doCommand(PhotoViewer.AppBar.Commands.launchMultiUpSlideshow,WindowsLive.Photo.Viewer.Commanding.CommandSurface.canvas,null,this._inputParam)}})();(function(){var i=PhotoViewer.FilmstripLayout,e=PhotoViewer.ViewHelpers,g=PhotoViewer.DataHubHelpers,d=g.SourceType,b=PhotoViewer.SourcesHelpers,j=WinJS.Promise,f="containerCount",h=400;PhotoViewer.SourcesStrip=function(){this._onItemInvoked=this._onItemInvoked.bind(this);this._addSourceStatusHandlers=this._addSourceStatusHandlers.bind(this);this._multiUpAlbumsRootChangedHandler=this._multiUpAlbumsRootChangedHandler.bind(this);this._rotateOneSourceTile=this._rotateOneSourceTile.bind(this);PhotoViewer.CollectionsControllerBase.apply(this,arguments)};Jx.inherit(PhotoViewer.SourcesStrip,PhotoViewer.CollectionsControllerBase);var a=PhotoViewer.SourcesStrip.prototype,c={itemAspectRatio:270/145,snapToMultiple:5,headerHeight:137,filePickerHeaderHeight:73,bottomPosition:28};PhotoViewer.SourcesStrip.sourcesStripLayoutOptions={itemMarginX:10,containerTitleHeight:80,shortenHeroShot:false,refreshOnScreenSizeChange:true,displayStateManager:null,updateScale:function(){var a=PhotoViewer.FilmstripLayout.megastripLayoutOptions.containerItemWidth,f=document.body.clientHeight,b=c.snapToMultiple;this.containerItemWidth=a;var g=this.fixedHeight=e.snapToMultiple(a/c.itemAspectRatio,b),d=PhotoViewer.Coordinator.filePickerMode?c.filePickerHeaderHeight:c.headerHeight;this.topMargin=e.snapToMultiple(f-d-g-this.containerTitleHeight-c.bottomPosition,b);if(this.displayStateManager.isAppSnapped())this.leadingMargin=this.trailingMargin=e.SourcesStripLeadingAndTrailingMargin.snapped;else this.leadingMargin=this.trailingMargin=e.SourcesStripLeadingAndTrailingMargin.normal}};a._createView=function(e){var a=this._dataAdaptor,d=this._site.coordinator,c=PhotoViewer.SourcesStrip.sourcesStripLayoutOptions;this._customRenderer=new PhotoViewer.SourcesCustomRenderer(a,{addSourceStatusHandlers:this._addSourceStatusHandlers});this._layout=new PhotoViewer.FilmstripLayout(a,c);var b={imgCache:d.imgCache,sizeLevel:PhotoViewer.ImgCache.ImgSizes.megastrip,viewName:PhotoViewer.Collections.SupportedModes.sourcesStrip,selectionMode:this._selectionMode,showTooltips:false,containerTitleHeight:c.containerTitleHeight,containerTitleClass:"collections-megastripContainerTitle",sourceStatusClass:"collections-sourceStatusText",itemCountClass:"collections-itemCount collections-sourceCount",progressBarContainerId:this._site.id,scalingCallback:d.plateauScaleManager.getPhysicalSize,addSourceStatusHandlers:this._addSourceStatusHandlers,customRenderer:this._customRenderer,getAnimationCompletionPromise:this._getAnimationCompletionPromise.bind(this)};Jx.mix(b,e);this._view=new PhotoViewer.ThumbsView(this._hostElement,a,this._layout,b);if(!this._multiUpAlbumsRootContainer&&!PhotoViewer.Coordinator.filePickerMode){this._multiUpAlbumsRootContainer=this._dataHub.createMultiUpAlbumRootContainer();this._multiUpAlbumsRootContainer.addEventListener("changed",this._multiUpAlbumsRootChangedHandler)}this._updatePlayButton();this._rotatingSourcesTilesTimer=setInterval(this._rotateOneSourceTile,3500)};a._multiUpAlbumsRootChangedHandler=function(b){var a=b;(a.fields&WindowsLive.Photo.Viewer.DataModel.ObjectChangedEventFields.subAlbumCount)!==0&&this._updatePlayButton()};a._getViewPort=function(){return this._hostElement.getElementsByClassName("win-viewport")[0]};a._updatePlayButton=function(){if(this._multiUpAlbumsRootContainer){var a=this;this._multiUpAlbumsRootContainer.getProperties([f],function(l,i,j){if(!j)return;var d=parseInt(i[f]);if(!a._multiUpSlideshowButton&&d>1){a._multiUpSlideshowButton=new PhotoViewer.MultiUpSlideshowButton(a._site.coordinator,a._multiUpAlbumsRootContainer);var e=a._getViewPort(),b=a._multiUpSlideshowButton.getElement();e.appendChild(b);if(Boolean(a._site)&&!a._site.coordinator.disableAnimations){b.style.visibility="hidden";var k;a._entranceAnimationRunningPromise.then(function(){return WinJS.Promise.timeout(h)}).then(function(){b.style.visibility="visible";WinJS.UI.Animation.fadeIn(b);PhotoViewer.log.perf("evPhotoViewer_MultiUpSlideshow_EntryPointVisible",{emptyValue:true})})}else PhotoViewer.log.perf("evPhotoViewer_MultiUpSlideshow_EntryPointVisible",{emptyValue:true})}else if(Boolean(a._multiUpSlideshowButton)&&d<=1){var g=a._getViewPort(),c=a._multiUpSlideshowButton.getElement();WinJS.UI.Animation.fadeOut(c).done(function(){g.removeChild(c)});a._multiUpSlideshowButton=null}})}};a._beginDeactivate=function(){clearInterval(this._rotatingSourcesTilesTimer)};a._onItemInvoked=function(i){if(this.isActivated()){var k=i.detail.itemIndex,h=this._dataAdaptor.indexToObject(k),f=this,c=b.SourceStatus,e=function(){if(f.isActivated()){var a=f._fileOpenPickerUI?PhotoViewer.Collections.SupportedModes.filteredObjectsPuzzle:PhotoViewer.Collections.SupportedModes.filteredObjectsStrip;f._site.activateMode(a,h,{itemIndex:0,recordNavStackEntry:true})}},a=h.sourceType;if(a!==d.picturesLibrary){var j=["assetCount","containerCount","sourceStatus","errorResult"];h.getProperties(j,function(m,t){var h=g.tryLookupPropertiesInMap(t,j);if(h){var s=parseInt(h.assetCount,10),q=parseInt(h.containerCount,10),k=h.sourceStatus,r=parseInt(h.errorResult,10),n=f._dataHub,l=i.target,o=r!==0,p=s===0&&q===0;if(a===d.genericConnect)b.showConnectUpsellFlyout(l,m);else if(a===d.genericDevice||a===d.device||a===d.skyDrive)b.checkSignedIn().then(function(){e()},function(a){if(a.number===-2147023579)b.ensureSignedIn(l,n).then(null);else e()});else if(p&&(k===c.noConnectedUser||k===c.errorProvider||k===c.notConnectedProvider||o))b.ensureSignedInAndConnected(m,n,o,l);else if(!p&&k===c.notConnectedProvider)b.showErrorFlyout(l,m,n);else e()}})}else e()}i.preventDefault()};a._addSourceStatusHandlers=function(a,d){var c=this;a.addEventListener("MSPointerDown",function(a){a.cancelable&&a.preventDefault();a.stopPropagation();return true},false);a.addEventListener("MSPointerUp",function(e){var a=c._dataAdaptor.objectIdToObject(d);b.showErrorFlyout(e.target,a,c._dataHub)},false)};a._removeEventListeners=function(){if(this._multiUpAlbumsRootContainer){this._multiUpAlbumsRootContainer.removeEventListener("changed",this._multiUpAlbumsRootChangedHandler);this._multiUpAlbumsRootContainer=null}};a._rotateOneSourceTile=function(){var a=[],e=this._customRenderer,b,c,d=this;this._layout.forEachItemInViewport(null,function(f,g){if(!e.isItemAnEmptySourceTile(g)&&Boolean(c=d._view.elementFromIndex(f))&&Boolean(c.msCurrentImg)&&!c.msIsRotationPending){b={};b.mainDiv=c;b.index=f;a.push(b)}return true}).done(function(){var b,c,e=a.length;if(e>1){do{var f=Math.floor(Math.random()*a.length);b=a[f];c=b.mainDiv.msObjectId}while(c===d._lastRotatedSourceTile)}else if(e===1)b=a[0];if(b){c=b.mainDiv.msObjectId;d._lastRotatedSourceTile=c;d._view.updateItemThumbnail(b.index,b.mainDiv,true)}})};a._customRenderer=null;a._multiUpAlbumsRootContainer=null;a._multiUpSlideshowButton=null;a._layout=null;a._rotatingSourcesTilesTimer=0;a._lastRotatedSourceTile=""})();(function(){var j=WinJS.Promise,d=PhotoViewer.AppBar.Commands,c=WindowsLive.Photo.Viewer.Commanding,g=PhotoViewer.DataHubHelpers,e=WindowsLive.Photo.Viewer.DataModel,v=e.ObjectCollectionChangedEventType,i=PhotoViewer.SourcesHelpers,m=PhotoViewer.ViewHelpers,u=PhotoViewer.Graphics,l=PhotoViewer.ZoomButtons,f=g.SourceType,h=PhotoViewer.AnimationHelpers,q=8,n=50,p=750,r=400;PhotoViewer.Collections=function(c,b,a){this.initComponent();this._site=c;this._dataHub=b;this._hubContentChangedHandler=this._hubContentChangedHandler.bind(this);this._containerChangedEventHandler=this._containerChangedEventHandler.bind(this);this._ensureBackgroundPhotoFitsScreen=this._ensureBackgroundPhotoFitsScreen.bind(this);this._onZoomOut=this._onZoomOut.bind(this);this._onZoomIn=this._onZoomIn.bind(this);this._registerPersistentCommands();if(a)this._disableSelection=Boolean(a.disableSelection);this._sourcesViewBackgroundPhoto=document.createElement("img");this._sourcesViewBackgroundPhoto.id="collections-sourcesBackgroundPhoto"};var k=PhotoViewer.Collections;Jx.augment(k,Jx.Component);var a=k.prototype;k.SupportedModes={filteredObjectsStrip:"filteredObjectsStrip",filteredObjectsPuzzle:"filteredObjectsPuzzle",sourcesStrip:"sourcesStrip"};var b=k.SupportedModes;a.getUI=function(a){a.html+='<div id="'+this._id+'" class="moPho-clientComponent">';a.html+='  <div id="collections-sourcesBackground" class="displayNone">    <div id="collections-sourceBackgroundGradient"></div>  </div>  <div id="collections-mainContent">      <div id="collections-headerContainer" class="photoViewer-headerContainer"></div>      <div id="collections-listViewContainer"></div>      <div id="collections-emptyMessageContainer" class="displayNone">        <div id="collections-emptyMessageTextLine1"></div>        <div id="collections-emptyMessageTextLine2"></div>        <a id="collections-emptyMessageLink" href="#"></a>      </div>  </div>';a.html+="</div>"};a.activateUI=function(){this._fileOpenPickerUI=this._site.fileOpenPickerUI;this._headerContainerElement=document.getElementById("collections-headerContainer");this._listViewContainerElement=document.getElementById("collections-listViewContainer");this._sourcesViewBackgroundElement=document.getElementById("collections-sourcesBackground");this._sourcesViewBackgroundElement.appendChild(this._sourcesViewBackgroundPhoto);var a=this._pendingNavState,c;if(Boolean(a)){var b=false;this.setNavState(a,null).done(function(){b=true})}else this._activateDataSource();this._initParams=null;this._site.displayStateManager.addSizeChangeCallback(this._ensureBackgroundPhotoFitsScreen);Jx.Component.prototype.activateUI.call(this)};a.deactivateUI=function(){var a=this._activeController;if(a){a.endDeactivate();a.shutdown();this._activeController=null}this._deactivating=false;this._activeMode=null;this._curViewElement=null;this._curHeaderElement=null;this._headerContainerElement=null;this._listViewContainerElement=null;this._pendingNavState=null;var b=this._hubContentChangedRegistrar;if(b){b.removeEventListener("changed",this._hubContentChangedHandler);this._hubContentChangedRegistrar=null}this._ensureContainerChangedHandler(null);o(this._curSeZo);this._curSeZo=null;if(this._zoomButtons){this._zoomButtons.shutdown();this._zoomButtons=null}this._ensureSyncingContentTimerIsCleared();this._pinchZoomingToOneUp=false;Jx.Component.prototype.deactivateUI.call(this)};a.preDeactivateUI=function(){this._pendingActiveItemId=null;this._deactivating=true;this._site.displayStateManager.removeSizeChangeCallback(this._ensureBackgroundPhotoFitsScreen);var a=this._activeController;if(a){var b={componentDeactivating:true,cancelable:false,preserveActiveItem:this._preserveActiveItem};a.beginDeactivate(b)}};a.postActivateUI=function(){this._registerTransientCommands();this._dataHub.activeItem.clear();var a=this._zoomButtons;if(a)a.enabled=true};a.lightweightSuspendCleanup=function(){if(this._deletePromise){this._suspending=true;this._deletePromise.cancel();this._site.updateCurrentlyDeleting(true)}};a.onActivatedAtSourcesView=function(a){this._activatedDeferral=a;this._loadBackgroundImage()};a.onResume=function(){this._suspending=false};a.setInitializationParameters=function(a){this._initParams=a};a.onFinishedLaunching=function(){return this._activeController.onInitialViewPlaceholderRenderComplete()};a.getEntranceAnimationInfo=function(e){var c=this._listViewContainerElement,d=this._headerContainerElement,g=this._sourcesViewBackgroundElement,a=PhotoViewer.Coordinator.Mode,j=[],i=e===a.oneUp||e===a.slideshow;if(i)j=[d,c];var f=PhotoViewer.AnimationHelpers.genericComponentAnimationInfoWithLayoutPos(j,c,"Collections","Entrance",true,this._getLayoutPosFn());if(!i){var k=this._activeController;if(e!==a.multiUpSlideshow)if(k)k.delayEntranceAnimation();else this._delayEntranceAnimationOnInit=true;d.style.visibility="hidden";c.style.visibility="hidden";var l=this;f.runCustomAnimation=function(b){b+=h.customAnimationDelay;d.style.visibility="visible";c.style.visibility="visible";if(e===a.multiUpSlideshow){var j=WinJS.UI.executeTransition(c,[{property:"opacity",delay:b,duration:500,timing:"linear",from:0,to:1},{property:"transform",delay:b,duration:500,timing:PhotoViewer.AnimationHelpers.pvlEaseOutCurve,from:"scale(0.9, 0.9)",to:"scale(1.0, 1.0)"}]);Jx.removeClass(g,"displayNone");var k=WinJS.UI.executeTransition(g,{property:"opacity",delay:b,duration:500,timing:"linear",from:0,to:1}),m=WinJS.UI.executeTransition(d,{property:"opacity",delay:b,duration:500,timing:"linear",from:0,to:1});return WinJS.Promise.join([j,k,m])}else{var f=l._activeController;if(Boolean(f)&&f.isActivated()){var i=n;if(e===a.none)i=p;WinJS.Promise.timeout(i).then(function(){f.isActivated()&&f.runEntranceAnimation()})}return WinJS.UI.Animation.enterContent([d])}}}f.actualMode=this._activeMode===b.filteredObjectsPuzzle?a.puzzle:a.megastrip;return f};a.getExitAnimationInfo=function(){var a=this._listViewContainerElement,d=this._headerContainerElement,f=this._sourcesViewBackgroundElement,c=PhotoViewer.AnimationHelpers.genericComponentAnimationInfoWithLayoutPos([d,a],a,"Collections","Exit",true,this._getLayoutPosFn());c.runCustomAnimation=function(){var b=WinJS.UI.executeTransition(a,[{property:"opacity",delay:h.customAnimationDelay,duration:167,timing:"linear",from:1,to:0},{property:"transform",delay:h.customAnimationDelay,duration:167,timing:PhotoViewer.AnimationHelpers.pvlEaseOutCurve,from:"scale(1.0, 1.0)",to:"scale(0.9, 0.9)"}]),c=WinJS.UI.executeTransition(f,{property:"opacity",delay:h.customAnimationDelay,duration:167,timing:"linear",from:1,to:0}),e=WinJS.UI.executeTransition(d,{property:"opacity",delay:h.customAnimationDelay,duration:167,timing:"linear",from:1,to:0});return WinJS.Promise.join([b,c,e])};var e=PhotoViewer.Coordinator.Mode;c.actualMode=this._activeMode===b.filteredObjectsPuzzle?e.puzzle:e.megastrip;return c};a.beginSemanticZoom=function(){var e=Boolean(this._curSeZo)&&this._curSeZo.seZoBouncing;if(!this._seZoInProgress&&!this._deactivating&&Boolean(this._activeMode)&&!e){this._seZoInProgress=true;var a=b.filteredObjectsPuzzle,c=b.filteredObjectsStrip,d=this._activeMode===a?c:a;this.activateMode(d,this._activeController.contentContainer,null)}};a.endSemanticZoom=function(a){if(this._seZoInProgress){var b=this._curSeZo.zoomedOut===a;this._seZoZoomCompleteCallback(b);this._seZoZoomCompleteCallback=null;this._seZoInProgress=false}};a.triggerZoom=function(i,f){if(!Jx.isNonEmptyString(this._activeMode)||this._seZoInProgress||this._activateModeInProgress)return j.wrap(false);var l=this._activeMode,k=l===b.filteredObjectsStrip;if(!f){var m=!(k&&i);this._activeController.setItemToZoomOn(m)}var e=this,a=this._curSeZo,h=this._dataHub;if(k)if(i){if(!Boolean(this._fileOpenPickerUI)&&Jx.isValidNumber(h.content.firstAssetPosition)){this._pinchZoomingToOneUp=true;f&&a.zoomedInZoomableProxy.setCurrentItem(f.x,f.y);return a.zoomedInZoomableProxy.getCurrentItem().then(function(i){var b=i.item.key,f;if(b)f=h.getObject(b);if(!Boolean(f)||g.isContainerType(f.type)){e._pinchZoomingToOneUp=false;return false}h.updateActiveItem(b);a.locked=true;e._zoomButtons.enabled=false;e._preserveActiveItem=true;try{e._site.doCommand(d.launchOneUp,c.CommandSurface.canvas,null,null)}finally{e._preserveActiveItem=false}return true})}}else{a.zoomedOut=true;this._updateZoomButtonsStateIfVisible(b.filteredObjectsPuzzle);return j.wrap(true)}else if(l===b.filteredObjectsPuzzle)if(i){a.zoomedOut=false;this._updateZoomButtonsStateIfVisible(b.filteredObjectsStrip);return j.wrap(true)}return j.wrap(false)};a._createControllerFromMode=function(f,d,a,e){if(!a.id){a.id="collections-"+f;a.setAttribute("aria-labelledby","collections-containerCounts");Jx.addClass(a,"collections-viewElement")}var c;switch(f){case b.filteredObjectsStrip:c=new PhotoViewer.FilteredObjectsStrip(this,d,a,e);break;case b.filteredObjectsPuzzle:c=new PhotoViewer.FilteredObjectsPuzzle(this,d,a,e);break;case b.sourcesStrip:c=new PhotoViewer.SourcesStrip(this,d,a,e);break;default:throw new Error("Unexpected mode: "+f)}return c};var t=function(a){return{initiallyZoomedOut:a,zoomedOutItem:function(a){a.groupKey=a.key;a.groupIndexHint=a.index;a.groupData=a.data;return a},zoomedInItem:function(a){a.groupSize=1;a.firstItemKey=a.key;a.firstItemIndexHint=a.index;return a},enableButton:false}},o=function(a){if(a){a.zoomedOutZoomableProxy&&a.zoomedOutZoomableProxy.shutdown();a.zoomedInZoomableProxy&&a.zoomedInZoomableProxy.shutdown();var b=a.zoomedInController;if(b){b.shutdown();a.zoomedInController=null}b=a.zoomedOutController;if(b){b.shutdown();a.zoomedOutController=null}}};a._loadBackgroundImage=function(){var g=this._sourcesViewBackgroundElement,a=this._sourcesViewBackgroundPhoto,d,h=this._site.applicationSettings.localSettingsContainer,c=h.get("useCustomBackground");if(Boolean(c)&&c>0)d="ms-appdata:///local/background.jpg?"+String(c);else d="/PhotoViewer/Images/defaultBackground.jpg";if(a.src===d)this._showElement(g,true);else{var b=this,f=function(){a.removeEventListener("load",f,true);a.removeEventListener("error",e,true);b._ensureBackgroundPhotoFitsScreen();if(b._activatedDeferral){b._activatedDeferral.complete();b._activatedDeferral=null}else b._showElement(g,true)},e=function(){if(c>0){h.set("useCustomBackground",0);a.src="/PhotoViewer/Images/defaultBackground.jpg"}else{a.removeEventListener("error",e,true);a.removeEventListener("load",f,true);a.src="";Jx.addClass(g,"displayNone")}};a.addEventListener("error",e,true);a.addEventListener("load",f,true);a.src=d}};a._showOrHideSourcesBackgroundImage=function(){var a=this._sourcesViewBackgroundElement;if(this._activeMode===b.sourcesStrip)this._loadBackgroundImage();else{if(this._activatedDeferral){this._activatedDeferral.complete();this._activatedDeferral=null}WinJS.UI.Animation.fadeOut(a).then(function(){Jx.addClass(a,"displayNone")})}};a._ensureBackgroundPhotoFitsScreen=function(){var b=document.body,a=this._sourcesViewBackgroundPhoto;u.scaleAndCenter(this._sourcesViewBackgroundPhoto,a.naturalWidth,a.naturalHeight,b.clientWidth,b.clientHeight,true)};a._initializeSeZoInfo=function(a,b,g){if(a.triggerSemanticZoom){a.seZoIsZoomedOut=this._curSeZo.zoomedOut;a.zoomedOutZoomableProxy=this._curSeZo.zoomedOutZoomableProxy;a.zoomedInZoomableProxy=this._curSeZo.zoomedInZoomableProxy;b.seZoProxy=a.seZoIsZoomedOut?a.zoomedInZoomableProxy:a.zoomedOutZoomableProxy;g.seZoProxy=a.seZoIsZoomedOut?a.zoomedOutZoomableProxy:a.zoomedInZoomableProxy;var d=b.seZoProxy.hostElement;if(!Jx.isNonEmptyString(d.id))d.id=b.viewElement.id;b.viewElement=d;b.viewElementWrapper=null}else{var c=document.createElement("div");Jx.addClass(c,"collections-viewElement");var e=a.createSeZoZoomedOut?b.viewElement:c,f=a.createSeZoZoomedOut?c:b.viewElement;a.zoomedOutZoomableProxy=new PhotoViewer.SeZoZoomableProxy(e,this);a.zoomedInZoomableProxy=new PhotoViewer.SeZoZoomableProxy(f,this);b.viewElementWrapper.appendChild(f);b.viewElementWrapper.appendChild(e)}};a._gatherElementsToAnimate=function(b,a){var d=b.viewElements,c=a.viewElements;if(b.header){d.push(b.header);a.header=this._curHeaderElement}a.header&&c.push(a.header);a.viewElement&&c.push(a.viewElement)};a._setUpSeZo=function(b,a){var c;if(!b.triggerSemanticZoom){var d=t(b.createSeZoZoomedOut);b.zoomedOutZoomableProxy.takeOverHostElement();b.zoomedInZoomableProxy.takeOverHostElement();c=a.seZo=new WinJS.UI.SemanticZoom(a.viewElementWrapper,d);this._hotPatchSeZo(a.seZo);a.viewElementWrapper.style.position="";a.seZo.zoomedOutZoomableProxy=b.zoomedOutZoomableProxy;a.seZo.zoomedInZoomableProxy=b.zoomedInZoomableProxy}else{a.seZoProxy.takeOverHostElement();c=this._curSeZo}if(b.createSeZoZoomedOut)c.zoomedOutController=a.controller;else c.zoomedInController=a.controller};var s=function(a,b){if(a){a.endDeactivate();a.shutdown();b&&b.releaseHostControl()}};a._onZoomOut=function(){this.triggerZoom(false)};a._onZoomIn=function(){this.triggerZoom(true)};a._getFinishModeSwitchCallback=function(d,b,c){var a=this;return function(j){try{Jx.log.info("Collections: Completing mode switch");if(d.triggerSemanticZoom&&j){var i=c.controller;i.cancelDeactivate();var g={componentDeactivating:false,cancelable:true,preserveActiveItem:false},h=b.controller;h.beginDeactivate(g);this._delayEntranceAnimationOnInit=false}else{if(b.header)a._curHeaderElement=b.header;a._curViewElement=b.viewElement;if(b.viewElementWrapper)a._curViewElementWrapper=b.viewElementWrapper;a._activeController=b.controller;a._activeMode=b.mode;if(a._delayEntranceAnimationOnInit){a._delayEntranceAnimationOnInit=false;a._activeController.delayEntranceAnimation()}b.viewElements&&b.viewElements.forEach(function(a){a.style.opacity="1.0"});c.header&&a._headerContainerElement.removeChild(c.header);!d.triggerSemanticZoom&&s(c.controller,c.seZoProxy);var f=Boolean(b.seZo)&&b.seZo!==c.seZo;if(f||!d.incomingViewUsesSeZo){if(c.viewElementWrapper){var e=c.viewElementWrapper.parentNode;e&&e.removeChild(c.viewElementWrapper)}a._curSeZo=b.seZo;if(a._curSeZo){var k=a._dataHub.content.size===0;if(k){a._curSeZo.locked=true;a._ensureHubContentChangedHandler()}a._activeController.getViewPortFullyRenderedPromise().then(function(){a._curSeZo===b.seZo&&a._createNonVisibleControllerForSeZo(d)})}o(c.seZo);if(a._zoomButtons){a._zoomButtons.shutdown();a._zoomButtons=null}if(f)a._zoomButtons=new l(b.viewElementWrapper,a._onZoomOut,a._onZoomIn,a._updateZoomButtonsState.bind(a),q,!c.mode)}a._showOrHideSourcesBackgroundImage()}}catch(m){}finally{a._activateModeInProgress=false;a._site.disableUserInput(false,true)}}};a.activateMode=function(r,j,e){if(this._activateModeInProgress){Jx.log.info("Collections::activateMode  - bailing early because of an in progress activateMode");return}var o=this._pendingActiveItemId;if(o){e=e||{};e.itemId=o;e.centerActiveItem=true;this._pendingActiveItemId=null}var d={},a={},c={};this._ensureSyncingContentTimerIsCleared();d.container=j;a.mode=r;c.mode=this._activeMode;Jx.log.info("Collections: Activate Mode. new mode: "+a.mode+"   outgoing mode: "+c.mode);var k=b.filteredObjectsPuzzle,n=b.filteredObjectsStrip;PhotoViewer.log.perf("evPhotoViewerCollections_RenderNewView_begin",{containerID:j.id,view:r,scrollPos:0});Boolean(e)&&e.recordNavStackEntry&&this._site.navStack.recordEntry();try{c.controller=this._activeController;d.sameContainer=Boolean(c.controller)&&g.doContainersMatch(c.controller.contentContainer,j);if(!d.sameContainer||!c.mode){this._showEmptyMessageForContainer(false,null,null);var p=a.header=this._createEmptyHeaderDOM();a.header.style.opacity="0.0";this._headerContainerElement.appendChild(p);this._updateStringsForContainer(p,j,false)}d.incomingViewUsesSeZo=a.mode===k||a.mode===n;var h=d.triggerSemanticZoom=d.sameContainer&&(a.mode===k&&c.mode===n||c.mode===k&&a.mode===n);d.createSeZoZoomedOut=a.mode===k;a.viewElementWrapper=document.createElement("div");Jx.addClass(a.viewElementWrapper,"collections-listViewWrapper");var q=document.createElement("div");a.viewElement=q;if(d.incomingViewUsesSeZo)this._initializeSeZoInfo(d,a,c);else a.viewElementWrapper.appendChild(q);a.viewElementWrapper&&this._listViewContainerElement.appendChild(a.viewElementWrapper);var m={componentDeactivating:false,cancelable:h,preserveActiveItem:false};if(!h)c.seZo=this._curSeZo;if(!h&&Boolean(c.seZo)){var i=c.seZo.zoomedInController;i&&i.beginDeactivate(m);i=c.seZo.zoomedOutController;i&&i.beginDeactivate(m)}else c.controller&&c.controller.beginDeactivate(m);var f;if(h){if(d.createSeZoZoomedOut)f=this._curSeZo.zoomedOutController;else f=this._curSeZo.zoomedInController;f&&f.cancelDeactivate()}if(!f){e=e||{};e.usingSeZo=d.incomingViewUsesSeZo;e.disableSelection=this._disableSelection;e.disableEntranceAnimation=!c.mode&&Boolean(a.mode);e.delayEntranceAnimation=!e.disableEntranceAnimation;f=this._createControllerFromMode(a.mode,j,a.viewElement,e)}a.controller=f;c.viewElement=this._curViewElement;if(a.viewElementWrapper)c.viewElementWrapper=this._curViewElementWrapper;if(!h){a.viewElements=[];c.viewElements=[];this._gatherElementsToAnimate(a,c)}this._site.disableUserInput(true,this._seZoInProgress);this._activateModeInProgress=true;this._updateAlbumDateToggleCommandForContainer(d.container);d.incomingViewUsesSeZo&&this._setUpSeZo(d,a,c);var l=this._getFinishModeSwitchCallback(d,a,c);if(h){Jx.log.info("Collections: Semantic Zoom navigation - outgoing mode: "+c.mode+"   incomingMode: "+a.mode);this._seZoZoomCompleteCallback=l}else if(!c.mode&&Boolean(a.mode)){Jx.log.info("Collections: Expect that an inter-view navigation will be triggered");l(false)}else if(c.mode&&a.mode){Jx.log.info("Collections: Triggering an intra-view navigation.");this._animateActivateMode(a.viewElements,c.viewElements,l,a)}else{Jx.log.info("Collections: Unknown navigation");l(false)}}catch(s){if(this._activateModeInProgress){this._site.disableUserInput(false,true);this._activateModeInProgress=false}this._goBackIfNotFoundOrRethrow(s)}};a._animateActivateMode=function(a,f,b,c){if(!this._site.disableAnimations){Jx.log.info("Collections: Triggering intra-collections animation");var d=this._site.animationRefCountedPromise;d.addRef();var g=WinJS.UI.Animation.exitPage(f,null).then(function(){Jx.log.info("Collections: Intra-collections animation complete. Finishing up with mode switch...");for(var f,g=a.length,d=0;d<g;d++){f=a[d];f.style.opacity="1.0"}b(false);if(c&&c.controller){var e=c.controller;WinJS.Promise.timeout(n).then(function(){e.isActivated()&&e.runEntranceAnimation()})}return WinJS.UI.Animation.enterContent(a,null)},function(){Jx.log.info("Collections: Intra-collections animation error. Finishing up with mode switch...");b(false)}),e=function(){d.decRef()};g.done(e,e)}else b(false)};a._hotPatchSeZo=function(c){var b=this,a=c._playBounce;if(a){a=a.bind(c);c._playBounce=function(e,f){var d=b._curSeZo;if(!d)return;if(c!==d||b._deactivating||b._pinchZoomingToOneUp||!Boolean(b._activeController)||b._activateModeInProgress)return;if(!(Boolean(d.zoomedInController)&&d.zoomedInController.isActivated())&&!(Boolean(d.zoomedOutController)&&d.zoomedOutController.isActivated()))return;if(!d.zoomedOut)if(d.seZoBouncing){a(e,f);d.seZoBouncing=e}else e&&b.triggerZoom(true,f).done(function(b){if(!b){d.seZoBouncing=true;a(e,f)}});else{if(e)d.seZoBouncing=e;a(e,f);if(!e)d.seZoBouncing=e}}}};a._createNonVisibleControllerForSeZo=function(g){var a=this._curSeZo,f={deactivated:true,usingSeZo:true,disableSelection:this._disableSelection,disableEntranceAnimation:true,delayEntranceAnimation:false},c,d,e=g.container;if(!a.zoomedInController){c=a.zoomedInZoomableProxy.hostElement;d=this._createControllerFromMode(b.filteredObjectsStrip,e,c,f);a.zoomedInController=d}else if(!a.zoomedOutController){c=a.zoomedOutZoomableProxy.hostElement;d=this._createControllerFromMode(b.filteredObjectsPuzzle,e,c,f);a.zoomedOutController=d}};a.getNavId=function(){return"Collections"};a.getNavState=function(){var a=this._activeController;return!a?null:{mode:this._activeMode,scrollbarPosition:a.scrollbarPosition,focusedIndex:a.focusedIndex}};a.setNavState=function(a,f){a=a||{mode:b.sourcesStrip,scrollbarPosition:0,focusedIndex:0};if(!this.hasUI())this._pendingNavState=a;else{var g={noActivateMode:true};this._activateDataSource(g);var c,e=PhotoViewer.Coordinator.Mode,h=f===e.oneUp||f===e.openWith,d=this._dataHub.activeItem;if(h&&d.size===1)c={itemId:d.idAt(0),centerActiveItem:true};else c={scrollbarPosition:a.scrollbarPosition,itemIndex:a.focusedIndex};var i=this._dataHub.contentContainer;this.activateMode(a.mode,i,c);this._pendingNavState=null}return j.wrap(true)};a.clearNavState=function(){this._pendingNavState=null};a.setActiveItemId=function(a){if(this._activeController)this._activeController.setActiveItemId(a);else this._pendingActiveItemId=a};Object.defineProperty(a,"dataHub",{"get":function(){return this._dataHub}});Object.defineProperty(a,"coordinator",{"get":function(){return this._site}});Object.defineProperty(a,"id",{"get":function(){return this._id}});a._registerPersistentCommands=function(){this._albumDateToggleHandler=this._albumDateToggleHandler.bind(this);var a=this._site;a.beginBatchCommandingUpdate();a.addCommand(d.albumDateToggle,c.CommandEnableProperties.viewIsMultiUp|c.CommandEnableProperties.justBelowSourcesView|c.CommandEnableProperties.sourceAllowsDateToggle,c.CommandEnableProperties.none,c.CommandEnableProperties.none,c.ExpectedActionableItems.content,true,this._albumDateToggleHandler);a.setCommandStage(d.albumDateToggle,d.viewByDate);a.endBatchCommandingUpdate()};a._registerTransientCommands=function(){this._deleteSelectedAssets=this._deleteSelectedAssets.bind(this);this._site.addCommand(d.deleteCmd,c.CommandEnableProperties.viewIsMultiUp|c.CommandEnableProperties.selectionExists|c.CommandEnableProperties.sourceAllowsDelete,c.CommandEnableProperties.none,c.CommandEnableProperties.none,c.ExpectedActionableItems.selection,true,this._deleteSelectedAssets)};a._activateDataSource=function(d){var j=!Jx.isNonEmptyString(this._activeMode),g=Boolean(d)&&d.forceReset,i=j||g;if(g)this._dataHub.contentContainer=this._dataHub.createRootContainer();if(i)if(!(this._site.navStack.navigating||Boolean(d)&&d.noActivateMode)){var a=this._initParams,k=Boolean(a)&&a.outgoingMode===PhotoViewer.Coordinator.Mode.oneUp,f=this._dataHub.contentContainer,c,e;if(Jx.isNonEmptyString(f.searchQuery)&&a.commandName!==PhotoViewer.AppBar.Commands.returnToMegastripFromOneUp)c=b.filteredObjectsPuzzle;else if(k){c=b.filteredObjectsStrip;var h=this._dataHub.activeItem;e={itemId:h.idAt(0),centerActiveItem:true}}else{if(f.type==="container.root")c=b.sourcesStrip;else c=b.filteredObjectsStrip;if(Boolean(a)&&Boolean(a.activeItemId))e={itemId:a.activeItemId,centerActiveItem:true}}this.activateMode(c,f,e)}};a._createEmptyHeaderDOM=function(){var e=document.createElement("div");e.className="collections-header-wrapper";var a=document.createElement("header");a.className="collections-header photoViewer-header";var b=document.createElement("div");b.setAttribute("role","heading");b.id="collections-containerTitle";b.className="collections-containerTitle photoViewer-headerPrimaryText";var g=document.createElement("div");g.id="collections-containerScope";g.className="collections-containerScope photoViewer-headerSecondaryText";var f=document.createElement("div");f.id="collections-containerCounts";f.className="collections-containerCounts photoViewer-headerSecondaryText";var d=document.createElement("div");d.id="collections-containerSourceStatus";d.className="collections-containerSourceStatus photoViewer-headerSecondaryText error";var c=document.createElement("a");c.className="collections-searchAllHeaderLink photoViewer-headerSecondaryText";c.setAttribute("href","#");a.appendChild(b);a.appendChild(g);a.appendChild(f);a.appendChild(d);a.appendChild(c);e.appendChild(a);return e};a._updateStringsForContainer=function(n,h,d){var c=this,q=n.getElementsByClassName("collections-header")[0];if(!q)return;var k={"collections-containerTitle":true,"collections-containerScope":true,"collections-containerCounts":true,"collections-containerSourceStatus":true,"collections-searchAllHeaderLink":true},a=function(b,d,e){delete k[b];var a=q.getElementsByClassName(b)[0];if(Jx.isNonEmptyString(d)){a.innerText=d;if(e)c._hideElement(a);else c._showElement(a,true)}else{a.innerText="";c._hideElement(a)}return a},o=h.searchQuery,j=Jx.isNonEmptyString(o),l=h.type,b=l==="container.root",p=l==="container.source",e=this._fileOpenPickerUI,f=["sourceTitle"];(j||!b)&&f.push("assetCount");!j&&f.push("containerCount","hasSyncedContent","sourceStatus","errorResult");!d&&f.push("title");h.getProperties(f,function(s,f,G){if(!c._hasUI||!n.parentNode)return;var x=Jx.res,h;if(j){if(!d){var F=x.loadCompoundString("resid-search-titleFormat",o);a("collections-containerTitle",F)}var l=g.tryLookupPropertiesInMap(f,["sourceTitle","assetCount"]);if(l){var y=l.assetCount,r=parseInt(y,10),D="resid-search-scope"+(r===1?"_1_Fmt":"_N_Fmt"),z=m.formatInteger(r),E=x.loadCompoundString(D,z,l.sourceTitle);a("collections-containerScope",E);h=r===0;PhotoViewer.log.perf("evSearch_SearchHeadersRendered",{emptyValue:true})}}else{if(!d){var q=g.tryLookupPropertyInMap(f,"title");if(Boolean(e)&&(b||p))e.title=b?"":q;else a("collections-containerTitle",q,b)}if(G){var A=Boolean(f.lookup("hasSyncedContent")),u=f.lookup("sourceStatus"),v=f.lookup("errorResult"),t=parseInt(f.lookup("containerCount"),10),w=b?0:parseInt(f.lookup("assetCount"),10);h=t===0&&w===0;if(!b&&!d){var k=f.lookup("sourceTitle");if(e){if(!p)e.title=k}else a("collections-containerScope",k===q?"":k)}if(!i.hasError(u,v)){a("collections-containerSourceStatus","");var C=b||h&&!A?"":m.getCountString(t,w);a("collections-containerCounts",C)}else{a("collections-containerCounts","");if(h)a("collections-containerSourceStatus","");else{var B=a("collections-containerSourceStatus",i.getInlineError(u,v));B.addEventListener("MSPointerUp",function(a){i.showErrorFlyout(a.target,s,c._dataHub)},false)}}}}Jx.isBoolean(h)&&c._showEmptyMessageForContainer(h,s,f)});this._ensureContainerChangedHandler(h);if(!d)for(var r in k)a(r,"")};a._updateAlbumDateToggleCommandForContainer=function(g){var a=this._site,b=g.type==="container.source";if(b){var h=g.shape,f;switch(h){case e.ContainerShape.byAlbum:f=d.viewByDate;break;case e.ContainerShape.byDate:f=d.viewByAlbum}a.beginBatchCommandingUpdate();a.setCommandStage(d.albumDateToggle,f)}a.setCommandPropertyState(c.CommandEnableProperties.justBelowSourcesView,b);b&&a.endBatchCommandingUpdate()};a._albumDateToggleHandler=function(c){var a;switch(c){case d.viewByAlbum:a=e.ContainerShape.byAlbum;break;case d.viewByDate:a=e.ContainerShape.byDate}var b=this._dataHub.getObject(this._activeController.contentContainer.id);b.shape=a;this.activateMode(this._activeMode,b)};a._updateZoomButtonsState=function(a){if(!a)a=this._activeMode;switch(a){case b.filteredObjectsPuzzle:this._zoomButtons.setState(l.State.zoomInOnly);break;case b.filteredObjectsStrip:var c=Jx.isValidNumber(this._dataHub.content.firstAssetPosition);this._zoomButtons.setState(c?l.State.both:l.State.zoomOutOnly)}};a._updateZoomButtonsStateIfVisible=function(b){var a=this._zoomButtons;a&&a.visible&&this._updateZoomButtonsState(b)};a._deleteSelectedAssets=function(o,n){PhotoViewer.log.perf("evPhotoViewerCommanding_Delete_Start",{emptyValue:true});var a=this,l=false,f=null,b=null,e=false,k=this._activeController,g,c;k.stopHandlingNotifications();var j=function(){l=true;k.resumeHandlingNotifications();if(f){window.clearTimeout(f);f=null}d();PhotoViewer.log.perf("evPhotoViewerCommanding_Delete_Stop",{emptyValue:true})},d=function(){if(l)if(e)!b&&g.cancel();else{a._site.updateCurrentlyDeleting(false);if(c>0&&!a._suspending)if(c===1)new Windows.UI.Popups.MessageDialog(Jx.res.getString("resid-delete-DeleteSingleFailureMessage"),Jx.res.getString("resid-delete-DeleteSingleItemFailureTitle")).showAsync().done();else{var d=m.formatInteger(c);new Windows.UI.Popups.MessageDialog(Jx.res.getString("resid-delete-DeleteMultiFailureMessage"),Jx.res.loadCompoundString("resid-delete-DeleteMultiItemFailureTitleFmt",d)).showAsync().done()}}};this._site.updateCurrentlyDeleting(true);this._deletePromise=n.executeAsync("deleteAssets",null);this._deletePromise.then(function(b){c=b;j();a._deletePromise=null},function(){if(a._suspending)b=null;j();a._deletePromise=null});var h=new Windows.UI.Popups.MessageDialog("",Jx.res.getString("resid-delete-DeleteProgressString"));h.commands.append(new Windows.UI.Popups.UICommand(Jx.res.getString("resid-delete-DeleteCancelButton"),function(){b=null;a._deletePromise&&a._deletePromise.cancel()}));h.cancelCommandIndex=0;g=h.showAsync();var i=function(){e=false;d()};e=true;g.then(i,i);b=window.setTimeout(function(){b=null;d()},1e3);return null};a._ensureHubContentChangedHandler=function(){if(!this._hubContentChangedRegistrar){var a=this._dataHub.content;a.addEventListener("changed",this._hubContentChangedHandler);this._hubContentChangedRegistrar=a}};a._hubContentChangedHandler=function(){if(this._curSeZo)this._curSeZo.locked=this._dataHub.content.size===0};a._ensureContainerChangedHandler=function(a){var b=this._containerChangedRegistrar,d=b?b.id:null,c=a?a.id:null;if(d!==c){b&&b.removeEventListener("changed",this._containerChangedEventHandler);a&&a.addEventListener("changed",this._containerChangedEventHandler);this._containerChangedRegistrar=a}};a._containerChangedEventHandler=function(c){var b=c.target,a=c.detail[0];if(Boolean(this._activeController))try{if(a.type===e.ObjectChangedEventType.modified&&Boolean(a.fields&(e.ObjectChangedEventFields.other|e.ObjectChangedEventFields.subAlbumCount)))this._updateStringsForContainer(this._curHeaderElement,b,true);else a.type===e.ObjectChangedEventType.removed&&this._goBack()}catch(d){this._goBackIfNotFoundOrRethrow(d)}else{b.removeEventListener("changed",this._containerChangedEventHandler);if(Boolean(this._containerChangedRegistrar)&&this._containerChangedRegistrar.id===b.id)this._containerChangedRegistrar=null}};a._showEmptyMessageForContainer=function(x,c,l){var e=document.getElementById("collections-emptyMessageContainer"),q=this._listViewContainerElement,d=this;if(x){var n=c.type,h=document.getElementById("collections-emptyMessageTextLine1"),b=document.getElementById("collections-emptyMessageTextLine2"),o=false,w=Jx.isNonEmptyString(c.searchQuery),k=l.lookup("sourceTitle"),a=Jx.res;if(w)if(c.sourceType===f.picturesLibrary){h.innerText=a.getString("resid-search-emptyLocalSearchMessageLine1");b.innerText=a.getString("resid-search-emptyLocalSearchMessageLine2")}else{h.innerText=a.loadCompoundString("resid-search-emptyRemoteSearchMessageLine1Fmt",k);b.innerText=""}else if(n==="container.root"){h.innerText="";b.innerText=a.getString("residEmptySourceMessage_EmptySourceView")}else{var p=false,v=Boolean(l.lookup("hasSyncedContent")),s=l.lookup("sourceStatus"),t=l.lookup("errorResult");if(i.hasError(s,t)){h.innerText=Jx.res.loadCompoundString("residErrorSourceUnavailableHeaderFmt",k);var m=i.getErrorFlyoutSpecification(s,t,this._dataHub,c,k);if(m.innerText)b.innerText=m.innerText;else if(m.innerHTML)b.innerHTML=m.innerHTML}else if(!v){h.innerText=a.getString("residCurrentlySyncingContent");var u=a.getString("residCurrentlySyncingContent-extraInfo");if(!this._showingEmptyMessageContainer||b.innerText!==u){o=true;b.innerText="";if(!this._currentlySyncingContentTimer)this._currentlySyncingContentTimer=setTimeout(function(){d._currentlySyncingContentTimer=0;if(!Jx.hasClass(e,"displayNone")&&g.doContainersMatch(c,d._dataHub.contentContainer)){b.innerText=u;WinJS.UI.Animation.fadeIn(b)}},5e3)}}else p=true;if(p){h.innerText=a.getString("residEmptyContainerMessage");var j="";if(n==="container.source")switch(c.sourceType){case f.picturesLibrary:case f.storage:j=a.getString("residEmptySourceMessage_PicturesLibrary");break;case f.skyDrive:j=a.getString("residEmptySourceMessage_SkyDrive");break;case f.device:j=a.loadCompoundString("residEmptySourceMessage_Device",k);break;case f.genericDevice:j=a.getString("residEmptySourceMessage_GenericDevice");break;case f.phone:case f.camera:break;default:j=a.getString("residEmptySourceMessage_Service")}b.innerHTML=j}}if(n==="container.root")Jx.addClass(e,"collections-emptySourcesView");else Jx.removeClass(e,"collections-emptySourcesView");!this._showingEmptyMessageContainer&&WinJS.Promise.timeout(r).then(function(){if(d._showingEmptyMessageContainer){d._showElement(e,false);WinJS.UI.Animation.enterContent(e)}});this._hideElement(q);!o&&this._ensureSyncingContentTimerIsCleared();this._showingEmptyMessageContainer=true}else if(this._showingEmptyMessageContainer){this._hideElement(e);this._showElement(q,false);c&&setTimeout(function(){d._curSeZo&&d._curSeZo.forceLayout();d._activeController.forceLayout()},20);this._showingEmptyMessageContainer=false}};a._ensureSyncingContentTimerIsCleared=function(){if(this._currentlySyncingContentTimer){clearTimeout(this._currentlySyncingContentTimer);this._currentlySyncingContentTimer=0}};a._getLayoutPosFn=function(){var a=this;return function(d,b){var c=a._activeController.getItemInViewAsync(d);return c.then(function(a){return a?PhotoViewer.ViewHelpers.getLayoutPosInElement(a,b):null})}};a._showElement=function(a,c){var b=Jx.removeClass(a,"displayNone");b&&c&&WinJS.UI.Animation.fadeIn(a)};a._hideElement=function(a){Jx.addClass(a,"displayNone")};a._goBack=function(){this._site.doCommand(d.navigateBack,c.CommandSurface.canvas,null,null)};a._goBackIfNotFoundOrRethrow=function(a){if(a.number===g.HResults.objectNotFoundError)this._goBack();else{Jx.promoteOriginalStack(a);throw a}};a._hubContentChangedRegistrar=null;a._containerChangedRegistrar=null;a._activeMode=null;a._activeController=null;a._pendingNavState=null;a._showingEmptyMessageContainer=false;a._initParams=null;a._preserveActiveItem=false;a._deactivating=false;a._activateModeInProgress=false;a._disableSelection=false;a._pendingActiveItemId=null;a._currentlySyncingContentTimer=0;a._activatedDeferral=null;a._delayEntranceAnimationOnInit=false;a._curViewElementWrapper=null;a._curHeaderElement=null;a._curViewElement=null;a._headerContainerElement=null;a._listViewContainerElement=null;a._sourcesViewBackgroundElement=null;a._sourcesViewBackgroundPhoto=null;a._curSeZo=null;a._seZoInProgress=false;a._seZoZoomCompleteCallback=null;a._zoomButtons=null;a._pinchZoomingToOneUp=false;a._fileOpenPickerUI=null;a._deletePromise=null;a._suspending=false})()