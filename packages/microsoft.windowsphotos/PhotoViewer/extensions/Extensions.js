(function(){var e=WindowsLive.Photo.Viewer.DataModel,b=e.ObjectCollectionChangedEventType,f=PhotoViewer.DataHubHelpers;PhotoViewer.FileOpenPickerExtension=function(a,b){this._site=a;this._dataHub=b;this._fileOpenPickerUI=a.fileOpenPickerUI;this._pickerSelection={};this._bindSelection()};var c=PhotoViewer.FileOpenPickerExtension,a=PhotoViewer.FileOpenPickerExtension.prototype,d=40;c.getFilenameForPicker=function(a){return new WinJS.Promise(function(b){a.getProperties(["filename"],function(d,f){var a=f.lookup("filename"),c=a.lastIndexOf(".");if(c===-1){var g=d.type;switch(g){case"asset.video":a+=".mp4";break;case"asset.photo":a+=".jpg"}}if(d.sourceType!=="PicturesLibrary")if(d.type==="asset.photo"){var e=a.substr(c).toLowerCase();if(e!==".jpg"&&e!==".jpeg")a=a.slice(0,c)+".jpg"}b(a)})})};a.shutdown=function(){if(this._hubSelection){this._hubSelection.removeEventListener("changed",this._hubSelectionChangedHandler);this._hubSelection=null}if(this._fileOpenPickerUI){var b=this,a=this._fileOpenPickerUI;msSetImmediate(function(){a.removeEventListener("fileremoved",b._pickerFileRemovedHandler)});this._fileOpenPickerUI=null}};a._bindSelection=function(){this._hubSelectionChangedHandler=this._hubSelectionChangedHandler.bind(this);var a=this._dataHub.selection;a.addEventListener("changed",this._hubSelectionChangedHandler);this._hubSelection=a;this._pickerFileRemovedHandler=this._pickerFileRemovedHandler.bind(this);this._fileOpenPickerUI.addEventListener("fileremoved",this._pickerFileRemovedHandler);this._pullSelectionFromHub()};a._hubSelectionChangedHandler=function(j){var k=j.target,i=j.detail[0];if(this._changingHubSelection)return;var n,d=false,e=[],a,c;for(a=0,c=i.length;a<c&&!d;a++){var g=i[a];switch(g.type){case b.added:for(var h=g.position,m=g.count,f=h;f<h+m;f++){var l=k.idAt(f);e.push(l)}break;case b.removed:case b.reset:d=true}}if(d)this._pullSelectionFromHub();else for(a=0,c=e.length;a<c;a++)this._addFileToPicker(e[a])};a._addFileToPicker=function(g){var h=this,l=this._dataHub,a=l.getObject(g),k=new WinJS.Promise(function(b){a.getThumbnailAsync(d,d,null,false).done(function(a){b(a)},function(){b(null)})}),j=c.getFilenameForPicker(a),b,i=function(c){var d=function(a){if(a){Jx.log.error("FileOpenPickerExtension: Failed to fulfill streamed file data request: "+a);c.failAndClose(Windows.Storage.StreamedFileFailureMode.failed)}else c.close()};a.getMediaAsync(e.GetMediaAsyncFlags.oneUpSizeForRemotePhotos).then(function(a){return f.getStreamFromBlobOperationResult(a,b)}).then(function(a){return Windows.Storage.Streams.RandomAccessStream.copyAsync(a,c)}).done(function(){d()},d)};WinJS.Promise.join({thumb:k,filename:j}).then(function(d){var a=d.thumb;b=d.filename;var c=null;if(a)if(a.data)c=Windows.Storage.Streams.RandomAccessStreamReference.createFromStream(a.data);return Windows.Storage.StorageFile.createStreamedFileAsync(b,i,c)}).then(function(b){var a=h._fileOpenPickerUI.addFile(g,b);if(a===Windows.Storage.Pickers.Provider.AddFileResult.added)h._pickerSelection[g]=true})};a._pullSelectionFromHub=function(){var b=this._hubSelection,d=this._pickerSelection,e=this._fileOpenPickerUI,a;for(a in d)if(!Jx.isValidNumber(b.lookup(a))){this._removingPickerSelection=true;try{e.removeFile(a);delete this._pickerSelection[a]}finally{this._removingPickerSelection=false}}for(var c=0,f=b.size;c<f;c++){a=b.idAt(c);!d[a]&&this._addFileToPicker(a)}};a._pickerFileRemovedHandler=function(b){var a=b.id;delete this._pickerSelection[a];if(!this._removingPickerSelection){this._changingHubSelection=true;try{this._hubSelection.remove(a)}finally{this._changingHubSelection=false}}};a._site=null;a._dataHub=null;a._fileOpenPickerUI=null;a._hubSelection=null;a._pickerSelection=null;a._changingHubSelection=false;a._removingPickerSelection=false})()