Share.Preview=function(n,t){if(this.constructor!==Share.Preview)throw new Error("Share.Preview is a constructor; it must be called using new.");if(!n||!Jx.isNonEmptyString(n.url))throw new Error("Share.Preview requires a linkData parameter with url set");this._imgArray=[];this.initComponent();this._soxeUrl=t;this._id="sharePreview";this._linkData=n;this._soxePromise=null};Jx.augment(Share.Preview,Jx.Component);Jx.augment(Share.Preview,Jx.Events);Share.Preview.prototype.activateUI=function(){var n,t;if(this.constructor!==Share.Preview)throw new Error("activateUI references this; use bind if you cache this method.");Jx.Component.prototype.activateUI.call(this);this._uiInitialized||(this._uiInitialized=true,n=Share.Preview.prototype,this._cancelHandler=n._cancelHandler.bind(this),this.pageHandler=n.pageHandler.bind(this),this._imgOnLoadEvent=n._imgOnLoadEvent.bind(this),this._errorLoadingImage=n._errorLoadingImage.bind(this),this._soxeComplete?this._hasSoxeData?this._renderWithSoxeData():this._noSoxeDataRender():(t=document.getElementById("sharePVClose"),t&&t.addEventListener("click",this._cancelHandler,false)))};Share.Preview.prototype.setAuth=function(n){var t,i,r,u;this._soxeComplete||Boolean(this._soxePromise)||(t=n,i=Microsoft.WindowsLive.Market.get(Microsoft.WindowsLive.FallbackLogic.language),Jx.isNonEmptyString(t)&&Jx.isNonEmptyString(this._linkData.url)?(Jx.log.verbose("SharePreview: using auth ticket to start SOXE call"),this._soxePromise=Share.SOXE.beginSOXERequest(this._linkData.url,t,this._soxeUrl,i),r=this._soxeCallback.bind(this),u=this._soxeErrorCallback.bind(this),this._soxePromise.then(function(n){msSetImmediate(r,n)},function(n){msSetImmediate(u,n)})):(Jx.fault("ShareAnything.SharePreview.NoLinkData","NoSoxeAuth"),this._soxeComplete=true,this.hasUI()&&this._noSoxeDataRender()))};Share.Preview.prototype.deactivateUI=function(){if(this.constructor!==Share.Preview)throw new Error("deactivateUI references this; use bind if you cache this method.");if(this._soxePromise&&(this._soxePromise.cancel(),this._soxePromise=null),this._uiInitialized){this._cleanupFlipView();var n=document.getElementById("sharePVClose");n&&n.removeEventListener("click",this._cancelHandler,false);this._cancelHandler=null;this._uiInitialized=false}Jx.Component.prototype.deactivateUI.call(this)};Share.Preview.prototype.isVisible=function(){return this._previewVisible};Share.Preview.prototype.focus=function(){var n=document.getElementById("share-pvFlipView");n&&n.focus()};Share.Preview.prototype._cleanupFlipView=function(){var t,n;if(this._imgArray){for(t=this._imgArray.length,n=0;n<t;n++)this._imgArray[n].removeEventListener("load",this._imgOnLoadEvent,false),this._imgArray[n].removeEventListener("error",this._errorLoadingImage,false);this._imgArray=null}Jx.isNullOrUndefined(this._flipView)||this._flipView.removeEventListener("pageselected",this.pageHandler,false);this._flipView=null;this._leftArrow=null;this._rightArrow=null;this._list=null;this._imgOnLoadEvent=null;this._errorLoadingImage=null;this.pageHandler=null};Share.Preview.prototype.getUI=function(n){n.html=ShareAnything.Templates.sharePreview()};Share.Preview.prototype.hide=function(){Boolean(this._flipView)&&this._flipView.currentPage===this._currentFlipperCount-1&&(this._wasOnLastPageForHide=true);document.getElementById(this._id).style.display="none"};Share.Preview.prototype.show=function(){document.getElementById(this._id).style.display="";this._flipView&&(this._flipView.forceLayout(),this._wasOnLastPageForHide&&(this._wasOnLastPageForHide=false,this._flipView.currentPage=this._currentFlipperCount-1))};Share.Preview.prototype._initializeFlipper=function(){var i=document.getElementById("share-pvFlipView"),t,r,n;for(WinJS.UI.processAll(i),this._flipView=i.winControl,this._flipView.itemTemplate=this._renderer,this._flipView.addEventListener("pageselected",this.pageHandler,false),t=i.getElementsByTagName("button"),r=t.length,n=0;n<r;n++)t[n].className==="win-navbutton win-navright"?(this._rightArrow=t[n],this._rightArrow.id="pvRightArrow"):t[n].className==="win-navbutton win-navleft"&&(this._leftArrow=t[n],this._leftArrow.id="pvLeftArrow");this._list=new WinJS.Binding.List([this._noImageSlide,this._noImageSlide],{binding:true});this._flipView.itemDataSource=this._list.dataSource;this._currentFlipperCount=2;this._startImageLoading()};Share.Preview.prototype.pageHandler=function(){this._flipViewInitialized||(this._flipViewInitialized=true);Jx.isRtl()?this._flipView.currentPage===0?(this._leftArrow.className="win-navbutton win-navleft",this._rightArrow.className="win-navbutton win-navright rightNotVisible"):this._flipView.currentPage===this._currentFlipperCount-1?(this._rightArrow.className="win-navbutton win-navright",this._leftArrow.className="win-navbutton win-navleft leftNotVisible"):(this._rightArrow.className="win-navbutton win-navright",this._leftArrow.className="win-navbutton win-navleft"):this._flipView.currentPage===0?(this._leftArrow.className="win-navbutton win-navleft leftNotVisible",this._rightArrow.className="win-navbutton win-navright"):this._flipView.currentPage===this._currentFlipperCount-1?(this._rightArrow.className="win-navbutton win-navright rightNotVisible",this._leftArrow.className="win-navbutton win-navleft"):(this._rightArrow.className="win-navbutton win-navright",this._leftArrow.className="win-navbutton win-navleft");this._checkShowFlipView()};Share.Preview.prototype._cancelHandler=function(){Jx.log.info("Share.Preview: cancel click handler");!this._soxeComplete&&Boolean(this._soxePromise)&&(this._soxePromise.cancel(),this._soxePromise=null,this._soxeCancelled=true);this._noSoxeDataRender()};Share.Preview.prototype.getData=function(){var n;if(!Jx.isNullOrUndefined(this._flipView))if(n=this._list.getItem(this._flipView.currentPage),Jx.isNullOrUndefined(n.data.img))this._linkData.thumbnailUrl="";else{var t=0,i=0,r=n.data.img.width,u=n.data.img.height,f=Share.Constants.previewImageHeight,e=Share.Constants.previewImageWidth;r/u>=e/f?(t=e,i=t*u/r):(i=f,t=i*r/u);this._linkData.thumbnailUrl=n.data.img.src;this._linkData.imgHeight=i.toString();this._linkData.imgWidth=t.toString()}return this._linkData};Share.Preview.prototype._imgOnLoadEvent=function(n){var t=n.target,u=t===this._imgArray[0];u&&(this._thumbnailLoaded=true);var i=t.width,r=t.height,f=Share.Constants.minImageSize,e=Share.Constants.maxImageSize,o=i>=f&&i<=e&&r>=f&&r<=e,s=(i>r?i/r:r/i)<=Share.Constants.maxImageRatio,h=this._linkData.isDirectImage&&u;h||o&&s?(t.flipViewReady=true,this._imageSuccessCount++,this._previewVisible&&this._addSingleImageToFlipView(t)):this._imageErrorCount++;this._checkShowFlipView()};Share.Preview.prototype._addAllToFlipView=function(){var t,i,n;for(Jx.log.verbose("Share.Preview._addAllToFlipView"),t=this._imgArray,i=t.length,n=0;n<i;n++)t[n].flipViewReady&&(this._addToFlipViewHelper(t[n]),this._imageCount++);this._flipView.itemDataSource.beginEdits();this._list.push(this._noImageSlide);this._flipView.itemDataSource.endEdits();this._flipView.next();this._currentFlipperCount=this._imageCount+2};Share.Preview.prototype._addSingleImageToFlipView=function(n){this._addToFlipViewHelper(n);this._flipView.itemDataSource.beginEdits();this._list.push(this._noImageSlide);this._flipView.itemDataSource.endEdits();this._imageCount++;this._currentFlipperCount=this._imageCount+2};Share.Preview.prototype._addToFlipViewHelper=function(n){var t={type:"SOXEImage",img:n};this._flipView.itemDataSource.beginEdits();this._list.setAt(this._imageCount+1,t);this._flipView.itemDataSource.endEdits()};Share.Preview.prototype._replacePreview=function(n){var r=document.getElementById(this._id),t=document.getElementById("hiddenSharePreview"),i;Jx.isNullOrUndefined(t)||(r.removeChild(t),t.id=this._id,t.className="share-preview",t.setAttribute("aria-hidden","false"),r.parentNode.replaceChild(t,r),n?(i=document.getElementById(this._imageId),Jx.isNullOrUndefined(i)||(i.parentNode.removeChild(i),this._cleanupFlipView())):this._addAllToFlipView(),this._previewVisible=true,Jx.log.verbose("Share.Preview firing SOXE complete event"),this.raiseEvent("soxeComplete"),WinJS.UI.Animation.fadeIn(t))};Share.Preview.prototype._soxeCallback=function(n){this.isShutdown()||(Jx.log.verbose("Share.Preview successfully retrieved SOXE data"),this._soxePromise=null,this._soxeComplete=true,this._hasSoxeData=true,this._linkData.populateSoxeData(n),this.hasUI()&&this._renderWithSoxeData())};Share.Preview.prototype._soxeErrorCallback=function(n){this.isShutdown()||(Jx.fault("ShareAnything.SharePreview.NoLinkData","SoxeError",n),this._soxePromise=null,this._soxeComplete=true,this.hasUI()&&!this._soxeCancelled&&this._noSoxeDataRender())};Share.Preview.prototype._renderWithSoxeData=function(){if(this._imageTotal=this._linkData.images.length,this._linkData.images.length===0)this._renderPreview(true),this._replacePreview(true);else{this._renderPreview(false);var n=document.getElementById(this._imageId);n.innerHTML='<div id="share-pvFlipView" class="flipView" data-win-control="WinJS.UI.FlipView"><\/div>';this._initializeFlipper()}};Share.Preview.prototype._startImageLoading=function(){for(var t=this._linkData.images.length,n=0;n<t;n++)this._imgArray[n]=document.createElement("img"),this._imgArray[n].addEventListener("load",this._imgOnLoadEvent,false),this._imgArray[n].addEventListener("error",this._errorLoadingImage,false),this._imgArray[n].src=this._linkData.images[n];this._imagesArrayCreated=true};Share.Preview.prototype._renderPreview=function(n){var f=document.getElementById("hiddenSharePreview"),r,u,t,i;Jx.isNullOrUndefined(f)||this._renderedPreview||(r="",Jx.isNonEmptyString(this._linkData.title)&&this._linkData.title!==this._linkData.url&&(r="<div class='singleLineText' id='shareTitle'>"+Jx.escapeHtml(this._linkData.title)+"<\/div>"),u="",Jx.isNonEmptyString(this._linkData.description)&&(u="<div id='shareDescription'>"+Jx.escapeHtml(this._linkData.description)+"<\/div>"),t="",i="",n?i="noImage":(t+="<div id='"+this._imageId+"'><\/div>",i="withImage"),t+="<div id='sharePVTextArea' class='"+i+"'>"+r+"<div class='singleLineText' id='shareUrl'>"+Jx.escapeHtml(this._linkData.url)+"<\/div>"+u+"<\/div>",f.innerHTML=t,this._renderedPreview=true)};Share.Preview.prototype._errorLoadingImage=function(n){var t=n.target===this._imgArray[0];t&&(this._thumbnailLoaded=true);this._imageErrorCount++;this._checkShowFlipView()};Share.Preview.prototype._checkShowFlipView=function(){var n=false,t=false,i;this._flipViewInitialized&&!this._previewVisible&&(i=this._imageErrorCount+this._imageSuccessCount===this._imageTotal,this._thumbnailLoaded&&this._imageSuccessCount>0?(t=true,n=true):i&&(this._imageSuccessCount===0?(t=true,n=false):(t=true,n=true)));t&&this._replacePreview(!n)};Share.Preview.prototype._noSoxeDataRender=function(){this._renderedPreview||this._renderPreview(true);this._replacePreview(true)};Share.Preview.prototype._renderer=function(n){return n.then(function(n){var i=document.createElement("div"),r,u;if(n.data.type==="noImage")i.innerHTML='<div class="share-noImageTxt">'+Jx.escapeHtml(Jx.res.getString(Share.Constants.stringsPrefix+"previewNoImage"))+"<\/div>",i.className="share-noImage";else{var f=n.data.img.width,e=n.data.img.height,o=Share.Constants.previewImageHeight,s=Share.Constants.previewImageWidth,t=document.createElement("img");t.src=n.data.img.src;f/e>=s/o?(r=s,u=r*e/f):(u=o,r=u*f/e);t.className="imgPreview";t.width=r;t.height=u;i.appendChild(t)}return i})};Share.Preview.prototype._setTitle=function(n){Jx.log.info("User edited title.");this._linkData.title=n;this.linkHasBeenCustomized=true};Share.Preview.prototype._setDescription=function(n){Jx.log.info("User edited description.");this._linkData.title=n;this.linkHasBeenCustomized=true};Share.Preview.prototype._imageId="sharePVImgArea";Share.Preview.prototype._noImageSlide={type:"noImage"};Share.Preview.prototype._uiInitialized=false;Share.Preview.prototype._soxeComplete=false;Share.Preview.prototype._hasSoxeData=false;Share.Preview.prototype._soxeCancelled=false;Share.Preview.prototype._renderedPreview=false;Share.Preview.prototype._imagesArrayCreated=false;Share.Preview.prototype._previewVisible=false;Share.Preview.prototype._flipViewInitialized=false;Share.Preview.prototype._thumbnailLoaded=false;Share.Preview.prototype.linkHasBeenCustomized=false;Share.Preview.prototype._wasOnLastPageForHide=false;Share.Preview.prototype._leftArrow=null;Share.Preview.prototype._rightArrow=null;Share.Preview.prototype._flipView=null;Share.Preview.prototype._list=null;Share.Preview.prototype._imageCount=0;Share.Preview.prototype._currentFlipperCount=0;Share.Preview.prototype._imageSuccessCount=0;Share.Preview.prototype._imageErrorCount=0;Share.Preview.prototype._imageTotal=0;Share.Preview.prototype._imgArray=null;Share.Preview.prototype._soxePromise=null