Jx.delayDefine(Jx,"Sas",function(){Jx.Sas=function(n,t){this._feedback={userid:"Anonymous",device:"",build:"",application:n,isBeta:false};this._filesRegistered=false;this._localizedAppName=t;this.initComponent();this._id="SendASmile"};Jx.augment(Jx.Sas,Jx.Component);Jx.Sas.HELPER_PAGE_URL="ms-appx-web:///sendasmile/survey_helper.html";Jx.Sas.POST_MESSAGE_URL="ms-appx-web://"+Windows.ApplicationModel.Package.current.id.name;Jx.Sas.LoadState={loading:0,jsLoaded:1,firstPage:2,secondPage:3,submitted:4,error:5};var n=Jx.Sas.prototype;n.getUI=function(n){var t=SasManager.getConfig().privacyUrl;t=Jx.escapeHtml(t.replace(/\{0\}/,SasManager.getMarket()));n.html="<div id='SendASmile' data-win-control='WinJS.UI.SettingsFlyout'><div id='sasHeader' class='win-header'><button id='sasBackButton' type='button' class='win-backbutton' aria-label='"+Jx.escapeHtml(Jx.res.getString("/accountsStrings/asc-backButtonAriaLabel"))+"'><\/button><div class='typeSizeMedium singleLineText' id='sasTitle'>"+Jx.res.getString("/strings/sasSurveyHeader")+"<\/div><div id='sasAppIcon'><\/div><\/div><div id='sasLoadCtr'><div id='sasLoadHeader'><progress id='sasLoadSpinner' class='win-ring win-small'><\/progress><span id='sasLoadHeaderText' class='typeSizeNormal'>"+Jx.res.getString("/strings/sasLoadingHeader")+"<\/span><\/div><div id='sasLoadText' class='typeSizeNormal'><\/div><\/div><div id='sasForm'><div id='surveyIFrameHost'><\/div><a id='sasLegalLink' href='"+t+"'>"+Jx.res.getString("/strings/sasPrivacyText")+"<\/a><\/div><\/div>";this._addCss("/resources/sendasmile/css/sas.css");this._addCss("/resources/sendasmile/css/"+this._feedback.application+"SaSColor.css");this._hasUI=true};n.activateUI=function(){var t,n;Jx.Component.activateUI.call(this);t=document.createElement("iframe");t.className="settings_section";t.id="surveyFrame";document.getElementById("surveyIFrameHost").replaceNode(t);this._flyout=document.getElementById("SendASmile");this._surveyFrame=document.getElementById("surveyFrame");this._backButton=document.getElementById("sasBackButton");WinJS.UI.processAll(this._flyout).done();n=this;this._listeners=[{element:window,type:"message",handler:function(){n._onMessage.apply(n,arguments)}},{element:this._flyout,type:"afterhide",handler:function(){n._onHide.apply(n)}},{element:this._backButton,type:"click",handler:function(){n._handleBackButton.apply(n)}}];this._listeners.forEach(function(n){n.element.addEventListener(n.type,n.handler)});this._collectFeedback();this._loadState=Jx.Sas.LoadState.loading};n.deactivateUI=function(){Jx.Component.deactivateUI.call(this);this._listeners.forEach(function(n){n.element&&n.element.removeEventListener(n.type,n.handler)})};n.show=function(){try{if(this._flyout.winControl&&this._flyout.winControl.show(),this._loadState===Jx.Sas.LoadState.loading){var n=Jx.appId?Jx.appId:0,t=SasManager._config.application.lookup(n).surveyId;this._loadIframe(this._surveyFrame,t);this._startLoadTime=(new Date).getTime()}SasManager.fireShowEvent()}catch(i){Jx.log.exception("Feedback: Error showing feedback form",i)}};n.hide=function(){this._flyout.winControl&&this._flyout.winControl.hide()};n.setUserInfo=function(n,t){this._feedback.isBeta=t;this._feedback.userid=n};n.collectAndUploadLogs=function(n,t){if(SasManager.enableIssueReporting()){var l=Windows.ApplicationModel.Package.current.id.familyName,o=Windows.ApplicationModel.Package.current.id.fullName,i=Windows.ApplicationModel.Package.current.id.version,s=i.major+"."+i.minor+"."+i.revision+"."+i.build,h=Windows.Storage.ApplicationData.current.localFolder,e=n+"_bug.txt",f=[],c=function(n){u._filesRegistered||(n.forEach(function(n){Jx.erRegisterFile(n)}),u._filesRegistered=true);Jx.fault("sas_bugreport","sas_bugreport")},r=function(n){return function(){Jx.log.error("Feedback: "+n)}},u=this;h.createFileAsync(e,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(n){return f.push(n.path),f.push(n.path.replace(e,"LiveCommLast.etl")),n.openAsync(Windows.Storage.FileAccessMode.readWrite)},r("Unable to create a new text file for bug information.")).then(function(i){function h(){return f.detachStream(),e.flushAsync()}var e=i.getOutputStreamAt(i.size),f=new Windows.Storage.Streams.DataWriter(e);return f.writeString("Bug report"),f.writeString("Bug title: "+n+","+u._feedback.userid),f.writeString("Bug description: "+t),f.writeString("Application name: "+n),f.writeString("Package full name: "+o),f.writeString("Package version: "+s),f.writeString("User id: "+u._feedback.userid),f.storeAsync().then(h,r("Unable to write bug information to newly created file."))},r("Unable to open newly created bug file.")).done(function(){c(f)},r("Unable to flush bug information to file stream."))}};n._loadIframe=function(n,t){var i={target:"",template:"default",enableLTS:0,survey:{language:SasManager.getLanguage(),id:t,host:SasManager.getConfig().fmsDomain,features:["Title,AllNormalPages,NextButton,Thankyou,SubmitButton,PreviousButton"],renderOption:"noDefault,overrideall"},site:{name:this._id,id:"3",brand:"3"},content:{id:"7D36270F8ABD495CADEF88DE0F0B904A",type:"kb",aggregateId:"Sas"},parameters:[this._feedback.application,this._feedback.userid,this._feedback.build,this._feedback.device,this._feedback.isBeta,SasManager.getMarket()],localCss:"//Microsoft.WinJS.2.0/css/ui-light.css",loadTimeout:15e3,localizedAppName:this._localizedAppName};n.src=Jx.Sas.HELPER_PAGE_URL+"?"+JSON.stringify(i)};n._onMessage=function(n){var t=n.data,f,i,r,e,u;if(n.origin===Jx.Sas.POST_MESSAGE_URL)if(t.badLoad)(this._loadState===Jx.Sas.LoadState.loading||this._loadState===Jx.Sas.LoadState.jsLoaded)&&(document.getElementById("sasLoadHeaderText").innerText=Jx.res.getString("/strings/sasBadLoadHeader"),document.getElementById("sasLoadText").innerText=Jx.res.getString("/strings/sasBadLoad"),document.getElementById("sasLoadSpinner").outerText="",this._loadState=Jx.Sas.LoadState.error,Jx.bici.increment(Microsoft.WindowsLive.Instrumentation.Ids.General.sendSmileErrorCount,1),f=this._loadState===Jx.Sas.LoadState.jsLoaded?Microsoft.WindowsLive.Instrumentation.ErrorType.network:Microsoft.WindowsLive.Instrumentation.ErrorType.fault,this._recordQos(this._startLoadTime,2,f));else if(t.loaded)(this._loadState===Jx.Sas.LoadState.loading||this._loadState===Jx.Sas.LoadState.jsLoaded)&&(document.getElementById("sasLoadCtr").outerText="",document.getElementById("sasForm").style.display="block",this._loadState=Jx.Sas.LoadState.firstPage,this._recordQos(this._startLoadTime,0,Microsoft.WindowsLive.Instrumentation.ErrorType.success));else if(t.jsLoaded)this._loadState===Jx.Sas.LoadState.loading&&(this._loadState=Jx.Sas.LoadState.jsLoaded);else if(t.submitted)this.collectAndUploadLogs(this._feedback.application,t.textInput),this._loadState=Jx.Sas.LoadState.submitted,Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.General.sendSmile,0);else if(t.onFirstPage&&this._loadState===Jx.Sas.LoadState.secondPage)this._loadState=Jx.Sas.LoadState.firstPage;else if(t.onFirstPage!==undefined&&this._loadState===Jx.Sas.LoadState.firstPage&&(this._loadState=Jx.Sas.LoadState.secondPage,t.showHelp)){if(Jx.bici.increment(Microsoft.WindowsLive.Instrumentation.Ids.General.sendSmile,1),this._loadState=Jx.Sas.LoadState.submitted,i=true,r=Jx.appId?Jx.appId:0,r===Jx.AppId.photo)try{e=new window.PhotoViewer.SettingsView;e.helpPaneInvoked();i=false}catch(o){Jx.log.exception("Feedback: Unable to show Photo-specific Help Flyout",o)}else if(SasManager._helpFlyoutCallbackFn)try{SasManager._helpFlyoutCallbackFn()}catch(o){Jx.log.exception("Feedback: Unable to show app-specific Help Flyout",o)}i&&(u=SasManager._config.application.lookup(r).helpFlyoutUrl,u&&this._launchUrl(u));this.hide()}};n._recordQos=function(n,t,i){try{var u=(new Date).getTime()-n,r=Microsoft.WindowsLive.Instrumentation;Jx.bici.recordDependentApiQos(r.ScenarioId.modernSendaSmile_ShowSurvey,r.ApiId.fms_LoadSurvey,r.PropertyId.fms,u,0,t,i,null);Jx.bici.recordScenarioQos(r.ScenarioId.modernSendaSmile_ShowSurvey,r.PropertyId.fms,u,0,t,i,null)}catch(f){Jx.log.exception("Feedback: Unable to record QoS",f)}};n._collectFeedback=function(){var n=(new Windows.Devices.Input.KeyboardCapabilities).keyboardPresent,t=(new Windows.Devices.Input.MouseCapabilities).mousePresent,i=(new Windows.Devices.Input.TouchCapabilities).touchPresent;this._feedback.device=n+","+t+","+i;this._feedback.build=Windows.ApplicationModel.Package.current.id.fullName};n._handleBackButton=function(){this._loadState!==Jx.Sas.LoadState.secondPage?(this.hide(),Windows.UI.ApplicationSettings.SettingsPane.show()):this._surveyFrame.contentWindow.postMessage({backButtonPressed:true},Jx.Sas.POST_MESSAGE_URL)};n._onHide=function(){(this._loadState===Jx.Sas.LoadState.submitted||this._loadState===Jx.Sas.LoadState.error)&&this.shutdownUI();SasManager.fireHideEvent()};n._addCss=function(n){var t=document.createElement("link");t.type="text/css";t.rel="stylesheet";t.href=n;document.head.appendChild(t)};n._launchUrl=function(n){var t=Windows.System,i=new t.LauncherOptions;i.desiredRemainingView=Windows.UI.ViewManagement.ViewSizePreference.useHalf;t.Launcher.launchUriAsync(new Windows.Foundation.Uri(n),i).done()}})