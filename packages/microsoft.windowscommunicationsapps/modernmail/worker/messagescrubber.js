(function(){"use strict";Mail.synchronousScrub=function(n,t){Jx.mark("Mail.synchronousScrub,StartTA,getScrubbedDocument");var i=Mail.Worker._Scrubber.scrubSynchronously(n,t);i.dispose();Jx.mark("Mail.synchronousScrub,StopTA,getScrubbedDocument")};Mail.getScrubbedDocument=function(n,t){var i,r,u;return Jx.mark("Mail.getScrubbedDocument,StartTA,getScrubbedDocument"),i=Mail.Worker._Scrubber.scrubSynchronously(n,t,{scrubDrafts:true}),r=i.getDocument(),i.dispose(),u=new Mail.BodyWriter(t,r,{skipWriting:true,sanitizedBody:i.getSanitizedBody()}),u.runSynchronous(),u.dispose(),Jx.mark("Mail.getScrubbedDocument,StopTA,getScrubbedDocument"),r};Jx.delayDefine(Mail.Worker,"AsyncMessageScrubber",function(){function n(n){Jx.mark("AsyncMessageScrubber."+n)}function r(n){Jx.mark("AsyncMessageScrubber."+n+",StartTA,AsyncMessageScrubber")}function u(n){Jx.mark("AsyncMessageScrubber."+n+",StopTA,AsyncMessageScrubber")}function e(n){Jx.mark("AsyncMessageScrubber:"+n+",StartTM,AsyncMessageScrubber")}function o(n){Jx.mark("AsyncMessageScrubber:"+n+",StopTM,AsyncMessageScrubber")}var t=Microsoft.WindowsLive.Platform,i=t.MailBodyType,f=Mail.Worker.AsyncMessageScrubber=function(i,f,e,o,s){r("ctor");this._platform=i;this._message=f;this._onComplete=e;this._onCompleteContext=o;this._priority=s;n("objectId = "+f.objectId);this._disposer=new Mail.Disposer;this._scrubber=null;this._bodyHook=null;this._completedSanitizedVersion=this._message.sanitizedVersion;this._disposer.add(new Mail.EventHook(f.platformMailMessage,"changed",this._onMessageChanged,this));this._startScrubbing();u("ctor")};f.prototype={dispose:function(){this._disposer.dispose()},getObjectId:function(){return this._message.objectId},_startScrubbing:function(n){var f,o;r("_startScrubbing");f=this._message;n||(n=f.getBodyByType(i.html));n&&(this._bodyHook=this._disposer.add(new Mail.EventHook(n,"changed",this._onBodyChanged,this)));e("scrubbing");o={onComplete:this.onScrubbingComplete,onCompleteContext:this,priority:this._priority};this._scrubber=this._disposer.add(new Mail.Worker._Scrubber(this._platform,f,o));u("_startScrubbing")},_cleanupScrubber:function(){o("scrubbing");this._disposer.disposeNow(this._scrubber);this._scrubber=null;this._disposer.disposeNow(this._bodyHook);this._bodyHook=null},onScrubbingComplete:function(){r("onScrubbingComplete");this._cleanupScrubber();this._onComplete&&this._onComplete.call(this._onCompleteContext);this._completedSanitizedVersion=this._message.sanitizedVersion;u("onScrubbingComplete")},_onMessageChanged:function(t){Mail.Validators.hasPropertyChanged(t,"sanitizedVersion")?this._scrubber||this._completedSanitizedVersion===this._message.sanitizedVersion||(n("_onMessageChanged - sanitizedVersion changed after scrubbing"),this._startScrubbing()):Mail.Validators.hasPropertyChanged(t,"allowExternalImages")&&(this._scrubber&&(n("_onMessageChanged - sanitizedVersion changed while scrubbing"),this._cleanupScrubber()),this._startScrubbing())},_onBodyChanged:function(){if(this._scrubber){var t=this._message.platformMailMessage.getBody(i.html);this._scrubber.isSameHtmlBody(t)||(n("_onBodyChanged - while scrubbing"),this._cleanupScrubber(),this._startScrubbing(t))}}}})})()