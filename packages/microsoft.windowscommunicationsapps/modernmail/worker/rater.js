Jx.delayDefine(Mail.Worker,"Rater",function(){"use strict";function n(n){Jx.mark("Rater."+n)}function i(n){Jx.mark("Rater."+n+",StartTA,Rater")}function t(n){Jx.mark("Rater."+n+",StopTA,Rater")}var r=Mail.Worker.Rater=function(n,r){i("ctor");this._platform=n;this._selection=r;this._done=false;this._nextToRate=null;this._scores={};this._sorted=[];this._needsResort=true;this._disposer=new Mail.Disposer;this._jobSet=this._disposer.add(Jx.scheduler.createJobSet());t("ctor")};r.prototype={dispose:function(){i("dispose");this._disposer.dispose();t("dispose")},getBestMessage:function(t,i,r){if(t.needsUpdate()){n("getBestMessage - calling update");t.update(function(){this._startRating(t,i,r)},this);return}if(this._nextToRate===null){n("getBestMessage - calling _startRating");this._startRating(t,i,r);return}if(this._sorted.length===0){n("getBestMessage - retuning null");i.call(r,null);return}if(this._needsResort){Jx.scheduler.addJob(this._jobSet,Mail.Priority.workerRater,"Rater.getBestMessage.resort",function(){n("getBestMessage - restoring");this._sort();this.getBestMessage(t,i,r)},this);return}var u=this._sorted.splice(0,1)[0],f=u.message;u.dispose();n("getBestMessage - retuning "+f.objectId);i.call(r,f)},_disposeAllScores:function(){i("_disposeAllScores");this._sorted.forEach(function(n){n.dispose()});this._sorted=[];t("_disposeAllScores")},_startRating:function(t,i,r){this._done=t.count===0;this._nextToRate=this._done?-1:0;this._disposeAllScores();this._done?(n("_startRating - retuning null"),i.call(r,null)):Jx.scheduler.addJob(this._jobSet,Mail.Priority.workerRater,"Rater._rateSome",this._rateSome,this,[t,i,r])},_rateSome:function(r,u,f){if(i("_rateSome"),r.needsUpdate())return n("_rateSome - needs update"),r.update(function(){this._startRating(r,u,f)},this),t("_rateSome"),Jx.Scheduler.repeat(false);var e=r.item(this._nextToRate++);return e&&this._sorted.push(new Mail.Worker.Score(this._platform,e,this._selection,function(){this._needsResort=true},this)),this._done=this._nextToRate===r.count,this._done&&(this._sort(),this.getBestMessage(r,u,f)),t("_rateSome"),Jx.Scheduler.repeat(!this._done)},_sort:function(){this._sorted.sort(Mail.Worker.Score.compare);this._needsResort=false}}})