Jx.delayDefine(Mail.Worker,"SyncListener",function(){"use strict";function e(n,i,r){this._resource=n;this._hook=new Mail.EventHook(n,"changed",i,r)}function o(n){Jx.mark("SyncListener."+n)}function i(n){Jx.mark("SyncListener."+n+",StartTA,SyncListener")}function r(n){Jx.mark("SyncListener."+n+",StopTA,SyncListener")}var t=Microsoft.WindowsLive.Platform,u=t.CollectionChangeType,f,n;e.prototype={dispose:function(){this._hook.dispose();this._hook=null},isSyncing:function(){var n=this._resource;return n.isSynchronizing||n.isSyncNeeded||!n.isInitialSyncFinished}};f=Mail.Worker.SyncListener=function(n){i("ctor");this._platform=n;this._isSyncing=false;this._resources={};this._disposer=new Mail.Disposer;this._accounts=null;this.initEvents();this._init();r("ctor")};Jx.augment(f,Jx.Events);n=f.prototype;n.dispose=function(){i("dispose");this._disposer.dispose();r("dispose")};n.isSyncing=function(){return this._isSyncing};n._init=function(){i("_init");var n=this._accounts=this._disposer.add(this._platform.accountManager.getConnectedAccountsByScenario(t.ApplicationScenario.mail,t.ConnectedFilter.normal,t.AccountSort.name));Mail.Collection.forEach(n,this._addResource,this);this._disposer.add(new Mail.EventHook(n,"collectionchanged",this._accountsChanged,this));n.unlock();r("_init")};n._accountsChanged=function(n){var t=n.detail[0],f;switch(t.eType){case u.itemAdded:this._addResource(this._accounts.item(t.index));break;case u.itemRemoved:this._removeResourceById(t.objectId);break;case u.reset:i("_accountsChanged-reset");for(f in this._resources)this._removeResourceById(f);Mail.Collection.forEach(this._accounts,this._addResource,this);r("_accountsChanged-reset")}};n._addResource=function(n){var i=n.getResourceByType(t.ResourceType.mail);i&&(this._resources[n.objectId]=this._disposer.add(new e(i,this._resourceChanged,this)),this._recalculateSyncing())};n._removeResourceById=function(n){var u="_removeResourceById:"+n,t;i(u);t=this._resources;this._disposer.disposeNow(t[n]);delete t[n];this._recalculateSyncing();r(u)};n._resourceChanged=function(){this._recalculateSyncing()};n._recalculateSyncing=function(){var n=Object.keys(this._resources).some(function(n){return this._resources[n].isSyncing()},this);n!==this._isSyncing&&(this._isSyncing=n,o("_isSyncing="+n),this.raiseEvent("syncStatusChanged",{isSyncing:n}))}})