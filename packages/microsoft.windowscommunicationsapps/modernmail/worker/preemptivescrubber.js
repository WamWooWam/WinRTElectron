Jx.delayDefine(Mail.Worker,"PreemptiveScrubber",function(){"use strict";function u(n){Jx.mark("PreemptiveScrubber:"+n)}function n(n){Jx.mark("PreemptiveScrubber."+n+",StartTA,PreemptiveScrubber")}function t(n){Jx.mark("PreemptiveScrubber."+n+",StopTA,PreemptiveScrubber")}function f(n){Jx.mark("PreemptiveScrubber:"+n+",StartTM,PreemptiveScrubber")}function i(n){Jx.mark("PreemptiveScrubber:"+n+",StopTM,PreemptiveScrubber")}var r=Mail.Worker.PreemptiveScrubber=function(i,r){n("ctor");this._platform=i;this._selection=r;this._disposer=new Mail.Disposer;this._priority=Mail.Priority.workerScrubber;this._isPaused=false;this._messageGetter=null;this._rater=null;this._messageScrubber=null;this._currentMessage=null;this._jobSet=this._disposer.add(Jx.scheduler.createJobSet());this._syncListener=this._disposer.add(new Mail.Worker.SyncListener(i));this._syncHook=null;this._start();t("ctor")};r.prototype={dispose:function(){n("dispose");Jx.dispose(this._syncHook);this._disposer.dispose();t("dispose")},_disposeMessageGetter:function(){this._disposer.disposeNow(this._messageGetter);this._messageGetter=null},_start:function(){var n=this._messageGetter;Jx.dispose(this._syncHook);this._syncListener.isSyncing()?(this._syncHook=new Mail.EventHook(this._syncListener,"syncStatusChanged",this._start,this),n&&n.whenDirty(this._disposeMessageGetter,this)):(n&&n.whenDirty(null),f("cycle"),Jx.scheduler.addJob(this._jobSet,Mail.Priority.workerScrubber,"PreemptiveScrubber._createGetter",this._createGetter,this))},_createGetter:function(){n("_createGetter");this._messageGetter||(this._messageGetter=this._disposer.add(new Mail.Worker.MessageGetter(this._platform)));Jx.scheduler.addJob(this._jobSet,this._priority,"PreemptiveScrubber._createRater",this._createRater,this);t("_createGetter")},_createRater:function(){n("_createRater");this._rater||(this._rater=this._disposer.add(new Mail.Worker.Rater(this._platform,this._selection)));this._rater.getBestMessage(this._messageGetter,this._onRaterReady,this);t("_createRater")},_onRaterReady:function(r){n("_onRaterReady");r?(this._currentMessage=r,Jx.scheduler.addJob(this._jobSet,this._priority,"PreemptiveScrubber._createMessageScrubber",this._createMessageScrubber,this)):(i("cycle"),u("no messages"),this._messageGetter.whenDirty(this._start,this));t("_onRaterReady")},_createMessageScrubber:function(){n("_createMessageScrubber");this._messageScrubber=this._disposer.add(new Mail.Worker.AsyncMessageScrubber(this._platform,this._currentMessage,this._onMessageScrubberFinished,this));t("_createMessageScrubber")},_onMessageScrubberFinished:function(){n("_onMessageScrubberFinished");this._disposer.disposeNow(this._messageScrubber);this._messageScrubber=null;this._currentMessage=null;i("cycle");Jx.scheduler.addJob(this._jobSet,this._priority,"PreemptiveScrubber._restart",this._start,this);t("_onMessageScrubberFinished")},resume:function(){n("resume");this._isPaused&&(this._isPaused=false,Jx.scheduler.resume());t("resume")},pause:function(){n("pause");this._isPaused||(this._isPaused=true,Jx.scheduler.pause());t("pause")}}})