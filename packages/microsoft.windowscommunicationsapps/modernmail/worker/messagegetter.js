Jx.delayDefine(Mail.Worker,"MessageGetter",function(){"use strict";function i(n){Jx.mark("MessageGetter:"+n)}function n(n){Jx.mark("MessageGetter."+n+",StartTA,MessageGetter")}function t(n){Jx.mark("MessageGetter."+n+",StopTA,MessageGetter")}var r=Microsoft.WindowsLive.Platform,u=Mail.Worker.MessageGetter=function(i){n("ctor");this._resetPending=false;this._whenDirty=null;this._disposer=new Mail.Disposer;this._jobSet=this._disposer.add(Jx.scheduler.createJobSet());this._deferredCollection=this._disposer.add(new Mail.MappedDeferredCollection(new Mail.CappedCollection(100,new Mail.QueryCollection(i.mailManager.getMessageCollectionBySanitizedVersion,i.mailManager,[r.SanitizedVersion.notSanitized])),this,function(n){if(!n||n.pendingRemoval)return null;var t=Mail.Account.load(n.accountId,i);return t?new Mail.UIDataModel.MailMessage(n,t):null},this,"Worker:getMessageCollectionBySanitizedVersion"));t("ctor")};u.prototype={dispose:function(){n("dispose");this._disposer.dispose();t("dispose")},update:function(i,r){n("update");this._jobSet.cancelJobs();this.needsUpdate()?Jx.scheduler.addJob(this._jobSet,Mail.Priority.workerMessageGetter,"MessageGetter.acceptPendingChanges",function(){this._deferredCollection.acceptPendingChanges();this._resetPending=false;Jx.scheduler.addJob(this._jobSet,Mail.Priority.workerMessageGetter,"MessageGetter.re-update",this.update,this,[i,r])},this):i.call(r);t("update")},get count(){return this._deferredCollection.count},item:function(n){return i("item "+n+" (count: "+this.count+")"),this._deferredCollection.item(n)},needsUpdate:function(){return this._resetPending||this._deferredCollection.pendingChangesCount>20},whenDirty:function(r,u){if(r===null){i("whenDirty - null");this._whenDirty=null;return}n("whenDirty");this._resetPending||this._deferredCollection.hasPendingChanges?(this._resetPending=true,r.call(u)):(i("whenDirty - waiting"),this._whenDirty={func:r,context:u});t("whenDirty")},onChangesPending:function(){if(this._whenDirty&&this._deferredCollection.pendingChangesCount>0){var n=this._whenDirty;this._whenDirty=null;this._resetPending=true;n.func.call(n.context)}},onResetPending:function(){this._resetPending=true;this.onChangesPending()}}})