Jx.delayGroup("MailCompose",function(){var n,t;Jx.Binder=function(n){this._impl=n};n=null;Jx.Binder.instance=function(){var t=Jx.Binder.Binders;return Boolean(n)||(n=new Jx.Binder(t.AddRemoveListenerBinder.instance(t.L2EventBinder.instance(new t.JxAttrBinder)))),n};t=Jx.Binder.prototype;t.attach=function(n,t){return this.addAttachments([],n,t)};t.addAttachments=function(n,t,i){var r=this;return i.forEach(function(i){n.push(r._impl.attach(t,i))}),n};t.detach=function(n){n.forEach(function(n){n.detach()})}});Jx.delayGroup("MailCompose",function(){var n=Jx.Binder.Binders={};n.Base=function(n){this._next=n};n.Base.prototype.bindFallback=function(n,t){var i=this._next;return i.attach(n,t)}});Jx.delayGroup("MailCompose",function(){var n=Jx.Binder.Binders,u,t,i,r;n.EventBinder=function(t,i,r,u){n.Base.call(this,t);this._bindImpl=i;this._unbindImpl=r;this._canHandleImpl=u};Jx.augment(n.EventBinder,n.Base);n.EventBinder.instance=function(t,i,r,u){return new n.EventBinder(t,i,r,u)};u=n.EventBinder.prototype;u.attach=function(n,t){var f,e;var r=null,i=null,u=false;return this._canHandleDef(t)&&(i=t.from||n,u=this._canHandleImpl(t,i)),u?(f=this._bindImpl(i,t.on,t.then,n),e=this._unbindImpl,r={detach:function(){e(i,t.on,f,n)}}):r=this.bindFallback(n,t),r};u._canHandleDef=function(n){return Jx.isNonEmptyString(n.on)&&Jx.isFunction(n.then)};t=n.OnDetachBinder={};t.instance=function(i){return n.EventBinder.instance(i,t.attach,t.detach,t.canHandleDef)};t.canHandleDef=function(n,t){return Jx.isFunction(t.on)&&Jx.isFunction(t.detach)};t.attach=function(n,t,i,r){n.on(t,i,r);return i};t.detach=function(n,t,i){n.detach(t,i)};i=n.AddRemoveListenerBinder={};i.instance=function(t){return n.EventBinder.instance(t,i.attach,i.detach,i.canHandleDef)};i.canHandleDef=function(n,t){return Jx.isFunction(t.addListener)&&Jx.isFunction(t.removeListener)};i.attach=function(n,t,i,r){return n.addListener(t,i,r),i};i.detach=function(n,t,i,r){n.removeListener(t,i,r)};r=n.L2EventBinder={};r.instance=function(t){return n.EventBinder.instance(t,r.attach,r.detach,r.canHandleDef)};r.canHandleDef=function(n,t){return Jx.isFunction(t.addEventListener)&&Jx.isFunction(t.removeEventListener)};r.attach=function(n,t,i,r){var u=i.bind(r);return n.addEventListener(t,u,false),u};r.detach=function(n,t,i){n.removeEventListener(t,i,false)}});Jx.delayGroup("MailCompose",function(){var n=Jx.Binder.Binders,t;n.JxAttrBinder=function(t){n.Base.call(this,t)};Jx.augment(n.JxAttrBinder,n.Base);t=n.JxAttrBinder.prototype;t.attach=function(n,t){var i;if(i=null,this._canHandleDef(t)){var r=t.to||{attr:t.bindAttrFrom.attr},u=r.to||n,f=t.bindAttrFrom.from,e=t.bindAttrFrom.attr,o=r.attr;f.bindAttr(e,u,o);i={detach:function(){f.unbindAttr(e,u,o)}}}else i=this.bindFallback(n,t);return i};t._canHandleDef=function(n){return Jx.isObject(n.bindAttrFrom)}});Jx.delayGroup("MailCompose",function(){$include("/modernmail/compose/mailcompose/appbar.css");$include("/modernmail/compose/mailcompose/inline.css");$include("/modernmail/compose/mailcompose/composeanimations.css");window.Compose=window.Compose||{};Compose.doc=document;Compose.platform=null;Compose.WinJsUI=WinJS.UI;Object.defineProperty(Compose,"InputPane",{get:function(){return Windows.UI.ViewManagement.InputPane},configurable:true,enumerable:true});Compose.ComposeAction={createNew:1,reply:2,replyAll:3,forward:4,openDraft:5};Compose.LogEvent={start:"_begin",stop:"_end",toProfilerMarkString:{_begin:",StartTA,Compose",_end:",StopTA,Compose"},toProfilerMarkAsyncString:{_begin:",StartTM,Compose",_end:",StopTM,Compose"}};Compose.log=function(n,t){Compose.mark(n,t)};Compose.mark=function(n,t){Jx.mark("Compose."+n+(Compose.LogEvent.toProfilerMarkString[t]||""))};Compose.markAsync=function(n,t){Jx.mark("Compose."+n+(Compose.LogEvent.toProfilerMarkAsyncString[t]||""))}});Jx.delayGroup("MailCompose",function(){Compose.ComposeUtil=function(){this._actionMailVerbMap=null;this._calendarToComposeMap=null};Compose.CalendarActionType={forward:"forward",reply:"reply",replyAll:"replyAll",accept:"accept",tentative:"tentative",decline:"decline",cancel:"cancel"};var n="0";Compose.ComposeUtil.prototype={isMailMessageCommitted:function(t){return t.objectId!==n},isValidCalendarAction:function(n){var t=this._getCalendarActionToComposeActionMap();return Jx.isNumber(t[n])},convertToMailVerb:function(n){return this._getActionMailVerbMap()[n]},convertToComposeAction:function(n){return this._getCalendarActionToComposeActionMap()[n]},convertCalendarResponseToCalendarActionType:function(n){var i=Microsoft.WindowsLive.Platform.Calendar.ResponseType,r=Compose.CalendarActionType,t;switch(n){case i.accepted:t=r.accept;break;case i.tentative:t=r.tentative;break;case i.declined:t=r.decline}return t},convertCalendarActionTypeToCalenderResponseType:function(n){var i=Microsoft.WindowsLive.Platform.Calendar.ResponseType,r=Compose.CalendarActionType,t;switch(n){case r.accept:t=i.accepted;break;case r.tentative:t=i.tentative;break;case r.decline:t=i.declined}return t},defineClassName:function(n,t){n.getClassName=n.prototype.getClassName=function(){return t}},getHeaderController:function(n){return n.getComponent("Compose.HeaderController")},_getActionMailVerbMap:function(){var n=this._actionMailVerbMap={},t=Microsoft.WindowsLive.Platform.MailMessageLastVerb,i=Compose.ComposeAction;return n[i.createNew]=t.unknown,n[i.reply]=t.replyToSender,n[i.replyAll]=t.replyToAll,n[i.forward]=t.forward,n[i.openDraft]=t.unknown,this._getActionMailVerbMap=function(){return this._actionMailVerbMap},this._getActionMailVerbMap()},_getCalendarActionToComposeActionMap:function(){var n=this._calendarToComposeMap={},t=Compose.CalendarActionType,i=Compose.ComposeAction;return n[t.forward]=i.forward,n[t.reply]=i.reply,n[t.replyAll]=i.replyAll,n[t.accept]=i.reply,n[t.tentative]=i.reply,n[t.decline]=i.reply,n[t.cancel]=i.replyAll,this._getCalendarActionToComposeActionMap=function(){return this._calendarToComposeMap},this._getCalendarActionToComposeActionMap()}};Compose.util=new Compose.ComposeUtil;Debug.Compose=Debug.Compose||{};Debug.Compose.util={isValidAction:function(n){return Object.keys(Compose.ComposeAction).some(function(t){return Compose.ComposeAction[t]===n})}}});Jx.delayGroup("MailCompose",function(){Compose.Component=function(){Jx.Component.call(this);this._isAddedToDOM=false;this._isActivated=false;this._componentCache=null;this._componentCreator=null;this._validationViewController=null;this._mailMessageModel=null;this._componentBinder=null;this._element=null;this._displayedMessageModel=null};Jx.augment(Compose.Component,Jx.Component);var n=Compose.Component.prototype;n.getUI=function(n){this.isAddedToDOM()||this.composeGetUI(n)};n.activateUI=function(){!this._isActivated&&Jx.isFunction(this.composeActivateUI)&&this.composeActivateUI();this._isActivated=true;this._isAddedToDOM=true;this._applyOnEachChild("activateUI")};n.isActivated=function(){return this._isActivated};n.deactivateUI=function(){this._applyOnEachChild("deactivateUI");this.composeDeactivateUI();this._componentCache.removeComponent(this);this._isActivated=false;this._displayedMessageModel=null;this._componentCache=null;this._componentCreator=null;this._validationViewController=null;this._mailMessageModel=null;this._componentBinder=null};n.updateUI=function(){this._displayedMessageModel!==this._mailMessageModel&&(this._mailMessageModel.getPlatformMessage(),this._displayedMessageModel=this._mailMessageModel,this.composeUpdateUI());this._applyOnEachChild("updateUI")};n.updateChildComponent=function(n){n.setComponentCache(this._componentCache);n.setComponentCreator(this._componentCreator);n.setMailMessageModel(this._mailMessageModel);n.setValidationViewController(this._validationViewController);n.setComponentBinder(this._componentBinder);n.setRootElement(this._element)};n.setComponentCache=function(n){this._componentCache!==n&&(n.addComponent(this),this._componentCache=n);this._applyOnEachChild("setComponentCache",[n])};n.getComponentCache=function(){return this._componentCache};n.setComponentBinder=function(n){this._componentBinder!==n&&(this._componentBinder=n);this._applyOnEachChild("setComponentBinder",[n])};n.getComponentBinder=function(){return this._componentBinder};n.removeFromComponentCache=function(){this._componentCache.removeComponent(this);this._componentCache=null};n.setComponentCreator=function(n){this._componentCreator!==n&&(this._componentCreator=n,this._applyOnEachChild("setComponentCreator",[n]))};n.getComponentCreator=function(){return this._componentCreator};n.setMailMessageModel=function(n){this._mailMessageModel!==n&&(this._mailMessageModel=n,this._applyOnEachChild("setMailMessageModel",[n]))};n.getMailMessageModel=function(){return this._mailMessageModel};n.setValidationViewController=function(n){this._validationViewController!==n&&(this._validationViewController=n,this._applyOnEachChild("setValidationViewController",[n]))};n.getValidationViewController=function(){return this._validationViewController};n.setRootElement=function(n){this._element=n};n.getComposeRootElement=function(){return this._element};n.isAddedToDOM=function(){return this._isAddedToDOM};n.validate=function(n){var i=this.composeValidate(n),t=[];return i||t.push(this.getClassName()),this.forEachChild(function(i){Jx.isFunction(i.validate)&&(t=t.concat(i.validate(n)))}),t};n.composeGetUI=function(){};n.composeActivateUI=function(){};n.composeDeactivateUI=function(){};n.composeUpdateUI=function(){};n.composeValidate=function(){return true};n.setIsAddedToDOM=function(n){this._isAddedToDOM=n;this._applyOnEachChild("setIsAddedToDOM",[n])};n.updateModel=function(n){this.forEachChild(function(t){Jx.isFunction(t.updateModel)&&t.updateModel(n)})};n.isDirty=function(){return false};n.getClassName=function(){return""};n._applyOnEachChild=function(n,t){t=t||[];this.forEachChild(function(i){Jx.isFunction(i[n])&&i[n].apply(i,t)})}});Jx.delayGroup("MailCompose",function(){Compose.ComponentCache=function(){this._components={}};Jx.inherit(Compose.ComponentCache,Jx.Events);var n=Compose.ComponentCache.prototype;n.hasComponent=function(n){return!Jx.isNullOrUndefined(this._components[n])};n.getComponent=function(n){return this._components[n]};n.forEachComponent=function(n){var t=this._components;Object.keys(t).filter(function(n){return n!=="Compose.ComposeImpl"&&!Jx.isNullOrUndefined(t[n])}).forEach(function(i){n(t[i])})};n.addComponent=function(n){Jx.isNullOrUndefined(this._components[n.getClassName()])&&(this._components[n.getClassName()]=n,this.raiseEvent("added",{component:n}))};n.removeComponent=function(n){this._components[n.getClassName()]=null;this.raiseEvent("removed",{component:n})}});Jx.delayGroup("MailCompose",function(){Compose.ComponentCreator=function(){this._instances={}};var n=Compose.ComponentCreator.prototype;n.getInstance=function(n,t){var i=this._instances[n.getClassName()];return!t&&Jx.isNullOrUndefined(i)&&(i=this._instances[n.getClassName()]=new n),i};n.seedInstance=function(n,t){this._instances[n.getClassName()]=t}});Jx.delayGroup("MailCompose",function(){var i={htmlBody:"html",textBody:"plainText"},r=function(n){return i.hasOwnProperty(n)},t={fromEmail:"fromEmail",moveToOutbox:"moveToOutbox"},u=function(n){return!(i.hasOwnProperty(n)||t.hasOwnProperty(n))},f=function(n,t){var i;return n.hasBody(t)?i=n.getBody(t):(i=n.createBody(),i.type=t),i},n;Compose.MailMessageModel=function(n){this._cachedValues={};this._mailMessage=null;this._isDeleted=false;this._isNew=Jx.isObject(n.messageCreator)?n.messageCreator.generatesNewPlatformMessage():true;var t=this._mailMessageCreator=Compose.FallbackMessageCreator.instance(n.messageCreator);t.setMailMessageModel(this);this._bodyContents=null;this.setSignatureLocation(n.signatureLocation||ModernCanvas.SignatureLocation.none);this.setInitAction(n.initAction)};Jx.inherit(Compose.MailMessageModel,Jx.Events);Compose.MailMessageModel.instance=function(n,t){var i=new Compose.MailMessageModel(n);return Jx.isObject(t)&&i.set(t),i};Compose.MailMessageModel.stubInstance=function(){var n=new Compose.MailMessageModel({initAction:Compose.ComposeAction.createNew,signatureLocation:ModernCanvas.SignatureLocation.start}),t=document.createDocumentFragment();return n.getBodyContents=function(){return[{content:t,format:ModernCanvas.ContentFormat.documentFragment,location:ModernCanvas.ContentLocation.end}]},n.commit=function(){this.raiseEvent("aftercommit")},n};n=Compose.MailMessageModel.prototype;Debug.MailMessageModel={properties:["to","cc","bcc","toRecipients","ccRecipients","bccRecipients","fromRecipient","htmlBody","textBody","photoMailAlbumName","subject","sourceVerb","objectId","photoMailFlags","outboxQueue","hasOrdinaryAttachments","accountId","fromEmail","sourceMessageStoreId","sanitizedVersion","irmCanEdit","irmCanExtractContent","irmIsContentOwner","irmCanRemoveRightsManagement","irmTemplateId","parentConversationId","irmHasTemplate","irmCanModifyRecipients","importance","irmTemplateName","irmTemplateDescription","moveToOutbox"],verifiers:{to:Jx.isString,cc:Jx.isString,bcc:Jx.isString,toRecipients:Jx.isObject,ccRecipients:Jx.isObject,bccRecipients:Jx.isObject,fromRecipient:Jx.isObject,htmlBody:Jx.isString,textBody:Jx.isString,sourceMessageStoreId:Jx.isNumber,sanitizedVersion:Jx.isNumber,subject:Jx.isString,sourceVerb:Jx.isNumber,objectId:Jx.isNumber,parentConversationId:Jx.isNumber,photoMailFlags:Jx.isNumber,outboxQueue:Jx.isNumber,hasOrdinaryAttachments:Jx.isBoolean,accountId:Jx.isNonEmptyString,irmHasTemplate:Jx.isBoolean,irmCanModifyRecipients:Jx.isBoolean,fromEmail:Jx.isString,irmCanEdit:Jx.isBoolean,irmCanExtractContent:Jx.isBoolean,irmIsContentOwner:Jx.isBoolean,irmCanRemoveRightsManagement:Jx.isBoolean,irmTemplateId:Jx.isString,importance:Jx.isNumber,irmTemplateName:Jx.isString,irmTemplateDescription:Jx.isString,moveToOutbox:Jx.isBoolean},isValidProperty:function(n){return Debug.MailMessageModel.properties.indexOf(n)!==-1},isValidValue:function(n,t){return!Debug.MailMessageModel.verifiers.hasOwnProperty(n)||Debug.MailMessageModel.verifiers[n](t)},assertIsValidProperty:function(){},assertIsValidPropertyAndValue:function(){}};n.set=function(n){if(!this._isDeleted){var t=false;Object.keys(n).forEach(function(i){this._cachedValues[i]!==n[i]&&(this._cachedValues[i]=n[i],t=true);!Jx.isNullOrUndefined(this._bodyContents)&&r(i)&&(this._bodyContents=null)}.bind(this));t&&this.raiseEvent("changed")}};n.get=function(n){return Jx.isUndefined(this._cachedValues[n])?u(n)?this.getPlatformMessage()[n]:r(n)?this._getMailBodyObject(n).body:n===t.fromEmail?this._getFromEmail():n===t.moveToOutbox?false:null:this._cachedValues[n]};n.getBodyContents=function(){if(this._isDeleted)return[];if(Jx.isNullOrUndefined(this._bodyContents)){var n=this.getPlatformMessage(),t=Mail.Account.load(n.accountId,Compose.platform),i=Mail.getScrubbedDocument(Compose.platform,new Mail.UIDataModel.MailMessage(n,t)),r=ModernCanvas.Mail.convertDocumentToDocumentFragment(i);return[{content:r,format:ModernCanvas.ContentFormat.documentFragment,location:ModernCanvas.ContentLocation.end}]}return this._bodyContents};n.setBodyContents=function(n){this._isDeleted||(this._bodyContents=n)};n.addBodyContents=function(n){this.setBodyContents(this.getBodyContents().concat(n))};n.prependBodyContents=function(n){this.setBodyContents(n.concat(this.getBodyContents()))};n.getSignatureLocation=function(){return this._signatureLocation};n.setSignatureLocation=function(n){this._signatureLocation=n};n.getInitAction=function(){return this._initAction};n.setInitAction=function(n){this._initAction=n};n._sync=function(n){var r,f;this._isDeleted||this.isSent()||(Compose.mark("sync",Compose.LogEvent.start),r=this._cachedValues,this._cachedValues={},n=n||[],f=this.getPlatformMessage(),Object.keys(r).filter(function(t){return u(t)&&n.indexOf(t)===-1}).forEach(function(n){f[n]=r[n]}),Object.keys(i).filter(function(n){return r.hasOwnProperty(n)}).forEach(function(n){this._getMailBodyObject(n).body=r[n]}.bind(this)),r.hasOwnProperty(t.fromEmail)&&this._syncFromEmail(f,r[t.fromEmail]),r.hasOwnProperty(t.moveToOutbox)&&r[t.moveToOutbox]&&this.getPlatformMessage().moveToOutbox(),Compose.mark("sync",Compose.LogEvent.stop))};n.commit=function(n){if(!this._isDeleted&&!this.isSent()){this._sync(n);Compose.log("commit",Compose.LogEvent.start);try{this.getPlatformMessage().commit()}catch(t){}Compose.log("commit",Compose.LogEvent.stop);this.raiseEvent("aftercommit")}};n.deletePlatformMessage=function(){if(!this._isDeleted){if(Compose.util.isMailMessageCommitted(this._mailMessage))try{this._mailMessage.deleteObject()}catch(n){Jx.log.exception("this._mailMessage.deleteObject failed",n)}this._mailMessage=null;this._cachedValues=null;this._isDeleted=true}};n.getPlatformMessage=function(){return this.getPlatformMessage=function(){return this._mailMessage},this._mailMessage=this._mailMessageCreator.createMessage(),Compose.log("prepareMessage",Compose.LogEvent.start),this._mailMessageCreator.onMessageCreated(),Compose.log("prepareMessage",Compose.LogEvent.stop),this.getPlatformMessage()};n.isCommitted=function(){return Jx.isObject(this._mailMessage)&&Compose.util.isMailMessageCommitted(this._mailMessage)};n.isNew=function(){return this._isNew};n.isSent=function(){var n=Microsoft.WindowsLive.Platform.MailFolderType;return Jx.isObject(this._mailMessage)&&!this._mailMessage.isInSpecialFolderType(n.drafts)};n._getMailBodyObject=function(n){return f(this.getPlatformMessage(),Microsoft.WindowsLive.Platform.MailBodyType[i[n]])};n._getFromEmail=function(){var t=this.getPlatformMessage(),i=t.fromRecipient,r,n;return i?i.emailAddress:(r=Compose.platform,n=r.accountManager.loadAccount(t.accountId),n?n.emailAddress:null)};n._syncFromEmail=function(n,t){var u=Compose.platform,i=u.accountManager.loadAccount(n.accountId),r=t;i&&(r=FromControl.buildFromString(t,i));n.from=r}});Jx.delayGroup("MailCompose",function(){var t=Compose.ComposeImpl=function(){Compose.Component.call(this);this._actionHandlers=null;this._isDirty=false},i,n;Jx.augment(t,Jx.Events);Jx.augment(t,Compose.Component);i="Compose.ComposeImpl";Compose.util.defineClassName(t,i);t.getComposeImpl=function(n){return n.getComponent(i)};t.getComposeWindow=function(n){var i=t.getComposeImpl(n);return i?i.getComposeRootElement().querySelector(".composeWindow"):null};t.quietSave=function(n){t.getComposeImpl(n).save(true)};n=Compose.ComposeImpl.prototype;n.activateUI=function(){Compose.log("activateUI",Compose.LogEvent.start);Compose.log("activateUI_jx",Compose.LogEvent.start);Compose.Component.prototype.activateUI.call(this);Compose.log("activateUI_jx",Compose.LogEvent.stop);var n=this.getComposeRootElement().querySelector(".composeWindow");Compose.log("winJsProcessAll",Compose.LogEvent.start);Compose.WinJsUI.processAll(n);Compose.log("winJsProcessAll",Compose.LogEvent.stop);Compose.log("jxProcessAll",Compose.LogEvent.start);Jx.res.processAll(n);Compose.log("jxProcessAll",Compose.LogEvent.stop);Compose.log("activateUI",Compose.LogEvent.stop)};n.addComponent=function(n){this.append(n);this.updateChildComponent(n)};n.setActionHandlers=function(n){this._actionHandlers=n};n.send=function(){Compose.log("sendMail",Compose.LogEvent.start);var t={success:false},n="send";return this._validate(n)&&(t=this._actionHandlers[n].runAnimation(this.getComponentCache()).then(function(){return{success:this._runAction(n,this.updateModel.bind(this,n))}}.bind(this))),Compose.log("sendMail",Compose.LogEvent.stop),WinJS.Promise.as(t)};n.save=function(n,t){var i,r,u;Compose.log("saveDraft",Compose.LogEvent.start);i="save";this._validate(i,n)&&this._runAction(i,this.updateModel.bind(this,t?"hideCurrent":i),n);Mail.Utilities.ComposeHelper.isComposeShowing&&(r=this.getMailMessageModel(),u=r.getPlatformMessage(),Mail.Utilities.ComposeHelper.updateWindowTitleWithMessage(u));Compose.log("saveDraft",Compose.LogEvent.stop)};n.discard=function(){Compose.log("discardMail",Compose.LogEvent.start);var n="discard",t=Mail.Utilities.ComposeHelper._selection,i=t.messages;this._actionHandlers[n].runAnimation(this.getComponentCache()).done(function(){this._runAction(n,function(){t.deleteItems(i)})}.bind(this));Compose.log("discardMail",Compose.LogEvent.stop)};n.updateUI=function(){Compose.log("completeLaunch",Compose.LogEvent.start);Compose.Component.prototype.updateUI.call(this);Compose.log("completeLaunch",Compose.LogEvent.stop)};n.updateModel=function(n){var t=this.getMailMessageModel(),i=false,r,u;return t&&(n==="send"||this.isDirty())&&(Compose.Component.prototype.updateModel.call(this,n),r=Compose.platform,u=r.accountManager.loadAccount(t.get("accountId")),Jx.isNullOrUndefined(u)||(n==="send"&&t.set({moveToOutbox:true}),t.commit(n==="save"?["accountId"]:[]),i=true)),i};n.isDirty=function(){if(this._isDirty)return true;var n=false;return this.forEachChild(function(t){n=n||t.isDirty()}),n};n.setDirtyState=function(n){this._isDirty=n};n._validate=function(n,t){var i=false,r=Compose.Component.prototype.validate.call(this,n);return t||this.getValidationViewController().display(r),r.length===0&&(i=true),i};n._runAction=function(n,t,i){var r=function(t){!i&&Jx.isObject(this._actionHandlers)&&Jx.isObject(this._actionHandlers[n])&&Jx.isFunction(this._actionHandlers[n][t])&&this._actionHandlers[n][t](this.getMailMessageModel(),this.getComponentCache())}.bind(this),u;return r("beforeAction"),this.raiseEvent("before"+n),u=t(),this.raiseEvent("after"+n),r("afterAction"),u}});Jx.delayGroup("MailCompose",function(){Object.defineProperty(Compose,"binder",{get:function(){return Object.defineProperty(Compose,"binder",{value:Jx.Binder.instance(),configurable:true}),Compose.binder},configurable:true,enumerable:true});Compose.ComponentBinder=function(n){this._impl=Compose.ComponentBinderImpl.instance(n)};var n=Compose.ComponentBinder.prototype;Compose.ComponentBinder.validationViewControllerClassName="{{ValidationViewController}}";Compose.ComponentBinder.messageModelClassName="{{MessageModel}}";n.setValidationViewController=function(n){this._impl.setValidationViewController(n)};n.setMailMessageModel=function(n){this._impl.setMailMessageModel(n)};n.attach=function(n,t){var r={jxBindings:Compose.binder.attach(n,t.filter(function(n){return Jx.isUndefined(n.fromComponent)})),componentBindings:[]},i={},u=this._impl;return t.filter(function(n){return Jx.isNonEmptyString(n.fromComponent)}).forEach(function(n){var t=i[n.fromComponent]=i[n.fromComponent]||[];t.push(n)}),Object.keys(i).forEach(function(t){var f=i[t];u.attachToComponent(n,t,f);r.componentBindings.push({componentUnbind:function(){u.detachFromComponent(n,t,f)}})}),r};n.addAttach=function(n,t,i){var r=this.attach(t,i);return n.jxBindings.concat(r.jxBindings),n.componentBindings.concat(r.componentBindings),r};n.detach=function(n){Compose.binder.detach(n.jxBindings);n.componentBindings.forEach(function(n){n.componentUnbind()})}});Jx.delayGroup("MailCompose",function(){var u,t;Compose.ComponentBinderImpl=function(n){this._componentCache=n;this._myBindings=null;var t=this._eventSources={};t[i]=null;t[r]=null;this._sourcesToTargetsMap={};this._attachToComponentCache()};Compose.ComponentBinderImpl.instance=function(n){return new Compose.ComponentBinderImpl(n)};var n=Compose.ComponentBinderImpl.prototype,i=Compose.ComponentBinder.validationViewControllerClassName,r=Compose.ComponentBinder.messageModelClassName;n.setValidationViewController=function(n){this._setEventSource(n,i)};n.setMailMessageModel=function(n){this._setEventSource(n,r)};n.attachToComponent=function(n,t,i){var r,f,u,e;r=n.getClassName();f={target:n,binderDefinitions:i,bindings:null};u=this._sourcesToTargetsMap[t]=this._sourcesToTargetsMap[t]||{};e=u[r]=u[r]||[];e.push(f);this._ensureBindings(t)};n.detachFromComponent=function(n,i,r){var s,f,o,u,e;for(s=n.getClassName(),f=this._sourcesToTargetsMap[i][s],o=-1,u=0;u<f.length;u++)if(e=f[u],r===e.binderDefinitions){Jx.isNullOrUndefined(e.bindings)||t(e);o=u;break}f.splice(o,1)};n._setEventSource=function(n,t){if(n!==this._eventSources[t]){var i=this._eventSources[t];Jx.isObject(i)&&(this._eventSources[t]=null,this._ensureBindings(t));this._eventSources[t]=n;this._ensureBindings(t)}};n._getComponent=function(n){return this._eventSources.hasOwnProperty(n)?this._eventSources[n]:this._componentCache.getComponent(n)};n._attachToComponentCache=function(){this._myBindings=Compose.binder.attach(this,[{on:"added",from:this._componentCache,then:this._onComponentCacheChange},{on:"removed",from:this._componentCache,then:this._onComponentCacheChange}])};n._onComponentCacheChange=function(n){var t=n.component;this._ensureBindings(t.getClassName())};n._ensureBindings=function(n){var i,r;i=this._sourcesToTargetsMap[n];Jx.isObject(i)&&(r=this._getComponent(n),Object.keys(i).forEach(function(n){i[n].filter(function(n){return Boolean(n.bindings)===!Boolean(r)}).forEach(function(n){Boolean(r)?u(n,r):t(n)})}))};u=function(n,t){var i=n.binderDefinitions;n.bindings=Compose.binder.attach(n.target,i.map(function(n){return{on:n.on,from:t,then:n.then}}))};t=function(n){Compose.binder.detach(n.bindings);n.bindings=null}});Jx.delayGroup("MailCompose",function(){Compose.MailMessageCreator=function(){this._callback=null};Compose.MailMessageCreator.prototype={createMessage:function(){return null},onMessageCreated:function(){var n=this._callback;Jx.isFunction(n)&&n()},setCallback:function(n){this._callback=n},getCallback:function(){return this._callback},generatesNewPlatformMessage:function(){return true}}});Jx.delayGroup("MailCompose",function(){Compose.MessageReturner=function(n){this._message=n};Compose.MessageReturner.instance=function(n){return new Compose.MessageReturner(n)};Jx.augment(Compose.MessageReturner,Compose.MailMessageCreator);var n=Compose.MessageReturner.prototype;n.createMessage=function(){return this._message};n.generatesNewPlatformMessage=function(){return false}});Jx.delayGroup("MailCompose",function(){Compose.MessageLoader=function(n){Compose.MailMessageCreator.call(this);this._messageId=n};Compose.MessageLoader.instance=function(n){return new Compose.MessageLoader(n)};Jx.augment(Compose.MessageLoader,Compose.MailMessageCreator);var n=Compose.MessageLoader.prototype;n.createMessage=function(){var n=null;try{n=Compose.platform.mailManager.loadMessage(this._messageId)}catch(t){Jx.log.error(t)}return n};n.generatesNewPlatformMessage=function(){return false}});Jx.delayGroup("MailCompose",function(){Compose.FallbackMessageCreator=function(n){Compose.MailMessageCreator.call(this);this._firstTry=n;this._didFallback=false;this._messageModel=null};Compose.FallbackMessageCreator.instance=function(n){return new Compose.FallbackMessageCreator(n)};var n=Compose.FallbackMessageCreator.prototype;n.setMailMessageModel=function(n){this._messageModel=n};n.createMessage=function(){var e=Compose.platform,n,f,i;if(n=Jx.isObject(this._firstTry)?this._firstTry.createMessage():null,n===null){var o=Microsoft.WindowsLive.Platform.MailViewType,r=Microsoft.WindowsLive.Platform.FilterCriteria,u=Mail.Utilities.ComposeHelper.currentSelectedFilter,t=null;u!==null&&(t=u.currentFilter);f=Mail.Utilities.ComposeHelper._selection;i=f.view;var s=i.type,h=t===r.flagged||s===o.flagged,c=t!==r.unread;n=e.mailManager.createDraftMessage(i.platformMailView);n.flagged=h;n.read=c;this._messageModel.setInitAction(Compose.ComposeAction.createNew);this._messageModel.setBodyContents([{content:"",format:ModernCanvas.ContentFormat.text,location:ModernCanvas.ContentLocation.end}]);this._didFallback=true}return n};n.onMessageCreated=function(){this._didFallback||this._firstTry.onMessageCreated()}});Jx.delayGroup("MailCompose",function(){function t(n){var t=false;try{t=n.isInSpecialFolderType(Microsoft.WindowsLive.Platform.MailFolderType.junkMail)}catch(i){Jx.log.exception("Exception getting message's folder type, assuming not junk",i)}return t}Compose.MessageCloner=function(n){Compose.MailMessageCreator.call(this);this._messageCreator=n;this._messageModel=null;this._originalMessage=null;this._cloneMessage=null};Compose.MessageCloner.instance=function(n){return new Compose.MessageCloner(n)};Jx.augment(Compose.MessageCloner,Compose.MailMessageCreator);var n=Compose.MessageCloner.prototype;n.setMailMessageModel=function(n){this._messageModel=n};n.createMessage=function(){var i=null,n=this._originalMessage=this._messageCreator.createMessage(),u=this._messageModel;if(n){var r=u.getInitAction(),f=r===Compose.ComposeAction.forward,e=t(n),o=Compose.util.convertToMailVerb(r),s=Mail.Utilities.ComposeHelper._selection;Compose.log("cloneMessage",Compose.LogEvent.start);i=this._cloneMessage=n.cloneMessage(f&&!e,o,s.view.platformMailView);Compose.log("cloneMessage",Compose.LogEvent.stop)}return i};n.onMessageCreated=function(){var n=this.getCallback();Jx.isFunction(n)&&n(this._originalMessage,this._cloneMessage,this._messageModel)}});Jx.delayGroup("MailCompose",function(){var t=["dir"],n;Compose.MailMessageFactoryUtil=function(){};Compose.MailMessageFactoryUtil.prototype={rePrefix:"Re: ",fwPrefix:"Fw: ",addReplyHeaderContents:function(t,i){i.get("irmCanEdit")&&i.get("irmCanExtractContent")&&i.prependBodyContents([{content:n.prepareReplyInfoFromOriginalMessage(t),format:ModernCanvas.ContentFormat.htmlString,location:ModernCanvas.ContentLocation.end}])},getFromEmailAddressToUse:function(n,t,i){var o,e,u,r,f;for(o=n.sendAsAddresses,e={},r=0,f=o.size;r<f;r++)e[o[r].toLowerCase()]=true;for(r=0,f=t.size;r<f;r++)if(u=t[r].emailAddress.toLowerCase(),e[u])return u;for(r=0,f=i.size;r<f;r++)if(u=i[r].emailAddress.toLowerCase(),e[u])return u;return n.preferredSendAsAddress},normalizeSubject:function(n){return n.replace(/^((FW|FWD|RE):\s*)+/i,"")},getReplyHeaderRecipientsHtml:function(n){var t="";return n.forEach(function(n){var r=Jx.escapeHtml(n.calculatedUIName),i=Jx.escapeHtml(n.emailAddress),u="<a tabindex='-1' title='mailto:"+i+"' href='mailto:"+i+"'>"+r+"<\/a>";t!==""&&(t+=", ");t+=u}),t},prepareReplyInfoFromOriginalMessage:function(t){var r,i,u,f,e,o;return Compose.log("prepareReplyInfo",Compose.LogEvent.start),r=t.sent,r||(r=t.received),i={recipientsCc:null,recipientsTo:this.getReplyHeaderRecipientsHtml(t.toRecipients),recurring:null,sender:this.getReplyHeaderRecipientsHtml(Jx.isNullOrUndefined(t.fromRecipient)?[]:[t.fromRecipient]),sentDate:Jx.escapeHtml(Mail.Utilities.getVerboseDateString(r)+" "+Mail.Utilities.getShortTimeString(r)),when:null,where:null},t.cc&&(i.recipientsCc=this.getReplyHeaderRecipientsHtml(t.ccRecipients)),u=t.calendarEvent,t.calendarMessageType!==Microsoft.WindowsLive.Platform.CalendarMessageType.none&&Boolean(u)&&(f=Compose.platform,e=f.accountManager.loadAccount(t.accountId),i.when=Jx.escapeHtml(Mail.Utilities.getCalendarEventTimeRange(e,u)),i.where=Jx.escapeHtml(u.location),i.recurring=u.recurring),o=n.prepareReplyInfo(i),Compose.log("prepareReplyInfo",Compose.LogEvent.stop),o},prepareReplyInfo:function(n){var t=Jx.DynamicFont;return n.primaryFontFamily=ModernCanvas.removeFakeFontNames(t.getPrimaryFontFamilyQuoted("'")),n.authoringFontFamily=ModernCanvas.removeFakeFontNames(t.getAuthoringFontFamilyQuoted("'")),n.fontSizeNormal="font-size:12pt;letter-spacing:0.02em;line-height:15pt",Compose.Templates.replyHeader(n)},getRecipientString:function(n){var i="",t=n.calculatedUIName,r=n.emailAddress;return Boolean(t)&&t!==r&&(i='"'+t+'" '),i+("<"+r+">;")},getRecipientsStringWithoutReceiver:function(t,i,r){for(var o="",s,f,h,e={},c={},u=i.length;u--;)e[i[u].toLowerCase()]=true;if(r)for(u=r.length;u--;)Jx.isObject(r[u])&&(e[r[u].emailAddress.toLowerCase()]=true);for(u=0,h=t.length;u<h;u++)Jx.isObject(t[u])&&(s=t[u].emailAddress||"",f=s.toLowerCase(),e[f]||c[f]||(c[f]=true,o+=n.getRecipientString(t[u])));return o},getSourceMessage:function(n){var t=n.sourceMessageStoreId;if(t!=="0")try{return Compose.platform.mailManager.loadMessage(n.sourceMessageStoreId)}catch(i){Jx.log.exception("Failed to load message "+t,i)}return null},setInitialBody:function(i){var o=i.get("irmCanEdit"),s=i.get("irmCanExtractContent"),e,f;if(o&&s){var r=i.getPlatformMessage(),h=Mail.Account.load(r.accountId,Compose.platform),u=this.getSourceMessage(r);Jx.isNullOrUndefined(u)&&(u=r);e=Mail.getScrubbedDocument(Compose.platform,new Mail.UIDataModel.MailMessage(u,h));f=ModernCanvas.Mail.convertDocumentToDocumentFragment(e,t);u!==r&&n.updateEmbeddedAttachments(f,u,r);i.setBodyContents([{content:f,format:ModernCanvas.ContentFormat.documentFragment,location:ModernCanvas.ContentLocation.end}])}else i.setBodyContents([{content:"",format:ModernCanvas.ContentFormat.text,location:ModernCanvas.ContentLocation.end}])},updateEmbeddedAttachments:function(n,t,i){var r,u,c,e,o,f;if(r=t.getEmbeddedAttachmentCollection(),r.count!==0){var s=i.getEmbeddedAttachmentCollection(),h=n.querySelectorAll("img[src^='ms-appdata:///']"),l=function(n){for(var i,t=0,u=r.count;t<u;t++)if(i=r.item(t),i.bodyUri===n)return i},a=function(n){for(var i,t=0,r=s.count;t<r;t++)if(i=s.item(t),i.contentId===n)return i};for(u=0,c=h.length;u<c;u++)e=h[u],o=l(e.src),o&&(f=a(o.contentId),f&&Jx.isNonEmptyString(f.bodyUri)&&(e.src=f.bodyUri))}}};n=Compose.mailMessageFactoryUtil=new Compose.MailMessageFactoryUtil});Jx.delayGroup("MailCompose",function(){Compose.MailMessageModelForwardFactory=function(){};Compose.MailMessageModelForwardFactory.prototype={instance:function(n){var i=Compose.mailMessageFactoryUtil,r=Compose.MessageCloner.instance(n),t=Compose.MailMessageModel.instance({initAction:Compose.ComposeAction.forward,messageCreator:r});return r.setMailMessageModel(t),r.setCallback(function(n){var u=Compose.platform,f=u.accountManager.loadAccount(n.accountId),r=Compose.CalendarUtil;i.setInitialBody(t);i.addReplyHeaderContents(n,t);t.set({subject:i.fwPrefix+i.normalizeSubject(n.subject),to:"",cc:"",bcc:"",fromEmail:i.getFromEmailAddressToUse(f,n.toRecipients,n.ccRecipients)});r.messageRequiresForwardContent(t.getPlatformMessage())?t.addBodyContents([{signatureLocation:ModernCanvas.SignatureLocation.start},r.getDownlevelForwardBodyContent(n.calendarEvent,n.from)]):t.setSignatureLocation(ModernCanvas.SignatureLocation.start)}),t}};Compose.mailMessageModelForwardFactory=new Compose.MailMessageModelForwardFactory});Jx.delayGroup("MailCompose",function(){Compose.MailMessageModelReplyAllFactory=function(){};Compose.MailMessageModelReplyAllFactory.prototype={instance:function(n){var t=Compose.mailMessageFactoryUtil,r=Compose.MessageCloner.instance(n),i=Compose.MailMessageModel.instance({initAction:Compose.ComposeAction.replyAll,messageCreator:r});return r.setMailMessageModel(i),r.setCallback(function(n){t.setInitialBody(i);t.addReplyHeaderContents(n,i);var a=Compose.platform,h=a.accountManager.loadAccount(n.accountId),r,f,c=false;var e=h.allEmailAddresses,l=n.replyToRecipients,o=n.fromRecipient,u=l.length>0?l:[o],s=n.toRecipients,v=n.ccRecipients;for(r=0,f=e.length;r<f;r++)if(Jx.isObject(o)&&e[r]===o.emailAddress){c=true;break}if(c)for(e=[],r=0,f=u.length;r<f;r++)u[r]!==o&&s.push(u[r]);else for(r=0,f=u.length;r<f;r++)u[r]===o?s.unshift(u[r]):s.push(u[r]);i.setSignatureLocation(ModernCanvas.SignatureLocation.start);i.set({subject:t.rePrefix+t.normalizeSubject(n.subject),to:t.getRecipientsStringWithoutReceiver(s,e)||n.replyTo||n.from,cc:t.getRecipientsStringWithoutReceiver(v,e,s),bcc:"",fromEmail:t.getFromEmailAddressToUse(h,n.toRecipients,n.ccRecipients),importance:Microsoft.WindowsLive.Platform.MailMessageImportance.normal})}),i}};Compose.mailMessageModelReplyAllFactory=new Compose.MailMessageModelReplyAllFactory});Jx.delayGroup("MailCompose",function(){Compose.MailMessageModelReplyFactory=function(){};Compose.MailMessageModelReplyFactory.prototype={instance:function(n){var i=Compose.mailMessageFactoryUtil,r=Compose.MessageCloner.instance(n),t=Compose.MailMessageModel.instance({initAction:Compose.ComposeAction.reply,messageCreator:r});return r.setMailMessageModel(t),r.setCallback(function(n){var r=Compose.platform,u=r.accountManager.loadAccount(n.accountId);i.setInitialBody(t);i.addReplyHeaderContents(n,t);t.setSignatureLocation(ModernCanvas.SignatureLocation.start);t.set({subject:i.rePrefix+i.normalizeSubject(n.subject),to:n.replyTo||n.from,cc:"",bcc:"",fromEmail:i.getFromEmailAddressToUse(u,n.toRecipients,n.ccRecipients),importance:Microsoft.WindowsLive.Platform.MailMessageImportance.normal})}),t}};Compose.mailMessageModelReplyFactory=new Compose.MailMessageModelReplyFactory});Jx.delayGroup("MailCompose",function(){Compose.ComposeBuilder=function(){this._componentCreator=null;this._componentCache=null;this._componentBinder=null;this._rootElement=null;this._compose=null};Compose.ComposeBuilder.instance=function(){return new Compose.ComposeBuilder};var n=Compose.ComposeBuilder.prototype;n.setRootElement=function(n){this._rootElement=n};n.getComposeRootElement=function(){return this._rootElement};n.build=function(n){var u;var i=this._getComponentCreator(),f=this._getComponentCache(),r=this._getComponentBinder(),t=i.getInstance(Compose.ComposeImpl);return r.setValidationViewController(n.validationViewController),r.setMailMessageModel(n.mailMessageModel),t.setComponentCreator(i),t.setComponentCache(f),t.setComponentBinder(r),t.setValidationViewController(n.validationViewController),t.setActionHandlers(n.actionHandlers),t.setRootElement(this._rootElement),Jx.isNullOrUndefined(n.mailMessageModel)||t.setMailMessageModel(n.mailMessageModel),u=function(n){Jx.isObject(n.getParent())&&n.getParent().removeChild(n)},n.components.forEach(function(n){u(i.getInstance(n))}),Jx.isObject(this._compose)&&(this._compose.forEachChild(function(n){n.deactivateUI()}),this._compose.removeChildren()),Compose.log("Ctor",Compose.LogEvent.start),n.components.forEach(function(n){t.addComponent(i.getInstance(n))}),Compose.log("Ctor",Compose.LogEvent.stop),this._compose=t,t};n.activateCurrent=function(){Compose.log("compose activate",Compose.LogEvent.start);var n=this._compose,t=this._componentCache.getComponent("Compose.Selection");n.isActivated()?t.isActivated()||t.composeActivateUI():n.activateUI();n.updateUI();Compose.log("compose activate",Compose.LogEvent.stop)};n.getCurrent=function(){return this._compose};n.closeCurrent=function(){var i=this._componentCache.getComponent("Compose.Selection"),n,t;i.isActivated()&&i.composeDeactivateUI();n=this._componentCache.getComponent("Compose.ToCcBcc");n.isActivated()&&n.clear();t=this._componentCache.getComponent("Compose.BodyComponent");t.isActivated()&&t.clear();Mail.Utilities.ComposeHelper.setComposeShowing(false);this._compose.setMailMessageModel(Compose.MailMessageModel.stubInstance())};n._getComponentCreator=function(){return this._getComponentCreator=function(){return this._componentCreator},this._componentCreator=new Compose.ComponentCreator,this._getComponentCreator()};n._getComponentCache=function(){return this._getComponentCache=function(){return this._componentCache},this._componentCache=new Compose.ComponentCache,this._getComponentCache()};n._getComponentBinder=function(){return this._getComponentBinder=function(){return this._componentBinder},this._componentBinder=new Compose.ComponentBinder(this._getComponentCache()),this._getComponentBinder()}});Jx.delayGroup("MailCompose",function(){Compose.CalendarCancelMessageModelFactory=function(){};Compose.CalendarCancelMessageModelFactory.prototype={instance:function(n){var i,t;var r=Compose.CalendarActionType.cancel,e=Compose.util.convertToComposeAction(r),u=n.calendar.account,f=Compose.mailMessageFactoryUtil,o=Compose.CalendarUtil,s=n.isOrganizer;return s?(i=Compose.MessageFromEventCreator.instance(n,u,r),t=Compose.MailMessageModel.instance({initAction:e,messageCreator:i}),i.setCallback(function(){var i,r,e;var s="",h="",c=n.getAttendees(),a=Compose.CalendarUtil.createRecipient,l=[],v=Microsoft.WindowsLive.Platform.Calendar.AttendeeType.optional,y=c.count;for(i=0;i<y;i++)r=c.item(i),e=a(r.name,r.email),l.push(e),r.attendeeType===v?h+=f.getRecipientString(e):s+=f.getRecipientString(e);t.addBodyContents([{content:o.getReplyHeaderHtmlFromEvent(n,u,l),format:ModernCanvas.ContentFormat.htmlString,location:ModernCanvas.ContentLocation.start},{signatureLocation:ModernCanvas.SignatureLocation.start}]);t.set({subject:n.subject,to:s,cc:h,bcc:"",importance:Microsoft.WindowsLive.Platform.MailMessageImportance.normal})}.bind(this)),t):(Jx.log.info("Not processing cancel request since user is not the organizer."),null)}};Compose.calendarCancelMessageModelFactory=new Compose.CalendarCancelMessageModelFactory});Jx.delayGroup("MailCompose",function(){Compose.CalendarForwardMessageModelFactory=function(){};Compose.CalendarForwardMessageModelFactory.prototype={instance:function(n){var i=Compose.CalendarActionType.forward,e=Compose.util.convertToComposeAction(i),r=Compose.mailMessageFactoryUtil,u=n.calendar.account,f=Compose.MessageFromEventCreator.instance(n,u,i),t=Compose.MailMessageModel.instance({initAction:e,messageCreator:f});return f.setCallback(function(i){var o;var f=Compose.CalendarUtil,s=f.getRecipientsArray(n),e=null;f.messageRequiresForwardContent(i)&&(e=f.getDownlevelForwardBodyContent(n));o=[{signatureLocation:ModernCanvas.SignatureLocation.start},{content:f.getReplyHeaderHtmlFromEvent(n,u,s),format:ModernCanvas.ContentFormat.htmlString,location:ModernCanvas.ContentLocation.end},f.getBodyContentFromEvent(n)];e&&o.push(e);t.addBodyContents(o);t.set({subject:r.fwPrefix+r.normalizeSubject(n.subject),to:"",cc:"",bcc:"",importance:Microsoft.WindowsLive.Platform.MailMessageImportance.normal})}.bind(this)),t}};Compose.calendarForwardMessageModelFactory=new Compose.CalendarForwardMessageModelFactory});Jx.delayGroup("MailCompose",function(){Compose.CalendarReplyMessageModelFactory=function(){};Compose.CalendarReplyMessageModelFactory.prototype={instance:function(n,t){var o=Compose.util.convertToComposeAction(t);var i=Compose.mailMessageFactoryUtil,r=Compose.CalendarUtil,u=n.calendar.account,e=Compose.MessageFromEventCreator.instance(n,u,t),f=Compose.MailMessageModel.instance({initAction:o,messageCreator:e});return e.setCallback(function(){var e,o,s;e=r.getRecipientsArray(n);f.addBodyContents([{signatureLocation:ModernCanvas.SignatureLocation.start},{content:r.getReplyHeaderHtmlFromEvent(n,u,e),format:ModernCanvas.ContentFormat.htmlString,location:ModernCanvas.ContentLocation.end},r.getBodyContentFromEvent(n)]);t===Compose.CalendarActionType.replyAll?(s=u.allEmailAddresses,o=i.getRecipientsStringWithoutReceiver(e,s)):t===Compose.CalendarActionType.reply&&(o=i.getRecipientString(r.createRecipient(n.organizerName,n.organizerEmail)));f.set({subject:i.rePrefix+i.normalizeSubject(n.subject),to:o,cc:"",bcc:"",importance:Microsoft.WindowsLive.Platform.MailMessageImportance.normal})}.bind(this)),f}};Compose.calendarReplyMessageModelFactory=new Compose.CalendarReplyMessageModelFactory});Jx.delayGroup("MailCompose",function(){Compose.CalendarEditResponseMessageModelFactory=function(){};Compose.CalendarEditResponseMessageModelFactory.prototype={instance:function(n,t,i){var f,e,u,r;return f=Compose.util.convertToComposeAction(i),e=n?Mail.Globals.platform.accountManager.loadAccount(n.accountId):t.calendar.account,u=Compose.MessageForEditResponseCreator.instance(n,t,e,i),r=Compose.MailMessageModel.instance({initAction:f,messageCreator:u}),u.setCallback(function(n){r.addBodyContents([{signatureLocation:ModernCanvas.SignatureLocation.start},]);r.set({subject:n.subject,to:n.to,cc:"",bcc:"",importance:n.importance})}.bind(this)),r}};Compose.calendarEditResponseMessageModelFactory=new Compose.CalendarEditResponseMessageModelFactory});Jx.delayGroup("MailCompose",function(){Compose.CalendarUtil={};Compose.CalendarUtil.getBodyContentFromEvent=function(n){var r=Microsoft.WindowsLive.Platform.Calendar.DataType,u=n.dataType,t,i;return u===r.plainText?(t=n.data,i=ModernCanvas.ContentFormat.text):u===r.html?(t=n.data,i=ModernCanvas.ContentFormat.htmlString):(t=n.subject,i=ModernCanvas.ContentFormat.text),{content:t,format:i,location:ModernCanvas.ContentLocation.end}};Compose.CalendarUtil.getReplyHeaderHtmlFromEvent=function(n,t,i){for(var u=n.organizerEmail,o=[],s=i.length,f,r=0;r<s;r++)f=i[r],f.emailAddress!==u&&o.push(f);var h=Jx.isNonEmptyString(n.organizerName)?n.organizerName:u,c={calculatedUIName:h,emailAddress:u},e=Compose.mailMessageFactoryUtil,l={recipientsCc:null,recipientsTo:e.getReplyHeaderRecipientsHtml(o),recurring:n.recurring,sender:e.getReplyHeaderRecipientsHtml([c]),sentDate:null,subject:Jx.escapeHtml(n.subject),when:Jx.escapeHtml(Mail.Utilities.getCalendarEventTimeRange(t,n)),where:Jx.escapeHtml(n.location)};return e.prepareReplyInfo(l)};Compose.CalendarUtil.createRecipient=function(n,t){var i=n;return Jx.isNonEmptyString(i)||(i=t),{calculatedUIName:i,emailAddress:t}};Compose.CalendarUtil.getRecipientsArray=function(n){var i=[],u=n.getAttendees(),f=Compose.CalendarUtil.createRecipient,e,t,r;for(Jx.isNonEmptyString(n.organizerEmail)&&i.push(f(n.organizerName,n.organizerEmail)),e=u.count,t=0;t<e;t++)r=u.item(t),i.push(f(r.name,r.email));return i};Compose.CalendarUtil.getDownlevelForwardBodyContent=function(n,t){var i=n.organizerEmail,r;return!Jx.isNonEmptyString(i)&&Jx.isNonEmptyString(t)&&(i=t),r="<div><br><\/div><div><br><\/div><div>"+Jx.res.loadCompoundString("composeForwardInviteMessage",'<a href="mailto:'+Jx.escapeHtml(i)+'">'+Jx.escapeHtml(n.organizerName||i)+"<\/a>")+"<\/div>",{content:r,format:ModernCanvas.ContentFormat.htmlString,location:ModernCanvas.ContentLocation.start}};Compose.CalendarUtil.messageRequiresForwardContent=function(n){var t,i;if(n.calendarMessageType!==Microsoft.WindowsLive.Platform.CalendarMessageType.request)return false;var u=true,r=null,f=Compose.platform,e=f.accountManager.loadAccount(n.accountId);return t=f.calendarManager.getAllCalendarsForAccount(e),t.lock(),t.count>0&&(r=t.item(0)),t.unlock(),t.dispose(),r&&(i=Microsoft.WindowsLive.Platform.Calendar.ServerCapability,u=(r.capabilities&i.canForward)!==i.canForward||(r.capabilities&i.canReplaceMime)!==i.canReplaceMime),u};Compose.CalendarUtil.PreEditResponseActionsEx=function(n,t,i,r,u){var s=Microsoft.WindowsLive.Platform.Calendar,e=Microsoft.WindowsLive.Platform.Calendar.ResponseType,o,f;r!==e.declined&&(o=Compose.platform,o.invitesManager.sendMeetingResponse(n,i,r,u),t&&(f=s.BusyStatus,t.responseType=r,t.busyStatus=r===e.accepted?t.allDayEvent?f.free:f.busy:f.tentative,t.commit()))};Compose.CalendarUtil.PreEditResponseActionsforCalendar=function(n,t){var i=n.calendar.account,r=Compose.util.convertCalendarActionTypeToCalenderResponseType(t);Compose.CalendarUtil.PreEditResponseActionsEx(n,n,null,r,i)};Compose.CalendarUtil.MoveMessageToDeleted=function(n){var t=Mail.Utilities.ComposeHelper._selection,i=t.account;t.moveItemsFrom(i.inboxView,i.deletedView,[n])}});Jx.delayGroup("MailCompose",function(){Compose.MessageFromEventCreator=function(n,t,i){Compose.MailMessageCreator.call(this);this._originalEvent=n;this._newMessage=null;this._account=t;this._action=i};Compose.MessageFromEventCreator.instance=function(n,t,i){return new Compose.MessageFromEventCreator(n,t,i)};Jx.augment(Compose.MessageFromEventCreator,Compose.MailMessageCreator);var n=Compose.MessageFromEventCreator.prototype;n.createMessage=function(){var n=null,t=Compose.platform;switch(this._action){case Compose.CalendarActionType.forward:n=t.invitesManager.createSmartForwardMail(this._originalEvent,this._account);break;case Compose.CalendarActionType.reply:case Compose.CalendarActionType.replyAll:n=t.mailManager.createMessage(this._account);break;case Compose.CalendarActionType.cancel:n=this._createCancelMail()}return this._newMessage=n,n};n._createCancelMail=function(){var i=Compose.platform,r=Compose.mailMessageFactoryUtil,n=Microsoft.WindowsLive.Platform.Calendar.MeetingStatus,t;return this._originalEvent.meetingStatus=n.isAMeeting|n.isCanceled,t=Jx.res.getString("EventCancelledPrefix"),this._originalEvent.subject=t+r.normalizeSubject(this._originalEvent.subject),i.invitesManager.mailFromEvent(this._originalEvent,this._account)};n.onMessageCreated=function(){var n=this.getCallback();Jx.isFunction(n)&&n(this._newMessage)}});Jx.delayGroup("MailCompose",function(){Compose.MessageForEditResponseCreator=function(n,t,i,r){Compose.MessageFromEventCreator.call(this,t,i,r);this._inviteMessage=n};Compose.MessageForEditResponseCreator.instance=function(n,t,i,r){return new Compose.MessageForEditResponseCreator(n,t,i,r)};Jx.augment(Compose.MessageForEditResponseCreator,Compose.MessageFromEventCreator);var n=Compose.MessageForEditResponseCreator.prototype;n.createMessage=function(){var n=null,t=Compose.platform,i=Compose.util.convertCalendarActionTypeToCalenderResponseType(this._action);switch(this._action){case Compose.CalendarActionType.accept:case Compose.CalendarActionType.tentative:case Compose.CalendarActionType.decline:n=t.invitesManager.createResponseMail(this._originalEvent,this._inviteMessage,i,this._account)}return this._newMessage=n,n}})