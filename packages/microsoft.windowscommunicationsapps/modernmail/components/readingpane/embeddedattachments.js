Jx.delayDefine(Mail,"EmbeddedAttachments",function(){"use strict";function r(t,i){var u,r,f;for(u=i.objectId!=="0"?"objectId":"bodyUri",r=0,f=t.length;r<f;r++)if(t[r][u]===i[u])return true;return false}function f(t){var i,r,u,f;return(i=t.contentType,!i||i==="application/octet-stream")?(r=AttachmentWell.Utils.getFileExtension(t),u=r===""||AttachmentWell.Utils.isSupportedPhotoFormat(r),u||(f=[".ext",".bin"],u=f.indexOf(r.toLowerCase())>=0),u):i.indexOf("image/")===0}var n=Microsoft.WindowsLive.Platform,i=n.AttachmentSyncStatus,u=Mail.EmbeddedAttachments=function(n,t,i,r){Mail.writeProfilerMark("EmbeddedAttachments.constructor",Mail.LogEvent.start);this._message=n;this._isTruncated=t;this._element=i;this._fixed=[];this._attachmentsWithListeners=[];this._embeddedButNotForDirectUse=null;this._imgsButNotForDirectUse=null;this._onAttachmentChanged=this._onAttachmentChanged.bind(this);this._fixLocal();this._downloadStatus=r;r&&r.newMessageSelected();Mail.writeProfilerMark("EmbeddedAttachments.constructor",Mail.LogEvent.stop)},t=u.prototype;t.dispose=function(){Mail.writeProfilerMark("EmbeddedAttachments.dispose",Mail.LogEvent.start);this._attachmentsWithListeners.forEach(function(t){t.removeEventListener("changed",this._onAttachmentChanged)},this);this._downloadStatus&&(this._downloadStatus.clear(),this._downloadStatus=null);Mail.writeProfilerMark("EmbeddedAttachments.dispose",Mail.LogEvent.stop)};Object.defineProperty(t,"embeddedCount",{get:function(){return this._getEmbedded().length}});t._getEmbedded=function(){var n,t,i;if(!this._embeddedButNotForDirectUse){for(Mail.writeProfilerMark("EmbeddedAttachments._getEmbedded",Mail.LogEvent.start),n=this._message.getEmbeddedAttachmentCollection(),this._embeddedButNotForDirectUse=[],t=0,i=n.count;t<i;t++)this._embeddedButNotForDirectUse.push(n.item(t));n.dispose();Mail.writeProfilerMark("EmbeddedAttachments._getEmbedded",Mail.LogEvent.stop)}return this._embeddedButNotForDirectUse};t._getImages=function(){return this._imgsButNotForDirectUse||(this._imgsButNotForDirectUse=this._element.querySelectorAll("img[src]")),this._imgsButNotForDirectUse};t._commitMessage=function(){this._message.commit();this._embeddedButNotForDirectUse=null};t._fixLocal=function(){var t=this._getEmbedded();t.length!==0&&t.forEach(function(t){t.syncStatus===i.done&&this._fix(t)},this)};t._fix=function(t){var h,s;if(Mail.writeProfilerMark("EmbeddedAttachments._fix",Mail.LogEvent.start),t.uiType!==n.AttachmentUIType.embedded){Mail.writeProfilerMark("EmbeddedAttachments._fix",Mail.LogEvent.stop);return}if(h=this._getEmbedded(),r(this._fixed,t)){Mail.writeProfilerMark("EmbeddedAttachments._fix",Mail.LogEvent.stop);return}var u=t.contentId,e=false,o=f(t);o&&Jx.isNonEmptyString(u)&&(s="cid:"+u.toLowerCase().trim().replace(/^</,"").replace(/>$/,""),Array.prototype.forEach.call(this._getImages(),function(n){if(n.src.toLowerCase()===s){e=true;var i=t.bodyUri;Jx.isNonEmptyString(i)&&(n.src=i)}},this));e&&o||this._isTruncated||this._message.isDraft?this._fixed.push(t):(Mail.writeProfilerMark("EmbeddedAttachments.updateEmbeddedAttachment - changing type to ordinary",Mail.LogEvent.start),t.uiType=n.AttachmentUIType.ordinary,this._commitMessage(),Mail.writeProfilerMark("EmbeddedAttachments.updateEmbeddedAttachment - changing type to ordinary",Mail.LogEvent.stop));Mail.writeProfilerMark("EmbeddedAttachments._fix",Mail.LogEvent.stop)};t.downloadAll=function(){Mail.writeProfilerMark("EmbeddedAttachments.downloadAll",Mail.LogEvent.start);this._fixOrdinary();var t=this._getEmbedded();t.forEach(function(t){if(t.syncStatus===i.done)this._fix(t);else{this._attachmentsWithListeners.push(t);t.addEventListener("changed",this._onAttachmentChanged);try{t.downloadBody()}catch(u){Jx.log.exception("Cannot download body",u);t.removeEventListener("changed",this._onAttachmentChanged);this._attachmentsWithListeners.pop()}}},this);this._attachmentsWithListeners.length===0&&this._downloadStatus&&this._downloadStatus.downloadComplete();Mail.writeProfilerMark("EmbeddedAttachments.downloadAll",Mail.LogEvent.stop)};t._onAttachmentChanged=function(t){var u,f;Mail.writeProfilerMark("EmbeddedAttachments._onAttachmentChanged",Mail.LogEvent.start);u=t.target;u.syncStatus===i.done?(f=this._attachmentsWithListeners.indexOf(u),this._attachmentsWithListeners.splice(f,1),u.removeEventListener("changed",this._onAttachmentChanged),this._fix(u),this._attachmentsWithListeners.length===0&&this._downloadStatus&&this._downloadStatus.downloadComplete()):u.syncStatus===i.failed&&this._downloadStatus&&this._downloadStatus.downloadError();Mail.writeProfilerMark("EmbeddedAttachments._onAttachmentChanged",Mail.LogEvent.stop)};t._fixOrdinary=function(){var i,e,r,u;if(Mail.writeProfilerMark("EmbeddedAttachments._fixOrdinary",Mail.LogEvent.start),this._message.hasOrdinaryAttachments){var o=this._getImages(),t=this._message.getOrdinaryAttachmentCollection(),f=false;if(!Jx.isNullOrUndefined(t)){for(i=0,e=t.count;i<e;i++)r=t.item(i),u=this._isOrdinaryAttachmentUsedInline(r,o),u&&(Mail.writeProfilerMark("EmbeddedAttachments._fixOrdinary - changing type to embedded"),r.uiType=n.AttachmentUIType.embedded,r.contentId=u,f=true);t.dispose()}f&&this._commitMessage()}Mail.writeProfilerMark("EmbeddedAttachments._fixOrdinary",Mail.LogEvent.stop)};t._isOrdinaryAttachmentUsedInline=function(t,i){var r,u;return(r=t.fileName,Jx.isNonEmptyString(r)&&this._checkForCID(r,i))?r:(u=t.contentId,Jx.isNonEmptyString(u)&&this._checkForCID(u,i))?u:null};t._checkForCID=function(n,t){var i="cid:"+n.toLowerCase().trim().replace(/^</,"").replace(/>$/,"");return Array.prototype.some.call(t,function(n){return n.src.toLowerCase()===i},this)}})