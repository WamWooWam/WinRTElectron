Jx.delayDefine(Mail,"ReadingPaneTruncationControl",function(){"use strict";var t=Mail.ReadingPaneTruncationControl=function(n,t,i){this._rootId=n;this._readingPane=t;this._readingPaneBody=i;this._disposer=new Mail.Disposer;this._rootElement=null;this._message=null;this._timer=null;this._messageChangeHook=null},n=t._selectors={progressText:".mailReadingPaneDownloadMessageProgress",failureState:".mailReadingPaneDownloadMessageFailure",failureText:".mailReadingPaneDownloadMessageFailureText",link:".mailReadingPaneDownloadMessageLink",linkRetry:".mailReadingPaneDownloadMessageLinkRetry",control:".mailReadingPaneTruncationControl"},r=Microsoft.WindowsLive.Platform,i=r.BodyDownloadStatus;t.prototype={dispose:function(){this._disposer.dispose();this._disposer=null;this._rootId=null;this._readingPane=null;this._readingPaneBody=null},_getRootElement:function(){return this._rootElement||(this._rootElement=document.getElementById(this._rootId)),this._rootElement},activateUI:function(){var t=this._getRootElement(),i=t.querySelector(n.link),r=t.querySelector(n.linkRetry);this._disposer.addMany(new Mail.EventHook(this._readingPaneBody,Mail.ReadingPaneBody.Events.bodyLoaded,this._onBodyLoaded,this),new Mail.EventHook(i,"click",this._onDownloadLinkClick,this,false),new Mail.EventHook(r,"click",this._onDownloadLinkClick,this,false))},setMessage:function(n){this._disposer.disposeNow(this._messageChangeHook);this._messageChangeHook=null;this._message=n;n&&(this._messageChangeHook=new Mail.EventHook(n.platformMailMessage,"changed",this._messageChanged,this),this._disposer.add(this._messageChangeHook))},_onBodyLoaded:function(){this.updateTruncationControl()},updateTruncationControl:function(){var t=this._message,r;Jx.isNullOrUndefined(t)||t.needBody||(r=this._readingPaneBody.getBodyType(),Jx.isNumber(r)&&t.isBodyTruncated(r)?(this._showElement(n.control),t.bodyDownloadStatus===i.upToDate?(this._showElement(n.link),this._hideElement(n.progressText),this._hideElement(n.failureState)):t.bodyDownloadStatus===i.inProgress?(this._showElement(n.progressText),this._hideElement(n.link),this._hideElement(n.failureState),this._getRootElement().querySelector(n.progressText).innerText=Jx.res.getString("mailReadingPaneDownloadProgress")):(this._showElement(n.failureState),this._hideElement(n.link),this._hideElement(n.progressText),this._getRootElement().querySelector(n.failureText).innerText=Jx.res.getString("mailReadingPaneDownloadFailure"))):this._hideElement(n.control))},_showElement:function(n){this._getRootElement().querySelector(n).classList.remove("hidden")},_hideElement:function(n){this._getRootElement().querySelector(n).classList.add("hidden")},_onDownloadLinkClick:function(){this._readingPaneBody.focusAfterReload=true;this._message.downloadFullBody()},updateBodyDownloadStatus:function(){this._message.bodyDownloadStatus===i.failed&&(this.clearProgressRingTimer(),this._showElement(".mailReadingPaneMissingBodyMessage"),this._hideElement(".mailReadingPaneProgress"))},clearProgressRingTimer:function(){this._disposer.disposeNow(this._timer);this._timer=null},_messageChanged:function(n){var t="ReadingPaneTruncationControl._messageChanged:";Mail.Validators.hasPropertyChanged(n,"bodyDownloadStatus")?(t+="bodyDownloadStatus - "+this._message.objectId,Mail.writeProfilerMark(t,Mail.LogEvent.start),this._message.needBody?this.updateBodyDownloadStatus():this.updateTruncationControl(),Mail.writeProfilerMark(t,Mail.LogEvent.stop)):Mail.Validators.hasPropertyChanged(n,"needBody")&&(t+="needBody - "+this._message.objectId,Mail.writeProfilerMark(t,Mail.LogEvent.start),this._readingPane.refreshUI(),this._message.needBody||this._handleBodyDownloaded(),Mail.writeProfilerMark(t,Mail.LogEvent.stop))},_handleBodyDownloaded:function(){var n=Mail.guiState;n.isReadingPaneVisible&&this._readingPane.markAsRead()},canShowBody:function(){Mail.writeProfilerMark("ReadingPaneTruncationControl.canShowBody",Mail.LogEvent.start);var t=this._message,n=t.needBody;return n&&t.downloadFullBody(),this._showSpinner(n),Mail.writeProfilerMark("ReadingPaneTruncationControl.canShowBody",Mail.LogEvent.stop),!n},_showSpinner:function(n){var r=this._getRootElement(),i=r.querySelector(".mailReadingPaneProgress");t.showSpinner(n,r);i.classList.add("hidden");n?(Mail.writeProfilerMark("ReadingPaneTruncationControl.canShowBody - showing spinner for objectId: "+this._message.objectId),this._timer=this._disposer.replace(this._timer,new Jx.Timer(1e3,function(){i.classList.remove("hidden");WinJS.UI.Animation.fadeIn([i])},this))):this.clearProgressRingTimer()}};t.showSpinner=function(n,t){Jx.setClass(t.querySelector(".mailReadingPaneBodyWrapper"),"hidden",n);Jx.setClass(t.querySelector(".mailReadingPaneProgressWrapper"),"hidden",!n);Jx.setClass(t.querySelector(".mailReadingPaneProgress"),"hidden",!n)}})