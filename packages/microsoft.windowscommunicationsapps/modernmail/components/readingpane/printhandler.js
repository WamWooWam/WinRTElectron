Jx.delayDefine(Mail,"PrintHandler",function(){"use strict";var t,n={readingPaneContent:".mailReadingPaneContent",printHeaderTemplate:".mailReadingPanePrintHeaderTemplate",readingPaneSubject:".mailReadingPaneSubjectArea",readingPaneHeaderArea:".mailReadingPaneHeaderArea",readingPaneAttachmentWell:".mailReadingPaneAttachmentWell",readingPaneInviteArea:".mailReadingPaneInviteArea"};Mail.PrintHandler=function(){return t||(this._isActivated=false,this._frame=null,this._headerFrame=null,this._isPrintEnabled=false,this._completeCallback=null,this._rootElement=null,this._loadContent=this._loadContent.bind(this),this._loadHeader=this._loadHeader.bind(this),this._printTaskRequestedHandler=this._printTaskRequestedHandler.bind(this),this._printTaskSourceRequestedHandler=this._printTaskSourceRequestedHandler.bind(this),this._beforePrintHandlerInternal=this._beforePrintHandlerInternal.bind(this),this._afterPrintHandlerInternal=this._afterPrintHandlerInternal.bind(this),t=this),t};Mail.PrintHandler.taskNameMaxLength=100;Object.defineProperty(Mail.PrintHandler.prototype,"printEnabled",{get:function(){return this._isPrintEnabled}});Mail.PrintHandler.prototype.deactivate=function(){this._isActivated&&(this._eventHook.dispose(),this._isActivated=false)};Mail.PrintHandler.prototype.activate=function(){var n,t;if(this._isActivated){Jx.log.info("Print handler already activated.");return}Mail.writeProfilerMark("PrintHandler_activate",Mail.LogEvent.start);n=Mail.Globals.commandManager;t=["printMenu"];n.registerShortcuts(t);this._eventHook=Mail.EventHook.createGlobalHook("composeVisibilityChanged",this.checkPrintViability,this);this._isActivated=true;this.checkPrintViability();Mail.writeProfilerMark("PrintHandler_activate",Mail.LogEvent.stop)};Mail.PrintHandler.prototype.setRootElement=function(n){this._rootElement!==n&&(this._rootElement=n,this._frame=this._rootElement.querySelector(".mailReadingPanePrintFrame"),this.checkPrintViability())};Object.defineProperty(Mail.PrintHandler.prototype,"_printFrame",{get:function(){return this._frame||(this._frame=document.createElement("iframe"),this._frame.className="mailReadingPanePrintFrame hidden",this._frame.sandbox="allow-same-origin",this._frame.src="about:blank",this._rootElement.querySelector(".mailReadingPanePrintFrameHost").replaceNode(this._frame)),this._frame},enumerable:false});Object.defineProperty(Mail.PrintHandler.prototype,"_printHeaderFrame",{get:function(){if(!this._headerFrame){this._headerFrame=document.createElement("iframe");this._headerFrame.className="mailReadingPanePrintHeaderFrame";var t=this._headerFrame.style;t.width="100%";t.border="0px";t.margin="0px";this._headerFrame.sandbox="allow-same-origin";this._headerFrame.src="/modernmail/Components/ReadingPane/ReadingPanePrintHeader.html";this._frame.contentDocument.querySelector(n.printHeaderTemplate).appendChild(this._headerFrame)}return this._headerFrame},enumerable:false});Mail.PrintHandler.prototype.checkPrintViability=function(){var t,n,i,r;t=Mail.Globals.appState.lastSelectedMessage;n=this._isActivated&&!Mail.Utilities.ComposeHelper.isComposeShowing&&Jx.isHTMLElement(this._rootElement)&&Jx.isObject(t)&&t.irmCanPrint;n!==this._isPrintEnabled&&(this._isPrintEnabled=n,i=n?"addEventListener":"removeEventListener",r=Windows.Graphics.Printing.PrintManager.getForCurrentView(),r[i]("printtaskrequested",this._printTaskRequestedHandler))};Mail.PrintHandler.prototype.showPrintUI=function(){Windows.Graphics.Printing.PrintManager.showPrintUIAsync()};Mail.PrintHandler.prototype._printTaskRequestedHandler=function(n){var i,t,r,u,f,e;Mail.writeProfilerMark("PrintHandler_printTaskRequested",Mail.LogEvent.start);i=Mail.Globals.appState.lastSelectedMessage;Jx.isObject(i)&&(t=Windows.Graphics.Printing.StandardPrintTaskOptions,r=i.subject,u=r.substr(0,Mail.PrintHandler.taskNameMaxLength),f=n.request.createPrintTask(u,this._printTaskSourceRequestedHandler),e=f.options.displayedOptions,e.push(t.mediaSize,t.duplex,t.inputBin,t.printQuality,t.staple,t.holePunch));Mail.writeProfilerMark("PrintHandler_printTaskRequested",Mail.LogEvent.stop)};Mail.PrintHandler.prototype._printTaskSourceRequestedHandler=function(n){Mail.writeProfilerMark("PrintHandler_printTaskSourceRequested",Mail.LogEvent.start);var t=n.getDeferral();WinJS.Promise.as(this._getPrintDocument()).done(function(i){i&&n.setSource(MSApp.getHtmlPrintDocumentSource(i));t.complete();Mail.writeProfilerMark("PrintHandler_printTaskSourceRequested",Mail.LogEvent.stop)})};Mail.PrintHandler.prototype._abort=function(n){n&&Jx.fault("PrintHandler.js","Print threw an exception",n);this._completeCallback();this._completeCallback=null};Mail.PrintHandler.prototype._loadContent=function(){var i,r,u,s,f;try{if(this._printFrame.contentDocument.readyState!=="complete")return;this._printFrame.contentDocument.removeEventListener("readystatechange",this._loadContent,false);var t=this._printFrame.contentDocument,e=t.body,o=t.head;if(!e||!o){this._abort();return}if(e.removeNode(true),o.removeNode(true),i=this._rootElement.querySelector(Mail.ReadingPaneBody._Selectors.bodyFrameElementSelector),r=i.contentDocument.head,u=i.contentDocument.body,!r||!u){this._abort();return}t.documentElement.appendChild(t.importNode(r,true));t.documentElement.appendChild(t.importNode(u,true));s=this._rootElement.querySelector(n.printHeaderTemplate);t.body.insertAdjacentElement("afterBegin",t.importNode(s,true));f=this._printHeaderFrame;f.contentDocument.readyState==="complete"?this._loadHeader():f.contentDocument.addEventListener("readystatechange",this._loadHeader,false)}catch(h){this._abort(h)}};Mail.PrintHandler.prototype._loadHeader=function(){var i,r,s,t,h,u,c,f,e,o;try{if(i=this._printHeaderFrame,i.contentDocument.readyState!=="complete")return;i.contentDocument.removeEventListener("readystatechange",this._loadHeader,false);r=Jx.DynamicFont;s="body:not(#spec) { font-family: "+r.getPrimaryFontFamilyQuoted('"')+"; } "+Mail.ReadingPaneBody._Selectors.bodyFrameElementSelector+" { font-family: "+r.getAuthoringFontFamilyQuoted('"')+"; }";Jx.addStyleToDocument(s,i.contentDocument);t=i.contentDocument.querySelector(n.readingPaneContent);t.innerHTML="";h=this._rootElement.querySelector(n.readingPaneHeaderArea).cloneNode(true);t.appendChild(h);u=this._rootElement.querySelector(n.readingPaneSubject).cloneNode(true);u.querySelector(".mailReadingPaneFlagGlyph").removeNode(true);t.appendChild(u);c=this._rootElement.querySelector(n.readingPaneAttachmentWell).cloneNode(true);t.appendChild(c);f=this._rootElement.querySelector(n.readingPaneInviteArea).cloneNode(true);f.querySelector(".calendarInviteButtons").removeNode(true);t.appendChild(f);e=this._printFrame.contentDocument;o=e.body;o.onbeforeprint=this._beforePrintHandlerInternal;o.onafterprint=this._afterPrintHandlerInternal;this._completeCallback(e)}catch(l){this._abort(l)}this._completeCallback=null};Mail.PrintHandler.prototype._getPrintDocument=function(){return new WinJS.Promise(function(n){this._completeCallback=n;try{this._printFrame.contentDocument.readyState==="complete"?this._loadContent():this._printFrame.contentDocument.addEventListener("readystatechange",this._loadContent,false)}catch(t){this._abort(t)}}.bind(this))};Mail.PrintHandler.prototype._beforePrintHandlerInternal=function(){var f;this._printFrame.classList.remove("hidden");var t=this._printHeaderFrame,i=t.contentDocument,n=i.documentElement,r=i.body,e=Windows.Globalization.ApplicationLanguages.languages[0],u=this._printFrame.contentDocument.body;r.style.direction=document.body.getComputedStyle().direction;u.lang=r.lang=e;u.style.maxWidth="";f=n.scrollHeight+n.offsetHeight-n.clientHeight;t.style.height=String(f)+"px"};Mail.PrintHandler.prototype._afterPrintHandlerInternal=function(){this._cleanup()};Mail.PrintHandler.prototype._cleanup=function(){this._printFrame.classList.add("hidden");this._printFrame.contentWindow.location.reload();this._headerFrame=null}})