Jx.delayDefine(Mail,"BodyWriter",function(){"use strict";function h(i){if(t("addFontFamilyStyles"),Jx.isObject(i.head)){var r=Jx.DynamicFont;Jx.addStyleToDocument("html { font-family: "+r.getAuthoringFontFamilyQuoted('"')+"; }",i)}n("addFontFamilyStyles")}function l(n,t){var i,u,e,r;i=false;try{u="<!DOCTYPE html><html><head><link href='/ModernMail/resources/css/ReadingPaneBody.css' rel='Stylesheet' type='text/css' /><\/head><body class='readingPaneBody'><div id='readingPaneBodyContent'><\/div><\/body><\/html>";t.open();MSApp.execUnsafeLocalFunction(function(){t.write(u)});t.close();h(t);e=t.getElementById("readingPaneBodyContent");r=n.body;Mail.applyDirection(t.body,r);e.innerText=r;i=true}catch(o){Jx.log.exception("writePlainText",o)}return i}function a(n){Jx.mark("BodyWriter:"+n)}function t(n){Jx.mark("BodyWriter."+n+",StartTA,BodyWriter")}function n(n){Jx.mark("BodyWriter."+n+",StopTA,BodyWriter")}var r=Microsoft.WindowsLive.Platform,f=r.MailBodyType,o=Jx.Bidi,c=Mail.Utilities,s=Mail.AppSettings.Direction,i=Mail.BodyWriter=function(i,u,f,e){if(t("ctor"),this._message=i,this._document=u,this._skipWriting=false,this._onNoBody=null,this._onNoBodyContext=null,f&&(f.onNoBody&&(this._onNoBody=f.onNoBody),f.onNoBodyContext&&(this._onNoBodyContext=f.onNoBodyContext),Jx.isBoolean(f.skipWriting)&&(this._skipWriting=f.skipWriting)),this._done=false,this._contentWritten=false,this._attachments=null,this._downloadStatus=e,this._disposer=new Mail.Disposer,this._disposer.add(new Mail.EventHook(i.platformMailMessage,"changed",this._onMessageChanged,this)),this._changeJob=null,this._jobSet=this._disposer.add(Jx.scheduler.createJobSet()),this._wasJunk=i.isJunk,this._wasJunk||i.sanitizedVersion===r.SanitizedVersion.noHtmlBody)this._writePlainText();else{var o=f&&f.sanitizedBody||i.getSanitizedBody();o?this._writeBody(o,this._skipWriting):this._onNoBody&&this._onNoBody.call(this._onNoBodyContext)}this.initEvents();n("ctor")},u,e;i.Events={contentChanged:"contentChanged",contentWritten:"contentWritten",processingDone:"processingDone"};Jx.inherit(i,Jx.Events);i.prototype.dispose=function(){t("dispose");this._disposer.dispose();n("dispose")};i.prototype._setBody=function(i){t("_setBody");this._body=i;this._disposer.disposeNow(this._bodyChangedHook);this._bodyChangedHook=this._disposer.add(new Mail.EventHook(i,"changed",this._onBodyChanged,this));n("_setBody")};i.prototype._onHTMLWriterError=function(i){t("_onHTMLWriterError");this._writer&&(this._disposer.disposeNow(this._writer),this._writer=null);this._jobSet.cancelJobs();i?this._writePlainText():this._raiseContentChanged();n("_onHTMLWriterError")};i.prototype._writePlainText=function(){t("_writePlainText");var i=this._message.getJunkBody();this._setBody(i);l(i,this._document)&&Jx.scheduler.addJob(this._jobSet,Mail.Priority.bodyContentChanged,"BodyWriter._writePlainText",this._onFirstPassFinished,this);n("_writePlainText")};i.prototype._writeBody=function(i,u){t("_writeBody");this._setBody(i);this._writer=this._disposer.add(new e(this._message,i,this._document,u,this._onHTMLWriterError,this));this._writer.write(this._onFirstPassFinished,this);n("_writeBody")};i.prototype.isContentWritten=function(){return this._contentWritten};i.prototype._onFirstPassFinished=function(){t("_onFirstPassFinished");this._contentWritten=true;this.raiseEvent(i.Events.contentWritten);Jx.scheduler.addJob(this._jobSet,Mail.Priority.readingPaneBodySecondPass,"BodyWriter-copyHandler",function(){this._disposer.add(new Mail.BodyCopyHandler(this._message,this._document.body))},this);this._body.type===f.sanitized&&(Jx.scheduler.addJob(this._jobSet,Mail.Priority.readingPaneBodySecondPass,"BodyWriter-attachments",function(){this._attachments=this._disposer.add(new Mail.EmbeddedAttachments(this._message,this._body.truncated,this._document.body,this._downloadStatus))},this),Jx.scheduler.addJob(this._jobSet,Mail.Priority.readingPaneBodySecondPass,"BodyWriter-download attachments",function(){this._attachments.downloadAll()},this));Jx.scheduler.addJob(this._jobSet,Mail.Priority.readingPaneBodySecondPass,"BodyWriter-finished",this._onFinished,this);n("_onFirstPassFinished")};i.prototype._onFinished=function(){t("_onFinished");this._done=true;this.raiseEvent(i.Events.processingDone);n("_onFinished")};i.prototype.runSynchronous=function(){this._writer&&this._writer.runSynchronous();this._jobSet.runSynchronous()};i.prototype.areImagesBlocked=function(){return this._writer?this._writer.areImagesBlocked():false};i.prototype.getBodyType=function(){var n=this._body;return n?n.type:null};i.prototype._raiseContentChanged=function(){t("_raiseContentChanged");this._changeJob||(this._changeJob=Jx.scheduler.addJob(this._jobSet,Mail.Priority.bodyContentChanged,null,function(){this._changeJob=null;this.raiseEvent(i.Events.contentChanged)},this));n("_raiseContentChanged")};i.prototype._onMessageChanged=function(i){if(t("_onMessageChanged"),Mail.Validators.hasPropertyChanged(i,"sanitizedVersion"))this._raiseContentChanged();else if(Mail.Validators.hasPropertyChanged(i,"displayViewIds")){var r=this._message.isJunk;this._wasJunk!==r&&(this._wasJunk=r,this._raiseContentChanged())}n("_onMessageChanged")};i.prototype._onBodyChanged=function(){t("_onBodyChanged");this._raiseContentChanged();n("_onBodyChanged")};u=10240;e=function(i,e,o,s,h,c){var k,y;if(t("HTMLWriter.ctor"),this._message=i,this._body=e,this._document=o,this._skipWriting=Boolean(s),this._onErrorCallback=h,this._onErrorCallbackContext=c,this._isValid=true,this._disposer=new Mail.Disposer,this._jobSet=this._disposer.add(Jx.scheduler.createJobSet()),e.length===0){a("HTMLWriter.ctor - no content");n("HTMLWriter.ctor");return}var l=JSON.parse(e.metadata),d=this._hasExternalImages=l.hasExternalImages,g=this._hasExternalBackgrounds=l.hasExternalBackgrounds,nt=l.hasCSSImages;if(this._direction=l.readingDirection,!this._skipWriting){for(var p=e.body,w=p.length,b=this._htmlParts=[],v=0;v<w;)k=w-v,y=Math.min(k,u),b.push(p.substr(v,y)),v+=y;b.length===0&&(this._htmlParts=[""]);this._nextPart=0}this._allowExternalImages=i.allowExternalImages;this._imagesBlocked=(d||g||nt)&&!this._allowExternalImages;n("HTMLWriter.ctor")};e.prototype={dispose:function(){t("HTMLWriter.dispose");this._document.close();this._onErrorCallback=null;this._onErrorCallbackContext=null;this._disposer.dispose();n("HTMLWriter.dispose")},runSynchronous:function(){this._jobSet.runSynchronous()},areImagesBlocked:function(){return this._imagesBlocked},write:function(i,r){if(this._isValid){t("HTMLWriter.write");var u=null;this._skipWriting||(u=this._addJob(this._writeContent,this,"BodyWriter.HTMLWriter._writeContent"));this._addJob(this._applyDirection,this,"BodyWriter.HTMLWriter._applyDirection");this._hasExternalImages&&this._allowExternalImages&&this._addJob(this._unblockImages,this,"BodyWriter.HTMLWriter._unblockImages");this._hasExternalBackgrounds&&this._allowExternalImages&&this._addJob(this._unblockBackgrounds,this,"BodyWriter.HTMLWriter._unblockBackgrounds");this._addJob(i,r,"BodyWriter.HTMLWriter.onComplete");u&&(u.runIteration(),h(this._document));n("HTMLWriter.write")}},_addJob:function(n,t,i){return Jx.scheduler.addJob(this._jobSet,Mail.Priority.readingPaneWriteContent,i,function(){try{return n.call(t)}catch(i){Jx.log.exception("BodyWriter.HTMLWriter: Failed when writing html to the reading pane",i);this._onError()}},this)},_onError:function(){t("HTMLWriter._onError");var i=this._onErrorCallback,r=this._onErrorCallbackContext;try{this._document.close()}catch(u){Jx.log.exception("BodyWriter.HTMLWriter: Unable to close document",u)}i.call(r,this._isValid);n("HTMLWriter._onError")},_writeContent:function(){var r,u,i,f;return t("HTMLWriter._writeContent"),r=this._htmlParts,u=this._nextPart++,i=this._document,u===0&&(t("HTMLWriter._writeContent-open"),i.open(),n("HTMLWriter._writeContent-open")),MSApp.execUnsafeLocalFunction(function(){t("HTMLWriter._writeContent-write");i.write(r[u]);n("HTMLWriter._writeContent-write")}),f=this._nextPart===r.length,f&&(t("HTMLWriter._writeContent-close"),i.close(),n("HTMLWriter._writeContent-close")),n("HTMLWriter._writeContent"),Jx.Scheduler.repeat(!f)},_unblockImages:function(){t("HTMLWriter._unblockImages");var i=this._document.getElementsByTagName("img");Array.prototype.forEach.call(i,function(n){n.src=n.getAttribute("data-ms-imgsrc")},this);n("HTMLWriter._unblockImages")},_unblockBackgrounds:function(){t("HTMLWriter._unblockBackgrounds");var i=this._document.querySelectorAll("[background]");Array.prototype.forEach.call(i,function(n){n.background=n.getAttribute("data-ms-background")},this);n("HTMLWriter._unblockBackgrounds")},_applyDirection:function(){var i,u,r;t("HTMLWriter._applyDirection");i=this._document;o.getDocumentDirection(i)||(c.haveRtlLanguage()?(u=this._direction,r=Mail.Globals.appSettings,i.body.style.direction=u!==o.Values.none&&r.readingDirection===s.auto?u:r.readingDirection!==s.auto?r.readingDirection:document.body.getComputedStyle().direction):i.body.style.direction=document.body.getComputedStyle().direction);n("HTMLWriter._applyDirection")}}})