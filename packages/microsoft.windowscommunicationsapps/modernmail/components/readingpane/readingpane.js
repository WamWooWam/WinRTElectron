Jx.delayDefine(Mail,"CompReadingPane",function(){"use strict";function r(n){Jx.mark("ReadingPane:"+n)}function i(n){Jx.mark("ReadingPane."+n+",StartTA,Mail,ReadingPane")}function t(n){Jx.mark("ReadingPane."+n+",StopTA,Mail,ReadingPane")}var n=Mail.CompReadingPane=function(n,r,u,f){i("Ctor");this._name="Mail.CompReadingPane";i("Ctor_InitComp");this.initComponent();t("Ctor_InitComp");this._disposer=new Mail.Disposer;this._selection=r;this._glomManager=u;this._header=new Mail.ReadingPaneHeader(r);this._imageDownloadStatus=new Mail.ImageDownloadStatus;this._subjectArea=new Mail.ReadingPaneSubjectArea(r);this._warning=new Mail.ReadingPaneWarning;this._body=new Mail.ReadingPaneBody(n,this,f,this._imageDownloadStatus);this._attachmentWell=new Mail.ReadingPaneAttachmentWell(n,this);this._calendarNotification=new Mail.ReadingPaneCalendarNotificationArea(n);this._truncate=new Mail.ReadingPaneTruncationControl(n,this,this._body);this._disposer.addMany(this._attachmentWell,this._calendarNotification,this._truncate);this._rootElement=null;this._canvasCommandBar=null;this._inviteArea=null;this._message=null;this._showPaneOnSelection=false;this._printHandler=null;this._rootElementId=n;MSApp.suppressSubdownloadCredentialPrompts(true);t("Ctor")};Jx.augment(n,Jx.Component);n.rootContentElementSelector=".mailReadingPaneContent";n.prototype.deactivateUI=function(){this._attachmentWell.clear();Jx.Component.deactivateUI.call(this);this._printHandler&&(this._printHandler.deactivate(),this._printHandler=null);this._header.dispose();this._header=null;this._imageDownloadStatus.dispose();this._imageDownloadStatus=null;this._subjectArea.dispose();this._subjectArea=null;this._warning.dispose();this._warning=null;Jx.isObject(this._inviteArea)&&(this._inviteArea.shutdown(),this._inviteArea=null);this._truncate.clearProgressRingTimer();this._body.deactivateUI();this._body=null;Jx.dispose(this._canvasCommandBar);this._canvasCommandBar=null;this._disposer.dispose();this._message=null};n.prototype.getUI=function(n){n.html=Mail.Templates.readingPane()};n.prototype.activateUI=function(){var n,r;i("activateUI");n=this._rootElement=document.getElementById(this._rootElementId);Jx.scheduler.addJob(null,Mail.Priority.readingPaneCommandBar,"ReadingPane.activateUI - create canvas command bar",function(){this._canvasCommandBar=new Mail.CompCanvasCommandBar(n,{back:".mailReadingPaneBackButton",deleteMessage:".mailReadingPaneDeleteButton",respond:".mailReadingPaneRespondButton",compose:".mailReadingPaneComposeButton",edit:".mailReadingPaneEditButton"});Mail.Globals.commandManager.registerCommandHost(this._canvasCommandBar)},this);this._insertIframes(n);Jx.scheduler.addJob(null,Mail.Priority.registerPrintHandler,"ReadingPane - create print handler",function(){this._printHandler=new Mail.PrintHandler;this._printHandler.activate();this._printHandler.setRootElement(n)},this);this._body.activateUI();this._header.initialize(n.querySelector(".mailReadingPaneHeaderArea"));this._imageDownloadStatus.initialize(n.querySelector(".mailReadingPaneImageDownloadStatusArea"));this._subjectArea.initialize(n.querySelector(".mailReadingPaneSubjectArea"));this._warning.initialize(n.querySelector(".mailReadingPaneWarning"));this._inviteArea=new Mail.CalendarInviteArea(this._selection);this._inviteArea.initialize(n.querySelector(".mailReadingPaneInviteArea"),[window,n.querySelector(Mail.ReadingPaneBody._Selectors.bodyFrameElementSelector).contentDocument]);this._hideOldContent();Jx.Component.prototype.activateUI.call(this);this._truncate.activateUI();this._disposer.add(new Mail.EventHook(Mail.guiState,"layoutChanged",this._onLayoutChanged,this));r=n.querySelector(".mailDraftEditButton");this._disposer.add(new Mail.EventHook(r,"click",this._editClicked,this));t("activateUI")};n.prototype._insertIframes=function(n){var t=document.createElement("iframe");t.className="mailReadingPaneBodyFrame";t.ariaLive="off";Mail.setAttribute(t,"data-win-res","aria-label:mailReadingPaneMessageBodyAriaLabel");Mail.setAttribute(t,"role","document");t.sandbox="allow-same-origin allow-top-navigation";t.tabindex=0;t.src="about:blank";n.querySelector(".mailReadingPaneScrollPreserver").appendChild(t)};n.prototype.showPane=function(n){var t=this._message,i=this._selection.message;n&&!Mail.Validators.areEqual(t,i)?(r("Delaying show of reading pane for selection. Current:"+(t?t.objectId:"null")+" pending Selection:"+(i?i.objectId:"null")),this._showPaneOnSelection=true,n=false):this._showPaneOnSelection&&(r("Clearing showPaneOnSelection flag"),this._showPaneOnSelection=false);r(n?"Showing rootElement":"Hiding rootElement");Jx.setClass(this._rootElement,"invisible",!n);n&&this._printHandler&&this._printHandler.setRootElement(this._rootElement)};n.prototype.refreshUI=function(){i("refreshUI");this._truncate.clearProgressRingTimer();this._header.setMessage(this._message);this._subjectArea.setMessage(this._message);Mail.GlomManager.messageOpenInAnotherWindow(this._message)&&this._message.isDraft?this._rootElement.querySelector(".mailReadingPaneDraftMessage").classList.remove("hidden"):(this._warning.setMessage(this._message),this._attachmentWell.setMessage(this._message),this._calendarNotification.setMessage(this._message),Jx.EventManager.fireDirect(null,"readingPaneHeaderLoaded"),this._truncate.canShowBody()&&this._body.update(this._message),this._inviteArea.setMessage(this._message));this._printHandler&&this._printHandler.checkPrintViability();t("refreshUI")};n.prototype._hideOldContent=function(){var u,r,f;for(i("HideOldContent"),u=this._rootElement.querySelector(n.rootContentElementSelector).querySelectorAll(".hideOnReload"),r=0,f=u.length;r<f;r++)Jx.addClass(u[r],"hidden");this._body.clearMessage();t("HideOldContent")};n.prototype.onNewSelectedMessageSynchronous=function(n,u){if(i("onNewSelectedMessage"),this._showPaneOnSelection&&(r("Showing Pane on selection"),this.showPane(true)),!u&&Mail.Validators.areEqual(this._message,n)){r("returning early because we're already displaying this message");t("onNewSelectedMessage");return}this._truncate.clearProgressRingTimer();r("Changing rendered messsage from "+(this._message?this._message.objectId:"null")+" to "+(n?n.objectId:"null"));this._message=n;this._hideOldContent();this._truncate.setMessage(this._message);Jx.isObject(this._message)?(i("SetValidMessage"),this._message.recordAction(Microsoft.WindowsLive.Platform.FolderAction.messageViewed),this.refreshUI(),Mail.guiState.isThreePane&&this.markAsRead(),t("SetValidMessage")):(this._inviteArea.setMessage(null),this._header.setMessage(null),this._subjectArea.setMessage(null),this._warning.setMessage(null),this._attachmentWell.setMessage(null),this._calendarNotification.setMessage(null),Mail.guiState.ensureNavMessageList());Jx.EventManager.fireDirect(null,"readingPaneBodyLoaded");t("onNewSelectedMessage")};Mail.CompReadingPane.prototype._getDocHidden=function(){return document.hidden};Mail.CompReadingPane.prototype.markAsRead=function(){var n=this._message,r;Mail.GlomManager.isParent()&&n&&(i("onMarkAsRead"),Mail.Globals.appSettings.autoMarkAsRead&&n.canMarkRead&&!n.read&&!this._getDocHidden()&&(r=Mail.Instrumentation,r.instrumentTriageCommand(r.Commands.markAsRead,r.UIEntryPoint.automatic,this._selection),this._selection.setReadState(true,[n])),t("onMarkAsRead"))};Mail.CompReadingPane.prototype._onLayoutChanged=function(){Mail.guiState.isReadingPaneVisible&&this.markAsRead();Mail.Utilities.ComposeHelper.isComposeShowing||this._setFocus()};n.prototype._editClicked=function(){this._glomManager.handleCommandBarNewChild()};n.prototype.onBodyProcessingDone=function(){this._attachmentWell.update()};n.prototype._setFocus=function(){Mail.setActiveHTMLElement(this._rootElement.querySelector(n.rootContentElementSelector))}})