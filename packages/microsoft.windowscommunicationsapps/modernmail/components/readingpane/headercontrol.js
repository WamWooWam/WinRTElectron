Jx.delayDefine(Mail,"HeaderControl",function(){"use strict";function t(n,t){return new People.IdentityControl(n,null,{getTooltip:function(n,t){return Jx.isNonEmptyString(n.emailAddress)&&t.indexOf(n.emailAddress)===-1?t+"\n"+n.emailAddress:t},onClick:function(n,i){People.ContactCard.show(n.person,i,t.account)},role:"option"})}Mail.HeaderControl=function(n){this._selection=n;this._host=null;this._addedUIListeners=false;this._onHeaderResize=this._onHeaderResize.bind(this);this._toggleExpandHeaders=this._toggleExpandHeaders.bind(this);this._jobSet=Jx.scheduler.createJobSet();this._addICJobSet=Jx.scheduler.createJobSet(this._jobSet);this._cleanupICJobSet=Jx.scheduler.createJobSet(this._jobSet);this._identityControls=[];this._arrowKeyHandlers=[];this._preventHeaderCollapse=false;this._headersExpanded=false;this._isOverflowDetected=false;this._detectOverflowAnimationFrameId=null;this._removeICTabStopsAnimationId=null;this._irmFlyout=null;this._detectOverflowSync=this._detectOverflowSync.bind(this);this._removeHiddenICTabStopsSync=this._removeHiddenICTabStopsSync.bind(this);this._onIrmClick=this._onIrmClick.bind(this);this._onIrmKeyDown=this._onIrmKeyDown.bind(this);this._isArm=Windows.ApplicationModel.Package.current.id.architecture===Windows.System.ProcessorArchitecture.arm};Mail.HeaderControl.prototype.initialize=function(n){var i,t,u,r,f;for(this._host=n,this._host.innerHTML=Mail.Templates.readingPaneHeader(),i=Mail.HeaderControl.expandableHeaderElements,t=0,u=i.length;t<u;t++)r=new MenuArrowKeyHandler(this._host.querySelector(i[t].content),{querySelector:"span",firstOnFocus:true,enableUp:false,enableDown:false}),r.activateUI(),this._arrowKeyHandlers[t]=r;f=Jx.res.loadCompoundString("mailReadingPaneOnBehalf",'<span class="mailReadingPaneBehalfSender"><\/span>','<span class="mailReadingPaneBehalfFrom"><\/span>');this._host.querySelector(".mailReadingPaneBehalfArea").innerHTML=f};Mail.HeaderControl.prototype.dispose=function(){var i,n,r,t;for(Mail.writeProfilerMark("HeaderControl.dispose",Mail.LogEvent.start),Jx.isNumber(this._detectOverflowAnimationFrameId)&&(window.cancelAnimationFrame(this._detectOverflowAnimationFrameId),this._detectOverflowAnimationFrameId=null),this._addedUIListeners&&(this._host.querySelector(".mailReadingPaneHeaderDetails").removeEventListener("mselementresize",this._onHeaderResize,false),this._host.querySelector(".mailReadingPaneExpandHeadersButton").removeEventListener("click",this._toggleExpandHeaders,false)),i=Mail.HeaderControl.expandableHeaderElements,n=0,r=i.length;n<r;n++)t=this._arrowKeyHandlers[n],t&&t.dispose(),this._arrowKeyHandlers[n]=null;this._cleanupICJobSet.runSynchronous();Jx.dispose(this._jobSet);this._jobSet=null;this._identityControls.forEach(function(n){n.shutdownUI()});this._identityControls=null;this._cancelPendingRemoveICTabStops();Jx.isNullOrUndefined(this._irmFlyout)||(this._host.querySelector(".mailReadingPaneIrmInfo").removeEventListener("click",this._onIrmClick,false),this._host.querySelector(".mailReadingPaneIrmInfo").removeEventListener("keydown",this._onIrmKeyDown,false),this._irmFlyout.hide(),this._irmFlyout=null);this._host=null;Mail.writeProfilerMark("HeaderControl.dispose",Mail.LogEvent.stop)};Mail.HeaderControl.prototype.isExpanded=function(){return this._headersExpanded};Mail.HeaderControl.prototype._ensureUIListeners=function(){this._addedUIListeners||(this._host.querySelector(".mailReadingPaneHeaderDetails").addEventListener("mselementresize",this._onHeaderResize,false),this._host.querySelector(".mailReadingPaneExpandHeadersButton").addEventListener("click",this._toggleExpandHeaders,false),this._addedUIListeners=true)};Mail.HeaderControl.prototype._onHeaderResize=function(){Mail.writeProfilerMark("HeaderControl._onSizeChange",Mail.LogEvent.start);this._isOverflowDetected=false;this._detectOverflow();this._removeHiddenICTabStops();Mail.writeProfilerMark("HeaderControl._onSizeChange",Mail.LogEvent.stop)};var n=null;Mail.HeaderControl.prototype._updateHeaderICField=function(i,r,u,f){var e,s,h,o,c;if(Mail.writeProfilerMark("HeaderControl._updateHeaderICField",Mail.LogEvent.start),u.length===0)Jx.isNonEmptyString(i)&&this._hideElement(i),this._hideElement(r).innerHTML="";else{for(Jx.isNonEmptyString(i)&&this._showElement(i),Mail.writeProfilerMark("HeaderControl._updateHeaderICField - createIC",Mail.LogEvent.start),e=u.map(function(n){return t(n,this._selection)},this),Mail.writeProfilerMark("HeaderControl._updateHeaderICField - createIC",Mail.LogEvent.stop),Jx.isNonEmptyString(f)&&e.length===1&&(Mail.writeProfilerMark("HeaderControl._updateHeaderICField - set user tile element",Mail.LogEvent.start),s=this._showElement(f),h=e[0],s.innerHTML=h.getUI(People.IdentityElements.Tile,{collapse:true,size:80,statusIndicator:null,tabIndex:-1,className:"mailReadingPaneUserTileIC"}),Mail.writeProfilerMark("HeaderControl._updateHeaderICField - set user tile element",Mail.LogEvent.stop)),Mail.writeProfilerMark("HeaderControl._updateHeaderICField - IC getUI",Mail.LogEvent.start),this._showElement(r).innerHTML=e.map(function(n){return n.getUI(People.IdentityElements.Name,{className:"mailReadingPaneHeaderIC"})}).join("; "),Mail.writeProfilerMark("HeaderControl._updateHeaderICField - IC getUI",Mail.LogEvent.stop),Mail.writeProfilerMark("HeaderControl._updateHeaderICField - IC activateUI",Mail.LogEvent.start),Jx.isValidNumber(n)||(n=this._isArm?2:10),o=0,c=Math.min(e.length,n);o<c;o++)this._activateNextIC(e);e.length>0&&Jx.scheduler.addJob(this._addICJobSet,Mail.Priority.addOverflowReadingPaneICs,"add overflow reading pane ICs",this._activateNextIC,this,[e]);Mail.writeProfilerMark("HeaderControl._updateHeaderICField - IC activateUI",Mail.LogEvent.stop)}Mail.writeProfilerMark("HeaderControl._updateHeaderICField",Mail.LogEvent.stop)};Mail.HeaderControl.prototype._activateNextIC=function(t){var i,r;return Mail.writeProfilerMark("HeaderControl._activateNextIC",Mail.LogEvent.start),i=t.shift(),i.activateUI(),this._identityControls.push(i),r=t.length,r%(n*2)==0&&this._detectOverflow(),Mail.writeProfilerMark("HeaderControl._activateNextIC",Mail.LogEvent.stop),Jx.Scheduler.repeat(r!==0)};Mail.HeaderControl.prototype.updateHeader=function(n,t,i,r,u,f,e,o,s){var y,h,a,b,v;if(Mail.log("ReadingPane_updateHeader",Mail.LogEvent.start),this._preventHeaderCollapse=e,this._ensureUIListeners(),this._identityControls.length>0&&(this._addICJobSet.cancelJobs(),Jx.scheduler.addJob(this._cleanupICJobSet,Mail.Priority.cleanupOldReadingPaneICs,"clean up reading pane ICs",function(n){var t=n.shift();return t.shutdownUI(),Jx.Scheduler.repeat(n.length!==0)},this,[this._identityControls]),this._identityControls=[]),Mail.writeProfilerMark("ReadingPane_updateHeader.headerRecipients",Mail.LogEvent.start),r.length<1)y=this._showElement(".mailReadingPaneSingleFrom"),y.innerText=u,this._hideElement(".mailReadingPaneUserTile");else{if(h=Jx.isObject(s),h&&o){var p=Mail.Globals.appState.selectedAccount,w=p?p.allEmailAddresses:[],k=r.length>0?r[0].emailAddress.toUpperCase():"",d=s.emailAddress.toUpperCase(),c=false,l=false;for(a=0,b=w.length;a<b&&(!c||!l);a++)v=w[a].toUpperCase(),c=c||k===v,l=l||d===v;h=!c||!l}h?(this._hideElement(".mailReadingPaneSingleFrom"),this._showElement(".mailReadingPaneBehalfArea"),this._updateHeaderICField(null,".mailReadingPaneBehalfFrom",r,".mailReadingPaneUserTile"),this._updateHeaderICField(null,".mailReadingPaneBehalfSender",[s])):this._updateHeaderICField(null,".mailReadingPaneSingleFrom",r,".mailReadingPaneUserTile")}Mail.writeProfilerMark("ReadingPane_updateHeader.headerRecipients",Mail.LogEvent.stop);Mail.writeProfilerMark("ReadingPane_updateHeader.ICFields",Mail.LogEvent.start);this._getElementAndSetVisibility(".mailReadingPaneNoRecipients",n.length+t.length+i.length===0);this._updateHeaderICField(".mailReadingPaneTo",".mailReadingPaneToContent",n);this._updateHeaderICField(".mailReadingPaneCC",".mailReadingPaneCCContent",t);this._updateHeaderICField(".mailReadingPaneBcc",".mailReadingPaneBccContent",i);Mail.writeProfilerMark("ReadingPane_updateHeader.ICFields",Mail.LogEvent.stop);this._expandHeaders(f);this._setOverflowDetected(false);this._detectOverflow();Mail.log("ReadingPane_updateHeader",Mail.LogEvent.stop)};Mail.HeaderControl.prototype.updateDateTime=function(n,t){Mail.writeProfilerMark("ReadingPane_updateHeader.simpleContent",Mail.LogEvent.start);this._showElement(".mailReadingPaneDateContent").innerText=n;Jx.isNonEmptyString(t)?this._showElement(".mailReadingPaneTimeContent").innerText=t:this._hideElement(".mailReadingPaneTimeContent");Mail.writeProfilerMark("ReadingPane_updateHeader.simpleContent",Mail.LogEvent.stop)};Mail.HeaderControl.prototype.updateIrmInfo=function(n,t,i){n?(Jx.isNullOrUndefined(this._irmFlyout)&&(this._irmFlyout=new WinJS.UI.Flyout(this._getElementAndSetVisibility(".mailReadingPaneIrmFlyout",true)),this._host.querySelector(".mailReadingPaneIrmInfo").addEventListener("click",this._onIrmClick,false),this._host.querySelector(".mailReadingPaneIrmInfo").addEventListener("keydown",this._onIrmKeyDown,false)),this._showElement(".mailReadingPaneIrmInfo").innerText=t,this._host.querySelector(".mailReadingPaneIrmDescription").innerText=i,this._host.querySelector(".mailReadingPaneIrmFlyout").setAttribute("aria-label",i)):this._hideElement(".mailReadingPaneIrmInfo")};Mail.HeaderControl.prototype._onIrmClick=function(){this._irmFlyout.show(this._host.querySelector(".mailReadingPaneIrmInfo"),"bottom","left")};Mail.HeaderControl.prototype._onIrmKeyDown=function(n){(n.keyCode===Jx.KeyCode.enter||n.keyCode===Jx.KeyCode.space)&&this._onIrmClick()};Mail.HeaderControl.prototype._cancelPendingRemoveICTabStops=function(){Jx.isNumber(this._removeICTabStopsAnimationId)&&(window.cancelAnimationFrame(this._removeICTabStopsAnimationId),this._removeICTabStopsAnimationId=null)};Mail.HeaderControl.prototype._removeHiddenICTabStops=function(){this._cancelPendingRemoveICTabStops();this._removeICTabStopsAnimationId=requestAnimationFrame(this._removeHiddenICTabStopsSync)};Mail.HeaderControl.expandableHeaderElements=[{root:".mailReadingPaneTo",content:".mailReadingPaneToContent"},{root:".mailReadingPaneCC",content:".mailReadingPaneCCContent"},{root:".mailReadingPaneBcc",content:".mailReadingPaneBccContent"}];Mail.HeaderControl.prototype._removeHiddenICTabStopsSync=function(){var i,t,n,r;for(Mail.writeProfilerMark("HeaderControl._removeHiddenICTabStopsSync",Mail.LogEvent.start),this._removeICTabStopsAnimationId=null,i=function(n,t){var u,i,f,r;for(u=n.querySelectorAll("span"),i=0,f=u.length;i<f;i++)r=u[i],r.offsetWidth===0?r.tabIndex=-1:(t.pushElement(r),i===0&&(r.tabIndex=0))},t=Mail.HeaderControl.expandableHeaderElements,n=0,r=t.length;n<r;n++)this._arrowKeyHandlers[n].reset(),i(this._host.querySelector(t[n].content),this._arrowKeyHandlers[n]);Mail.writeProfilerMark("HeaderControl._removeHiddenICTabStopsSync",Mail.LogEvent.stop)};Mail.HeaderControl.prototype._detectOverflow=function(){Mail.writeProfilerMark("HeaderControl._detectOverflow",Mail.LogEvent.start);Jx.isNumber(this._detectOverflowAnimationFrameId)&&window.cancelAnimationFrame(this._detectOverflowAnimationFrameId);this._detectOverflowAnimationFrameId=window.requestAnimationFrame(this._detectOverflowSync);Mail.writeProfilerMark("HeaderControl._detectOverflow",Mail.LogEvent.stop)};Mail.HeaderControl.prototype._detectOverflowSync=function(){var n,i,r,t,f,u,o;if(Mail.log("ReadingPane_computeHeaderOverflows",Mail.LogEvent.start),this._detectOverflowAnimationFrameId=null,n=this._isOverflowDetected,this._preventHeaderCollapse)n=false;else if(this._headersExpanded)n=true;else if(!n){for(i=Mail.HeaderControl.expandableHeaderElements,r=0,t=0,f=i.length;t<f;++t){var e=i[t],s=e.root,h=e.content,c=this._host.querySelector(h),l=c.childNodes.length;l>1&&(u=this._host.querySelector(s),u.scrollWidth>u.offsetWidth&&(n=true,r=t+1))}n&&(o=this._host.querySelector(".mailReadingPaneExpandHeadersButton"),o.style.msGridRowSpan=String(r))}this._setOverflowDetected(n);Mail.log("ReadingPane_computeHeaderOverflows",Mail.LogEvent.stop)};Mail.HeaderControl.prototype._setOverflowDetected=function(n){this._getElementAndSetVisibility(".mailReadingPaneExpandHeadersButton",n);n!==this._isOverflowDetected&&(this._isOverflowDetected=n,n&&this._removeHiddenICTabStops())};Mail.HeaderControl.prototype._toggleExpandHeaders=function(){this._expandHeaders(!this._headersExpanded)};Mail.HeaderControl.prototype._expandHeaders=function(n){var e,i,r,u,t,o,f;for(Mail.writeProfilerMark("HeaderControl._expandHeaders",Mail.LogEvent.start),this._headersExpanded=n,this._host.querySelector(".mailReadingPaneExpandHeadersButtonLabel").innerHTML="&nbsp;"+(n?"&#xE098;":"&#xE099;"),e=n?Jx.res.getString("mailReadingPaneHideRecipientsAriaLabel"):Jx.res.getString("mailReadingPaneShowAllRecipientsAriaLabel"),i=this._host.querySelector(".mailReadingPaneExpandHeadersButton"),Mail.setAttribute(i,"aria-label",e),Mail.setAttribute(i,"aria-expanded",n.toString()),r="mailReadingPaneExpandedHeader",u=Mail.HeaderControl.expandableHeaderElements,t=0,o=u.length;t<o;++t)f=this._host.querySelector(u[t].root),n?f.classList.add(r):f.classList.remove(r);this._removeHiddenICTabStops();Mail.writeProfilerMark("HeaderControl._expandHeaders",Mail.LogEvent.stop)};Mail.HeaderControl.prototype._showElement=function(n){return this._getElementAndSetVisibility(n,true)};Mail.HeaderControl.prototype._hideElement=function(n){return this._getElementAndSetVisibility(n,false)};Mail.HeaderControl.prototype._getElementAndSetVisibility=function(n,t){var i=this._host.querySelector(n);return Jx.setClass(i,"hidden",!t),i}})