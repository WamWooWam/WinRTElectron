Jx.delayDefine(Mail,"AccountSwitcher",function(){"use strict";var n=Microsoft.WindowsLive.Platform,t=n.CollectionChangeType;Mail.AccountSwitcher=function(t,i,r,u,f){var s,h;Mail.log("AccountList_Ctor",Mail.LogEvent.start);this.initComponent();this._selection=r;this._host=i;this._element=null;this._hooks=null;this._listElement=null;this._switcherButton=null;this._flyout=null;this._createFlyout=f;var c=new Mail.QueryCollection(t.accountManager.getConnectedAccountsByScenario,t.accountManager,[n.ApplicationScenario.mail,n.ConnectedFilter.normal,n.AccountSort.name]),e=this._items=new Mail.MappedCollection(c,function(n){return new Mail.AccountItem(n,u)}),o=this._list=new Jx.List;o.setSource(e);s=this._ariaFlows=new Mail.AriaFlows(o);h=this._aggregator=new Mail.AccountSwitcherAggregator(e);this.append(s,h);this._disposer=new Mail.Disposer(e,new Mail.EventHook(e,"collectionchanged",this._onCollectionChanged,this));this._singleAccountHook=null;this._hookSingleAccountListener();Mail.log("AccountList_Ctor",Mail.LogEvent.stop)};Jx.augment(Mail.AccountSwitcher,Jx.Component);Mail.AccountSwitcher.prototype.shutdownComponent=function(){Jx.dispose(this._disposer);Jx.dispose(this._singleAccountHook);Jx.Component.prototype.shutdownComponent.call(this)};Mail.AccountSwitcher.prototype.getUI=function(n){var t=Jx.escapeHtml(Jx.res.getString("mailAccountSwitcherTooltip")),i=this._singleAccountHasError(),r=this._singleAccountHasOof(),u=i?Jx.escapeHtml(this._getSingleAccountErrorText()):r?Jx.escapeHtml(Jx.res.getString("mailOofAccountListMessage")):"";n.html="<div id='accountSwitcher' class='"+(this._items.count<=1?"singleAccount":"")+(i?" singleAccountHasError":"")+(r?" singleAccountHasOof":"")+"'><div class='listElement'><div class='inhibitTouchHover'><\/div>"+Jx.getUI(this._ariaFlows).html+"<\/div><div id='narrowAccountSwitcher'><div id='accountSwitcherButton' tabIndex='0' role='button' title='"+t+"' aria-label='"+t+"'><div class='icon-accountSwitcher'><\/div>"+Jx.getUI(this._aggregator).html+"<\/div><\/div><div id='narrowSingleAccountIndicator' role='status' title='"+u+"' aria-label='"+u+"'><div class='singleAccountIcon icon-acSingleError'><\/div><div class='singleAccountIcon icon-acSingleOof'><\/div><\/div><\/div>"};Mail.AccountSwitcher.prototype._singleAccountHasError=function(){var n=this._items;return n.count===1?n.item(0).hasError:false};Mail.AccountSwitcher.prototype._getSingleAccountErrorText=function(){var n=this._items;return n.count===1?n.item(0).errorText:""};Mail.AccountSwitcher.prototype._singleAccountHasOof=function(){var n=this._items;return n.count===1?n.item(0).hasOof:false};Mail.AccountSwitcher.prototype._onSingleAccountChanged=function(n){var t=this._element,i,r,u,f;t&&Mail.Validators.havePropertiesChanged(n,["hasError","hasOof"])&&(i=this._singleAccountHasError(),r=this._singleAccountHasOof(),Jx.setClass(t,"singleAccountHasError",i),Jx.setClass(t,"singleAccountHasOof",r),u=i?this._getSingleAccountErrorText():r?Jx.escapeHtml(Jx.res.getString("mailOofAccountListMessage")):"",f=t.querySelector("#narrowSingleAccountIndicator"),f.setAttribute("title",u),f.setAttribute("aria-label",u))};Mail.AccountSwitcher.prototype.detachList=function(){return this.removeChild(this._ariaFlows),this._element.removeChild(this._listElement),{control:this._ariaFlows,element:this._listElement}};Mail.AccountSwitcher.prototype.attachList=function(n){this.appendChild(this._ariaFlows);this._element.appendChild(n.element)};Mail.AccountSwitcher.prototype.activateUI=function(){Jx.Component.prototype.activateUI.call(this);var n=this._element=document.querySelector("#accountSwitcher"),t=this._listElement=n.querySelector(".listElement"),i=this._switcherButton=n.querySelector("#accountSwitcherButton");this._hooks=new Mail.Disposer(new Jx.Clicker(t,this._onListClick,this),new Jx.PressEffect(n,".accountItem, #accountSwitcherButton",["className"],".inhibitTouchHover"),new Jx.KeyboardNavigation(t,"vertical",this),new Jx.Clicker(i,this._onSwitcherButtonClick,this),Mail.EventHook.createGlobalHook("People.Accounts.AccountDialogEvents.newAccountAdded",this._onAccountSetup,this));this._items.unlock()};Mail.AccountSwitcher.prototype.deactivateUI=function(){Jx.Component.prototype.deactivateUI.call(this);Jx.dispose(this._hooks)};Mail.AccountSwitcher.prototype.setFocus=function(){Jx.safeSetActive(this._element)};Mail.AccountSwitcher.prototype.selectDefaultAccount=function(){this._items.count>0&&this._selectItem(this._items.item(0),true)};Mail.AccountSwitcher.prototype._selectAccount=function(n,t){this._host.selectAccount(n,t);var i=this._flyout;i&&i.hide()};Mail.AccountSwitcher.prototype._hookSingleAccountListener=function(){var n=this._items;Jx.dispose(this._singleAccountHook);this._singleAccountHook=n.count===1?new Mail.EventHook(n.item(0),"changed",this._onSingleAccountChanged,this):null};Mail.AccountSwitcher.prototype._onCollectionChanged=function(n){if(Jx.setClass(this._element,"singleAccount",this._items.count<=1),this._onSingleAccountChanged(["hasError","hasOof"]),this._hookSingleAccountListener(),n.eType===t.itemRemoved)this._selection.account.objectId===n.objectId&&this.selectDefaultAccount();else if(n.eType===t.itemAdded){var i=this._items.item(n.index);Mail.AccountSettings.isSetupCompleted(i.platformAccount)&&this._selectItem(i)}else n.eType===t.reset&&this.selectDefaultAccount()};Mail.AccountSwitcher.prototype._onAccountSetup=function(n){var t=n.data.account;Mail.Validators.areEqual(this._selection.account,t)||this._selectAccount(t)};Mail.AccountSwitcher.prototype._onListClick=function(n){Mail.log("AccountList_onItemInvoked",Mail.LogEvent.start);var t=this._list.getTarget(n);t&&(t.onClick(),this._items.count>1&&this._selectItem(t));Mail.log("AccountList_onItemInvoked",Mail.LogEvent.stop)};Mail.AccountSwitcher.prototype._onSwitcherButtonClick=function(n){Mail.log("AccountList_onSwitcherButtonClick",Mail.LogEvent.start);var t=this._flyout;t||(t=this._flyout=new Mail.AccountSwitcherFlyout(this,this._createFlyout),this._disposer.add(t));t.show(this._switcherButton,n.type==="keydown");Mail.log("AccountList_onSwitcherButtonClick",Mail.LogEvent.stop)};Mail.AccountSwitcher.prototype._selectItem=function(n,t){this._selectAccount(n.platformAccount,t)};Mail.AccountSwitcher.prototype.flyoutBeforeShow=function(){this._switcherButton.classList.add("pressed")};Mail.AccountSwitcher.prototype.flyoutDismissed=function(){this._switcherButton.classList.remove("pressed")}})