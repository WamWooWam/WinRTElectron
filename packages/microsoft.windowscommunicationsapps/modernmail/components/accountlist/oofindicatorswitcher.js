Jx.delayDefine(Mail,"OofIndicatorSwitcher",function(){"use strict";function r(n,t){n&&Jx.log.info(t+": "+n.toString())}var t=Microsoft.WindowsLive.Platform,n,i;Mail.OofIndicatorSwitcher=function(n,t,i){this._showIndicatorCallback=n;this._hideIndicatorCallback=t;this._respectIgnoredTime=i;this._timer=0;this._account=null;this._oofSupported=false;this._onAccountChanged=this._onAccountChanged.bind(this)};n=Mail.OofIndicatorSwitcher.prototype;n.dispose=function(){this._clearTimer();this._showIndicatorCallback=null;this._hideIndicatorCallback=null;this._clearAccount()};n._clearTimer=function(){this._timer&&(window.clearTimeout(this._timer),this._timer=0)};n._clearAccount=function(){var n=this._account,i;n&&(i=n.getResourceByType(t.ResourceType.mail),i.removeEventListener("changed",this._onAccountChanged));this._oofSupported&&(this._hideOofIndicator(),this._oofSupported=false);this._account=null};n.setAccount=function(n){var r,i;Jx.log.info("Mail.OofIndicatorSwitcher.setAccount: id="+n.objectId);this._clearAccount();this._clearTimer();this._account=n;r=n.getResourceByType(t.ResourceType.mail);r.addEventListener("changed",this._onAccountChanged);i=n.getServerByType(t.ServerType.eas);this._oofSupported=i&&i.isOofSupported();this._oofSupported&&this._updateOofIndicator()};i=Mail.OofIndicatorSwitcher;i._calculateTime=function(n,t,i){var r=n&&i<n?n-i:-1,u=t&&i<t?t-i:-1,f=r>0?r:u;return{isNowBetween:(!n||i>=n)&&(!t||i<t),timeToNextCheckPoint:!n||!t||n<t?f:-1}};i.calculateTime=function(n,t){var r=new Date;return i._calculateTime(n,t,r)};n._updateOofIndicator=function(){var n,f;Jx.log.info("Mail.OofIndicatorSwitcher._updateOofIndicator: account id= "+this._account.objectId);var o=false,s=false,h=this._account,u=h.getResourceByType(t.ResourceType.mail);if(this._clearTimer(),u.oofLastSyncResult===t.Result.success){if(n=h.getServerByType(t.ServerType.eas),n.oofState){var c=n.oofStartTime,l=n.oofEndTime,a=u.oofLastStateChangedTime,e=n.oofLastIgnoredTime;r(c,"oofStartTime");r(l,"oofEndTime");r(a,"oofLastStateChangedTime");r(e,"oofLastIgnoredTime");f=i.calculateTime(c,l);f.isNowBetween&&(!this._respectIgnoredTime||!e||u.oofLastStateChangedTime>=e)&&(this._showOofIndicator(),o=true);f.timeToNextCheckPoint>0&&(this._timer=window.setTimeout(this._updateOofIndicator.bind(this),Math.min(864e5,f.timeToNextCheckPoint+5e3)))}}else s=true,Jx.log.info("Mail.OofIndicatorSwitcher._updateOofIndicator: sync error "+u.oofResult);o||s||this._hideOofIndicator()};n._showOofIndicator=function(){var n=this._showIndicatorCallback;n&&(Jx.log.info("Mail.OofIndicatorSwitcher._showOofIndicator: account id= "+this._account.objectId),n())};n._hideOofIndicator=function(){var n=this._hideIndicatorCallback;n&&(Jx.log.info("Mail.OofIndicatorSwitcher._hideOofIndicator: account id= "+this._account.objectId),n())};n._onAccountChanged=function(n){if(Mail.Validators.hasPropertyChanged(n,"oofLastStateChangedTime"))this._oofSupported&&this._updateOofIndicator();else if(Mail.Validators.hasPropertyChanged(n,"lastSyncResult")){var i=this._account.getServerByType(t.ServerType.eas);this._oofSupported=i&&i.isOofSupported();this._oofSupported&&this._updateOofIndicator()}}})