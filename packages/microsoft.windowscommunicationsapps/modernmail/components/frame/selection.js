Jx.delayDefine(Mail,"Selection",function(){"use strict";function r(n,t){return n+":"+(t?t.objectId||"":"")}function e(n,t,i,u){return n+" = { "+r("account",t)+" "+r("view",i)+" "+r("message",u)+" } "}function s(n){Jx.mark("Mail.Selection."+n+",StartTA,Mail,Selection")}function h(n){Jx.mark("Mail.Selection."+n+",StopTA,Mail,Selection")}var f=Mail.Selection=function(n,t){this._platform=n;this._appState=t;this._account=t.getStartupAccount();this._view=t.getStartupView();this._message=t.lastSelectedMessage;this._messages=t.selectedMessages||[];this._query=null;this._filter=o.all;this._pendingNav=0;this._logChange("initial",null,null,null)},n=f.prototype={get account(){return this._account},get view(){return this._view},get message(){return this._message},get messages(){return this._messages},get messageIndex(){return this._appState.lastSelectedMessageIndex}};Jx.augment(f,Jx.Events);n.dispose=function(){this._cancelPendingNav()};n.selectMessage=function(n,t){var i=n.loadMessage(t);i&&(this.updateNav(n.account,n,i),this.updateMessages(i,-1,[i],false))};n.clearMessageSelection=function(){s("clearMessageSelection");this.updateMessages(null,-1,[]);h("clearMessageSelection")};n.updateMessages=function(n,t,i,r){this._logChange("messages",null,null,n);var u=!Mail.Validators.areEqual(n,this._message),f={target:this,messageChanged:u||n&&this._message&&n.isDraft!==this._message.isDraft,keyboard:r||false};this._message=n;this._messages=i;this._appState.setSelectedMessages(n,t,i);this.raiseEvent("messagesChanged",f)};n.updateNav=function(n,t,i){this._cancelPendingNav();this._logChange("navigation",n,t,i);t=t||n.inboxView;var r={target:this,accountChanged:!Mail.Validators.areEqual(n,this._account),viewChanged:!Mail.Validators.areEqual(t,this._view),desiredMessage:i};this._account=n;this._view=t;this._appState.setSelectedView(t);this.raiseEvent("navChanged",r)};n.updateNavAsync=function(n,t,i){this._cancelPendingNav();this._logChange("async navigation queued",n,t,i);this._pendingNav=window.requestAnimationFrame(this._completePendingNav.bind(this,n,t,i))};n._completePendingNav=function(n,t,i){Jx.mark("Selection async navigation completed");this._pendingNav=0;this.updateNav(n,t,i)};n._cancelPendingNav=function(){this._pendingNav&&(Jx.mark("Selection async navigation cancelled"),window.cancelAnimationFrame(this._pendingNav),this._pendingNav=0)};n._logChange=function(n,t,i,r){Jx.mark("Selection "+n+" "+e("old",this._account,this._view,this._message)+e("new",t,i,r))};var u=Microsoft.WindowsLive.Platform,i=u.MailViewType,o=u.FilterCriteria,t=u.MailMessageChangeOperation;n.registerQuery=function(n,t){this._query=n;this._filter=t};n.clearQuery=function(){this._query=null;this._filter=o.all};n.moveItemsTo=function(n,t){this._batchMove(this._view.objectId,n.objectId,t)};n.moveItemsFrom=function(n,t,i){this._batchMove(n.objectId,t.objectId,i)};n.deleteItems=function(n){this.raiseEvent("deleteItemsStart");switch(this._view.type){case i.deletedItems:case i.junkMail:case i.draft:case i.outbox:this._batchDelete(n);break;default:this.moveItemsTo(this.account.deletedView,n)}};n.junkItems=function(n){var t=this.account;this.moveItemsTo(t.junkView||t.deletedView,n)};n.emptyView=function(){this.deleteItems(this._query)};n.setFlagState=function(n,i){this._batchChange(n?t.flag:t.unflag,i)};n.setReadState=function(n,i){this._batchChange(n?t.markAsRead:t.markAsUnread,i)};n.markViewRead=function(){this._batchChange(t.markAsRead,this._query)};n._batchChange=function(n,t){var u=this._getBatch(t),i,r;if(u.length>0){i=this._query;r=null;i&&Mail.ViewCapabilities.isFiltered(this._view,this._filter)&&(r=i.keepInView());try{this._platform.mailManager.batchChange(r,this._view.objectId,n,u)}catch(f){Jx.log.exception("batchChange("+n+")",f)}}};n._batchMove=function(n,t,i){var r=this._getBatch(i);if(r.length>0)try{this._platform.mailManager.batchMove(n,t,r)}catch(u){Jx.log.exception("batchMove("+n+", "+t+")",u)}};n._batchDelete=function(n){var t=this._getBatch(n);if(t.length>0)try{this._platform.mailManager.batchDelete(t)}catch(i){Jx.log.exception("batchDelete("+this._view.objectId+")",i)}};n._getBatch=function(n){return n=n||this._messages,n.map(function(n){return n.objectId})}})