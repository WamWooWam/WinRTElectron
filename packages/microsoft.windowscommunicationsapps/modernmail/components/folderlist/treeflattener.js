Jx.delayDefine(Mail,"TreeFlattener",function(){function t(n,i){return n.reduce(function(n,i){return n.push(i),t(i.children,n)},i||[])}var i=Microsoft.WindowsLive.Platform,n=i.CollectionChangeType;Mail.TreeFlattener=function(n){Mail.writeProfilerMark("TreeFlattener_ctor",Mail.LogEvent.start);Mail.Collection.call(this,"<flat>");this._root=n;this._hook(n);this._items=t(n.children);this._items.forEach(this._hook,this);Mail.writeProfilerMark("TreeFlattener_ctor",Mail.LogEvent.stop)};Mail.TreeFlattener.create=function(n){return new Mail.TreeFlattener(new Mail.ViewHierarchy(n))};Jx.inherit(Mail.TreeFlattener,Mail.Collection);Mail.TreeFlattener.prototype.dispose=function(){this._root!==null&&(this._items.forEach(this._unhook,this),this._unhook(this._root),Jx.dispose(this._root),this._root=null)};Object.defineProperty(Mail.TreeFlattener.prototype,"count",{get:function(){return this._items.length},enumerable:true});Mail.TreeFlattener.prototype.item=function(n){return this._items[n]};Mail.TreeFlattener.prototype.unlock=function(){this._root.unlock();Mail.Collection.prototype.unlock.call(this)};Mail.TreeFlattener.prototype._onNodeChanged=function(t){switch(t.eType){case n.itemAdded:this._itemAdded(t);break;case n.itemRemoved:this._itemRemoved(t);break;case n.itemChanged:this._itemChanged(t);break;case n.reset:this._reset()}};Mail.TreeFlattener.prototype._itemAdded=function(n){var i=n.target,r=this._mapIndex(i,this._items.indexOf(i),n.index),u=i.children.item(n.index),f;f=t(u.children,[u]);f.forEach(function(n,t){this._items.splice(r+t,0,n);this._raiseAdded(n,r+t);this._hook(n)},this)};Mail.TreeFlattener.prototype._itemRemoved=function(n){for(var u=n.target,t=this._mapIndex(u,this._items.indexOf(u),n.index),e=this._items[t],r,i=0,f=e.totalCount;i<f;i++)r=this._items.splice(t,1)[0],this._raiseRemoved(r,t),this._unhook(r)};Mail.TreeFlattener.prototype._itemChanged=function(n){var t=n.target,u=this._items.indexOf(t),f=t.children.item(n.index),i,r,e,s,o;for(n.previousIndex<n.index?(i=this._mapIndex(t,u,n.previousIndex),r=this._mapIndex(t,u,n.index)+f.descendantCount):(i=this._mapIndex(t,u,n.previousIndex+1)-f.totalCount,r=this._mapIndex(t,u,n.index)),e=0,s=f.totalCount;e<s;e++)o=this._items.splice(i,1)[0],this._items.splice(r,0,o),this._raiseMoved(o,i,r),r<i&&(i++,r++)};Mail.TreeFlattener.prototype._reset=function(){var i=this._items;this._items=[];i.forEach(this._unhook,this);this._items=t(this._root.children);this._items.forEach(this._hook,this);this._raiseChange({eType:n.reset,removed:i})};Mail.TreeFlattener.prototype._mapIndex=function(n,t,i){for(var u=n.children,r=t+1;--i>=0;)r+=u.item(i).totalCount;return r};Mail.TreeFlattener.prototype._hook=function(n){n.addListener("childrenChanged",this._onNodeChanged,this)};Mail.TreeFlattener.prototype._unhook=function(n){n.removeListener("childrenChanged",this._onNodeChanged,this)}})