Jx.delayDefine(Mail,"ViewNode",function(){"use strict";var t=Mail.ViewNode=function(n,t,i){this.depth=t;this._view=n;this._tree=i;this._sorted=null;this._children=null;this._listeners=new Mail.Disposer;this.initEvents()},n;Jx.augment(t,Jx.Events);n=t.prototype;n.dispose=function(){this._listeners.dispose()};n.unlock=function(){this._children.forEach(function(n){n.unlock()});this._children.unlock()};n.setChildren=function(t){n.dispose.call(this);this._sorted=new Mail.SortedCollection(this,t);this._children=new Mail.MappedCollection(this._sorted,function(n){var t=new Mail.ViewNode(n,this.depth+1,this._tree);return t.setChildren(this._tree.getChildren(n)),t},this);this._listeners.addMany(this._sorted,this._children);this._listeners.add(new Mail.EventHook(this._children,"collectionchanged",this._onChildrenChanged,this))};Object.defineProperty(n,"objectId",{get:function(){return this._view?this._view.objectId:"-1"},enumerable:true});Object.defineProperty(n,"view",{get:function(){return this._view},enumerable:true});Object.defineProperty(n,"children",{get:function(){return this._children},enumerable:true});Object.defineProperty(n,"totalCount",{get:function(){return this._children.reduce(function(n,t){return t.totalCount+n},1)},enumerable:true});Object.defineProperty(n,"descendantCount",{get:function(){return this.totalCount-1},enumerable:true});n.viewChanged=function(n){Mail.Validators.hasPropertyChanged(n,"name")&&this._sorted.update(n.target)};n.hook=function(n){n.addListener("changed",this.viewChanged,this)};n.unhook=function(n){n.removeListener("changed",this.viewChanged,this)};n.setCallback=Jx.fnEmpty;n.compare=function(n,t){return n.name.localeCompare(t.name)||n.objectId.localeCompare(t.objectId)};n._onChildrenChanged=function(n){this.raiseEvent("childrenChanged",{target:this,eType:n.eType,objectId:n.objectId,index:n.index,previousIndex:n.previousIndex})}});Jx.delayDefine(Mail,"ViewHierarchy",function(){function o(n){return t[n]||i}var f=Microsoft.WindowsLive.Platform,u=f.CollectionChangeType,r=f.MailViewType,e=Mail.ViewHierarchy=function(n){Mail.writeProfilerMark("ViewHierarchy.ctor",Mail.LogEvent.start);Mail.ViewNode.call(this,null,-1,this);this._hooks=[];this._views=n;this._disposer=new Mail.Disposer(n,this._hooks,new Mail.EventHook(n,"collectionchanged",this._onCollectionChanged,this));this._reset();Mail.writeProfilerMark("ViewHierarchy.ctor",Mail.LogEvent.stop)},n,t,i;e.wrapFlat=function(n){return new Mail.MappedCollection(Mail.ViewFilters.sortFolders(n),function(n){return new Mail.ViewNode(n,0,null)})};Jx.inherit(e,Mail.ViewNode);n=e.prototype;n.dispose=function(){Mail.writeProfilerMark("ViewHierarchy.dispose",Mail.LogEvent.start);Mail.ViewNode.prototype.dispose.call(this);Jx.dispose(this._disposer);Mail.writeProfilerMark("ViewHierarchy.dispose",Mail.LogEvent.stop)};n.unlock=function(){this._views.unlock()};n.getChildren=function(n){return this._getCollection(n.objectId)};n._onCollectionChanged=function(n){var t,i;switch(n.eType){case u.itemAdded:t=this._views.item(n.index);this._updateSourceMapping(t);this._addView(t,n.index);break;case u.itemRemoved:this._removeView(n.objectId,n.index);break;case u.itemMoved:i=this._hooks;i.splice(n.index,0,i.splice(n.previousIndex,1)[0]);break;case u.reset:this._reset();this.raiseEvent("childrenChanged",{target:this,eType:u.reset})}};n._reset=function(){var n,t,i;this._initialized=false;this._hooks=this._disposer.replace(this._hooks,[]);n=this._childCollections={};this._sourceMapping={};this._views.forEach(this._updateSourceMapping,this);t=this._getCollection("roots");this._views.forEach(this._addView,this);this.setChildren(t);for(i in n)n[i].unlock();this._initialized=true};n._addView=function(n,t){this._hooks.splice(t,0,new Mail.EventHook(n,"changed",this._onViewChanged,this));this._addChild(n)};n._removeView=function(n,t){this._removeChild(n);Jx.dispose(this._hooks.splice(t,1)[0]);delete this._childCollections[n]};n._addChild=function(n){var t=this._getCollection(this._parentId(n));t.insertItem(n,0)};n._removeChild=function(n){var r=this._childCollections,u,t,i;for(u in r)if(t=r[u],i=t.findIndexById(n),i!==-1){t.removeItem(i);return}};n._onViewChanged=function(n){if(Mail.Validators.hasPropertyChanged(n,"parentFolder","sourceObject")){var t=n.target;this._updateSourceMapping(t);this._removeChild(t.objectId);this._addChild(t)}};n._getCollection=function(n){var t=this._childCollections[n];return t||(t=this._childCollections[n]=new Mail.ArrayCollection([],n+"-children"),this._initialized&&t.unlock()),t};n._updateSourceMapping=function(n){var t=n.sourceObject;t&&(this._sourceMapping[t.objectId]=n.objectId)};n._parentId=function(n){if(n.type===r.userGeneratedFolder){var t=n.sourceObject.parentFolder;if(t&&t.folderType===f.FolderType.mail)return this._sourceMapping[t.objectId]}return"roots"};t={};i=1;t[r.inbox]=i++;t[r.draft]=i++;t[r.sentItems]=i++;t[r.outbox]=i++;t[r.junkMail]=i++;t[r.deletedItems]=i++;t[r.userGeneratedFolder]=i++;n.compare=function(n,t){return o(n.type)-o(t.type)||Mail.ViewNode.prototype.compare.call(this,n,t)};n.viewChanged=function(n){Mail.Validators.hasPropertyChanged(n,"type")&&this._sorted.update(n.target);Mail.ViewNode.prototype.viewChanged.call(this,n)}})