Jx.delayDefine(Mail,["GlomManager","ChildMailGlomManager"],function(){"use strict";var i={showMessageList:"showMessageList",releasingMessage:"releasingMessage",parentWindowVisibilityChanged:"parentWindowVisibilityChanged"},t,n,r;t=Mail.GlomManager=function(n,t,r){Mail.writeProfilerMark("Child mail glom manager constructor");Jx.initGlomManager();this._selection=n;this._platform=r;this._message=null;var u=Jx.glomManager,f=Jx.GlomManager.Events;this._disposer=new Mail.Disposer(u,new Mail.EventHook(n,"messagesChanged",this._handleMessageSelected,this),new Mail.EventHook(n,"deleteItemsStart",this._handleDeleteStart,this),new Mail.EventHook(u,f.startingContext,this._handleStartingContext,this),new Mail.EventHook(u,f.resetGlom,this._handleReset,this),new Mail.EventHook(u,f.glomConsolidated,this._glomConsolidated,this),new Mail.EventHook(u.getParentGlom(),i.parentWindowVisibilityChanged,this._handleParentVisChange,this),new Mail.GlomManagerUtil(this,n));this._handleMessageDeleted=this._handleMessageDeleted.bind(this);this._handleMessageChanged=this._handleMessageChanged.bind(this);Mail.Utilities.ComposeHelper.setGlomManager(this);this._consolidateStarted=false;this._currentDisplayIds=null;this._parentVisible=false};Mail.ChildMailGlomManager=Mail.GlomManager;n=t.prototype;n.dispose=function(){Mail.log("Child mail glom manager disposed");Jx.dispose(this._disposer);this._selection=null;this._platform=null;Mail.Utilities.ComposeHelper.setGlomManager(null)};r=2e3;n._loadMessageInstance=function(n,t){var i=this._platform,f=function(){var f,e;try{var o=Mail.UIDataModel,u=i.mailManager.loadMessage(n),r=u?Mail.Account.load(u.accountId,i):null,t=r?new o.MailMessage(u,r):null;t&&(f=t?t.primaryViewId:null,e=f?r.loadView(f):null,this._selection.updateNav(r,e,t),this._selection.updateMessages(t,-1,[t],false))}catch(s){Jx.log.exception("Failed to select message with error: ",s)}}.bind(this),u;return Mail.writeProfilerMark("Child mail glom manager _loadMessageInstance",Mail.LogEvent.start),u=i.mailManager.waitForInstanceNumberOnMessage(n,t),u?WinJS.Promise.timeout(r,u).then(function(){Mail.writeProfilerMark("Child mail glom manager _loadMessageInstance",Mail.LogEvent.stop);f()},function(){Mail.writeProfilerMark("Child mail glom manager _loadMessageInstance timed out",Mail.LogEvent.info);Mail.writeProfilerMark("Child mail glom manager _loadMessageInstance",Mail.LogEvent.stop);f()}):(Mail.writeProfilerMark("Child mail glom manager: Missing promise from platform",Mail.LogEvent.info),WinJS.Promise.wrap())};n._handleParentVisChange=function(n){this._updateParentVisible(n.message.visible)};n._updateParentVisible=function(n){this._parentVisible=n;Jx.setClass(document.getElementById("mailFrameReadingPaneSection"),"parentVisible",n)};n.getParentVisible=function(){return this._parentVisible};n._handleStartingContext=function(n){Mail.writeProfilerMark("Child mail glom manager handleStartingContext",Mail.LogEvent.start);var t=n.message;this._updateParentVisible(t.isParentVisible);this._loadMessageInstance(t.messageId,t.instanceNumber).done(function(){Mail.writeProfilerMark("Child mail glom manager handleStartingContext instance loaded",Mail.LogEvent.start);this._message?(Jx.safeSetActive(document.getElementById("idCompApp")),Mail.writeProfilerMark("StartDelayBuildCompose",Mail.LogEvent.start),Mail.Utilities.ComposeHelper.ensureComposeObject(),Mail.writeProfilerMark("StartDelayBuildCompose",Mail.LogEvent.stop),Mail.writeProfilerMark("StartDelayInsertComposeHTML",Mail.LogEvent.start),Mail.Utilities.ComposeHelper.ensureComposeHTML(),Mail.writeProfilerMark("StartDelayInsertComposeHTML",Mail.LogEvent.stop),Jx.ptStop("Mail-ChildStart")):(Mail.writeProfilerMark("Message failed to load and/or select.  Closing child window"),this._cleanlyCloseWindow());Mail.writeProfilerMark("Child mail glom manager handleStartingContext instance loaded",Mail.LogEvent.stop)}.bind(this));Mail.writeProfilerMark("Child mail glom manager handleStartingContext",Mail.LogEvent.stop)};n._updateGlomTitle=function(n){var i,t;Mail.writeProfilerMark("Child mail glom manager update glom title");n?(i="",n.isDraft&&(i=Jx.res.getString("mailMessageListDraftPrefix")+" "),t=n.subject,t.length===0&&(t=Jx.res.getString("mailUIMailMessageNoSubject")),Jx.glomManager.changeGlomTitle(i+t)):Jx.glomManager.changeGlomTitle(Jx.res.getString("mailWindowTitleNoSubject"))};n._handleMessageSelected=function(n){Mail.writeProfilerMark("GlomManager._handleMessageSelected",Mail.LogEvent.start);n.messageChanged&&(this._message&&(this._message.removeListener("deleted",this._handleMessageDeleted),this._message.removeListener("changed",this._handleMessageChanged)),this._message=this._selection.message,this._message&&(this._message.addListener("deleted",this._handleMessageDeleted),this._message.addListener("changed",this._handleMessageChanged),this._currentDisplayIds=this._message.displayViewIds),this._updateGlomTitle(this._message));Mail.writeProfilerMark("GlomManager._handleMessageSelected",Mail.LogEvent.stop)};n._ensureMessageList=function(){Mail.writeProfilerMark("Child mail glom manager post message to ensure message list");Jx.glomManager.getParentGlom().postMessage(i.showMessageList)};n._handleDeleteStart=function(){Mail.writeProfilerMark("Child mail hidding window at start of delete process");Jx.glomManager.createOrShowGlom(Jx.GlomManager.ParentGlomId,{},Jx.GlomManager.ShowType.showAndCloseThis)};n._cleanlyCloseWindow=function(){if(Mail.writeProfilerMark("Child mail glom manager cleanlyCloseWindow (consolidate)"),this._selection.message&&this._message){this._ensureMessageList();var n=this._message;Jx.glomManager.getParentGlom().postMessage(i.releasingMessage,{messageId:n.objectId,instanceNumber:n.instanceNumber});this._selection.clearMessageSelection()}Jx.glomManager.createOrShowGlom(Jx.GlomManager.ParentGlomId,{},Jx.GlomManager.ShowType.showAndCloseThis);this._consolidateStarted&&(this._consolidateStarted=false,Jx.glomManager.consolidateComplete())};n._glomConsolidated=function(){this._consolidateStarted=true;this.handleHomeButton()};n.handleComposeComplete=function(){Mail.writeProfilerMark("Child mail glom manager compose complete");this._cleanlyCloseWindow()};n.handleHomeButton=function(){Mail.writeProfilerMark("Child mail glom manager home button");this._message&&this._message.isDraft?Mail.Utilities.ComposeHelper.handleHomeButton():this._cleanlyCloseWindow()};n.composeComplete=n.handleComposeComplete;n.updateWindowTitleWithMessage=function(n){Mail.writeProfilerMark("Child mail glom manager message updated");this._updateGlomTitle(n)};n._handleMessageDeleted=function(){Mail.writeProfilerMark("Child mail glom manager message deleted");this._cleanlyCloseWindow()};n._handleMessageChanged=function(n){var i,t,r;if(Mail.Validators.hasPropertyChanged(n,"displayViewIds")){for(i=n.target.displayViewIds,t=0,r=this._currentDisplayIds.length;t<r;++t)if(!i.indexOf(this._currentDisplayIds.getAt(t)).returnValue){Mail.writeProfilerMark("Child mail glom manager - message's display view Id changed");this._cleanlyCloseWindow();break}this._currentDisplayIds=i}};n._handleReset=function(){this._selection.clearMessageSelection();document.activeElement&&document.activeElement.blur()};t.isParent=function(){return false};t.isChild=function(){return true};t.messageOpenInAnotherWindow=function(){return false}})