Jx.delayDefine(Mail,["GlomManager","ParentGlomManager"],function(){"use strict";var t={showMessageList:"showMessageList",childGlomVisible:"childGlomVisible",releasingMessage:"releasingMessage",parentWindowVisibilityChanged:"parentWindowVisibilityChanged"},i,n;i=Mail.GlomManager=function(n,t){Mail.writeProfilerMark("Parent mail glom manager constructor");Jx.initGlomManager();this._selection=n;Mail.Globals.appState.addRestartCheck("Child glom age check",this._canRestart,this);this._guiState=t;this._openGloms={};var i=Jx.glomManager;this._disposer=new Mail.Disposer(i,new Mail.EventHook(i,Jx.GlomManager.Events.glomCreated,this._handleNewChild,this),new Mail.EventHook(i,Jx.GlomManager.Events.glomClosed,this._handleChildClosed,this),new Mail.EventHook(document,"msvisibilitychange",this._handleVisibilityChange,this));this._glomUtil=this._disposer.add(new Mail.GlomManagerUtil(this,n));i.enableGlomCache("/modernmail/ChildApp/ChildApp.html"+document.location.hash,3)};Mail.ParentGlomManager=Mail.GlomManager;n=i.prototype={};Jx.augment(Mail.GlomManager,Jx.Events);n.dispose=function(){Mail.writeProfilerMark("Parent mail glom manager dispose");this._disposer.dispose();Jx.glomManager=null};Mail.youngestWindow=function(n){var t=Mail.Utilities.msInOneDay*10,r,i;for(r in n)i=n[r],i.openTime>t&&(t=i.openTime);return(Date.now()-t)/Mail.Utilities.msInOneDay};n.getParentVisible=function(){return!document.hidden};n._handleVisibilityChange=function(){var r={visible:this.getParentVisible()},u=t.parentWindowVisibilityChanged,i,n;for(i in this._openGloms)n=this._openGloms[i].glom,n&&n.postMessage(u,r)};n._canRestart=function(){var n=Mail.youngestWindow(this._openGloms);return n>1};n._handleNewChild=function(n){Mail.writeProfilerMark("Parent mail glom manager handleNewChild");var i=n.glom,u=i.getGlomId(),r=this._openGloms[u];u!=="Worker"&&(r||(r=this._openGloms[u]={keepAlive:null,openTime:null,glom:null}),r.openTime=Date.now(),r.glom=i,i.addListener(t.showMessageList,this._handleShowMessageList,this),i.addListener(t.childGlomVisible,this._handleChildGlomVisible,this),i.addListener(t.releasingMessage,this._handleReleasingMessage,this),i.postMessage(t.parentWindowVisibilityChanged,{visible:!document.hidden}))};n._handleShowMessageList=function(){Mail.writeProfilerMark("Parent mail glom manager handleShowMessageList");this._guiState.ensureNavMessageList()};n._handleChildGlomVisible=function(){Mail.writeProfilerMark("Parent mail glom manager handleChildGlomVisible");this._guiState.handleGlomVisible()};n._handleReleasingMessage=function(n){Mail.writeProfilerMark("Parent mail glom manager handleGlomClosing");this.raiseEvent(t.releasingMessage,{context:n.message})};n.handleCommandBarNewChild=function(){var t=this._selection.message,n,i;t&&(n=Mail.Instrumentation,i=t.isDraft?n.Commands.newComposeWindow:n.Commands.newReadingPaneWindow,n.instrumentMailCommand(i),this._glomUtil.openChildMailWindow(t,false))};n._handleChildClosed=function(n){Mail.writeProfilerMark("Parent mail glom manager handleChildClosed");var i=n.glom.getGlomId(),t=this._openGloms[i];t&&(t.keepAlive&&t.keepAlive.dispose(),delete this._openGloms[i])};n.addKeepAlive=function(n){this._openGloms[n.objectId]||(this._openGloms[n.objectId]={keepAlive:n})};i.isParent=function(){return true};i.isChild=function(){return false};i.messageOpenInAnotherWindow=function(n){return n&&Jx.glomManager.isGlomOpen(n.objectId)}})