Jx.delayDefine(Mail,"DisplayedItemManager",function(){"use strict";function e(n,t,i){if(t<0||t>=n.count)return false;var r=n.item(t);return r.isDescendant(i)}function o(n){Jx.mark("DisplayedItemManager."+n)}function n(n){Jx.mark("DisplayedItemManager."+n+",StartTA,DisplayedItemManager")}function t(n){Jx.mark("DisplayedItemManager."+n+",StopTA,DisplayedItemManager")}var u=Mail.SelectionModel,f=u.ScrollOptions,i=Mail.SelectionHelper,r=i.EventTypes;Mail.DisplayedItemManager=function(n,t,i){this._collection=n;this._model=t;this._selection=i;this._view=i.view;this._displayedIndex=-1;this._displayedItem=null;this._displayedItemParentId=null;this._displayedItemHook=null;this._disposer=new Mail.Disposer(new Mail.EventHook(this._collection,"itemAdded",this._onItemAdded,this),new Mail.EventHook(this._collection,"itemRemoved",this._onItemRemoved,this),new Mail.EventHook(this._collection,"itemMoved",this._onItemMoved,this),new Mail.EventHook(this._collection,"reset",this._onReset,this),Mail.EventHook.createGlobalHook(Mail.Commands.Events.showNextMessage,this._selectNextMessage,this),Mail.EventHook.createGlobalHook(Mail.Commands.Events.showPreviousMessage,this._selectPreviousMessage,this))};Mail.DisplayedItemManager.prototype.dispose=function(){Jx.dispose(this._disposer)};Object.defineProperty(Mail.DisplayedItemManager.prototype,"displayedItem",{get:function(){return this._displayedItem},enumerable:true});Mail.DisplayedItemManager.prototype.setModel=function(n){this._model=n};Mail.DisplayedItemManager.prototype._findNewDisplayedIndex=function(){var t=-1,i=this._displayedItem?this._displayedItem.objectId:"",r=this._model.selection(),n;return i&&(o("_findNewDisplayedIndex - trying to keep "+i+" in view"),t=r.indexOfObject(i)),t===-1&&(n=r.indices,n.length>1&&(n=n.filter(function(n){var t=this._collection.item(n);return!t.expanded},this)),o("_findNewDisplayedIndex - no displayed item: setting first index from selection"+r[0]),t=n[0]),t};Mail.DisplayedItemManager.prototype.handleSelectionChange=function(i,r){var u;if(u=-1,n("_onSelectionChanged"),i.length===0)u=this.handleSelectedItemDeleted();else{u=this._findNewDisplayedIndex();var f=this._collection.item(u),e=i.logicalItems,o=Mail.DisplayedItem.create(this._view,f,null,this._model.getNodeSelection(f));this.setDisplayItems(u,o,e,r)}return t("_onSelectionChanged"),u};Mail.DisplayedItemManager.prototype._findNextSelectableIndex=function(n){var i,t,r;for(i=this._collection.mailItems.count,n=Mail.Validators.clamp(n,0,i-1),t=n;t<i;t++)if(r=this._collection.item(t),!r.pendingRemoval&&r.selectable)return t;return-1};Mail.DisplayedItemManager.prototype._findPrevSelectableIndex=function(n){var t,i;for(n=Mail.Validators.clamp(n,0,this._collection.mailItems.count-1),t=n;t>=0;t--)if(i=this._collection.item(t),!i.pendingRemoval&&i.selectable)return t;return-1};Mail.DisplayedItemManager.prototype.handleSelectedItemDeleted=function(){var r=this._displayedIndex,f=this._displayedItemParentId,u=-1;if(!i.hasSelectableItems(this._collection))return u;n("handleSelectedItemDeleted");var o=this._findPrevSelectableIndex(r-1),s=e(this._collection,o,f),h=s&&!e(this._collection,r,f);return u=h?o:this._findNextSelectableIndex(r),t("handleSelectedItemDeleted"),u};Mail.DisplayedItemManager.prototype.clear=function(){this.setDisplayItems(-1,null,[],false)};Mail.DisplayedItemManager.prototype.setDisplayItem=function(n,t){var i=this._collection.item(n),r=Mail.DisplayedItem.create(this._view,i,t,this._model.getNodeSelection(i));this.setDisplayItems(n,r,[i],false)};Mail.DisplayedItemManager.prototype.setDisplayItems=function(i,r,u,f){var o=r?r.objectId:"",e="setDisplayItems - index:="+i+" id:="+o+" keyboard:="+f;n(e);this._displayedIndex=i;this._displayedItem=this._disposer.replace(this._displayedItem,r);this._hookDisplayedItem();this._displayedItemParentId=this._displayedItem?this._displayedItem.parentId:"";this._updateAppSelection(f,i,u);t(e)};Mail.DisplayedItemManager.prototype._hookDisplayedItem=function(){this._disposer.disposeNow(this._displayedItemHook);this._displayedItemHook=null;this._displayedItem&&(this._displayedItemHook=this._disposer.add(new Mail.Disposer(new Mail.EventHook(this._displayedItem,"messageChanged",this._onDisplayedItemChanged,this),new Mail.EventHook(this._displayedItem,"requestExpansion",this._onRequestExpansion,this))))};Mail.DisplayedItemManager.prototype._updateAppSelection=function(i,r,u){n("_updateAppSelection - changing selection");var e=this._displayedItem?this._displayedItem.message:null,o=false,f=[];e&&(f=u.filter(function(n){return!n.pendingRemoval}).map(function(n){return n.data}),o=f.length>0);o?this._selection.updateMessages(e,r,f,i):this._selection.clearMessageSelection();t("_updateAppSelection - changing selection")};Mail.DisplayedItemManager.prototype._selectNextMessage=function(){this._model.setSelection(this._displayedIndex+1,f.ensureVisible,true)};Mail.DisplayedItemManager.prototype._selectPreviousMessage=function(){this._model.setSelection(this._displayedIndex-1,f.ensureVisible,true)};Mail.DisplayedItemManager.prototype._handleCollectionChange=function(n,t){if(this._collection.count===0){this.clear();return}this._displayedIndex=i.getUpdatedIndex(n,t,this._displayedIndex)};Mail.DisplayedItemManager.prototype._onReset=function(){this._displayedIndex=-1;this._disposer.disposeNow(this._displayedItemHook);this._disposer.disposeNow(this._displayedItem);this._displayedItemHook=null;this._displayedItem=null;this._displayedItemParentId=null};Mail.DisplayedItemManager.prototype._onItemAdded=function(n){this._handleCollectionChange(r.itemAdded,n)};Mail.DisplayedItemManager.prototype._onItemRemoved=function(n){this._handleCollectionChange(r.itemRemoved,n)};Mail.DisplayedItemManager.prototype._onItemMoved=function(n){this._handleCollectionChange(r.itemMoved,n)};Mail.DisplayedItemManager.prototype._onRequestExpansion=function(n){var t=this._collection.getTreeView();t.expand(this._displayedIndex,n.messageId)};Mail.DisplayedItemManager.prototype._onDisplayedItemChanged=function(){var n=this._displayedItem.message,t=this._selection.messages;this._selection.updateMessages(n,this._displayedIndex,t,false)}})