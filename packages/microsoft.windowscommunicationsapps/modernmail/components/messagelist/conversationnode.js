Jx.delayDefine(Mail,"ConversationNode",function(){"use strict";function r(n,t){Jx.mark("Mail.ConversationNode."+n+" - "+t)}function t(n,t){Jx.mark("Mail.ConversationNode."+n+" - "+t+",StartTA,Mail")}function i(n,t){Jx.mark("Mail.ConversationNode."+n+" - "+t+",StopTA,Mail")}var f=Microsoft.WindowsLive.Platform,u=f.CollectionChangeType,n;Mail.ConversationNode=function(n,t){this._locked=true;this._children=null;this._disposer=null;this._view=t;Jx.isInstanceOf(n,Mail.UIDataModel.MailConversation)||(r("Ctor - creating placeholder",n.objectId),n=this._createPlaceHolder(n));Mail.MessageListTreeNode.call(this,n,"conversation",null)};Jx.inherit(Mail.ConversationNode,Mail.MessageListTreeNode);n=Mail.ConversationNode.prototype;n.dispose=function(){Mail.MessageListTreeNode.prototype.dispose.call(this);this._disposeChildren()};n._disposeChildren=function(){Jx.dispose(this._children);this._unhook();this._children=null;this._expanded=false};n.expand=function(){if(t("expand",this.objectId),this.children.count>1){t("expand - firing itemAdded events for child messages",this.objectId);this._setExpanded(true);var n=this.objectId;Mail.Collection.forEach(this.children,function(t,i){this.raiseEvent("itemAdded",{eType:u.itemAdded,target:this,prevId:n,data:t,objectId:t.objectId,index:i});n=t.objectId},this);i("expand - firing itemAdded events for child messages",this.objectId)}return i("expand",this.objectId),this._expanded};n.collapse=function(n){var f,r,e;if(t("collapse index:="+n,this.objectId),f=this._expanded,this._expanded){for(t("collapse - firing itemRemoved events for child messages",this.objectId),r=0;r<this.children.count;r++)e=this.item(r),this.raiseEvent("itemRemoved",{eType:u.itemRemoved,target:this,objectId:e.objectId,index:r,parentIndex:n});this._setExpanded(false);i("collapse - firing itemRemoved events for child messages",this.objectId)}return this._disposeChildren(),i("collapse index:="+n,this.objectId),f};n.isParent=function(n){return this.findIndexById(n)!==-1};n.item=function(n){return this.children.item(n)};n.map=function(n,t){return Mail.Collection.map(this.children,n,t)};n.findIndexById=function(n){return Mail.Collection.findIndexById(this.children,n)};n.forEach=function(n,t){this.pendingRemoval||Mail.Collection.forEach(this.children,n,t)};n.lock=function(){r("lock",this.objectId);this._locked=true;this._children&&this._children.lock()};n.unlock=function(){r("unlock",this.objectId);this._locked=false;this._children&&this._children.unlock()};n._createPlaceHolder=function(n){return{objectId:n.objectId,totalCount:0,getChildMessageCollection:function(){return new Mail.ArrayCollection([])},pendingRemoval:true}};Object.defineProperty(n,"totalCount",{get:function(){return this._children?this._children.count:this._data.totalCount},enumerable:true});Object.defineProperty(n,"children",{get:function(){return this._ensureChildren(),this._children},enumerable:true});Object.defineProperty(n,"visibleChildrenCount",{get:function(){return this.expanded?this.children.count:0},enumerable:true});Object.defineProperty(n,"pendingCollapse",{get:function(){return this._expanded&&this.totalCount<=1},enumerable:true});Object.defineProperty(n,"pendingRemoval",{get:function(){return this._data.pendingRemoval},enumerable:true});n._setExpanded=function(n){this._expanded=n;this.raiseEvent("toggleExpansion")};n._hook=function(){this._disposer=new Mail.Disposer(new Mail.EventHook(this._children,"beginChanges",this._beginChanges,this),new Mail.EventHook(this._children,"endChanges",function(n){this._forwardEvent("endChanges",n)},this),new Mail.EventHook(this._children,"itemAdded",function(n){this._forwardEvent("itemAdded",n)},this),new Mail.EventHook(this._children,"itemRemoved",function(n){this._forwardEvent("itemRemoved",n)},this),new Mail.EventHook(this._children,"itemMoved",function(n){this._forwardEvent("itemMoved",n)},this),new Mail.EventHook(this._children,"reset",function(n){this._forwardEvent("reset",n)},this))};n._unhook=function(){Jx.dispose(this._disposer);this._disposer=null};n._ensureChildren=function(){if(!this._children){t("_ensureChildren",this.objectId);var n=new Mail.QueryCollection(this._data.getChildMessageCollection,this._data);this._children=Mail.MessageListCollection.createForMessages(n,this._view,this._locked,this);this._hook();i("_ensureChildren",this.objectId)}};n._beginChanges=function(n){this._forwardEvent("beginChanges",n)};n._forwardEvent=function(n,t){t.target=this;this.raiseEvent(n,t)}})