Jx.delayDefine(Mail,"ThreadedListCollection",function(){"use strict";function u(n){Jx.mark("ThreadedListCollection."+n)}function t(n){Jx.mark("ThreadedListCollection."+n+",StartTA,ThreadedListCollection")}function i(n){Jx.mark("ThreadedListCollection."+n+",StopTA,ThreadedListCollection")}var f=Mail.SelectionHelper,r=-1,n;Mail.ThreadedListCollection=function(n,u,f,e,o){var c,s,h;t("ctor");o=o||{};this._platform=n;this._locked=e;this._batchDepth=0;c=["_onMessageItemAdded","_onMessageItemRemoved","_onConversationAdded","_onConversationRemoved","_onConversationMoved","_onMessageItemMoved"];c.forEach(function(n){this[n]=this._createEventHandler(this[n])}.bind(this));this._conversationCollection=Mail.MessageListCollection.createForConversations(u,f,e);this._convCollectionEventHooks=null;this._initConversationCollection(this._conversationCollection);this._activeConversation=null;this._activeConversationIndex=r;this._activeConversationEventHooks=null;this._pendingCollapseExpand=null;s=o.initialExpansion;h=o.initialExpansionId;this.count>0&&(Jx.isNumber(s)||Jx.isNonEmptyString(h))&&this._tryInitialExpansion(s,h);i("ctor")};Jx.inherit(Mail.ThreadedListCollection,Jx.Events);n=Mail.ThreadedListCollection.prototype;Object.defineProperty(n,"count",{get:function(){var n=this._conversationCollection.count;return n>0?n+this._visibleExpandedItemsCount:n}});Object.defineProperty(n,"_visibleExpandedItemsCount",{get:function(){return this._activeConversation?this._activeConversation.visibleChildrenCount:0},enumerable:true});Object.defineProperty(n,"isEmpty",{get:function(){return this.count===0}});Object.defineProperty(n,"expanded",{get:function(){return this._activeConversation?this._activeConversation.expanded:false}});Object.defineProperty(n,"activeConversationIndex",{get:function(){return this._activeConversationIndex}});Object.defineProperty(n,"activeConversation",{get:function(){return this._activeConversation}});n.findIndexByThreadId=function(n,t){if(this._activeConversation&&this._activeConversation.objectId===n&&this._isValidIndex(this._activeConversationIndex))return this._activeConversationIndex;var i=r,u=Mail.Collection.findIndexById(this._conversationCollection,n,t);return u!==r&&(i=this._conversationIndexToOverallIndex(u)),i};n.findIndexByMessageId=function(n,t){var i,r,u,f;if(n){i=null;try{i=this._platform.mailManager.loadMessage(n).parentConversationId}catch(e){}if(i&&(r=this.findIndexByThreadId(i,t),r!==-1&&(u=this.item(r),f=u.findIndexById(n),f!==-1)))return r}return-1};n.clearPendingExpandCollapse=function(){Jx.dispose(this._pendingCollapseExpand);this._pendingCollapseExpand=null};n._isThreadIndex=function(n){return this._isValidIndex(n)&&!this._isIndexWithinExpandedConversation(n)};n.expand=function(n,f){if(this._isValidIndex(n)&&this._isThreadIndex(n)&&!this.item(n).pendingRemoval)if(this._locked)u("expand - delaying expand until listview is ready. index:="+n),this.clearPendingExpandCollapse(),this._pendingCollapseExpand=new Mail.Promises.AsyncJob(this.expand,this,[n]);else{t("expand - index:="+n);var e=this._overallIndexToConversationIndex(n);this._beginChanges();this._activeConversationIndex!==r&&this._activeConversationIndex!==n&&this._collapseHelper();this._expandHelper(e,f);this._endChanges();i("expand - index:="+n)}return WinJS.Promise.as(this._pendingCollapseExpand?this._pendingCollapseExpand.promise:null)};n.collapse=function(){return this.expanded&&(this._locked?(u("collapse - delaying collapse until listview is ready. index:="+this._activeConversationIndex),this.clearPendingExpandCollapse(),this._pendingCollapseExpand=new Mail.Promises.AsyncJob(this.collapse,this)):(t("collapse - index:"+this._activeConversationIndex),this._beginChanges(),this._collapseHelper(),this._endChanges(),i("collapse - index:"+this._activeConversationIndex))),WinJS.Promise.as(this._pendingCollapseExpand?this._pendingCollapseExpand.promise:null)};n.item=function(n){var t=this._isIndexWithinExpandedConversation(n);return t?this._activeConversation.item(n-this._activeConversationIndex-1):this._conversationCollection.item(this._overallIndexToConversationIndex(n))};n.getTreeView=function(){return this};n.dispose=function(){t("dispose");this.clearPendingExpandCollapse();this._unhookActiveConversation();Jx.dispose(this._activeConversation);this._activeConversation=null;this._activeConversationIndex=r;Jx.dispose(this._conversationCollection);this._conversationCollection=null;Jx.dispose(this._convCollectionEventHooks);this._convCollectionEventHooks=null;this._platform=null;i("dispose")};n.lock=function(){this._locked||(t("lock"),this._locked=true,this._conversationCollection.lock(),this._activeConversation&&this._activeConversation.lock(),i("lock"))};n.unlock=function(){this._locked&&(this._locked=false,this._pendingCollapseExpand&&(t("unlock - running pending collapse/expand"),this._beginChanges(),this._pendingCollapseExpand.execute(),this.clearPendingExpandCollapse(),this._endChanges(),i("unlock - running pending collapse/expand")),t("unlock - accept pending changes"),this._beginChanges(),this._conversationCollection.unlock(),this._activeConversation&&this._activeConversation.unlock(),this._endChanges(),i("unlock - accept pending changes"))};n._onReset=function(n){this._filterAndAdjustEvent(n)&&(t("._onReset"),this.clearPendingExpandCollapse(),this._unhookActiveConversation(),this._activeConversation&&this._activeConversation.collapse(),this._clearActiveConversation(),this.raiseEvent("reset",n),i("._onReset"))};n._baseEventHandler=function(n,t){var i=f.getEventType(n.eType);this._filterAndAdjustEvent(n)&&(n.originalExpandedConversationIndex=this._activeConversationIndex,this._activeConversationIndex=f.getUpdatedIndex(i,n,this._activeConversationIndex),t.call(this,n))};n._createEventHandler=function(n){return function(t){this._baseEventHandler(t,n)}.bind(this)};n._onConversationAdded=function(n){t("_onConversationAdded index:="+n.index+" key:="+n.objectId);this.raiseEvent("itemAdded",n);i("_onConversationAdded index:="+n.index+" key:="+n.objectId)};n._onConversationRemoved=function(n){if(this._beginChanges(),n.index===n.originalExpandedConversationIndex){t("_onConversationRemoved - activeConversation:=true index:="+n.originalExpandedConversationIndex);var r=this._activeConversationIndex,u=this._activeConversation;this._activeConversationIndex=-1;this._activeConversation=null;this._collapseHelper(u,r);Jx.dispose(this._activeConversationEventHooks);this._activeConversationEventHooks=null;i("_onConversationRemoved - activeConversation:=true index:="+n.originalExpandedConversationIndex)}t("_onConversationRemoved activeConversation:=false index:="+n.index);this.raiseEvent("itemRemoved",n);i("_onConversationRemoved activeConversation:=false index:="+n.index);this._endChanges()};n._onConversationMoved=function(n){var t=n.previousIndex===n.originalExpandedConversationIndex&&this.expanded;t?(this._beginChanges(),this._onExpandedConversationMoved(n),this._endChanges()):(n.originalExpandedConversationIndex!==r&&n.index===n.originalExpandedConversationIndex&&n.index>n.previousIndex&&(n.index+=this._visibleExpandedItemsCount),this.raiseEvent("itemMoved",n))};n._onExpandedConversationMoved=function(n){var s,r;t("onExpandedConversationMoved");s=n.originalExpandedConversationIndex;r=n.index>n.previousIndex;var h=Microsoft.WindowsLive.Platform.CollectionChangeType,f=r?this._conversationCollection.item(this._activeConversationIndex-1).objectId:null,e=r?null:this._conversationCollection.item(this._activeConversationIndex+1).objectId,o=this._activeConversation.map(function(n,t){var i=s+t+1,r=this._activeConversationIndex+t+1;return{eType:h.itemChanged,data:n,previousIndex:i,index:r,prevId:f,nextId:e,objectId:n.objectId}},this);n.prevId=f;n.nextId=e;o.unshift(n);r&&o.reverse();o.forEach(function(n){this.raiseEvent("itemMoved",n)},this);i("onExpandedConversationMoved")};n._onMessageItemAdded=function(n){t("_onMessageItemAdded");this._activeConversation.expanded&&this.raiseEvent("itemAdded",n);i("_onMessageItemAdded")};n._onMessageItemRemoved=function(n){n.target.expanded&&(this._beginChanges(),this.raiseEvent("itemRemoved",n),this._endChanges())};n._onMessageItemMoved=function(n){this.raiseEvent("itemMoved",n)};n._fireCollapsingEvent=function(n,t){if(n.expanded){var i=t+1,u=t+n.visibleChildrenCount;this.raiseEvent("collapsing",{target:this,index:t,firstMessageIndex:i,lastMessageIndex:u})}};n._expandHelper=function(n,r){t("_expandHelper");this.clearPendingExpandCollapse();var u=this._conversationCollection.item(n);!u||u.pendingRemoval||u.expanded||(this._activeConversation!==u&&this._setActiveConversation(n,u),this._activeConversation.expand()&&this.raiseEvent("expanded",{target:this,index:this._activeConversationIndex,newValue:this._activeConversation,childIdToSelect:r}));i("_expandHelper")};n._collapseHelper=function(n,u){var e=Jx.isUndefined(n)?this._activeConversation:n,f=Jx.isUndefined(u)?this._activeConversationIndex:u;t("_collapseHelper index:="+f);this.clearPendingExpandCollapse();this._fireCollapsingEvent(e,f);e.collapse(u)&&this.raiseEvent("collapsed",{target:this,index:f,newValue:null});i("_collapseHelper index:="+f)};n._setActiveConversation=function(n,t){u("_setActiveConversation - index:="+n+" key:="+t?t.objectId:null);this._activeConversationIndex=n;t!==this._activeConversation&&(this._unhookActiveConversation(),this._activeConversation=t,this._locked?this._activeConversation.lock():this._activeConversation.unlock(),this._hookActiveConversation(this._activeConversation))};n._clearActiveConversation=function(){u("_clearActiveConversation");this._unhookActiveConversation();this._activeConversation=null;this._activeConversationIndex=-1};n._beginChanges=function(){if(this._batchDepth===0){var n=this.count;t("_beginChanges count:="+n);this.raiseEvent("beginChanges",{target:this});i("_beginChanges count:="+n)}this._batchDepth++};n._endChanges=function(){if(this._batchDepth===1){this._ensureVisibleInvisible();var n="_endChanges count:="+this.count;t(n);this.raiseEvent("endChanges",{target:this});i(n)}this._batchDepth--};n._initConversationCollection=function(n){t("_initConversationCollection");this._convCollectionEventHooks=new Mail.Disposer(new Mail.EventHook(n,"beginChanges",this._beginChanges,this),new Mail.EventHook(n,"endChanges",this._endChanges,this),new Mail.EventHook(n,"itemAdded",this._onConversationAdded,this),new Mail.EventHook(n,"itemRemoved",this._onConversationRemoved,this),new Mail.EventHook(n,"itemMoved",this._onConversationMoved,this),new Mail.EventHook(n,"reset",this._onReset,this));i("_initConversationCollection")};n._hookActiveConversation=function(n){t("_hookActiveConversation");this._activeConversationEventHooks=new Mail.Disposer(new Mail.EventHook(n,"beginChanges",this._beginChanges,this),new Mail.EventHook(n,"endChanges",this._endChanges,this),new Mail.EventHook(n,"itemAdded",this._onMessageItemAdded,this),new Mail.EventHook(n,"itemRemoved",this._onMessageItemRemoved,this),new Mail.EventHook(n,"itemMoved",this._onMessageItemMoved,this),new Mail.EventHook(n,"reset",this._onReset,this));i("_hookActiveConversation")};n._unhookActiveConversation=function(){t("_unhookActiveConversation");Jx.dispose(this._activeConversationEventHooks);this._activeConversationEventHooks=null;i("_unhookActiveConversation")};n._tryUpdateConversationEventIndex=function(n,t){var i=n[t],f=Microsoft.WindowsLive.Platform.CollectionChangeType,e=n.eType===f.itemChanged&&n.previousIndex===this._activeConversationIndex,r;e||Jx.isNumber(i)&&(r=n[t]=this._conversationIndexToOverallIndex(i),i!==r)};n._tryUpdateMessageEventIndex=function(n,t){var i=n[t],r=Jx.isNumber(n.parentIndex)?n.parentIndex:this._activeConversationIndex,f;Jx.isNumber(i)&&(f=n[t]=r+i+1)};n._filterAndAdjustEvent=function(n){var i=n.target,t;return t=true,i===this._conversationCollection?(n.originalIndex=n.index,this._tryUpdateConversationEventIndex(n,"index"),this._tryUpdateConversationEventIndex(n,"previousIndex"),t=false):(i===this._activeConversation||Jx.isValidNumber(n.parentIndex))&&(n.originalIndex=n.index,this._tryUpdateMessageEventIndex(n,"index"),this._tryUpdateMessageEventIndex(n,"previousIndex"),t=false),!t};n._ensureVisibleInvisible=function(){this._activeConversation&&(t("_ensureVisibleInvisible index:= "+this._activeConversationIndex),this._activeConversation.pendingCollapse&&this._collapseHelper(),i("_ensureVisibleInvisible index:= "+this._activeConversationIndex))};n._isIndexWithinExpandedConversation=function(n){return this._activeConversationIndex!==r&&n>this._activeConversationIndex&&n<=this._activeConversationIndex+this._visibleExpandedItemsCount};n._overallIndexToConversationIndex=function(n){var t=n;return this._activeConversationIndex>=0&&this._activeConversationIndex<this._conversationCollection.count&&n>this._activeConversationIndex&&(t-=this._visibleExpandedItemsCount),t};n._conversationIndexToOverallIndex=function(n){var t=n;return this._activeConversationIndex>=0&&this._activeConversationIndex<this._conversationCollection.count&&n>this._activeConversationIndex&&(t+=this._visibleExpandedItemsCount),t};n._isValidIndex=function(n){return n>=0&&n<this.count};n._tryInitialExpansion=function(n,t){n=Jx.isNumber(n)?n:-1;var i=-1;i=Jx.isNonEmptyString(t)?this.findIndexByMessageId(t,n):n;!this._isValidIndex(i)&&this._conversationCollection.count>0&&(i=0);i!==-1&&this._expandHelper(i)};Debug.ThreadedListCollection={};Debug.ThreadedListCollection.verifyExpansionState=function(n){var o,r,i,s,h,u,c;if(n._activeConversation){var t=n.activeConversationIndex,f=" :: expandedIndex:"+String(t),e=n.activeConversation;if(o=e.objectId,f+=", headerId:"+o,r=e.visibleChildrenCount,n._activeConversation.expanded)for(i=t+1;i<t+r+1;i++)s=n.item(i),h=s.parentId,f+=", messageParentId:"+String(h);(u=t+r+1,n._isValidIndex(u))&&(c=n.item(u))}}})