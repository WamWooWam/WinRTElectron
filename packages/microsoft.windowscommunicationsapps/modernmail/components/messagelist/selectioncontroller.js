Jx.delayDefine(Mail,"SelectionController",function(){"use strict";function e(n){return Jx.isRtl()&&(n=n==="Left"?"Right":"Left"),n}function o(n){Jx.mark("SelectionController:"+n)}function r(n){Jx.mark("SelectionController."+n+",StartTA,SelectionController")}function i(n){Jx.mark("SelectionController."+n+",StopTA,SelectionController")}var t=Mail.SelectionModel.ScrollOptions,f=400,u=Mail.SelectionController=function(n,t,i,r){Mail.writeProfilerMark("SelectionController_ctor",Mail.LogEvent.start);this._model=i;this._collection=n;this._view=t.view;this._handler=r;this._treeView=n.getTreeView();this._displayedItemManager=new Mail.DisplayedItemManager(n,i,t);this._nodeExpansionHandler=new Mail.SimpleNodeExpansionHandler(t.view,n,i);this._selection=t;this._tryInvokeAsyncId=-1;this._tryAnimationJob=null;var u=i.listViewElement;this._disposer=new Mail.Disposer(new Mail.EventHook(this._treeView,"collapsing",this._onNodeCollapsing,this),new Mail.EventHook(this._treeView,"expanded",this._onNodeExpanded,this),new Mail.EventHook(u,"keydown",this._onKeyDown,this,true),new Mail.EventHook(this._collection,"beginChanges",this._onBeginChanges,this),new Mail.EventHook(this._collection,"itemRemoved",this._onItemRemoved,this),new Mail.EventHook(this._collection,"endChanges",this._onEndChanges,this));this._createModelEventHooks();Mail.writeProfilerMark("SelectionController_ctor",Mail.LogEvent.stop)},n=u.prototype;n.dispose=function(){Mail.writeProfilerMark("SelectionController.dispose",Mail.LogEvent.start);this._clearAsyncOperations();Jx.dispose(this._disposer);this._disposer=null;this._model=null;this._treeView=null;this._collection=null;Jx.dispose(this._displayedItemManager);this._displayedItemManager=null;Mail.writeProfilerMark("SelectionController.dispose",Mail.LogEvent.stop)};n._createModelEventHooks=function(){this._modelEventHook=this._disposer.add(new Mail.Disposer(new Mail.EventHook(this._model,"selectionchanging",this._onSelectionChanging,this),new Mail.EventHook(this._model,"selectionchanged",this._onSelectionChanged,this),new Mail.EventHook(this._model,"iteminvoked",this._onItemInvoked,this)))};n.setInitialSelection=function(n,i,r){var u;if(Mail.writeProfilerMark("SelectionController.setInitialSelection",Mail.LogEvent.start),this._collection.mailItems.count>0){u=this._collection.findIndexByMessageId(n,i);u===-1&&(u=0,n=null);r=Jx.isNonEmptyString(r)?r:t.ensureVisible;var f=this._collection.item(u),o=Mail.DisplayedItemRetriever.create(this._view,f).findMessage(n),e=f.expanded?u+o.offset:u;this._displayedItemManager.setDisplayItem(e,n);this._setSelection(e,r,{childIdToSelect:n})}else this.clearDisplayedItem();Mail.writeProfilerMark("SelectionController.setInitialSelection",Mail.LogEvent.stop)};n.setModel=function(n){this._disposer.disposeNow(this._modelEventHook);this._modelEventHook=null;this._model=n;this._displayedItemManager.setModel(n);this._updateDisplayedItem();this._createModelEventHooks()};n.exitSelectionMode=function(){var f=this._displayedItemManager.displayedItem,n=-1,r,i,u,e;f&&(r=f.objectId,i=Mail.Collection.findIndexById(this._collection,r),this._model.isValidIndex(i)&&(u=this._collection.item(i),u.expanded?(e=Mail.DisplayedItemRetriever.create(this._view,u).findMessage(r),n=e.offset+i):n=i));this._model.isValidIndex(n)||(n=this._displayedItemManager.handleSelectedItemDeleted());n!==-1&&this._model.setSelection(n,t.ensureVisible,true)};n.setNodeExpansionHandler=function(n){this._nodeExpansionHandler=n};n.clearDisplayedItem=function(){this._displayedItemManager.clear()};n._onNodeCollapsing=function(n){for(var i=[],t=n.firstMessageIndex;t<=n.lastMessageIndex;t++)i.push(t);this._model.removeSelection(i,false)};n._onNodeExpanded=function(n){this._nodeExpansionHandler.onNodeExpanded(n)};n._onBeginChanges=function(){this._hasSelectableItemsBeforeCurrentOperation=Mail.SelectionHelper.hasSelectableItems(this._collection)};Mail.SelectionController.prototype._onEndChanges=function(){r("_onEndChanges");var n=this._hasSelectableItemsBeforeCurrentOperation;this._hasSelectableItemsBeforeCurrentOperation=false;!n&&Mail.SelectionHelper.hasSelectableItems(this._collection)&&this._setSelection(0,t.none);i("_onEndChanges")};n._onItemRemoved=function(n){var s,u,h,f,e;r("_onItemRemoved");this._selection.messages.length===1&&(s=this._displayedItemManager,u=this._displayedItemManager.displayedItem,u&&(h=u.message,f=n.objectId,h.objectId!==f&&u.objectId===f&&(e=s.handleSelectedItemDeleted(),o("_onItemRemoved: setting expected selection to "+e),this._setSelection(e,t.none,{viaKeyboard:false}))));i("_onItemRemoved")};n._onItemInvoked=function(n){var t=n.detail.itemIndex;this._tryInvokeItem(t)};n._onSelectionChanging=function(n){var r,t,i;Mail.SelectionHelper.preventEmptySelectionChanging(this._collection,n)||(Mail.log("SelectionController_onSelectionChanging",Mail.LogEvent.start),r=n.detail.newSelection.getIndices(),t=this._model.selection().diff(r),t.added.length+t.removed.length===1&&(i=t.added.length===1?t.added[0]:t.removed[0],this._model.isValidIndex(i)&&!this._shouldAllowTapSelection(i)&&n.detail.preventTapBehavior()),Mail.log("SelectionController_onSelectionChanging",Mail.LogEvent.stop))};n._isConversationIndex=function(n){if(n>this._collection.count||n<0)return false;var t=this._collection.item(n);return t.type==="conversation"};n._onSelectionChanged=function(n){if(this._clearAsyncInvoke(),Mail.SelectionHelper.hasSelectableItems(this._collection)){Mail.writeProfilerMark("SelectionController._onSelectionChanged_nonEmptyCollection",Mail.LogEvent.stop);var i=this._model.selection(),r=n.invokeType===Mail.SelectionModel.InvokeTypes.keyboard,u=this._displayedItemManager.handleSelectionChange(i,r);i.length===0?this._setSelection(u,t.ensureVisible,{alwaysAllowTapSelection:true}):i.length!==1||r||(this._model.currentItem={index:i.indices[0],hasFocus:false});r&&i.length===1&&this._isConversationIndex(i.indices[0])&&this._tryInvokeAsync(i.indices[0],f,true);Mail.writeProfilerMark("SelectionController._onSelectionChanged_nonEmptyCollection",Mail.LogEvent.stop)}else this.clearDisplayedItem()};n._onKeyDown=function(n){var u,o,f,s,h;u=n.key;(u==="Left"||u==="Right")&&(r("_onKeyDown key:="+u),o=this._model.selection(),f=o.length===1?o.indices[0]:-1,this._model.isValidIndex(f)&&(s=this._collection.item(f),h=u===e("Right"),h&&!s.expanded&&s.totalCount>1&&(this._treeView.expand(f),n.stopImmediatePropagation()),!h&&this._treeView.expanded&&(this._setSelection(this._treeView.activeConversationIndex,t.ensureVisible,{viaKeyboard:false}),n.stopImmediatePropagation())),i("_onKeyDown key:="+u))};n._setSelection=function(n,t,u){var f,e;if(r("_setSelection"),u=u||{},u.viaKeyboard=Jx.isNullOrUndefined(u.viaKeyboard)?false:u.viaKeyboard,f=u.childIdToSelect,!this._model.isValidIndex(n)){i("_setSelection");return}this._clearAsyncOperations();e=u.alwaysAllowTapSelection||u.viaKeyboard||this._shouldAllowTapSelection(n);u.viaKeyboard||u.disableInvoke||this._tryInvokeItem(n,true,f);e&&this._model.setSelection(n,t,u.viaKeyboard);i("_setSelection")};n._shouldAllowTapSelection=function(n){var t=this._collection.item(n),i=t.totalCount>1&&!t.expanded;return!i};n._clearAsyncInvoke=function(){this._tryInvokeAsyncId!==-1&&(clearTimeout(this._tryInvokeAsyncId),this._tryInvokeAsyncId=-1)};n._clearAsyncAnimation=function(){Jx.dispose(this._tryAnimationJob);this._tryAnimationJob=null};n._tryInvokeAsync=function(n,t,i){this._clearAsyncOperations();this._tryInvokeAsyncId=setTimeout(this._tryInvokeItem.bind(this,n,i),t)};n._clearAsyncOperations=function(){this._clearAsyncInvoke();this._clearAsyncAnimation();this._treeView.clearPendingExpandCollapse()};n._tryInvokeItem=function(n,t,i){if(Mail.writeProfilerMark("SelectionController._tryInvokeItem - index:"+String(n),Mail.LogEvent.start),this._model.isValidIndex(n)){this._clearAsyncOperations();var r=this._collection.item(n),u=r.type==="conversation",f=r.totalCount>1,e=!t&&!f;if(r.pendingRemoval){Jx.log.warning("SelectionController._tryInvokeItem - ignoring the invoke event as item is pending removal");Mail.writeProfilerMark("SelectionController._tryInvokeItem - index:"+String(n),Mail.LogEvent.stop);return}u&&this._toggleExpansion(n,i);e&&this._tryOnePaneNavigation(r)}Mail.writeProfilerMark("SelectionController._tryInvokeItem - index:"+String(n),Mail.LogEvent.stop)};n._updateDisplayedItem=function(){var n=this._model.selection(),i=this._displayedItemManager.handleSelectionChange(n,false);n.length===0&&i!==-1&&this._setSelection(i,t.ensureVisible,{alwaysAllowTapSelection:true,disableInvoke:true})};n._tryOnePaneNavigation=function(n){Mail.guiState.isOnePane&&!this._handler.isSelectionMode&&(this._tryAnimationJob=Jx.scheduler.addJob(null,Mail.Priority.messageListTryAnimation,"threaded selection controller - one pane animation",function(){if(Mail.guiState.isOnePane){var t=this._displayedItemManager.displayedItem,i=t&&t.objectId===n.objectId;Mail.Globals.animator.animateNavigateForward(Jx.fnEmpty,i)}},this))};n._toggleExpansion=function(n,t){Mail.writeProfilerMark("SelectionController._toggleExpansion - index:= "+String(n),Mail.LogEvent.start);var i=this._collection.item(n);i.expanded?this._treeView.collapse():this._treeView.expand(n,t).then(function(){this._treeView.expanded||this._model.ensureVisible(this._treeView.activeConversationIndex)}.bind(this));Mail.writeProfilerMark("SelectionController._toggleExpansion - index:= "+String(n),Mail.LogEvent.stop)};u.getSelectionRange=function(n,t,i){var r;var u=i.selection().indices,f=n,e=f;return t&&(r=i.selectionPivot,r===-1&&(r=u.length>0?u[u.length-1]:n),f=Math.min(n,r),e=Math.max(n,r)),{firstIndex:f,lastIndex:e}};n.onCheckBoxClicked=function(n,t){var i,r;if(Mail.writeProfilerMark("SelectionController._onCheckBoxClicked",Mail.LogEvent.start),i=this._model.findIndexByElement(n),r=Mail.SelectionController.getSelectionRange(i,t,this._model),t||(this._model.currentItem={index:i}),this._handler.isSelectionMode)if(t)this._model.addSelection(r);else{var u=this._model.selection(),f=u.isIndexSelected(i),e=f?this._model.removeSelection:this._model.addSelection;e.call(this._model,i)}else this._model.setSelectionRange(r,true).then(function(){this._handler.startSelectionMode()}.bind(this));Mail.writeProfilerMark("SelectionController._onCheckBoxClicked",Mail.LogEvent.stop)};Mail.SimpleNodeExpansionHandler=function(n,t,i){this._view=n;this._collection=t;this._model=i};Mail.SimpleNodeExpansionHandler.prototype.onNodeExpanded=function(n){var u;var i=n.index,f=this._collection.item(i),r=i+1;f.totalCount<=1||(u=Mail.DisplayedItemRetriever.create(this._view,f).findMessage(n.childIdToSelect),u.offset!==-1&&(r=i+u.offset),r!==-1&&this._model.setSelection(r,t.ensureVisible,false))}})