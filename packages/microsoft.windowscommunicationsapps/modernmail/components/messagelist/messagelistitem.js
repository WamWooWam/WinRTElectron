Jx.delayDefine(Mail,"MessageListItem",function(){"use strict";function e(n){return n.loadingState!=="complete"?Mail.Promises.waitForEvent(n,"loadingstatechanged",function(){return n.loadingState==="complete"}):WinJS.Promise.wrap()}var t=Microsoft.WindowsLive.Platform,i="convHeader",r="convChild",h="unthreadedMsg",n=Mail.MessageListItem=function(n,t,u,e){this._node=n;this._item=n.data;this._selection=u;this._isThreadingMode=e;this._element=null;this._checkBox=null;this._identityControls=[];this._onItemCommandControl=null;this._renderIncomplete=false;this._toBeRemoved=false;this._updateAriaJob=null;this._renderFullJob=null;this._listViewPromise=null;this._selectionHandler=t;this._type=Jx.isInstanceOf(this._item,Mail.UIDataModel.MailConversation)?i:this._isThreadingMode?r:h;f();this._disposer=new Mail.Disposer},u,f,o,s;Object.defineProperty(n.prototype,"objectId",{get:function(){return this._item.objectId},enumerable:true});n.prototype._alwaysRenderFrom=function(){var n=this._selection.view.folder;return n&&n.isOutboundFolder?false:!this._item.isDraft};n.prototype._onDisposed=function(){var n=this.objectId;Mail.writeProfilerMark("MessageListItem_onDispose_"+n,Mail.LogEvent.start);Mail.MessageListItemFactory.resetItemById(n);Mail.writeProfilerMark("MessageListItem_onDispose_"+n,Mail.LogEvent.stop)};n.prototype.getElement=function(){return Mail.log("MessageListItem_getElement",Mail.LogEvent.start),this._element||(this._element=document.createElement("div"),this._element.className="mailMessageListEntryContainer "+this._type,this._renderElement(),this._disposer.add(new Mail.EventHook(this._item,"changed",this._itemChanged,this)),this._listenForExpandCollapse()),this._disposer.add(new Mail.EventHook(this._node,"disposed",this._onDisposed,this)),Mail.log("MessageListItem_getElement",Mail.LogEvent.stop),this._element};n.prototype._renderElement=function(){var i;Mail.writeProfilerMark("MessageListItem_renderElement",Mail.LogEvent.start);this._cleanupICs();Jx.dispose(this._onItemCommandControl);this._onItemCommandControl=null;var n=this._item,t=this._element,c=this._getGlyphs(),f=this._getDraftPrefix(),e="",o="",s="",l=this._getCheckBoxDiv(),h="mailMessageListHeaderSecondRow";e=this._alwaysRenderFrom()?this._getFieldDiv("From","fastFromRecipientsString","typeSize16pt"):this._getFieldDiv("From","fastHeaderRecipientsString","typeSize16pt");o=this._type===r?this._getDiv("mailMessageListPreview typeSizeNormal",f+"<span>"+this._item.previewHTML+"<\/span>"):this._getDiv("mailMessageListSubject typeSizeNormal",f+"<span>"+this._item.subjectHTML+"<\/span>");i=this._type===r?Mail.ViewCustomizations.getLabel(n,this._selection.view):null;s=i?this._getDiv("mailMessageListFolder typeSizeSmall",Jx.escapeHtml(i)):this._getFieldDiv("Date","bestDateShortString","typeSizeSmall");n.totalCount<=1&&(h+=" singleItemConversation");Jx.setClass(t,"unread",!n.read);Jx.setClass(t,"mailMessageListConversationExpanded",this._node.expanded);Mail.writeProfilerMark("MessageListItem_setInnerHtml",Mail.LogEvent.start);t.innerHTML=e+"<div class='mailMessageListGlyphContainer typeSizeSmall'>"+c+"<\/div><div class='mailMessageListItemCommandContainer typeSizeSmall'><div class='mailMessageListCommand commandMarkAsReadUnread hidden' aria-hidden='true'><\/div><div class='mailMessageListCommand commandDelete hidden' aria-hidden='true' title='"+u.mailCommandDeleteOnItemTooltip+"'><\/div><div class='mailMessageListCommand commandFlag hidden' aria-hidden='true'><\/div><\/div><div class='"+h+"'>"+s+o+"<\/div>"+l;Mail.writeProfilerMark("MessageListItem_setInnerHtml",Mail.LogEvent.stop);this._renderIncomplete=true;Mail.writeProfilerMark("MessageListItem_renderElement",Mail.LogEvent.stop)};u={};f=function(){["mailCommandDeleteOnItemTooltip","mailMessageListDraftPrefix"].forEach(function(n){u[n]=Jx.escapeHtml(Jx.res.getString(n))});f=Jx.fnEmpty};n.prototype._getGlyphs=function(){var u,e;Mail.writeProfilerMark("MessageListItem_getGlyphs",Mail.LogEvent.start);var r=this._item,o=r.importance,f=r.lastVerb,n=this._getGlyphDiv("graphic glyphIrm",r.irmHasTemplate);return n+=this._getGlyphDiv("graphic glyphAttachment",r.hasOrdinaryAttachments),n+=this._getGlyphDiv("graphic glyphInvite",r.calendarInvite),n+=this._getGlyphDiv("graphic glyphLowPriority",o===t.MailMessageImportance.low),n+=this._getGlyphDiv("graphic glyphHiPriority",o===t.MailMessageImportance.high),n+=this._getGlyphDiv("graphic glyphReplied mirrorInRTL",f===t.MailMessageLastVerb.replyToSender||f===t.MailMessageLastVerb.replyToAll),n+=this._getGlyphDiv("graphic glyphForwarded mirrorInRTL",f===t.MailMessageLastVerb.forward),n+=this._getGlyphDiv("graphic glyphFlag",r.flagged),this._type===i&&(u=r.totalCount,e="glyphCount",n&&(e+=" glyphDivider"),n+=this._getGlyphDiv(e,u>1,u>99?"99+":u)),Mail.writeProfilerMark("MessageListItem_getGlyphs",Mail.LogEvent.stop),n};n.prototype._getDraftPrefix=function(){return this._item.hasDraft?this._getDiv("mailMessageListDraftPrefix typeSizeNormal",u.mailMessageListDraftPrefix):""};n.prototype._getFieldDiv=function(n,t,i,r){Mail.writeProfilerMark("MessageListItem_getFieldDiv:"+n,Mail.LogEvent.start);var u=this._getDiv("mailMessageList"+n+" "+i,(r||"")+Jx.escapeHtml(this._item[t]));return Mail.writeProfilerMark("MessageListItem_getFieldDiv:"+n,Mail.LogEvent.stop),u};n.prototype._getGlyphDiv=function(n,t,i){return t?this._getDiv("mailMessageListGlyph "+n,i):""};n.prototype._getDiv=function(n,t){return"<div aria-hidden='true' class='"+n+"'>"+(t?t:"")+"<\/div>"};n.prototype._getCheckBoxDiv=function(){return"<div class='mailMessageListCheckBox' aria-hidden='true' role='checkbox' tabindex='-1'><div class='mailMessageListCheckBoxButton' aria-hidden='true' tabindex='-1'><span class='mailMessageListCheckBoxGlyph' aria-hidden='true' tabindex='-1'><\/span><\/div><\/div>"};n.prototype._cleanupICs=function(){this._identityControls.forEach(function(n){n.shutdownUI()});this._identityControls=[]};n.prototype.markForCleanup=function(){Mail.writeProfilerMark("MessageListItem.markForCleanup",Mail.LogEvent.start);this._toBeRemoved=true;this._cancelPendingJobs();this._element&&this._element.classList.add("toBeRemoved");Mail.writeProfilerMark("MessageListItem.markForCleanup",Mail.LogEvent.stop)};n.prototype._cancelPendingJobs=function(){Jx.dispose(this._updateAriaJob);this._updateAriaJob=null;Jx.dispose(this._renderFullJob);this._renderFullJob=null};n.prototype.dispose=function(){Mail.writeProfilerMark("MessageListItem.dispose",Mail.LogEvent.start);this._listViewPromise&&(this._listViewPromise.cancel(),this._listViewPromise=null);this._cancelPendingJobs();this._cleanupICs();this._element=null;Jx.dispose(this._disposer);this._onItemCommandControl=null;this._item=null;this._node=null;this._selectionHandler=null;Mail.writeProfilerMark("MessageListItem.dispose",Mail.LogEvent.stop)};n.prototype._renderRecipients=function(){var n,t,i,r;Mail.writeProfilerMark("MessageListItem._renderRecipients",Mail.LogEvent.start);n=this._item;t=this._element.querySelector(".mailMessageListFrom");i=this._alwaysRenderFrom()?n.fromRecipientArray:n.headerRecipients;i.length>0?(this._cleanupICs(),this._identityControls=i.map(function(n){return new People.IdentityControl(n,null,{interactive:false})}),r=this._identityControls.map(function(n){return n.getUI(People.IdentityElements.Name)}).join("; "),t.innerHTML=r,this._identityControls.forEach(function(n){n.activateUI(this._element)}.bind(this))):t.innerText=n.headerNoRecipientsString;Mail.writeProfilerMark("MessageListItem._renderRecipients",Mail.LogEvent.stop)};n.prototype._listenForExpandCollapse=function(){this._type===i&&this._disposer.add(new Mail.EventHook(this._node,"toggleExpansion",this._onToggleExpansion,this))};n.prototype.finishUpdates=function(){return this._toBeRemoved||!this._renderIncomplete||this._item.pendingRemoval?false:(Mail.log("MessageListItem_finishUpdates",Mail.LogEvent.start),this._onItemCommandControl=this._disposer.add(new Mail.OnItemCommandControl(this._item,this._selection,this._element)),this._renderRecipients(),this._addAriaDescription(),this._addOnItemCheckBoxHandler(),this._renderIncomplete=false,Mail.log("MessageListItem_finishUpdates",Mail.LogEvent.stop),true)};n.prototype._addAriaDescription=function(){Mail.writeProfilerMark("MessageList_renderer_aria",Mail.LogEvent.start);var n=Mail.MessageListItemAria.getDescription(this._item,this._type===r,this._selection.view);Mail.setAttribute(this._element,"aria-label",n);Jx.dispose(this._updateAriaJob);this._updateAriaJob=null;Mail.writeProfilerMark("MessageList_renderer_aria",Mail.LogEvent.stop)};n.prototype._addOnItemCheckBoxHandler=function(){Mail.writeProfilerMark("MessageList_renderer_addOnItemCheckBoxHandler",Mail.LogEvent.start);this._checkBox=this._element.querySelector(".mailMessageListCheckBox");this._disposer.addMany(new Mail.EventHook(this._checkBox,"click",this._onCheckBoxClicked,this),new Mail.EventHook(this._checkBox,"contextmenu",this._onCheckBoxClicked,this),new Mail.EventHook(this._checkBox,"MSPointerDown",this._onCheckBoxPointerDown,this),new Mail.EventHook(this._element,"keydown",this._onCheckBoxKeyDown,this));Mail.writeProfilerMark("MessageList_renderer_addOnItemCheckBoxHandler",Mail.LogEvent.stop)};n.prototype._onCheckBoxKeyDown=function(n){if(!this._toBeRemoved&&!this._selectionHandler.isSelectionMode&&n.keyCode===Jx.KeyCode.space){this._selectionHandler.controller.onCheckBoxClicked(this._element,false);n.stopPropagation();n.preventDefault()}};n.prototype._onCheckBoxPointerDown=function(n){n.stopPropagation()};n.prototype._onCheckBoxClicked=function(n){if(!this._toBeRemoved)this._selectionHandler.controller.onCheckBoxClicked(this._element,n.shiftKey)};n.prototype._onToggleExpansion=function(){this._toBeRemoved||this._renderExpandCollapse()};n.prototype._renderExpandCollapse=function(){Mail.writeProfilerMark("MessageListItem._expandConversation",Mail.LogEvent.start);this._listViewPromise&&(this._listViewPromise.cancel(),this._listViewPromise=null);this._node.expanded?(this._element.classList.add("mailMessageListConversationPendingExpansion"),this._element.classList.add("mailMessageListConversationExpanded"),this._listViewPromise=e(Mail.MessageListItemFactory.listView).then(function(){Mail.writeProfilerMark("MessageListItem_conversationExpanded");this._listViewPromise=null;this._element.classList.remove("mailMessageListConversationPendingExpansion")}.bind(this))):(this._element.classList.remove("mailMessageListConversationPendingExpansion"),this._listViewPromise=e(Mail.MessageListItemFactory.listView).then(function(){Mail.writeProfilerMark("MessageListItem_conversationCollapsed");this._listViewPromise=null;this._element.classList.remove("mailMessageListConversationExpanded")}.bind(this)));Mail.writeProfilerMark("MessageListItem._expandConversation",Mail.LogEvent.stop)};o=["subject","to","toRecipients","from","fromRecipient","receivedDate","latestReceivedTime","preview","displayViewIds","hasDraft","hasNewsletterCategory","hasSocialUpdateCategory"];s=["flagged","importance","lastVerb","hasOrdinaryAttachments","irmHasTemplate","calendarMessageType","hasCalendarInvite","totalCount"];n.prototype._itemChanged=function(n){var t,i;if(!this._toBeRemoved&&this._renderFullJob===null){if(Mail.Validators.havePropertiesChanged(n,o)){this._cancelPendingJobs();this._renderFullJob=Jx.scheduler.addJob(null,Mail.Priority.finishMessageListItem,"MessageListItem._renderFull",this._renderFull,this);return}if(t=false,Mail.Validators.havePropertiesChanged(n,s)&&(this._element.querySelector(".mailMessageListGlyphContainer").innerHTML=this._getGlyphs(),t=true,Mail.Validators.hasPropertyChanged(n,"totalCount")&&(i=this._element.querySelector(".mailMessageListHeaderSecondRow"),Jx.setClass(i,"singleItemConversation",this._item.totalCount<=1))),Mail.Validators.hasPropertyChanged(n,"read")&&(Jx.setClass(this._element,"unread",!this._item.read),t=true),this._onItemCommandControl)this._onItemCommandControl.onItemChanged(n);t&&this._updateAriaJob===null&&(this._updateAriaJob=Jx.scheduler.addJob(null,Mail.Priority.finishMessageListItem,"MessageListItem._addAriaDescription",this._addAriaDescription,this))}};n.prototype._renderFull=function(){this._toBeRemoved||(this._renderElement(),this.finishUpdates());Jx.dispose(this._renderFullJob);this._renderFullJob=null}})