Jx.delayDefine(Mail,"SelectionModel",function(){"use strict";function n(n){Jx.mark("SelectionModel."+n+",StartTA,SelectionModel")}function t(n){Jx.mark("SelectionModel."+n+",StopTA,SelectionModel")}Mail.SelectionModel=function(r,u){n("_ctor");this._collection=r;this._listView=u;this._selectionChangedJob=null;this._invokeJob=null;this._pendingInvoke=null;this._lastInvokeType=i.unknown;this._viaKeyboardIndex=-1;this._selection=new Mail.FilteredSelection(this._listView.selection.getIndices(),this._collection);this._hookListViewEvents();t("_ctor")};Jx.inherit(Mail.SelectionModel,Jx.Events);var r=Mail.SelectionModel.ScrollOptions={none:"none",ensureVisible:"ensureVisible",scrollToTop:"scrollToTop"},i=Mail.SelectionModel.InvokeTypes={unknown:"unknown",keyboard:"keyboard",tap:"tap"};Mail.SelectionModel.prototype.selectAll=function(){this._listView.selection.selectAll()};Mail.SelectionModel.prototype.dispose=function(){n("dispose");this._clearAsyncSelectionChange();this._clearAsyncInvoke();Jx.dispose(this._listViewEventHook);this._listView=null;this._collection=null;this._viaKeyboardIndex=-1;t("dispose")};Mail.SelectionModel.prototype.findIndexByElement=function(n){return this._listView.indexOfElement(n)};Object.defineProperty(Mail.SelectionModel.prototype,"currentItem",{get:function(){return this._listView.currentItem},set:function(n){return this._listView.currentItem=n},enumerable:true});Object.defineProperty(Mail.SelectionModel.prototype,"selectionPivot",{get:function(){return this._listView.selection._pivot},set:function(n){return this._listView.selection._pivot=n},enumerable:true});Object.defineProperty(Mail.SelectionModel.prototype,"tapBehavior",{get:function(){return this._listView.tapBehavior},set:function(n){return this._listView.tapBehavior=n},enumerable:true});Object.defineProperty(Mail.SelectionModel.prototype,"indexOfFirstVisible",{get:function(){return this._listView.indexOfFirstVisible},set:function(n){return this._listView.indexOfFirstVisible=n},enumerable:true});Object.defineProperty(Mail.SelectionModel.prototype,"listViewElement",{get:function(){return this._listView.element},enumerable:true});Mail.SelectionModel.prototype.isValidIndex=function(n){return n>=0&&n<this._collection.count};Mail.SelectionModel.prototype.selection=function(){return this._selection};Mail.SelectionModel.prototype.addSelection=function(n,t){return this._changeSelection(this._listView.selection.add,[n],t)};Mail.SelectionModel.prototype.removeSelection=function(n,t){return this._changeSelection(this._listView.selection.remove,[n],t)};Mail.SelectionModel.prototype.setSelectionRange=function(n,t){return this._changeSelection(this._listView.selection.set,[n],t)};Mail.SelectionModel.prototype.setSelection=function(i,r,u,f){n("_setSelection index:= "+i);u&&(this._viaKeyboardIndex=i);var o=this._collection.count,e=null;return o!==0?(i=Mail.Validators.clamp(i,0,o-1),e=this._changeSelection(this._listView.selection.set,[i],f).then(this._handleScrollOption.bind(this,i,r))):e=this._changeSelection(this._listView.selection.clear,[],f),t("_setSelection index:= "+i),e};Mail.SelectionModel.prototype.getNodeSelection=function(){return null};Mail.SelectionModel.prototype._hookListViewEvents=function(){n("_hookListViewEvents");this._listViewEventHook=new Mail.Disposer(new Mail.EventHook(this._listView,"selectionchanging",this._onSelectionChanging,this),new Mail.EventHook(this._listView,"selectionchanged",this._onSelectionChanged,this),new Mail.EventHook(this._listView,"iteminvoked",this._onTapInvoked,this),new Mail.EventHook(this._listView,"keyboardnavigating",this._onKeyboardNavigating,this));t("_hookListViewEvents")};Mail.SelectionModel.prototype._onSelectionChanging=function(n){if(this._isListViewEventInvalid(n.detail.newSelection.getIndices())){n.preventDefault();return}this.raiseEvent("selectionchanging",n)};Mail.SelectionModel.prototype._onSelectionChanged=function(r){(n("_onSelectionChanged"),this._clearAsyncSelectionChange(),this._isListViewEventInvalid(this._listView.selection.getIndices()))||(this._selectionChangedJob=Jx.scheduler.addJob(null,Mail.Priority.messageListSetSelection,"selection model - selection changed",function(){var u,f;n("_selectionChangedAsyncId");this._selectionChangedJob=null;u=this._selection;this._selection=new Mail.FilteredSelection(this._listView.selection.getIndices(),this._collection);this._pendingInvoke&&this._runPendingInvoke();f=this._viaKeyboardIndex;this._viaKeyboardIndex=-1;r.invokeType=this._selection.isIndexSelected(f)?i.keyboard:this._lastInvokeType;r.diff=u.diff(this._selection.indices);u.dispose();this._lastInvokeType=i.unknown;this.raiseEvent("selectionchanged",r);t("_selectionChangedAsyncId")},this),t("_onSelectionChanged"))};Mail.SelectionModel.prototype._onTapInvoked=function(r){(n("_onTapInvoked"),this._clearAsyncInvoke(),this._isListViewEventInvalid([r.detail.itemIndex]))||(this._lastInvokeType=i.tap,this._pendingInvoke=this._handleItemInvoke.bind(this,r),this._invokeJob=Jx.scheduler.addJob(null,Mail.Priority.messageListPendingInvoke,"selection model - run pending invoke",function(){this._invokeJob=null;this._runPendingInvoke()},this),t("_onTapInvoked"))};Mail.SelectionModel.prototype._handleItemInvoke=function(n){var i=n.detail.itemIndex,t=this._collection.item(i);if(Jx.isFunction(t.onInvoke)){t.onInvoke.call(t);return}this.raiseEvent("iteminvoked",n)};Mail.SelectionModel.prototype._runPendingInvoke=function(){n("_runPendingInvoke");this._pendingInvoke();this._clearAsyncInvoke();t("_runPendingInvoke")};Mail.SelectionModel.prototype._onKeyboardNavigating=function(){this._lastInvokeType=i.keyboard};Mail.SelectionModel.prototype._clearAsyncSelectionChange=function(){Jx.dispose(this._selectionChangedJob);this._selectionChangedJob=null};Mail.SelectionModel.prototype._clearAsyncInvoke=function(){this._pendingInvoke=null;Jx.dispose(this._invokeJob);this._invokeJob=null};Mail.SelectionModel.prototype._isListViewEventInvalid=function(i){n("_isListViewEventInvalid");var r=this._collection.count,u=i.some(function(n){return n>=r});return t("_isListViewEventInvalid"),u};Mail.SelectionModel.prototype._changeSelection=function(r,u,f){n("_changeSelection");f&&(Jx.dispose(this._listViewEventHook),this._clearAsyncSelectionChange());n("_changeSelection-listview");var e=r.apply(this._listView.selection,u);return t("_changeSelection-listview"),e=e.then(function(){f&&(this._selection=new Mail.FilteredSelection(this._listView.selection.getIndices(),this._collection),this._lastInvokeType=i.unknown,this._hookListViewEvents())}.bind(this)),t("_changeSelection"),e};Mail.SelectionModel.prototype._handleScrollOption=function(n,t){if(Jx.isObject(this._listView))try{this._listView.currentItem={index:n,hasFocus:false}}catch(u){Jx.log.warning("SelectionModel._setSelectionInternal - this._listView.currentItem exception. Keyboard focus may be off as a result.")}var i=Jx.isString(t)?t:r.none;switch(i){case r.scrollToTop:this._listView.indexOfFirstVisible=0;break;case r.ensureVisible:this.ensureVisible(n,true)}};Mail.SelectionModel.prototype.ensureVisible=function(i,r){var u;if(u="SelectionMode.ensureVisible index:="+i+" snapToParent:="+Boolean(r),n(u),r){var s=this._collection.item(i),f=this._collection.getTreeView(),e=f.activeConversation,o=f.activeConversationIndex,h=window.innerHeight/112;e&&s.isDescendant(e.objectId)&&Math.abs(o-i)<h&&(i=o)}this._listView.ensureVisible(i);t(u)}})