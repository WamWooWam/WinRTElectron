Jx.delayDefine(Mail,"ViewIntroductionHeader",function(){"use strict";function e(n,t){var i=parseInt(t.getLocalSettings().container("ViewIntroCounts").get(n),10);return Jx.isValidNumber(i)?i:0}function o(n,t,i){t.getLocalSettings().container("ViewIntroCounts").set(n,i.toString())}function n(n,t,i){this.initEvents();this._viewName=n;this._view=t;this._settings=i;this._disposer=new Mail.Disposer;this._incremented=false;this._show=false;this._update()}function u(t,i){this._eas=null;this._enabledCategories=null;n.call(this,"Inbox",t,i)}function f(t,i){this._account=null;n.call(this,"AllFavorites",t,i)}function s(t,i){switch(t.type){case r.inbox:return new u(t,i);case r.newsletter:return new n("Newsletter",t,i);case r.social:return new n("Social",t,i);case r.allPinnedPeople:return new f(t,i);default:return null}}var i=Microsoft.WindowsLive.Platform,r=i.MailViewType,t;Jx.augment(n,Jx.Events);n.prototype.dispose=function(){Jx.dispose(this._disposer)};n.prototype.shouldShow=function(){return this._show};n.prototype.getText=function(){return Jx.res.getString("mail"+this._viewName+"Intro")};n.prototype.dismiss=function(){this._settings["dismissed"+this._viewName+"Intro"]=true;this._update()};n.prototype._isSupported=function(){return true};n.prototype._isDismissed=function(){return this._settings["dismissed"+this._viewName+"Intro"]||this._settings.isRetailExperience};n.prototype._shouldAutoDismiss=function(){var t=this._settings,n=e(this._viewName,t);return this._incremented||(this._incremented=true,n++,o(this._viewName,t,n)),n>3};n.prototype._update=function(){var n=!this._isDismissed()&&this._isSupported();n&&this._shouldAutoDismiss()&&(n=false,this.dismiss());n!==this._show&&(this._show=n,this.raiseEvent("updated",{shouldShow:n}))};Jx.inherit(u,n);u.prototype._isSupported=function(){var r=n.prototype._isSupported.call(this),t,u;return r&&(t=this._eas,t||(u=this._view.account,u&&(t=this._eas=u.platformObject.getServerByType(i.ServerType.eas),t&&this._disposer.add(new Mail.EventHook(t,"changed",this._update,this)))),r=t&&t.isWlasSupported),r};u.prototype._shouldAutoDismiss=function(){var r=n.prototype._shouldAutoDismiss.call(this),f,t,o,u;return r&&(f=this._settings,r=e("Newsletter",f)>=1&&e("Social",f)>=1),r||(t=this._enabledCategories,t||(o=this._view.account,o&&(u=o.queryViews(i.MailViewScenario.systemCategories),u&&(t=this._enabledCategories=Mail.ViewFilters.filterEnabled(u),t.unlock(),this._disposer.addMany(u,t,new Mail.EventHook(t,"collectionchanged",this._update,this))))),r=t.count<2),r};Jx.inherit(f,n);f.prototype._shouldAutoDismiss=function(){var r=n.prototype._shouldAutoDismiss.call(this),t,u,f;if(!r&&(t=this._account,t||(t=this._account=this._view.account,t&&this._disposer.add(new Mail.EventHook(t,"changed",this._onAccountChanged,this))),t&&t.peopleViewComplete)){for(u=t.queryViews(i.MailViewScenario.allPeople),r=true,f=0;f<u.count;f++)if(u.item(f).isPinnedToNavPane){r=false;break}Jx.dispose(u)}return r};f.prototype._onAccountChanged=function(n){Mail.Validators.hasPropertyChanged(n,"peopleViewComplete")&&this._update()};t=Mail.ViewIntroductionHeader=function(n){this.initComponent();this._settings=n;this._container=null;this._disposer=null;this._view=null;this._intro=null;this._visible=false;this._animationPromise=null};Jx.inherit(t,Jx.Component);t.prototype.getUI=function(n){n.html="<div id='"+this._id+"' class='mailMessageListViewIntro'><div class='descriptionText' role='note'><\/div><div class='buttonContainer'><button class='dismiss' tabIndex='0'>"+Jx.res.getString("mailOkButton")+"<\/button><\/div><\/div>"};t.prototype.setContainer=function(n){this._container=n};t.prototype.onDeactivateUI=function(){Jx.dispose(this._disposer)};t.prototype.waitForAnimation=function(){return Jx.Promise.fork(this._animationPromise)};t.prototype.setView=function(n){var t,i;Jx.dispose(this._disposer);this._disposer=null;this._view=n;t=this._intro=s(n,this._settings);t&&(this._disposer=new Mail.Disposer(t,new Mail.EventHook(t,"updated",this._onUpdate,this)));i=t&&t.shouldShow();i?this._show():this._hide(false)};t.prototype._show=function(){var t=this._disposer,i=this._getElement(),r=i.querySelector(".descriptionText"),n;r.innerHTML=Jx.escapeHtml(this._intro.getText()).replace("%1",function(){return"<span class='settingsLink' role='button' tabIndex='0'>"+Jx.escapeHtml(Jx.res.getString("mailViewIntroSettingsLink"))+"<\/span>"});n=r.querySelector(".settingsLink");n&&t.add(new Jx.Clicker(n,this._onSettingsClick,this));t.add(new Mail.EventHook(i.querySelector(".dismiss"),"click",this._onDismissClick,this));this._visible||(this._container.classList.add("showViewIntro"),this._visible=true)};t.prototype._hide=function(n){var i;if(this._visible)if(this._visible=false,n){var t=this._getElement(),r=Array.prototype.filter.call(this._container.parentElement.children,function(n){return n!==t}),u=WinJS.UI.Animation.createCollapseAnimation(t,r);t.classList.add("collapsing");i=this._animationPromise=u.execute();this._disposer.add(new Mail.Disposable(i,"cancel"));i.done(function(){this._animationPromise=null;t.classList.remove("collapsing");this._container.classList.remove("showViewIntro")}.bind(this))}else this._container.classList.remove("showViewIntro")};t.prototype._onUpdate=function(n){var t=n.shouldShow;t!==this._visible&&(t?this._show():this._hide(true))};t.prototype._getElement=function(){return document.getElementById(this._id)};t.prototype._onSettingsClick=function(n){Mail.AppSettings.openAccountUI(this._view.account.platformObject);n.preventDefault()};t.prototype._onDismissClick=function(){this._intro.dismiss()}})