Jx.delayDefine(Mail.Commands,"FolderOperations",function(){"use strict";function y(n,t,i){var u=t.view,f=t.account,e=u.folder,o=Mail.ViewCapabilities;e&&f.canCreateFolders&&(i.push({id:"MailFolderOperations.NewFolder",label:Jx.res.getString("mailCreateFolder"),onclick:function(){l(n,new r(t.account))}}),o.canHaveChildren(u)&&i.push({id:"MailFolderOperations.NewSubFolder",label:Jx.res.getString("mailCreateSubfolder"),onclick:function(){l(n,new s(t.view))}}))}function p(n,t,i){var r=t.view,f=t.account,e=Mail.ViewCapabilities;e.canRename(r)&&f.canUpdateFolders&&i.push({id:"MailFolderOperations.RenameFolder",label:Jx.res.getString("mailFolderOperationsRenameFolder"),onclick:function(){l(n,new u(t.view.folder))}})}function w(t,i,r){var u=i.view;u.canDeleteSource()&&r.push({id:"MailFolderOperations.DeleteFolder",label:Jx.res.getString("mailFolderOperationsDeleteFolder"),onclick:function(){return n.onDeleteView(i)}})}function b(n,t,i){var r=t.view,f=t.account,u=Mail.ViewCapabilities;u.canPinToStart(r)&&(Mail.Commands.Contexts.showPin(t)?i.push({id:"MailFolderOperations.pinFolder",label:Jx.res.getString("mailCommandPinFolder"),onclick:function(){return Mail.Commands.Handlers.onPinFolder(t,n)}}):i.push({id:"MailFolderOperations.unpinFolder",label:Jx.res.getString("mailCommandUnpinFolder"),onclick:function(){return Mail.Commands.Handlers.onUnpinFolder(t,n)}}))}function k(t,i,r){var u=i.view,l=i.account,f=u.folder,h;if(f){var e=u.getMessages(o.FilterCriteria.unread),s=u.getMessages(o.FilterCriteria.all),c=false;f.specialMailFolderType===v.deletedItems&&(h=f.getChildFolderCollection(),c=h.count>0,h.dispose());(s&&s.count>0||c)&&r.push({id:"MailFolderOperations.EmptyFolder",label:Jx.res.getString("mailFolderOperationsEmptyFolder"),onclick:function(){return n._onEmptyFolder(i)}});e&&e.count>0&&r.push({id:"MailFolderOperations.MarkAsRead",label:Jx.res.getString("mailFolderOperationsMarkAsRead"),onclick:function(){return n._onMarkViewAsRead(i)}});Jx.dispose(e);Jx.dispose(s)}}function l(n,t){if(!document.querySelector(".folderOperation")){var i={anchor:n,singleShow:true};return new Mail.Flyout(document.getElementById(Mail.CompApp.rootElementId),t,i).show()}}function f(n){Jx.mark("Mail.Commands.FolderOperations."+n+",StartTA,Mail")}function e(n){Jx.mark("Mail.Commands.FolderOperations."+n+",StopTA,Mail")}function a(n){Jx.mark("Mail.Commands.FolderOperations:"+n)}var o=Microsoft.WindowsLive.Platform,v=o.MailFolderType,n=Mail.Commands.FolderOperations={},h,c,t,u,r,s,i;n._areAnyFolderOperationsEnabled=function(){var n=Mail.guiState;return!(n.isOnePane&&n.isReadingPaneActive)&&!Mail.SearchHandler.isSearching};n.folderOperationsEnabled=function(t){var i=n._areAnyFolderOperationsEnabled(),r;return i&&(r=n._createCommandList("",t,true),i=r.length>0),i};h=[y,p,w,b];c=[k];n._createCommandList=function(n,t,i){f("_createCommandList");var u=[],o=[],r,s;for(i?a("StopAtOne"):a("FullList"),r=0,s=h.length;(!i||o.length===0)&&r<s;++r)h[r](n,t,o);if(o.length===0||!i)for(r=0,s=c.length;(!i||u.length===0)&&r<s;++r)c[r](n,t,u);return u.length>0&&o.length>0&&u.push({id:"MailFolderOperations.Separator",label:"",type:"separator"}),u=u.concat(o),e("_createCommandList"),u};n.onFolderOptionsButton=function(t,i){Mail.Globals.commandManager.showAppBar().then(function(){n._openFolderOperationsMenu(t,i)})};n._openFolderOperationsMenu=function(t,i){var r,u,o;f("onFolderOptionsButton");r=document.getElementById("mailFolderOperationsFlyout");Jx.isHTMLElement(r)?(u=document.getElementById(Mail.CompApp.rootElementId),u.removeChild(r)):(o=n.createFolderOperationsFlyout(t,i),o.show(t,"top","center"));e("onFolderOptionsButton")};n.createFolderOperationsFlyout=function(t,i){var r,o,u;return f("createFolderOperationsFlyout"),r=document.createElement("div"),r.id="mailFolderOperationsFlyout",Mail.setAttribute(r,"aria-label",Jx.res.getString("mailCommandFolderOperationsLabel")),o=document.getElementById(Mail.CompApp.rootElementId),o.appendChild(r),u=new WinJS.UI.Menu(r,{commands:n._createCommandList(t,i),sticky:true}),u.addEventListener("afterhide",function(){Mail.safeRemoveNode(r,true)},true),e("createFolderOperationsFlyout"),u};n._onEmptyFolder=function(t){var r=Windows.UI.Popups,i=new r.MessageDialog(Jx.res.getString("mailFolderOperationsEmptyFolderConfirmationBody"),Jx.res.getString("mailFolderOperationsEmptyFolderConfirmationTitle"));i.commands.append(new r.UICommand(Jx.res.getString("mailFolderOperationsEmptyFolderConfirm"),function(){n._emptyView(t)}));i.commands.append(new r.UICommand(Jx.res.getString("mailFolderOperationsEmptyFolderCancel"),Jx.fnEmpty));i.defaultCommandIndex=1;i.cancelCommandIndex=1;Mail.showPopupAsync(i)};n._emptyView=function(n){var t,i,r;if(f("_emptyView"),n.emptyView(),t=n.view,t.type===o.MailViewType.deletedItems)for(i=t.folder.getChildFolderCollection(),r=i.count;r--;)i.item(r).deleteObject();e("_emptyView")};n._onMarkViewAsRead=function(n){f("_onMarkViewAsRead");n.markViewRead();e("_onMarkViewAsRead")};n.onDeleteView=function(n){var t=n.view,i;t.canDeleteSource()&&(Mail.Commands.Contexts.showUnpin(n)?(i=n.view.startScreenTileId,t.deleteSource(),Mail.Globals.commandManager.showAppBar().then(function(){Mail.Commands.Handlers.unpinFolder(i)})):t.deleteSource())};t=function(){Mail.FlyoutContent.call(this);this._title="";this._error="";this._root=null;this._input=null;this._disposer=null};Jx.inherit(t,Mail.FlyoutContent);t.prototype.getUI=function(n){var t=Jx.escapeHtml(Jx.res.getString("mailFolderOperationsPlaceholderFolderName"));n.html="<div id='"+this._id+"' class='folderOperation'><div class='title'>"+Jx.escapeHtml(this._title)+"<\/div><input class='name' type='text' MaxLength='128' placeholder='"+t+"'>"+(this._error?"<div class='error'>"+Jx.escapeHtml(this._error)+"<\/div>":"")+"<button class='commit'>"+Jx.escapeHtml(Jx.res.getString("mailOkButton"))+"<\/button><\/div>"};t.prototype.onActivateUI=function(){var n=this._root=document.getElementById(this._id);this._input=n.querySelector(".name");this._disposer=new Mail.Disposer(new Mail.EventHook(n.querySelector(".commit"),"click",this._operate,this),new Mail.EventHook(n,"keypress",this._onKeyPress,this))};t.prototype.onDeactivateUI=function(){Jx.dispose(this._disposer)};t.prototype._onKeyPress=function(n){n.key==="Enter"&&(n.preventDefault(),this._operate())};t.prototype._operate=function(){var n=this._input.value;if(n)try{return this._commit(n)}catch(t){Jx.log.exception("Folder operation failed",t)}this._error=this._error||Jx.res.getString("mailFolderOperationsCreateFolderError");this._flyout.replace(this)};u=function(n){t.call(this);this._folder=n;this._title=Jx.res.getString("mailFolderOperationsRenameFolder")};Jx.inherit(u,t);u.prototype._commit=function(n){var t=this._folder.platformMailFolder;t&&t.canRename&&(t.folderName=n,t.commit());this._flyout.hide()};u.prototype.onActivateUI=function(){t.prototype.onActivateUI.call(this);this._input.value=this._folder.folderName};r=function(n){t.call(this);this._account=n;this._title=Jx.res.getString("mailCreateFolder")};Jx.inherit(r,t);r.prototype._commit=function(n){var t=this._account.createFolder(n);this._flyout.replace(new i(Jx.res.loadCompoundString("mailCreateFolderText",t.folderName)))};s=function(n){r.call(this,n.account);var t=this._parent=n.folder;this._title=Jx.res.loadCompoundString("mailCreateSubfolderTitle",t.folderName)};Jx.inherit(s,r);s.prototype._commit=function(n){var t=this._parent,r=this._account.createFolder(n,t),u=Jx.res.loadCompoundString("mailCreateSubfolderText",r.folderName,t.folderName);this._flyout.replace(new i(u))};i=function(n){Mail.FlyoutContent.call(this);this._text=n;this._hook=null};Jx.inherit(i,Mail.FlyoutContent);i.prototype.getUI=function(n){n.html="<div id='"+this._id+"' class='folderOperation'><div class='blurb'>"+Jx.escapeHtml(this._text)+"<\/div><button class='commit'>"+Jx.escapeHtml(Jx.res.getString("mailOkButton"))+"<\/button><\/div>"};i.prototype.activateUI=function(){this._hook=new Mail.EventHook(document.getElementById(this._id),"click",this._flyout.hide,this._flyout)};i.prototype.deactivateUI=function(){Jx.dispose(this._hook)}})