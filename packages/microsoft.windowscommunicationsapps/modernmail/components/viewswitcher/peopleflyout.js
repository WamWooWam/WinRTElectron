Jx.delayDefine(Mail,"PeopleFlyout",function(){"use strict";function f(n){var u=t.max,i;return n&&(i=n.objectType,u=i==="MailView"?n.type===r.MailViewType.allPinnedPeople?t.allPinnedPeople:n.isPinnedToNavPane?t.pinnedPerson:t.unpinnedPerson:t[i]),u}function l(n,i,r){return n.getSortName(r).localeCompare(i.getSortName(r))}function a(n,i,r){return r?r.indexOf(i.objectId)-r.indexOf(n.objectId):0}function v(n,t,f){switch(f.objectType){case"MailView":return f.type===r.MailViewType.allPinnedPeople?new e(n,f):new i(n,f);case"pinnedHeader":return new u("<div class='header' role='heading'>"+Jx.escapeHtml(Jx.res.getString("mailPeopleFlyoutHeader"))+"<\/div>");case"suggestedHeader":return new u("<div class='header secondary' role='heading'>"+Jx.escapeHtml(Jx.res.getString("mailPeopleFlyoutSuggestionsHeader"))+"<\/div>");case"noPinnedText":return new u("<div class='blurb' role='note'>"+Jx.escapeHtml(Jx.res.getString("mailPeopleFlyoutNoPinnedText"))+"<\/div>");case"picker":return new o(n,t)}}function i(n,t){this.initComponent();this._switcher=n;this._view=t;var i=this._tile=new Mail.BoundElements.ViewTile(t),r=this._name=new Mail.BoundElements.ViewName(t),u=this._count=new Mail.BoundElements.ViewCount(t),f=this._star=new Mail.BoundElements.ViewPinner(t,"mailPinPersonLabel","mailUnpinPersonLabel");this.append(i,r,u,f);this._job=this._augment=null}function e(n,t){this.initComponent();this._switcher=n;this._view=t;var i=this._name=new Mail.BoundElements.ViewName(t),r=this._count=new Mail.BoundElements.ViewCount(t);this.append(i,r)}function u(n){this.initComponent();this._html=n}function o(n,t){this.initComponent();this._switcher=n;this._account=t}function h(n){Jx.mark("Mail.PeopleFlyout."+n+",StartTA,Mail")}function c(n){Jx.mark("Mail.PeopleFlyout."+n+",StopTA,Mail")}var r=Microsoft.WindowsLive.Platform,s=Mail.ViewItems,n=Mail.PeopleFlyout=function(n,t,i){var o,u,s;h("ctor");this.initComponent();this._switcher=n;this._hasPinnedPeople=this._hasSuggestions=false;o=t.platform;this._lastFirst=o.peopleManager.nameSortOrder;this._pinningActivity=null;u=this._views=t.queryViews(r.MailViewScenario.allPeople,"peopleFlyout");s=this._extraItems=[n.getViewCollection().find(function(n){return n.type===r.MailViewType.allPinnedPeople}),{objectId:"pinnedHeader",objectType:"pinnedHeader"},{objectId:"suggestedHeader",objectType:"suggestedHeader"},{objectId:"noPinnedText",objectType:"noPinnedText"},{objectId:"picker",objectType:"picker"}];this._updateCounts();var l=this._extraItemsFilter=new Mail.FilteredCollection(this,new Mail.ArrayCollection(s)),f=this._collection=new Mail.SortedCollection(this,new Mail.ConcatenatedCollection([u,l])),e=this._list=new Jx.List({factory:v.bind(null,n,t),jobSet:i}),a=this._ariaFlows=new Mail.AriaFlows(e);this.appendChild(a);e.setSource(f);e.disableAnimations();f.unlock();this._disposer=new Mail.Disposer(f,u,l,new Mail.EventHook(n,"widthChanged",this._onSwitcherWidthChanged,this),new Mail.EventHook(u,"collectionchanged",this._onViewCollectionChanged,this));this._hooks=null;this._keyboardNavigation=null;c("ctor")},t;Jx.augment(n,Jx.Component);n.prototype.getUI=function(n){n.html="<div id='"+this._id+"' class='peopleFlyout viewFlyout' role='listbox'><div class='inhibitTouchHover'><\/div>"+Jx.getUI(this._ariaFlows).html+"<\/div>"};n.prototype.activateUI=function(){h("activateUI");Jx.Component.prototype.activateUI.call(this);var n=document.getElementById(this._id),t=this._keyboardNavigation=new Jx.KeyboardNavigation(n,"vertical",this);this._hooks=new Mail.Disposer(new Jx.Clicker(n,this._onClick,this),new Mail.EventHook(n,"contextmenu",this._onClick,this),new Mail.EventHook(n,"MSHoldVisual",function(n){n.preventDefault()}),t,new Jx.PressEffect(n,".person, .picker, .content",["className"],".inhibitTouchHover"),new Mail.Disposable(Jx.observeMutation(n,{attributes:true,subtree:true,attributeFilter:["aria-checked"]},this._onAttributeChange,this),"disconnect"));c("activateUI")};n.prototype.deactivateUI=function(){Jx.Component.prototype.deactivateUI.call(this);Jx.dispose(this._hooks)};n.prototype.shutdownComponent=function(){Jx.Component.prototype.shutdownComponent.call(this);Jx.dispose(this._disposer)};n.prototype._onClick=function(n){var t=this._list.getTarget(n);if(t)t.onClick(n)};n.prototype._onAttributeChange=function(n){n.forEach(function(n){var t=this._list.getTarget(n);if(t)t.onAttributeChange(n)},this)};n.prototype.setCallback=Jx.fnEmpty;n.prototype.hook=function(n){n&&n.objectType==="MailView"&&n.addListener("changed",this._onViewChanged,this)};n.prototype.unhook=function(n){n&&n.objectType==="MailView"&&n.removeListener("changed",this._onViewChanged,this)};n.prototype.matches=function(n){var t=false;if(n)switch(n.objectType){case"MailView":t=!this._switcher.isWide&&this._hasPinnedPeople;break;case"pinnedHeader":case"picker":t=true;break;case"suggestedHeader":t=this._hasSuggestions;break;case"noPinnedText":t=!this._hasPinnedPeople}return t};t={pinnedHeader:0,allPinnedPeople:1,noPinnedText:2,pinnedPerson:3,suggestedHeader:4,unpinnedPerson:5,picker:6,max:7};n.prototype.compare=function(n,i){var r=f(n),u=f(i);return r-u||(r===t.pinnedPerson?l(n,i,this._lastFirst):a(n,i,this._pinningActivity))};n.prototype._onViewCollectionChanged=function(){this._updateCounts()&&this._updateExtraItems()};n.prototype._onSwitcherWidthChanged=function(){this._updateExtraItems()};n.prototype._updateCounts=function(){var n=this._hasPinnedPeople,t=this._hasSuggestions;return this._hasPinnedPeople=this._hasSuggestions=false,this._views.forEach(function(n){n.isPinnedToNavPane?this._hasPinnedPeople=true:this._hasSuggestions=true},this),n!==this._hasPinnedPeople||t!==this._hasSuggestions};n.prototype._updateExtraItems=function(){this._extraItems.forEach(function(n){this._extraItemsFilter.update(n)},this)};n.prototype._onViewChanged=function(n){var i=n.target,t,r,u;Mail.Validators.hasPropertyChanged(n,"sortName")&&this._collection.update(i);Mail.Validators.hasPropertyChanged(n,"isPinnedToNavPane")&&(t=this._pinningActivity,t&&(r=i.objectId,u=t.indexOf(r),u!==-1&&t.splice(u,1),t.push(r)),this._collection.update(i),this._updateCounts()&&this._updateExtraItems())};n.prototype.beforeShow=function(){this._pinningActivity=[];this._list.enableAnimations();this._keyboardNavigation.update(true)};n.prototype.afterHide=function(){h("afterHide");this._list.disableAnimations();var n=this._pinningActivity,t=this._collection;if(n&&t)while(n.length>0)t.updateById(n.pop());this._pinningActivity=null;c("afterHide")};n.prototype.waitForAnimation=function(){return this._list.waitForAnimation()};Jx.augment(i,Jx.Component);i.prototype.getUI=function(n){var t=this._view;n.html="<div class='person' id='"+this._id+"'><div class='content' tabIndex='-1' aria-label='"+Jx.escapeHtml(s.getLabel(t))+"' title='"+Jx.escapeHtml(t.name)+"' role='option'>"+Jx.getUI(this._tile).html+Jx.getUI(this._name).html+Jx.getUI(this._count).html+"<\/div>"+Jx.getUI(this._star).html+"<\/div>"};i.prototype.activateUI=function(){Jx.Component.prototype.activateUI.call(this);this._job=Jx.scheduler.addJob(null,Mail.Priority.galLookup,null,this._galLookup,this)};i.prototype.deactivateUI=function(){Jx.Component.prototype.deactivateUI.call(this);Jx.dispose(this._job)};i.prototype.onClick=function(n){this._star.onClick(n)||this._switcher.selectView(this._view)};i.prototype.onAttributeChange=function(n){this._star.onAttributeChange(n)};i.prototype.updateLabel=function(){var n=document.querySelector("#"+this._id+" .content"),t=this._view;Mail.setAttribute(n,"aria-label",s.getLabel(t));Mail.setAttribute(n,"title",t.name)};i.prototype._galLookup=function(){var n=this._view.sourceObject;if(n)try{this._augment=n.augmentViaServerAsync(false).done(Jx.fnEmpty,Jx.fnEmpty)}catch(t){Jx.log.exception("Error in GAL augmentation",t)}};Jx.augment(e,Jx.Component);e.prototype.getUI=function(n){n.html="<div id='"+this._id+"' class='person favorites'><div class='content' tabIndex='-1' aria-label='"+Jx.escapeHtml(s.getLabel(this._view))+"' title='"+Jx.escapeHtml(this._view.name)+"' role='option'><div class='tile'><\/div>"+Jx.getUI(this._name).html+Jx.getUI(this._count).html+"<\/div><\/div>"};e.prototype.onClick=function(){this._switcher.selectView(this._view)};e.prototype.onAttributeChange=Jx.fnEmpty;e.prototype.updateLabel=function(){Mail.setAttribute(document.querySelector("#"+this._id+" .content"),"aria-label",s.getLabel(this._view))};Jx.augment(u,Jx.Component);u.prototype.getUI=function(n){n.html=this._html};u.prototype.onClick=Jx.fnEmpty;u.prototype.onAttributeChange=Jx.fnEmpty;Jx.augment(o,Jx.Component);o.prototype.getUI=function(n){n.html="<div class='picker' tabIndex='-1' role='button' title='"+Jx.escapeHtml(Jx.res.getString("mailPeopleFlyoutPicker"))+"'><div class='plus'><\/div><div class='text'>"+Jx.escapeHtml(Jx.res.getString("mailPeopleFlyoutPicker"))+"<\/div><\/div>"};o.prototype.onClick=function(){Mail.PeopleFlyout.pickPeople(this._account)};o.prototype.onAttributeChange=Jx.fnEmpty;Mail.PeopleFlyout.pickPeople=function(n){var i=Windows.ApplicationModel.Contacts,t=new i.ContactPicker;t.commitButtonText=Jx.res.getString("mailPeopleFlyoutPickerCommit");t.selectionMode=i.ContactSelectionMode.contacts;t.desiredFieldsWithContactFieldType.append(i.ContactFieldType.email);t.pickContactsAsync().then(function(t){t&&t.forEach(function(t){var u=t.id,i;if(u)try{i=n.queryView(r.MailViewType.person,u);i&&i.pinToNavPane(true)}catch(f){Jx.log.exception("Error creating and pinning view",f)}},this)}).done(Jx.fnEmpty,Jx.fnEmpty)}})