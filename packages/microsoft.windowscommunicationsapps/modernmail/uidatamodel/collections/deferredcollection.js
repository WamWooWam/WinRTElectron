Jx.delayDefine(Mail,["DeferredCollection","MappedDeferredCollection"],function(){"use strict";function e(n){Jx.mark("DeferredCollection."+n+",StartTA,DeferredCollection")}function o(n){Jx.mark("DeferredCollection."+n+",StopTA,DeferredCollection")}var s=Microsoft.WindowsLive.Platform,n=s.CollectionChangeType,i=Mail.DeferredCollection=function(n,t){this._realCollection=new People.PlatformCollectionWatcher(n,new People.Callback(this._collectionChanged,this));this._pendingChanges=[];this._length=n.count;this._listener=t;n.unlock()},t,r,f,u;Jx.inherit(i,Mail.Collection);t=i.prototype;Object.defineProperty(t,"count",{get:function(){return this._length}});i.updateIndex=function(n,t){return Mail.DeferredCollection.updateIndexEx(n,t).index};i.updateIndexEx=function(t,i){for(var r,u=0,f=t.length;u<f;u++){r=t[u];switch(r.eType){case n.reset:return{removedObjectId:"",index:Mail.DeferredCollection.removed};case n.itemRemoved:if(r.index===i)return{removedObjectId:r.objectId,index:Mail.DeferredCollection.removed};r.index<i&&i--;break;case n.itemAdded:r.index<=i&&i++;break;case n.itemChanged:r.previousIndex===i?i=r.index:(r.previousIndex<i&&i--,r.index<=i&&i++)}}return{removedObjectId:"",index:i}};t.item=function(n){var t=Mail.DeferredCollection.updateIndexEx(this._pendingChanges,n);return t.index===Mail.DeferredCollection.removed?{objectId:t.removedObjectId,pendingRemoval:true}:this._realCollection.item(t.index)};r={};r[n.itemAdded]=1;r[n.itemRemoved]=-1;r[n.itemChanged]=0;t.acceptPendingChanges=function(){var n,t;for(n="acceptPendingChanges numChanges:="+this._pendingChanges.length,e(n);this.hasPendingChanges;)t=this._getFirstPendingChange(),this.raiseEvent("collectionchanged",t);o(n)};t._getFirstPendingChange=function(){var t=this._pendingChanges.shift(),i;return t.eType===n.reset?this._length=this._realCollection.getCount():(i=r[t.eType],this._length+=i),t};t.dispose=function(){this._realCollection.dispose()};t._reportReset=function(n){return(this._pendingChanges=[n],Jx.isFunction(this._listener.onResetPending))?(e("_reportReset"),this._listener.onResetPending(),o("_reportReset"),true):false};t._collectionChanged=function(t,i){var r=i.eType===n.reset,u=this._pendingChanges.length===0||r;if(!this._isReset()&&(!r||!this._reportReset(i))){switch(i.eType){case n.itemRemoved:case n.itemAdded:case n.itemChanged:this._pendingChanges.push(i)}if(u)this._listener.onChangesPending(t,this)}};t._isReset=function(){return this._pendingChanges.length===1&&this._pendingChanges[0].eType===n.reset};Object.defineProperty(t,"hasPendingChanges",{get:function(){return this._pendingChanges.length!==0}});Object.defineProperty(t,"pendingChangesCount",{get:function(){return this._pendingChanges.length}});i.removed=-1;f=Mail.MappedDeferredCollection=function(n,t,i,r,u){Mail.MappedCollection.call(this,new Mail.DeferredCollection(n,t),i,r,u)};Jx.inherit(f,Mail.MappedCollection);u=f.prototype;u.acceptPendingChanges=function(){this._collection.acceptPendingChanges()};Object.defineProperty(u,"hasPendingChanges",{get:function(){return this._collection.hasPendingChanges},enumerable:true});Object.defineProperty(u,"pendingChangesCount",{get:function(){return this._collection.pendingChangesCount},enumerable:true})})