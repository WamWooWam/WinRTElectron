Jx.delayDefine(Mail.Utilities,"ComposeHelper",function(){"use strict";function o(n,t,i){var f=Mail.Globals.platform,e=f.mailManager.ensureMailView(Microsoft.WindowsLive.Platform.MailViewType.inbox,n.objectId,""),o=Compose.MessageReturner.instance(f.mailManager.createDraftMessage(e)),u=Compose.MailMessageModel.instance({initAction:Compose.ComposeAction.createNew,messageCreator:o}),r={};return["to","cc","bcc","subject"].filter(function(n){return Jx.isNonEmptyString(t[n])}).forEach(function(n){r[n]=t[n]}),Jx.isNonEmptyString(i)&&(r.to=Boolean(r.to)?i+","+r.to:i),u.set(r),Jx.isNonEmptyString(t.body)?u.setBodyContents([{content:t.body,format:ModernCanvas.ContentFormat.text,location:ModernCanvas.ContentLocation.end}]):u.setBodyContents([{signatureLocation:ModernCanvas.SignatureLocation.start}]),u}var n=Mail.Utilities,t=Mail.Instrumentation,r=Microsoft.WindowsLive.Platform.AttachmentSyncStatus,i;n.ComposeHelper={};n.ComposeHelper._builder=null;n.ComposeHelper._compose=null;n.ComposeHelper.currentSelectedFilter=null;n.ComposeHelper._selection=null;n.ComposeHelper.ensureComposeFiles=function(){n.ComposeHelper.ensureComposeFiles=Jx.fnEmpty;Jx.delayGroupExec("MailCompose");Compose.platform=Mail.Globals.platform};n.ComposeHelper.ensureComposeObject=function(){var u=Mail.Globals.platform,t=Microsoft.WindowsLive.Platform,f=u.accountManager.getConnectedAccountsByScenario(t.ApplicationScenario.mail,t.ConnectedFilter.normal,t.AccountSort.rank),i=false,r;return f.count>0&&(n.ComposeHelper._builder=Mail.composeBuilder,r=n.ComposeHelper._buildEmpty(),n.ComposeHelper._compose=r,n.ComposeHelper.ensureComposeObject=function(){return true},i=true),i};n.ComposeHelper.ensureComposeHTML=function(t){if(n.ComposeHelper._compose)n.ComposeHelper.ensureComposeHTML=Jx.fnEmpty,n.ComposeHelper._builder.ensureFullscreenInDOM(n.ComposeHelper._compose),n.ComposeHelper._compose=null;else if(Jx.log.warning("Skipping ensureComposeHTML because there is no compose object."),t)throw new Error("Utilities.ComposeHelper.ensureComposeHTML failed because there was no Compose object to use.")};n.ComposeHelper._parseQueryParams=function(t){var i,u,e,r,f,o;if(i=t.query,u={},i.length>0)for(i=i.substr(1),e=i.split("&"),o=e.length;o--;)r=e[o],f=r.indexOf("="),f>-1?u[r.substr(0,f).toLowerCase()]=n.ComposeHelper.decodeURIComponent(r.substr(f+1)):u[r.toLowerCase()]=true;return u};n.ComposeHelper.decodeURIComponent=function(n){try{return decodeURIComponent(n)}catch(t){return Jx.log.exception("decodeURIComponent failed",t),null}};n.ComposeHelper.onProtocol=function(t){Mail.log("Mail_MailTo_Command",Mail.LogEvent.start);var r=n.ComposeHelper._selection.account.platformObject,i=n.ComposeHelper._parseQueryParams(t.uri);t.uri.schemeName==="mailto"?n.ComposeHelper._mailToHandler(t.uri,i,r):i.action==="calendar"&&n.ComposeHelper._calendarProtocolHandler(i);Mail.log("Mail_MailTo_Command",Mail.LogEvent.stop)};n.ComposeHelper._mailToHandler=function(t,r,u){n.ComposeHelper.ensureComposeFiles();n.ComposeHelper.launchCompose(Compose.ComposeAction.createNew,i({messageModel:o(u,r,Jx.isNullOrUndefined(t.path)?null:n.ComposeHelper.decodeURIComponent(t.path))}),{startDirty:true,moveToInbox:true,suppressPerfTrack:true})};n.ComposeHelper._calendarProtocolHandler=function(t){var u,f,i,r,e,o;Mail.writeProfilerMark("ComposeHelper.calendarProtocolHandler",Mail.LogEvent.start);u=t.eventhandle;f=Mail.Globals.platform;try{i=f.calendarManager.getEventFromHandle(u)}catch(s){Jx.log.exception("Unable to load event",s);i=null}i&&(n.ComposeHelper.ensureComposeFiles(),r=t.calendaraction,Compose.util.isValidCalendarAction(r)?(e=Compose.util.convertToComposeAction(r),o={factorySpec:{originalEvent:i,calendarAction:r}},n.ComposeHelper.launchCompose(e,o,{startDirty:true,moveToDrafts:true,suppressPerfTrack:true})):Jx.log.info("Invalid calendar action, not proceeding with compose launch"));Mail.writeProfilerMark("ComposeHelper.calendarProtocolHandler",Mail.LogEvent.stop)};n.ComposeHelper.registerSelection=function(t){n.ComposeHelper._selection=t};var u=0,f=false,e=function(){return u>0};Object.defineProperty(n.ComposeHelper,"isComposeShowing",{get:function(){return e()}});Object.defineProperty(n.ComposeHelper,"isComposeLaunching",{get:function(){return f},set:function(n){f=n}});n.ComposeHelper.setComposeShowing=function(n){var t=u+(n?1:-1),i=t>0,r=e()!==i;u=t;r&&Jx.EventManager.fire(null,"composeVisibilityChanged")};n.ComposeHelper._buildEmpty=function(){return n.ComposeHelper._emptyCompose||(n.ComposeHelper._emptyCompose=n.ComposeHelper._builder.createBackgroundCompose()),n.ComposeHelper._emptyCompose};n.ComposeHelper.addRestartCheck=function(){Mail.Globals.appState.addRestartCheck("Compose is showing",function(){return!n.ComposeHelper.isComposeShowing});n.ComposeHelper.addRestartCheck=Jx.fnEmpty};n.ComposeHelper.launchCompose=function(t,i,r){Mail.writeProfilerMark("ComposeHelper.launchCompose",Mail.LogEvent.start);var u=function(){var u;if(i=i||{},i.factorySpec=i.factorySpec||{},i.factorySpec.initAction=t,r=r||{},u=n.ComposeHelper,u.isComposeLaunching=true,u.ensureComposeFiles(),u.addRestartCheck(),u.ensureComposeObject()){u.ensureComposeHTML(true);document.getElementById("idCompCompose").classList.remove("invisible");var e=t!==Compose.ComposeAction.openDraft,f=this._builder.createFullScreenCompose(i),o=this._builder.showCompose(i,r.suppressPerfTrack);o.done(function(){var t,i;u.isComposeLaunching=false;f.setDirtyState(Boolean(r.startDirty));e&&(t=f.getMailMessageModel(),t.commit(),i=t.get("objectId"),Jx.scheduler.addJob(null,Mail.Priority.composeSelectionUpdateNav,"ComposeHelper - update selected item in message list to newly created draft",function(){var s,e,u,c,h;if(t===f.getMailMessageModel()&&(s=n.ComposeHelper._selection,e=s.view,Mail.ViewCapabilities.canHaveDrafts(e)||(r.moveToDrafts=true),u=s.account,c=t.get("accountId"),c!==u.objectId&&(u=Mail.Account.load(c,u.platform)),u)){h=false;r.moveToDrafts&&e!==u.draftsView?(e=u.draftsView,h=true):r.moveToInbox&&e!==u.inboxView&&(e=u.inboxView,h=true);var o=t.getPlatformMessage(),l=new Mail.UIDataModel.MailMessage(o,u),a=function(){s.updateNav(u,e,l);s.updateMessages(l,-1,[l])},v=Mail.SearchHandler&&Mail.SearchHandler.isSearching;(h||v)&&(o.displayViewIdString===""||o.parentConversationId==="")?Mail.Promises.waitForEvent(o,"changed",function(){return o.displayViewIdString!==""&&o.parentConversationId!==""}).done(a):a();Mail.Globals.animator&&Mail.Globals.animator.animateNavigateForward(Jx.fnEmpty,true);Jx.glomManager.getIsChild()&&Jx.glomManager.changeGlomId(i)}}))}.bind(this));Mail.writeProfilerMark("ComposeHelper.launchCompose",Mail.LogEvent.stop)}}.bind(this);n.ComposeHelper.isComposeShowing&&n.ComposeHelper.hideCurrent();u()};n.ComposeHelper.save=function(t,i){var r,u;Jx.isNullOrUndefined(t)&&(t=false);r=n.ComposeHelper;r.ensureComposeObject()&&(u=r._builder.getCurrent(),Boolean(u)&&u.save(t,i))};n.ComposeHelper.hideCurrent=function(){return n.ComposeHelper.save(false,true)};i=function(n){n.factorySpec=n.factorySpec||{};var t=Mail.Globals.appState.selectedAccount;return n.factorySpec.accountId=t.objectId,n};n.ComposeHelper.onEdit=function(t,r){var e;Mail.log("CommandBar_onEdit",Mail.LogEvent.start);n.ComposeHelper.ensureComposeFiles();var o=Mail.composeBuilder,u=o.getCurrent(),f=null;u&&(f=u.getMailMessageModel().getPlatformMessage());Boolean(u)&&(!Boolean(u.getMailMessageModel())||Mail.Validators.areEqual(t,f))&&t.instanceNumber===f.instanceNumber?(document.getElementById("idCompCompose").classList.remove("invisible"),Mail.Utilities.ComposeHelper.isComposeShowing||(e=u.getComponentCache().getComponent("Compose.Selection"),e.isActivated()||e.composeActivateUI(),Mail.Utilities.ComposeHelper.setComposeShowing(true))):t.isDraft&&(Mail.Globals.appSettings.autoMarkAsRead&&t.canMarkRead&&!t.read&&!document.msHidden&&n.ComposeHelper._selection.setReadState(true,[t]),n.ComposeHelper.launchCompose(Compose.ComposeAction.openDraft,i({factorySpec:{messageCreator:Compose.MessageLoader.instance(t.objectId),moveFocus:!!r}}),{startDirty:true}));Mail.log("CommandBar_onEdit",Mail.LogEvent.stop)};n.ComposeHelper.onNewButton=function(r){var e,u,f,o;Mail.log("CommandBar_onNewButton",Mail.LogEvent.start);Jx.ptStart("Compose-NewMail");n.ComposeHelper.ensureComposeFiles();e=Mail.Utilities.ComposeHelper._builder;u=null;e&&(u=e.getCurrent());f=false;n.ComposeHelper.isComposeShowing&&(!u.getMailMessageModel().isNew()||u.isDirty())&&(f=true);o=Microsoft.WindowsLive.Platform.MailMessageLastVerb;!n.ComposeHelper.isComposeShowing||n.ComposeHelper.isComposeShowing&&u.getMailMessageModel().get("sourceVerb")!==o.unknown||f?(n.ComposeHelper.launchCompose(Compose.ComposeAction.createNew,i({})),t.instrumentTriageCommand(t.Commands.new,r,n.ComposeHelper._selection)):f||Mail.Globals.animator&&Mail.Globals.animator.animateNavigateForward(Jx.fnEmpty,true);Mail.log("CommandBar_onNewButton",Mail.LogEvent.stop)};n.ComposeHelper.onReplyButton=function(r,u){Mail.log("CommandBar_onReplyButton",Mail.LogEvent.start);Jx.ptStart("Compose-Reply");var f=r.message;n.ComposeHelper.launchReplyAsync(function(){f.recordAction(Microsoft.WindowsLive.Platform.FolderAction.messageAction);n.ComposeHelper.ensureComposeFiles();n.ComposeHelper.launchCompose(Compose.ComposeAction.reply,i({factorySpec:{messageCreator:Compose.MessageReturner.instance(f.platformMailMessage)}}));t.instrumentTriageCommand(t.Commands.reply,u,n.ComposeHelper._selection)},f);Mail.log("CommandBar_onReplyButton",Mail.LogEvent.stop)};n.ComposeHelper.onReplyAllButton=function(r,u){Mail.log("CommandBar_onReplyAllButton",Mail.LogEvent.start);Jx.ptStart("Compose-ReplyAll");var f=r.message;n.ComposeHelper.launchReplyAsync(function(){f.recordAction(Microsoft.WindowsLive.Platform.FolderAction.messageAction);n.ComposeHelper.ensureComposeFiles();n.ComposeHelper.launchCompose(Compose.ComposeAction.replyAll,i({factorySpec:{messageCreator:Compose.MessageReturner.instance(f.platformMailMessage)}}));t.instrumentTriageCommand(t.Commands.replyAll,u,n.ComposeHelper._selection)},f);Mail.log("CommandBar_onReplyAllButton",Mail.LogEvent.stop)};n.ComposeHelper.launchReplyAsync=function(t,i){if(i.isComposeBodyTruncated||i.hasAttachments){var r=i.getEmbeddedAttachmentCollection();n.ComposeHelper.launchAsync(t,i,r)}else t()};n.ComposeHelper.onForwardButton=function(r,u){Mail.log("CommandBar_onForwardButton",Mail.LogEvent.start);Jx.ptStart("Compose-Forward");var f=r.message;n.ComposeHelper.launchForwardAsync(function(){f.recordAction(Microsoft.WindowsLive.Platform.FolderAction.messageAction);n.ComposeHelper.ensureComposeFiles();n.ComposeHelper.launchCompose(Compose.ComposeAction.forward,i({factorySpec:{messageCreator:Compose.MessageReturner.instance(f.platformMailMessage)}}));t.instrumentTriageCommand(t.Commands.forward,u,n.ComposeHelper._selection)},f);Mail.log("CommandBar_onForwardButton",Mail.LogEvent.stop)};n.ComposeHelper.launchForwardAsync=function(t,i){if(i.isComposeBodyTruncated||i.hasAttachments){var r=i.getEmbeddedAttachmentCollection(),u=i.getOrdinaryAttachmentCollection();n.ComposeHelper.launchAsync(t,i,r,u)}else t()};n.ComposeHelper.launchAsync=function(t,i,r,u){var c=n.ComposeHelper.containsNotDownloadedAttachments,f,l,a;if(!i.isJunk&&(i.isComposeBodyTruncated||c(r)||c(u))){f=document.querySelector(".mailReadingPaneFinishDownloadingFlyout");f||(l=document.getElementById(Mail.CompApp.rootElementId),f=document.createElement("div"),f.className="mailReadingPaneFinishDownloadingFlyout",f.innerHTML="<div><div class='mailReadingPaneFinishDownloadingPrompt typeSizeNormal' data-win-res='innerText:mailReadingPaneFinishDownloadingPrompt'><\/div><div class='mailReadingPaneFinishDownloadingFlyoutButtons'><button class='mailReadingPaneFlyoutDefaultFocusButton mailReadingPaneContinueWithoutDownloadingButton' data-win-res='innerText:mailReadingPaneContinueWithoutDownloading' role='button' tabindex='0' type='button'><\/button><button class='mailReadingPaneFinishDownloadingButton' data-win-res='innerText:mailReadingPaneFinishDownloading' role='button' tabindex='0' type='button'><\/button><\/div><\/div>",Jx.res.processAll(f),l.appendChild(f),a=document.querySelector(".mailReadingPaneRespondButton"),new WinJS.UI.Flyout(f,{anchor:a}));var o=f.querySelector(".mailReadingPaneContinueWithoutDownloadingButton"),s=f.querySelector(".mailReadingPaneFinishDownloadingButton"),e=f.winControl,v=function(){h();e.hide();t()},y=function(){e.hide();n.ComposeHelper.finishDownloading(i,r,u)},p=function(n){var t=document.activeElement;n.key==="Enter"&&t!==o&&t!==s&&(n.preventDefault(),f.querySelector(".mailReadingPaneFlyoutDefaultFocusButton").click())},h=function(){o.removeEventListener("click",v,false);s.removeEventListener("click",y,false);f.removeEventListener("keydown",p,false);e.removeEventListener("afterhide",h,false)};o.addEventListener("click",v,false);s.addEventListener("click",y,false);f.addEventListener("keydown",p,false);e.addEventListener("afterhide",h,false);e.show()}else t()};n.ComposeHelper.containsNotDownloadedAttachments=function(n){var t,i,u;if(n)for(t=0,i=n.count;t<i;t++)if(u=n.item(t),u.syncStatus!==r.done)return true;return false};n.ComposeHelper.finishDownloading=function(t,i,r){t.isComposeBodyTruncated&&t.downloadFullBody();var u=n.ComposeHelper.startAttachmentDownloads;u(i);u(r)};n.ComposeHelper.startAttachmentDownloads=function(n){var t,u,i;if(n)for(t=0,u=n.count;t<u;t++)i=n.item(t),(i.syncStatus===r.notStarted||i.syncStatus===r.failed)&&i.downloadBody()};n.ComposeHelper.createAutoReplaceManager=function(){return this._ensureAutoReplaceManagerTables(),new ModernCanvas.AutoReplaceManager("mail",n.ComposeHelper._autoReplaceManagerTables)};n.ComposeHelper._autoReplaceManagerTables=null;n.ComposeHelper._ensureAutoReplaceManagerTables=function(){n.ComposeHelper._autoReplaceManagerTables=ModernCanvas.AutoReplaceManagerTables.instance();n.ComposeHelper._ensureAutoReplaceManagerTables=Jx.fnEmpty};n.ComposeHelper.setDirty=function(){var n=this._builder.getCurrent();n&&n.setDirtyState(true)};n.ComposeHelper.handleHomeButton=function(){var t=n.ComposeHelper;t.setDirty();t.save();t.composeComplete()};n.ComposeHelper.setGlomManager=function(t){n.ComposeHelper._glomManager=t};n.ComposeHelper.composeComplete=function(){var t=n.ComposeHelper._glomManager;t&&t.composeComplete()};n.ComposeHelper.updateWindowTitleWithMessage=function(t){var i=n.ComposeHelper._glomManager,r;i&&(r=Mail.Account.load(t.accountId,Compose.platform),i.updateWindowTitleWithMessage(new Mail.UIDataModel.MailMessage(t,r)))}})