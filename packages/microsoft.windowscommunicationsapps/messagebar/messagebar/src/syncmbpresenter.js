Jx.delayDefine(Chat,"SyncMessageBarPresenter",function(){"use strict";function i(n){Jx.mark("SyncMessageBarPresenter."+n)}function u(n){Jx.mark("SyncMessageBarPresenter."+n+",StartTA,Shared")}function f(n){Jx.mark("SyncMessageBarPresenter."+n+",StopTA,Shared")}var t=Microsoft.WindowsLive.Platform,r=Chat.MessageBar.Priority,n,e;Chat.SyncMessageBarPresenter=function(){};n=Chat.SyncMessageBarPresenter.prototype;n._initialized=false;n._mb=null;n._platform=null;n._className=null;n._resourceType=null;n._accounts=null;n._resources={};n._moreDetailsFlyout=null;n._checkedNetworkConnection=false;n._hasNetworkConnection=false;n._errorDisabled=false;n._appScenario=null;n._syncing={};n._sending={};n._syncingOrSending={count:0,previousCount:0};n._SYNC_MESSAGE_ID="easSync";n._SYNC_ALL_MESSSAGE_ID="syncAll";n._STATUS_MESSAGE_PREFIX="statusEasResource-";n._ERROR_MESSAGE_PREFIX="errorEasResource-";n._SYNC_MESSAGE_PREFIX="sync";n._SEND_MESSAGE_PREFIX="send";n._syncStatusShownTime=0;n._syncStatusDisabled=false;n._clearSyncStatusTimer=-1;n._errorDuration=null;n._online=true;n._policyEnforcementAttempted={};n.init=function(n,i,r,e,o){var s,c,h;for(u("init"),this._mb=n,this._platform=i,this._className=e,this._appScenario=r,this._isRetail=Jx.appData.localSettings().get("RetailExperience")||false,this._syncStatusDisabled&&this._mb.disableMessage(this._SYNC_MESSAGE_ID),Windows.Networking.Connectivity.NetworkInformation.addEventListener("networkstatuschanged",this._onNetworkStatusChanged.bind(this)),o=o||{},this._checkIsSyncingAll=Boolean(o.checkIsSyncingAll),this._showCredError=Jx.isBoolean(o.showCredError)?o.showCredError:true,this._showFolderSyncError=Boolean(o.showFolderSyncError),r===t.ApplicationScenario.mail?this._resourceType=t.ResourceType.mail:r===t.ApplicationScenario.calendar?this._resourceType=t.ResourceType.calendar:r===t.ApplicationScenario.people&&(this._resourceType=t.ResourceType.contacts),this._resourceChanged=this._resourceChanged.bind(this),this._collectionChanged=this._collectionChanged.bind(this),this._accounts=i.accountManager.getConnectedAccountsByScenario(r,t.ConnectedFilter.normal,t.AccountSort.name),this._accounts.addEventListener("collectionchanged",this._collectionChanged),s=0;s<this._accounts.count;s++)c=this._accounts.item(s),this._addResource(c);this._accounts.unlock();h=i.accountManager.defaultAccount;r===t.ApplicationScenario.mail&&h.mailScenarioState===t.ScenarioState.unknown&&this._addResource(h);this._initialized=true;f("init")};n._getErrorDuration=function(){var n=this._errorDuration;return n===null&&(n=this._errorDuration=(new Windows.UI.ViewManagement.UISettings).messageDuration*1e3),n};n._getMessageDuration=function(){return this._getErrorDuration()/2};n.disableSyncStatus=function(){this._syncStatusDisabled=true;this._mb&&this._mb.disableMessage(this._SYNC_MESSAGE_ID)};n.unDisableSyncStatus=function(n){var t=this._syncStatusDisabled;this._syncStatusDisabled=false;n&&(this._syncStatusEnabledOneTime=true);this._mb&&(this._mb.unDisableMessage(this._SYNC_MESSAGE_ID),!this._isRetail&&t&&(this._syncingOrSending.previousCount=0,this._updateSyncStatus()))};n.disableCredentialMissingErrorMessage=function(){this._errorDisabled=true};n.shutdown=function(){var n,t;u("shutdown");for(n in this._resources)t=this._resources[n].resource,this._removeResource(t);this._accounts&&(this._accounts.removeEventListener("collectionchanged",this._collectionChanged),this._accounts.dispose());f("shutdown")};n.setClassName=function(n){var t,i;this._className=n;for(t in this._resources)i=this._resources[t],this._updateSync(i.resource)};n._collectionChanged=function(n){var i=n.detail[0],f=t.CollectionChangeType,e=null,r,o,u;if(i.eType===f.itemAdded)e=this._accounts.item(i.index),this._addResource(e);else if(i.eType===f.itemRemoved){r=null;for(o in this._resources)if(u=this._resources[o],u.account.objectId===i.objectId){r=u.resource;break}r!==null&&this._removeResource(r)}};n._addResource=function(n){var i=n.getResourceByType(this._resourceType);!i||i.objectId in this._resources||(this._resources[i.objectId]={resource:i,account:n},i.addEventListener("changed",this._resourceChanged),this._initialized&&this.unDisableSyncStatus(this._syncStatusDisabled),this._updateSync(i))};n._removeResource=function(n){n.removeEventListener("changed",this._resourceChanged);this._mb.removeMessage(this._getErrorMessageId(n,false));this._mb.removeMessage(this._getErrorMessageId(n,true));this._updateSync(n,true);delete this._resources[n.objectId]};n._resourceChanged=function(n){var t=n.target;this._updateSync(t)};n._updateSync=function(n,u){var f=n.objectId,e,o;if(this._syncingOrSending.previousCount=this._syncingOrSending.count,(n.isSynchronizing||n.isSyncNeeded||!n.isInitialSyncFinished)&&!u?this._syncing[f]||(i("Starting sync for "+f),this._syncing[f]=true):this._syncing[f]&&(i("Ending sync for "+f),this._syncing[f]=false,u||this._checkErrorState(n,true,false)),n.isSendingMail&&!u?this._sending[f]||(i("Starting send mail for "+f),this._sending[f]=true):this._sending[f]&&(i("Ending send mail for "+f),this._sending[f]=false,u||this._checkErrorState(n,true,true)),(n.isSynchronizing||n.isSendingMail||n.isSyncNeeded||!n.isInitialSyncFinished)&&!u?this._syncingOrSending[f]||(this._syncingOrSending[f]=true,this._syncingOrSending.count++):this._syncingOrSending[f]&&(this._syncingOrSending[f]=false,this._syncingOrSending.count--),i("syncingOrSending count: "+this._syncingOrSending.count),!this._isRetail&&this._checkIsSyncingAll)if(e=this._getSyncAllMessageId(n),n.isSyncingAllMail&&!u&&this._isConnectedToInternet()){o=n.syncWindowSize;var h=o===t.SyncWindowSize.all?"/messagebar/messageBarSyncingAll":"/messagebar/messageBarSyncingOneMonth",s=Jx.res.loadCompoundString(h,this._getAccountFromResource(n).displayName),c={messageText:s,tooltip:s,cssClass:this._className};this._mb.addStatusMessage(e,r.medium,c)}else this._mb.removeMessage(e);this._isRetail||this._updateSyncStatus()};n._getSyncAllMessageId=function(n){return this._SYNC_ALL_MESSSAGE_ID+n.objectId};n._updateSyncStatus=function(){var n,u,t,f,i;this._syncingOrSending.count>0&&this._syncingOrSending.previousCount===0?this._syncStatusDisabled||(n=null,u=this._online=this._isConnectedToInternet(),n=u?"/messagebar/messageBarSyncing":"/messagebar/messageBarOffline",t=Jx.res.getString(n),f={messageText:t,tooltip:t,cssClass:this._className},this._mb.addStatusMessage(this._SYNC_MESSAGE_ID,r.low,f),this._syncStatusEnabledOneTime&&(this._syncStatusDisabled=true,this._syncStatusEnabledOneTime=false),this._syncStatusShownTime=Date.now(),Jx.dispose(this._clearSyncStatusTimer),this._clearSyncStatusTimer=null):this._syncingOrSending.previousCount>0&&this._syncingOrSending.count===0&&(Jx.dispose(this._clearSyncStatusTimer),this._clearSyncStatusTimer=null,i=this._getMessageDuration()-(Date.now()-this._syncStatusShownTime),i>11?this._clearSyncStatusTimer=new Jx.Timer(i,this._showUpToDate,this):this._showUpToDate())};n._showUpToDate=function(){if(this._syncStatusShownTime=0,Jx.dispose(this._clearSyncStatusTimer),this._clearSyncStatusTimer=null,this._mb.removeMessage(this._SYNC_MESSAGE_ID),!this._online){this._clearMessage();return}var n=Jx.res.getString("/messagebar/messageBarUpToDate"),t={messageText:n,tooltip:n,cssClass:this._className};this._mb.addStatusMessage(this._SYNC_MESSAGE_ID,r.low,t);this._clearSyncStatusTimer=new Jx.Timer(this._getMessageDuration(),this._clearMessage,this)};n._clearMessage=function(){Jx.dispose(this._clearSyncStatusTimer);this._clearSyncStatusTimer=null;this._mb.removeMessage(this._SYNC_MESSAGE_ID);this._syncStatusDisabled&&this.disableSyncStatus()};e=Windows.Networking.Connectivity.NetworkConnectivityLevel.internetAccess;n._onNetworkStatusChanged=function(){this._checkedNetworkConnection=false;this._isRetail||this._updateSyncStatus()};n._isConnectedToInternet=function(){var n,t,i;if(u("_isConnectedToInternet"),!this._checkedNetworkConnection){u("_isConnectedToInternet:check");n=Windows.Networking.Connectivity;t=n.NetworkConnectivityLevel.none;try{i=n.NetworkInformation.getInternetConnectionProfile();i&&(t=i.getNetworkConnectivityLevel())}catch(r){Jx.log.exception("Exception from Connectivity.NetworkInformation",r)}this._hasNetworkConnection=t>=e;this._checkedNetworkConnection=true;f("_isConnectedToInternet:check")}return f("_isConnectedToInternet"),this._hasNetworkConnection};n._checkErrorState=function(n,u,f){var h=null,w=null,e=null,o=null,a=null,l=null,y=null,tt=null,it=null,s=false,c,v,b,k,rt,p,ut,d,g;if(c=f?n.lastSendMailResult:n.lastSyncResult,i("Checking error state for resource: "+n.objectId+" checkNetworkConnection: "+u+" checkSendResult: "+f+" lastSyncResult: "+c),b=true,(c===t.Result.success||c===t.Result.serverNotAttempted||c===t.Result.autoDiscoveryNotAttempted)&&(this._mb.removeMessage(this._getErrorMessageId(n,f)),b=false),b){if(!u||this._isConnectedToInternet())switch(c){case t.Result.e_HTTP_DENIED:case t.Result.e_HTTP_UNEXPECTED_CONTENT:case t.Result.ixp_E_IMAP_LOGINFAILURE:this._showCredError&&(e=Jx.res.loadCompoundString("/messagebar/messageBarAuthFailure",this._getEmail(n)),this._isEasType(n)&&(o=Jx.res.getString("/messagebar/messageBarFix"),a=o,l=this._fixClicked.bind(this)),s=true);break;case t.Result.e_NEXUS_APPLY_POLICY_NEEDED:case t.Result.e_NEXUS_UNABLE_TO_COMPLY_WITH_POLICY:if(f)break;h=this._getAccountFromResource(n);w=this._getServerFromAccount(h);k=w.policyComplianceResults;(k&t.PolicyComplianceResults.userCanceledPolicyDialog)==0&&Jx.isNullOrUndefined(this._policyEnforcementAttempted[w.objectId])?(s=false,this._applyPolicyClicked(null,this._getErrorMessageId(n,f))):(rt=this._policyResultsContainEnforceableErrors(k),rt?(e=Jx.res.loadCompoundString("/messagebar/messageBarApplyPolicyNeeded",this._getEmail(n)),o=Jx.res.getString("/messagebar/messageBarContinue"),a=o,l=this._applyPolicyClicked.bind(this)):(e=Jx.res.loadCompoundString("/messagebar/messageBarUnableToComply",this._getEmail(n)),o=Jx.res.getString("/messagebar/messageBarRetry"),a=o,l=this._applyPolicyClicked.bind(this)),y=Jx.res.getString("/messagebar/messageBarMoreDetails"),tt=y,it=this._policyMoreDetailsClicked.bind(this),s=true);break;case t.Result.e_NEXUS_STATUS_MAXIMUM_DEVICES_REACHED:e=Jx.res.getString("/messagebar/messageBarDeviceLimitReached");s=true;break;case-2147012867:e=Jx.res.loadCompoundString("/messagebar/messageBarConnectionFailure",this._getAccountFromResource(n).displayName);s=true;break;case t.Result.credentialMissing:!this._errorDisabled&&this._showCredError&&(e=Jx.res.loadCompoundString("/messagebar/messageBarConnectionError",this._getEmail(n)),o=Jx.res.getString("/messagebar/messageBarUpdate"),a=o,l=this._fixClicked.bind(this),s=true);break;case t.Result.invalidServerCertificate:case t.Result.certBadChain:case t.Result.certBadPurpose:case t.Result.certBadRole:case t.Result.certChainValidityBadNesting:case t.Result.certCNNoMatch:case t.Result.certExpired:case t.Result.certInvalidName:case t.Result.certInvalidPolicy:case t.Result.certLengthConstraintViolated:case t.Result.certMissingImportantField:case t.Result.certNotIssuedByParent:case t.Result.certRevocationCheckFailed:case t.Result.certRevoked:case t.Result.certUntrustedRoot:case t.Result.certUntrustedTestRoot:case t.Result.certWithUnknowExtMarkedCritical:case t.Result.certWrongUsage:e=Jx.res.loadCompoundString("/messagebar/messageBarInvalidServerCertificate",this._getEmail(n));s=true;break;case t.Result.autoDiscoveryFailed:break;default:i("Showing status message for "+c);e=Jx.res.loadCompoundString("/messagebar/messageBarConnectionError",this._getEmail(n));v={messageText:e,tooltip:e,cssClass:this._className};p=this._getStatusMessageId(n,f);this._mb.removeMessage(p);this._mb.addStatusMessage(p,r.high,v);new Jx.Timer(this._getErrorDuration(),function(){this._mb.removeMessage(p)},this)}}else this._showFolderSyncError&&(h=this._getAccountFromResource(n),ut=h.folderStateResult,ut===t.Result.localFolderChangesLost&&(e=Jx.res.getString("/messagebar/messageBarAccountFolderSyncFail"),s=true,h.folderStateResult=0,h.commit()));if(s?i("Showing error message for "+c):this._resourceType===t.ResourceType.mail&&n.oofLastSyncResult!==t.Result.success&&(h=this._getAccountFromResource(n),d=n.oofLastSyncResult,d===t.Result.serverNotAttempted?(e=Jx.res.loadCompoundString("/messagebar/oofSettingNotSynced",h.displayName),l=this._oofSyncTryAgainClicked.bind(this)):(e=Jx.res.loadCompoundString("/messagebar/oofSettingRejectedByServer",h.displayName),l=this._oofSettingTryAgainClicked.bind(this)),o=a=Jx.res.getString("/messagebar/oofSettingSyncErrorActionButtonText"),s=true,i("Showing error message for OOF setting "+d)),s)v={messageText:e,button2:{text:Jx.res.getString("/messagebar/messageBarCloseText"),tooltip:Jx.res.getString("/messagebar/messageBarCloseTooltip"),callback:this._closeClicked.bind(this)},cssClass:this._className},o&&(v.button1={text:o,tooltip:a,callback:l}),y&&(v.textButton={text:y,tooltip:tt,callback:it}),g=this._getErrorMessageId(n,f),this._mb.removeMessage(g),this._mb.addErrorMessage(g,r.high,v);else{Jx.log.info("FB Deprecation Message Bar");var ft=this._mb,et="FB_Deprecation",nt=function(){ft.removeMessage(et);document.removeEventListener("msvisibilitychange",ot,false)},ot=function(){document.msVisibilityState!=="visible"&&nt()},st=Jx.appData.localSettings().get("FBDeprecationDismissed")||false,ht=this._resourceType===t.ResourceType.contacts;ht&&!st&&ft.addErrorMessage(et,r.medium,{messageHTML:Jx.res.getString("/strings/facebookDeprecationBodyText"),button1:{text:Jx.res.getString("/strings/IgnoreButton"),tooltip:Jx.res.getString("/strings/IgnoreButton"),callback:nt},button2:{text:Jx.res.getString("/strings/DismissButton"),tooltip:Jx.res.getString("/strings/DismissButton"),callback:function(){Jx.appData.localSettings().set("FBDeprecationDismissed",true);nt()}},cssClass:this._className});document.addEventListener("msvisibilitychange",ot,false)}};n._getStatusMessageId=function(n,t){var i=t?this._SEND_MESSAGE_PREFIX:this._SYNC_MESSAGE_PREFIX;return this._STATUS_MESSAGE_PREFIX+i+n.objectId};n._getErrorMessageId=function(n,t){var i=t?this._SEND_MESSAGE_PREFIX:this._SYNC_MESSAGE_PREFIX;return this._ERROR_MESSAGE_PREFIX+i+n.objectId};n._getResourceByMessageId=function(n){var t=n.slice(this._ERROR_MESSAGE_PREFIX.length+this._SYNC_MESSAGE_PREFIX.length);return this._resources[t].resource};n._getAccountFromResource=function(n){return this._resources[n.objectId].account};n._getServerFromAccount=function(n){return n.getServerByType(t.ServerType.eas)};n._getEmail=function(n){var t=this._getAccountFromResource(n);return t.emailAddress};n._isEasType=function(n){var i=this._getAccountFromResource(n);return i.accountType===t.AccountType.eas};n._fixClicked=function(n,t){this._mb.removeMessage(t);var i=this._getResourceByMessageId(t),r=this._getAccountFromResource(i),u=new People.Accounts.AccountDialog(r,People.Accounts.AccountDialogMode.update,this._appScenario,this._platform);u.show()};n._applyPolicyClicked=function(n,r){var s=this,u=this._getResourceByMessageId(r),f=this._getAccountFromResource(u),e=this._getServerFromAccount(f),o=f.objectId,a=e.getClientSecurityPolicy(),h,c;s._mb.removeMessage(r);h=function(){i("applyAsync completed successfully for account "+o);e.policyApplyAttempted=true;s._policyEnforcementAttempted[e.objectId]=true;u.isSyncNeeded=true;u.commit();f.commit()};c=function(n){i("applyAsync returned "+n.number+" for account "+o);n.number===t.Result.e_NEXUS_USER_CANCELLED_POLICY?(e.policyComplianceResults|=t.PolicyComplianceResults.userCanceledPolicyDialog,f.commit(),s._checkErrorState(u,false,false)):h(null)};try{i("Calling applyAsync for account "+o);a.applyAsync().then(h,c)}catch(l){i("applyAsync threw exception "+l.number+" for account "+o)}};n._policyMoreDetailsClicked=function(n,t){var i=this._getResourceByMessageId(t),u=this._getAccountFromResource(i),f=this._getServerFromAccount(u),r=f.policyComplianceResults,e=this._policyResultsContainEnforceableErrors(r);this._moreDetailsFlyout||(this._moreDetailsFlyout=new Chat.SyncMessageBarFlyout);this._moreDetailsFlyout.init(this._getEmail(i),r,e);this._moreDetailsFlyout.show(n,"bottom")};n._closeClicked=function(n,t){this._mb.removeMessage(t)};n._policyResultsContainEnforceableErrors=function(n){var i=t.PolicyComplianceResults,r=n&(i.userNotAnAdmin|i.userCanceledPolicyDialog|i.usersCannotChangePassword|i.connectedUserPasswordIsWeak|i.userHasBlankPassword|i.connectedAdminPasswordIsWeak|i.adminsHaveBlankPasswords|i.notProtectedBitLocker|i.notProtected3rdParty|i.protectionSuspendedBitLocker|i.protectionSuspended3rdParty|i.osVolumeNotProtectedBitLocker|i.osVolumeNotProtected3rdParty|i.protectionNotYetEnabledBitLocker|i.protectionNotYetEnabled3rdParty);return Boolean(r)};n._oofSyncTryAgainClicked=function(n,t){this._mb.removeMessage(t);var i=this._getResourceByMessageId(t),r=this._getAccountFromResource(i);i.isSyncNeeded=true;try{r.commit()}catch(u){Jx.log.exception("Chat.SyncMessageBarPresenter._oofSyncTryAgainClicked failed to call account.commit.",u)}};n._oofSettingTryAgainClicked=function(n,i){this._mb.removeMessage(i);var r=this._getResourceByMessageId(i),u=this._getAccountFromResource(r);Mail.AccountSettings.launchPerAccountSettings(u,true)}})