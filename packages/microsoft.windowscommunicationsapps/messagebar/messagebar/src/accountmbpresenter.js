Jx.delayDefine(Chat,"AccountMessageBarPresenter",function(){var t=Microsoft.WindowsLive.Platform,n;Chat.AccountMessageBarPresenter=function(){};n=Chat.AccountMessageBarPresenter.prototype;n._mb=null;n._platform=null;n._className=null;n._accounts=null;n._accountMap={};n._appScenario=null;n._appName=null;n._relevantProperty=null;n._ERROR_MESSAGE_PREFIX="errorAccount";n._ERROR_MESSAGE_PRIORITY=4;n.init=function(n,i,r,u){var e,f;if(this._mb=n,this._platform=i,this._appScenario=r,this._className=u,this._appScenario===t.ApplicationScenario.people&&(this._appName="people",this._relevantProperty="peopleScenarioState"),this._accountChanged=this._accountChanged.bind(this),this._collectionChanged=this._collectionChanged.bind(this),this._accounts=i.accountManager.getConnectedAccountsByScenario(this._appScenario,t.ConnectedFilter.normal,t.AccountSort.name),!Jx.isNullOrUndefined(this._accounts)){for(this._accounts.addEventListener("collectionchanged",this._collectionChanged),e=0;e<this._accounts.count;e++)f=this._accounts.item(e),this._accountMap[f.objectId]=f,f.addEventListener("changed",this._accountChanged),this._checkScenarioState(f,f[this._relevantProperty]);this._accounts.unlock()}};n.shutdown=function(){var n,t;for(n in this._accountMap)t=this._accountMap[n],t.removeEventListener("changed",this._accountChanged);this._accounts&&(this._accounts.removeEventListener("collectionchanged",this._collectionChanged),this._accounts.dispose())};n._collectionChanged=function(n){var r=n.detail[0],u=t.CollectionChangeType,i=null;r.eType===u.itemAdded?(i=this._accounts.item(r.index),this._accountMap[i.objectId]=i,i.addEventListener("changed",this._accountChanged),this._checkScenarioState(i,i[this._relevantProperty])):r.eType===u.itemRemoved&&(i=this._accountMap[r.objectId],Jx.isNullOrUndefined(i)?Jx.isNullOrUndefined(r.objectId)||this._mb.removeMessage(this._ERROR_MESSAGE_PREFIX+r.objectId):(this._checkScenarioState(i,t.ScenarioState.none),i.removeEventListener("changed",this._accountChanged),delete this._accountMap[i.objectId]))};n._accountChanged=function(n){var t,i;t=n.target;for(i in n)if(n[i]===this._relevantProperty){this._checkScenarioState(t,t[this._relevantProperty]);break}};n._checkScenarioState=function(n,i){var r=Microsoft.WindowsLive.Platform.ScenarioState,u,f,e,o;i===r.error?(u=n.getConfigureType(this._appScenario),u===t.ConfigureType.editOnWeb&&(f={messageText:Jx.res.loadCompoundString("/messagebar/messageBarAccountError",n.displayName),button1:{text:Jx.res.getString("/messagebar/messageBarReconnect"),tooltip:Jx.res.getString("/messagebar/messageBarReconnect"),callback:this._reconnectClicked.bind(this)},button2:{text:Jx.res.getString("/messagebar/messageBarNotNow"),tooltip:Jx.res.getString("/messagebar/messageBarNotNow"),callback:this._notNowClicked.bind(this)},cssClass:this._className},this._mb.removeMessage(this._getErrorMessageId(n)),this._mb.addErrorMessage(this._getErrorMessageId(n),this._ERROR_MESSAGE_PRIORITY,f))):i===r.upgradeRequired?(e=n.getConfigureType(this._appScenario),e===t.ConfigureType.editOnWeb&&(o={messageText:Jx.res.loadCompoundString("/messagebar/messageBarAccountUpgrade",n.displayName),button1:{text:Jx.res.getString("/messagebar/messageBarUpdateString"),tooltip:Jx.res.getString("/messagebar/messageBarUpdateString"),callback:this._reconnectClicked.bind(this)},button2:{text:Jx.res.getString("/messagebar/messageBarNotNow"),tooltip:Jx.res.getString("/messagebar/messageBarNotNow"),callback:this._notNowClicked.bind(this)},cssClass:this._className},this._mb.removeMessage(this._getErrorMessageId(n)),this._mb.addErrorMessage(this._getErrorMessageId(n),this._ERROR_MESSAGE_PRIORITY,o))):this._mb.removeMessage(this._getErrorMessageId(n))};n._getErrorMessageId=function(n){return this._ERROR_MESSAGE_PREFIX+n.objectId};n._getAccountByMessageId=function(n){var t=n.slice(this._ERROR_MESSAGE_PREFIX.length);return this._accountMap[t]};n._buildUrl=function(n){var r=this._platform.accountManager.defaultAccount.meContact,u=Windows.Security.Authentication.Web.WebAuthenticationBroker.getCurrentApplicationCallbackUri(),i=Microsoft.WindowsLive.Cid,t="https://profile.live.com/cid-"+i.CidFormatter.toString(r.cid.value,i.CidFormat.hexidecimal)+"/services/connect/?",f=n[this._relevantProperty]===Microsoft.WindowsLive.Platform.ScenarioState.error;return t+="appid="+n.sourceId,t+="&scenarios="+n.getServerScenarios(this._appScenario,f),t+="&view=modern",t+="&biciID="+this._appName+"infobar",t+="&brand="+this._appName,t+="&ru="+u.absoluteUri,t+"&authz=true"};n._reconnectClicked=function(n,t){this._mb.removeMessage(t);var i=this._getAccountByMessageId(t),r=this._buildUrl(i),u=new Windows.Foundation.Uri(r),f=Windows.Security.Authentication.Web.WebAuthenticationBroker.getCurrentApplicationCallbackUri();Windows.Security.Authentication.Web.WebAuthenticationBroker.authenticateAsync(Windows.Security.Authentication.Web.WebAuthenticationOptions.none,u,f).then()};n._notNowClicked=function(n,t){this._mb.removeMessage(t)}})