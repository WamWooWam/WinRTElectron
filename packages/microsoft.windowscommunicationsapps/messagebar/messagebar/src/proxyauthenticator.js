Jx.delayDefine(Chat,"ProxyAuthenticator",function(){"use strict";var t=Microsoft.WindowsLive.Platform,n;Chat.ProxyAuthenticator=function(){};n=Chat.ProxyAuthenticator.prototype;n._platform=null;n._accounts=null;n._accountMap={};n._appScenario=null;n.init=function(n,i){var u,r;if(this._platform=n,this._appScenario=i,this._accountChanged=this._accountChanged.bind(this),this._collectionChanged=this._collectionChanged.bind(this),this._accounts=n.accountManager.getConnectedAccountsByScenario(this._appScenario,t.ConnectedFilter.normal,t.AccountSort.name),!Jx.isNullOrUndefined(this._accounts)){for(this._accounts.addEventListener("collectionchanged",this._collectionChanged),u=0;u<this._accounts.count;u++)r=this._accounts.item(u),this._accountMap[r.objectId]=r,r.addEventListener("changed",this._accountChanged),this._checkErrorState(r);this._accounts.unlock()}};n.shutdown=function(){var n,t;for(n in this._accountMap)t=this._accountMap[n],t.removeEventListener("changed",this._accountChanged);this._accounts&&(this._accounts.removeEventListener("collectionchanged",this._collectionChanged),this._accounts.dispose())};n._collectionChanged=function(n){var r=n.detail[0],u=t.CollectionChangeType,i=null;r.eType===u.itemAdded?(i=this._accounts.item(r.index),this._accountMap[i.objectId]=i,i.addEventListener("changed",this._accountChanged),this._checkErrorState(i)):r.eType===u.itemRemoved&&(i=this._accountMap[r.objectId],Jx.isNullOrUndefined(i)||(this._checkErrorState(i),i.removeEventListener("changed",this._accountChanged),delete this._accountMap[i.objectId]))};n._accountChanged=function(n){this._checkErrorState(n.target)};n._checkErrorState=function(n){if(!Jx.isNullOrUndefined(n)){var i=n.lastAuthResult;i===t.Result.e_HTTP_PROXY_AUTH_REQ&&this._authenticateProxy(n)}};n._authenticateProxy=function(n){var i,u,t,r;try{if(Jx.log.info("Sending canary request to trigger proxy authentication dialog."),i=n.getServerByType(Microsoft.WindowsLive.Platform.ServerType.eas),Jx.isNullOrUndefined(i))return;u="http://"+i.server;t=new XMLHttpRequest;t.open("OPTIONS",u);r=function(){t.status!==407?(Jx.log.info("Proxy canary returned successfully, kicking off sync."),this._platform&&Jx.forceSync(this._platform,Microsoft.WindowsLive.Platform.ApplicationScenario.mail)):Jx.log.error("Status Error "+t.status.toString()+": "+t.responseText);t.removeEventListener("load",r)}.bind(this);t.addEventListener("load",r);t.send()}catch(f){Jx.log.exception("_authenticateProxy exception",f)}}})