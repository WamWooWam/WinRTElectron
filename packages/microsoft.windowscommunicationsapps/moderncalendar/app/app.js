Jx.delayDefine(Calendar,"App",function(){function u(n){Jx.mark("Calendar.App."+n+",Info,Calendar,App")}function t(n){Jx.mark("Calendar:App."+n+",StartTA,Calendar,App")}function i(n){Jx.mark("Calendar:App."+n+",StopTA,Calendar,App")}var r=Calendar.App=function(n,r){t("ctor");this._host=n;this._platformWorker=new Calendar.WorkerEx(r);this._scheduler=null;this._jobset=null;this._deferredWork=new Calendar.WorkQueue;this._services={deferredWork:this._deferredWork};this._firstRun=true;this._platform=null;this._hrPlatform=0;this._suspended=false;this._hadConnectedId=false;this.initComponent();this._id="calApp";this._lastOuterWidth=window.outerWidth;var u=Jx.activation;u.addListener(u.tile,this._onTile,this);u.addListener(u.protocol,this._onProtocol,this);u.addListener(u.resuming,this._onResuming,this);u.addListener(u.appointmentsProvider,this._onShowTimeFrame,this);this.on("getPlatform",this._onGetPlatform,this);this.on("getPlatformWorker",this._onGetPlatformWorker,this);this.on("getSettings",this._onGetSettings,this);this.on("setShowArrows",this._onSetShowArrows,this);this.on("viewReady",this._onViewReady,this);this._time=Date.now();document.addEventListener("msvisibilitychange",this._onVisibilityChange.bind(this),false);this._onResize=this._onResize.bind(this);window.addEventListener("resize",this._onResize,false);document.title=Jx.res.getString("calendarAppTitle");i("ctor")},n,f;Jx.augment(r,Jx.Component);r._reloadTimeout=Calendar.DAY_IN_MILLISECONDS*3;n=r.prototype;n.dispose=function(){this._services=null;this._deferredWork&&(this._deferredWork.dispose(),this._deferredWork=null)};n.onQueryService=function(n){return this._services[n]};n.shutdownUI=function(){this._ui.shutdownUI()};n._getPlatform=function(){if(!this._platform){var u=Microsoft.WindowsLive.Platform,n=u.ClientCreateOptions;try{t("createUiPlatform");this._platform=new u.Client("calendar",n.delayResources|n.failIfNoUser|n.failIfUnverified);this._hrPlatform=0;i("createUiPlatform")}catch(r){Jx.mark("Calendar:WinRT_GetPlatform_error: "+r.toString().trim()+" ("+r.number+")");this._hrPlatform=r.number}}return this._platform};n._retryPlatformCreation=function(n){var t=this._getPlatform();return n&&n(this._hrPlatform),Jx.isObject(t)};n._onTile=function(n){if(t("_onTile"),n.arguments&&this._ui){Jx.log.info("launched with arguments: "+n.arguments);var r;try{r=this._platform.calendarManager.getEventFromHandle(n.arguments)}catch(u){Jx.log.exception("tile received invalid handle: "+n.arguments,u);r=this._getEventFromPreHandleToastId(n.arguments)}r&&Jx.EventManager.broadcast("editEvent",{event:r},this._ui)}i("_onTile")};n._onProtocol=function(n){var r,f,s,u;t("_onProtocol");var e=n.uri,h=e.host,o=e.queryParsed;if(h==="focusEvent"){for(r={startDate:null,endDate:null,allDayEvent:null},f=0,s=o.length;f<s;f++){u=o[f];switch(u.name){case"start":r.startDate=new Date(parseInt(u.value,10));break;case"end":r.endDate=new Date(parseInt(u.value,10));break;case"allDay":r.allDayEvent=u.value==="true"}}Jx.isDate(r.startDate)&&Jx.isDate(r.endDate)&&Jx.isBoolean(r.allDayEvent)&&(isNaN(r.startDate.valueOf())||isNaN(r.endDate.valueOf())||r.startDate<=r.endDate&&Jx.EventManager.broadcast("focusEvent",r,this._ui))}i("_onProtocol")};n._onShowTimeFrame=function(n){var u,f,r;(t("_onShowTimeFrame"),u=n.verb===Windows.ApplicationModel.Appointments.AppointmentsProvider.AppointmentsProviderLaunchActionVerbs.showTimeFrame,u)&&(f=Math.round(n.duration),r={},r.startDate=new Date(n.timeToShow),r.endDate=new Date(r.startDate.getTime()+f),r.allDayEvent=false,i("_onShowTimeFrame"),Jx.EventManager.broadcast("focusEvent",r,this._ui))};n._onCommandsRequested=function(n){this._settingsPane=new Calendar.Views.Settings;this.append(this._settingsPane);this._settingsPane.activateUI();this._settingsPane.appendCommands(n.request.applicationCommands);n.target.removeEventListener("commandsrequested",this._onCommandsRequested)};n._onSuspending=function(){t("_onSuspending");this._platform&&(this._suspended=true,this._platform.suspend());i("_onSuspending")};n._onResuming=function(){t("_onResuming");this._platform&&(this._suspended=false,this._platform.resume());this.fire("resuming");Jx.ptStopResume(Jx.TimePoint.responsive);i("_onResuming")};n._onVisibilityChange=function(){if(!document.msHidden&&!this._suspended){var n=Date.now()-this._time;r._reloadTimeout<n&&(this._ui&&this._ui.isEditing()||(t("reload"),Jx.EventManager.broadcast("reload"),window.location.reload(),i("reload")))}};n._onGetPlatform=function(n){n.handled||(n.data.platform=this._platform,n.handled=true)};n._onGetPlatformWorker=function(n){n.handled||(n.data.platformWorker=this._platformWorker,n.handled=true)};n._onGetSettings=function(n){if(!n.handled){if(!this._settingsContainer){var t=new Jx.AppData,i=t.localSettings();this._settingsContainer=i.container("Calendar")}n.data.settings=this._settingsContainer;n.handled=true}};n._onSetShowArrows=function(n){n.handled||(this._settingsContainer.set("alwaysShowArrows",n.data.value),Jx.EventManager.broadcast("showArrows",n.data,this._ui),n.handled=true)};n._onViewReady=function(n){var t,f,i;n.stage===Jx.EventManager.Stages.bubbling&&(t=this._deferredWork,this._firstRun&&(this._firstRun=false,f=People.Accounts,i=People.Priority.launch,t.queue("PlatformInit",50,i,this._platformInit,this),t.queue("NetFirstRun",50,i,f.ensureNetworkOnFirstRun,null,[this._platform]),t.queue("EasiId",50,i,f.checkForEasiId,null,[this._platform,r.scenario]),t.queue("JxLaunch",50,i,Jx.launch.startDeferredTasks,Jx.launch,[this._platform]),t.queue("LockScreen",50,i,Chat.Shared.ensureLockScreen)),u("RunDeferredWork"),t.unlock())};n._platformInit=function(){t("_platformInit");this._platform.addEventListener("restartneeded",r._onRestartNeeded);this._platform.requestDelayedResources();Jx.forceSync(this._platform,Calendar.scenario);i("_platformInit")};n.initialize=function(){if(this._getPlatform())this._hadConnectedId=true,this._initUi();else{var n=this._retryPlatformCreation.bind(this),t=this._initUi.bind(this);People.Accounts.showLogonErrorDialog(n,t,this._hrPlatform)}};n._hookSuspend=function(){var n=Jx.activation;n.addListener(n.suspending,this._onSuspending,this)};n._hookSettings=function(){this._onCommandsRequested=this._onCommandsRequested.bind(this);var n=Windows.UI.ApplicationSettings.SettingsPane.getForCurrentView();n.addEventListener("commandsrequested",this._onCommandsRequested)};n._hookShare=function(){var n=Windows.ApplicationModel.DataTransfer.DataTransferManager.getForCurrentView();n.addEventListener("datarequested",this._onShareSourceDataRequested.bind(this))};n._onShareSourceDataRequested=function(n){this._ui.getShareData(n.request)};r._onRestartNeeded=function(){People.Accounts.showMustSignInDialog(function(){location.reload()},true)};n._initUi=function(){t("_initUi");this._scheduler=new People.Scheduler;this._jobset=this._scheduler.getJobSet();this._host&&(this._hadConnectedId||this._platformWorker.postCommand("Worker/restartPlatform"),this._platformWorker.postCommand("Worker/DOMContentLoaded",{isRtl:getComputedStyle(document.documentElement).direction==="rtl"}),this._ui=new Calendar.Views.Frame,this.appendChild(this._ui),this._ui.initUI(this._host,this._jobset));this._hookSuspend();this._hookSettings();this._hookShare();i("_initUi")};n._onResize=function(){t("_onResize");this._suspended||setImmediate(function(){var n={outerWidth:window.outerWidth},t,i;this._lastOuterWidth!==n.outerWidth&&(this._deferredWork.lock(),Jx.EventManager.broadcast("resizeWindow",n),t=true,i=false,Jx.ptStopResize(Jx.TimePoint.responsive,t,i,n.outerWidth,window.outerHeight),this._deferredWork.unlock(),this._lastOuterWidth=n.outerWidth)}.bind(this));i("_onResize")};n._getEventFromPreHandleToastId=function(n){var i=null,t,r,u;return n&&(t=n.split(".",2),r=parseInt(t[0],10),t.length>1&&(u=new Date(parseInt(t[1],10))),i=this._loadEvent(r,u)),i};n._loadEvent=function(n,t){var r=this._platform.calendarManager,i=null;try{i=r.getEventFromID(n);t&&i&&(i=i.getOccurrence(t))}catch(u){Jx.log.exception("unable to load eventId ["+n+"] with instanceStartDate ["+t+"]",u);i=null}return i};f=Calendar.WorkQueue=function(){this._queue=[];this._job=null;this._locked=true};f.prototype={dispose:function(){this._queue=null;this._job&&(this._job.dispose(),this._job=null)},queue:function(n,t,i,r,f,e){for(var o=this._queue,s=o.length-1;s>=0;s--)n===o[s].description&&(u("WorkQueue: remove:"+n),o.splice(s,1));o.push({description:n,delay:t,priority:i,fn:r,context:f,args:e})},_run:function(){var t=this._queue,n;!this._locked&&!this._job&&t.length>0&&(n=t.shift(),this._job=Jx.scheduler.addTimerJob(null,n.priority,n.description,n.delay,function(){this._job=null;n.fn.apply(n.context,n.args);this._run()},this))},lock:function(){this._locked=true},unlock:function(){this._locked=false;this._run()}}})