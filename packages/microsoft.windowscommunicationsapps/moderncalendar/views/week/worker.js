(function(){function i(n){Jx.mark("Calendar:WeekWorker."+n+",StartTA,Calendar")}function r(n){Jx.mark("Calendar:WeekWorker."+n+",StopTA,Calendar")}function f(t){var i=t.start?'<div class="startTime" aria-hidden="true">'+t.start+"<\/div>":"",r=t.end?'<div class="endTime" aria-hidden="true">'+t.end+"<\/div>":"";return'<div id="'+n.getIdFromEventHandle(t.handle,t.isCrossDay)+'" data-handle="'+t.handle+'" class="event" style="color:'+t.color+';" data-status="'+t.status+'" tabIndex="0" data-order="'+t.order+'" role="button" aria-label="'+Jx.escapeHtml(t.label)+'"><div class="glyph" style="background-color:'+t.color+';"><div class="glyphInner"><\/div><\/div>'+i+'<div class="subject" aria-hidden="true">'+Jx.escapeHtml(t.subject)+"<\/div>"+r+'<div class="overlay"><\/div><\/div>'}function e(n){var t=n.location?"("+Jx.escapeHtml(n.location)+")":"";return'<span class="subject">'+Jx.escapeHtml(n.subject)+'<\/span> <span class="location">'+t+"<\/span>"}function o(n){return'<div class="subject">'+Jx.escapeHtml(n.subject)+'<\/div><div class="location">'+Jx.escapeHtml(n.location)+"<\/div>"}function s(t){var i=t.isOneLine?e(t):o(t);return'<div id="'+n.getIdFromEventHandle(t.handle,t.isCrossDay)+'" data-handle="'+t.handle+'" class="'+t.className+'" data-status="'+t.status+'" tabIndex="0" data-order="'+t.order+'" role="button" aria-label="'+Jx.escapeHtml(t.label)+'" style="position: absolute;top:'+t.top+"%;"+t.dir+":"+t.left+"%;width:"+t.width+";height:"+t.height+"%;color:"+t.color+';"><div class="glyph" style="background-color:'+t.color+";"+t.glyphHeight+';"><div class="glyphInner"><\/div><\/div><div class="details" aria-hidden="true">'+i+'<\/div><div class="overlay"><\/div><\/div>'}var n=Calendar.Helpers,u=Calendar.Views.WeekWorker=function(t,i,r){this._router=t;this._scheduler=i;this._manager=r;this._requests={};this._updateEvents=this._updateEvents.bind(this);this._router.route("Week/getEvents",this.getEvents,this);this._router.route("Week/setVisible",this.setVisible,this);this._router.route("Week/expandAllDay",this.expandAllDay,this);this._router.route("Week/cancel",this.cancel,this);u._allDayMore||(n.ensureFormats(),u._allDayMore=Jx.res.getFormatFunction("AllDayMore"))},t=u.prototype;t.getEvents=function(n){var u=n.id,t=n.data;t.id=u;t.start=new Date(t.start);t.end=new Date(t.end);i("getEvents");t.collection=this._manager.getEvents(t.start,t.end);t.job=this._scheduler.schedule(this._splitEventsByDay,this,[t],t.isVisible);r("getEvents");this._requests[u]=t};t.setVisible=function(n){var t=n.data;t&&(t.isVisible=n.data,this._scheduler.setVisible(t.job,n.data))};t.expandAllDay=function(n){var t=this._requests[n.id],i;t&&(i=n.data.index,this._scheduler.schedule(this._expandAllDay,this,[t,i],true))};t.cancel=function(n){var f,t,u;i("cancel");f=n.id;t=this._requests[f];t&&(u=t.onCollectionChanged,u&&(t.collection.removeEventListener("collectionchanged",u),t.changeTimeout!==true&&clearTimeout(t.changeTimeout)),this._unhookEvents(t),t.collection.dispose(),this._scheduler.cancel(t.job),delete this._requests[n.id]);r("cancel")};t.dispose=function(){for(var n in this._requests)this.cancel({id:n});this._requests={};this._manager=null;this._scheduler=null;this._router=null};t._splitEventsByDay=function(t){var l,a;i("_splitEventsByDay");for(var e=new Date(t.start),tt=new Date(e.getFullYear(),e.getMonth(),e.getDate()+7).getTime(),v=new Array(7),y=new Date(e),g,f=0;f<7;f++)v[f]=y.getTime(),y.setDate(y.getDate()+1);var p=[[],[],[],[],[],[],[]],o=0,w=n.getCollection(e,tt,t.collection);for(t.requiresSort&&(w.sort(n.orderEvents),t.requiresSort=false),f=0,g=w.length;f<g;f++){var b=w[f],s=b.winrt,u=s.startDate,nt=s.endDate,h=b.start,c=b.end,k=false,d=!n.isSameDate(u,nt);for(!s.allDayEvent&&d&&(l=new Date(u.getTime()),l.setDate(l.getDate()+1),l<=nt&&(k=true)),u=h<v[0]?new Date(e):new Date(u.getFullYear(),u.getMonth(),u.getDate());v[o]<u&&o<7;)o++;if(h===c&&o<7)p[o].push({start:h,end:c,isMultiDay:k,isCrossDay:d,winrt:s});else for(a=o;a<7&&u<c;a++)p[a].push({start:h,end:c,isMultiDay:k,isCrossDay:d,winrt:s}),u.setDate(u.getDate()+1)}t.events=p;t.days=new Array(7);t.job=this._scheduler.schedule(this._processEvents,this,[t],t.isVisible);r("_splitEventsByDay")};t._processEvents=function(t){var p,g,o,f,c,u,s,w,v,b,k,d;for(i("_processEvents"),p=t.start,g={},s=0;s<7;s++){w=t.days[s]=new Date(p.getFullYear(),p.getMonth(),p.getDate()+s);v=w.getTime();o=t.events[s];o.allDay=0;var l=[],a={width:1},nt=0,e,y,h;for(f=0,c=o.length;f<c;f++)if(u=o[f],b=u.winrt,b.allDayEvent||u.isMultiDay)o.allDay++;else for(k=b.startDate,d=b.endDate,u.dayStart=w<k?v+k.getHours()*n.hourInMilliseconds+k.getMinutes()*n.minuteInMilliseconds:v,u.dayEnd=n.isSameDate(w,d)?v+d.getHours()*n.hourInMilliseconds+d.getMinutes()*n.minuteInMilliseconds:v+n.dayInMilliseconds,u.length=u.dayEnd-u.dayStart,u.length<=n.shortEventLength?(u.uiLength=n.shortEventLength,u.uiEnd=u.dayStart+u.uiLength,u.isShort=true):(u.uiLength=u.length,u.uiEnd=u.dayEnd,u.length<=n.mediumEventLength&&(u.isMedium=true)),g[u.uiEnd]=true,e=0;e<=f;e++)if(h=l[e],h||(h={uiEnd:n.zeroYearTime},a.width=e+1),h.uiEnd<=u.dayStart){for(y=e+1;y<a.width&&l[y].uiEnd<=h.dayStart;y++)h.width++;y===a.width&&(h.width=-1);e===0&&nt<=u.dayStart&&(a={width:1},l=[]);nt=Math.max(nt,u.uiEnd);l[e]=u;u.cluster=a;u.position=e;u.width=1;break}for(f=0,c=a.width;f<c;f++)for(h=l[f],e=f+1;e<c&&l[e].uiEnd<=h.dayStart;e++)h.width++;o.allDayHtml="";o.eventHtml=""}for(s=0;s<7;s++)for(o=t.events[s],f=0,c=o.length;f<c;f++)u=o[f],g[u.dayStart]&&(u.hasPreviousEvent=true);t.job=this._scheduler.schedule(this._buildAllDayHtml,this,[t],t.isVisible);r("_processEvents")};t._buildAllDayHtml=function(n){var f,e,t,u;for(i("_buildAllDayHtml"),f=n.events,e=n.days,t=0;t<7;t++)u=f[t],u.allDayHtml=this._getAllDayHtmlForDay(u,t,e[t],false);n.job=this._scheduler.schedule(this._buildEventHtml,this,[n],n.isVisible);r("_buildAllDayHtml")};t._getAllDayHtmlForDay=function(t,e,o,s){var c,l,h;i("_getAllDayHtmlForDay");for(var w=new Date(o.getFullYear(),o.getMonth(),o.getDate()+1),y=!s&&3<t.allDay,b=y?2:t.allDay,a="",v=0,p=0,k=t.length;v<k&&p<b;v++)c=t[v],l=c.winrt,(l.allDayEvent||c.isMultiDay)&&(h=n.getEventUiInfo(l,false),h.order=e,h.start="",h.end="",h.isCrossDay=c.isCrossDay,c.isMultiDay&&(o<=c.start?h.start=n.simpleTime.format(l.startDate):c.end<=w&&(h.end=n.simpleTime.format(l.endDate))),a+=f.call(this,h),p++);return y&&(a+="<div class='more' tabIndex='0' data-order='"+e+"' role='button'>"+Jx.escapeHtml(u._allDayMore(t.allDay-2))+"<\/div>"),r("_getAllDayHtmlForDay"),a};t._buildEventHtml=function(n){var t,u,f;for(i("_buildEventHtml"),t=0;t<7;t++)u=n.events[t],f=n.days[t],u.eventHtml=this._getEventHtmlForDay(u,f,t);n.job=this._scheduler.schedule(this._sendEvents,this,[n],n.isVisible);r("_buildEventHtml")};t._getEventHtmlForDay=function(t,u,f){var l,c,w,e,a,o;for(i("_getEventHtmlForDay"),l="",c=0,w=t.length;c<w;c++)if(e=t[c],a=e.winrt,!a.allDayEvent&&!e.isMultiDay){var k=u.getTime(),d=e.width===-1?e.cluster.width-e.position:e.width,g=(e.dayStart-k)*n.percentageOfDay,b=e.position*100/e.cluster.width,v=d*100/e.cluster.width,h,y="event",p=e.length*n.percentageOfDay;e.isShort?(h=e.uiLength*n.percentageOfDay,y+=" short"):h=p;e.hasPreviousEvent&&(y+=" hasPreviousEvent");o=n.getEventUiInfo(a,false);o.className=y;o.order=f;o.dir=this._isRtl?"right":"left";o.left=b;o.top=g;o.width=b+v!==100?"calc("+v+"% - 1px)":v+"%";o.height=h-100/1440;o.glyphHeight=p<h?"height: "+100*p/h+"%":"";o.isOneLine=e.isShort||e.isMedium;o.isCrossDay=e.isCrossDay;l+=s(o)}return r("_getEventHtmlForDay"),l};t._sendEvents=function(n){i("_sendEvents");var t;n.onCollectionChanged?(t="Week/eventsChanged",n.job=this._scheduler.schedule(this._hookEvents,this,[n],n.isVisible),n.collection.unlock()):(t="Week/getEvents",n.job=this._scheduler.schedule(this._hookCollection,this,[n],n.isVisible));this._router.postMessage({command:t,id:n.id,allDayHtml:n.events.map(function(n){return n.allDayHtml}),eventHtml:n.events.map(function(n){return n.eventHtml})});r("_sendEvents")};t._expandAllDay=function(n,t){i("_expandAllDay");var u=n.events[t],f=n.days[t],e=this._getAllDayHtmlForDay(u,t,f,true);this._router.postMessage({command:"Week/expandAllDay",id:n.id,index:t,html:e});r("_expandAllDay")};t._hookCollection=function(n){i("_hookCollection");n.onCollectionChanged=this._onCollectionChanged.bind(this,n);n.collection.addEventListener("collectionchanged",n.onCollectionChanged);n.collection.unlock();this._hookEvents(n);r("_hookCollection")};t._hookEvents=function(n){var t,f,u,e;for(i("_hookEvents"),n.onItemChanged=this._onItemChanged.bind(this,n),t=0;t<7;t++)for(f=n.events[t],u=0,e=f.length;u<e;u++)f[u].winrt.addEventListener("changed",n.onItemChanged);r("_hookEvents")};t._unhookEvents=function(n){var f,t,e,u,o;if(i("_unhookEvents"),f=n.onItemChanged,f){for(t=0;t<7;t++)for(e=n.events[t],u=0,o=e.length;u<o;u++)e[u].winrt.removeEventListener("changed",f);n.onItemChanged=null}r("_unhookEvents")};t._onCollectionChanged=function(n){if(i("_onCollectionChanged"),!n.changeTimeout){this._unhookEvents(n);this._scheduler.cancel(n.job);var t=Date.now()-(n.lastChanged?n.lastChanged:0);t<990?n.changeTimeout=setTimeout(this._updateEvents,1e3-t,n):(setImmediate(this._updateEvents,n),n.changeTimeout=true)}r("_onCollectionChanged")};t._updateEvents=function(n){this._requests[n.id]&&(i("_updateEvents"),n.changeTimeout=null,n.lastChanged=Date.now(),n.collection.lock(),this._splitEventsByDay(n),r("_updateEvents"))};t._onItemChanged=function(t,u){var e,f,o,h,s;for(i("_onItemChanged"),e=Array.prototype.slice.call(u.detail[0]),f=u.target,o=0,h=e.length;o<h;o++)if(s=e[o],s==="startDate"||s==="endDate"){t.requiresSort=true;this._onCollectionChanged(t,u);return}this._router.postMessage({command:"Week/eventChanged",id:t.id,properties:e,ev:{handle:f.handle,busyStatus:f.busyStatus,color:f.color,location:f.location,subject:f.subject||n.noSubject}});r("_onItemChanged")}})()