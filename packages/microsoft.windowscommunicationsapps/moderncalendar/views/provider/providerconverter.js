Jx.delayDefine(Calendar,"ProviderConverter",function(){function o(n){Jx.mark("Calendar.ProviderConverter."+n+",StartTA,Calendar,App")}function s(n){Jx.mark("Calendar.ProviderConverter."+n+",StopTA,Calendar,App")}function l(n){return Math.round(n/h.minuteInMilliseconds)}function p(t,i){var r=t;return t===n.BusyStatus.workingElsewhere&&(i.capabilities&n.ServerCapability.statusWorkingElsewhere)!==n.ServerCapability.statusWorkingElsewhere&&(r=n.BusyStatus.free),r}function e(n){return Jx.res.getString("ProviderErrorRecurrenceLog")+"unit: "+n.recurrence.unit+", occurrences: "+n.recurrence.occurrences+", until: "+n.recurrence.until+", interval: "+n.recurrence.interval+", daysOfWeek: "+n.recurrence.daysOfWeek+", weekOfMonth: "+n.recurrence.weekOfMonth+", month: "+n.recurrence.month+", day: "+n.recurrence.day+"."}function w(t){var r=u.AppointmentBusyStatus,i;switch(t){case r.free:i=n.BusyStatus.free;break;case r.tentative:i=n.BusyStatus.tentative;break;case r.outOfOffice:i=n.BusyStatus.outOfOffice;break;case r.workingElsewhere:i=n.BusyStatus.workingElsewhere;break;case r.busy:default:i=n.BusyStatus.busy}return i}function b(n,t,i){var r,u,f;return r=new Date(n.getTime()+t),u=new Date(n),i&&(u=new Date(n.getFullYear(),n.getMonth(),n.getDate()),f=0,(r.getHours()>0||r.getMinutes()>0||r.getSeconds()>0||r.getMilliseconds()>0)&&(f=1),r=new Date(r.getFullYear(),r.getMonth(),r.getDate()+f),r<=u&&(r=new Date(r.getFullYear(),r.getMonth(),r.getDate()+1))),{startDate:u,endDate:r}}function k(n){var i=null,t=null,r=false;return n&&(i=n.displayName,t=n.address,Jx.isNonEmptyString(t)&&(t=t.trim()),Jx.isNonEmptyString(t)&&(r=true,Jx.isNonEmptyString(i)&&(i=i.trim()))),{organizerName:i,organizerEmail:t,hasOrganizer:r}}function r(n){var t=n.number;return Jx.isNumber(t)&&t!==0||(t=c.generalFailure),t}function f(n,t){var i=0;try{t.recurrence.dayOfWeek=n.daysOfWeek}catch(u){Jx.log.exception("Error setting recurrence dayOfWeek.",u);i=r(u)}return i}function a(i,r){var e=0,f=u.AppointmentWeekOfMonth;switch(i.weekOfMonth){case f.first:r.recurrence.weekOfMonth=n.WeekOfMonth.first;break;case f.second:r.recurrence.weekOfMonth=n.WeekOfMonth.second;break;case f.third:r.recurrence.weekOfMonth=n.WeekOfMonth.third;break;case f.fourth:r.recurrence.weekOfMonth=n.WeekOfMonth.fourth;break;case f.last:r.recurrence.weekOfMonth=n.WeekOfMonth.last;break;default:Jx.log.error("Invalid week of month");e=t.errorInvalidWeekOfMonth}return e}function v(n,t){var i=0;try{t.recurrence.monthOfYear=n.month}catch(u){Jx.log.exception("Error setting recurrence monthOfYear.",u);i=r(u)}return i}function y(n,t){var i=0;try{t.recurrence.dayOfMonth=n.day}catch(u){Jx.log.exception("Error setting recurrence dayOfMonth.",u);i=r(u)}return i}function d(i,e){var o=t.success,s,c;if(!i)return o;if(s=u.AppointmentRecurrenceUnit,c=n.RecurrenceType,e.recurring=true,i.until)e.recurrence.until=i.until;else if(i.occurrences>0)try{e.recurrence.occurrences=i.occurrences}catch(l){Jx.log.exception("Error setting occurrences",l);o=r(l)}switch(i.unit){case s.daily:e.recurrence.recurrenceType=c.daily;o=o||f(i,e);break;case s.weekly:e.recurrence.recurrenceType=c.weekly;o=o||f(i,e);break;case s.monthly:e.recurrence.recurrenceType=c.monthly;o=o||y(i,e);break;case s.monthlyOnDay:e.recurrence.recurrenceType=c.monthlyOnDay;o=o||f(i,e);o=o||a(i,e);break;case s.yearly:e.recurrence.recurrenceType=c.yearly;o=o||y(i,e);o=o||v(i,e);break;case s.yearlyOnDay:e.recurrence.recurrenceType=c.yearlyOnDay;o=o||f(i,e);o=o||a(i,e);o=o||v(i,e);break;default:Jx.log.error("Invalid recurrence type");o=t.errorInvalidRecurrenceType}try{e.recurrence.interval=i.interval}catch(p){Jx.log.exception("Error setting recurrence interval.",p);o=r(p)}return e.recurrence.firstDayOfWeek=h.firstDayOfWeek,o}function i(n,t,i){return n[t]!==i?(n[t]=i,true):false}var h=Calendar.Helpers,u=Windows.ApplicationModel.Appointments,n=Microsoft.WindowsLive.Platform.Calendar,t=n.Status,c=Calendar.ProviderHresult;Calendar.ProviderConverter=function(){this._organizerInfo=null;this._numAttendees=0};Calendar.ProviderConverter.prototype={_convertAttendees:function(n){this._numAttendees=n.length},convertToEvent:function(i,r,f){var nt,v,it;o("convertToEvent");var h=r.createEvent(),c=null,a,p,g,y=b(i.startTime,i.duration,i.allDay);if(y.startDate<Calendar.FIRST_DAY||Calendar.LAST_DAY<y.endDate){var tt=new Jx.DTFormatter("shortDate"),rt=tt.format(Calendar.FIRST_DAY),ut=tt.format(Calendar.LAST_DAY);c=Jx.res.loadCompoundString("ProviderErrorDate",rt,ut);a=c+" "+Jx.res.loadCompoundString("ProviderErrorDateLog",String(i.startTime),l(i.duration));p=y.startDate<Calendar.FIRST_DAY?t.errorEventDateTooSmall:t.errorEventDateTooLarge}else h.startDate=y.startDate,h.endDate=y.endDate,h.allDayEvent=i.allDay;return f&&(nt=d(i.recurrence,h),nt!==0&&(c=Jx.res.getString("ProviderErrorRecurrenceGeneric"),a=c+" "+e(i),p=nt)),h.subject=i.subject,h.location=i.location,g=i.reminder,h.reminder=Jx.isNumber(g)?l(g):-1,o("convertToEvent.toStaticHtml"),h.data=toStaticHTML(i.details),h.dataType=n.DataType.html,s("convertToEvent.toStaticHtml"),this._organizerInfo=k(i.organizer),this._organizerInfo.hasOrganizer&&(h.organizerName=this._organizerInfo.organizerName,h.organizerEmail=this._organizerInfo.organizerEmail),i.sensitivity===u.AppointmentSensitivity.private&&(h.sensitivity=n.Sensitivity.private),this._convertAttendees(i.invitees),h.busyStatus=w(i.busyStatus,null),h.responseRequested=!this._organizerInfo.hasOrganizer,Jx.isNonEmptyString(c)||(v=h.validate(),v!==t.success&&(it=v>=t.errorNotRecurring&&v<=-2058026416,v===t.errorExceptionsOverlap?(c=Jx.res.getString("ProviderErrorRecurrenceOverlap"),a=c+" "+e(i)):it&&i.recurrence?(c=Jx.res.getString("ProviderErrorRecurrenceGeneric"),a=c+" "+e(i)):(c=Jx.res.getString("ProviderErrorGeneric"),a=c),p=v)),Jx.isNonEmptyString(c)&&(h=null),s("convertToEvent"),{event:h,errorText:c,errorDetails:a,errorHresult:p}},updateBeforeSave:function(t,r,u){var f=null,y,w,e,b,h,o,k,d,l,a,v,s,g;if(f=u?u:r.createEvent(),y=f.eventType===n.EventType.instanceOfSeries||f.eventType===n.EventType.exceptionToSeries,w=u?u.isOrganizer:false,i(f,"startDate",t.startDate),i(f,"endDate",t.endDate),i(f,"allDayEvent",t.allDayEvent),i(f,"subject",t.subject),i(f,"location",t.location),i(f,"reminder",t.reminder),i(f,"data",t.data)&&(f.dataType=t.dataType),i(f,"sensitivity",t.sensitivity),y||(this._organizerInfo.hasOrganizer&&(f.organizerName=t.organizerName,f.organizerEmail=t.organizerEmail),f.responseRequested=t.responseRequested,f.recurring=t.recurring,t.recurring&&(f.recurrence.recurrenceType=t.recurrence.recurrenceType,f.recurrence.occurrences=t.recurrence.occurrences,f.recurrence.until=t.recurrence.until,f.recurrence.interval=t.recurrence.interval,f.recurrence.dayOfWeek=t.recurrence.dayOfWeek,f.recurrence.weekOfMonth=t.recurrence.weekOfMonth,f.recurrence.monthOfYear=t.recurrence.monthOfYear,f.recurrence.dayOfMonth=t.recurrence.dayOfMonth,f.recurrence.firstDayOfWeek=t.recurrence.firstDayOfWeek)),e=!this._organizerInfo.hasOrganizer,!e)for(b=f.organizerEmail.toUpperCase(),h=f.calendar.account.allEmailAddresses,o=0,k=h.length;o<k;o++)if(d=h[o].toUpperCase(),d===b){e=true;break}if(u&&e!==w){l=new Error("Cannot add or remove organizer using the provider");l.number=c.organizerChange;throw l}return e?(s=f.getAttendees(),g=s.count>0,s.dispose(),s=null,f.meetingStatus=g?n.MeetingStatus.isAMeeting:n.MeetingStatus.notAMeeting):(f.meetingStatus=n.MeetingStatus.meetingReceived,u||(a=f.calendar.account.preferredSendAsAddress,v=f.addAttendee(a,a),v.responseType=n.ResponseType.notResponded,v.attendeeType=n.AttendeeType.required)),f.busyStatus=p(t.busyStatus,f.calendar),f},getNumAttendees:function(){return this._numAttendees}}})