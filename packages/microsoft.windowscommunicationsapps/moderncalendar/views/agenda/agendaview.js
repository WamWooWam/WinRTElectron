Jx.delayDefine(Calendar.Views,"Agenda",function(){function r(n){Jx.mark("Calendar:Agenda."+n+",StartTA,Calendar")}function u(n){Jx.mark("Calendar:Agenda."+n+",StopTA,Calendar")}function s(n){Jx.mark("Calendar:Agenda."+n+",StartTM,Calendar")}function h(n){Jx.mark("Calendar:Agenda."+n+",StopTM,Calendar")}var i=Calendar.Views.AgendaHelpers,c=Microsoft.WindowsLive.Platform.Calendar.ErrorPriority,f=Calendar.Helpers,e=Calendar.Templates.Agenda,o=WinJS.UI.Animation,n=Calendar.Views.Agenda=function(){r("ctor");this.initComponent();this._id="calAgenda";this._firstRun=true;n._name||(f.ensureFormats(),i.ensureInitialized(),n._name="Calendar.Views.Agenda",n._backgroundError=Jx.res.getString("AgendaBackgroundError"),n._noEvents=Jx.res.getString("AgendaNoEvents"),n._seeMoreEvents=Jx.res.getString("AgendaSeeMoreEvents"),n._accAgendaAllDay={format:Jx.res.getFormatFunction("AccAgendaAllDay")},n._accAgendaAllDaySeeMore=Jx.res.getString("AccAgendaAllDaySeeMore"),n._allDayMore={format:Jx.res.getFormatFunction("AllDayMore")},n._dateWithDay=new Jx.DTFormatter("dayofweek month day"),n._dateWithDayAbbr=new Jx.DTFormatter("dayofweek.abbreviated month.abbreviated day"),n._monthWithYear=new Jx.DTFormatter("month year"));this._background=new Calendar.Views.AgendaBackground;this.append(this._background);this._now=Calendar.getMinute();this._today=i.getDayFromDate(this._now);this._state=null;this._idsCalendar=null;this._upNextHeroItem=null;this._layoutType=n.LayoutType.none;this._listView=null;this._getEventsCompleted=false;this._onAppBarBeforeShow=this._onAppBarBeforeShow.bind(this);this._onListItemInserted=this._onListItemInserted.bind(this);this._onListItemRemoved=this._onListItemRemoved.bind(this);this._onListViewLoadingStateChanged=this._onListViewLoadingStateChanged.bind(this);this._onListViewItemInvoked=this._onListViewItemInvoked.bind(this);this._onHeroDateInvoked=this._onHeroDateInvoked.bind(this);this._onHeroAllDayInvoked=this._onHeroAllDayInvoked.bind(this);this._uid=0;this._objectIdMap={};this._handleMap={};this._allDayMap={};u("ctor")},t;Jx.augment(n,Jx.Component);t=n.prototype;n.ItemAction={editEvent:0,createEvent:1,viewDay:2,viewMonth:3};n.LayoutType={none:0,horizontal:1,vertical:2};n._getLayoutType=function(t){return t>856?n.LayoutType.horizontal:n.LayoutType.vertical};n._getIndexOfItem=function(n,t){return t?n.indexOfKey(t.listKey):-1};n._getDateKey=function(n){var r=String(n.getFullYear()),t=String(n.getMonth()),i=String(n.getDate());return r+(t<10?"0"+t:t)+(i<10?"0"+i:i)};n._compareItems=function(n,t){var r,u,f;return(r=i.compareDates(n.startDate,t.startDate),r!==0)?r:(u=t.busyStatus-n.busyStatus,u!==0)?u:(f=i.compareDates(t.endDate,n.endDate),f!==0)?f:0};n._allDayCardSorter=function(n,t){var r,u,f,e;return(r=t.multiDay-n.multiDay,r!==0)?r:(u=i.compareDates(n.startDate,t.startDate),u!==0)?u:(f=t.busyStatus-n.busyStatus,f!==0)?f:(e=i.compareDates(n.endDate,t.endDate),e!==0)?e:0};n._itemSorter=function(t,r){var u,f;return t.allDayContainer||r.allDayContainer?(u=i.compareDates(t.startDate,r.startDate),u!==0)?u:(f=r.allDayContainer-t.allDayContainer,f!==0)?f:0:n._compareItems(t,r)};n._itemFilter=function(n){return!n.isHidden&&!n.isPast};n._getGroupKeyFromItem=function(n){return n.groupKey};n._groupKeySorter=function(n,t){return n.localeCompare(t)};t.setFocusedDay=function(n){this._today&&this._listView&&f.isSameDate(n,this._today)&&(this._listView.indexOfFirstVisible=0,this._listView.scrollPosition=0)};t.getFocusedDay=function(){var n,t;return this._listView&&(n=this._listView.indexOfFirstVisible,n>0)?(t=this._groupedList.getAt(n),i.getDayFromDate(t.startDate)):this._today};t.getState=function(){var n=this._listView,t;return n?(t=n.currentItem,delete t.key,{currentItem:t,indexOfFirstVisible:n.indexOfFirstVisible,scrollPosition:n.scrollPosition}):null};t.setState=function(n){this._state=n};t.focusEvent=function(n){this._eventToFocus=n};t.containsDate=function(n){var r,t,o,s;var u=this._rangeStart,f=this._rangeEnd,e=this._groupedList.length;return this._listView&&e>1&&(r=this._listView.indexOfFirstVisible,t=this._listView.indexOfLastVisible,r>0&&(o=this._groupedList.getAt(r),u=i.getDayFromDate(o.startDate)),t>0&&t<e-1&&(s=this._groupedList.getAt(t),f=i.getDayFromDate(s.startDate,1))),i.containsDate(u,f,n)};t.changeBackground=function(t){if(this._background){s("changeBackground");var i=this,r=this._appBar.getCommandById("backgroundCommand");r.disabled=true;this._backgroundChangePromise=this._background.changeAsync(t);this._backgroundChangePromise.then(null,function(t){if(t.name!=="Canceled"){Jx.log.exception("Error occurred while changing the background image",t);var r=i._getCalendarManager();r&&r.addCalendarError(n._backgroundError,c.high)}}).done(function(){i._backgroundChangePromise=null;r.disabled=false;h("changeBackground")})}};t.allowPeekBarTabVersion=function(){return this._layoutType!==n.LayoutType.vertical};t.getUI=function(n){n.html=e.host({id:this._id,background:Jx.getUI(this._background)})};t.activateUI=function(t){var e,f,s;r("activateUI");this._jobSet=t;this._listJobSet=t.createChild();this._host=document.getElementById(this._id);e=this._host.querySelector(".herocontainer");this._allDayHero=e.querySelector(".allday");this._timeline=this._host.querySelector(".timeline");f=this._dateContainer=e.querySelector(".date");f.addEventListener("click",this._onHeroDateInvoked,false);f.addEventListener("keydown",this._onHeroDateInvoked,false);this.on("resizeWindow",this._onWindowResize);this.on("viewReady",this._onViewReady);this._now=Calendar.getMinute();this._today=i.getDayFromDate(this._now);Calendar.addListener("minuteChanged",this._onMinuteChanged,this);this._worker=null;this._workerId=null;this._calendarManager=null;this._appBar=null;s={};this.fire("getPeekBar",s);this._peekBar=s.peekBar;this._peekBar.isTabMode()&&this._onPeekBarTab();this._todayGroupKey=null;this._todayAllDayContainer=null;var h=this._list=new WinJS.Binding.List,c=this._sortedList=h.createSorted(n._itemSorter),l=this._filteredList=c.createFiltered(n._itemFilter);this._groupedList=l.createGrouped(n._getGroupKeyFromItem,this._getGroupHeader.bind(this),n._groupKeySorter);h.addEventListener("iteminserted",this._onListItemInserted);h.addEventListener("itemremoved",this._onListItemRemoved);this._background.activateUI(t.createChild());document.body.classList.add("darkBg");this.on("peekBarFull",this._onPeekBarFull);this.on("peekBarTab",this._onPeekBarTab);this._ensureLayout(window.outerWidth);o.fadeIn(f).then(function(){f.style.opacity=""});u("activateUI")};t.deactivateUI=function(){r("deactivateUI");document.body.classList.remove("darkBg");this.detach("peekBarFull",this._onPeekBarFull);this.detach("peekBarTab",this._onPeekBarTab);this._backgroundChangePromise&&(this._backgroundChangePromise.cancel(),this._backgroundChangePromise=null);this._background&&(this._background.shutdownUI(),this._background=null);this._worker&&(this._cancelWorker(),this._worker.removeListener("Agenda/eventsChanged",this._onEventsChanged,this),this._worker.removeListener("Agenda/getEvents",this._onGetEvents,this),this._worker=null);r("deactivateUI:_listView");this._listView&&(this._listView.removeEventListener("loadingstatechanged",this._onListViewLoadingStateChanged),this._listView.removeEventListener("iteminvoked",this._onListViewItemInvoked),this._listView.itemDataSource=null,this._listView.groupDataSource=null,this._listView.dispose(),this._listView=null);this._listViewGridLayout=null;this._listViewListLayout=null;u("deactivateUI:_listView");r("deactivateUI:_appBar");this._appBar&&(this._appBar.removeEventListener("beforeshow",this._onAppBarBeforeShow),this._appBar.hideCommands(["backgroundCommand"]),this._appBar=null);this._peekBar=null;u("deactivateUI:_appBar");r("deactivateUI:_list");this._groupedList&&(this._groupedList.dispose(),this._groupedList=null);this._filteredList&&(this._filteredList.dispose(),this._filteredList=null);this._sortedList&&(this._sortedList.dispose(),this._sortedList=null);this._list&&(this._list.removeEventListener("iteminserted",this._onListItemInserted),this._list.removeEventListener("itemremoved",this._onListItemRemoved),this._clearList(),this._list=null);this._objectIdMap=null;this._handleMap=null;this._allDayMap=null;u("deactivateUI:_list");this._heroAnimationPromise&&(this._heroAnimationPromise.cancel(),this._heroAnimationPromise=null);this._jobSet&&(this._jobSet.cancelAllChildJobs(),this._jobSet=null);this._listJobSet=null;this._cancelDeferredWork();this.detach("viewReady",this._onViewReady);this.detach("resizeWindow",this._onWindowResize);Calendar.removeListener("minuteChanged",this._onMinuteChanged,this);this._dateContainer.removeEventListener("click",this._onHeroDateInvoked,false);this._dateContainer.removeEventListener("keydown",this._onHeroDateInvoked,false);this._today=null;this._now=null;this._rangeStart=null;this._rangeEnd=null;this._upNextHeroItem=null;this._idsCalendar=null;this._todayGroupKey=null;this._calendarManager=null;this._state=null;this._timeline=null;this._host=null;this._todayAllDayContainer=null;u("deactivateUI")};t._getIdsCalendar=function(){return this._idsCalendar||(this._idsCalendar=Microsoft.WindowsLive.Instrumentation.Ids.Calendar),this._idsCalendar};t._onViewReady=function(n){var t,i;this._firstRun&&n.stage===Jx.EventManager.Stages.bubbling&&(this._firstRun=false,t=this._deferredWork=this.queryService("deferredWork"),t&&(i=People.Priority.launch,t.queue("AgDateRange",50,i,this._updateDateRange,this),t.queue("AgListView",50,i,this._ensureListView,this),t.queue("AgAppBar",50,i,this._ensureAppBar,this)))};t._cancelDeferredWork=function(){var n=this._deferredWork,t;n&&(t=People.Priority.launch,n.queue("AgDateRange",12,t,Jx.fnEmpty,null),n.queue("AgListView",12,t,Jx.fnEmpty,null),n.queue("AgAppBar",12,t,Jx.fnEmpty,null));this._deferredWork=null};t._ensureWorker=function(){if(!this._worker){var n={};this.fire("getPlatformWorker",n);this._worker=n.platformWorker;this._worker.addListener("Agenda/eventsChanged",this._onEventsChanged,this);this._worker.addListener("Agenda/getEvents",this._onGetEvents,this)}};t._ensureAppBar=function(){if(r("_ensureAppBar"),!this._appBar&&this._host){var n={};this.fire("getAppBar",n);this._appBar=n.appBar;this._appBar&&(this._appBar.addEventListener("beforeshow",this._onAppBarBeforeShow),this._appBar.showCommands(["backgroundCommand"]))}u("_ensureAppBar")};t._ensureLayout=function(t){r("_ensureLayout");var f=this._layoutType,i=n._getLayoutType(t),e=false;f!==i&&(this._layoutType=i,e=f!==n.LayoutType.none,this._updateDateHeader(i),this._updatePeekBar(i));this._updateListViewLayout(i,e);u("_ensureLayout")};t._ensureListView=function(){if(r("_ensureListView"),!this._listView&&this._host){var n=this._listView=new WinJS.UI.ListView(this._timeline);n.selectionMode=WinJS.UI.SelectionMode.none;n.groupHeaderTapBehavior=WinJS.UI.GroupHeaderTapBehavior.none;n.itemTemplate=this._onListViewItemTemplate.bind(this);n.groupHeaderTemplate=this._onListViewGroupHeaderTemplate.bind(this);this._listViewGridLayout=new WinJS.UI.GridLayout;this._listViewListLayout=new WinJS.UI.ListLayout;n.addEventListener("loadingstatechanged",this._onListViewLoadingStateChanged);n.addEventListener("iteminvoked",this._onListViewItemInvoked);this._updateListViewLayout(this._layoutType)}u("_ensureListView")};t._connectDataSource=function(){var n=this._listView,t=this._groupedList;n.itemDataSource=t.dataSource;n.groupDataSource=t.groups.dataSource};t._getCalendarManager=function(){if(r("_getCalendarManager"),!this._calendarManager&&this.hasUI()){var n={};this.fire("getPlatform",n);this._calendarManager=n.platform.calendarManager}return u("_getCalendarManager"),this._calendarManager};t._updateDateHeader=function(t){r("_updateDateHeader");this._dateContainer.textContent=t===n.LayoutType.horizontal?n._dateWithDay.format(this._today):n._dateWithDayAbbr.format(this._today);u("_updateDateHeader")};t._updatePeekBar=function(t){r("_updatePeekBar");this._peekBar&&this._peekBar.allowTabVersion(t===n.LayoutType.horizontal);u("_updatePeekBar")};t._updateListViewLayout=function(t,i){if(r("_updateListViewLayout"),this._listView){var f;this._updatePillarItems();t===n.LayoutType.horizontal?(this._maxAllDayItems=5,f=this._listViewGridLayout):(this._maxAllDayItems=4,f=this._listViewListLayout);this._listViewCurrentLayout!==f?(this._listViewCurrentLayout=f,this._listViewSetActiveItem=i,this._listViewUpdateScheduled||(this._listViewUpdateScheduled=true,this._focusListItemReady=false,this._jobSet.addUIJob(this,this._applyListViewLayout,null,People.Priority.perfLowFidelity))):this._listView.recalculateItemPosition()}u("_updateListViewLayout")};t._applyListViewLayout=function(){this._listViewUpdateScheduled=false;this._listView.layout=this._listViewCurrentLayout;this._listViewSetActiveItem&&this._setActiveItem()};t._updateDateRange=function(){var t,e,f;r("_updateDateRange");this._today&&(t=this._today,this._rangeStart&&this._rangeStart-t==0||(this._rangeStart=t,e=this._rangeEnd=i.getDayFromDate(t,61),this._listJobSet.cancelAllChildJobs(),f=this._groupedList.dataSource,f.beginEdits(),this._clearList(),this._todayGroupKey=n._getDateKey(this._today),this._createPillarItems(),f.endEdits(),this._ensureWorker(),this._workerId=this._worker.postCommand("Agenda/getEvents",{start:t.getTime(),end:e.getTime(),isVisible:true}),this._updateDateHeader(this._layoutType)));u("_updateDateRange")};t._cancelWorker=function(){r("_cancelWorker");this._workerId&&(this._worker.postCommand("Agenda/cancel",null,this._workerId),this._workerId=null);u("_cancelWorker")};t._clearList=function(){r("_clearList");this._cancelWorker();this._getEventsCompleted=false;var n=this._list;n.splice(0,n.length);this._noEventsItem=null;this._seeMoreEventsItem=null;this._objectIdMap={};this._handleMap={};this._allDayMap={};this._uid=0;this._scheduleAllDayHeroUpdate(true);u("_clearList")};t._notifyMutated=function(t){var i=this._list,r=n._getIndexOfItem(i,t);i.notifyMutated(r)};t._setAt=function(t,i){var r=this._list,u=n._getIndexOfItem(r,i);r.setAt(u,i)};t._addEventToList=function(n){r("_addEventToList");var t=n.items;t.length>0?(this._objectIdMap[n.objectId]=n,this._handleMap[n.handle]=n,t.forEach(this._addListItem,this)):Jx.log.warning("Agenda::_addEventToList - event contained no usable pieces: "+n.handle);u("_addEventToList")};t._removeEventFromList=function(n){r("_removeEventFromList");var t=this._objectIdMap[n];t?(delete this._objectIdMap[t.objectId],delete this._handleMap[t.handle],t.items.forEach(this._removeListItem,this)):Jx.log.warning("Agenda::_removeEventFromList - objectId not found: "+n);u("_removeEventFromList")};t._replaceEventInList=function(n){var o,l,s,h,c;if(r("_replaceEventInList"),o=n.objectId,l=this._objectIdMap[o],l)if(l.showInAllDayCard^n.showInAllDayCard)this._removeEventFromList(o),this._addEventToList(n);else if(s=n.items,s.length===0)this._removeEventFromList(o);else{for(var a=l.items,t=0,e=0,v=a.length,y=s.length;t<v&&e<y;)h=a[t],c=s[e],f.isSameDate(h.startDate,c.startDate)?(this._replaceListItem(h,c),t++,e++):i.compareDates(h.startDate,c.startDate)<0?(this._removeListItem(h),t++):(this._addListItem(c),e++);while(t<v)this._removeListItem(a[t]),t++;while(e<y)this._addListItem(s[e]),e++;this._objectIdMap[o]=n;this._handleMap[n.handle]=n}else Jx.log.warning("Agenda::_replaceEventInList - objectId not found: "+o);u("_replaceEventInList")};t._addListItem=function(t){var o,u,r,e,f;o=this._list;t.showInAllDayCard?(u=t.groupKey,r=this._allDayMap[u],Jx.isObject(r)||(e=i.getDayFromDate(t.startDate),r={action:n.ItemAction.viewDay,allDayContainer:true,groupKey:u,isHidden:false,isPast:false,listKey:null,startDate:e,endDate:i.getDayFromDate(e,1),label:i.getDateString(this._today,e),allDayLabelFormat:n._accAgendaAllDay,allDayMoreFormat:n._allDayMore,allDayMoreLabel:n._accAgendaAllDaySeeMore,items:[]},this._allDayMap[u]=r),f=r.items,f.push(t),f.sort(n._allDayCardSorter),f.length>1?(r.action=n.ItemAction.viewDay,r.handle=null):(r.action=n.ItemAction.editEvent,r.handle=f[0].handle),u===this._todayGroupKey?this._scheduleAllDayHeroUpdate(true):r.listKey?this._setAt(r.listKey,r):o.push(r)):o.push(t)};t._removeListItem=function(t){var f,u,e,i,r;f=this._list;t.showInAllDayCard?(e=t.groupKey,i=this._allDayMap[e],r=i.items,u=r.indexOf(t),r.splice(u,1),r.length>1?(i.action=n.ItemAction.viewDay,i.handle=null):r.length>0?(i.action=n.ItemAction.editEvent,i.handle=r[0].handle):delete this._allDayMap[e],e===this._todayGroupKey?this._scheduleAllDayHeroUpdate(true):r.length>0?this._setAt(i.listKey,i):(u=n._getIndexOfItem(f,i),f.splice(u,1))):(u=n._getIndexOfItem(f,t),f.splice(u,1))};t._replaceListItem=function(n,t){var o,f,i,e,s;r("_replaceListItem");n.showInAllDayCard?(f=t.groupKey,i=this._allDayMap[f],e=i.items,s=e.indexOf(n),e.splice(s,1,t),f===this._todayGroupKey?this._scheduleAllDayHeroUpdate(true):this._setAt(i.listKey,i)):(o=t.listKey=n.listKey,n.listKey=null,this._setAt(o,t));u("_replaceListItem")};t._ensurePastItemsHidden=function(){var f,t,e,n;for(r("_ensurePastItemsHidden"),f=this._sortedList,t=0,e=f.length;t<e;t++){if(n=f.getAt(t),i.compareDates(n.startDate,this._now)>=0)break;(n.isPast||i.compareDates(n.endDate,this._now)<=0)&&(n.isPast||(n.isPast=true,this._notifyMutated(n)))}u("_ensurePastItemsHidden")};t._updateConflicts=function(t,f){var y,l,p,a,w,o,s,v;r("_updateConflicts");var e=this._sortedList,h=0,c=e.length;if(Jx.isDate(t)&&(y=this._itemByDate(i.getDayFromDate(t)),l=n._getIndexOfItem(e,y),l>=0&&(h=l)),Jx.isDate(f)&&(p=this._itemByDate(i.getDayFromDate(f,1)),a=n._getIndexOfItem(e,p),a>=0&&(c=a)),h<c)for(w=this._findConflicts(h,c),o=h;o<c;o++)s=e.getAt(o),v=Boolean(w[s.uid]),v!==s.conflict&&(s.conflict=v,e.setAt(o,s));u("_updateConflicts")};t._itemByDate=function(n){var r,t,f,u;for(r=this._sortedList,t=0,f=r.length;t<f;t++)if(u=r.getAt(t),i.compareDates(n,u.startDate)<=0)return u;return null};t._findConflicts=function(n,t){var f,i,s,h;r("_findConflicts");var l=this._sortedList,e={},c=-1,o=0;for(f=n;f<t;f++)i=l.getAt(f),i.isPast||i.allDayContainer||i.textContainer||(s=i.uid,h=i.endDate.getTime(),i.startDate.getTime()<o&&(e[c]=true,e[s]=true),o<h&&(c=s,o=h));return u("_findConflicts"),e};t._createPillarItems=function(){var t=i.getDayFromDate(this._rangeStart,0);this._noEventsItem={action:n.ItemAction.createEvent,busyStatus:0,endDate:i.getDayFromDate(t,1),isHidden:true,isPast:false,multiDay:false,startDate:t,infoHtml:Jx.escapeHtml(n._noEvents),allDayContainer:false,textContainer:true,showInAllDayCard:false,groupKey:n._getDateKey(t),listKey:null};t=i.getDayFromDate(this._rangeEnd,0);this._seeMoreEventsItem={action:n.ItemAction.viewMonth,busyStatus:0,endDate:i.getDayFromDate(t,1),isHidden:true,isPast:false,multiDay:false,startDate:t,infoHtml:Jx.escapeHtml(n._seeMoreEvents),allDayContainer:false,textContainer:true,showInAllDayCard:false,groupKey:n._getDateKey(t),listKey:null};this._addListItem(this._noEventsItem);this._addListItem(this._seeMoreEventsItem)};t._updatePillarItems=function(){var t,n;if(r("_updatePillarItems"),t=this._noEventsItem,n=this._seeMoreEventsItem,t&&n){var f=t.isHidden,e=n.isHidden,i=this._groupedList.length;f||i--;e||i--;i>0?(t.isHidden=true,n.isHidden=false):(t.isHidden=false,n.isHidden=true);this._isCompanion()&&(n.isHidden=true);f!==t.isHidden&&this._notifyMutated(t);e!==n.isHidden&&this._notifyMutated(n)}u("_updatePillarItems")};t._isCompanion=function(){return this._parent?this._parent.isCompanion():false};t._setActiveItem=function(){var f,e,t;if(this._getEventsCompleted){var i,r=false,u=this._eventToFocus,o=this._state;this._eventToFocus=null;this._state=null;u?(f=this._groupedList,e=this._handleMap[u.handle],Jx.isObject(e)?(t=e.items[0],t.showInAllDayCard&&(t=this._allDayMap[t.groupKey]),t.allDayContainer&&t.groupKey===this._todayGroupKey?(this._focusAllDayHero(),r=true):(i=n._getIndexOfItem(f,t),i>=0&&(this._focusListItem(i,true),r=true))):(i=0,t=this._itemByDate(u.startDate),i=n._getIndexOfItem(f,t)-1,i<0&&(i=0),this._focusListItem(i,true),r=true)):o&&(this._applyListState(o),r=true);r||this._focusListItem(0,true)}};t._applyListState=function(n){var t=this._listView;t.indexOfFirstVisible=n.indexOfFirstVisible;t.scrollPosition=n.scrollPosition;t.currentItem=n.currentItem};t._focusListItem=function(n,t){this._focusListItemReady?(this._pendingFocusListItem=false,this._pendingFocusListItemFn=null,this._listView.currentItem={index:n,hasFocus:true},t?this._listView.indexOfFirstVisible=n:this._listView.ensureVisible(n)):(this._pendingFocusListItem=true,this._pendingFocusListItemFn=this._focusListItem.bind(this,n,t))};t._focusAllDayHero=function(){this._todayAllDayContainer?(this._shouldFocusAllDayHero=false,Jx.safeSetActive(this._todayAllDayContainer)):this._shouldFocusAllDayHero=true};t._updateAllDayHero=function(){var f,c,u;s("_updateAllDayHero");f=this._allDayHeroUpdateForced;this._allDayHeroUpdateForced=false;this._allDayHeroUpdateScheduled=false;var n=null,t=null,r=this._allDayMap[this._todayGroupKey];r?(c=this._updateAllDayItems(r),(c||f)&&(n=this._todayAllDayContainer,this._todayAllDayContainer=null,r.isHidden||(t=this._todayAllDayContainer=e.item({item:r,maxAllDay:3}),t.setAttribute("role","link"),t.tabIndex=0,i.registerInteractiveHandlers(t),t.addEventListener("click",this._onHeroAllDayInvoked,"false"),t.addEventListener("keydown",this._onHeroAllDayInvoked,"false")))):(n=this._todayAllDayContainer,this._todayAllDayContainer=null);n&&(n.removeEventListener("click",this._onHeroAllDayInvoked,"false"),n.removeEventListener("keydown",this._onHeroAllDayInvoked,"false"),i.unregisterInteractiveHandlers(n),n.tabIndex=-1);this._heroAnimationPromise&&(this._heroAnimationPromise.cancel(),this._heroAnimationPromise=null);t?(this._allDayHero.appendChild(t),this._heroAnimationPromise=n?o.crossFade(t,n):o.fadeIn(t)):this._heroAnimationPromise=n?o.fadeOut(n):WinJS.Promise.wrap();u=this;this._heroAnimationPromise.done(function(){t&&(t.style.opacity="",u._shouldFocusAllDayHero&&u._focusAllDayHero());n&&u._allDayHero.removeChild(n);h("_updateAllDayHero")})};t._scheduleAllDayHeroUpdate=function(n){this._allDayHeroUpdateForced=this._allDayHeroUpdateForced||n;this._allDayHeroUpdateScheduled||(this._allDayHeroUpdateScheduled=true,this._listJobSet.addUIJob(this,this._updateAllDayHero,null,People.Priority.perfLowFidelity))};t._updateHeroItems=function(){var e,c,n;r("_updateHeroItems");var s=this._sortedList,h=false,t=this._upNextHeroItem;for(this._upNextHeroItem=null,t&&(t.isHero=false),e=0,c=s.length;e<c;e++)if(n=s.getAt(e),!n.textContainer&&!n.allDayContainer&&!n.isPast){var o=n.startDate,l=f.getDayInfo(this._now,o),a=new Date(o.getTime()-15*f.minuteInMilliseconds);if(i.compareDates(a,this._now)<=0)i.compareDates(o,this._now)>0&&(h=true),this._updateHeroItem(n,true);else if(!h&&l.isToday){this._upNextHeroItem=n;this._updateHeroItem(n,true);break}else break}t&&t.listKey&&!t.isHero&&this._updateHeroItem(t,false);u("_updateHeroItems")};t._updateHeroItem=function(n,t){r("_updateHeroItem");var f=n.heroTextHtml,e=t?i.getHeroHeader(this._now,n):"",o=i.getEventLabel(n.event,n,this._now,t);n.isHero=t;n.heroTextHtml=Jx.escapeHtml(e);n.label=o;f!==n.heroTextHtml&&this._setAt(n.listKey,n);u("_updateHeroItem")};t._updateAllDayItems=function(n){var t,e,i;var r=false,u=false,f=n.items;for(t=0,e=f.length;t<e;t++)i=f[t],i.isPast||(i.endDate-this._now<=0?(r=true,i.isPast=true):u=true);return n.isHidden=!u,r};t._invokeItem=function(t,i){switch(t.action){case n.ItemAction.editEvent:f.editEvent(this,t.handle,i);break;case n.ItemAction.createEvent:this.fire("createEvent");break;case n.ItemAction.viewDay:this.fire("dayChosen",t.startDate);break;case n.ItemAction.viewMonth:this._isCompanion()||(Jx.bici.addToStream(this._getIdsCalendar().calendarAgendaShowMore,this._groupedList.length),this.fire("monthChosen",t.startDate))}};t._hydrateChangeInfo=function(t){var e,f,o,i;for(r("_hydrateChangeInfo"),t.startDate=new Date(t.startDate),t.endDate=new Date(t.endDate),e=t.items,f=0,o=e.length;f<o;f++)i=e[f],i.uid=this._uid++,i.event=t,i.startDate=new Date(i.startDate),i.endDate=new Date(i.endDate),i.handle=t.handle,i.action=n.ItemAction.editEvent,i.conflict=false,i.isHero=false,i.heroTextHtml="",i.groupKey=n._getDateKey(i.startDate),i.listKey=null,i.showInAllDayCard=t.showInAllDayCard,i.allDayContainer=false,i.isHidden=false,i.isPast=false;u("_hydrateChangeInfo")};t._onEventsChanged=function(n){var e,o,f,h,s,t;if(this._workerId===n.id){for(r("_onEventsChanged"),e=this._groupedList.dataSource,e.beginEdits(),o=n.changes,f=0,h=o.length;f<h;f++){s=o[f];t=s.info;switch(s.type){case i.ChangeType.add:this._hydrateChangeInfo(t);this._addEventToList(t);break;case i.ChangeType.change:this._hydrateChangeInfo(t);this._replaceEventInList(t);break;case i.ChangeType.remove:this._removeEventFromList(t.objectId)}}this._ensurePastItemsHidden();this._updateHeroItems();this._updatePillarItems();e.endEdits();this._listJobSet.addUIJob(this,this._updateConflicts,null,People.Priority.perfHighFidelity);u("_onEventsChanged")}};t._onGetEvents=function(n){this._workerId===n.id&&(r("_onGetEvents"),this._getEventsCompleted=true,this._ensureListView(),this._connectDataSource(),this._setActiveItem(),u("_onGetEvents"))};t._onMinuteChanged=function(n){r("_onMinuteChanged");var t=this._now;this._now=n;f.isSameDate(t,this._now)?(this._ensurePastItemsHidden(),this._scheduleAllDayHeroUpdate(false),this._updateHeroItems(),this._updatePillarItems(),this._listJobSet.addUIJob(this,this._updateConflicts,[this._now,this._now],People.Priority.perfHighFidelity)):(this._today=i.getDayFromDate(n),this._jobSet.addUIJob(this,this._updateDateRange,null,People.Priority.perfLowFidelity));u("_onMinuteChanged")};t._onWindowResize=function(n){this._ensureLayout(n.data.outerWidth)};t._getGroupHeader=function(t){var r=i.getDayFromDate(t.startDate),u={date:r,text:null};return u.text=r.getTime()<this._rangeEnd.getTime()?i.getDateString(this._today,r):n._monthWithYear.format(r),u};t._onListItemInserted=function(n){var t=n.detail.value;t.listKey=n.detail.key};t._onListItemRemoved=function(n){var t=n.detail.value;t.listKey=null};t._onListViewItemTemplate=function(n){var t=this;return n.then(function(n){return e.item({item:n.data,maxAllDay:t._maxAllDayItems})})};t._onListViewGroupHeaderTemplate=function(n){return n.then(function(n){return e.groupHeader(n)})};t._onListViewLoadingStateChanged=function(){this._listView.loadingState==="complete"?(this._listViewLoadingItems=false,h("_listViewLoadingItems"),this._focusListItemReady=true,this._pendingFocusListItem&&this._pendingFocusListItemFn()):this._listViewLoadingItems||(this._listViewLoadingItems=true,s("_listViewLoadingItems"))};t._onListViewItemInvoked=function(n){var t=this;n.detail.itemPromise.done(function(i){t._invokeItem(i.data,n.target)})};t._onAppBarBeforeShow=function(){var n=this._appBar.getCommandById("backgroundCommand");n.hidden=false};t._onHeroDateInvoked=function(n){this._listView&&(Jx.isUndefined(n.keyCode)||n.keyCode===Jx.KeyCode.space||n.keyCode===Jx.KeyCode.enter)&&(this._listView.indexOfFirstVisible=0,this._listView.scrollPosition=0,this._listView.currentItem={index:0,hasFocus:true})};t._onHeroAllDayInvoked=function(n){if(Jx.isUndefined(n.keyCode)||n.keyCode===Jx.KeyCode.space||n.keyCode===Jx.KeyCode.enter){var t=this._allDayMap[this._todayGroupKey];this._invokeItem(t,n.currentTarget)}};t._onPeekBarFull=function(){this._timeline.classList.add("peekBarSpace")};t._onPeekBarTab=function(){this._timeline.classList.remove("peekBarSpace")}})