(function(){function f(n){Jx.mark("Calendar:AgendaWorker."+n+",Info,Calendar")}function t(n){Jx.mark("Calendar:AgendaWorker."+n+",StartTA,Calendar")}function i(n){Jx.mark("Calendar:AgendaWorker."+n+",StopTA,Calendar")}var r=Calendar.Views.AgendaHelpers,e=Microsoft.WindowsLive.Platform.CollectionChangeType,u=Calendar.Views.AgendaWorker=function(n,t,i){this._router=n;this._scheduler=t;this._manager=i;this._requests={};this._router.route("Agenda/getEvents",this.getEvents,this);this._router.route("Agenda/cancel",this.cancel,this);u._allAgendaMore||r.ensureInitialized()},n=u.prototype;u.SEND_WAIT_TIME=1e3;u.MAX_QUEUE_LENGTH=50;n.getEvents=function(n){t("getEvents");var u=n.id,r=n.data;r.id=u;r.start=new Date(r.start);r.end=new Date(r.end);r.changeQueue=[];r.eventMap={};r.collection=this._manager.getEvents(r.start,r.end);r.job=this._scheduler.schedule(this._processEvents,this,[r],true);this._requests[u]=r;i("getEvents")};n.cancel=function(n){t("cancel");var u=n.id,r=this._requests[u];r&&(this._scheduler.cancel(r.job),r.job=null,r.changeTimeout&&(clearTimeout(r.changeTimeout),r.changeTimeout=null),this._unhookEvents(r),r.onCollectionChanged&&(r.collection.removeEventListener("collectionchanged",r.onCollectionChanged),r.onCollectionChanged=null),r.collection.dispose(),r.collection=null,r.changeQueue=null,r.eventMap=null,delete this._requests[n.id]);i("cancel")};n.dispose=function(){Object.keys(this._requests).forEach(function(n){this.cancel({id:n})},this);this._requests=null;this._manager=null;this._scheduler=null;this._router=null};n._processEvents=function(n){var u,s,e,o,h;for(t("_processEvents"),u=n.collection,s=u.count,e=0;e<s;e++)o=u.item(e),o&&(h=r.wrapEvent(n.start,n.end,o),this._enqueueChange(n,r.ChangeType.add,h),this._hookEvent(n,o));f("_processEvents:count="+s);this._sendChanges(n);n.onCollectionChanged=this._onCollectionChanged.bind(this,n);u.addEventListener("collectionchanged",n.onCollectionChanged);u.unlock();this._sendGetEvents(n);i("_processEvents")};n._enqueueChange=function(n,r,f){t("_enqueueChange");n.changeQueue.push({type:r,info:f});n.changeTimeout||(n.changeTimeout=setTimeout(this._sendChanges.bind(this,n),u.SEND_WAIT_TIME));n.changeQueue.length>=u.MAX_QUEUE_LENGTH&&this._sendChanges(n);i("_enqueueChange")};n._sendChanges=function(n){t("_sendChanges");n.changeTimeout&&(clearTimeout(n.changeTimeout),n.changeTimeout=null);f("_sendChanges:queueLength="+n.changeQueue.length);this._router.postMessage({command:"Agenda/eventsChanged",id:n.id,changes:n.changeQueue});n.changeQueue=[];i("_sendChanges")};n._sendGetEvents=function(n){t("_sendGetEvents");this._router.postMessage({command:"Agenda/getEvents",id:n.id});i("_sendGetEvents")};n._hookEvent=function(n,r){t("_hookEvent");n.onItemChanged||(n.onItemChanged=this._onItemChanged.bind(this,n));r.addEventListener("changed",n.onItemChanged);n.eventMap[r.objectId]=r;i("_hookEvent")};n._unhookEvents=function(n){t("_unhookEvents");Object.keys(n.eventMap).forEach(function(t){this._unhookEvent(n,t)},this);n.onItemChanged=null;i("_unhookEvents")};n._unhookEvent=function(n,r){t("_unhookEvent");var u=n.eventMap[r];delete n.eventMap[r];u&&u.removeEventListener("changed",n.onItemChanged);i("_unhookEvent")};n._onCollectionChanged=function(n,t){var i,u,o,f;switch(t.eType){case e.itemAdded:i=t.target;i.lock();u=i.item(t.index);u&&(o=r.wrapEvent(n.start,n.end,u),this._enqueueChange(n,r.ChangeType.add,o),this._hookEvent(n,u));i.unlock();break;case e.itemRemoved:f=t.objectId;this._unhookEvent(n,f);this._enqueueChange(n,r.ChangeType.remove,{objectId:f})}};n._onItemChanged=function(n,t){var u,i,f,e,o;for(u=t.detail[0],i=0,f=u.length;i<f;i++)switch(u[i]){case"startDate":case"endDate":case"busyStatus":case"allDayEvent":case"subject":case"location":case"color":e=t.target;o=r.wrapEvent(n.start,n.end,e);this._enqueueChange(n,r.ChangeType.change,o);return}}})()