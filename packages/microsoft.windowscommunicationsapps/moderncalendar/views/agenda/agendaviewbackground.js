Jx.delayDefine(Calendar.Views,"AgendaBackground",function(){function i(n){Jx.mark("Calendar:AgendaBackground."+n+",StartTA,Calendar")}function r(n){Jx.mark("Calendar:AgendaBackground."+n+",StopTA,Calendar")}function u(n){Jx.mark("Calendar:AgendaBackground."+n+",StartTM,Calendar")}function f(n){Jx.mark("Calendar:AgendaBackground."+n+",StopTM,Calendar")}var s=Calendar.Templates.Agenda,l=WinJS.UI.Animation,h=Windows.Storage.ApplicationData,e=Windows.Graphics.Imaging.BitmapDecoder,o=Windows.Graphics.Imaging.BitmapEncoder,c=Windows.Storage.CreationCollisionOption,n=Calendar.Views.AgendaBackground=function(){this.initComponent();this._id="calAgendaBackground";n._name||(n._name="Calendar.Views.AgendaBackground",n._pickerCommitButton=Jx.res.getString("AgendaBackgroundPickerButton"),n._shortEdgeLength=1920,n._settingName="agendaBackground",n._localFolderUriBase="ms-appdata:///local/",n._folderName="CalBackground",n._fileName="Background",n._fileNameCount=0,n._extJpeg="jpg",n._extPng="png",n._default="/moderncalendar/views/agenda/Background.jpg",n._cacheImage=null)},t;Jx.augment(n,Jx.Component);t=n.prototype;n._getSupportedFileExtensions=function(){i("_getSupportedFileExtensions");var n=[],t=e.getDecoderInformationEnumerator();return t.forEach(function(t){t.fileExtensions.forEach(function(t){n.push(t)},this)},this),r("_getSupportedFileExtensions"),n};t.getUI=function(n){n.html=s.backgroundContainer({id:this._id})};t.activateUI=function(n){var t,u;i("activateUI");this._jobSet=n;t={};this.fire("getSettings",t);this._settings=t.settings;u=this._host=document.getElementById(this._id);this._progress=u.querySelector(".backgroundprogress");this._hideProgress();this._backgroundUri=null;this._backgroundElement=null;n.addUIJob(this,this._load,null,People.Priority.perfLowFidelity);r("activateUI")};t.deactivateUI=function(){i("deactivateUI");this._jobSet.cancelAllChildJobs();Jx.dispose(this._jobSet);this._jobSet=null;this._changePromise&&(this._changePromise.cancel(),this._changePromise=null);this._backgroundUri=null;this._settings=null;this._backgroundElement=null;this._progress=null;this._host=null;r("deactivateUI")};t.changeAsync=function(t){var i=this;return this._changePromise=t?this._changeAsync(n._default).then(this._cleanUpBackgrounds.bind(this)):this._browse().then(function(n){return i._showProgress(),i._process(n)}).then(function(n){return i._hideProgress(),n?i._changeAsync(n):void 0},function(n){return i._hideProgress(),WinJS.Promise.wrapError(n)}),this._changePromise};t._getSetting=function(){return this._settings.get(n._settingName)};t._setSetting=function(t){t!==n._default?this._settings.set(n._settingName,t):this._settings.remove(n._settingName)};t._load=function(){var t=this._getSetting();t?(this._changePromise=this._changeAsync(t),this._changePromise.done()):(this._changePromise=this._changeAsync(n._default),this._changePromise.done())};t._changeAsync=function(t){var e,r,o,i;return u("_changeAsync"),e=this,this._backgroundUri!==t?(this._backgroundUri=t,this._setSetting(this._backgroundUri),o=this._backgroundElement,i=this._backgroundElement=s.background(),t===n._default&&i.classList.add("backgroundDefault"),i.style.opacity=0,i.style.backgroundImage='url("'+t+'")',this._host.appendChild(i),r=this._loadImageAsync(t).then(function(){return e._animate(i,o)})):r=WinJS.Promise.wrap(null),r.then(function(){f("_changeAsync")})};t._loadImageAsync=function(t){var i,r;return new WinJS.Promise(function(u){i=n._cacheImage=new Image;r=function(){i&&r&&(i.removeEventListener("load",r),i.removeEventListener("error",r),r=null);setImmediate(function(){u()})};i.addEventListener("load",r);i.addEventListener("error",r);i.src=t},function(){i&&r&&(i.removeEventListener("load",r),i.removeEventListener("error",r),r=null,i=null)})};t._showProgress=function(){this._progress.style.display=""};t._hideProgress=function(){this._progress&&(this._progress.style.display="none")};t._animate=function(n,t){u("_animate");n.style.zIndex=2;t&&(t.style.zIndex=1);var i=this;return l.fadeIn(n).then(function(){i._animationPromise=null;t&&i._host.removeChild(t);f("_animate");i.fire("viewReady")})};t._browse=function(){var i=n._getSupportedFileExtensions(),t=new Windows.Storage.Pickers.FileOpenPicker;return t.commitButtonText=n._pickerCommitButton,t.fileTypeFilter.replaceAll(i),t.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.picturesLibrary,t.viewMode=Windows.Storage.Pickers.PickerViewMode.thumbnail,t.pickSingleFileAsync()};t._process=function(t){if(!t)return WinJS.Promise.wrap(null);u("_process");var p=this,a,v,r,i,h,c,y,s,l;return t.openReadAsync().then(function(n){return a=n,e.createAsync(n)}).then(function(t){i=t;h=i.orientedPixelWidth;c=i.orientedPixelHeight;var r;return i.decoderInformation.codecId===e.pngDecoderId?(r=n._extPng,y=o.pngEncoderId):(r=n._extJpeg,y=o.jpegEncoderId),p._createFile(r)}).then(function(n){return r=n,r.openAsync(Windows.Storage.FileAccessMode.readWrite)}).then(function(n){return v=n,o.createAsync(y,n)}).then(function(t){s=t;var u=n._shortEdgeLength/h,f=n._shortEdgeLength/c,r=Math.min(1,Math.max(u,f));return s.bitmapTransform.scaledWidth=Math.round(h*r),s.bitmapTransform.scaledHeight=Math.round(c*r),i.getPixelDataAsync()}).then(function(n){return s.setPixelData(i.bitmapPixelFormat,i.bitmapAlphaMode,h,c,i.dpiX,i.dpiY,n.detachPixelData()),s.flushAsync()}).then(null,function(n){l=n}).then(function(){if(a&&a.close(),v&&v.close(),l){var n=r;if(r=null,n)return n.deleteAsync().then(null,function(){})}else return p._cleanUpBackgrounds(r)}).then(function(){return f("_process"),l?WinJS.Promise.wrapError(l):WinJS.Promise.wrap(n._localFolderUriBase+n._folderName+"/"+r.name)})};t._createFile=function(t){return h.current.localFolder.createFolderAsync(n._folderName,c.openIfExists).then(function(i){var r=n._fileNameCount++,u=n._fileName+r+"."+t;return i.createFileAsync(u,c.generateUniqueName)})};t._cleanUpBackgrounds=function(t){return h.current.localFolder.getFolderAsync(n._folderName).then(function(n){return n.getFilesAsync()}).then(function(n){var i=[];return n.forEach(function(n){t&&n.isEqual(t)||i.push(n.deleteAsync())}),WinJS.Promise.join(i)}).then(null,function(){})}})