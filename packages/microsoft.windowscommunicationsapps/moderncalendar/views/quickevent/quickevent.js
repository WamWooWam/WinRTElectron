Jx.delayDefine(Calendar.Controls,"QuickEvent",function(){function t(n){msWriteProfilerMark("Calendar:QuickEvent."+n+",StartTA,Calendar")}function i(n){msWriteProfilerMark("Calendar:QuickEvent."+n+",StopTA,Calendar")}var e=Calendar.Helpers,u=Calendar.Views.Manager,r=Calendar.Loc,f,n=Calendar.Controls.QuickEvent=function(n){this.initComponent();f=Calendar.Views.CalendarSelector;this._surface=null;this._glyph=null;this._subject=null;this._location=null;this._textContainer=null;this._caret=null;this._dropdownHolder=null;this._closeButton=null;this._platform=null;this._settings=null;this._calendar=null;this._onKeyDown=this._onKeyDown.bind(this);this._onKeyDownInputBox=this._onKeyDownInputBox.bind(this);this._onResizeWindow=this._onResizeWindow.bind(this);this._onCalendarSelectorHidden=this._onCalendarSelectorHidden.bind(this);this._onClickCloseButton=this._onClickCloseButton.bind(this);this.onDismiss=this.onDismiss.bind(this);this._ensureVisible=this._ensureVisible.bind(this);this._shutdown=this._shutdown.bind(this);this._startEventDetails=this._startEventDetails.bind(this);this._view=n;this._element=null;this._allDayEvent=true;this._focusRestore=null;this._host=null;this._date=null;this._tabElements=null;this._windowWidth=null;this._animation=null;this._useAnimation=false;this._calendarSelector=new f(".qe-caret");this._calendarSelector.updateSelectionUI=this._updateSelectionUI.bind(this);this._calendarSelector.disableInitialFocus();this._timeSlider=new Calendar.Views.TimeSlider(60,false);this.appendChild(this._timeSlider)};Jx.augment(n,Jx.Component);n.prototype.activateUI=function(n,r,u,f,o){var s,h;t("activateUI");this.isOpen()?this.onDismiss():(this._calendar=this._getPlatform().calendarManager.defaultCalendar,this._host=n,this._date=r,this._windowWidth=window.outerWidth,this._allDayEvent=u,this._focusRestore=o,this._useAnimation=true,this._createOrRecycleHtml(f),this._allDayEvent||(s=new Date(r.getFullYear(),r.getMonth(),r.getDate()),this._timeSlider.setAllowStartStopSwap(false),this._timeSlider.setAllowSliderJump(false),this._timeSlider.setRange(s,r,new Date(+r+e.hourInMilliseconds))),this._calendarSelector.enableEventDetailsLink(true),this._calendarSelector.activateUI(),this._setupCalendarCombo(),this._setupTabIndex(),this._bindEvents(),this.fire("setScrollable",false),h=this._timeSliderElement?this._timeSliderElement:this._element,h.style.opacity=1,this._subject.focus());i("activateUI")};n.prototype._shutdown=function(){this._subject.value="";this._location.value="";this._calendarSelector.deactivateUI();this._timeSlider.deactivateUI();this._focusRestore&&this._focusRestore.parentNode&&Jx.safeSetActive(this._focusRestore);this._element.parentNode&&this._element.parentNode.removeChild(this._element);this._host=null;this._element=null;this._animation=null};n.prototype.deactivateUI=function(){if(t("deactivateUI"),this._host){if(this._animation)this._animation.cancel();else if(this._unhookEvents(),this._timeSlider.unhookEvents(),this._useAnimation){var n=this._timeSliderElement?this._timeSliderElement:this._element;this._animation=WinJS.UI.Animation.fadeOut(n).then(this._shutdown,this._shutdown)}else this._shutdown();this.fire("setScrollable",true)}i("deactivateUI")};n.prototype.isDirty=function(){return this._subject.value!==""||this._location.value!==""};n.prototype.isOpen=function(){return this._host!==null};n.prototype._bindEvents=function(){Jx.EventManager.addListener(Jx.root,"resizeWindow",this._onResizeWindow,this);this._allDayEvent?this._element.addEventListener("keydown",this._onKeyDown,false):this._timeSlider.getElement().addEventListener("keydown",this._onKeyDown,false);this._subject.addEventListener("keydown",this._onKeyDownInputBox,false);this._location.addEventListener("keydown",this._onKeyDownInputBox,false);this._subject.addEventListener("input",this._refreshHintTextVisibility,false);this._location.addEventListener("input",this._refreshHintTextVisibility,false);this._element.addEventListener("click",this._onStopPropagation,false);this._element.addEventListener("MSPointerDown",this._onStopPropagation,false);this._element.addEventListener("MSPointerCancel",this._onStopPropagation,false);this._closeButton.addEventListener("click",this._onClickCloseButton,false);this._calendarSelector.on("showDropdown",this._ensureVisible);this._calendarSelector.on("CalendarSelectorHidden",this._onCalendarSelectorHidden);this._calendarSelector.on("createEvent",this._startEventDetails);this.on("lightDismiss",this.onDismiss);this.on("timeSliderBegin",this._onTimeSliderBegin);this.on("timeSliderEnd",this._onTimeSliderEnd)};n.prototype._unhookEvents=function(){Jx.EventManager.removeListener(Jx.root,"resizeWindow",this._onResizeWindow,this);this._allDayEvent?this._element.removeEventListener("keydown",this._onKeyDown,false):this._timeSlider.getElement().removeEventListener("keydown",this._onKeyDown,false);this._subject.removeEventListener("keydown",this._onKeyDownInputBox,false);this._location.removeEventListener("keydown",this._onKeyDownInputBox,false);this._subject.removeEventListener("input",this._refreshHintTextVisibility,false);this._location.removeEventListener("input",this._refreshHintTextVisibility,false);this._element.removeEventListener("click",this._onStopPropagation,false);this._element.removeEventListener("MSPointerDown",this._onStopPropagation,false);this._element.removeEventListener("MSPointerCancel",this._onStopPropagation,false);this._closeButton.removeEventListener("click",this._onClickCloseButton,false);this._calendarSelector.detach("showDropdown",this._ensureVisible);this._calendarSelector.detach("CalendarSelectorHidden",this._onCalendarSelectorHidden);this._calendarSelector.detach("createEvent",this._startEventDetails);this.detach("lightDismiss",this.onDismiss);this.detach("timeSliderBegin",this._onTimeSliderBegin);this.detach("timeSliderEnd",this._onTimeSliderEnd)};n.prototype._onClickCloseButton=function(n){n.stopPropagation();n.preventDefault();this.onDismiss()};n.prototype._onCalendarSelectorHidden=function(){this._subject.focus()};n.prototype._onResizeWindow=function(){this.onDismiss(true)};n.prototype._onStopPropagation=function(n){n.stopPropagation();n.target.nodeName!=="INPUT"&&n.preventDefault()};n.prototype._onKeyDownInputBox=function(n){var i=n.keyCode,t=true;!n.ctrlKey||n.shiftKey||n.altKey?i===Jx.KeyCode.enter?t=false:i===Jx.KeyCode.tab?t=false:i===Jx.KeyCode.escape?t=false:i===Jx.KeyCode.uparrow?t=false:i===Jx.KeyCode.downarrow&&(t=false):i===Jx.KeyCode.s&&(t=false);t&&n.stopPropagation()};n.prototype._refreshHintTextVisibility=function(n){var t=n.target;t.id==="qeSubject"?$.id("qeSubjectHint").style.visibility=t.value===""?"visible":"hidden":t.id==="qeLocation"&&($.id("qeLocationHint").style.visibility=t.value===""?"visible":"hidden")};n.prototype._onKeyDown=function(n){var t=n.keyCode;if(!n.ctrlKey||n.shiftKey||n.altKey)if(t===Jx.KeyCode.enter)this.onDismiss();else if(t===Jx.KeyCode.tab){var r=this._tabElements,i=r.indexOf(document.activeElement),u=r.length;i=i<0?0:n.shiftKey?(i-1+u)%u:(i+1)%u;r[i].focus()}else t===Jx.KeyCode.escape?this.deactivateUI():this._allDayEvent||(t===Jx.KeyCode.uparrow?n.target.id==="qeLocation"?$.id("qeSubject").focus():this._timeSlider._handleDecrement(n.target):t===Jx.KeyCode.downarrow&&(n.target.id==="qeSubject"?$.id("qeLocation").focus():this._timeSlider._handleIncrement(n.target)));else t===Jx.KeyCode.s&&this._createEvent();n.stopPropagation();n.preventDefault()};n.prototype.onDismiss=function(n){t("onDismiss");this._host&&(this._subject!==document.activeElement||this._focusRestore||this._subject.blur(),n&&(this._focusRestore=null),(!this._calendarSelector.isOpen()||n)&&(this.isDirty()?this._createEvent():this.deactivateUI()),this._calendarSelector.onDismiss());i("onDismiss")};n.prototype._isChild=function(n){for(var t=false;n&&n.parentNode&&!t;)n.parentNode===this._element?t=true:n=n.parentNode;return t};n.prototype._onTimeSliderBegin=function(){var n=document.activeElement;n&&this._isChild(n)&&(this._focusedElAtSliderBegin=n,n.blur())};n.prototype._onTimeSliderEnd=function(){this._focusedElAtSliderBegin&&(Jx.safeSetActive(this._focusedElAtSliderBegin),this._focusedElAtSliderBegin=null)};n.prototype._createOrRecycleHtml=function(n){function e(n,t,i){var u=i?r.loadCompoundString(t,Jx.key.getLabel(i)):r.getString(t);new WinJS.UI.Tooltip($.id(n),{innerHTML:u})}var f,o,s;t("_createOrRecycleHtml");this._allDayEvent?this._element?this._host.appendChild(this._element):(this._host.insertAdjacentHTML("beforeend",this._html()),this._element=this._host.lastElementChild):(this._timeSliderElement?this._host.appendChild(this._timeSliderElement):(this._host.insertAdjacentHTML("beforeend",Jx.getUI(this._timeSlider).html),this._timeSliderElement=this._host.lastElementChild),this._timeSlider.activateUI(this._timeSliderElement),this._element?this._timeSlider.getContentRegion().appendChild(this._element):(this._timeSlider.getContentRegion().insertAdjacentHTML("beforeend",this._html()),this._element=this._timeSlider.getContentRegion().lastElementChild));e("qeSubject","EventTitleLabel");e("qeLocation","EventLocationLabel");e("qeCaret","EventCalendarLabel");f=this._element;this._surface=f.querySelector(".surface");this._glyph=f.querySelector(".qe-glyph");this._subject=f.querySelector(".qe-subject");this._location=f.querySelector(".qe-location");this._textContainer=f.querySelector(".textContainer");this._caret=f.querySelector(".qe-caret");this._dropdownHolder=f.querySelector(".dropdownHolder");this._closeButton=$.id("qecClose");this._view===u.Views.month&&(this._textContainer.style.paddingTop=Math.floor((n.height-28)/2)+"px",this._surface.style.height=n.height-1+"px",this._element.style.bottom=n.bottom+"px",o=n.height<35?0:"5px",s=this._dropdownHolder.style,s.paddingTop=o,s.paddingBottom=o);this._allDayEvent?f.setAttribute("data-status","free"):f.setAttribute("data-status","busy");i("_createOrRecycleHtml")};n.prototype._updateAriaFlow=function(){var t=$("#CalendarCombo .entry").last()[0],n,i;t&&(n=$.id("eventDetailsLink"),i=$.id("calendarMenu"),t.setAttribute("aria-flowto",n.id),n.setAttribute("x-ms-aria-flowfrom",t.id),n.setAttribute("aria-flowto",i.id),i.setAttribute("x-ms-aria-flowfrom",n.id))};n.prototype._ensureVisible=function(n){t("_ensureVisible");var h=n.data.container,e=n.data.ev,f=h.style,v=this._element;f.position="-ms-device-fixed";f.left=0;f.top=0;f.opacity=0;var c=window.innerWidth,l=window.innerHeight,o=0,s=0,r=v.querySelector(".qe-caret"),a=$.id("calendar");if(e.pageX&&e.pageY)o=e.pageX,s=e.pageY;else for(this._allDayEvent&&this._view!==u.Views.day&&(a=this._host.parentNode),o+=Math.floor(r.offsetWidth/2),s+=Math.floor(r.offsetHeight/2);r!==a;)o+=r.offsetLeft-r.scrollLeft,s+=r.offsetTop-r.scrollTop,r=r.parentNode;setImmediate(function(){if(t("_ensureVisible:inner"),this.isOpen()){var u=10,e=h.offsetWidth,a=h.offsetHeight,n=o-Math.floor(e/2),r=s+12-window.pageYOffset;n<0?n=u:n+e>=c&&(n=c-e-u);r<0?r=u:r+a>l&&(r=l-a-u);f.left=n+"px";f.top=r+"px";f.opacity="";this._updateAriaFlow();this._calendarSelector.setFocus()}i("_ensureVisible:inner")}.bind(this));i("_ensureVisible")};n.prototype._setupTabIndex=function(){var n,f,r,e;for(t("_setupTabIndex"),n=[this._subject],this._view!==u.Views.month&&n.push(this._location),n.push(this._caret),this._allDayEvent||(n=n.concat(this._timeSlider.getTouchTargets())),this._tabElements=n,f=n.concat([this._closeButton]),r=0,e=f.length;r<e;r++){var s=f[(r+1)%e],h=f[(r-1+e)%e],o=f[r];o.setAttribute("aria-flowto",s.id);o.setAttribute("x-ms-aria-flowfrom",h.id)}i("_setupTabIndex")};n.prototype._updateSelectionUI=function(n){this._calendar=n.calendar;this._updateColors()};n.prototype._updateColors=function(){var r,n;t("_updateColors");r=this._calendar.color;this._subject.style.color=r;this._glyph.style["background-color"]=r;n=document.getElementById("quickEventStyles");n||(n=document.createElement("STYLE"),n.setAttribute("id","quickEventStyles"),document.querySelector("head").appendChild(n));n.innerHTML="";n.appendChild(document.createTextNode(".quickEvent ::selection {background-color: #"+("00000"+r.toString(16)).slice(-6)+";}"));i("_updateColors")};n.prototype._getPlatform=function(){if(!this._platform){var n={};this.fire("getPlatform",n);this._platform=n.platform}return this._platform};n.prototype._startEventDetails=function(){var n,r;t("_startEventDetails");n={startDate:this._date,allDayEvent:true,subject:this._subject.value,location:this._location.value,calendarId:this._calendarSelector.activeCalendarItem().calendar.id};this._allDayEvent||(r=this._timeSlider.getState(),n.startDate=r.start,n.endDate=r.end,n.allDayEvent=false);this.fire("createEvent",n);this._subject.value="";this._location.value="";i("_startEventDetails")};n.prototype._createEvent=function(){var h,n;t("_createEvent");var f=Microsoft.WindowsLive.Platform.Calendar,r=this._date,c=this._allDayEvent,u,o,s;if(c?(r=new Date(r.getFullYear(),r.getMonth(),r.getDate()),u=new Date(r.getFullYear(),r.getMonth(),r.getDate()+1),o=f.BusyStatus.free,s=Calendar.DEFAULT_ALLDAY_EVENT_REMINDER):(o=f.BusyStatus.busy,s=Calendar.DEFAULT_EVENT_REMINDER,this._timeSlider?(h=this._timeSlider.getState(),r=h.start,u=h.end):u=new Date(r.getTime()+e.hourInMilliseconds),u>=Calendar.LAST_DAY&&(u=r)),n=this._calendar.createEvent(),n.subject=this._subject.value,n.location=this._location.value,n.startDate=r,n.endDate=u,n.busyStatus=o,n.responseType=f.ResponseType.organizer,n.allDayEvent=c,n.reminder=s,n.responseRequested=true,n.validate()===f.Status.success)try{n.commit();this._settings.set("lastCalendarId",this._calendar.id)}catch(l){Jx.fault("quickEvent.js","_createEvent",l)}i("_createEvent");this._useAnimation=true;this.deactivateUI()};n.prototype._setupCalendarCombo=function(){var r,n,u,e;t("_setupCalendarCombo");r=this._getPlatform();n={};this.fire("getSettings",n);this._settings=n.settings;u=this._settings.get("lastCalendarId");e=f.getCalendarsForSelector(r);this._calendarSelector.setCalendars(e);this._calendarSelector.updateSelectionById(u);i("_setupCalendarCombo")};n.prototype._html=function(){var n=Jx.escapeHtml(r.getString("EventTitleLabel")),t=Jx.escapeHtml(r.getString("EventLocationLabel")),i=Jx.escapeHtml(r.getString("CloseButton")),u=Jx.escapeHtml(r.getString("EventCalendarLabel")),f=this._allDayEvent?" allDayQuickEvent":"";return'<div class="quickEvent'+f+'"><div class="surface"><div class="dropdownHolder"><div id="qeCaret" class="qe-caret" tabindex="3" aria-label="'+u+'" role="button">&#xE099;<\/div><\/div><div class="qe-glyph"><div class="glyphInner"><\/div><\/div><div class="textContainer"><div id="qeSubjectHint" aria-hidden="true">'+n+'<\/div><input id="qeSubject" class="qe-subject" tabindex="1" maxlength="255" aria-label="'+n+'" type="text" aria-readonly="false"/><div id="qeLocationHint" aria-hidden="true">'+t+'<\/div><input id="qeLocation" class="qe-location" tabindex="2" maxlength="255" aria-label="'+t+'" type="text" aria-readonly="false"/><\/div><div id="qecClose" class="qec-close-button" role="button" aria-hidden="false">'+i+"<\/div><\/div><\/div>"}})