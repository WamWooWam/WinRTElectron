Jx.delayDefine(Calendar.Views,"Manager",function(){function i(n){Jx.mark("Calendar.Views.Manager."+n+",Info,Calendar")}function f(n){Jx.mark("Calendar.Views.Manager."+n+",StartTA,Calendar")}function e(n){Jx.mark("Calendar.Views.Manager."+n+",StopTA,Calendar")}function u(n){Jx.Dep.load("CalED",n)}var t=Calendar.Views,r=671,n=t.Manager=function(){this.initComponent();this._id="calViewsMgr";this._view=n.Views.agenda;this._companion=window.outerWidth<=r;this._editing=false;this._replacementEvent=null;this._date=new Date};Jx.augment(n,Jx.Component);n.Views={month:0,week:1,workweek:2,day:3,agenda:4};n.prototype.setCurrentView=function(n){var t,i,r,u;this._view!==n&&(t=this._view,this._view=n,this._host&&(this._editing||(this._companion?(i=this._getCompanionView(t),r=this._getCompanionView(n)):(i=t,r=n),i!=r&&(u=this._updateChild(),this._replaceUi(u.prev,u.next)))))};n.prototype.getCurrentView=function(){return this._view};n.prototype.isEditing=function(){return this._editing};n.prototype.showDatePicker=function(){this._child&&this._child.showDatePicker&&(i("showDatePicker"),this._child.showDatePicker())};n.prototype.changeBackground=function(n){this._child&&this._child.changeBackground&&(i("changeBackground"),this._child.changeBackground(n))};n.prototype.allowPeekBarTabVersion=function(){return this._child&&this._child.allowPeekBarTabVersion?this._child.allowPeekBarTabVersion():false};n.prototype.setFocusedDay=function(n){var t=this.getFocusedDay();t&&t.getTime()!==n.getTime()&&(this._date=new Date(n),this._child&&this._child.setFocusedDay&&(this._child.setFocusedDay(this._date),i("setFocusedDay "+this._date)))};n.prototype.getFocusedDay=function(){return this._child&&this._child.getFocusedDay&&(this._date=this._child.getFocusedDay()),this._date};n.prototype.getUI=function(n){this._child||(this._companion=window.outerWidth<=r,this._updateChild(),this._child.setLoadAnimation&&this._child.setLoadAnimation(WinJS.UI.Animation.enterPage));n.html="<div id='viewManager' class='viewManager'>"+Jx.getUI(this._child).html+"<\/div>"};n.prototype.activateUI=function(n){this._jobset=n;this._host=document.getElementById("viewManager");this.on("dayChosen",this._onDayChosen);this.on("monthChosen",this._onMonthChosen);this.on("createEvent",this._onCreateEvent);this.on("editEvent",this._onEditEvent);this.on("focusEvent",this._onFocusEvent);this.on("finishedEditing",this._onFinishedEditing);this.on("resizeWindow",this._onResizeWindow);this._childJobset=n.createChild();this._child.activateUI(this._childJobset)};n.prototype.deactivateUI=function(){Jx.Component.prototype.deactivateUI.call(this);this.detach("resizeWindow",this._onResizeWindow);this.detach("dayChosen",this._onDayChosen);this.detach("monthChosen",this._onMonthChosen);this.detach("createEvent",this._onCreateEvent);this.detach("editEvent",this._onEditEvent);this.detach("focusEvent",this._onFocusEvent);this.detach("finishedEditing",this._onFinishedEditing);this._host=null;this._jobset.dispose();this._jobset=null};n.prototype.isCompanion=function(){return this._companion};n.prototype.getShareData=function(n){var i,u,r,f,t;if(this._editing)if(i=this._child.getCanvasWindow(),i.getSelection().isCollapsed)n.failWithDisplayText(Jx.res.getString("ShareFail"));else{try{n.data=MSApp.createDataPackageFromSelection()}catch(e){u=i.getSelection().getRangeAt(0).cloneContents();r=document.createElement("div");r.appendChild(u);f=Windows.ApplicationModel.DataTransfer.HtmlFormatHelper.createHtmlFormat(r.innerHTML);n.data=new Windows.ApplicationModel.DataTransfer.DataPackage;n.data.setHtmlFormat(f)}t=this._child.getTitle();n.data.properties.title=Jx.isNonEmptyString(t)&&Jx.isNonEmptyString(t.trim())?Jx.res.loadCompoundString("ShareTitle",t.trim()):Jx.res.getString("ShareEmptyTitle")}else n.failWithDisplayText(Jx.res.getString("ShareFail"))};n._viewCreators=[function(){return new t.Month},function(){return new t.Week},function(){var n=new t.Week;return n.setWorkWeek(true),n},function(){return new t.Day},function(){return new t.Agenda}];n.prototype._getCompanionView=function(t){return t===n.Views.agenda?n.Views.agenda:n.Views.day};n.prototype._updateChild=function(){var i=this._child,r,u;return i&&(i.getFocusedDay&&(this._date=i.getFocusedDay()),this.removeChild(i),this._childJobset.cancelAllChildJobs()),this._editing?(i&&i.getState&&(this._lastViewState=i.getState(),this._lastWasCompanion=this._companion),this._child=new t.EventDetails):(r=this._companion?this._getCompanionView(this._view):this._view,u=n._viewCreators[r],this._child=u()),this._child.setFocusedDay&&this._child.setFocusedDay(this._date),this.appendChild(this._child),this.fire("viewUpdated",{companion:this._companion,editing:this._editing}),{prev:i,next:this._child}};n.prototype._replaceUi=function(n,t){n.shutdownUI();this._host.innerHTML=Jx.getUI(t).html;t.activateUI(this._childJobset)};n.prototype._isValidEvent=function(n){if(n&&n.event){var t={};this.fire("getPlatform",t);try{n=t.platform.calendarManager.getEventFromHandle(n.event.handle)}catch(i){n=null}if(n)return true}return false};n.prototype._viewSupportsCompanion=function(t){switch(t){case n.Views.agenda:case n.Views.day:return true;default:return false}};n.prototype._onResizeWindow=function(n){var t,i;f("_onResizeWindow");t=n.data.outerWidth<=r;t===this._companion||this._editing||(t||this._companion)&&this._viewSupportsCompanion(this._view)?(this._companion=t,this.fire("viewUpdated",{companion:this._companion,editing:this._editing})):(this._companion=t,i=this._updateChild(),this._replaceUi(i.prev,i.next));e("_onResizeWindow")};n.prototype._onCreateEvent=function(n){if(!n.handled&&!this._editing){i("eventDetails_create");Jx.ptStart("Calendar-EventDetails-NoData");var t=this;u(function(){var r=new Date,i=n.data,f,u;i||(i={},t._child.containsDate(r)?(i.startDate=new Date(r.getFullYear(),r.getMonth(),r.getDate(),r.getHours()),f=r.getMinutes(),f>30?i.startDate.setMinutes(60):f>0&&i.startDate.setMinutes(30)):(i.startDate=new Date(t._child.getFocusedDay()),i.startDate.setHours(9)));t._editing=true;t._replacementEvent=null;u=t._updateChild();u.next.createEvent(i);t._replaceUi(u.prev,u.next)});n.handled=true}};n.prototype._onEditEvent=function(n){if(!n.handled){i("eventDetails_edit");Jx.ptStart("Calendar-EventDetails-Data");var t=this,r=n.data.event,f="dirty"in n.data?n.data.dirty:false;u(function(){var i,u;t._editing?(u=t._child.getEvent(),u&&u.handle===r.handle||(t._replacementEvent=n.data,t._child.cancel())):(t._editing=true,i=t._updateChild(),i.next.editEvent(r,f)||(t._editing=false,i.prev.shutdownUI(),i=t._updateChild()),t._replaceUi(i.prev,i.next))});n.handled=true}};n.prototype._onFocusEvent=function(t){if(!t.handled){var r,i=t.data,u=Calendar.Helpers,f=i.endDate.getTime()-i.startDate.getTime();r=f<=2*u.dayInMilliseconds?n.Views.day:f<=7*u.dayInMilliseconds?n.Views.week:n.Views.month;this.setCurrentView(r);this._editing?(this._eventToFocus=i,this._child.cancel()):this._child.focusEvent(i);t.handled=true}};n.prototype._onFinishedEditing=function(n){var t,r;n.handled||(this._isValidEvent(this._replacementEvent)?(r="dirty"in this._replacementEvent?this._replacementEvent.dirty:false,t=this._updateChild(),t.next.editEvent(this._replacementEvent.event,r)):(this._editing=false,t=this._updateChild(),this._companion===this._lastWasCompanion&&this._lastViewState&&t.next.setState(this._lastViewState),this._lastViewState=null,this._lastWasCompanion=null,this._eventToFocus?(t.next.focusEvent(this._eventToFocus),this._eventToFocus=null):n.data&&n.data.eventType!==Microsoft.WindowsLive.Platform.Calendar.EventType.series&&t.next.focusEvent(n.data)),this._replacementEvent=null,this._replaceUi(t.prev,t.next),i(n.data?"SaveEnd":"CancelEnd"),n.handled=true)};n.prototype._onDayChosen=function(t){t.data&&this.setFocusedDay(t.data);this.setCurrentView(n.Views.day)};n.prototype._onMonthChosen=function(t){t.data&&this.setFocusedDay(t.data);this.setCurrentView(n.Views.month)}})