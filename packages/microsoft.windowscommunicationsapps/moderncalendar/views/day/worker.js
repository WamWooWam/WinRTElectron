(function(){function i(n){Jx.mark("DayWorker."+n+",StartTA,Calendar")}function r(n){Jx.mark("DayWorker."+n+",StopTA,Calendar")}function u(t){var i=t.start?'<div class="startTime" aria-hidden="true">'+t.start+"<\/div>":"",r=t.end?'<div class="endTime" aria-hidden="true">'+t.end+"<\/div>":"";return'<div id="'+n.getIdFromEventHandle(t.handle,t.isCrossDay)+'" data-handle="'+t.handle+'" class="'+t.className+'" tabindex="0" data-status="'+t.status+'" role="button" aria-label="'+Jx.escapeHtml(t.label)+'" style="color:'+t.color+'"><div class="glyph" style="background-color:'+t.color+';"><div class="glyphInner"><\/div><\/div>'+i+'<div class="subject" aria-hidden="true">'+Jx.escapeHtml(t.subject)+"<\/div>"+r+'<div class="overlay"><\/div><\/div>'}function f(n){var t=n.location?"("+Jx.escapeHtml(n.location)+")":"";return'<span class="subject">'+Jx.escapeHtml(n.subject)+'<\/span> <span class="location">'+t+"<\/span>"}function e(n){return'<div class="subject">'+Jx.escapeHtml(n.subject)+'<\/div><div class="location">'+Jx.escapeHtml(n.location)+"<\/div>"}function o(t){var i=t.isOneLine?f(t):e(t);return'<div id="'+n.getIdFromEventHandle(t.handle,t.isCrossDay)+'" data-handle="'+t.handle+'" class="'+t.className+'" tabindex="0" data-status="'+t.status+'" role="button" aria-label="'+Jx.escapeHtml(t.label)+'" style="position:absolute;top:'+t.top+"%;"+t.dir+":"+t.left+"%;width:"+t.width+";height:"+t.height+"%;color:"+t.color+';"><div class="glyph" style="background-color: '+t.color+";"+t.glyphHeight+';"><div class="glyphInner"><\/div><\/div><div class="details" aria-hidden="true">'+i+'<\/div><div class="overlay"><\/div><\/div>'}var n=Calendar.Helpers,t=Calendar.Views.DayWorker=function(i,r,u){this._router=i;this._scheduler=r;this._manager=u;this._requests={};this._updateEvents=this._updateEvents.bind(this);this._router.route("Day/getEvents",this.getEvents,this);this._router.route("Day/setVisible",this.setVisible,this);this._router.route("Day/expandAllDay",this.expandAllDay,this);this._router.route("Day/cancel",this.cancel,this);t._allDayMore||(n.ensureFormats(),t._allDayMore=Jx.res.getFormatFunction("AllDayMore"))};t.prototype.getEvents=function(n){var u=n.id,t=n.data;t.id=u;t.start=new Date(t.start);t.end=new Date(t.end);i("getEvents");t.collection=this._manager.getEvents(t.start,t.end);t.job=this._scheduler.schedule(this._processEvents,this,[t],t.isVisible);r("getEvents");this._requests[u]=t};t.prototype.setVisible=function(n){var t=n.data;t&&(t.isVisible=n.data,this._scheduler.setVisible(t.job,n.data))};t.prototype.expandAllDay=function(n){var i=n.id,t=this._requests[i];t&&this._scheduler.schedule(this._expandAllDay,this,[t],true)};t.prototype.cancel=function(n){var f,t,u;i("cancel");f=n.id;t=this._requests[f];t&&(u=t.onCollectionChanged,u&&(t.collection.removeEventListener("collectionchanged",u),t.changeTimeout!==true&&clearTimeout(t.changeTimeout)),this._unhookEvents(t),t.collection.dispose(),this._scheduler.cancel(t.job),delete this._requests[n.id]);r("cancel")};t.prototype.dispose=function(){for(var n in this._requests)this.cancel({id:n});this._requests={};this._manager=null;this._scheduler=null;this._router=null};t.prototype._processEvents=function(t){var k;i("_processEvents");var h=new Date(t.start),nt=new Date(h.getFullYear(),h.getMonth(),h.getDate()+1).getTime(),w=h.getTime(),s=n.getCollection(h,nt,t.collection);t.requiresSort&&(s.sort(n.orderEvents),t.requiresSort=false);s.allDay=0;for(var l=[],a={width:1},d=0,e,v,o,g={},u,f=0,c=s.length;f<c;f++){u=s[f];var b=u.winrt,y=b.startDate,p=b.endDate;if(u.isCrossDay=!n.isSameDate(y,p),!b.allDayEvent&&u.isCrossDay&&(k=new Date(y.getTime()),k.setDate(k.getDate()+1),k<=p&&(u.isMultiDay=true)),b.allDayEvent||u.isMultiDay)s.allDay++;else for(u.dayStart=n.isSameDate(h,y)?w+y.getHours()*n.hourInMilliseconds+y.getMinutes()*n.minuteInMilliseconds:w,u.dayEnd=n.isSameDate(h,p)?w+p.getHours()*n.hourInMilliseconds+p.getMinutes()*n.minuteInMilliseconds:w+n.dayInMilliseconds,u.length=u.dayEnd-u.dayStart,u.length<=n.shortEventLength?(u.uiLength=n.shortEventLength,u.uiEnd=u.dayStart+u.uiLength,u.isShort=true):(u.uiLength=u.length,u.uiEnd=u.dayEnd,u.length<=n.mediumEventLength&&(u.isMedium=true)),g[u.uiEnd]=true,e=0;e<=f;e++)if(o=l[e],o||(o={uiEnd:n.zeroYearTime},a.width=e+1),o.uiEnd<=u.dayStart){for(v=e+1;v<a.width&&l[v].uiEnd<=o.dayStart;v++)o.width++;v===a.width&&(o.width=-1);e===0&&d<=u.dayStart&&(a={width:1},l=[]);d=Math.max(d,u.uiEnd);l[e]=u;u.cluster=a;u.position=e;u.width=1;break}}for(f=0,c=a.width;f<c;f++)for(o=l[f],e=f+1;e<c&&l[e].uiEnd<=o.dayStart;e++)o.width++;for(f=0,c=s.length;f<c;f++)u=s[f],g[u.dayStart]&&(u.hasPreviousEvent=true);t.events=s;t.allDayHtml="";t.eventHtml="";t.job=this._scheduler.schedule(this._buildAllDayHtml,this,[t],t.isVisible);r("_processEvents")};t.prototype._buildAllDayHtml=function(n){i("_buildAllDayHtml");var t=n.events,u=n.start;n.allDayHtml=this._getAllDayHtml(t,u,false);n.job=this._scheduler.schedule(this._buildEventHtml,this,[n],n.isVisible);r("_buildAllDayHtml")};t.prototype._getAllDayHtml=function(i,r,f){var y=new Date(r.getFullYear(),r.getMonth(),r.getDate()+1),l=!f&&3<i.allDay,p=l?2:i.allDay,h="",a="event",o,s,e;f&&(a+=" full");for(var c=0,v=0,w=i.length;c<w&&v<p;c++)o=i[c],s=o.winrt,(s.allDayEvent||o.isMultiDay)&&(e=n.getEventUiInfo(s,false),e.className=a,e.start="",e.end="",e.isCrossDay=o.isCrossDay,o.isMultiDay&&(r<=o.start?e.start=n.simpleTime.format(s.startDate):o.end<=y&&(e.end=n.simpleTime.format(s.endDate))),h+=u.call(this,e),v++);return l&&(h+="<div class='more' tabIndex='0' role='button'>"+Jx.escapeHtml(t._allDayMore(i.allDay-2))+"<\/div>"),h};t.prototype._buildEventHtml=function(t){var h,y,s,p,u,c,f;for(i("_buildEventHtml"),h=t.events,y=t.start,s=0,p=h.length;s<p;s++)if(u=h[s],c=u.winrt,!c.allDayEvent&&!u.isMultiDay){var b=y.getTime(),k=u.width===-1?u.cluster.width-u.position:u.width,d=(u.dayStart-b)*n.percentageOfDay,w=u.position*100/u.cluster.width,l=k*100/u.cluster.width,e,a="event",v=u.length*n.percentageOfDay;u.isShort?(e=u.uiLength*n.percentageOfDay,a+=" short"):e=v;u.hasPreviousEvent&&(a+=" hasPreviousEvent");f=n.getEventUiInfo(c,false);f.dir=this._isRtl?"right":"left";f.left=w;f.top=d;f.width=w+l!==100?"calc("+l+"% - 1px)":l+"%";f.height=e-100/1440;f.className=a;f.glyphHeight=v<e?"height: "+100*v/e+"%":"";f.isOneLine=u.isShort||u.isMedium;f.isCrossDay=u.isCrossDay;t.eventHtml+=o.call(this,f)}t.job=this._scheduler.schedule(this._sendEvents,this,[t],t.isVisible);r("_buildEventHtml")};t.prototype._sendEvents=function(n){i("_sendEvents");var t;n.onCollectionChanged?(t="Day/eventsChanged",n.job=this._scheduler.schedule(this._hookEvents,this,[n],n.isVisible),n.collection.unlock()):(t="Day/getEvents",n.job=this._scheduler.schedule(this._hookCollection,this,[n],n.isVisible));this._router.postMessage({command:t,id:n.id,allDayHtml:n.allDayHtml,eventHtml:n.eventHtml});r("_sendEvents")};t.prototype._expandAllDay=function(n){i("_expandAllDay");var t=n.events,u=n.start,f=this._getAllDayHtml(t,u,true);this._router.postMessage({command:"Day/expandAllDay",id:n.id,html:f});r("_expandAllDay")};t.prototype._hookCollection=function(n){i("_hookCollection");n.onCollectionChanged=this._onCollectionChanged.bind(this,n);n.collection.addEventListener("collectionchanged",n.onCollectionChanged);n.collection.unlock();this._hookEvents(n);r("_hookCollection")};t.prototype._hookEvents=function(n){i("_hookEvents");n.onItemChanged=this._onItemChanged.bind(this,n);for(var t=0,u=n.events.length;t<u;t++)n.events[t].winrt.addEventListener("changed",n.onItemChanged);r("_hookEvents")};t.prototype._unhookEvents=function(n){var u,t,f;if(i("_unhookEvents"),u=n.onItemChanged,u){for(t=0,f=n.events.length;t<f;t++)n.events[t].winrt.removeEventListener("changed",u);n.onItemChanged=null}r("_unhookEvents")};t.prototype._onCollectionChanged=function(n){if(i("_onCollectionChanged"),!n.changeTimeout){this._unhookEvents(n);this._scheduler.cancel(n.job);var t=Date.now()-(n.lastChanged?n.lastChanged:0);t<990?n.changeTimeout=setTimeout(this._updateEvents,1e3-t,n):(setImmediate(this._updateEvents,n),n.changeTimeout=true)}r("_onCollectionChanged")};t.prototype._updateEvents=function(n){this._requests[n.id]&&(i("_updateEvents"),n.changeTimeout=null,n.lastChanged=Date.now(),n.collection.lock(),this._processEvents(n),r("_updateEvents"))};t.prototype._onItemChanged=function(t,u){var e,f,o,h,s;for(i("_onItemChanged"),e=Array.prototype.slice.call(u.detail[0]),f=u.target,o=0,h=e.length;o<h;o++)if(s=e[o],s==="startDate"||s==="endDate"){t.requiresSort=true;this._onCollectionChanged(t,u);return}this._router.postMessage({command:"Day/eventChanged",id:t.id,properties:e,ev:{handle:f.handle,busyStatus:f.busyStatus,color:f.color,location:f.location,subject:f.subject||n.noSubject}});r("_onItemChanged")}})()