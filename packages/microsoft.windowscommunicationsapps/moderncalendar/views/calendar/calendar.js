Jx.delayDefine(Calendar.Views,"Frame",function(){function e(n){Jx.mark("Calendar.Frame."+n+",Info,Calendar")}function t(n){Jx.mark("Calendar.Frame."+n+",StartTA,Calendar")}function i(n){Jx.mark("Calendar.Frame."+n+",StopTA,Calendar")}var r=People.Priority.launch,u={unknown:0,chooseNothing:1,chooseCustom:2,chooseDefault:3},n=Calendar.Views.Frame=function(){t("ctor");this.initComponent();this._id="calFrame";this._firstRun=true;this._jobset=null;this._commandState={companion:false,editing:false};this._onKeyDown=this._onKeyDown.bind(this);this._onBeforeShowAppbar=this._onBeforeShowAppbar.bind(this);this._onKeyboardShow=this._onKeyboardShow.bind(this);this._onKeyboardHide=this._onKeyboardHide.bind(this);this._appBar=null;this._appBarElt=null;this._navBar=null;this._peekBar=null;this._initializedSas=false;i("ctor")},f;Jx.augment(n,Jx.Component);n.REHYDRATION_TIMEOUT=36e5;n.BiciViews={month:0,week:1,workweek:2,day:3,snap:4,agenda:5};f=n.prototype;f.dispose=function(){};n.prototype.isEditing=function(){return this._views.isEditing()};n.prototype.getShareData=function(n){this._views.getShareData(n)};n.prototype.initUI=function(n,r){t("initUI");this._jobset=r;this._views=new Calendar.Views.Manager;this.append(this._views);this._navBar=new Calendar.NavBar;this.append(this._navBar);this._peekBar=new Jx.PeekBar("bottom");this.append(this._peekBar);document.body.insertAdjacentHTML("beforeend",'<div id="peekBar"><\/div>');this._peekBar.initUI(document.getElementById("peekBar"));this._initState();this._initEvents();Jx.Component.prototype.initUI.call(this,n);i("initUI")};n.prototype.getUI=function(n){t("getUI");n.html=Jx.getUI(this._views).html;i("getUI")};n.prototype.activateUI=function(){t("activateUI");window.addEventListener("click",this._lightDismiss,false);window.addEventListener("blur",this._forceDismiss,false);window.addEventListener("keydown",this._onKeyDown,false);window.addEventListener("MSHoldVisual",this._preventDefault,false);this._inputPane=Windows.UI.ViewManagement.InputPane.getForCurrentView();this._inputPane.addEventListener("showing",this._onKeyboardShow);this._inputPane.addEventListener("hiding",this._onKeyboardHide);this._views.activateUI(this._jobset);i("activateUI")};n.prototype.shutdownUI=function(){Jx.activation.removeListener("suspending",this._onSuspending,this);this._messageBar&&(this._authMessageBarPresenter.shutdown(),this._syncMessageBarPresenter.shutdown(),this._errorMessageBarPresenter.shutdown(),this._proxyAuthenticator.shutdown());this._onSuspending();window.removeEventListener("click",this._lightDismiss,false);window.removeEventListener("blur",this._forceDismiss,false);window.removeEventListener("keydown",this._onKeyDown,false);window.removeEventListener("MSHoldVisual",this._preventDefault,false);this._peekBar&&(Jx.dispose(this._peekBar),this._peekBar=null);this._appBarElt&&(this._appBar.removeEventListener("beforeshow",this._onBeforeShowAppbar,false),this._appBar=null,this._appBarElt.removeEventListener("keydown",this._onAppBarKeyDown,false),this._appBarElt.outerHTML="",this._appBarElt=null);this._navBar&&this._navBar.destroyUI();Jx.Component.prototype.shutdownUI.call(this)};n.prototype._ensureAppBar=function(){this._appBar===null&&(this._initAppBar(),this._ensureAppBar=Jx.fnEmpty)};n.prototype._ensureSasButton=function(){this._initializedSas||(t("SaSInit"),SasManager.init(document.title,"sasCommand"),i("SaSInit"),this._initializedSas=true)};n.prototype._initAppBar=function(){var n,u;t("_initAppBar");this._appBarElt=document.getElementById("appBar");this._appBarElt&&(this._appBarElt.removeEventListener("keydown",this._onAppBarKeyDown,false),document.body.removeChild(this._appBarElt),this._appBarElt=null);document.body.insertAdjacentHTML("beforeend",'<div id="appBar" class="win-ui-dark"><\/div>');this._appBarElt=document.getElementById("appBar");n={commands:this._createViewCommands()};t("_initAppBar:WinJS");this._appBar=new WinJS.UI.AppBar(this._appBarElt,n);i("_initAppBar:WinJS");this._initializedSas=false;u=this.queryService("deferredWork");u.queue("SaSButton",50,r,this._ensureSasButton,this);this._appBar.addEventListener("beforeshow",this._onBeforeShowAppbar,false);this._appBarElt.addEventListener("keydown",this._onAppBarKeyDown,false);i("_initAppBar")};n.prototype._initState=function(){var n,r;t("_initState");n={};this.fire("getSettings",n);this._settings=n.settings;r=this._settings.get("view");typeof r=="number"&&this._views.setCurrentView(r);this._onResuming();i("_initState")};n.prototype._initEvents=function(){if(t("_initEvents"),Jx.activation.addListener("suspending",this._onSuspending,this),Jx.root)Jx.root.on("resuming",this._onResuming,this);this.on("goToView",this._onGoToView);this.on("viewUpdated",this._onViewUpdated);this.on("viewReady",this._onViewReady);this.on("createEvent",this._views._onCreateEvent.bind(this._views));this.on("editEvent",this._views._onEditEvent.bind(this._views));this.on("getAppBar",this._onGetAppBar);this.on("getPeekBar",this._onGetPeekBar);this.on("today",this._onToday);this.on("reload",this._onSuspending);this.on("peekBarShow",this._onPeekBarShow);i("_initEvents")};n.prototype._initMessageBar=function(){var r,n;t("_initMessageBar");r=Jx.appData.localSettings().get("LiveDemoMode")||false;r||(this._messageBar=new Chat.MessageBar(1001),this._authMessageBarPresenter=new Chat.AuthMessageBarPresenter,this._syncMessageBarPresenter=new Chat.SyncMessageBarPresenter,this._errorMessageBarPresenter=new Calendar.Controls.ErrorMessageMessageBarPresenter,this._proxyAuthenticator=new Chat.ProxyAuthenticator,t("_initMessageBar:getPlatform"),n={},this.fire("getPlatform",n),i("_initMessageBar:getPlatform"),t("_initMessageBar:initAuthBar"),this._authMessageBarPresenter.init(this._messageBar,n.platform,"messageBar"),i("_initMessageBar:initAuthBar"),t("_initMessageBar:initSyncBar"),this._syncMessageBarPresenter.init(this._messageBar,n.platform,Calendar.scenario,"messageBar"),i("_initMessageBar:initSyncBar"),t("_initMessageBar::initErrorMessageBar"),this._errorMessageBarPresenter.init(this._messageBar,n.platform,this,"messageBar"),i("_initMessageBar::initErrorMessageBar"),t("_initMessageBar:initProxyAuthenticator"),this._proxyAuthenticator.init(n.platform,Calendar.scenario),i("_initMessageBar:initProxyAuthenticator"));i("_initMessageBar")};n.prototype._sync=function(){var n={};this.fire("getPlatform",n);Jx.forceSync(n.platform,Calendar.scenario)};n.prototype._setView=function(n){t("_setView");this._views.getCurrentView()!==n&&this._bici(n,false);this._views.setCurrentView(n);i("_setView")};n.prototype._setToday=function(){this._views.setFocusedDay(Calendar.getToday())};n.prototype._showDatePicker=function(){this._views.showDatePicker()};n.prototype._changeBackground=function(n){this._views.changeBackground(n)};n.prototype._purgeCalendars=function(){var n={};this.fire("getPlatform",n);n.platform.calendarManager.purgeAllCalendars()};n.prototype._onAppBarKeyDown=function(n){(n.keyCode===Jx.KeyCode.rightarrow||n.keyCode===Jx.KeyCode.leftarrow)&&(n.stopPropagation(),n.preventDefault())};n.prototype._onSuspending=function(){var n,r;t("_onSuspending");n=this._views.getFocusedDay();this._settings.set("day",n.getTime());r=Date.now();this._settings.set("time",r);i("_onSuspending")};n.prototype._onResuming=function(){var u;t("_onResuming");var r=Date.now(),f=this._settings.get("time")||0,e=r-f;e<=n.REHYDRATION_TIMEOUT&&(r=this._settings.get("day")||r);this._settings.remove("day");this._settings.remove("time");u=new Date(r);this._views.setFocusedDay(u);this._bici(this._views.getCurrentView(),true);i("_onResuming")};n.prototype._ensureIdsCalendar=function(){this._idsCalendar||(this._idsCalendar=Microsoft.WindowsLive.Instrumentation.Ids.Calendar);this._ensureIdsCalendar=Jx.fnEmpty};n.prototype._bici=function(t,i){setTimeout(function(){this._ensureIdsCalendar();var f=Calendar.Views.Manager.Views,r=n.BiciViews,u=r.month,o=i?this._idsCalendar.calendarViewLaunch:this._idsCalendar.calendarViewClick;switch(t){case f.month:u=r.month;break;case f.week:u=r.week;break;case f.workweek:u=r.workweek;break;case f.day:u=r.day;break;case f.agenda:u=r.agenda}Jx.bici.addToStream(o,u)}.bind(this),3e3)};n.prototype._recordBackgroundAction=function(n){this._ensureIdsCalendar();Jx.bici.addToStream(this._idsCalendar.calendarBackgroundFlyout,n)};n.prototype._onGoToView=function(n){if(!n.handled){this._forceDismiss(n);n.handled=true;this._appbar&&this._appBar.hide();var t=Calendar.Views.Manager.Views[n.data.view];this._views.getCurrentView()===t?this._onTodayClicked():(this._views.setCurrentView(t),this._bici(t,false))}};n.prototype._onViewUpdated=function(n){var u,f;n.handled||(t("_onViewUpdated"),u=n.data,this._navBar&&(u.editing?(this._navBar.destroyUI(),this._peekBar.hide()):(f=this.queryService("deferredWork"),f.queue("NavBar",50,r,function(){this._commandState.editing||this._navBar.buildUI(this._commandState.companion)},this),this._appBar&&(this._appBar.hide(),this._appBar.commands=this._createViewCommands(),this._initializedSas=false,f.queue("SaSButton",50,r,this._ensureSasButton,this)),this._peekBar.allowTabVersion(this._views.allowPeekBarTabVersion()),this._peekBar.show())),this._settings.set("view",this._views.getCurrentView()),this._commandState=u,n.handled=true,i("_onViewUpdated"))};f._onViewReady=function(n){if(this._firstRun&&n.stage===Jx.EventManager.Stages.bubbling){this._firstRun=false;var t=this.queryService("deferredWork");t.queue("AppBar",50,r,this._ensureAppBar,this);t.queue("MsgBar",50,r,this._initMessageBar,this)}};n.prototype._onPeekBarShow=function(n){if(this._navBar&&this._appBar){this._navBar.show();this._appBar.show();n.cancel=true;this._ensureIdsCalendar();var t=(new Windows.Devices.Input.TouchCapabilities).touchPresent?1:0,i=n.data.pointerType==="touch"?1:2;Jx.bici.addToStream(this._idsCalendar.calendarNavAndAppBarInvoke,t,i)}};n.prototype._onGetAppBar=function(n){n.handled||(this._ensureAppBar(),n.data.appBar=this._appBar,n.data.peekBar=this._peekBar,n.handled=true)};n.prototype._onGetPeekBar=function(n){n.handled||(n.data.peekBar=this._peekBar,n.handled=true)};n.prototype._onToday=function(n){n.handled||(this._setToday(),n.handled=true)};n.prototype._preventDefault=function(n){n.preventDefault()};n.prototype._onKeyDown=function(n){this._handleViewCommandKey(n)};n.prototype._forceDismiss=function(){Jx.EventManager.broadcast("lightDismiss",true)};n.prototype._lightDismiss=function(){Jx.EventManager.broadcast("lightDismiss",false)};n.ensureCommandInfo=function(){if(!n.SYNC_LABEL){var t=Jx.res;n.SYNC_LABEL=t.getString("SyncCommand");n.SYNC_TOOLTIP=t.loadCompoundString("SyncTooltip",Jx.key.getLabel("F5"));n.BACKGROUND_LABEL=t.getString("AgendaBackgroundButton");n.BACKGROUND_TOOLTIP=t.loadCompoundString("AgendaBackgroundTooltip",Jx.key.getLabel("Ctrl+B"));n.NEW_LABEL=t.getString("NewCommand");n.NEW_TOOLTIP=t.loadCompoundString("NewTooltip",Jx.key.getLabel("Ctrl+N"));n.BACKGROUND_DEFAULT_LABEL=t.getString("AgendaBackgroundDefault");n.BACKGROUND_BROWSE_LABEL=t.getString("AgendaBackgroundBrowse")}};n.prototype._onBeforeShowAppbar=function(){if(!this._initializedSas){var n=this._appBarElt.querySelector("#sasCommand");n&&this._ensureSasButton()}};n.prototype._hideCommands=function(){this._navBar&&this._navBar.hide();this._appBar&&this._appBar.hide()};n.prototype._createCommandHandler=function(n){return function(t){t.stopPropagation();t.preventDefault();this._hideCommands();n()}.bind(this)};n.prototype._ensureCommandHandlers=function(){this._onTodayClicked=this._setToday.bind(this);this._onSyncClicked=this._sync.bind(this);this._onBackgroundClicked=this._showBackgroundMenu.bind(this);this._onNewClicked=function(){return Jx.EventManager.broadcast("lightDismiss",true),this._views._onCreateEvent({handled:false})}.bind(this);this._ensureCommandHandlers=Jx.fnEmpty};n.prototype._ensureBackgroundPopup=function(){this._ensureCommandHandlers();this._initBackgroundPopup();this._ensureBackgroundPopup=Jx.fnEmpty};n.prototype._initBackgroundPopup=function(){var t=Windows.UI.Popups,r=this._backgroundPopup=new t.PopupMenu,i;this._backgroundPopupShown=false;i=r.commands;i.append(new t.UICommand(n.BACKGROUND_DEFAULT_LABEL,this._changeBackground.bind(this,true),u.chooseDefault));i.append(new t.UICommand(n.BACKGROUND_BROWSE_LABEL,this._changeBackground.bind(this,false),u.chooseCustom))};n.prototype._createViewCommands=function(){return n.ensureCommandInfo(),this._ensureCommandHandlers(),[{icon:"",id:"syncCommand",label:n.SYNC_LABEL,tooltip:n.SYNC_TOOLTIP,section:"selection",type:"button",onclick:this._createCommandHandler(this._onSyncClicked)},{icon:"",id:"backgroundCommand",label:n.BACKGROUND_LABEL,tooltip:n.BACKGROUND_TOOLTIP,section:"selection",type:"button",onclick:this._onBackgroundClicked,hidden:true},{id:"sasCommand"},{icon:"",id:"newEventCommand",label:n.NEW_LABEL,tooltip:n.NEW_TOOLTIP,section:"global",type:"button",onclick:this._createCommandHandler(this._onNewClicked)}]};n.prototype._handleViewCommandKey=function(n){for(var e=n.target,u,o,f,r;Jx.isHTMLElement(e);){if(e.classList.contains("win-settingsflyout"))return;e=e.parentNode}u=false;o=this._commandState;o.editing||(this._ensureCommandHandlers(),f=Calendar.Views.Manager.Views,r=Jx.key.mapKeyCode(n.keyCode),!n.ctrlKey||n.shiftKey||n.altKey?n.ctrlKey||n.shiftKey||n.altKey||(r===Jx.KeyCode.home?(this._onTodayClicked(),u=true):r===Jx.KeyCode.f5&&(this._onSyncClicked(),u=true)):r===Jx.KeyCode.t?(this._onTodayClicked(),u=true):r===Jx.KeyCode.n?(this._onNewClicked(),u=true):r===Jx.KeyCode.g?(t("_handleViewCommandKey:DatePicker"),this._showDatePicker(),u=true,i("_handleViewCommandKey:DatePicker")):r===Jx.KeyCode.b?(this._changeBackground(false),u=true):r===Jx.KeyCode.f5?(this._purgeCalendars(),this._onSyncClicked(),u=true):r===Jx.KeyCode["1"]||r===Jx.KeyCode.a?(this._setView(f.agenda),u=true):r===Jx.KeyCode["2"]||r===Jx.KeyCode.d?(this._setView(f.day),u=true):o.companion||(r===Jx.KeyCode["3"]||r===Jx.KeyCode.o?(this._setView(f.workweek),u=true):r===Jx.KeyCode["4"]||r===Jx.KeyCode.w?(this._setView(f.week),u=true):(r===Jx.KeyCode["5"]||r===Jx.KeyCode.m)&&(this._setView(f.month),u=true)));u&&(n.stopPropagation(),n.preventDefault())};n.prototype._showBackgroundMenu=function(n){if(this._backgroundPopupShown){e("_showBackgroundMenu - Background menu is already shown");return}this._ensureBackgroundPopup();var i=this,t=n.target.getBoundingClientRect(),r={x:t.left,y:t.top,height:t.height,width:t.width};this._backgroundPopupShown=true;this._backgroundPopup.showForSelectionAsync(r).done(function(n){i._backgroundPopupShown=false;var t=u.chooseNothing;n&&(t=n.id);i._recordBackgroundAction(t);i._hideCommands()})};n.prototype._onKeyboardShow=function(){document.body.classList.add("keyboardShown");this._commandState.editing||this._peekBar.hide()};n.prototype._onKeyboardHide=function(){document.body.classList.remove("keyboardShown");this._commandState.editing||this._peekBar.show()}})