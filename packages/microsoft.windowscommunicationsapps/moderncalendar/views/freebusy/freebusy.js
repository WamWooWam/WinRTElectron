Jx.delayDefine(Calendar.Views,"FreeBusy",function(){function i(n){Jx.mark("Calendar:FreeBusy."+n+",StartTA,Calendar")}function r(n){Jx.mark("Calendar:FreeBusy."+n+",StopTA,Calendar")}function e(n,t){return Array.prototype.slice.call(n.querySelectorAll(t))}var u=Calendar.Helpers,t={},f=WinJS.UI.Animation,o=new Jx.DTFormatter("shortTime"),n=Calendar.Views.FreeBusy=function(){if(i("ctor"),this.initComponent(),!n._title){u.ensureFormats();var t=Jx.res;n._title=t.getString("FreeBusyTitle");n._me=t.getString("FreeBusyMe");n._unknown=t.getString("FreeBusyUnknown");n._yesterday=t.getString("Yesterday");n._today=t.getString("Today");n._tomorrow=t.getString("Tomorrow");n._clearRoom=t.getString("FreeBusyClearRoom");n._clearRooms=t.getString("FreeBusyClearRooms");n._startLabel=t.getString("EventStartLabel");n._endLabel=t.getString("EventEndLabel");n._dateFormatter=new Jx.DTFormatter("dayofweek.abbreviated month.abbreviated day");n._rangeFormatter=t.getFormatFunction("DateRange");n._loadingLabel=t.getString("FreeBusyUpdating");n._loadingCompletedLabel=t.getString("FreeBusyCompleted")}this._anchor=Calendar.getToday();this._start=this._anchor;this._end=this._anchor;this._resetUiMembers();this._doUpdateState=this._doUpdateState.bind(this);this._onRoomFinder=this._onRoomFinder.bind(this);this._onAfterShowFlyout=this._onAfterShowFlyout.bind(this);this._onAfterHideFlyout=this._onAfterHideFlyout.bind(this);this._onClearRooms=this._onClearRooms.bind(this);this._onToggleWorkHours=this._onToggleWorkHours.bind(this);this._onRefresh=this._onRefresh.bind(this);this._onBack=this._onBack.bind(this);this._onFocusIn=this._onFocusIn.bind(this);this._onArrowClick=this._onArrowClick.bind(this);this._onScroll=this._onScroll.bind(this);this._onPointerDown=this._onPointerDown.bind(this);this._onPointerMove=this._onPointerMove.bind(this);this._onPointerUp=this._onPointerUp.bind(this);this._onAttrModifed=this._onAttrModified.bind(this);this._onKeyDown=this._onKeyDown.bind(this);r("ctor")};Jx.augment(n,Jx.Component);Jx.augment(n,Jx.Events);n.prototype.setRange=function(n,t){var e,s,o,f,h;if(i("setRange"),(n.getTime()!==this._start.getTime()||t.getTime()!==this._end.getTime())&&(this._start=new Date(n),this._end=new Date(t),e=this._anchor,this._calculateAnchor(),this._host)){if(!u.isSameDate(e,this._anchor)){for(s=Math.round((this._anchor-e)/u.dayInMilliseconds)*this._dayWidth,o=this._schedules.querySelectorAll(".schedule:not(.me) > .container"),f=0,h=o.length;f<h;f++){var c=o[f],l=c.style,a=parseFloat(this._getLeft(l))||0;a-=s;this._setLeft(l,a+"px");c.parentNode.classList.add("fetching")}this._updateWorkerVisible();this._meSchedule.style.opacity="0"}this._updateSlider();this._updateAria();this._setScrollPos();this._updateDateHeaders(true)}r("setRange")};n.prototype.setCalendar=function(n){if(i("setCalendar"),n.id!==this._calendarId){this._calendarId=n.id;this._color=u.processEventColor(n.color);var f=this._accountId;this._accountId=n.account.objectId;this._host&&(this._updateWorkerCalendar(),this._style.innerHTML=t.style.call(this),this._meSchedule.style.opacity="0",this._setScrollPos(),this._accountId!==f&&this._resetScheduleUi())}r("setCalendar")};n.prototype.setAttendees=function(n){var e,t,s,u,f,o;for(i("setAttendees"),this._attendees=[],this._attendeeEmails=[],e={},t=0,s=n.length;t<s;t++)u=n[t],u.isJsRecipient||(f=u.emailAddress,o=f.toLowerCase(),e[o]||(this._attendeeEmails.push(f),this._attendees.push({emailHtml:Jx.escapeHtml(f),nameHtml:Jx.escapeHtml(u.calculatedUIName)}),e[o]=true));this._host&&(this._worker.postCommand("FreeBusy/setAttendees",{attendees:this._getCombinedAttendeeEmails()},this._id),this._updateAttendeeUi(),this._updateArrows(),this._updateProgress());r("setAttendees")};n.prototype.setResource=function(n){n?this._setNewResource(n):this._clearResource()};n.prototype.getState=function(){i("getState");this._doUpdateState();var n={start:new Date(this._start.getTime()),end:new Date(this._end.getTime()),resource:this._resource};return r("getState"),n};n.prototype.getUI=function(f){i("getUI");var e=Microsoft.WindowsLive.Platform.Calendar.BusyStatus,o=u.accEventStatuses;f.html=t.main.call(this,{idHtml:this._id,workHours:this._workHours,titleHtml:Jx.escapeHtml(n._title),meHtml:Jx.escapeHtml(n._me),attendees:this._attendees,rooms:this._rooms,statusBusyHtml:Jx.escapeHtml(o[e.busy]),statusTentativeHtml:Jx.escapeHtml(o[e.tentative]),statusOofHtml:Jx.escapeHtml(o[e.outOfOffice]),statusUnknownHtml:Jx.escapeHtml(n._unknown)});r("getUI")};n.prototype.activateUI=function(){i("activateUI");this._host=document.getElementById(this._id);this._initWorker();this._isRtl=Jx.isRtl();this._style=this._host.querySelector("style");this._back=this._host.querySelector(".win-backbutton");this._date=this._host.querySelector(".date");this._dayNames=this._host.querySelectorAll(".day .name");this._progress=this._host.querySelector(".fetch-progress");this._progressText=this._host.querySelector(".fetch-progress-text");this._arrowUp=this._host.querySelector(".arrow.up");this._arrowDown=this._host.querySelector(".arrow.down");this._scroller=this._host.querySelector(".scroller");this._surface=this._scroller.querySelector(".surface");this._slider=this._scroller.querySelector(".slider");this._sliderFocus=this._slider.querySelector(".focus-region");this._grabberTouchLeft=this._slider.querySelector(".left.grabberTouch");this._grabberTouchRight=this._slider.querySelector(".right.grabberTouch");this._grabberLeft=this._grabberTouchLeft.firstElementChild;this._grabberRight=this._grabberTouchRight.firstElementChild;this._attendeesEl=this._host.querySelector(".attendees");this._meAttendee=this._attendeesEl.querySelector(".me");this._otherAttendees=this._attendeesEl.querySelector(".other");this._roomAttendees=this._attendeesEl.querySelector(".rooms");this._schedules=this._host.querySelector(".schedules");this._meSchedule=this._schedules.querySelector(".me > .container");this._otherSchedules=this._schedules.querySelector(".other");this._roomSchedules=this._schedules.querySelector(".rooms");this._surface._onPointerDown=this._onSurfacePointerDown;this._surface._onPointerUp=this._onSurfacePointerUp;this._grabberTouchLeft._onPointerDown=this._onGrabberTouchPointerDown;this._grabberTouchLeft._onPointerMove=this._onGrabberPointerMoveLeft;this._grabberTouchLeft._onPointerUp=this._onGrabberPointerUpLeft;this._grabberTouchRight._onPointerDown=this._onGrabberTouchPointerDown;this._grabberTouchRight._onPointerMove=this._onGrabberPointerMoveRight;this._grabberTouchRight._onPointerUp=this._onGrabberPointerUpRight;this._grabberLeft._onPointerMove=this._onGrabberPointerMoveLeft;this._grabberLeft._onPointerUp=this._onGrabberPointerUpLeft;this._grabberRight._onPointerMove=this._onGrabberPointerMoveRight;this._grabberRight._onPointerUp=this._onGrabberPointerUpRight;this._initAppbar();this._updateSlider();this._updateAria();this._setScrollPos();this._postProcessRoomUi();this._updateArrows();this._onScroll();this.resume();r("activateUI")};n.prototype.resume=function(){i("resume");this._paused&&(this._host.disabled=false,this._sliderFocus.setActive(),this._hookEvents(),this._worker.postCommand("FreeBusy/resume",null,this._id),this._updateProgress(),this._roomFinderWell&&this._roomFinderWell.setDisabled(false),this._paused=false);r("resume")};n.prototype.pause=function(){i("pause");this._paused||(this._roomFinderWell&&this._roomFinderWell.setDisabled(true),this._worker.postCommand("FreeBusy/pause",null,this._id),this._unhookEvents(),this._host.disabled=true,this._paused=true);r("pause")};n.prototype.deactivateUI=function(){i("deactivateUI");this.pause();this._worker.postCommand("FreeBusy/cancel",null,this._id);this._worker.removeListener("FreeBusy/getEvents",this._onGetEvents,this);this._worker.removeListener("FreeBusy/eventsChanged",this._onEventsChanged,this);this._worker.removeListener("FreeBusy/meAria",this._onGetMeAria,this);this._worker.removeListener("FreeBusy/schedules",this._onGetSchedules,this);this._worker.removeListener("FreeBusy/attendeeAria",this._onGetAttendeeAria,this);this._roomFinderWell&&(this._roomFinderWell.removeListener(AddressWell.Events.recipientsAdded,this._onRoomsAdded,this),this._roomFinderWell.removeListener(AddressWell.Events.beforeRecipientsAdded,this._onBeforeRoomsAdded,this),this._roomFinderWell.shutdownUI(),this._flyoutHost.outerHTML="");this._commandWorkHours.removeEventListener("DOMAttrModified",this._onToggleWorkHours,false);this._resetUiMembers();r("deactivateUI")};n._hourWidth=160;n._halfWidth=n._hourWidth/2;n._quarterWidth=n._halfWidth/2;n._minuteWidth=n._hourWidth/60;n._dayWidth=n._hourWidth*24;n._numberOfDays=35;n._scrollWidth=n._dayWidth*n._numberOfDays;n._workStart=8;n._workEnd=19;n._workHours=n._workEnd-n._workStart;n._dayWidthForWork=n._hourWidth*n._workHours;n._scrollWidthForWork=n._dayWidthForWork*n._numberOfDays;t.style=function(){return"#"+this._id+" .schedules .status {    background-color: "+this._color+";}#"+this._id+" .fetch-progress {    color: "+this._color+";}"};t.hours=function(){var r=new Date(2e3,1,1),i="",o="",t,f,e,s;for(i+="<div class='day'><div class='name'><\/div>",t=0;t<24;t++)f="hour",n._workStart<=t&&t<n._workEnd&&(f+=" work"),i+="<div class='"+f+"'>"+Jx.escapeHtml(u.simpleTime.format(r))+"<\/div>",r.setHours(r.getHours()+1);for(i+="<\/div>",e=0,s=n._numberOfDays;e<s;e++)o+=i;return o};t.attendees=function(n){for(var r=n.attendees,u="",i=0,f=r.length;i<f;i++)u+=t.attendee(r[i]);return u};t.roomAttendees=function(n){for(var r=n.rooms,u="",i=0,f=r.length;i<f;i++)u+=t.roomAttendee(r[i]);return u};t.schedules=function(n){for(var r=n.attendees,u="",i=0,f=r.length;i<f;i++)u+=t.schedule(r[i]);return u};t.roomSchedules=function(n){for(var r=n.rooms,u="",i=0,f=r.length;i<f;i++)u+=t.roomSchedule(r[i]);return u};t.main=function(n){return'<div id="'+n.idHtml+'" class="freebusy '+(n.workHours?"workHours":"")+'"><style>'+t.style.call(this,n)+'<\/style><div role="alert" aria-live="polite" aria-hidden="true"><progress class="fetch-progress" aria-hidden="true"><\/progress><span class="fetch-progress-text"><\/span><\/div>'+t.header.call(this,n)+t.grid.call(this,n)+"<\/div>"};t.header=function(n){return'<div class="header"><button type="button" class="win-backbutton" aria-label="'+Jx.escapeHtml(Jx.res.getString("AccBackArrow"))+'"><\/button><div class="text">'+n.titleHtml+"<\/div><\/div>"};t.grid=function(n){return'<div class="grid"><input type="button" class="arrow up" value="" tabindex="0"><input type="button" class="arrow down" value="" tabindex="0"><div class="date"><\/div><div class="scrollContainer"><div class="scroller"><div class="surface"><div class="times" aria-hidden="true">'+t.hours.call(this,n)+'<\/div><div class="schedules" aria-hidden="true"><div class="me schedule"><div class="container"><\/div><\/div><div class="other">'+t.schedules.call(this,n)+'<\/div><div class="rooms">'+t.roomSchedules.call(this,n)+'<\/div><\/div><div class="slider"><div class="left line"><\/div><div class="right line"><\/div><div class="focus-region" tabindex="0" role="slider" aria-live="assertive" aria-valuemin="0" aria-valuemax="10" aria-valuenow="5"><\/div><div class="left grabberTouch" role="slider" aria-live="assertive" tabindex="0" aria-valuemin="0" aria-valuemax="10" aria-valuenow="5"><div class="grabber"><\/div><\/div><div class="right grabberTouch" role="slider" aria-live="assertive" tabindex="0" aria-valuemin="0" aria-valuemax="10" aria-valuenow="5"><div class="grabber"><\/div><\/div><\/div><\/div><\/div><\/div><div class="attendeeContainer"><div class="attendees"><div class="attendee me" tabindex="0" aria-live="polite">'+n.meHtml+'<\/div><div class="other">'+t.attendees.call(this,n)+'<\/div><div class="rooms">'+t.roomAttendees.call(this,n)+"<\/div><\/div><\/div><\/div>"};t.attendee=function(n){return'<div class="attendee" data-attendee="'+n.emailHtml+'" tabindex="0" aria-live="polite">'+n.nameHtml+"<\/div>"};t.roomAttendee=function(n){var i="room"+Jx.uid(),t='<div class="room"><input type="radio" id="'+i+'" class="room-radio" data-attendee="'+n.emailHtml+'" tabindex="0" aria-live="polite"';return n.checked&&(t+=' checked="true"'),t+('><label data-for="'+n.roomId+'" class="name">'+n.nameHtml+"<\/label><\/div>")};t.schedule=function(n){return'<div class="schedule fetching" data-attendee="'+n.emailHtml+'"><div class="container"><\/div><\/div>'};t.roomSchedule=function(n){return'<div class="schedule fetching" data-attendee="'+n.emailHtml+'"><div class="container"><\/div><\/div>'};n.prototype._resetUiMembers=function(){this._host=null;this._worker=null;this._dayOffset=-1;this._updateTimeout=null;this._setWorkHours(true);this._calendarId=null;this._accountId=null;this._color=null;this._attendees=[];this._attendeeEmails=[];this._rooms=[];this._roomEmails=[];this._resource=null;this._paused=true;this._appbar=null;this._commandClearRooms=null;this._commandWorkHours=null;this._flyoutHost=null;this._flyout=null;this._roomFinderWell=null;this._style=null;this._back=null;this._date=null;this._progress=null;this._progressText=null;this._arrowUp=null;this._arrowDown=null;this._scroller=null;this._surface=null;this._slider=null;this._sliderFocus=null;this._grabberTouchLeft=null;this._grabberTouchRight=null;this._grabberLeft=null;this._grabberRight=null;this._attendeesEl=null;this._meAttendee=null;this._otherAttendees=null;this._roomAttendees=null;this._schedules=null;this._meSchedule=null;this._otherSchedules=null;this._roomSchedules=null;this._pointerTarget=null;this._pointerId=null;this._scrollLeft=0;this._scrollHeight=0;this._offsetHeight=0;this._translateY=0;this._initialSurfaceX=0};n.prototype._initAppbar=function(){var t={},n;this.fire("getAppBar",t);this._appbar=t.appBar;n=Jx.res;this._appbar.commands=[{id:"refreshCommand",icon:"",label:n.getString("FreeBusyRefresh"),section:"global",type:"button",onclick:this._onRefresh},{icon:"",id:"workHoursCommand",label:n.getString("FreeBusyWorkHours"),section:"global",type:"toggle",selected:this._workHours}];this._commandWorkHours=this._appbar.getCommandById("workHoursCommand");this._commandWorkHours.addEventListener("DOMAttrModified",this._onToggleWorkHours,false)};n.prototype._getLeft=function(n){return this._isRtl?n.right:n.left};n.prototype._getRight=function(n){return this._isRtl?n.left:n.right};n.prototype._setLeft=function(n,t){this._isRtl?n.right=t:n.left=t};n.prototype._setRight=function(n,t){this._isRtl?n.left=t:n.right=t};n.prototype._setWorkHours=function(t){var e,r,i,u,s,o,f,h;if(t!==this._workHours&&(t?(this._workHours=true,this._hourOffset=n._workStart,this._hoursPerDay=n._workHours,this._dayWidth=n._dayWidthForWork,this._scrollWidth=n._scrollWidthForWork,e="add",r=this._start.getHours(),i=this._end.getHours(),r<n._workStart?(u=n._workStart-r,this._start.setHours(n._workStart),i+=u,this._end.setHours(i)):n._workEnd<=r&&(u=r-n._workEnd+1,s=this._start.getMinutes(),this._start.setHours(r-u),this._start.setMinutes(0),i-=u,this._end.setHours(i),this._end.setMinutes(this._end.getMinutes()-s)),i<n._workStart?this._end.setHours(n._workStart):n._workEnd<=i&&(this._end.setHours(n._workEnd),this._end.setMinutes(0))):(this._workHours=false,this._hourOffset=0,this._hoursPerDay=24,this._dayWidth=n._dayWidth,this._scrollWidth=n._scrollWidth,e="remove"),this._host)){for(this._host.classList[e]("workHours"),o=this._schedules.querySelectorAll(".schedule .container"),f=0,h=o.length;f<h;f++)o[f].innerHTML="";this._worker.postCommand("FreeBusy/setWorkHours",{workHours:t},this._id);this._updateSlider();this._setScrollPos();this._commandWorkHours.selected=t}};n.prototype._setNewResource=function(n){var u=n.email,i,r;this._resource&&this._resource.email===u||(i=u.toLowerCase(),r=n.name,this._resource={email:i,name:r,emailHtml:Jx.escapeHtml(i),nameHtml:Jx.escapeHtml(r),checked:true},this._roomEmails=[i],this._rooms=[this._resource],this._host&&(this._roomAttendees.innerHTML=t.roomAttendees({rooms:this._rooms}),this._roomSchedules.innerHTML=t.roomSchedules({rooms:this._rooms}),this._postProcessRoomUi(),this._updateArrows(),this._worker.postCommand("FreeBusy/setAttendees",{attendees:this._getCombinedAttendeeEmails()},this._id)))};n.prototype._clearResource=function(){var t,n,i;if(this._resource&&(this._resource=null,this._host)){for(t=e(this._roomAttendees,"input"),n=0,i=t.length;n<i;n++)t[n].checked=false;this._worker.postCommand("FreeBusy/setAttendees",{attendees:this._getCombinedAttendeeEmails()},this._id)}};n.prototype._calculateAnchor=function(){var e=this._start.getFullYear(),o=this._start.getMonth(),s=this._start.getDate(),f=Calendar.getToday(),t,i,r;this._workHours&&(t=this._start.getHours(),t<n._workStart||n._workEnd<=t?this._setWorkHours(false):(t=this._end.getHours(),(t<n._workStart||n._workEnd<=t)&&this._setWorkHours(false)));this._start<f?this._anchor=new Date(e,o,s):(i=new Date(f),i.setDate(i.getDate()+7),this._start<i?this._anchor=f:(r=this._start.getDay()-u.firstDayOfWeek,r<0&&(r+=7),this._anchor=new Date(e,o,s-r)))};n.prototype._getFocusedDate=function(){var n=new Date(this._anchor);return n.setDate(n.getDate()+this._dayOffset),n};n.prototype._getDateName=function(t){var i=u.getDayInfo(Calendar.getToday(),t);return i.isToday?n._today:i.isTomorrow?n._tomorrow:i.isYesterday?n._yesterday:n._dateFormatter.format(t)};n.prototype._updateDateHeaders=function(n){var f=Math.floor(this._scrollLeft/this._dayWidth),t,u,e;(n||f!==this._dayOffset)&&(i("_updateDateHeaders"),this._dayOffset=f,t=this._getFocusedDate(),u=this._getDateName(t),this._date.innerText=u,this._dayNames[f].innerText=u,e=this._dayNames[f+1],e&&(t.setDate(t.getDate()+1),u=this._getDateName(t),e.innerText=u),r("_updateDateHeaders"))};n.prototype._updateSlider=function(){var i=Math.floor((this._start-this._anchor)/u.dayInMilliseconds),r=(this._start.getHours()-this._hourOffset)*60+this._start.getMinutes(),f=Math.floor((this._end-this._anchor)/u.dayInMilliseconds),e=(this._end.getHours()-this._hourOffset)*60+this._end.getMinutes(),o=i*this._hoursPerDay*n._hourWidth+r*n._minuteWidth,s=f*this._hoursPerDay*n._hourWidth+e*n._minuteWidth,t=this._slider.style;this._setLeft(t,o+"px");this._setRight(t,this._scrollWidth-s+"px")};n.prototype._setScrollPos=function(){var r=Math.floor((this._start-this._anchor)/u.dayInMilliseconds),t=this._start.getHours()-this._hourOffset,i=r*this._hoursPerDay+t;t&&(i-=1);this._scrollLeft=i*n._hourWidth;this._scroller.scrollLeft=this._scrollLeft};n.prototype._swapPointerListener=function(n){var t=this._pointerId;this._unhookPointerEvents();this._hookPointerEvents(n,t)};n.prototype._getCombinedAttendeeEmails=function(){return this._attendeeEmails.concat(this._roomEmails)};n.prototype._updateAttendeeUi=function(){for(var f={},n,o,i,r;this._otherAttendees.firstElementChild;){var u=this._otherAttendees.firstElementChild,e=this._otherSchedules.firstElementChild,s=u.getAttribute("data-attendee");f[s]={attendee:u,schedule:e};this._otherAttendees.removeChild(u);this._otherSchedules.removeChild(e)}for(n=0,o=this._attendees.length;n<o;n++)i=this._attendees[n],r=f[i.emailHtml],r?(this._otherAttendees.appendChild(r.attendee),this._otherSchedules.appendChild(r.schedule)):(this._otherAttendees.insertAdjacentHTML("beforeend",t.attendee(i)),this._otherSchedules.insertAdjacentHTML("beforeend",t.schedule(i)))};n.prototype._resetScheduleUi=function(){for(var r=this._schedules.querySelectorAll(".schedule"),t,i,n=0,u=r.length;n<u;n++)t=r[n],i=t.classList,f.fadeOut(t.firstElementChild).done(),i.contains("me")||i.add("fetching");this._updateProgress()};n.prototype._updateProgress=function(){var t=this._schedules.querySelector(".fetching");this._progress.style.display=t?"block":"none";this._progressText.innerText=t?n._loadingLabel:n._loadingCompletedLabel};n.prototype._updateArrows=function(n){var i=0,t=0,r;this._offsetHeight=this._scroller.offsetHeight;this._scrollHeight=this._scroller.scrollHeight;this._offsetHeight<this._scrollHeight&&(n=n||0,i=this._offsetHeight-this._scrollHeight,t=Math.min(Math.max(this._translateY+n,i),0));i?(this._arrowUp.style.display=t?"block":"",this._arrowDown.style.display=i<t?"block":""):(this._arrowUp.style.display="",this._arrowDown.style.display="");t!==this._translateY&&(r="translateY("+t+"px)",this._attendeesEl.style.transform=r,this._schedules.style.transform=r,this._translateY=t)};n.prototype._updateState=function(){clearTimeout(this._updateTimeout);this._updateTimeout=setTimeout(this._doUpdateState,250)};n.prototype._doUpdateState=function(){var t,i,p,o;clearTimeout(this._updateTimeout);this._updateTimeout=null;var s=this._slider.style,r=parseInt(this._getLeft(s),10),u=this._scrollWidth-parseInt(this._getRight(s),10),w=Math.floor(r/this._dayWidth),b=r%this._dayWidth/n._minuteWidth,h=Math.floor(u/this._dayWidth),f=u%this._dayWidth/n._minuteWidth;r<u&&(f||(h-=1,f=this._dayWidth/n._minuteWidth));var c=this._anchor.getFullYear(),l=this._anchor.getMonth(),a=this._anchor.getDate(),v=new Date(c,l,a+w,this._hourOffset,Math.round(b)),y=new Date(c,l,a+h,this._hourOffset,Math.round(f));for((v.getTime()!==this._start.getTime()||y.getTime()!==this._end.getTime())&&(this._start=v,this._end=y,this._updateAria()),this._resource=null,t=e(this._roomAttendees,"input"),i=0,p=t.length;i<p;i++)if(o=t[i],o.checked){this._resource=this._rooms[t.indexOf(o)];break}};n.prototype._postProcessRoomUi=function(){for(var u=this._roomAttendees.querySelectorAll("input"),r,i,n=0,t=u.length;n<t;n++)u[n].name="freebusy-room";for(r=this._roomAttendees.querySelectorAll(".name[data-for]"),n=0,t=r.length;n<t;n++)i=r[n],i.setAttribute("for",i.getAttribute("data-for")),i.removeAttribute("data-for")};n.prototype._updateAria=function(){var e=this._start,i=this._end,s=u.isSameDate(e,i),h=u.dateAndTime.format(e),c=s?o.format(i):u.dateAndTime.format(i),t=n._rangeFormatter(h,c),r,f;this._sliderFocus.setAttribute("aria-label",t);this._sliderFocus.setAttribute("aria-valuetext",t);r=n._startLabel+", "+t;this._grabberTouchLeft.setAttribute("aria-label",r);this._grabberTouchLeft.setAttribute("aria-valuetext",r);f=n._endLabel+", "+t;this._grabberTouchRight.setAttribute("aria-label",f);this._grabberTouchRight.setAttribute("aria-valuetext",f);this._updateWorkerSelected()};n.prototype._onRoomFinder=function(){var n,t,i,r;this._roomFinderWell||(n={},this.fire("getPlatform",n),t=n.platform,i=Jx.res.getString("FreeBusyRoomFinderHint"),this._roomFinderWell=new AddressWell.Controller("roomFinder",null,t,false,i,AddressWell.ContactSelectionMode.roomContacts),this._roomFinderWell.addListener(AddressWell.Events.beforeRecipientsAdded,this._onBeforeRoomsAdded,this),this._roomFinderWell.addListener(AddressWell.Events.recipientsAdded,this._onRoomsAdded,this),this.appendChild(this._roomFinderWell),this._flyoutHost.innerHTML=Jx.getUI(this._roomFinderWell).html,this._roomFinderWell.activateUI(),this._roomFinderWell.setAriaLabel(i),r=t.accountManager.loadAccount(this._accountId),this._roomFinderWell.setContextualAccount(r))};n.prototype._onAfterShowFlyout=function(){this._roomFinderWell.focusInput()};n.prototype._onAfterHideFlyout=function(){this._roomFinderWell.clear()};n.prototype._onClearRooms=function(){this._roomAttendees.innerHTML="";this._roomSchedules.innerHTML="";this._updateArrows();this._rooms=[];this._roomEmails=[];this._resource=null;this._worker.postCommand("FreeBusy/setAttendees",{attendees:this._getCombinedAttendeeEmails()},this._id);this._updateProgress();this._appbar.hide()};n.prototype._onToggleWorkHours=function(n){if(n.attrName==="aria-checked"){var t=n.newValue==="true";this._setWorkHours(t);this._appbar.hide()}};n.prototype._onRefresh=function(){this._resetScheduleUi();this._worker.postCommand("FreeBusy/refresh",null,this._id);this._appbar.hide()};n.prototype._hookEvents=function(){this._back.addEventListener("click",this._onBack,false);this._scroller.addEventListener("scroll",this._onScroll,false);this._attendeesEl.addEventListener("focusin",this._onFocusIn,false);this._arrowUp.addEventListener("click",this._onArrowClick,false);this._arrowDown.addEventListener("click",this._onArrowClick,false);this._surface.addEventListener("MSPointerDown",this._onPointerDown,false);this._sliderFocus.addEventListener("DOMAttrModified",this._onAttrModifed,false);this._grabberTouchLeft.addEventListener("MSPointerDown",this._onPointerDown,false);this._grabberTouchRight.addEventListener("MSPointerDown",this._onPointerDown,false);this._grabberLeft.addEventListener("MSPointerDown",this._onPointerDown,false);this._grabberRight.addEventListener("MSPointerDown",this._onPointerDown,false);this._grabberTouchLeft.addEventListener("DOMAttrModified",this._onAttrModifed,false);this._grabberTouchRight.addEventListener("DOMAttrModified",this._onAttrModifed,false);window.addEventListener("keydown",this._onKeyDown,false);this.on("resizeWindow",this._onResizeWindow)};n.prototype._onBack=function(){i("_onBack");this.raiseEvent("back",this.getState());r("_onBack")};n.prototype._onFocusIn=function(n){var r=n.target,u=r.offsetTop,t=u+this._translateY,i;t<0?this._updateArrows(-t):(i=this._offsetHeight-this._attendeesEl.offsetTop,t+=r.offsetHeight,i<t&&this._updateArrows(i-t))};n.prototype._onArrowClick=function(n){i("_onArrowClick");var t=this._offsetHeight-this._attendeesEl.offsetTop-this._meSchedule.offsetHeight;n.target===this._arrowUp?this._updateArrows(t):this._updateArrows(-t);r("_onArrowClick")};n.prototype._onScroll=function(){i("_onScroll");this._scrollLeft=this._scroller.scrollLeft;this._updateDateHeaders(false);r("_onScroll")};n.prototype._onPointerDown=function(n){if(!this._pointerTarget&&n.button===0){var t=n.currentTarget;(!t._onPointerDown||t._onPointerDown.call(this,n))&&this._hookPointerEvents(t,n.pointerId)}};n.prototype._onPointerMove=function(n){var t=this._pointerTarget;t&&n.pointerId===this._pointerId&&t._onPointerMove&&t._onPointerMove.call(this,n)};n.prototype._hookPointerEvents=function(n,t){n.addEventListener("MSPointerMove",this._onPointerMove,false);n.addEventListener("MSPointerUp",this._onPointerUp,false);n.addEventListener("MSPointerCancel",this._onPointerUp,false);n.addEventListener("MSLostPointerCapture",this._onPointerUp,false);n.msSetPointerCapture(t);this._pointerTarget=n;this._pointerId=t};n.prototype._unhookPointerEvents=function(){var n=this._pointerTarget;n&&(n.msReleasePointerCapture(this._pointerId),n.removeEventListener("MSLostPointerCapture",this._onPointerUp,false),n.removeEventListener("MSPointerCancel",this._onPointerUp,false),n.removeEventListener("MSPointerUp",this._onPointerUp,false),n.removeEventListener("MSPointerMove",this._onPointerMove,false),this._pointerId=null,this._pointerTarget=null)};n.prototype._onPointerUp=function(n){var t=this._pointerTarget;t&&n.pointerId===this._pointerId&&(t._onPointerUp&&t._onPointerUp.call(this,n),this._unhookPointerEvents())};n.prototype._calculateOffsetX=function(t){for(var i=t.target,u=t.currentTarget,r=t.offsetX;i!==u;)r+=i.offsetLeft,i=i.parentNode;return this._isRtl&&(r+=n._halfWidth),r-r%n._halfWidth};n.prototype._onSurfacePointerDown=function(n){return this._initialSurfaceX=this._calculateOffsetX(n),true};n.prototype._onSurfacePointerUp=function(n){var f,t;if(n.type!=="MSPointerCancel"&&n.type!=="pointercancel"&&(f=n.offsetY,0<=f&&f<=this._pointerTarget.offsetHeight&&(t=this._calculateOffsetX(n),t===this._initialSurfaceX))){this._isRtl&&(t=this._scrollWidth-t);var r=this._slider.style,u=parseFloat(this._getLeft(r)),i=parseFloat(this._getRight(r)),e=t-u;u=t;i-=e;i<0&&(u+=i,i=0);this._setLeft(r,u+"px");this._setRight(r,i+"px");this._updateState()}};n.prototype._onGrabberTouchPointerDown=function(n){return n.pointerType==="touch"};n.prototype._onGrabberPointerMoveLeft=function(n){var u;i("_onGrabberPointerMoveLeft");u=n.offsetX;this._isRtl&&(u*=-1);var f=this._slider.style,t=parseInt(this._getLeft(f),10)+u,e=this._scrollWidth-parseInt(this._getRight(f),10);t<this._scrollLeft&&(t=this._scrollLeft);e-t<0&&(this._swapPointerListener(this._grabberRight),t=e);this._setLeft(f,t+"px");r("_onGrabberPointerMoveLeft")};n.prototype._onGrabberPointerMoveRight=function(n){var t;i("_onGrabberPointerMoveRight");t=n.offsetX;this._isRtl&&(t*=-1);var u=this._slider.style,e=parseInt(this._getLeft(u),10),f=parseInt(this._getRight(u),10)-t,o=this._scrollWidth-f-e;o<0&&(this._swapPointerListener(this._grabberLeft),f=this._scrollWidth-e);this._setRight(u,f+"px");r("_onGrabberPointerMoveRight")};n.prototype._onGrabberPointerUpLeft=function(){i("_onGrabberPointerUpLeft");var u=this._slider.style,t=parseInt(this._getLeft(u),10),f=this._scrollWidth-parseInt(this._getRight(u),10);t+=n._quarterWidth;t-=t%n._halfWidth;f<t&&(t-=n._halfWidth);this._setLeft(u,t+"px");this._updateState();r("_onGrabberPointerUpLeft")};n.prototype._onGrabberPointerUpRight=function(){i("_onGrabberPointerUpRight");var u=this._slider.style,f=parseInt(this._getLeft(u),10),t=this._scrollWidth-parseInt(this._getRight(u),10);t+=n._quarterWidth;t-=t%n._halfWidth;t<f&&(t+=n._halfWidth);this._setRight(u,this._scrollWidth-t+"px");this._updateState();r("_onGrabberPointerUpRight")};n.prototype._onResizeWindow=function(n){i("_onResizeWindow");n.data.outerWidth<=499?this._onBack():this._scroller.scrollLeft=this._scrollLeft;r("_onResizeWindow")};n.prototype._handleDecrement=function(t){i("_handleDecrement");var o=this._slider.style,u=parseInt(this._getLeft(o),10),f=this._scrollWidth-parseInt(this._getRight(o),10),e;t===this._sliderFocus?u&&(e=u%n._halfWidth||n._halfWidth,u-=e,f-=e,u<this._scrollLeft&&(this._scroller.scrollLeft=u)):t===this._grabberTouchLeft?u&&(e=u%n._halfWidth||n._halfWidth,u-=e,u<this._scrollLeft&&(this._scroller.scrollLeft=u)):t===this._grabberTouchRight&&(e=f%n._halfWidth||n._halfWidth,f-=e,f-u<n._halfWidth?(u-=1,u-=u%n._halfWidth,u<=0&&(u=0,f=n._halfWidth),u<this._scrollLeft&&(this._scroller.scrollLeft=u)):f<=this._scrollLeft&&(this._scroller.scrollLeft=f-n._halfWidth));this._setLeft(o,u+"px");this._setRight(o,this._scrollWidth-f+"px");this._updateState();r("_handleDecrement")};n.prototype._handleIncrement=function(t){var c;i("_handleIncrement");var h=this._slider.style,f=parseInt(this._getLeft(h),10),u=this._scrollWidth-parseInt(this._getRight(h),10),e,s=this._scrollLeft+this._scroller.offsetWidth,o=this._scroller.scrollWidth;t===this._sliderFocus?(e=f+n._halfWidth,e-=e%n._halfWidth,u+=e-f,f=e,o<u&&(f-=u-o,u=o),s<u&&(this._scroller.scrollLeft+=u-s)):t===this._grabberTouchLeft?(e=f+n._halfWidth,e-=e%n._halfWidth,f=e,u=Math.max(u,f+n._halfWidth),o<u&&(f-=u-o,u=o),c=f+n._halfWidth,s<c&&(this._scroller.scrollLeft=c-this._scroller.offsetWidth)):t===this._grabberTouchRight&&(u+=n._halfWidth,u-=u%n._halfWidth,o<u&&(u=o),s<u&&(this._scroller.scrollLeft+=u-s));this._setLeft(h,f+"px");this._setRight(h,this._scrollWidth-u+"px");this._updateState();r("_handleIncrement")};n.prototype._onKeyDown=function(n){var i=n.key,t;i==="Esc"?this._onBack():(t=n.target,(t===this._sliderFocus||t===this._grabberTouchLeft||t===this._grabberTouchRight)&&(i==="Left"?(this._isRtl?this._handleIncrement(t):this._handleDecrement(t),n.preventDefault()):i==="Right"&&(this._isRtl?this._handleDecrement(t):this._handleIncrement(t),n.preventDefault())))};n.prototype._onAttrModified=function(n){if(n.attrName==="aria-valuenow"){var t=n.target,i=parseInt(n.newValue,10);i!==5&&(t.setAttribute("aria-valuenow",5),i<5?this._handleDecrement(t):this._handleIncrement(t),this._doUpdateState())}};n.prototype._unhookEvents=function(){this._unhookPointerEvents();this.detach("resizeWindow",this._onResizeWindow);window.removeEventListener("keydown",this._onKeyDown,false);this._grabberTouchRight.removeEventListener("DOMAttrModified",this._onAttrModifed,false);this._grabberTouchLeft.removeEventListener("DOMAttrModified",this._onAttrModifed,false);this._grabberRight.removeEventListener("MSPointerDown",this._onPointerDown,false);this._grabberLeft.removeEventListener("MSPointerDown",this._onPointerDown,false);this._grabberTouchRight.removeEventListener("MSPointerDown",this._onPointerDown,false);this._grabberTouchLeft.removeEventListener("MSPointerDown",this._onPointerDown,false);this._surface.removeEventListener("MSPointerDown",this._onPointerDown,false);this._arrowDown.removeEventListener("click",this._onArrowClick,false);this._arrowUp.removeEventListener("click",this._onArrowClick,false);this._attendeesEl.removeEventListener("focusin",this._onFocusIn,false);this._scroller.removeEventListener("scroll",this._onScroll,false);this._back.removeEventListener("click",this._onBack,false)};n.prototype._onBeforeRoomsAdded=function(n){var e=n.recipients,i,f,s,r,h,u,o;if(n.cancelled=true,e.length){for(i=[],f=0,s=e.length;f<s;f++)r=e[f],r.isJsRecipient||(h=r.emailAddress,u=h.toLowerCase(),this._roomEmails.indexOf(u)===-1&&(o={email:u,name:r.calculatedUIName,emailHtml:Jx.escapeHtml(u),nameHtml:Jx.escapeHtml(r.calculatedUIName),checked:false},this._roomEmails.push(u),this._rooms.push(o),i.push(o)));i.length&&(this._rooms.length===1&&(this._rooms[0].checked=true),this._roomAttendees.insertAdjacentHTML("beforeend",t.roomAttendees({rooms:i})),this._roomSchedules.insertAdjacentHTML("beforeend",t.roomSchedules({rooms:i})),this._postProcessRoomUi(),this._updateArrows(-this._scroller.scrollHeight),this._worker.postCommand("FreeBusy/setAttendees",{attendees:this._getCombinedAttendeeEmails()},this._id),this._updateProgress())}this._appbar.hide()};n.prototype._onRoomsAdded=function(){this._roomFinderWell.clearInput()};n.prototype._initWorker=function(){var i;i={};this.fire("getPlatformWorker",i);this._worker=i.platformWorker;this._worker.addListener("FreeBusy/getEvents",this._onGetEvents,this);this._worker.addListener("FreeBusy/eventsChanged",this._onEventsChanged,this);this._worker.addListener("FreeBusy/meAria",this._onGetMeAria,this);this._worker.addListener("FreeBusy/schedules",this._onGetSchedules,this);this._worker.addListener("FreeBusy/attendeeAria",this._onGetAttendeeAria,this);var t=this._anchor,r=t.getFullYear(),u=t.getMonth(),f=t.getDate(),e=new Date(r,u,f+n._numberOfDays);this._worker.postCommand("FreeBusy/initialize",{visible:{start:t.getTime(),end:e.getTime()},selected:{start:this._start.getTime(),end:this._end.getTime()},workHours:this._workHours,attendees:this._getCombinedAttendeeEmails(),calendarId:this._calendarId,accountId:this._accountId},this._id)};n.prototype._updateWorkerVisible=function(){var t=this._anchor,i=t.getFullYear(),r=t.getMonth(),u=t.getDate(),f=new Date(i,r,u+n._numberOfDays);this._worker.postCommand("FreeBusy/setVisible",{start:t.getTime(),end:f.getTime()},this._id)};n.prototype._updateWorkerSelected=function(){this._worker.postCommand("FreeBusy/setSelected",{start:this._start.getTime(),end:this._end.getTime()},this._id)};n.prototype._updateWorkerCalendar=function(){this._worker.postCommand("FreeBusy/setCalendar",{calendarId:this._calendarId,accountId:this._accountId},this._id)};n.prototype._onGetEvents=function(n){i("_onGetEvents");this._meSchedule.innerHTML=n.html;f.fadeIn(this._meSchedule).done();r("_onGetEvents")};n.prototype._onEventsChanged=function(n){i("_onEventsChanged");var t=this._meSchedule;this._meSchedule=t.cloneNode(false);this._meSchedule.style.opacity="0";this._meSchedule.innerHTML=n.html;t.parentElement.appendChild(this._meSchedule);setImmediate(function(){WinJS.UI.executeTransition(this._meSchedule,{property:"opacity",delay:0,duration:250,timing:"linear",to:1}).done();WinJS.UI.executeTransition(t,{property:"opacity",delay:200,duration:250,timing:"linear",to:0}).done(function(){t.parentNode&&(t.outerHTML="")})}.bind(this));r("_onEventsChanged")};n.prototype._onGetMeAria=function(t){i("_onGetMeAria");this._meAttendee.setAttribute("aria-label",n._me+": "+t.label);r("_onGetMeAria")};n.prototype._onGetSchedules=function(n){function h(n){n.parentNode&&(n.outerHTML="")}var u,t,o,s,e;i("_onGetSchedules");for(u in n.html)t=this._schedules.querySelector("[data-attendee='"+Jx.escapeHtml(u)+"']"),t&&(o=n.html[u],t.classList.remove("fetching"),t.insertAdjacentHTML("beforeend","<div class='container'>"+o+"<\/div>"),s=t.lastElementChild,e=t.firstElementChild,f.fadeIn(s).done(),f.fadeOut(e).done(h.bind(null,e)));this._updateProgress();r("_onGetSchedules")};n.prototype._onGetAttendeeAria=function(n){var u,t,f,e;i("_onGetAttendeeAria");for(u in n.labels)t=this._attendeesEl.querySelector("[data-attendee='"+Jx.escapeHtml(u)+"']"),t&&(f=n.labels[u],e=t.nodeName==="INPUT"?t.parentNode.querySelector(".name").innerText:t.innerText,t.setAttribute("aria-label",e+": "+f));r("_onGetAttendeeAria")}})