(function(){function t(n){Jx.mark("Calendar:FreeBusyWorker."+n+",StartTA,Calendar")}function i(n){Jx.mark("Calendar:FreeBusyWorker."+n+",StopTA,Calendar")}function o(n){return'<div class="event" data-status="'+n.status+'" title="'+n.tooltipHtml+'" style="color: '+n.color+"; "+n.dir+": "+(n.offset-1)+"px; width: "+n.width+'px;"><div class="glyph" style="background-color: '+n.color+';"><div class="glyphInner"><\/div><\/div><div class="subject">'+n.subjectHtml+"<\/div><\/div>"}function c(n){var t="unknown";return u.tentative<=n&&n<=u.outOfOffice&&(t=r.busyStatusClasses[n]),t}var r=Calendar.Helpers,u=Microsoft.WindowsLive.Platform.Calendar.BusyStatus,f=new Jx.DTFormatter("shortTime"),n=Calendar.Views.FreeBusyWorker=function(t,i,u,f){this._router=t;this._scheduler=i;this._accounts=u;this._manager=f;this._requests={};this._updateEvents=this._updateEvents.bind(this);this._router.route("FreeBusy/initialize",this.initialize,this);this._router.route("FreeBusy/refresh",this.refresh,this);this._router.route("FreeBusy/setVisible",this.setVisible,this);this._router.route("FreeBusy/setSelected",this.setSelected,this);this._router.route("FreeBusy/setWorkHours",this.setWorkHours,this);this._router.route("FreeBusy/setCalendar",this.setCalendar,this);this._router.route("FreeBusy/setAttendees",this.setAttendees,this);this._router.route("FreeBusy/pause",this.pause,this);this._router.route("FreeBusy/resume",this.resume,this);this._router.route("FreeBusy/cancel",this.cancel,this);r.ensureFormats();n._unknown=Jx.res.getString("FreeBusyUnknown");n._rangeFormatter=Jx.res.getFormatFunction("DateRange")};n.prototype.initialize=function(n){t("initialize");var u=n.id,r=n.data;r.id=u;r.visible.start=new Date(r.visible.start);r.visible.end=new Date(r.visible.end);r.selected.start=new Date(r.selected.start);r.selected.end=new Date(r.selected.end);r.results={};r.aria={};r.account=this._accounts.loadAccount(r.accountId);this._setHourBoundaries(r);this._adjustForDst(r);this._getEvents(r);this._getSchedules(r);this._requests[u]=r;i("initialize")};n.prototype.refresh=function(n){t("refresh");var u=n.id,r=this._requests[u];r&&(this._disposeEvents(r),this._getEvents(r),this._disposeSchedules(r),this._getSchedules(r));i("refresh")};n.prototype.setVisible=function(n){t("setVisible");var u=n.id,r=this._requests[u];r&&(r.visible.start=new Date(n.data.start),r.visible.end=new Date(n.data.end),this._disposeEvents(r),this._getEvents(r),this._disposeSchedules(r),this._adjustForDst(r),this._getSchedules(r));i("setVisible")};n.prototype.setSelected=function(n){t("setSelected");var u=n.id,r=this._requests[u];r&&(r.selected.start=new Date(n.data.start),r.selected.end=new Date(n.data.end),r.aria={},this._getMeAria(r),this._getAria(r));i("setSelected")};n.prototype.setWorkHours=function(n){var f,r,u;t("setWorkHours");f=n.id;r=this._requests[f];r&&(u=n.data.workHours,u!==r.workHours&&(r.workHours=u,this._setHourBoundaries(r),this._updateEvents(r),this._updateSchedules(r)));i("setWorkHours")};n.prototype.setCalendar=function(n){var e,r,u,f;t("setCalendar");e=n.id;r=this._requests[e];r&&(u=n.data.calendarId,f=n.data.accountId,u!==r.calendarId&&(r.calendarId=u,this._disposeEvents(r),this._getEvents(r)),f!==r.accountId&&(r.accountId=f,r.account=this._accounts.loadAccount(r.accountId),this._disposeSchedules(r),this._getSchedules(r)));i("setCalendar")};n.prototype.setAttendees=function(n){var c,r,f,u,l,o,a,e,v,s,h;if(t("setAttendees"),c=n.id,r=this._requests[c],r){for(f=r.attendees=n.data.attendees,u=r.request,u&&(l=u.attendees.some(function(n){return f.indexOf(n)!==-1}),l||(o=u.winrt,o.removeEventListener("changed",u.onChanged),o.dispose(),r.request=null)),a=r.results,r.results={},e=0,v=f.length;e<v;e++)s=f[e],h=a[s],h&&(r.results[s]=h);r.requestQueue=null;r.request||this._getSchedules(r)}i("setAttendees")};n.prototype.pause=function(n){t("pause");var u=n.id,r=this._requests[u];r&&(r.paused=true);i("pause")};n.prototype.resume=function(n){t("resume");var u=n.id,r=this._requests[u];r&&(r.paused=false,r.dirtyEvents?(this._getEvents(r),r.dirtyEvents=false,r.dirtyMeAria=false):r.dirtyMeAria&&(this._getMeAria(r),r.dirtyMeAria=false),r.dirtySchedules?(this._getSchedules(r),r.dirtySchedules=false,r.dirtyAria=false):r.dirtyAria&&(this._getAria(r),r.dirtyAria=false));i("resume")};n.prototype.cancel=function(n){t("cancel");var u=n.id,r=this._requests[u];r&&(this._disposeEvents(r),this._disposeSchedules(r),delete this._requests[n.id]);i("cancel")};n.prototype.dispose=function(){for(var n in this._requests)this.cancel({id:n});this._requests={};this._manager=null;this._accounts=null;this._scheduler=null;this._router=null};n._invalidResult="INVALID";n._hourWidth=160;n._halfWidth=n._hourWidth/2;n._numberOfDays=35;n._resultsPerDay=48;n._resultLength=n._numberOfDays*n._resultsPerDay;n._workStart=8;n._workEnd=19;n._workHours=n._workEnd-n._workStart;n._getNormalizedStatus=function(n,t){var i=parseInt(n.charAt(t),10);return(isNaN(i)||i<u.free||u.outOfOffice<i)&&(i=u.outOfOffice+1),i};n._formatScheduleBlock=function(t,i,e){var s=f.format(t),h=r.isSameDate(t,i)?f.format(i):r.dateAndTime.format(i),o=n._unknown;return u.free<=e&&e<=u.outOfOffice&&(o=r.accEventStatuses[e]),n._rangeFormatter(s,h)+", "+o+"; "};n.prototype._setHourBoundaries=function(t){t.workHours?(t.startBoundary=n._workStart,t.endBoundary=n._workEnd,t.hourOffset=n._workStart,t.hoursPerDay=n._workHours):(t.startBoundary=-1,t.endBoundary=25,t.hourOffset=0,t.hoursPerDay=24);t.startStatusBoundary=t.startBoundary*2;t.endStatusBoundary=t.endBoundary*2};n.prototype._getEvents=function(n){t("_getEvents");n.paused?n.dirtyEvents=true:(n.collection=this._manager.getEvents(n.visible.start,n.visible.end),n.jobIdEvents=this._scheduler.schedule(this._processEvents,this,[n]));i("_getEvents")};n._statusSorter=function(n,t){var i=n.status-t.status;return i||(i=n.start-t.start),i};n.prototype._processEvents=function(r){var v,w,c,y,p;t("_processEvents");var a=r.blocks=[],f={end:0,status:0},h=[],s;for(v=0,w=r.collection.count;v<w;v++)if(c=r.collection.item(v),c&&c.busyStatus!==u.free&&c.calendar.id===r.calendarId){var e=c.startDate,o=c.endDate,l=c.busyStatus;if(e<o&&(f.end<o||f.status<l)&&(e<r.visible.start&&(e=r.visible.start),r.visible.end<o&&(o=r.visible.end),y=e.getHours(),p=o.getHours(),y<r.startBoundary?(e.setHours(r.startBoundary),e.setMinutes(0)):r.endBoundary<=y&&(e.setHours(r.startBoundary+24),e.setMinutes(0)),p<r.startBoundary?(o.setHours(r.endBoundary-24),o.setMinutes(0)):r.endBoundary<=p&&(o.setHours(r.endBoundary),o.setMinutes(0)),e<o)){if(f.end<=e&&h.length){h.sort(n._statusSorter);do s=h.pop(),f.end<s.end&&(s.start=f.end,(s.start<e||l<=s.status)&&a.push(s),f=s);while(f.end<=e&&h.length)}f.end<=e?(f={ev:c,start:e,end:o,status:l},a.push(f)):f.status<l?(o<f.end&&h.push({ev:f.ev,start:f.start,end:f.end,status:f.status}),f.end=e,f={ev:c,start:e,end:o,status:l},a.push(f)):h.push({ev:c,start:e,end:o,status:l})}}if(h.length){h.sort(n._statusSorter);do s=h.pop(),f.end<s.end&&(s.start=f.end,a.push(s),f=s);while(h.length)}r.jobIdEvents=this._scheduler.schedule(this._buildEventHtml,this,[r]);i("_processEvents")};n.prototype._buildEventHtml=function(u){var e,w;t("_buildEventHtml");var v=u.visible.start,y=u.blocks,p="";for(e=0,w=y.length;e<w;e++){var s=y[e],c=s.start,l=s.end,h=s.ev,g=Math.floor((c-v)/r.dayInMilliseconds),nt=c.getHours()-u.hourOffset,b=g*u.hoursPerDay+nt+c.getMinutes()/60,tt=Math.floor((l-v)/r.dayInMilliseconds),it=l.getHours()-u.hourOffset,rt=tt*u.hoursPerDay+it+l.getMinutes()/60,ut=rt-b,k=Jx.escapeHtml(h.subject||r.noSubject),d=h.startDate,a=h.endDate,ft=r.isSameDate(d,a),et=r.dateAndTime.format(d),ot=ft?f.format(a):r.dateAndTime.format(a),st=Jx.escapeHtml(n._rangeFormatter(et,ot)),ht=k+" ("+st+")";p+=o({status:r.busyStatusClasses[s.status],color:r.processEventColor(h.color),dir:this._isRtl?"right":"left",subjectHtml:k,tooltipHtml:ht,offset:b*n._hourWidth,width:ut*n._hourWidth})}u.jobIdEvents=this._scheduler.schedule(this._sendEvents,this,[u,p]);i("_buildEventHtml")};n.prototype._sendEvents=function(n,r){t("_sendEvents");n.jobIdEvents=null;var u;n.onCollectionChanged?(u="FreeBusy/eventsChanged",n.collection.unlock(),this._getMeAria(n)):(u="FreeBusy/getEvents",n.jobIdEvents=this._scheduler.schedule(this._hookCollection,this,[n]));this._router.postMessage({command:u,id:n.id,html:r});i("_sendEvents")};n.prototype._disposeEvents=function(n){var t=n.onCollectionChanged;t&&(n.collection.removeEventListener("collectionchanged",t),n.onCollectionChanged=null,clearTimeout(n.changeTimeout));n.collection.dispose();n.collection=null;this._scheduler.cancel(n.jobIdEvents);n.jobIdEvents=null};n.prototype._hookCollection=function(n){t("_hookCollection");n.jobIdEvents=null;n.onCollectionChanged=this._onCollectionChanged.bind(this,n);n.collection.addEventListener("collectionchanged",n.onCollectionChanged);n.collection.unlock();this._getMeAria(n);i("_hookCollection")};n.prototype._getMeAria=function(n){t("_getMeAria");n.paused?n.dirtyMeAria=true:n.jobIdEvents||(n.jobIdEvents=this._scheduler.schedule(this._calculateMeAria,this,[n]));i("_getMeAria")};n.prototype._calculateMeAria=function(r){var c,h,e,f,s,l,o;if(t("_calculateMeAria"),r.jobIdEvents=null,c=r.blocks,h="",c.length){for(s=0,l=c.length;s<l;s++)if(o=c[s],r.selected.start<o.end)break;for(e=r.selected.start,f=e;s<l;s++){if(o=c[s],r.selected.end<=o.start)break;e<o.start&&(f=o.start,h=n._formatScheduleBlock(e,f,u.free),e=f);f=new Date(Math.min(r.selected.end,o.end));h+=n._formatScheduleBlock(e,f,o.ev.busyStatus);e=f}f<r.selected.end&&(e=f,f=r.selected.end,h+=n._formatScheduleBlock(e,f,u.free))}else e=r.selected.start,f=r.selected.end,h+=n._formatScheduleBlock(e,f,u.free);this._router.postMessage({command:"FreeBusy/meAria",id:r.id,label:h});i("_calculateMeAria")};n.prototype._onCollectionChanged=function(n){t("_onCollectionChanged");n.changeTimeout||(this._scheduler.cancel(n.jobIdEvents),n.changeTimeout=setTimeout(this._updateEvents,1e3,n));i("_onCollectionChanged")};n.prototype._updateEvents=function(n){this._requests[n.id]&&(t("_updateEvents"),this._scheduler.cancel(n.jobIdEvents),clearTimeout(n.changeTimeout),n.changeTimeout=null,n.collection.lock(),this._processEvents(n),i("_updateEvents"))};n._attendeeChunkSize=5;n.prototype._adjustForDst=function(n){var o=n.visible,s=o.start,f=o.end,u=s.getTimezoneOffset(),h=f.getTimezoneOffset(),t,i,e,r;if(u!==h){for(t=new Date(s),i=0;t<f&&t.getTimezoneOffset()===u;)t.setDate(t.getDate()+1),i+=48;for(t.setDate(t.getDate()-1),i-=48;t<f&&t.getTimezoneOffset()===u;)t.setMinutes(t.getMinutes()+30),i+=1;e=h-u;r=Math.abs(Math.floor(e/30));n.adjustSchedule=e<0?function(n){for(var f=n[i-1],u="",t=0;t<r;t++)u+=f;return n.substring(0,i)+u+n.substring(i)}:function(n){for(var e=i-r,o="",f,u,t=0;t<r;t++)f=parseInt(n.charAt(e+t),10),u=parseInt(n.charAt(e+t+r),10),o+=isNaN(f)?isNaN(u)?"X":u:isNaN(u)?f:Math.max(f,u);return n.substring(0,e)+o+n.substring(i+r)}}else n.adjustSchedule=function(n){return n}};n.prototype._getSchedules=function(r){if(t("_getSchedules"),r.paused)r.dirtySchedules=true;else if(r.requestQueue||(r.requestQueue=r.attendees.filter(function(n){return!r.results[n]})),r.requestQueue.length){var f=r.requestQueue.splice(0,n._attendeeChunkSize),u=r.request={attendees:f,winrt:this._manager.requestFreeBusyData(r.account,r.visible.start,r.visible.end,f)};u.onChanged=this._onRequestChanged.bind(this,r,u);u.winrt.addEventListener("changed",u.onChanged)}i("_getSchedules")};var e=Microsoft.WindowsLive.Platform,s=e.Calendar.FreeBusyStatus,h=e.SearchStatusCode;n.prototype._getAttendeeHtml=function(t,i,r){for(var e="",v=this._isRtl?"right":"left",h=0,o=0,u=0,f=0;f<n._resultLength;f++){var l=f%n._resultsPerDay,a=i<=l&&l<r,s=n._getNormalizedStatus(t,f);s!==u&&(u&&(e+=o-1+"px;'><\/div>"),s&&a?(e+="<div class='status "+c(s)+"' style='"+v+": "+h+"px; width: ",o=0):u=0);a&&(u=s,h+=n._halfWidth,o+=n._halfWidth)}return u&&(e+=o-1+"px;'><\/div>"),e};n.prototype._onRequestChanged=function(r,u){var o,a,d,v,b;if(t("_onRequestChanged"),o=u.winrt,o.status){var y=u.attendees,c=r.results,k=r.aria,p={},e,l,f;if(o.status===h.success){var w=o.results,g=r.startStatusBoundary,nt=r.endStatusBoundary;for(e=0,l=w.count;e<l;e++)a=w.item(e),f=a.attendee,r.attendees.indexOf(f)!==-1&&y.indexOf(f)!==-1&&(d=a.status,v=r.adjustSchedule(a.freebusy),d===s.success&&v?(c[f]=v,b=this._getAttendeeHtml(v,g,nt)):(c[f]=n._invalidResult,b="<div class='status unknown' style='width: 100%; height: 100%;'><\/div>"),p[f]=b,k[f]=null);w.dispose()}for(e=0,l=y.length;e<l;e++)f=y[e],c[f]||r.attendees.indexOf(f)===-1||(c[f]=n._invalidResult,p[f]="<div class='status unknown' style='width: 100%; height: 100%;'><\/div>",k[f]=null);this._router.postMessage({command:"FreeBusy/schedules",id:r.id,html:p});o.removeEventListener("changed",u.onChanged);o.dispose();r.request=null;this._getSchedules(r);this._getAria(r)}i("_onRequestChanged")};n.prototype._getAria=function(n){t("_getAria");n.paused?n.dirtyAria=true:n.jobIdAria||(n.jobIdAria=this._scheduler.schedule(this._calculateAria,this,[n]));i("_getAria")};n.prototype._calculateAria=function(u){var s,e,c,l,f,h,a,o;t("_calculateAria");u.jobIdAria=null;var v=u.results,y=u.aria,p={},w=false,b=Math.floor((u.selected.start-u.visible.start)/r.hourInMilliseconds*2),k=Math.ceil((u.selected.end-u.visible.start)/r.hourInMilliseconds*2);for(s in v)if(e=y[s]||"",!e){if(c=v[s],c===n._invalidResult)u.fullUnknown||(u.fullUnknown=n._formatScheduleBlock(u.selected.start,u.selected.end,-1)),e=u.fullUnknown;else{for(l=new Date(u.selected.start),h=n._getNormalizedStatus(c,b),o=b+1;o<k;o++)a=n._getNormalizedStatus(c,o),a!==h&&(f=new Date(u.visible.start),f.setMinutes(o*30),e+=n._formatScheduleBlock(l,f,h),l=f,h=a);f=new Date(u.visible.start);f.setMinutes(o*30);e+=n._formatScheduleBlock(l,f,h)}y[s]=p[s]=e;w=true}w&&this._router.postMessage({command:"FreeBusy/attendeeAria",id:u.id,labels:p});i("_calculateAria")};n.prototype._updateSchedules=function(n){var r,s,u,f;t("_updateSchedules");var e=n.attendees,h=n.results,o={},c=n.startStatusBoundary,l=n.endStatusBoundary;for(r=0,s=e.length;r<s;r++)u=e[r],f=h[u],f&&(o[u]=this._getAttendeeHtml(f,c,l));this._router.postMessage({command:"FreeBusy/schedules",id:n.id,html:o});i("_updateSchedules")};n.prototype._disposeSchedules=function(n){var r,u;t("_disposeSchedules");r=n.request;r&&(u=r.winrt,u.removeEventListener("changed",r.onChanged),u.dispose(),n.request=null);n.results={};n.aria={};n.requestQueue=null;this._scheduler.cancel(n.jobIdAria);n.jobIdAria=null;i("_disposeSchedules")}})()