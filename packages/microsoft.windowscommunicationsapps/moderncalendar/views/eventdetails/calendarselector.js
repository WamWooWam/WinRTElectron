Jx.delayDefine(Calendar.Views,"CalendarSelector",function(){function t(n){Jx.mark("Calendar.CS."+n+",StartTA,Calendar")}function i(n){Jx.mark("Calendar.CS."+n+",StopTA,Calendar")}function u(n){for(var t=n.target;$(t).hasClass("ctcsel");)t=t.parentNode;return $(t).hasClass("entry")?$(t):false}var r,n;t("calendarSelector.js");r=Calendar.Views.CalendarSelector=function(n){t("ctor");this.initComponent();this._onCalendarSelectClick=this._onCalendarSelectClick.bind(this);this._onActiveState=this._onActiveState.bind(this);this._offActiveState=this._offActiveState.bind(this);this._onHoverState=this._onHoverState.bind(this);this._offHoverState=this._offHoverState.bind(this);this._onKeyDown=this._onKeyDown.bind(this);this._onShowDropdown=this._onShowDropdown.bind(this);this._onExpandChange=this._onExpandChange.bind(this);this._onClickEater=this._onClickEater.bind(this);this.onDismiss=this.onDismiss.bind(this);this.updateSelectionByIndex=this.updateSelectionByIndex.bind(this);this._eventDetailsLinkHandler=this._eventDetailsLinkHandler.bind(this);this._control=null;this._selection=null;this._dropDown=null;this._dropDownContainer=null;this._clickEater=null;this._id="CalendarCombo";this._externalButton=n;this._selectionID=this._id+"Selection";this._calendars=[];this._isDirty=true;this._selectedCalendar=0;this._eventsEnabled=false;this._dropDownDown=false;this._eventDetailsLink=false;this._eventDetailsLinkFocused=false;this._disableInitialFocus=false;i("ctor")};Jx.augment(r,Jx.Component);r.createCalendarOption=function(n,r){var o;t("_createCalendarOption");var u=n.name,f=n.account.emailAddress,e="";return e=r?u===""?Jx.res.getString("HiddenCalendar"):Jx.res.loadCompoundString("HiddenCalendarWithEmail",f):u===""?"":f,o={name:u!==""?u:f,email:e,color:Calendar.Helpers.processEventColor(n.color),colorRaw:n.color,calendar:n},i("_createCalendarOption"),o};r.getCalendarsForSelector=function(n){var h,b,y,k;t("getCalendarsForSelector");var c=n.calendarManager,d=c.getAllCalendars().count,l=[];if(d<=1)l.push(r.createCalendarOption(c.defaultCalendar,false));else{for(var p=Microsoft.WindowsLive.Platform,e=n.accountManager.getConnectedAccountsByScenario(Calendar.scenario,p.ConnectedFilter.normal,p.AccountSort.rank),w=0,o=[],u,f=0,s=e.count;f<s;f++){var g=e.item(f),a=c.getAllCalendarsForAccount(g),v=[];for(h=0,b=a.count;h<b;h++)u=a.item(h),u.readOnly||(u.isDefault?v.unshift(u):v.push(u),u.hidden||w++);a.dispose();o=o.concat(v)}for(e.dispose(),e=null,y=w===0,k=r.createCalendarOption,f=0,s=o.length;f<s;f++)u=o[f],(y||!u.hidden)&&l.push(k(u,y))}return i("getCalendarsForSelector"),l};n=r.prototype;n.getUI=function(n){n.html=this._containerTemplate()};n.activateUI=function(){var r,u,n;t("activateUI");this._control=$.id(this._id);this._control||(r=$.id("calendar"),r.insertAdjacentHTML("beforeend",Jx.getUI(this).html),this._control=r.lastElementChild);this._clickEater||(u=document.body,u.insertAdjacentHTML("beforeend",'<div class="calendarSelector-clickEater"><\/div>'),this._clickEater=u.lastElementChild);n=this._control;this._dropDown=n.querySelector(".dropDown");this._dropDownContainer=n.querySelector(".dropDownContainer");$("#eventDetailsLink").on("click",this._eventDetailsLinkHandler);this._selection=(this._externalButton?$(this._externalButton):$(".selection",n))[0];$(this._clickEater).on("MSPointerDown",this._stopPropagation).on("wheel",this._stopPropagation).on("click",this._onClickEater);$(this._dropDownContainer).on("click",this._stopPropagation);this._hideDropdown();i("activateUI")};n.deactivateUI=function(){t("deactivateUI");this.toggleEventBindings(false);$(this._control).remove();this._control=null;$(this._clickEater).off("MSPointerDown",this._stopPropagation).off("wheel",this._stopPropagation).off("click",this._onClickEater).remove();this._clickEater=null;$(this._dropDownContainer).off("click",this._stopPropagation);this._dropDownContainer=null;this._dropDown=null;$("#eventDetailsLink").off("click",this._eventDetailsLinkHandler);i("deactivateUI")};n.toggleEventBindings=function(n){if(t("toggleEventBindings"),!this._eventsEnabled&&n){$(this._selection).on("click",this._onShowDropdown).on("keydown",this._onShowDropdown);$(this._dropDown).on("click",this._onCalendarSelectClick).on("mouseover",this._onHoverState).on("mouseout",this._offHoverState).on("mousedown",this._onActiveState).on("mouseup",this._offActiveState).on("MSPointerDown",this._stopPropagation).on("MSPointerCancel",this._stopPropagation).on("DOMAttrModified",this._onExpandChange);this._control.addEventListener("keydown",this._onKeyDown,true)}else this._eventsEnabled&&!n&&($(this._selection).off("click",this._onShowDropdown).off("keydown",this._onShowDropdown),$(this._dropDown).off("click",this._onCalendarSelectClick).off("mouseover",this._onHoverState).off("mouseout",this._offHoverState).off("mousedown",this._onActiveState).off("mouseup",this._offActiveState).off("MSPointerDown",this._stopPropagation).off("MSPointerCancel",this._stopPropagation).off("DOMAttrModified",this._onExpandChange),this._control.removeEventListener("keydown",this._onKeyDown,true));this._eventsEnabled=n;i("toggleEventBindings")};n.enableEventDetailsLink=function(n){this._eventDetailsLink=n};n._eventDetailsLinkHandler=function(n){n.stopPropagation();n.preventDefault();this.fire("createEvent")};n.setCalendars=function(n){t("setCalendars");this._calendars=n;this._isDirty=true;this.toggleEventBindings(n.length>1||this._externalButton);i("setCalendars")};n.updateSelectionByIndex=function(n){(t("updateSelectionByIndex"),n>this._calendars.length-1)||(this._selectedCalendar=n,this.updateSelectionUI(this._calendars[n]),$(this._selection).attr("aria-haspopup","true"),Jx.EventManager.fire(this,"calendarSelected",{index:n}),i("updateSelectionByIndex"))};n.updateSelectionById=function(n){var f,r,u,o,e;for(t("updateSelectionById"),f=-1,r=-1,u=0,o=this._calendars.length;u<o&&r===-1;u++)e=this._calendars[u].calendar,e.id===n?r=u:e.isDefault&&(Jx.isNumber(n)?f=u:r=u);r===-1&&(r=f===-1?0:f);this.updateSelectionByIndex(r);i("updateSelectionById")};n.updateSelectionUI=function(n){if(!this._externalButton){t("updateSelectionUI");$(this._selection).html(this._selectionTemplate(n,this._calendars.length>1,this._selectionID));var r=n.name+" "+n.email;$(this._selection).attr("aria-label",r);i("updateSelectionUI")}};n.hasDropdown=function(){return this._calendars.length>1};n.isOpen=function(){return this._dropDownDown};n.getSelectedCalendarIndex=function(){return this._selectedCalendar};n._showDropdown=function(n){this._dropDownDown||(t("_showDropdown"),this._dropDownDown=true,$(this._selection).off("mouseover",this._onHoverState).off("mouseout",this._offHoverState).off("mousedown",this._onActiveState).off("mouseup",this._offActiveState),this._isDirty&&($(this._dropDown).html(this._entryListTemplate(this._calendars)),this._isDirty=false),this._dropDownContainer.style.display="block",$(this._dropDown).attr("aria-hidden",false).attr("aria-selected",true).attr("aria-expanded",true).attr("aria-owns","calendarMenu"),this._keySelect=this._selectedCalendar,this.fire("showDropdown",{container:this._dropDownContainer,ev:n}),this._clickEater.style.display="block",this._eventDetailsLinkFocused=false,this._disableInitialFocus||this.setFocus(),i("_showDropdown"))};r.prototype.disableInitialFocus=function(){this._disableInitialFocus=true};r.prototype.setFocus=function(){var n,r;t("setFocus");n=$(".entry",this._dropDown);n.each(function(n){$(this).attr("tabindex",n+1)});this._setActiveEntryStyle(n,this._selectedCalendar);r=n[this._selectedCalendar];r.focus();i("setFocus")};n._hideDropdown=function(){if(this._dropDownDown){t("_hideDropdown");this._clickEater.style.display="";this._dropDownContainer.style.display="none";$(this._dropDown).attr("aria-hidden",true);$(this._selection).on("mouseover",this._onHoverState).on("mouseout",this._offHoverState).on("mousedown",this._onActiveState).on("mouseup",this._offActiveState);this._dropDownDown=false;this._externalButton||Jx.safeSetActive($("#CalendarCombo .selection")[0]);Jx.EventManager.fire(this,"CalendarSelectorHidden");i("_hideDropdown")}};n._onCalendarSelectClick=function(n){var r,f,e;t("_onCalendarSelectClick");n.stopPropagation();n.preventDefault();r=u(n);r&&(f=$(".entry",this._dropDown),e=Array.prototype.indexOf.call(f,r[0]),this._removeActiveEntryStyle(f,this._keySelect),this.updateSelectionByIndex(e),this._hideDropdown());i("_onCalendarSelectClick")};n._onClickEater=function(n){n.stopPropagation();this._hideDropdown()};n._stopPropagation=function(n){n.stopPropagation();n.preventDefault()};n._onActiveState=function(n){var t=u(n);t&&t.addClass("active")};n._offActiveState=function(n){var t=u(n);t&&t.removeClass("active")};n._onHoverState=function(n){var t=u(n);t&&($(".entry",this._dropDown).removeClass("hover"),t.addClass("hover"));n.stopPropagation();n.preventDefault()};n._offHoverState=function(n){var t=u(n);t&&t.removeClass("hover").removeClass("active")};n._onShowDropdown=function(n){t("onShowDropdown");var r=n.keyCode,u=Jx.KeyCode;r?n.altKey||n.ctrlKey||r!==u.enter&&r!==u.space||(this._showDropdown(n),n.stopPropagation(),n.preventDefault()):(n.stopPropagation(),this._dropDownDown?this._hideDropdown():this._showDropdown(n));i("onShowDropdown")};n._setActiveEntryStyle=function(n,t){var i=n.get(t);$(i).css("background-color",this._calendars[this._selectedCalendar].color);$(".name, .email",i).css("color","white");$(".color",i).css("background-color","white")};n._removeActiveEntryStyle=function(n,t){var i=n.get(t);$(i).each(function(){this.style["background-color"]=""});$(".name, .email",i).each(function(){this.style.color=""});$(".color",i).css("background-color",this._calendars[t].color)};n._onKeyDown=function(n){var i=n.keyCode,r=Jx.KeyCode,e;if(this._dropDownDown){var f=this._calendars.length,t=this._keySelect,u=$(".entry",this._dropDown);n.stopPropagation();n.preventDefault();this._eventDetailsLink&&i===r.tab&&(this._eventDetailsLinkFocused=!this._eventDetailsLinkFocused,this._eventDetailsLinkFocused?$.id("eventDetailsLink").focus():u[t].focus());this._eventDetailsLinkFocused?(i===r.enter||i===r.space)&&this._eventDetailsLinkHandler(n):(i===r.uparrow?t=(t+f-1)%f:i===r.downarrow?t=(t+1)%f:i===r.home?t=0:i===r.end?t=f-1:i===r.enter||i===r.space?(this.updateSelectionByIndex(this._keySelect),this._hideDropdown()):i===r.escape&&(this._removeActiveEntryStyle(u,this._keySelect),this._hideDropdown()),t!==this._keySelect&&(this._removeActiveEntryStyle(u,this._keySelect),this._setActiveEntryStyle(u,t),e=u[t],e.focus(),this._keySelect=t))}};n.activeCalendarItem=function(){return this._calendars[this._keySelect]};n.onDismiss=function(){t("onDismiss");this._hideDropdown();i("onDismiss")};n._onExpandChange=function(n){t("_onExpandChange");n.attrName==="aria-expanded"&&(n.newValue==="true"?this._showDropdown(n):this._hideDropdown());i("_onExpandChange")};n._entryListTemplate=function(n){for(var r="",t,i=0,u=n.length;i<u;i++)t=n[i],r+='<div class="entry" id="calendarSelectEntry'+i+'" role="menuitem" aria-label="'+Jx.escapeHtml(t.name+" "+t.email)+'"><div class="color ctcsel" style="background:'+t.color+'" aria-hidden="true"><\/div><div class="name ctcsel" aria-hidden="true"><span class="ctcsel">'+Jx.escapeHtml(t.name)+'<\/span><\/div><div class="email ctcsel" aria-hidden="true">'+Jx.escapeHtml(t.email)+"<\/div><\/div>";return r};n._selectionTemplate=function(n,t,i){var r=t?'<div class="ctcsel">'+Jx.escapeHtml(n.name)+'<\/div><div class="caret ctcsel">&#xE099;<\/div>':Jx.escapeHtml(n.name);return'<div class="entry currentEntry" id="'+i+'"><div class="color ctcsel" style="background:'+n.color+'" aria-hidden="true"><\/div><div class="name ctcsel">'+r+'<\/div><div class="email ctcsel">'+Jx.escapeHtml(n.email)+"<\/div><\/div>"};n._containerTemplate=function(){var n=this._externalButton?"":'<div class="selection" tabindex="0" aria-label="'+Jx.res.getString("EventCalendarLabel")+'" role="button"><\/div>',t=this._eventDetailsLink?'<div class="eventDetailsLink"><div class="hr"><\/div><div class="link" id="eventDetailsLink" tabindex="0" role="button">'+Jx.escapeHtml(Jx.res.getString("AddMoreDetailLink"))+"<\/div><\/div>":"";return'<div id="'+this._id+'" class="calendarSelector">'+n+'<div class="dropDownContainer"><div class="dropDown" id="calendarMenu" aria-hidden="true" role="menu" aria-label="menu"><\/div>'+t+"<\/div><\/div>"}})