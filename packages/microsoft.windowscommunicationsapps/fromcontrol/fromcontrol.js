Jx.delayDefine(window,"FromControl",function(){var t,n,i;$include("/FromControl/MailFromControl.css");window.FromControl={};FromControl.CustomLayout=function(){};Jx.inherit(FromControl.CustomLayout,People.IdentityElements.BaseElement);t=FromControl.CustomLayout.prototype;t.getUI=function(n,t,i){return People.IdentityElements.makeElementWithAttributes("div",t,"fromControl-customLayout",i,"",n.getUI(People.IdentityElements.Tile,{className:"fromControl-tileElement",size:"40",statusIndicator:null})+'<div class="fromControl-label">'+Jx.res.getString("fromControlDescription")+'<\/div><div class="fromControl-textArea">'+n.getUI(People.IdentityElements.Name,{attributes:'id="fromControlNameElement"',className:"fromControl-nameElement"})+'<div class="fromControl-emailElement"><\/div><div class="fromControl-dropArrow">&#xE099;<\/div><\/div>')};t.activateUI=function(n,t){this._element=t};t.shutdownUI=function(){this._element=null};FromControl.FromControl=function(n,t){this._accountManager=n;this._peopleManager=t;this._identityControl=null;this._emailDiv=null;this._disabled=false;this._forceRefresh=false;this._onClick=this._onClick.bind(this);this._markActive=this._markActive.bind(this);this._markInactive=this._markInactive.bind(this);this.refresh();this.initComponent()};Jx.augment(FromControl.FromControl,Jx.Component);n=FromControl.FromControl.prototype;n.activateUI=function(){Jx.Component.prototype.activateUI.call(this);this._identityControl.activateUI();this._element=document.body.querySelector(".fromControl-wrapper");this._element.setAttribute("data-multipleaccount",this._multipleAccounts.toString());this._selectableElement=this._element.querySelector(".fromControl-customLayout");this._selectableElement.setAttribute("aria-disabled",(!this._multipleAccounts).toString());this._selectableElement.setAttribute("role","button");this._selectableElement.addEventListener("MSPointerDown",this._markActive);this._selectableElement.addEventListener("MSPointerUp",this._markInactive);this._multipleAccounts&&!this._disabled?Jx.addClass(this._selectableElement,"interactive"):Jx.removeClass(this._selectableElement,"interactive");this._emailDiv=this._element.querySelector(".fromControl-emailElement");this._selectedEmail&&(this._emailDiv.innerHTML=Jx.escapeHtml(this._selectedEmail))};n.click=function(){this._element.focus();this._onClick()};n._markActive=function(){this._selectableElement.classList.add("active")};n._markInactive=function(){this._selectableElement.classList.remove("active")};n.deactivateUI=function(){Jx.Component.prototype.deactivateUI.call(this);this._identityControl.shutdownUI();this._selectableElement.removeEventListener("MSPointerDown",this._markActive);this._selectableElement.removeEventListener("MSPointerUp",this._markInactive);this._selectableElement=null;this._element=null};Object.defineProperty(n,"selectedAccount",{get:function(){return this._selectedAccount},enumerable:true});Object.defineProperty(n,"selectedEmailAddress",{get:function(){return this._selectedEmail},enumerable:true});n.getUI=function(n){n.html=this._identityControl.getUI(FromControl.WrapperLayout,{attributes:'id="fromControl"'})};n.onAccountChanged=null;n.multipleAccounts=function(){return this._multipleAccounts};n.refresh=function(){var e,o,t,n,i,a,s,w,h,v,r,f,c,u,y,p,l;for(e=Microsoft.WindowsLive.Platform,o=this._accountManager.getConnectedAccountsByScenario(e.ApplicationScenario.mail,e.ConnectedFilter.normal,e.AccountSort.rank),t={},i=o.count;i--;)for(n=o.item(i),a=n.sendAsAddresses,s=0,w=a.size;s<w;s++)h=a[s],t[h]||(t[h]=[]),t[h].push(n);for(v=Object.keys(t),f=[],i=v.length;i--;)if(u=v[i],r=t[u],r.length===1)f.push({account:r[0],emailAddress:u,displayEmailAddress:u});else for(c=r.length;c--;)f.push({account:r[c],emailAddress:u,displayEmailAddress:u+"("+r[c].displayName+")"});return(f.sort(function(n,t){return n.displayEmailAddress.localeCompare(t.displayEmailAddress)}),this._accountList=f,y=this._accountList.length>1,y!==this._multipleAccounts||this._forceRefresh)?(this._multipleAccounts=y,n=o.item(0),p=this._getValidEmailAddress(n,n.preferredSendAsAddress),l=n.meContact,l||(l=this._peopleManager.loadRecipientByEmail(p,n.displayName)),this._selectedAccount=n,this._selectedEmail=p,this._fireAccountChanged(),Jx.isNullOrUndefined(this._identityControl)||this._identityControl.shutdownUI(),this._identityControl=new People.IdentityControl(l,null,{interactive:this._multipleAccounts&&!this._disabled,getTooltip:this._getTooltip,onClick:this._onClick,pressEffect:false}),this._forceRefresh=false,true):false};n.select=function(n,t){var i,r;if(this._multipleAccounts&&(this._selectedAccount.objectId!==n||this._selectedEmail!==t))for(i=this._accountList,r=i.length;r--;)if(i[r].account.objectId===n){this.selectAccount(i[r].account,t);break}};n.selectAccount=function(n,t){var r=this._getValidEmailAddress(n,t),i=n.meContact;i||(i=this._peopleManager.loadRecipientByEmail(r,n.displayName));this._identityControl.updateDataSource(i);this._selectedAccount=n;this._selectedEmail=r;this._emailDiv&&(this._emailDiv.innerHTML=Jx.escapeHtml(this._selectedEmail));this._fireAccountChanged()};Object.defineProperty(n,"disabled",{get:function(){return this._disabled},set:function(n){this._disabled!==n&&(this._disabled=n,this._forceRefresh=true)},enumerable:true});n._getValidEmailAddress=function(n,t){var i=n.sendAsAddresses;return Array.prototype.indexOf.call(i,t)!==-1?t:n.emailAddress};n._fireAccountChanged=function(){if(typeof this.onAccountChanged=="function")try{this.onAccountChanged(this._selectedAccount)}catch(n){Jx.log.error("FromControl unexpected exception on account changed handler: "+String(n))}};n._getTooltip=function(){return Jx.res.getString("fromControlTooltip")};n._onClick=function(){var n,i,o,r,s;if(this._multipleAccounts&&!this._disabled){n=document.createElement("div");n.id="fromControlDropDown_"+n.uniqueID;n.className="fromControl-dropDown";document.body.appendChild(n);var f=[],u,e=this._accountList,t=this;for(i=0,o=e.length;i<o;i++)u=e[i],f.push({id:"fromControlOption"+i.toString(),label:u.displayEmailAddress,onclick:function(n){return function(){r.hide();WinJS.UI.Animation.fadeOut(t._element).then(null,function(n){Jx.log.error("Error while trying to fade out the From Control:"+n)}).then(function(){return t.selectAccount(n.account,n.emailAddress),WinJS.UI.Animation.fadeIn(t._element)}).done(null,function(n){Jx.log.error("Error while trying to fade in the From Control:"+n)})}}(u)});r=new WinJS.UI.Menu(n,{commands:f});r.element.setAttribute("aria-label",Jx.res.getString("fromControlTooltip"));this._selectableElement.setAttribute("aria-selected","true");this._selectableElement.setAttribute("aria-expanded","true");this._selectableElement.setAttribute("aria-owns",n.id);r.addEventListener("afterhide",function(){n.parentNode&&(document.body.removeChild(n),t._selectableElement.setAttribute("aria-selected","false"),t._selectableElement.setAttribute("aria-expanded","false"),t._selectableElement.setAttribute("aria-owns",""))});s=Jx.isRtl()?"right":"left";r.show(this._selectableElement,"bottom",s)}return false};n._accountManager=null;n._multipleAccounts=null;n._peopleManager=null;n._selectedAccount=null;n._selectedEmail=null;FromControl.WrapperLayout=function(){};Jx.inherit(FromControl.WrapperLayout,People.IdentityElements.BaseElement);i=FromControl.WrapperLayout.prototype;i.getUI=function(n,t,i){return People.IdentityElements.makeElementWithAttributes("span",t,"fromControl-wrapper",i,"",n.getUI(FromControl.CustomLayout,{}))};FromControl.buildFromString=function(n,t){var r,i;return r=t.emailAddress,r===n?(i=t.userDisplayName,Jx.isNonEmptyString(i)&&i!==n?i+" <"+n+">":n):n}})