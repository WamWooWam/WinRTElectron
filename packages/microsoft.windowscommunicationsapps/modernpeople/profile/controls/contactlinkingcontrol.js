Jx.delayDefine(People,"ContactLinkingControl",function(){function e(n,t){return function(){try{return t.apply(this,arguments)}finally{}}}function h(n){var e,v,y,p,nt,u,w,h,ut,o,b,k,d,g;$include("$(cssResources)/controls-people.css");e=this._host;v=this._person=n.data;y=this._element=n.element;this._platform=e.getPlatform();p=e.getFrameCommands();p.addCommand(new r.Command("cmdid_profile_save",null,"/strings/profileFrameButtonSave_tooltip","",true,true,this,this._onSave));p.addCommand(new r.Command("cmdid_profile_cancel",null,"/strings/profileFrameButtonCancel_tooltip","",true,true,this,this._onCancel));nt=new WinJS.Binding.List;u=this._groupedItems=nt.createGrouped(c,l);try{w=JSON.parse(n.context)}catch(tt){Jx.log.exception("Error parsing hydration data: "+n.context,tt)}var ft=r.Hydration.get(w,"contactIdsToUnlink",[]),et=r.Hydration.get(w,"personIdsToLink",[]),it=[],rt=v.linkedContacts;for(h=0,ut=rt.count;h<ut;h++)try{o=rt.item(h);o.isGal||(ft.indexOf(o.objectId)!==-1?it.push(o):u.push({type:i.existingContact,group:t.links,contact:o}))}catch(tt){Jx.log.exception("Error adding linked contact",tt)}et.forEach(function(n){var r=this._platform.peopleManager.tryLoadPerson(n);r&&u.push({type:i.newPerson,group:t.links,person:r})},this);it.forEach(function(n){u.push({type:i.existingContact,group:t.suggestions,contact:n})});u.push({type:i.progress,group:t.suggestions});u.push({type:i.pickerLink,group:t.suggestions});this._jobSet=e.getJobSet().createChild();b=this._suggestions=f.getSuggestions(v);b.isReady()?(this._suggestionReadyInLoad=true,this._addSuggestions()):b.addListener("ready",this._addSuggestions,this);k={statusIndicator:null,secondaryContent:r.IdentityElements.Networks};d={interactive:false,createJobSet:true};this._linkedFactory=new r.IdentityControlNodeFactory(r.IdentityElements.BillboardLayout,Jx.mix({className:"profileLink-linked"},k),Jx.mix({getLabel:function(n,t){return t+"\n"+Jx.res.getString("/strings/linking_ariaLabelLinked")}},d));this._unlinkedFactory=new r.IdentityControlNodeFactory(r.IdentityElements.BillboardLayout,Jx.mix({className:"profileLink-unlinked"},k),Jx.mix({getLabel:function(n,t){return t+"\n"+Jx.res.getString("/strings/linking_ariaLabelUnlinked")}},d));this._identityControls={};g=this._layout=e.getLayout();this._layoutChangedHandler=this._updateLayout;g.addLayoutChangedEventListener(this._updateLayout,this);y.innerHTML="<div id='linkingListView'><\/div>";new WinJS.UI.ListView(y.firstChild,{layout:{type:g.getLayoutState()===r.Layout.layoutState.snapped?WinJS.UI.ListLayout:WinJS.UI.GridLayout,groupHeaderPosition:WinJS.UI.HeaderPosition.top},selectionMode:WinJS.UI.SelectionMode.none,swipeBehavior:WinJS.UI.SwipeBehavior.none,itemDataSource:u.dataSource,groupDataSource:u.groups.dataSource,itemTemplate:s(this._renderItem,this),resetItem:this._disposeElement.bind(this),groupHeaderTemplate:s(a),oniteminvoked:this._itemInvoked.bind(this)});this._suggestionReadyInLoad&&this._markPtStopLoad()}function c(n){return n.group}function l(n){return{title:n.group===t.links?Jx.res.getString("/strings/linking_linkedProfiles"):Jx.res.getString("/strings/linking_suggestions")}}function o(n){var i,t;if(n.objectType==="Person"){for(i=n.linkedContacts,t=0;t<i.count;t++)if(o(i.item(t)))return true;return false}return n.linkType===Microsoft.WindowsLive.Platform.ContactLinkingType.windowsLive}function s(n,t){return function(i){return i.then(function(i){return n.call(t,i.data)})}}function a(n){var t=document.createElement("div");return t.innerText=n.title,t}function v(){return JSON.stringify({personIdsToLink:this._getPersonIdsToLink(),contactIdsToUnlink:this._getContactIdsToUnlink()})}function y(){if(!this._completeListener){var n=this._person,t=this._getPersonIdsToLink(),i=this._getContactIdsToUnlink();if(t.length===0&&i.length===0)Jx.log.info("No linking requested"),this._host.back();else{Jx.log.info("Managing links for person: "+n.objectId);Jx.log.info("Adding links: "+t.join(", "));Jx.log.info("Removing links: "+i.join(", "));n.addEventListener("changed",this._completeListener=this._onChange.bind(this));this._timeout=setTimeout(this._onTimeout.bind(this),1e3);try{n.manageLinks(t,i)}catch(r){Jx.log.exception("Linking failed",r);this._host.back()}}}}function u(n){this._id=n.objectId;this._isReady=false;this._collection=n.suggestedPeople;this._listener=this._onChange.bind(this);this._collection.addEventListener("collectionchanged",this._listener);this._collection.unlock()}var r=window.People,p=r.Controls,w=r.Nav,i={existingContact:1,newPerson:2,progress:3,pickerLink:4},t,f,n;Object.freeze(i);t={links:1,suggestions:2};Object.freeze(t);f=r.ContactLinkingControl=function(n){Jx.ptStart("People-Linking","Windows-Live-People-Linking");this._host=n;this._suggestionReadyInLoad=false;this._suggestionCount=0;this._ptStopLogged=false};n=f.prototype;n._completeListener=null;n._timeout=null;n._suggestions=null;n.load=e("load",h);n._updateLayout=function(){this._element.firstChild.winControl.layout={type:this._layout.getLayoutState()===r.Layout.layoutState.snapped?WinJS.UI.ListLayout:WinJS.UI.GridLayout,groupHeaderPosition:WinJS.UI.HeaderPosition.top}};n._markPtStopLoad=function(){Jx.ptStopData("People-Linking","Windows-Live-People-Linking",this._suggestionCount,0,0,0,0,"","");this._ptStopLogged=true};n.activate=function(){};n.deactivate=function(){return this._layoutChangedHandler&&(this._layout.removeLayoutChangedEventListener(this._updateLayout,this),this._layoutChangedHandler=null),this._completeListener&&(this._person.removeEventListener("changed",this._completeListener),this._completeListener=null),clearTimeout(this._timeout),this._timeout=0,true};n.unload=function(){this._ptStopLogged||this._markPtStopLoad();Jx.dispose(this._suggestions);this._suggestions=null;Jx.dispose(this._groupedItems);for(var n in this._identityControls)Jx.dispose(this._identityControls[n]);this._identityControls=null;Jx.dispose(this._jobSet);this._jobSet=null};n._addSuggestions=function(){for(var r,u,n=0;n<this._groupedItems.length;n++)if(this._groupedItems.getAt(n).type===i.progress)break;this._groupedItems.splice(n,1);var f=this._suggestions,e=f.getResults(),o=e.count;for(r=0;r<o;r++)try{u=e.item(r);this._groupedItems.some(function(n){return n.type===i.newPerson&&n.person.objectId===u.objectId})||(this._groupedItems.splice(n,0,{type:i.newPerson,group:t.suggestions,person:u}),n++)}catch(s){Jx.log.exception("Error adding suggestion",s)}this._suggestionCount=o;Jx.dispose(f);this._suggestions=null;this._suggestionReadyInLoad||this._markPtStopLoad()};n._itemInvoked=function(n){var e,u,o;var s=this,f=n.detail.itemIndex,r=this._groupedItems.getAt(f);r.type===i.pickerLink?(e=Windows.ApplicationModel.Contacts,u=new e.ContactPicker,u.commitButtonText=Jx.res.getString("/strings/linking_peoplepickertext"),u.desiredFieldsWithContactFieldType.append(Windows.ApplicationModel.Contacts.ContactFieldType.custom),u.selectionMode=e.ContactSelectionMode.contacts,u.pickContactsAsync().done(function(n){n&&n.forEach(function(n){s._addLinkedContact(n.id)})},Jx.fnEmpty)):(r.type===i.existingContact||r.type===i.newPerson)&&(r.group===t.links?this._getLinkCount()>1&&this._changeGroup(r,f,t.suggestions):(o=r.person||r.contact,this._canLink(o)?this._changeGroup(r,f,t.links):this._reportRejectedLinks([o])))};n._getLinkCount=function(){return this._groupedItems.reduce(function(n,i){return n+(i.group===t.links?1:0)},0)};n._canLink=function(n){var u,i,r;if(o(n))for(u=this._groupedItems,i=0;i<u.length;i++)if(r=u.getAt(i),r.group===t.links&&o(r.person||r.contact))return false;return true};n._reportRejectedLinks=function(n){var t,i,r;n.length>0&&(t=Jx.res.getString("/strings/linking_linkRejectedMultiple"),n.length===1&&(i=n[0].calculatedUIName,i&&(t=Jx.res.loadCompoundString("/strings/linking_linkRejected",i))),r=this._host.getMessageBar(),r.addErrorMessage("linkRejection",10,{messageText:t,button2:{text:Jx.res.getString("/strings/linking_linkRejected_button"),tooltip:Jx.res.getString("/strings/linking_linkRejected_button"),callback:function(){r.removeMessage("linkRejection")}}}))};n._changeGroup=function(n,i,r){var u=this._getLinkCount();u>i&&u--;this._groupedItems.move(i,u);n.group=r;this._groupedItems.notifyMutated(u)};n._renderItem=function(n){var r,f,u;return n.type===i.pickerLink?(r=document.createElement("div"),r.innerHTML="<div class='profileLink-pickerLink'><div class='profileLink-pickerGlyph'><\/div><span class='profileLink-pickerText'>"+Jx.escapeHtml(Jx.res.getString("/strings/linking_choosecontact"))+"<\/span><\/div>"):n.type===i.progress?(r=document.createElement("div"),r.className="profileLink-progress",r.innerHTML="<progress class='profileLink-progressSpinner'><\/progress>"):(f=n.group===t.links?this._linkedFactory:this._unlinkedFactory,u=f.create(this._jobSet),u.setDataContext(n.contact||n.person),this._identityControls[u.id]=u,r=u.getElement()),r};n._disposeElement=function(n,t){var i=t.id,r=this._identityControls[i];r&&(delete this._identityControls[i],Jx.dispose(r))};n._addLinkedContact=function(n){var o=[],s,r,e,u,f,h;if(n!==this._person.objectId){for(s=false,r=0;r<this._groupedItems.length;r++)if(e=this._groupedItems.getAt(r),u=e.person,Jx.isObject(u)&&u.objectId===n){s=true;e.group!==t.links&&(this._canLink(u)?this._changeGroup(e,r,t.links):o.push(u));break}s||(f=this._platform.peopleManager.tryLoadPerson(n),f&&(this._canLink(f)?(h=this._getLinkCount(),this._groupedItems.splice(h,0,{type:i.newPerson,group:t.links,person:f})):o.push(f)))}this._reportRejectedLinks(o)};n._getPersonIdsToLink=function(){return this._groupedItems.filter(function(n){return n.group===t.links&&n.type===i.newPerson}).map(function(n){return n.person.objectId})};n._getContactIdsToUnlink=function(){return this._groupedItems.filter(function(n){return n.group===t.suggestions&&n.type===i.existingContact}).map(function(n){return n.contact.objectId})};n.prepareSuspension=e("prepareSuspension",v);n._onSave=e("onSave",y);n._onChange=function(n){Array.prototype.indexOf.call(n,"manualLinkCompleted")!==-1&&(Jx.log.info("Link complete event received, leaving page"),this._host.back())};n._onTimeout=function(){Jx.log.warning("Timed out waiting for link complete event, leaving page");this._host.back()};n._onCancel=function(){this._host.back()};f.prepareSuggestions=function(n){Jx.dispose(this._suggestions);this._suggestions=new u(n)};f.getSuggestions=function(n){var t=this._suggestions;return this._suggestions=null,t&&t.getPersonId()===n.objectId||(Jx.dispose(t),t=new u(n)),t};Jx.augment(u,Jx.Events);u.prototype.dispose=function(){this._collection.removeEventListener("collectionchanged",this._listener);this._collection.dispose()};u.prototype.getPersonId=function(){return this._id};u.prototype.getResults=function(){return this._collection};u.prototype.isReady=function(){return this._isReady};u.prototype._onChange=function(n){n.eType===Microsoft.WindowsLive.Platform.CollectionChangeType.localSearchComplete&&(this._isReady=true,this.raiseEvent("ready"))}})