Jx.delayDefine(People.Controls,"ProfilePictureControl",function(){function ot(n){$include("$(cssResources)/controls-people.css");this._loaded=true;this._dragging=false;this._container=n.element;this._person=n.data;this._buttonsControl=new h;this._createDisplay();this._showProfilePicture()}function st(){this._photoProperties.url===null?this._photoProperties.changed&&this._person.clearUserTile():this._setUserTile();this._host.back()}function ht(){var t=this._host.getCommandBar(),i,n;t.addCommand(new f.Command("photoPicker","/meStrings/picCtrl_cmdPicker",null,"",true,true,this,this.openPhotoPicker));t.addCommand(new f.Command("webcam","/meStrings/picCtrl_cmdWebCam",null,"",true,true,this,this.openWebCam));t.addCommand(new f.Command("deletePic","/meStrings/picCtrl_cmdDelete",null,"",true,this._photoProperties.url!==null,this,this.removePicture));i=this._host.getFrameCommands();i.addCommand(new f.Command("savePic",null,"/meStrings/picCtrl_cmdSave_tooltip","",true,true,this,this.save));i.addCommand(new f.Command("cancelPic",null,"/meStrings/picCtrl_cmdCancel_tooltip","",true,true,this,this.cancel));this._buttonsControl.activate();n=this._elements;this._MSContentZoomListener=this._onZoom.bind(this);n.scroller.addEventListener("MSContentZoom",this._MSContentZoomListener,false);n.scroller.addEventListener("mousedown",function(n){n.button===1&&n.preventDefault()},false);n.container.addEventListener("keydown",this._onKeyDown.bind(this),false);n.container.addEventListener("mousewheel",this._onMouseWheel.bind(this),false);n.hitTarget.addEventListener("MSPointerDown",this._onMSPointerDown.bind(this),false);this._MSPointerMoveListener=this._onMSPointerMove.bind(this);this._MSPointerUpListener=this._onMSPointerUp.bind(this);n.photo.addEventListener("load",this._showImage.bind(this),false);this._resizeListener=this._onResize.bind(this);window.addEventListener("resize",this._resizeListener,false)}function ct(){var t=this,n=new y.FileOpenPicker;n.viewMode=y.PickerViewMode.thumbnail;n.suggestedStartLocation=y.PickerLocationId.picturesLibrary;n.fileTypeFilter.replaceAll([".jpg",".jpeg",".gif",".png",".bmp",".tif",".tiff"]);n.pickSingleFileAsync().done(function(n){t._elements.container.focus();n&&(t._loadFromFileItem(n),t=null)},Jx.fnEmpty)}function lt(){var n=this,t=new Windows.Media.Capture.CameraCaptureUI;t.photoSettings.allowCropping=false;t.captureFileAsync(Windows.Media.Capture.CameraCaptureUIMode.photo).done(function(t){n._elements.container.focus();t&&(n._loadFromFileItem(t),n=null)},Jx.fnEmpty)}function at(){this._setImage(null)}function rt(n,t,i){return c?t-i-n:n}function r(n){var t=n;t&&t.close()}function d(n,t,i){n.style.width=String(t)+"px";n.style.height=String(i)+"px"}function a(n,t,i){n.style[w]=String(t)+"px";n.style.top=String(i)+"px"}function ut(n,t){for(var i in n)n[i]=Math.round(n[i]/t)}function v(n){return Jx.escapeHtml(Jx.res.getString("/meStrings/"+n))}function vt(){return p.ApplicationView.value===p.ApplicationViewState.snapped}var f=window.People,g=f.Controls,yt=f.Nav,i=Windows.Graphics.Imaging,o=Windows.Storage,y=Windows.Storage.Pickers,p=Windows.UI.ViewManagement,pt=p.ApplicationView,c=Jx.isRtl(),w=c?"right":"left",ft=Include.replacePaths("$(imageResources)/ic-default-220.png"),t=220,nt=2200,tt=.1,b=4,it=4,et=10,l=.001,s={},k,e,n,h,u;s[i.BitmapDecoder.gifDecoderId]=i.BitmapEncoder.gifEncoderId;s[i.BitmapDecoder.pngDecoderId]=i.BitmapEncoder.pngEncoderId;s[i.BitmapDecoder.jpegDecoderId]=i.BitmapEncoder.jpegEncoderId;k=i.BitmapEncoder.jpegEncoderId;e=function(n,t){return function(){try{return t.apply(this,arguments)}finally{}}};g.ProfilePictureControl=function(n){this._host=n;this._container=null;this._person=null;this._elements={photo:null,scroller:null,container:null,hitTargetZoom:null,hitTarget:null,inner:null,anchor:null,mask:null,crop:null};this._controlProperties={scale:1,photoWidth:0,photoHeight:0,zoomMin:0,zoomMax:0,scrollLimitLeft:0,scrollLimitTop:0,minScrollHeight:0,minScrollWidth:0,crop:{x:0,y:0,width:0,height:0}};this._photoProperties={url:null,changed:false,tempFile:null,storageFile:null,crop:null};this._snappedX=-1;this._snappedY=-1;this._updateScrollerHandle=null};n=g.ProfilePictureControl.prototype;n.load=e("load",ot);n.save=e("save",st);n.cancel=function(){this._photoProperties.tempFile&&this._photoProperties.tempFile.deleteAsync();this._host.back()};n.prepareSuspension=Jx.fnEmpty;n.activate=e("activate",ht);n.deactivate=function(){return window.removeEventListener("resize",this._resizeListener,false),window.removeEventListener("MSPointerUp",this._MSPointerUpListener,false),true};n.unload=function(){this._loaded=false};n.openPhotoPicker=e("openPhotoPicker",ct);n.openWebCam=e("openWebCam",lt);n.removePicture=e("remove",at);n._createDisplay=function(){var n=this._buttonsControl,i;n.addButton(new u("zoomIn","",this._doZoom.bind(this,1),"ctrl + plus"));n.addButton(new u("zoomOut","",this._doZoom.bind(this,-1),"ctrl + -"));n.addButton(new u("zoomToFit","",this._zoomToFit.bind(this)));this._container.innerHTML="<div id='profilePicture-container'><div id='profilePicture-scroller' aria-label='"+v("picCtrl_image")+"'><div id='profilePicture-hitTargetContainer'><div id='profilePicture-hitTargetZoom'><\/div><div id='profilePicture-hitTarget'><\/div><\/div><div id='profilePicture-inner'><img id='profilePicture-photo' width='0' height='0' aria-label='"+v("picCtrl_image")+"'><\/div><div id='profilePicture-anchor'><\/div><\/div>"+n.getUI()+"<div id='profilePicture-mask'><div id='profilePicture-crop' style='width:"+String(t)+"px;height:"+String(t)+"px;'><\/div><\/div><\/div>";this._container.style.msScrollLimitXMax="0px";i=this._elements={container:document.getElementById("profilePicture-container"),scroller:document.getElementById("profilePicture-scroller"),hitTargetZoom:document.getElementById("profilePicture-hitTargetZoom"),hitTarget:document.getElementById("profilePicture-hitTarget"),inner:document.getElementById("profilePicture-inner"),photo:document.getElementById("profilePicture-photo"),anchor:document.getElementById("profilePicture-anchor"),mask:document.getElementById("profilePicture-mask"),crop:document.getElementById("profilePicture-crop")};this._setUpMask()};n._setUpMask=function(){var u=this._elements.mask,n=this._elements.container,i=this._elements.scroller,r;i.style.width=String(i.clientWidth)+"px";i.style.height=String(i.clientHeight)+"px";r=Math.ceil((Math.max(n.offsetWidth,n.offsetHeight)-t)/2);u.style.borderWidth=String(r)+"px";a(u,Math.floor((n.clientWidth-t)/2)-r-it,Math.floor((n.clientHeight-t)/2)-r-it)};n._loadFromFileItem=function(n){var u,f=this._photoProperties.tempFile,t=this,e=n;e.openReadAsync().then(function(n){return u=n,i.BitmapDecoder.createAsync(n)}).done(function(e){if(e.frameCount>1){var l,c,h;e.getPixelDataAsync().then(function(n){return l=n.detachPixelData(),r(u),o.ApplicationData.current.temporaryFolder.createFileAsync("profilepicture",o.CreationCollisionOption.generateUniqueName)}).then(function(n){return c=n,n.openAsync(o.FileAccessMode.readWrite)}).then(function(n){h=n;var t=s[e.decoderInformation.codecId];return t=t?t:k,i.BitmapEncoder.createAsync(t,h)}).then(function(n){return n.setPixelData(e.bitmapPixelFormat,e.bitmapAlphaMode,e.orientedPixelWidth,e.orientedPixelHeight,e.dpiX,e.dpiY,l),n.flushAsync()}).done(function(){r(h);f&&f.deleteAsync();t._photoProperties.storageFile=t._photoProperties.tempFile=c;t._setImage("ms-appdata:///temp/"+c.name)},function(){r(u);r(h)})}else r(u),t._photoProperties.storageFile=n,t._setImage(URL.createObjectURL(n,{oneTimeOnly:true}))},Jx.fnEmpty)};n._showProfilePicture=function(){var t=this._person.getUserTile(Microsoft.WindowsLive.Platform.UserTileSize.original,false),n=this._person.userTileCrop,i=null;!Jx.isNullOrUndefined(t)&&Jx.isNonEmptyString(t.appdataURI)&&(i=t.appdataURI,!Jx.isNullOrUndefined(n)&&n.width>0&&n.height>0&&(this._photoProperties.crop=n));this._setImage(i)};n._showImage=function(){var h,p,w,c,l;if(this._loaded){var r=this._controlProperties,n=this._photoProperties,s=this._elements.container,o=this._elements.scroller;this._dragging=false;this._setScale();var i=1,u=r.scale,f=r.photoWidth,e=r.photoHeight;n.crop?(h=t/n.crop.width/u,h>=tt&&h<=b&&n.crop.x+n.crop.width<=f/u&&n.crop.y+n.crop.height<=e/u?(i=h,p=rt(n.crop.x*u,f,n.crop.width),w=n.crop.y*u):n.crop=null):u<=1&&(c=e/s.clientHeight,l=f/s.clientWidth,c>=l&&c>1?(i=s.clientHeight/e,f*i<t&&(i=t/f)):c<l&&l>1&&(i=s.clientWidth/f,e*i<t&&(i=t/e)));var a=Math.max(tt,t/Math.min(f,e)),v=Math.min(b,Math.max(b/u,1)),y=n.url===null;a=y?1:Math.ceil(a*Math.pow(10,4))/Math.pow(10,4);v=y?1:Math.floor(v*Math.pow(10,4))/Math.pow(10,4);this._buttonsControl.disableButton("zoomToFit",y);o.style.msContentZoomLimitMin=String(a*100)+"%";o.style.msContentZoomLimitMax=String(v*100)+"%";r.zoomMin=a;r.zoomMax=v;this._setDimensions();o.msContentZoomFactor=i;this._updateScroller();n.crop?(o.scrollLeft=r.scrollLimitLeft+p,o.scrollTop=r.scrollLimitTop+w):this._centerImage(i);Jx.setClass(this._elements.crop,"inactive",y);Jx.removeClass(this._elements.photo,"hidden")}};n._setScale=function(){var u=this._elements.photo,i=u.naturalWidth,r=u.naturalHeight,f=Math.max(i,r),e=Math.min(i,r),n=1;n=f>nt?nt/f:n;n=e*n<t?t/e:n;this._controlProperties.scale=n;i=Math.round(i*n);r=Math.round(r*n);this._sizePhoto(i,r)};n._setDimensions=function(){var i=this._controlProperties,r=i.photoWidth,u=i.photoHeight,n=i.zoomMin,f=this._elements.scroller,e=Math.ceil((f.clientWidth+r*n-t)/n),o=Math.ceil((f.clientHeight+u*n-t)/n),s,h;this._sizeControls(e,o);s=Math.floor((e-r)/2);h=Math.floor((o-u)/2);this._movePhoto(s,h)};n._setImage=function(n){if(this._loaded){var t=this._elements.photo,i=this._host.getCommandBar();Jx.isNonEmptyString(t.src)&&(this._photoProperties.crop=null);this._photoProperties.changed=Jx.isNonEmptyString(t.src);this._photoProperties.url=n;t.src="";n===null?(t.src=ft,i.hideCommand("deletePic")):(t.src=n,i.showCommand("deletePic"));Jx.addClass(t,"hidden")}};n._setUserTile=function(){var i=this._controlProperties,r=this._photoProperties,u=this._elements.scroller,n={},f,e,s;n.width=n.height=Math.round(t/u.msContentZoomFactor);n.x=rt(u.scrollLeft-i.scrollLimitLeft,i.photoWidth,n.width);n.y=u.scrollTop-i.scrollLimitTop;i.crop=n;f=this._person.userTileCrop;"isMock"in this._host.getPlatform()||(r.changed?this._savePhotoStreams(r.storageFile):(e=Object.getOwnPropertyNames(n).some(function(t){return n[t]!==f[t]}),(i.scale!==1||e)&&(s=this._savePhotoStreams.bind(this),o.StorageFile.getFileFromApplicationUriAsync(new Windows.Foundation.Uri(r.url)).done(s,Jx.fnEmpty))))};n._savePhotoStreams=function(n){var u=this._controlProperties,l=this._elements.scroller,f,e,h=this,c=n;c.openReadAsync().then(function(n){return f=n,i.BitmapDecoder.createAsync(n)}).done(function(n){var y=[],p,c,l,w,a,v,b,d,g;e=s[n.decoderInformation.codecId];e||(e=k);p=new i.BitmapTransform;c={width:u.crop.width,height:u.crop.height,x:u.crop.x,y:u.crop.y};ut(c,u.scale);c.x=Math.min(c.x,n.orientedPixelWidth-c.width);c.y=Math.min(c.y,n.orientedPixelHeight-c.height);p.bounds=c;w=n.getPixelDataAsync(n.bitmapPixelFormat,n.bitmapAlphaMode,p,i.ExifOrientationMode.respectExifOrientation,i.ColorManagementMode.colorManageToSRgb).then(function(r){return l=new o.Streams.InMemoryRandomAccessStream,i.BitmapEncoder.createAsync(e,l).then(function(u){return u.bitmapTransform.scaledWidth=t,u.bitmapTransform.scaledHeight=t,u.bitmapTransform.interpolationMode=i.BitmapInterpolationMode.linear,u.setPixelData(n.bitmapPixelFormat,n.bitmapAlphaMode,c.width,c.height,n.dpiX,n.dpiY,r.detachPixelData()),u.flushAsync()})});y.push(w);u.scale<1||Jx.isNullOrUndefined(s[n.decoderInformation.codecId])?(a=new o.Streams.InMemoryRandomAccessStream,v=f.cloneStream(),g=i.BitmapDecoder.createAsync(v).then(function(n){return b=n.pixelWidth,d=n.pixelHeight,i.BitmapEncoder.createForTranscodingAsync(a,n)}).then(function(n){return u.scale<1&&(n.bitmapTransform.scaledWidth=b*u.scale,n.bitmapTransform.scaledHeight=d*u.scale,n.bitmapTransform.interpolationMode=i.BitmapInterpolationMode.linear),n.flushAsync()}),y.push(g)):a=f;WinJS.Promise.join(y).done(function(){var n=u.crop,t,i;u.scale>1&&ut(n,u.scale);n.x=Math.min(n.x,u.photoWidth-n.width);n.y=Math.min(n.y,u.photoHeight-n.height);h._person.setUserTile(a,l,n);Windows.System.UserProfile.UserInformation.accountPictureChangeEnabled&&(t=new Windows.Security.Authentication.OnlineId.OnlineIdAuthenticator,t.canSignOut||(i=l,Windows.System.UserProfile.UserInformation.setAccountPicturesFromStreamsAsync(null,i,null)));r(f);r(v);h._photoProperties.tempFile&&h._photoProperties.tempFile.deleteAsync()},function(){r(f);r(v)})},Jx.fnEmpty)};n._onResize=function(){var n=this._controlProperties,t=this._elements.scroller,i,r;this._dragging=false;i=this._snappedX===-1?t.scrollLeft-n.scrollLimitLeft:this._snappedX;r=this._snappedY===-1?t.scrollTop-n.scrollLimitTop:this._snappedY;t.style.width=t.style.height="";this._setUpMask();this._setDimensions();this._updateScroller();vt()?(this._snappedX=i,this._snappedY=r):(this._snappedX=this._snappedY=-1,this._scrollTo(n.scrollLimitLeft+i,n.scrollLimitTop+r))};n._onMSPointerDown=function(n){this._dragging||n.pointerType!=="mouse"&&n.pointerType!==n.MSPOINTER_TYPE_MOUSE||n.button!==0||(this._dragging=true,this._offsetLeft=this._startingOffsetLeft=parseInt(this._elements.photo.style[w]),this._offsetTop=this._startingOffsetTop=this._elements.photo.offsetTop,this._lastX=n.clientX,this._lastY=n.clientY,this._elements.container.addEventListener("MSPointerMove",this._MSPointerMoveListener,false),window.addEventListener("MSPointerUp",this._MSPointerUpListener,false))};n._onMSPointerMove=function(n){var t;if(this._dragging){var i=n.clientX-this._lastX,r=n.clientY-this._lastY,u=this._elements.scroller;i&&(t=i/u.msContentZoomFactor,this._offsetLeft+=c?-t:t,this._lastX=n.clientX);r&&(this._offsetTop+=r/u.msContentZoomFactor,this._lastY=n.clientY);this._movePhoto(this._offsetLeft,this._offsetTop)}};n._onMSPointerUp=function(n){if(this._dragging&&(n.pointerType==="mouse"||n.pointerType===n.MSPOINTER_TYPE_MOUSE)&&n.button===0){this._dragging=false;var t=this._elements.photo,i=this._elements.scroller,r=this._startingOffsetLeft-parseInt(t.style[w]),u=this._startingOffsetTop-t.offsetTop;this._movePhoto(this._startingOffsetLeft,this._startingOffsetTop);this._scrollTo(i.scrollLeft+r,i.scrollTop+u);this._elements.container.removeEventListener("MSPointerMove",this._MSPointerMoveListener,false);window.removeEventListener("MSPointerUp",this._MSPointerUpListener,false)}};n._onMouseWheel=function(n){n.ctrlKey&&this._doZoom(n.wheelDelta/120);n.preventDefault()};n._onKeyDown=function(n){var t=WinJS.Utilities.Key,i=this._elements.scroller,r=et/i.msContentZoomFactor;switch(n.keyCode){case t.add:case t.equal:n.ctrlKey&&this._doZoom(1);break;case t.subtract:case t.dash:n.ctrlKey&&this._doZoom(-1);break;case t.upArrow:i.scrollTop-=r;n.preventDefault();break;case t.downArrow:i.scrollTop+=r;n.preventDefault();break;case t.leftArrow:n.altKey||(i.scrollLeft-=r*(c?-1:1),n.preventDefault());break;case t.rightArrow:i.scrollLeft+=r*(c?-1:1);n.preventDefault();break;case t.space:case t.pageDown:case t.pageUp:case t.home:case t.end:n.preventDefault()}};n._onZoom=function(){this._updateScrollerHandle&&msClearImmediate(this._updateScrollerHandle);this._updateScrollerHandle=msSetImmediate(this._updateScroller.bind(this))};n._doZoom=function(n){var t=this._elements.scroller,i=t.msContentZoomFactor,r=i*(n>0?1.1:1/1.1);n>0&&i>=this._controlProperties.zoomMax-l||n<0&&i<=this._controlProperties.zoomMin+l||(t.style.msScrollLimitXMin=t.style.msScrollLimitXMax=t.style.msScrollLimitYMin=t.style.msScrollLimitYMax="",t.msContentZoomFactor=r,this._scrollTo(t.scrollLeft+t.clientWidth*(1/i-1/t.msContentZoomFactor)/2,t.scrollTop+t.clientHeight*(1/i-1/t.msContentZoomFactor)/2),this._updateScroller())};n._zoomToFit=function(){this._elements.scroller.msContentZoomFactor=this._controlProperties.zoomMin;this._updateScroller();this._centerImage()};n._scrollTo=function(n,t){var i=this._elements.anchor;a(i,n,t);i.scrollIntoView()};n._centerImage=function(n){var t=this._elements.scroller,i=this._elements.inner;Jx.isNullOrUndefined(n)&&(n=t.msContentZoomFactor);t.scrollLeft=(i.clientWidth-t.clientWidth/n)/2;t.scrollTop=(i.clientHeight-t.clientHeight/n)/2};n._updateScroller=function(){var i=this._elements.scroller,e=this._elements.container,n=this._controlProperties,r=i.msContentZoomFactor,o=this._buttonsControl,c=r>=n.zoomMax-l,s,u;o.disableButton("zoomIn",c);s=r<=n.zoomMin+l;o.disableButton("zoomOut",s);var a=(e.clientWidth-t)/2,v=(e.clientHeight-t)/2,h=function(n,i,u){var f=Math.ceil(Math.floor((n-i)/2)-u/r),e=Math.max(Math.floor(Math.floor((n+i)/2)-(u+t)/r),0);return f=Math.min(f,e),{min:f,max:e}},f=h(n.minScrollHeight,n.photoHeight,v);n.scrollLimitTop=f.min;i.style.msScrollLimitYMin=String(f.min)+"px";i.style.msScrollLimitYMax=String(f.max)+"px";u=h(n.minScrollWidth,n.photoWidth,a);n.scrollLimitLeft=u.min;i.style.msScrollLimitXMin=String(u.min)+"px";i.style.msScrollLimitXMax=String(u.max)+"px"};n._movePhoto=function(n,t){a(this._elements.photo,n,t);a(this._elements.hitTarget,n,t)};n._sizePhoto=function(n,t){this._elements.photo.width=n;this._elements.photo.height=t;d(this._elements.hitTarget,n,t);this._controlProperties.photoWidth=n;this._controlProperties.photoHeight=t};n._sizeControls=function(n,t){d(this._elements.inner,n,t);d(this._elements.hitTargetZoom,n,t);this._controlProperties.minScrollWidth=n;this._controlProperties.minScrollHeight=t};h=function(){this._buttons={}};h.prototype.addButton=function(n){var t=n.getName();this._buttons[t]=n};h.prototype.disableButton=function(n,t){this._buttons[n].disabled(t)};h.prototype.getUI=function(){var n=this._buttons,t="<div id='profilePicture-buttons'>",i;for(i in n)t+=n[i].getUI();return t+"<\/div>"};h.prototype.activate=function(){var n=this._buttons,t;for(t in n)n[t].activate()};u=function(n,t,i,r){this._name=n;this._id="profilePicture-"+n;this._symbol=t;this._eventHandler=i;this._keyboardShortcut=r?r:null;this._element=null};u.prototype.getUI=function(){var n="picCtrl_"+this._name,i=v(n),t=n+"_tooltip",r=function(n){return Jx.escapeHtml(Jx.res.loadCompoundString("/meStrings/"+t,n))},u=this._keyboardShortcut?r([Jx.key.getLabel(this._keyboardShortcut)]):v(t);return"<div id='"+this._id+"' class='profilePicture-button' tabIndex='0' role='button' aria-label='"+i+"' title='"+u+"'>"+this._symbol+"<\/div>"};u.prototype.activate=function(){var n=this._element=document.getElementById(this._id);n.addEventListener("click",this._eventHandler,false);n.addEventListener("keydown",this._onKeyDown.bind(this),false);f.Animation.addPressStyling(n)};u.prototype.disabled=function(n){var t=this._element;t.disabled=n;t.setAttribute("aria-disabled",String(n))};u.prototype._onKeyDown=function(n){if((n.key==="Enter"||n.key==="Spacebar")&&(this._eventHandler(),!Jx.hasClass(n.target,"pressed"))){Jx.addClass(n.target,"pressed");var t=function(){document.removeEventListener("keyup",t,false);Jx.removeClass(n.target,"pressed")};document.addEventListener("keyup",t,false)}};u.prototype.getName=function(){return this._name}})