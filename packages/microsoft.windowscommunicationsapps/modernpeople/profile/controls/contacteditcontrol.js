Jx.delayDefine(People.Controls,"ContactEditControl",function(){function i(n,t){return function(){try{return t.apply(this,arguments)}finally{}}}function h(n){var i,r,o,u,s,e;$include("$(cssResources)/controls-people.css");i=this._hostDiv=n.element;this._cachedWidth=0;this._explicitLeave=false;r=this._host;this._jobSet=r.getJobSet().createChild();this._setContact(n.data,n.fields);o=this._contact;u=r.getFrameCommands();!Jx.isNullOrUndefined(o)&&o.canDelete&&u.addCommand(new t.Command("cmdid_profile_delete",null,"/strings/profileFrameButtonDelete_tooltip","",true,true,this,this._onDelete));u.addCommand(new t.Command("cmdid_profile_save",null,"/strings/profileFrameButtonSave_tooltip","",true,true,this,this._onSave));u.addCommand(new t.Command("cmdid_profile_cancel",null,"/strings/profileFrameButtonCancel_tooltip","",true,true,this,this._onCancel));s=this._layout=r.getLayout();this._layoutChangedHandler=this._resizeContent;s.addLayoutChangedEventListener(this._resizeContent,this);s.addOrientationChangedEventListener(this._resizeContent,this);i.innerHTML="<div id='displayDiv_addLinkEdit' class='profileBase-container' aria-label='"+Jx.escapeHtml(Jx.res.getString("/strings/editContactHeader"))+"'><div id='contactEditControl'><\/div><div id='contactEditPadding' class='profileBase-paddingDiv' aria-disabled='true'><\/div><\/div>";e=n.context||n.state;this._jobSet.addUIJob(this,function(){this._loadContent(i.querySelector("#contactEditControl"),e);n.mode==="hydrate"&&e&&f.setScrollPosition(i,e)},null,t.Priority.next)}function c(){return this._getCurrentState()}function l(n,i){var r=this._personAccessor,u=this._contact,e=this._contactAccessor,f,o;u||(f=this._host.getPlatform(),o=f.accountManager.defaultAccount,u=f.peopleManager.createContact(o),Boolean(r)&&Boolean(r.firstName)&&(u.firstName=r.firstName),Boolean(r)&&Boolean(r.lastName)&&(u.lastName=r.lastName));this._contact=u;this._uiform=new t.UiForm({fieldList:t.Contact.editFieldList,groupList:t.Contact.getEditGroupList(),loc:Jx.res,formValidator:t.Contact._formValidator,cssPrefix:"profileEdit-",residPrefix:"/strings/profile_",onFormChanged:this._resizeContent.bind(this)});e?this._createEditForm(n,e,i):this._createEditForm(n,u,i)}function a(n,t){for(var e=n.accountManager,o=e.getConnectedAccountsByScenario(r.ApplicationScenario.people,r.ConnectedFilter.normal,r.AccountSort.name),u,c,i=0,s=o.count;i<s;i++){var f=o.item(i),h=f.editableResources,l=h.count;for(u=0;u<l;u++)if(c=h.item(u),Number(c.resourceType)===r.ResourceType.contacts){if(f.objectId===t)return f;break}}return e.defaultAccount}function v(n,t){var i=n._host.getPlatform(),r=a(i,t);return i.peopleManager.createContact(r)}function y(){var u;if(this._commitContact){Jx.log.error("Commit is already in progress");return}var f=this._person,n=this._contact,r=this._uiform,i=true;try{i=!n.person}catch(s){Jx.log.exception("Error accessing contact.person on ContactEditControl._onSave.",s);this._onCancel()}u=Boolean(f)&&i;i&&!u?(n=v(this,r.getInputFieldValueByName("account")),this._contact=n,Jx.bici.increment(e.People.contactAddSave,1)):Jx.bici.increment(e.People.profileEditSave,1);Boolean(r)&&r.saveEditForm(n)&&(this._commitContact=new t.CommitContact(n,f,function(n){var t=i&&!u&&n;this._leavePage(t?o.getViewPersonUri(n.objectId):null)},this))}var t=window.People,u=t.Controls,o=t.Nav,p=t.Layout,f=u.ContactControlPosition,r=Microsoft.WindowsLive.Platform,e=Microsoft.WindowsLive.Instrumentation.Ids,s=120,w=u.ContactEditControl=function(n){this._host=n},n=u.ContactEditControl.prototype;n._uiform=null;n._contact=null;n._person=null;n._timeout=null;n._onFocus=null;n._personChangedListener=null;n._contactChangedListener=null;n._leavePage=null;n._personBinder=null;n._personAccessor=null;n._contactAccessor=null;n._commitContact=null;n.load=i("load",h);n._setContact=function(n,i){var r,e,o,f,l,u;this._person=n;r=this._personBinder=n?new t.PlatformObjectBinder(n):null;e=this._personAccessor=r?r.createAccessor():null;r&&r.getCollection(this._onContactDelete.bind(this),"linkedContacts");var s=null,h=i&&i.contactId?i.contactId:null,c=null;if(e)for(o=e.linkedContacts,f=0,l=o.length;f<l;f++)if(u=o[f],u.canEdit&&(!h||u.objectId===h)){c=u;s=u.getPlatformObject();break}this._contact=s;this._contactAccessor=c};n.prepareSaveBackState=function(){var n=null;return this._explicitLeave||(n=this._getCurrentState()),n};n.prepareSuspension=i("prepareSuspension",c);n._getCurrentState=function(){var n=f.getScrollPosition(this._hostDiv);return this._uiform&&(n.form=this._uiform.dehydrateEditForm(this._contact)),n};n.activate=i("activate",function(){});n.deactivate=function(){Jx.dispose(this._commitContact);this._commitContact=null;this._layoutChangedHandler&&(this._layout.removeLayoutChangedEventListener(this._resizeContent,this),this._layout.removeOrientationChangedEventListener(this._resizeContent,this),this._layoutChangedHandler=null);var n=this._jobSet;return n&&n.cancelAllChildJobs(),true};n.unload=function(){this._uiform=null;Jx.dispose(this._jobSet);this._jobSet=null;Jx.dispose(this._personBinder);this._personBinder=null;this._personAccessor=null;this._contactAccessor=null;this._person=null;this._contact=null;this._hostDiv.innerHTML=""};n._loadContent=i("loadContent",l);n._createEditForm=function(n,t,i){var r=null;i&&i.form&&(r=i.form);this._uiform.createEditForm(n,t,r);this._saved=false;this._resizeContent()};n._resize=function(){var n=this._hostDiv;this._cachedWidth=f.update(this._layout,this._cachedWidth,n.querySelector("#contactEditControl"),n.querySelector("#contactEditPadding"),s)};n._resizeContent=function(){this._jobSet.addUIJob(this,this._resize,null,t.Priority.realizeItem)};n._leavePage=function(n){this._explicitLeave=true;this._host.back(n)};n._onSave=i("onSave",y);n._onCancel=function(){this._leavePage();Jx.bici.increment(e.People.profileEditCancel,1)};n._onContactDelete=function(){var t;var n=this._personAccessor.linkedContacts,i=this._contact,r=n.some(function(n){return n.objectId===i.objectId});r||(t=n.some(function(n){return!n.isGal}),t?this._leavePage():Jx.log.info("Last contact on person is deleted."))};n._onDelete=function(n,i){var u=this._personAccessor,r;r=new t.Controls.ContactDeleteFlyout;r.show(u,i,"bottom",this._contactAccessor)}})