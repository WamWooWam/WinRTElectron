Jx.delayDefine(People,"CpMain",function(){function e(n){Jx.mark("People.CpMain."+n+",StartTA,People,AppFrame")}function o(n){Jx.mark("People.CpMain."+n+",StopTA,People,AppFrame")}function l(n){Jx.mark("People.CpMain."+n+",Info,People,AppFrame")}function h(){return document.getElementById("searchControlId").winControl}function b(){return document.getElementById("searchControlId").querySelector(".win-searchbox-input")}function y(n,t){t.forEach(function(t){t[n]&&t[n]()})}function p(n){return n.linkedContacts.length===0}var n=window.People,t=n.Nav,r=Microsoft.WindowsLive.Platform,u=r.ApplicationScenario,s,v,f,c;InstruID=Microsoft.WindowsLive.Instrumentation.Ids;var i={inactive:"inactive",active:"active"},a=955,w=501;n.CpMain=function(t,r,f){Jx.log.info("People.CpMain");this._name="People.CpMain";this.initComponent();this._scheduler=r;var e=this._jobSet=r.getJobSet().createChild();this._platformCache=new n.PlatformCache(t,this._jobSet);this._searchPane=null;this._activationUri=f;this._header=new n.CpHeader(e);this._content=new n.CpContent(e);this._connectedTo=new n.Accounts.ConnectedAccounts(u.people,e);this._connectedTo.setPlatform(t);this._appbar=new n.CpAppBar(e,this);this._navbar=new n.CpNavBar(e,this);this._settings=null;this._currentSearchState=i.inactive;this.append(this._header,this._content,this._connectedTo,this._navbar,this._appbar);this._nav=new n.AppNav(this.homeLocation,this.onBeforeNavigate,this.onNavigate,this)};Jx.augment(n.CpMain,Jx.Component);n.CpMain.prototype.navigationCompleted="navigationCompleted";n.CpMain.prototype.homepage=t.Pages.viewab.id;n.CpMain.prototype.homeLocation={page:t.Pages.viewab.id};n.CpMain.prototype._hydraDataVersion="1.0";n.CpMain.prototype._connectedTo=null;n.CpMain.prototype._initialLoad=true;n.CpMain.prototype._platformCache=null;n.CpMain.prototype._jobSet=null;n.CpMain.prototype._currentPage="";n.CpMain.prototype._layout=null;n.CpMain.prototype._meId="";n.CpMain.prototype._resumedLocation=null;n.CpMain.prototype._resumedLocState=null;n.CpMain.prototype._resumedPageData=null;n.CpMain.prototype._activationUri="";n.CpMain.prototype._rootElem=null;n.CpMain.prototype._binder=null;n.CpMain.prototype._messageBar=null;n.CpMain.prototype._accountMessageBarPresenter=null;n.CpMain.prototype._authMessageBarPresenter=null;n.CpMain.prototype._easMessageBarPresenter=null;n.CpMain.prototype._proxyAuthenticator=null;n.CpMain.prototype._syncMessageBarPresenter=null;n.CpMain.prototype._docEventListener=null;n.CpMain.prototype._curVisibilityState="";n.CpMain.prototype._navigating=false;n.CpMain.prototype._disableReload=false;n.CpMain.prototype._reloadTimeStamp=new Date;n.CpMain.prototype._currentQuery="";n.CpMain.prototype._currentQueryLanguage="";n.CpMain.prototype._saveSearchQueryOnNav=false;n.CpMain.prototype.getHydraDataVersion=function(){return this._hydraDataVersion};n.CpMain.prototype.getPlatform=function(){return this._platformCache.getPlatform()};n.CpMain.prototype.getPlatformCache=function(){return this._platformCache};n.CpMain.prototype.trackStartup=function(){this._content.trackStartup()};n.CpMain.prototype.getJobSet=function(){return this._jobSet};s=["keypress","MSPointerUp","keyup","visibilitychange"];n.CpMain.prototype._onDocumentEvent=function(n){switch(n.type){case"keypress":this._onKeyPress(n);break;case"pointerup":case"MSPointerUp":this._onMsPointerUp(n);break;case"keyup":this._onKeyUp(n);break;case"visibilitychange":this._onVisibilityChanged()}};n.CpMain.prototype.deactivateUI=function(){var n,t;Jx.log.info("People.CpMain.deactivateUI");this._stopWatchingForDelete();this._onSuspend();n=Jx.app;n.removeListener("suspending",this._onSuspend,this);t=this._docEventListener;s.forEach(function(n){document.removeEventListener(n,t,false)});this._docEventListener=null;this.getLayout().removeLayoutChangedEventListener(this._onLayoutChanged,this);this._content.deactivate(true);Jx.Component.prototype.deactivateUI.call(this)};n.CpMain.prototype.shutdownComponent=function(){var n,t,i,r;this._nav.dispose();Jx.dispose(this._platformCache);this._platformCache=null;this._jobSet.dispose();this._jobSet=null;n=this._accountMessageBarPresenter;n&&n.shutdown();this._accountMessageBarPresenter=null;t=this._proxyAuthenticator;t&&t.shutdown();this._proxyAuthenticator=null;i=this._authMessageBarPresenter;i&&i.shutdown();this._authMessageBarPresenter=null;r=this._syncMessageBarPresenter;r&&r.shutdown();this._syncMessageBarPresenter=null;this._header=null;this._content=null;this._connectedTo=null;this._appbar=null;this._navbar=null;this._messageBar=null;Jx.Component.prototype.shutdownComponent.call(this)};n.CpMain.prototype.clearBackStack=function(){this._nav.clearBackStack();this._header.updateBackBtn()};n.CpMain.prototype.setBackStateOfTopItem=function(n){this._nav.setBackStateOfTopItem(n)};n.CpMain._setSessionData=function(n){return Jx.appData.localSettings().setObjectInSegments("LastSession",n)};n.CpMain._clearSessionData=function(){return Jx.appData.localSettings().setObjectInSegments("LastSession",{})};n.CpMain._getSessionData=function(){return Jx.appData.localSettings().getObjectInSegments("LastSession")};n.CpMain.prototype._onSuspend=function(){Jx.log.info("People.CpMain._onSuspend");var t={version:this.getHydraDataVersion(),location:this._nav.getLocation(),locState:this._content.getCurrentLocationState(),pageData:this._content.prepareSuspension(),backStack:this._nav.convertBackStackToObject()};n.CpMain._setSessionData(t)?Jx.log.pii("People.CpMain._onSuspend: saved session data: "+JSON.stringify(t)):Jx.log.error("People.CpMain._onSuspend: save session data failed: "+JSON.stringify(t));this._platformCache.suspend();this._recordTimeStamp()};n.CpMain.prototype._onResume=function(){Jx.log.info("People.CpMain._onResume");var t=n.CpMain._getSessionData();t&&(this.getHydraDataVersion()!==t.version||this._isExpired()||(this._resumedLocation=t.location,this._resumedLocState=t.locState,this._resumedPageData=t.pageData,t.backStack&&this._nav.rebuildBackStackFromObject(t.backStack)),Jx.log.pii("People.CpMain._onResume: lastSessionData: "+JSON.stringify(t)));this._initialNavigate()};n.CpMain.prototype._ensureSettings=function(){this._settings=new n.Settings(this.getPlatform(),this._jobSet);this.append(this._settings);this._settings.activateUI()};n.CpMain.prototype._recordTimeStamp=function(){var n=(new Date).toString();Jx.appData.localSettings().set("PeopleExpiration",n)};n.CpMain.prototype._isExpired=function(){var i=false,t=null,n,r;return t=Jx.appData.localSettings().get("PeopleExpiration"),Jx.isNullOrUndefined(t)||(n=new Date(t),n.setDate(n.getDate()+1),r=new Date,r>n&&(i=true)),i};n.CpMain.prototype._needReload=function(){var i=false,n=this._reloadTimeStamp,t,r;return Jx.isNullOrUndefined(n)||(t=n,t.setDate(n.getDate()+3),r=new Date,r>t&&(i=true)),i};n.CpMain.prototype._getResumedPageData=function(n){Jx.log.info("People.CpMain._getResumedPageData");var t=null,i=null;return Jx.isObject(this._resumedLocation)&&n===this._resumedLocation.page&&(t=this._resumedPageData,this._nav.isSameAsCurrentLocation(this._resumedLocation)&&(i=this._resumedLocState)),this._clearResumedData(),Jx.log.pii("People.CpMain._getResumedPageData: { data: "+JSON.stringify(t)+", locationState: "+JSON.stringify(i)+"}"),{data:t,locationState:i}};n.CpMain.prototype._clearResumedData=function(){Jx.log.info("People.CpMain._clearResumedData");this._resumedPageData=null;this._resumedLocState=null;this._resumedLocation=null};n.CpMain.prototype.getUI=function(n){n.html='<div class="app-frame-header" id="idPeopleAppHeader">'+Jx.getUI(this._header).html+'<\/div><div class="app-frame-body" id="idPeopleAppContent">'+Jx.getUI(this._content).html+'<\/div><div class="app-frame-connectedTo" id="idPeopleAppConnectedTo"><div class="connectedTo-container" id="connectedTo_container">'+Jx.getUI(this._connectedTo).html+"<\/div><\/div>"};n.CpMain.prototype.clearSearchBox=function(){var n=h();this._saveSearchQueryOnNav&&this._nav.getLocation().page===t.Pages.allcontacts.id?n.queryText=this._currentQuery:(n.queryText="",this._currentSearchState=i.inactive,this._searchLostFocus());this._saveSearchQueryOnNav=false};n.CpMain.prototype._searchHasFocus=function(){var n=document.getElementById("searchControlId"),t=document.getElementById("idPeopleBack");WinJS.Utilities.addClass(n,"dynamic-win-searchbox");t&&document.documentElement.offsetWidth<=w&&t.getAttribute("aria-hidden")==="false"&&(WinJS.Utilities.addClass(n,"dynamic-win-searchbox-with-back-button"),WinJS.Utilities.addClass(n.querySelector(".win-searchbox-flyout"),"dynamic-win-searchbox-flyout-with-back-button"));WinJS.Utilities.addClass(n.querySelector(".win-searchbox-input"),"dynamic-win-searchbox-input");document.documentElement.offsetWidth>=a&&WinJS.Utilities.addClass(n.querySelector(".win-searchbox-button"),"dynamic-win-searchbox-button");n.setAttribute("aria-expanded","true")};n.CpMain.prototype._searchLostFocus=function(){if(this._currentSearchState===i.inactive){var n=document.getElementById("searchControlId");WinJS.Utilities.removeClass(n,"dynamic-win-searchbox");WinJS.Utilities.removeClass(n,"dynamic-win-searchbox-with-back-button");WinJS.Utilities.removeClass(n.querySelector(".win-searchbox-flyout"),"dynamic-win-searchbox-flyout-with-back-button");WinJS.Utilities.removeClass(n.querySelector(".win-searchbox-input"),"dynamic-win-searchbox-input");document.documentElement.offsetWidth>=a&&WinJS.Utilities.removeClass(n.querySelector(".win-searchbox-button"),"dynamic-win-searchbox-button");n.setAttribute("aria-expanded","false")}};n.CpMain.prototype.performQuery=function(t,i){var f=this._nav.getLocation(),r,u;Jx.isNonEmptyString(i)||(i=Windows.Globalization.Language.currentInputMethodLanguageTag);f.page===n.Nav.Pages.allcontacts.id?(r=this._content.getControl(),this._jobSet.addUIJob(r,r._updateQuery,[t,i],n.Priority.appbar)):Jx.isNonEmptyString(t)&&(this._saveSearchQueryOnNav=true,u=People.Nav.getAllContactsSearchUri(t,i),People.Nav.navigate(u))};n.CpMain.prototype.reloadAllContactsPage=function(){var t=this._content.getControl();t&&this._jobSet.addUIJob(t,t._reload,null,n.Priority.appbar)};n.CpMain.prototype.searchBoxQuerySubmittedHandler=function(t){var i=this._nav.getLocation();i.page!=n.Nav.Pages.allcontacts.id&&this.performQuery(t.detail.queryText,t.detail.language)};n.CpMain.prototype.searchBoxResultSuggestionChosenHandler=function(t){t.detail.tag=="allResultsTag"?this.performQuery(this._currentQuery,this._currentQueryLanguage):n.Nav.navigate(t.detail.tag)};n.CpMain.prototype.searchBoxSuggestionsRequestedHandler=function(i){if(this._currentPage!=t.Pages.allcontacts.id&&Jx.isNonEmptyString(i.detail.queryText)){var u=this;i.detail.setPromise(new WinJS.Promise(function(t){Jx.isNonEmptyString(i.detail.language)||(i.detail.language=Windows.Globalization.Language.currentInputMethodLanguageTag);var f=new n.IndexedSearchCollection(u.getPlatform().peopleManager,i.detail.queryText,i.detail.language);f.addListener("load",function(u){var d=Include.replacePaths("ms-appx://$(imageResources)/ic-default-40.png"),g=new Windows.Foundation.Uri(d),nt=Windows.Storage.Streams.RandomAccessStreamReference.createFromUri(g),o=this.getPlatform().accountManager.getConnectedAccountsByScenario(r.ApplicationScenario.peopleSearch,r.ConnectedFilter.normal,r.AccountSort.name),e=25,l=false,v=false,c=o.count>0,tt=u.length>0,it=u.length,y,a,s,w,b,f,k,h;for(c&&(e-=o.count),it>(c?e-1:e)&&(e-=1,l=true),(c||l)&&(e-=1,e>0&&tt&&(v=true)),y=Math.min(u.length,e),Jx.log.info("New Search Suggestions added for query "+i.detail.queryText),f=0;f<y;f++)person=u.target.getItem(f),s=person.data.getUserTile(Microsoft.WindowsLive.Platform.UserTileSize.extraSmall,false),!Jx.isNullOrUndefined(s)&&Jx.isNonEmptyString(s.appdataURI)?(userTileUri=new Windows.Foundation.Uri(s.appdataURI),Jx.log.info("Search Suggestion URI: "+s.appdataURI+" used for user "+person.data.calculatedUIName),a=Windows.Storage.Streams.RandomAccessStreamReference.createFromUri(userTileUri)):(Jx.log.info("Search Suggestion weeble used for user "+person.data.calculatedUIName),a=nt),h=n.Nav.getViewPersonUri(person.data.objectId),i.detail.searchSuggestionCollection.appendResultSuggestion(person.data.calculatedUIName,"",h,a,person.data.calculatedUIName);if(v&&i.detail.searchSuggestionCollection.appendSearchSeparator(""),l){var rt=Include.replacePaths("ms-appx://$(imageResources)/searchviewall.png"),ut=new Windows.Foundation.Uri(rt),ft=Windows.Storage.Streams.RandomAccessStreamReference.createFromUri(ut),p=new Windows.Globalization.NumberFormatting.DecimalFormatter;p.fractionDigits=0;w=p.formatInt(u.totalCount);b=Jx.res.loadCompoundString("/strings/SearchBoxAllEntries",w);i.detail.searchSuggestionCollection.appendResultSuggestion(b,"","allResultsTag",ft,"")}if(c){var et=Include.replacePaths("ms-appx://$(imageResources)/searchgal.png"),ot=new Windows.Foundation.Uri(et),st=Windows.Storage.Streams.RandomAccessStreamReference.createFromUri(ot);for(f=0;f<o.count;f++)k=Jx.res.loadCompoundString("/strings/galSearchButtonText",o.item(f).displayName),h=People.Nav.getGALSearchUri(i.detail.queryText,o.item(f).emailAddress),i.detail.searchSuggestionCollection.appendResultSuggestion(k,"",h,st,"")}t()},u);f.load(u._jobSet)}))}};v=200;f=null;n.CpMain.prototype.searchTimeoutHandler=function(){this.performQuery(this._currentQuery,this._currentQueryLanguage)};n.CpMain.prototype.searchBoxQueryChangedHandler=function(n){this._currentQuery=n.detail.queryText;Jx.isNonEmptyString(n.detail.language)||(n.detail.language=Windows.Globalization.Language.currentInputMethodLanguageTag);this._currentQueryLanguage=n.detail.language;this._currentSearchState=Jx.isNonEmptyString(this._currentQuery)?i.active:i.inactive;this._currentPage==t.Pages.allcontacts.id&&(f&&clearTimeout(f),timeoutHandler=this.searchTimeoutHandler.bind(this),f=setTimeout(timeoutHandler,v))};n.CpMain.prototype.receivingFocusOnKeyboardInputHandler=function(){this._currentSearchState===i.inactive&&this._searchHasFocus()};n.CpMain.prototype.initUI=function(n){this._rootElem=n;Jx.addClass(n,"app-frame-grid");Jx.Component.prototype.initUI.apply(this,arguments);WinJS.UI.processAll();var t=h();t.addEventListener("focusout",this._searchLostFocus.bind(this),false);t.addEventListener("focusin",this._searchHasFocus.bind(this),false);t.addEventListener("querysubmitted",this.searchBoxQuerySubmittedHandler.bind(this),false);t.addEventListener("suggestionsrequested",this.searchBoxSuggestionsRequestedHandler.bind(this),false);t.addEventListener("resultsuggestionchosen",this.searchBoxResultSuggestionChosenHandler.bind(this),false);t.addEventListener("querychanged",this.searchBoxQueryChangedHandler.bind(this),this);t.addEventListener("receivingfocusonkeyboardinput",this.receivingFocusOnKeyboardInputHandler.bind(this),false);b().maxLength=500;window.addEventListener("focusin",this._focusChanged.bind(this),false)};n.CpMain.prototype._focusChanged=function(n){h().focusOnKeyboardInput=this._isTypeToSearchEnabled(n.target)};isElementOrDescendant=function(n,t){while(n&&n!==t)n=n.parentElement;return n===t};n.CpMain.prototype._isTypeToSearchEnabled=function(n){var i,t;if(!n)return!this._rootElem.disabled;if(n.tagName==="INPUT"&&["button","checkbox","radio"].indexOf(n.type.toLowerCase())===-1||n.tagName==="TEXTAREA"||n.isContentEditable)return false;for(i=document.getElementsByClassName("ra-shareCanvas"),t=0;t<i.length;t++)if(isElementOrDescendant(n,i.item(t)))return false;return!this._rootElem.disabled&&(n===document.body||n===document.documentElement)?true:isElementOrDescendant(n,this._rootElem)?true:false};n.CpMain.prototype.getRootElem=function(){return this._rootElem};n.CpMain.prototype._isEditPage=function(){var n=this._nav.getLocation();return Jx.isObject(n)&&Jx.isNonEmptyString(n.page)&&t.Pages[n.page].isEdit};n.CpMain.prototype._navBack=function(){this.canGoBack()&&this.back()};n.CpMain.prototype._onKeyPress=function(n){var t,i;if(n.key==="Esc"||n.key==="Backspace"){if(n.key==="Backspace"&&(t=n.srcElement?n.srcElement.tagName:null,t==="INPUT"||t==="TEXTAREA"))return;i=this._isEditPage();(n.key==="Esc"&&i||n.key==="Backspace"&&!i)&&this._navBack()}};n.CpMain.prototype._onMsPointerUp=function(n){n.button===3&&(this._isEditPage()||this._navBack())};n.CpMain.prototype._onKeyUp=function(n){var t=Jx.isRtl();(n.altKey&&(!t&&n.key==="Left"||t&&n.key==="Right")||n.key==="BrowserBack")&&(this._isEditPage()||this._navBack())};n.CpMain.prototype.activateUI=function(){var t,i,r;Jx.log.info("People.CpMain.activateUI");Jx.Component.prototype.activateUI.call(this);t=Jx.app;t.addListener("suspending",this._onSuspend,this);this._curVisibilityState=document.msVisibilityState;i=this._docEventListener=this._onDocumentEvent.bind(this);s.forEach(function(n){document.addEventListener(n,i,false)});this.getLayout().addLayoutChangedEventListener(this._onLayoutChanged,this);this._header.setParentContainer(document.getElementById("idPeopleAppHeader"));this._onResume();this._jobSet.addUIJob(this._navbar,this._navbar.initialize,null,n.Priority.appbar);this._jobSet.addUIJob(this,this._ensureMessageBar,null,n.Priority.messageBar);this._jobSet.addUIJob(this,this._ensureSettings,null,n.Priority.settingsPane);this._jobSet.addUIJob(this,function(){n.AppTile.subscribeNotifications(this.getPlatform());n.Social.unreadNotifications.initialize(this.getPlatform())},null,n.Priority.notifications);this._jobSet.addUIJob(this,function(){n.startBackgroundLoading(this._jobSet)},null,n.Priority.backgroundLoad);r="People.DialogEvents.closed";Jx.EventManager.addListener(this,r,function(){this._content&&this._content.setDefaultFocus()},this)};n.CpMain.prototype._onLayoutChanged=function(){this._connectedTo.disabled=this.getLayoutState()==="snapped"};n.CpMain.prototype._onVisibilityChanged=function(){this._curVisibilityState!==document.msVisibilityState&&(this._curVisibilityState=document.msVisibilityState,Jx.isNonEmptyString(this._activationUri)||(document.msVisibilityState==="visible"?(Jx.log.info("People.CpMain._onVisibilityChanged: changed to visible"),this._isExpired()&&(this.goHome(),window.msSetImmediate(function(){this.clearBackStack()}.bind(this))),n.CpMain._clearSessionData(),this._needReload()&&window.location.reload()):this._recordTimeStamp()))};n.CpMain.prototype.go=function(n){if(!this._navigating){var t=this._nav,i=t.getLocation(),r=this;msSetImmediate(function(){(Jx.isNullOrUndefined(i)||t.isSameAsCurrentLocation(i))&&(t.go(n),r.clearSearchBox())})}};n.CpMain.prototype.back=function(n){Jx.isNonEmptyString(n)&&this._nav.pushUriToBackStack(n);this._nav.back();this.clearSearchBox()};n.CpMain.prototype.canGoBack=function(){return this._nav.canGoBack()};n.CpMain.prototype.isSameAsCurrentLocation=function(n){return this._nav.isSameAsCurrentLocation(n)};n.CpMain.prototype.getLocation=function(){return this._nav.getLocation()};n.CpMain.prototype.getLayout=function(){return Jx.log.info("People.CpMain.getLayout"),this._layout||(this._layout=new n.Layout),this._layout};n.CpMain.prototype.getLayoutState=function(){return Jx.log.info("People.CpMain.getLayoutState"),this.getLayout().getLayoutState()};n.CpMain.prototype._initialNavigate=function(){Jx.log.info("People.CpMain._initialNavigate");var n=this._resumedLocation;Jx.isNonEmptyString(this._activationUri)?this._navigate(this._activationUri):this._nav.go(n?n:this.homeLocation)};n.CpMain.prototype.navToActivatedUri=function(n){this._activationUri=n;this._navigate(n)};c={connectaccount:function(t){if(Jx.isNonEmptyString(t.accountObjectId)){var i=Jx.isNonEmptyString(t.reconnect)?t.reconnect.toLowerCase()==="true":false,u=new n.Accounts.FlowLauncher(this.getPlatform(),r.ApplicationScenario.people,"share",this._jobSet);u.launchManageFlowByObjectId(t.accountObjectId,i)}}};n.CpMain.prototype._getNonNavigationAction=function(n){var i=/([^,]*),(.*)/g.exec(n),t=i?i.slice(1):[],r=t[0]&&t[0].toLowerCase(),u=c.hasOwnProperty(r)&&c[r];return u&&u.bind(this,Jx.parseHash(t[1]))};n.CpMain.prototype._navigate=function(i){Jx.log.info("People.CpMain._navToActivationUri");Jx.log.pii("activation uri = "+i);var u=this._getNonNavigationAction(i),r;Jx.isFunction(u)?(r="#",u()):r=n.CpMain.convertProtocolPathToHash(i)||i;t.navigate(r)};n.CpMain.prototype._logEtwActivationEnd=function(){Jx.mark("People:AppActivation,StopTA,People");this._logEtwActivationEnd=Jx.fnEmpty};n.CpMain.prototype._getMeId=function(){if(!this._meId)try{var n=this._platformCache.getDefaultMeContact();this._meId=n.objectId}catch(t){Jx.log.exception("People.CpMain._getMeId: failed to get ME contact.",t)}return this._meId};n.CpMain.prototype._fixHashValues=function(i){var r,u;if(Jx.log.info("People.CpMain._fixHashValues begin: page="+i.page+",id="+i.id),Jx.log.pii("People.CpMain._fixHashValues begin(cont):query="+i.query),r=t.Pages,i.page in r||(i.page=this.homepage),i.page===r.allcontacts.id&&i.query===undefined&&(i.query=null),i.page===t.Pages.viewperson.id&&i.verb&&i.verb==="Windows.ContactsProvider.AddContact"&&(r.viewperson.isEdit=true),i.page===this.homepage&&i.trigger==="back"&&i.data&&(u=this._parseJSONData(i.data),u.pos==="home"&&(u.pos=null,i.data=escape(JSON.stringify(u)))),t.Pages[i.page].requirePerson&&!t.Pages[i.page].requireMe&&i.page!==r.viewraitem.id&&i.id===this._getMeId()){i.id=null;switch(i.page){case r.viewperson.id:i.page=r.viewme.id;break;case r.viewprofile.id:i.page=r.viewmeprofile.id;break;case r.viewphoto.id:i.page=r.viewmephoto.id;break;case r.viewra.id:i.page=r.viewmera.id;break;case r.editprofile.id:Jx.log.error("Edit Me profile is not supported!");i.page=this.homepage;break;case r.linkperson.id:Jx.log.error("Link Me is not supported!");i.page=this.homepage}}Jx.isNonEmptyString(this._activationUri)&&(n.AppNav.markLocationAsDeepLinking(i),this._activationUri="");Jx.log.info("People.CpMain._fixHashValues end: page="+i.page+",id="+i.id);Jx.log.pii("People.CpMain._fixHashValues end(cont): query="+i.query)};n.CpMain.prototype.onBeforeNavigate=function(i){var r,f,u;Jx.log.info("People.CpMain.onBeforeNavigate");this._navigating||!this._content.deactivate()?i.cancel=true:(this._fixHashValues(i.location),this._nav.isSameAsCurrentLocation(i.location)?(i.cancel=true,i.location.trigger==="back"&&(this._nav.removeLastLocation(),t.backAsync())):(r=i.location,f=this.getLayout(),t.Pages[r.page].blockSnap&&f.getLayoutState()===n.Layout.layoutState.snapped&&r.trigger!=="back"?(i.cancel=true,f.unsnap()&&this.go(r)):(this._navigating=true,u=this,window.msSetImmediate(function(){n.AppNav.isLocationDeepLinking(r)&&u._nav.isLastLocationDeepLinking()&&(u._nav.removeLastLocation(),u._header.updateBackBtn(r.page))}))))};n.CpMain.prototype._addBiciOnNavigate=function(i){var r=-1;switch(i.page){case t.Pages.createcontact.id:r=n.Bici.createContact;break;case t.Pages.editmepicture.id:r=n.Bici.editMePicture;break;case t.Pages.linkperson.id:r=n.Bici.linkPerson;break;case t.Pages.viewmeprofile.id:r=n.Bici.viewMeProfile;break;case t.Pages.editprofile.id:r=n.Bici.editProfile;break;case t.Pages.viewme.id:r=n.Bici.mePage;break;case t.Pages.viewperson.id:r=n.Bici.landingPage;break;case t.Pages.viewab.id:r=n.Bici.allPage;break;case t.Pages.galsearchresults.id:r=n.Bici.galsearchresults}r!==-1&&Jx.bici.addToStream(InstruID.People.socialPageViewed,"",r)};n.CpMain.prototype.isNavigating=function(){return this._navigating};n.CpMain.prototype._setNavigationCompleted=function(){this._navigating=false;Jx.raiseEvent(this,this.navigationCompleted)};n.CpMain.prototype.onNavigate=function(t){Jx.log.info("People.CpMain.onNavigate");var i=t.location;i.page===this.homepage&&this._currentPage===this.homepage||(this._jobSet.addUIJob(this,this._addBiciOnNavigate,[i],n.Priority.bici),this._onNavigate(i))};n.CpMain.prototype._getPersonById=function(n){var t=this.getPlatform().peopleManager.tryLoadPerson(n);return Jx.isObject(t)&&t.objectType==="MeContact"&&(t=this._platformCache.getDefaultMeContact()),t};n.CpMain.prototype._onNavigate=function(i){var u=this._currentPage=i.page,h=i.data,f=this._parseJSONData(h),v=null,y=false,c,l,s,r;try{if(document.msFullscreenElement&&document.msExitFullscreen(),this._content.trackNavStart(u),this._stopWatchingForDelete(),this.getCommandBar().reset(),this.getFrameCommands().reset(),this._navbar.updateShowHide(),u===t.Pages.allcontacts.id||u===t.Pages.galsearchresults.id)i.query&&(c=i.query,this._saveSearchQueryOnNav=true,this._currentQuery=unescape(i.query),Jx.log.info("People.CpMain._onNavigate: page="+u),Jx.log.pii("People.CpMain._onNavigate(cont): query="+c+", data="+h)),v=c?unescape(c):null;else if(t.Pages[u].requirePerson){if(l=i.id,Jx.log.info("People.CpMain._onNavigate: page="+u+", id="+l),Jx.log.pii("People.CpMain._onNavigate(cont): data="+h),s=l?unescape(l):undefined,r=null,t.Pages[u].requireMe||s===this._getMeId())try{r=this._platformCache.getDefaultMeContact()}catch(a){Jx.log.exception("People.CpMain._onNavigate: failed to get ME contact.",a)}else if(s&&f&&f.extendedData)try{r=this._getPersonById(s);Jx.isObject(r)||(r=this._loadPersonFromParsedData(f))}catch(a){Jx.log.exception("People.CpMain._onNavigate: failed to load person with id "+s,a)}else if(s)try{r=this._getPersonById(s);Jx.isObject(r)||Jx.log.error("People.CpMain._onNavigate: failed to load person with id "+s)}catch(a){Jx.log.exception("People.CpMain._onNavigate: failed to load person with id "+s,a)}else f&&(f.name||f.email||f.extendedData)&&(r=this._loadPersonFromParsedData(f));Jx.isObject(r)&&r.linkedContacts.count!==0||(r=null,y=true);r&&this._startWatchingForDelete(r)}else Jx.log.info("People.CpMain._onNavigate: page="+u),Jx.log.pii("People.CpMain._onNavigate(cont): data="+h);[t.Pages.notification.id,t.Pages.viewme.id].indexOf(u)>=0&&n.AppTile.pushTiles(this.getPlatform());y?this._fallbackOnFail(i):(this._logEtwActivationEnd(),e("ControlLoad"),this._loadControl(u,v,r,f,i),o("ControlLoad"))}finally{this._content.trackNavEnd(u)}};n.CpMain.prototype._loadPersonFromParsedData=function(n){var r=null,i="",f=this.getPlatform().accountManager,u,t;try{n.extendedData&&n.extendedData.accountId?(i=n.extendedData.accountId,Jx.isNonEmptyString(i)&&(r=f.loadAccount(i))):(i=n.objectSourceId,Jx.isNonEmptyString(i)&&(r=f.getAccountBySourceId(i,"")))}catch(e){Jx.log.exception("People.CpMain._onNavigate: failed to load account "+i,e)}return u=this.getPlatform().peopleManager.createTemporaryPerson(r,{firstName:n.name||"",yomiFirstName:n.yomiName||"",emailAddress:n.email||"",thirdPartyObjectId:n.objectId||"",userTileUri:n.largeUserTile||n.userTile||""}),n.extendedData&&(t=u.linkedContacts.item(0),t.firstName=n.extendedData.firstName||"",t.lastName=n.extendedData.lastName||"",t.middleName=n.extendedData.middleName||"",t.title=n.extendedData.title||"",t.suffix=n.extendedData.suffix||"",t.yomiFirstName=n.extendedData.yomiFirstName||"",t.yomiLastName=n.extendedData.yomiLastName||"",t.notes=n.extendedData.notes||"",t.webSite=n.extendedData.webSite||"",t.significantOther=n.extendedData.significantOther||"",t.homePhoneNumber=n.extendedData.homePhoneNumber||"",t.home2PhoneNumber=n.extendedData.home2PhoneNumber||"",t.mobilePhoneNumber=n.extendedData.mobilePhoneNumber||"",t.mobile2PhoneNumber=n.extendedData.mobile2PhoneNumber||"",t.businessPhoneNumber=n.extendedData.businessPhoneNumber||"",t.business2PhoneNumber=n.extendedData.business2PhoneNumber||"",t.personalEmailAddress=n.extendedData.personalEmailAddress||"",t.businessEmailAddress=n.extendedData.businessEmailAddress||"",t.otherEmailAddress=n.extendedData.otherEmailAddress||"",t.companyName=n.extendedData.companyName||"",t.yomiCompanyName=n.extendedData.yomiCompanyName||"",t.officeLocation=n.extendedData.officeLocation||"",t.jobTitle=n.extendedData.jobTitle||"",n.extendedData.homeLocation&&(t.homeLocation=n.extendedData.homeLocation),n.extendedData.businessLocation&&(t.businessLocation=n.extendedData.businessLocation),n.extendedData.otherLocation&&(t.otherLocation=n.extendedData.otherLocation)),u};n.CpMain.prototype._fallbackOnFail=function(n){this._setNavigationCompleted();this._nav.fallbackOnFail(n)};n.CpMain.prototype._loadControl=function(i,r,u,f,e){var s,h,c,o;this._content.setupUpdate(i);this._header.setupUpdate(i);s=null;h=null;this._initialLoad&&(c=this._getResumedPageData(i),s=c.data,h=c.locationState);var v=r||u,y=this._content.update(i,v,f,s,e.state||h,e.trigger),l=this._header.update(i,u,this._content.getControl(),f),a=this._getConnectedToAnimationData(i);this._setMessageBarVisibility(i);this.getCommandBar().load(t.Pages[this._currentPage].stickyAppbar?true:false);this._scheduler.runVisibleJobsUntil(n.Priority.perfLowFidelity);o=this;y.done(function(n){o._initialLoad?(o._initialLoad=false,o._execEnterPageAnimation(l,a,n,0)):o._execExitEnterPageAnimation(l,a,n)},function(n){Jx.log.exception("CpContent loading",n);o._fallbackOnFail(e)});this._scheduler.setVisibleOnly(n.Priority.perfHighFidelity)};n.CpMain.prototype._getConnectedToAnimationData=function(n){var r=this._connectedTo.isPopulated(),i=document.getElementById("idPeopleAppConnectedTo"),u=r&&!Jx.hasClass(i,"hidden"),f=r&&t.Pages[n].showConnectedTo;return Jx.setClass(i,"hidden",!t.Pages[n].showConnectedTo),{entering:!u&&f?[i]:[],exiting:u&&!f?[i]:[]}};n.CpMain.prototype._execExitEnterPageAnimation=function(t,i,r){e("_execExitEnterPageAnimation:appFrameAnimation_exitPage");var f=this,u=function(n){return function(){o("_execExitEnterPageAnimation:appFrameAnimation_exitPage");l("_execExitEnterPageAnimation_"+n);f._setNavigationCompleted();y("onExitComplete",[t,i,r])}},s=t.exiting.concat(i.exiting,r.exiting);n.Animation.exitPage(s).done(u("completed"),u("error"));this._execEnterPageAnimation(t,i,r,80)};n.CpMain.prototype._execEnterPageAnimation=function(t,i,r,u){Jx.log.info("execEnterPageAnimation");e("_execEnterPageAnimation:appFrameAnimation_enterPage");var s=this,f=function(n){return function(){s._setNavigationCompleted();y("onEnterComplete",[t,i,r]);o("_execEnterPageAnimation:appFrameAnimation_enterPage");l("_execEnterPageAnimation_"+n)}},h=t.entering.concat(i.entering,r.entering);n.Animation.enterPage(h,null,u).done(f("completed"),f("error"))};n.CpMain.prototype._parseJSONData=function(n){var t=null;if(n)try{t=JSON.parse(unescape(n))}catch(i){Jx.log.exception("People.CpMain._parseJSONdata: failed parse '"+n+"'.",i)}return t};n.CpMain.prototype.getHeader=function(){return this._header};n.CpMain.prototype.getNavBar=function(){return this._navbar};n.CpMain.prototype.getCommandBar=function(){return this._appbar};n.CpMain.prototype.getFrameCommands=function(){return this.getHeader().getFrameCommands()};n.CpMain.prototype.getMessageBar=function(){return this._ensureMessageBar(false),this._messageBar};n.CpMain.prototype._ensureMessageBar=function(n){var i,f,t,e,o,s,h,r;this._messageBar||($include("$(messageBarResources)/css/messagebar.css"),i=this._messageBar=new Chat.MessageBar(10),f=Jx.appData.localSettings().get("LiveDemoMode")||false,f||(t=this.getPlatform(),e=this._accountMessageBarPresenter=new Chat.AccountMessageBarPresenter,e.init(i,t,u.people,"ab-messageBar"),o=this._authMessageBarPresenter=new Chat.AuthMessageBarPresenter,o.init(i,t,"ab-messageBar"),s=this._syncMessageBarPresenter=new Chat.SyncMessageBarPresenter,s.init(i,t,u.people,"ab-messageBar"),h=this._proxyAuthenticator=new Chat.ProxyAuthenticator,h.init(t,u.mail)),r=this._currentPage,n&&Jx.isNonEmptyString(r)&&this._setMessageBarVisibility(r))};n.CpMain.prototype.hideMessageBar=function(){var n=this._messageBar;n&&n.hide()};n.CpMain.prototype.unhideMessageBar=function(){this._setMessageBarVisibility(this._currentPage)};n.CpMain.prototype._setMessageBarVisibility=function(n){var i=this._messageBar;i&&(t.Pages[n].showMessageBar?i.unhide():i.hide())};n.CpMain.prototype.hasNavbar=function(){var n=false;return this._currentPage&&(n=t.Pages[this._currentPage].blockNavbar?false:true),n};n.CpMain.prototype.hideAppBar=function(){this._appbar.hideAppBar()};n.CpMain.prototype.hideNavBar=function(){this._navbar.hideNavBar()};n.CpMain.prototype.canGoHome=function(){return t.Pages[this._currentPage].stickyAppbar?false:true};n.CpMain.prototype.goHome=function(){var i=this._nav.getLocation(),n;i.page===this.homepage?(n=this._content.getAddressBookControl(),n.goHome(),this._content.setDefaultFocus()):t.navigate(t.getViewAddressBookUri({pos:"home"}))};n.CpMain.prototype.navToPageOrScroll=function(n){var i=this._nav.getLocation();i.page===n?(this._content.scrollToBeginning(),this._content.setDefaultFocus()):t.navigate(t.getUri(n,"",null))};n.CpMain.convertProtocolPathToHash=function(i){var r,u,f;return Jx.log.pii("People.CpMain.convertProtocolPathToHash: protocol path="+i),r=null,Jx.debug&&(u=i.split(",",1),f=unescape(u[0]).toLowerCase(),f==="reset"&&(n.CpMain.reset(),r=t.getViewAddressBookUri(null))),r||(r=t.convertProtocolPathToHash(i)),Jx.log.pii("People.CpMain.convertProtocolPathToHash: uri hash="+r),r};n.CpMain.reset=function(){Jx.log.info("People.CpMain.reset");n.CpMain._clearSessionData();n.CpContent.clearControlState()};n.CpMain.prototype._startWatchingForDelete=function(t){var i=this._binder=new n.PlatformObjectBinder(t),r=this._person=i.createAccessor(this._personUpdated.bind(this));p(r)&&this._stopWatchingForDelete()};n.CpMain.prototype._personUpdated=function(){p(this._person)&&(this._stopWatchingForDelete(),this._nav.canGoBack()?this._nav.back():this._nav.go())};n.CpMain.prototype._stopWatchingForDelete=function(){Jx.dispose(this._binder);this._binder=null;this._person=null};n.CpMain.prototype.zoomChanged=function(n){Jx.setClass(this.getRootElem(),"inZoomedOutView",n);n?this.hideMessageBar():this.unhideMessageBar()}})