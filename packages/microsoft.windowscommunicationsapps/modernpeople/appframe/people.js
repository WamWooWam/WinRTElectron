(function(){var n=window.People,i=Windows.ApplicationModel.Activation,u,r,t;n.errorOccurred=false;n.inPeopleApp=true;u=true;r=true;window.addEventListener("DOMContentLoaded",function(){Jx.mark("People:AppInit,StartTA,People");Jx.app=new n.App(window.initialPlatformResult);window.initialPlatformResult=null;document.title=Jx.res.getString("/strings/peopleAppName");Jx.mark("People:AppInit,StopTA,People")},false);window.addEventListener("beforeunload",function(){n.errorOccurred||(Jx.log.info("beforeunload called."),Jx.app.shutdownUI(),Jx.app.shutdown())},false);window.addEventListener("error",function(t){Jx.log&&(Jx.log.info("People.errorOccurred set to true."),Jx.log.error("Unhandled exception: "+t.message+"\n  file: "+t.filename+"\n  line: "+t.lineno+"\n  column: "+t.colno),Jx.app.shutdownLog());n.errorOccurred=true},false);t=n.App=function(t){var i,r;if(Jx.Application.call(this,Jx.AppId.people,true),Jx.root){this._settings=new n.Settings;return}this._root=null;this._scheduler=new n.Scheduler;this._schedulerVisibility=new n.SchedulerVisibility;this._jobSet=this._scheduler.getJobSet();this._platform=t.client;this._hrPlatform=t.hr;this._restartneededEventListener=null;this._pendingActivation=null;this._activationKind=-1;this._settings=null;i=Jx.activation;i.addListener(i.activated,this._activated,this);i.addListener(i.navigated,this._navigated,this);i.addListener(i.suspending,this._suspend,this);i.addListener(i.resuming,this._resume,this);r=Windows.ApplicationModel.DataTransfer.DataTransferManager.getForCurrentView();r.addEventListener("datarequested",this._shareSourceDataRequested.bind(this))};Jx.inherit(t,Jx.Application);Jx.augment(t,Jx.Events);t.prototype.shutdown=function(){if(this._scheduler){this._restartneededEventListener&&(this._platform.removeEventListener("restartneeded",this._restartneededEventListener),this._restartneededEventListener=null);var n=Jx.activation;n.removeListener(n.activated,this._activated,this);n.removeListener(n.navigated,this._navigated,this);n.removeListener(n.suspending,this._suspend,this);n.removeListener(n.resuming,this._resume,this);Jx.dispose(this._jobSet);this._jobSet=null}Jx.Application.prototype.shutdown.call(this);Jx.dispose(this._platform);this._platform=null};t.prototype._activated=function(t){this._platform!==null?this._handleActivation(t):this._pendingActivation||this._activationKind!==-1||(this._pendingActivation=t,this._ensurePlatform(),this._settings=new n.Settings)};t.prototype._handleActivation=function(t){var e,o,s,f;t=t||this._pendingActivation;this._pendingActivation=null;this._activationKind=t.kind;this._settings&&(this._settings.shutdownComponent(),this._settings=null);e=i.ActivationKind;o=null;t.kind===e.contactPicker?(o=new n.PeopleProvider(t,this._platform,this._scheduler),this._root=Jx.root=o,this._showUI()):t.kind===e.shareTarget?(u=false,o=new n.ShareTarget.ShareRoot(t,this._platform,this._scheduler),this._root=Jx.root=o,this._showUI()):(s=this,f=function(u){s._root?Jx.isNonEmptyString(u)&&s._root.navToActivatedUri(u):((t.previousExecutionState===i.ApplicationExecutionState.notRunning||t.previousExecutionState===i.ApplicationExecutionState.closedByUser)&&n.CpMain.reset(),r=r&&u==="",o=new n.CpMain(s._platform,s._scheduler,u),s._root=Jx.root=o,s._showUI())},t.kind===e.launch?t.verb?this._getActionActivationUriAsync(t).done(function(n){f(n)},function(){f("")}):f(this._getTileActivationUri(t)):t.kind===e.protocol?f(this._getProtocolActivationUri(t)):t.kind===e.search?f(this._getSearchActivationUri(t)):t.kind===e.contact&&(t.verb===Windows.ApplicationModel.Contacts.ContactLaunchActionVerbs.post?f(this._getPostActionActivationUri(t)):f("")))};t.prototype._showUI=function(){Jx.mark("People:AppActivation,StartTA,People");var t=this._platform;this.initUI(document.getElementById("idRoot"));r&&this._root.trackStartup();u&&this._jobSet.addUIJob(null,function(){n.Accounts.checkForEasiId(t,Microsoft.WindowsLive.Platform.ApplicationScenario.people)},null,n.Priority.firstRun);this._jobSet.addUIJob(this,function(){n.Accounts.ensureNetworkOnFirstRun(t)},null,n.Priority.firstRun);this._jobSet.addUIJob(this,this._beginReplication,null,n.Priority.replication);Jx.launch&&this._jobSet.addUIJob(Jx.launch,Jx.launch.startDeferredTasks,[t],n.Priority.launch);this._scheduler.runVisibleJobsUntil(n.Priority.perfLowFidelity)};t.prototype._getTileActivationUri=function(t){var i,u,f;if(Jx.isNonEmptyString(t.arguments)&&t.tileId!=="Microsoft.WindowsLive.People"){i=null;try{i=this._platform.peopleManager.tryLoadPersonByTileId(t.arguments)}catch(r){Jx.log.exception("People.App._getTileActivationUri: failed to load person by tile Id.",r)}if(u=t.tileId,i){try{Windows.UI.Notifications.TileUpdateManager.createTileUpdaterForSecondaryTile(u).clear()}catch(r){if(r.number===-2143420158)Jx.log.exception("People.App._getTileActivationUri: failed to clear tile updater for secondary tile.",r);else throw r}return n.Nav.getViewPersonUri(i.objectId)}f=this;this._jobSet.addUIJob(null,function(){n.Pinning.tileLaunchError(f._platform,u)},null,n.Priority.tileError)}return""};t.prototype._getActionActivationUriAsync=function(t){var i=this;return new WinJS.Promise(function(r,u){t.verb==="Windows.ContactsProvider.ShowContact"?i._extractContactDataAsync(t.contact).then(function(i){r(n.Nav.getViewPersonUri(t.contact.id,i,t.verb))}):t.verb==="Windows.ContactsProvider.AddContact"?i._extractContactDataAsync(t.contact).then(function(i){r(n.Nav.getViewPersonUri("",i,t.verb))}):u()})};t.prototype._getProtocolActivationUri=function(t){var i=t.uri,u,f,e;if(i.schemeName==="wlpeople"){var s=i.path,h=s.replace(/\s*$/,""),o=/([^,]*)(?:,([^,]*)(?:,(.*))?)?/g.exec(h),r=o?o.slice(1):[],c=unescape(r[0]||"").toLowerCase();if(c==="search"){if(u="allcontacts",r.length>2)for(u+=",",f=1;f<r.length;f++)u+=r[f]+",";return u}return i.path}return i.schemeName==="ms-accountpictureprovider"?n.Nav.getEditMePictureUri():(e=n.Protocol.fromUri(i).toPerson(this._platform),e?n.Nav.getViewPersonUri(e.objectId):"")};t.prototype._getSearchActivationUri=function(t){var i=t.queryText.trim();return Jx.isNonEmptyString(i)?n.Nav.getAllContactsSearchUri(i,t.language):""};t.prototype._getPostActionActivationUri=function(t){var i=n.Protocol.createFromPostInfo(t.serviceId,t.serviceUserId),r=i.toPerson(this._platform),u;return r?(u={isPostScenario:true,postNetworkSelection:i.contact.sourceId},n.Nav.getViewPersonUri(r.objectId,u)):""};t.prototype._navigated=function(){this._activated({kind:i.ActivationKind.launch,previousExecutionState:i.ApplicationExecutionState.terminated})};t.prototype._suspend=function(){if(this.raiseEvent("suspending"),this._platform)try{this._platform.suspend()}catch(n){if(n.number!==-2147023174)throw n}};t.prototype._resume=function(){this._platform&&this._platform.resume();Jx.ptStopResume(Jx.TimePoint.responsive)};t.prototype._ensurePlatform=function(){r=false;n.Accounts.showLogonErrorDialog(this._retryPlatformCreation.bind(this),function(){this._handleActivation()}.bind(this),this._hrPlatform)};t.prototype._retryPlatformCreation=function(n){var t=window.createPlatform(),i=this._platform=t.client;return this._hrPlatform=t.hr,n&&n(t.hr),i!==null};t.prototype._beginReplication=function(){var t=this._platform,i=this._restartneededEventListener=this._onRestartNeeded.bind(this);t.addEventListener("restartneeded",i);t.requestDelayedResources();Jx.forceSync(t,Microsoft.WindowsLive.Platform.ApplicationScenario.people);n.AppTile.enableTilePush(t)};t.prototype._shareSourceDataRequested=function(t){var r=n.ShareSource,i=new r.DataRequestedEventArgs(t);this.raiseEvent("sharesourcedatarequested",i);i.handled||t.request.failWithDisplayText(Jx.res.getString("/strings/shareFailGeneric"))};t.prototype._onRestartNeeded=function(){Jx.log.warning("Restarting due to connected account change");this._activationKind!==i.ActivationKind.contactPicker&&this._activationKind!==i.ActivationKind.shareTarget&&n.Accounts.showMustSignInDialog(function(){location.reload()},true)};var f=0,e=1,o=2,s=3,h=0,c=1,l=2,a=0,v=1,y=2;t.prototype._extractContactDataAsync=function(n){return new WinJS.Promise(function(t){var i={firstName:n.firstName||"",lastName:n.lastName||"",middleName:n.middleName||"",title:n.honorificNamePrefix||"",suffix:n.honorificNameSuffix||"",yomiFirstName:n.yomiGivenName||"",yomiLastName:n.yomiFamilyName||"",notes:n.notes||""},p,tt,w,it,rt,r,b;if(n.providerProperties&&n.providerProperties.augmented&&(i.accountId=n.providerProperties.accountId),n.phones&&n.phones.size>0){var k=0,d=0,g=0,nt=[],u={businessPhoneNumber:true,business2PhoneNumber:true,mobilePhoneNumber:true,mobile2PhoneNumber:true,homePhoneNumber:true,home2PhoneNumber:true};n.phones.forEach(function(n){var t;n.kind===f&&k<2?(t=k===0?"homePhoneNumber":"home2PhoneNumber",i[t]=n.number,u[t]=false,k++):n.kind===e&&d<2?(t=d===0?"mobilePhoneNumber":"mobile2PhoneNumber",i[t]=n.number,u[t]=false,d++):n.kind===o&&g<2?(t=g===0?"businessPhoneNumber":"business2PhoneNumber",i[t]=n.number,u[t]=false,g++):n.kind===s&&nt.push(n.number)});p=0;for(tt in u){if(p===nt.length)break;u[tt]&&(i[tt]=nt[p],p++)}}if(n.emails&&n.emails.size>0){var ut=false,ft=false,et=false;n.emails.forEach(function(n){n.kind!==h||ut?n.kind!==c||ft?n.kind!==l||et||(i.otherEmailAddress=n.address,et=true):(i.businessEmailAddress=n.address,ft=true):(i.personalEmailAddress=n.address,ut=true)})}n.significantOthers&&n.significantOthers.size>0&&(i.significantOther=n.significantOthers[0].name);n.websites&&n.websites.size>0&&(i.webSite=n.websites[0].uri.absoluteCanonicalUri);w=false;n.addresses&&n.addresses.size>0&&(it=false,rt=false,n.addresses.forEach(function(n){var t={street:n.streetAddress||"",city:n.locality||"",state:n.region||"",zipCode:n.postalCode||"",country:n.country||""};n.kind!==a||it?n.kind!==v||w?n.kind!==y||rt||(i.otherLocation=t,rt=true):(i.businessLocation=t,w=true):(i.homeLocation=t,it=true)}));n.jobInfo&&n.jobInfo.size>0&&(r=n.jobInfo[0],i.companyName=r.companyName,i.yomiCompanyName=r.companyYomiName,i.officeLocation=r.office,i.jobTitle=r.title,w||(i.businessLocation={street:r.companyAddress||"",city:"",state:"",zipCode:"",country:""}));b=function(){t({objectType:"literal",name:n.displayName,yomiName:n.calculatedYomiName,extendedData:i})};n.thumbnail?n.thumbnail.openReadAsync().then(function(n){i.url=URL.createObjectURL(n);b()},function(){b()}):b()})}})()