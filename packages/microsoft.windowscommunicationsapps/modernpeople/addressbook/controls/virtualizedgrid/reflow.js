Jx.delayDefine(People.Grid,"Reflow",function(){function h(n){n.style.opacity=""}function v(n){n.sort(function(n,t){var i=n.offset.top,r=t.offset.top;return i===r?n.offset.left-t.offset.left:i-r});var t=n[0].offset,i={elements:[],offset:t},r=[i];return n.forEach(function(n){var u=n.offset;t.top===u.top&&t.left===u.left?i.elements.push(n.element):(t=u,i={elements:[n.element],offset:u},r.push(i))}),f.executeElementsAnimation(r.map(function(n){return{elements:n.elements,animations:f.createOffsetAnimationArray(n.offset)}}))}function y(n){var t=n.cloneNode(true);return t.id="",t}function e(n){n.getElement()&&(n.hide(),n.returnToPool())}function r(n,t,r){var u=i[t];n[i[t]]=u===t?r:-r}function c(n){var t=n.offset}var l=window.People,o=l.Grid,t=o.Cell,p=WinJS.Utilities,w=WinJS.UI,f=o.Animations,a=People.Animation,s=WinJS.Promise,n=o.Reflow=function(n,t){this._grid=t;this._layout=n;this._canvas=n.getCanvas();this._scrollableAttr=n.getScrollableAttr();this._orthogonalAttr=n.getOrthogonalAttr();a.disabled&&(this.reflow=this._unanimatedReflow);this._animating=false;this._timeoutId=-1;this._boundTimeoutComplete=this._onTimeoutComplete.bind(this)},i,u;n.prototype.unanimatedReflow=function(n,i,r,u){n.forEach(e);u.forEach(e);i.forEach(t.position);r.forEach(t.position)};n.prototype._unanimatedReflow=function(n,t,i,r){this.unanimatedReflow(n,t,i,r);this._completeAnimation()};n.prototype._onRemoveErr=function(n,t,i,r){n.forEach(function(n){h(n.getElement())});this.reflow=this._unanimatedReflow;this.reflow(n,t,i,r)};n.prototype._onMoveErr=function(n,t,i){this.reflow=this._unanimatedReflow;this.reflow([],n,t,i)};n.prototype._onAddErr=function(n,t){this.reflow=this._unanimatedReflow;this.reflow([],[],n,t)};i={};i.left="left";i.right="left";i.top="top";n.prototype._addGridOffset=function(n,t,i,u,f){var c=n.priorGridIndex,o,s,h,e,l;return c!==-1&&(o=this._layout.calculateColumn(c))!==(s=this._layout.calculateColumn(n.gridIndex))?(h=this._layout.getOrthogonalExtent(),e={},l=o>s?h+u:u-h,r(e,this._scrollableAttr,0),r(e,this._orthogonalAttr,l-u),f.moves.push({element:t,offset:e}),{priorColumn:o,newColumn:s}):(this._addListOffset(n,t,i,u,f),null)};n.prototype._addSnakingOffset=function(n,t,i,u){var f=this._layout.getOrthogonalExtent(),e=t>i?n.orthogonalPos-f:f+n.orthogonalPos;return r(u,this._scrollableAttr,0),r(u,this._orthogonalAttr,n.orthogonalPos-e),e};n.prototype._addUnclonedOffset=function(n,t,i,r,u){var e=n.priorGridIndex,o,s,f;e!==-1&&(o=this._layout.calculateColumn(e))!==(s=this._layout.calculateColumn(n.gridIndex))&&(f={},this._addSnakingOffset(n,o,s,f),u.moves.push({element:t,offset:f}))};n.prototype._addClonedOffset=function(n,t,i,r,u){var e=this._addGridOffset(n,t,i,r,u);if(e!==null){var c=this._layout.getOrthogonalExtent(),f=y(t),o=f.style,s={},h=this._addSnakingOffset(n,e.priorColumn,e.newColumn,s);this._canvas.appendChild(f);o[this._scrollableAttr]=n.scrollablePos.toString()+"px";o[this._orthogonalAttr]=h.toString()+"px";u.clones.push(f);u.moves.push({element:f,offset:s})}};n.prototype._addListOffset=function(n,t,i,u,f){var e={};r(e,this._scrollableAttr,n.scrollablePos-i);r(e,this._orthogonalAttr,n.orthogonalPos-u);f.moves.push({element:t,offset:e});c(f.moves[f.moves.length-1])};n.prototype.reflow=function(n,t,i,r){this._animatedReflow(n,t,i,r)};u=function(n,i,r,u,f){this._reflow=n;this._addOffset=i;this._layout=r;this._moveData=u;this._gridIndices=f.map(t.getGridIndex);this._cells=f};u.prototype._processMove=function(n,t){var i=this._layout,r;if(n.gridIndex===this._gridIndices[t]&&(r=n.getElement(),r)){var u=r.style,f=n.gridIndex,s=n.priorGridIndex,e=i.calculateScrollPos(f),o=i.calculateOrthogonal(i.calculateRow(f));this._addOffset.call(this._reflow,n,r,e,o,this._moveData);i.setOrthogonalPos(n,o,u);i.setScrollablePos(n,e,u)}};u.prototype.processMoves=function(){this._cells.forEach(this._processMove,this)};n.prototype._animatedReflow=function(n,i,r,o){var w;this._animating=true;var b=this._layout.getRows()===1?this._addListOffset:this._addClonedOffset,k=this._layout.getRows()===1?this._addListOffset:this._addUnclonedOffset,y=n.map(t.getElement),p=this._layout,a=this,tt=this._scrollableAttr,it=this._orthogonalAttr,l={clones:[],moves:[]},d=new u(this,b,p,l,i),g=new u(this,k,p,l,o),rt=o.map(t.getGridIndex),nt=r.map(t.getGridIndex);y.forEach(function(n){n.style.opacity="0"});w=n.length>0?f.deleteFromList(y):s.wrap();w.done(function(){n.forEach(e);y.forEach(h);d.processMoves();g.processMoves();var u=l.moves.length>0?v(l.moves):s.wrap(),t=p.getCanvas();u.done(function(){for(var i,n=0;n<l.clones.length;n++)try{t.removeChild(l.clones[n])}catch(u){if(u.name!=="NotFoundError")throw u}o.forEach(e);i=[];r.forEach(function(n,t){var r;n.gridIndex!==nt[t]||Jx.isNullOrUndefined(r=n.getElement())||(i.push(r),n.position())});i.length>0?f.addToList(i).done(function(){a._completeAnimation()},function(){Jx.log.info("add animation failed.  Switching to unanimatedReflow");a._onAddErr(r,o)}):a._completeAnimation()},function(){Jx.log.info("move animation failed.  Switching to unanimatedReflow");l.clones.forEach(t.removeChild,t);a._onMoveErr(i,r,o)})},function(){Jx.log.info("removal animation failed.  Switching to unanimatedReflow");a._onRemoveErr(n,i,r,o)})};n.prototype._onTimeoutComplete=function(){this._animating=false;this._timeoutId=-1;this._grid.onAnimationComplete()};n.prototype._completeAnimation=function(){this._timeoutId=setTimeout(this._boundTimeoutComplete,4e3)};n.prototype.resetAnimationTimeout=function(){if(this._timeoutId!==-1)clearTimeout(this._timeoutId),this._onTimeoutComplete();else if(this._animating){var n=this._completeAnimation;this._completeAnimation=function(){this._completeAnimation=n;this._onTimeoutComplete()}}}})