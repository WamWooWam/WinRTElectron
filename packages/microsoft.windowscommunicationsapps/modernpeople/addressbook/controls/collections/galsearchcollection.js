Jx.delayDefine(People,"GALSearchCollection",function(){"use strict";var n=People,t=Microsoft.WindowsLive.Platform;n.GALSearchCollection=function(t,i,r){n.Collection.call(this,"search:"+i);this._query=i;this._accountEmail=r;this._peopleManager=t.peopleManager;this._collection=null;this._listener=this._collectionChanged.bind(this);this._pendingChanges=[];this._reportedPending=false;this._jobSet=null;this._searchTimer=0;this._searchTimerFired=false;this._platform=t};Jx.inherit(n.GALSearchCollection,n.Collection);Object.defineProperty(n.GALSearchCollection.prototype,"totalCount",{get:function(){return this._collection.count}});n.GALSearchCollection.prototype.dispose=function(){this._collection&&(this._collection.removeEventListener("collectionchanged",this._listener),this._collection.dispose());this._clearTimer()};n.GALSearchCollection.prototype.getItem=function(n){return{type:"person",data:this._collection.item(n)}};n.GALSearchCollection.prototype.load=function(t){this._jobSet=t;t.addUIJob(this,this._runQuery,null,n.Priority.query)};n.GALSearchCollection.prototype.acceptPendingChanges=function(){var n=this._pendingChanges;return this.length=this._collection.count,this._pendingChanges=[],this._reportedPending=false,this.raiseEvent("changesApplied",{target:this,changes:n}),this.raiseEvent("updateHeader",{target:this,length:this.length,error:false,searching:false}),n};n.GALSearchCollection.prototype.hydrate=Jx.fnEmpty;n.GALSearchCollection.prototype.dehydrate=Jx.fnEmpty;n.GALSearchCollection.prototype._runQuery=function(){var n,r,i,u;if(n=this._platform.accountManager.getConnectedAccountsByScenario(t.ApplicationScenario.peopleSearch,t.ConnectedFilter.normal,t.AccountSort.name),n.count>0){if(i=null,Jx.isNonEmptyString(this._accountEmail))for(r=0;r<n.count;r++)if(n.item(r).emailAddress===this._accountEmail){i=n.item(r);break}i==null&&(i=n.item(0));u=this._collection=this._peopleManager.searchServer(this._query,50,i,0);u.addEventListener("collectionchanged",this._listener);u.unlock();this._markLoaded();this.raiseEvent("updateHeader",{target:this,error:false,searching:true})}};n.GALSearchCollection.prototype._collectionChanged=function(n){var t=n.eType;t===Microsoft.WindowsLive.Platform.CollectionChangeType.serverSearchComplete&&(n.index===1?this._collection.count>0&&!this._reportedPending?(this._reportedPending=true,this._pendingChanges.push(n),this.raiseEvent("changesPending",{target:this})):this.raiseEvent("updateHeader",{target:this,length:0,error:false,searching:false}):(Jx.log.info("Server failure "+n.index+" trying to get search results for "+this._accountEmail),this.raiseEvent("updateHeader",{target:this,length:0,error:true,searching:false})))};n.GALSearchCollection.prototype._markLoaded=function(){this.length=this._collection.count;this.isLoaded=true;this.raiseEvent("load",{target:this,length:this.length,totalCount:this.length})};n.GALSearchCollection.prototype._onTimer=function(){Jx.log.warning("Search hasn't completed in the time allowed. Timer fired to finish the search.");this._searchTimerFired=true};n.GALSearchCollection.prototype._clearTimer=function(){this._searchTimer&&(window.clearTimeout(this._searchTimer),this._searchTimer=0)}})