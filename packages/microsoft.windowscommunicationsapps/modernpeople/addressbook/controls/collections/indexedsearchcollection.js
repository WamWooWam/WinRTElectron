Jx.delayDefine(People,"IndexedSearchCollection",function(){"use strict";var n=People,i=Microsoft.WindowsLive.Platform,t=50;n.IndexedSearchCollection=function(t,i,r){n.Collection.call(this,"search:"+i);this._query=i;this._locale=r;this._peopleManager=t;this._collection=null;this._listener=this._collectionChanged.bind(this);this._pendingChanges=[];this._reportedPending=false;this._jobSet=null;this._searchTimer=0;this._searchTimerFired=false};Jx.inherit(n.IndexedSearchCollection,n.Collection);Object.defineProperty(n.IndexedSearchCollection.prototype,"totalCount",{get:function(){return this._searchTimerFired?this._collection.count:this._collection.totalCount}});n.IndexedSearchCollection.prototype.dispose=function(){this._collection&&(this._collection.removeEventListener("collectionchanged",this._listener),this._collection.dispose());this._clearTimer()};n.IndexedSearchCollection.prototype.getItem=function(n){return{type:"person",data:this._collection.item(n)}};n.IndexedSearchCollection.prototype.load=function(t){this._jobSet=t;t.addUIJob(this,this._runQuery,null,n.Priority.query)};n.IndexedSearchCollection.prototype.acceptPendingChanges=function(){var n=this._pendingChanges;return this.length=this._collection.count,this._pendingChanges=[],this._reportedPending=false,this.raiseEvent("changesApplied",{target:this,changes:n}),n};n.IndexedSearchCollection.prototype.hydrate=Jx.fnEmpty;n.IndexedSearchCollection.prototype.dehydrate=Jx.fnEmpty;n.IndexedSearchCollection.prototype._runQuery=function(){var n=this._collection=this._peopleManager.search(i.PeopleSearchType.searchCharm,this._query,this._locale,t);n.addEventListener("collectionchanged",this._listener);n.unlock();this._searchTimer=window.setTimeout(this._onTimer.bind(this),5e3)};n.IndexedSearchCollection.prototype._collectionChanged=function(r){var f=i.CollectionChangeType,u=this._collection;r.eType===f.localSearchComplete?u.totalCount>0?u.fetchMoreItems(t):this._markLoaded():r.eType===f.itemAdded?this._pendingChanges.push(r):r.eType===f.batchEnd&&(this.isLoaded?this._reportedPending||(this._reportedPending=true,this.raiseEvent("changesPending",{target:this})):(this._pendingChanges=[],this._markLoaded()),u.count<u.totalCount&&this._jobSet.addUIJob(u,u.fetchMoreItems,[t],n.Priority.query))};n.IndexedSearchCollection.prototype._markLoaded=function(){var n,i;this._clearTimer();n=0;try{n=this._collection.count}catch(t){if(t.number!==-2147483638)throw t}this.length=n;this.isLoaded=true;i=n;try{i=this._collection.totalCount}catch(t){if(t.number!==-2147483638)throw t}this.raiseEvent("load",{target:this,length:this.length,totalCount:i})};n.IndexedSearchCollection.prototype._onTimer=function(){Jx.log.warning("Search hasn't completed in the time allowed. Timer fired to finish the search.");this._searchTimerFired=true;this._markLoaded()};n.IndexedSearchCollection.prototype._clearTimer=function(){this._searchTimer&&(window.clearTimeout(this._searchTimer),this._searchTimer=0)}})