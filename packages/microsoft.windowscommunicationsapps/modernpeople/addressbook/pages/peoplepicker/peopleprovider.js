Jx.delayDefine(People,"PeopleProvider",function(){var i=window.People,r=i.Sequence,n=Windows.ApplicationModel.Contacts,u=Microsoft.WindowsLive.Platform,t=i.PeopleProvider=function(r,u,f){$include("$(cssResources)/AddressBook.css");$include("$(cssResources)/PeoplePicker.css");this.name="PeopleProvider";this._root=null;this._rootElem=null;this._platform=u;this._scheduler=f;this._jobSet=f.getJobSet().createChild();this._jobSet.setOrder(0);this._zoomedOutJobSet=f.getJobSet().createChild();this._zoomedOutJobSet.setOrder(1);this._basket=r.contactPickerUI;this._selectedPersons=[];this._selectedProperties={};this._div=null;this._header=new i.PickerHeader(this._basket,u,this._jobSet);this._footer=new i.PickerFooter(this._basket,u,this._jobSet);this.appendChild(this._header);this.appendChild(this._footer);this._resizeListener=null;this._orientation=null;this._windowedMaxWidth=500;this.initComponent();this._id="idPeoplePickerControl";this._mapKnownFieldToContactType=[{knownField:n.KnownContactField.email,contactType:n.ContactFieldType.email},{knownField:n.KnownContactField.phoneNumber,contactType:n.ContactFieldType.phoneNumber},{knownField:n.KnownContactField.location,contactType:n.ContactFieldType.location},{knownField:t.CustomDesiredFields.chat,contactType:n.ContactFieldType.custom},{knownField:t.CustomDesiredFields.link,contactType:n.ContactFieldType.custom}].reduce(function(n,t){return n[t.knownField]=t.contactType,n},{});this._addressKindCategoryMap=[{kind:n.ContactAddressKind.home,category:n.ContactFieldCategory.home},{kind:n.ContactAddressKind.work,category:n.ContactFieldCategory.work},{kind:n.ContactAddressKind.other,category:n.ContactFieldCategory.other}].reduce(function(n,t){return n[t.kind]=t.category,n},{});this._emailKindCategoryMap=[{kind:n.ContactEmailKind.personal,category:n.ContactFieldCategory.home},{kind:n.ContactEmailKind.work,category:n.ContactFieldCategory.work},{kind:n.ContactEmailKind.other,category:n.ContactFieldCategory.other}].reduce(function(n,t){return n[t.kind]=t.category,n},{});this._phoneKindCategoryMap=[{kind:n.ContactPhoneKind.home,category:n.ContactFieldCategory.home},{kind:n.ContactPhoneKind.work,category:n.ContactFieldCategory.work},{kind:n.ContactPhoneKind.mobile,category:n.ContactFieldCategory.mobile},{kind:n.ContactPhoneKind.other,category:n.ContactFieldCategory.other}].reduce(function(n,t){return n[t.kind]=t.category,n},{})};Jx.augment(t,Jx.Component);Jx.augment(t,Jx.Events);t.CustomDesiredFields={chat:"Windows.Live.Chat",link:"Windows.Live.Link"};Object.freeze(t.CustomDesiredFields);t.SupportedPropertyType={email:"email",phone:"phone",location:"location"};Object.freeze(t.SupportedPropertyType);t.prototype.getUI=function(n){n.html="<div id='idPeoplePickerControl' class='peoplePickerControl' ><div class='peoplePickerHeader'>"+Jx.getUI(this._header).html+"<\/div><div class='peoplePickerContent' id='idContacts' ><\/div><div class='peoplePickerFooter'>"+Jx.getUI(this._footer).html+"<\/div><\/div>"};t.prototype.activateUI=function(){Jx.Component.prototype.activateUI.call(this);this._orientation=i.Orientation.horizontal;document.documentElement.offsetWidth<this._windowedMaxWidth&&(this._orientation=i.Orientation.vertical);try{this._loadContactsViewport();this._basket.addEventListener("contactremoved",this._onContactRemovedFromBasket.bind(this))}catch(n){Jx.log.exception("Exception: ",n)}var t=this._div=document.getElementById(this._id);this._div.addEventListener("mselementresize",this._resizeListener=this._onResize.bind(this),false)};t.prototype._onResize=function(){var n=this._viewport.getOrientation(),t=n;document.documentElement.offsetWidth<this._windowedMaxWidth?n===i.Orientation.horizontal&&(t=i.Orientation.vertical):n===i.Orientation.vertical&&(t=i.Orientation.horizontal);n!=t&&(this._zoomHost?(this._zoomHost.shutdownComponent(),this.removeChild(this._zoomHost),this._zoomHost=null,this._viewport=null):this._viewport&&(this._viewport.shutdownComponent(),this.removeChild(this._viewport),this._viewport=null),this._orientation=t,this._loadContactsViewport())};t.prototype._loadContactsViewport=function(){var f,t;var e=this._platform,r=this._rootElem=document.getElementById(this._id),u=u=new i.PickerAlphabeticSection(e,this._onPersonClicked.bind(this),this,this._basket,r,this._header.getFilterToggle()),n=this._viewport=new i.ScrollingViewport(this._jobSet,u,this._orientation,true);this.appendChild(n);f=this._container=r.querySelector("#idContacts");f.innerHTML=Jx.getUI(n).html;t=document.getElementById(n.id);t.setAttribute("aria-multiselectable","true");t.setAttribute("aria-label",Jx.res.getString("/strings/peopleAppName"));n.activateUI();n.hydrate(null);this._jobSet.addUIJob(this,this._initializeSemanticZoom,null,i.Priority.semanticZoom)};t.prototype.getMessageBar=function(){return this._header.getMessageBar()};t.prototype.zoomChanged=function(n){var t=this.getMessageBar();Jx.setClass(this._rootElem,"inZoomedOutView",n);n?t.hide():t.unhide()};t.prototype._initializeSemanticZoom=function(){this.removeChild(this._viewport);this._zoomHost=i.ZoomHost.create(this._viewport,this._jobSet,this._zoomedOutJobSet,this._orientation,this,{disableEnterKey:true},this._container);this.appendChild(this._zoomHost)};t.prototype.trackStartup=function(){};t.prototype.shutdownComponent=function(){this._basket&&this._basket.removeEventListener("contactremoved",this._onContactRemovedFromBasket.bind(this));this._platform=null;this._basket=null;Jx.dispose(this._jobSet);Jx.dispose(this._zoomedOutJobSet);Jx.Component.prototype.shutdownComponent.call(this)};t.prototype.setSelectedProperty=function(n,t,i){this.getSelectedPropertyValue(i)!==t&&(this._selectedProperties[i.objectId]={property:n,displayValue:t},this.isSelected(i)?(this._removePersonFromBasket(i),this._addPersonToBasket(i)):(this._addPersonToBasket(i),this._selectedPersons.push(i.objectId)),this.raiseEvent("selectionchange",{id:i.objectId}))};t.prototype.getSelectedPropertyValue=function(n){var t=this._selectedProperties[n.objectId];return Jx.isNullOrUndefined(t)?null:t.displayValue};t.prototype.isSelected=function(n){return this._selectedPersons.indexOf(n.objectId)!==-1};t.prototype._removeFromSelectedList=function(n){var t=this._selectedPersons.indexOf(n);this._selectedPersons.splice(t,1)};t.prototype._onPersonClicked=function(n,t,i){var u,r,f;if(n!==null){if(u=this.isSelected(n),!Jx.isNullOrUndefined(t)&&!Jx.isNullOrUndefined(i)&&i.type==="keydown"&&(r=t.querySelector(".ic-pickerLayout-secondaryHitTarget"),f=!Jx.isNullOrUndefined(r)&&getComputedStyle(r).visibility!=="hidden",!u&&f)){r.click();return}msSetImmediate(function(){u?(this._removePersonFromBasket(n),this._removeFromSelectedList(n.objectId)):(this._addPersonToBasket(n),this._selectedPersons.push(n.objectId));this.raiseEvent("selectionchange",{id:n.objectId})}.bind(this))}};t.prototype._onContactRemovedFromBasket=function(n){this._removeFromSelectedList(n.id);this.raiseEvent("selectionchange",{id:n.id})};t.prototype._addPersonToBasket=function(n){var i=n.getWindowsContact(),f=this._basket,r,t;try{r=n.getUserTile(u.UserTileSize.small,false);Jx.isObject(r)&&(t=r.stream,!Jx.isNullOrUndefined(t)&&t.size>0&&(i.thumbnail=Windows.Storage.Streams.RandomAccessStreamReference.createFromStream(t)))}catch(e){Jx.log.exception("Error retrieving/processing usertile",e)}this._addDesiredProperties(n,i);f.addContact(i)};t.prototype._removePersonFromBasket=function(n){this._basket.removeContact(n.objectId)};t.prototype._applyPropertySetToContact=function(t,r){var f=this,u,e;for(u in t)e=t[u],e.forEach(function(t){var o,e,s;if(u===n.KnownContactField.email){for(o=0;o<r.emails.length;o++)if(e=r.emails[o],e.address===t.value&&f._emailKindCategoryMap[e.kind]===t.category){r.emails.insertAt(0,e);r.emails.removeAt(o+1);break}}else if(u===n.KnownContactField.phoneNumber){for(o=0;o<r.phones.length;o++)if(e=r.phones[o],e.number===t.value&&f._phoneKindCategoryMap[e.kind]===t.category){r.phones.insertAt(0,e);r.phones.removeAt(o+1);break}}else if(u===n.KnownContactField.location)for(o=0;o<r.addresses.length;o++)if(e=r.addresses[o],s=i.Location.chooseBestDisplayField({street:e.streetAddress,city:e.locality,region:e.region,zipCode:e.postalCode,country:e.country}),i.Location.chooseBestDisplayField(t.value)===s&&f._addressKindCategoryMap[e.kind]===t.category){r.addresses.insertAt(0,e);r.addresses.removeAt(o+1);break}})};t.prototype._addDesiredProperties=function(n,t){for(var e=[],o=[],y=this._basket.desiredFields,h,c,a,u,l,v,f,s=0;s<y.size;s++)h=y[s],this._mapKnownFieldToContactType[h]!==undefined&&(e.push(this._createPropertySetRequest(h)),o.push(h));e.length>0&&(c=this._retrievePropertySets(n,e),e.length===1&&(a=this._selectedProperties[n.objectId]||null,u=a?a.property:null,u===null&&(u=this._getDefaultField(n,o[0])),l=c[o[0]],l.length>1&&(v=l.map(function(n){return n.value}),f=-1,Jx.isObject(u)?f=r.findIndex(v,i.Location.isIdentical,u):Jx.isNullOrUndefined(u)||(f=v.indexOf(u)),f>=0&&(c[o[0]]=l.splice(f,1)))),this._applyPropertySetToContact(c,t))};t.prototype._createPropertySetRequest=function(r){var e=function(n){return Jx.isNonEmptyString(n)},o=function(n){return String.prototype.toLowerCase.apply(n.value)===String.prototype.toLowerCase.apply(this)},u=function(n){return function(t){return t[n]}},f={validator:e,equalityCheck:o};return r===n.KnownContactField.email?f.properties=[{name:"personalEmailAddress",accessor:u("personalEmailAddress"),category:n.ContactFieldCategory.home},{name:"windowsLiveEmailAddress",accessor:u("windowsLiveEmailAddress"),category:n.ContactFieldCategory.other},{name:"yahooEmailAddress",accessor:u("yahooEmailAddress"),category:n.ContactFieldCategory.other},{name:"businessEmailAddress",accessor:u("businessEmailAddress"),category:n.ContactFieldCategory.work},{name:"otherEmailAddress",accessor:u("otherEmailAddress"),category:n.ContactFieldCategory.other},{name:"federatedEmailAddress",accessor:u("federatedEmailAddress"),category:n.ContactFieldCategory.other}]:r===n.KnownContactField.phoneNumber?f.properties=[{name:"homePhoneNumber",accessor:u("homePhoneNumber"),category:n.ContactFieldCategory.home},{name:"home2PhoneNumber",accessor:u("home2PhoneNumber"),category:n.ContactFieldCategory.home},{name:"businessPhoneNumber",accessor:u("businessPhoneNumber"),category:n.ContactFieldCategory.work},{name:"business2PhoneNumber",accessor:u("business2PhoneNumber"),category:n.ContactFieldCategory.work},{name:"mobilePhoneNumber",accessor:u("mobilePhoneNumber"),category:n.ContactFieldCategory.mobile},{name:"mobile2PhoneNumber",accessor:u("mobile2PhoneNumber"),category:n.ContactFieldCategory.mobile}]:r===n.KnownContactField.location?(f.validator=i.Location.isValid,f.equalityCheck=i.Location.isIdentical,f.properties=[{name:"homeLocation",accessor:u("homeLocation"),category:n.ContactFieldCategory.home},{name:"businessLocation",accessor:u("businessLocation"),category:n.ContactFieldCategory.work},{name:"otherLocation",accessor:u("otherLocation"),category:n.ContactFieldCategory.other}]):(r===t.CustomDesiredFields.chat||r===t.CustomDesiredFields.link)&&(f.properties=[{name:"personId",accessor:function(n){return n.person.objectId},category:n.ContactFieldCategory.none}]),f.knownField=r,f};t.prototype._getDefaultField=function(t,r){if(r===n.KnownContactField.email)return t.mostRelevantEmail;if(r===n.KnownContactField.phoneNumber)return t.mostRelevantPhone;if(r===n.KnownContactField.location){var f=[this._createPropertySetRequest(n.KnownContactField.location)],e=this._retrievePropertySets(t,f),o=e[n.KnownContactField.location],s=o.map(function(n){return{value:n.value}}),u=i.Location.getBestLocation(s);return u?u.value:null}return null};t.prototype._retrievePropertySets=function(n,t){var e=n.linkedContacts,i={},o,u,f;for(t.forEach(function(n){i[n.knownField]=[]}),o=e.count,u=0;u<o;u++)f=e.item(u),f&&t.forEach(function(n){n.properties.forEach(function(t){var u=t.accessor(f),e={name:t.name,value:u,category:t.category};n.validator(u)&&r.findIndex(i[n.knownField],n.equalityCheck,e.value)===-1&&i[n.knownField].push(e)})});return i};t.prototype._createLocationField=function(t,r){return new n.ContactLocationField("",r,t.street,t.city,t.state,t.country,t.zipCode)}})