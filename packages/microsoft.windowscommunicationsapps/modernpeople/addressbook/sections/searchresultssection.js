Jx.delayDefine(People,["Highlighter","SearchResultsSection"],function(){function i(n,t){return n.toLocaleUpperCase().substr(0,t.length).localeCompare(t.toLocaleUpperCase())===0}var n=window.People,u=n.IdentityElements,f=Microsoft.WindowsLive.Platform,r,t;n.SearchResultsSection=function(t,i,r,u,f){n.ContactGridSection.call(this,"searchSection",null,t.peopleManager);this._query=i;this._data=r;this._header=u;this._platform=t;this._isGAL=f;this._searching=false};Jx.inherit(n.SearchResultsSection,n.ContactGridSection);r=n.ContactGridSection.prototype;n.SearchResultsSection.prototype.hydrateExtent=function(t){Jx.isNonEmptyString(this._query)||(this._query=n.Hydration.get(t,"query",""),this._data=n.Hydration.get(t,"data",""),this._isGAL=n.Hydration.get(t,"isGAL",false));r.hydrateExtent.call(this,t)};n.SearchResultsSection.prototype.dehydrate=function(t){var i=r.dehydrate.call(this,t);return n.Hydration.set(i,"query",this._query),n.Hydration.set(i,"data",this._data),n.Hydration.set(i,"isGAL",this._isGAL),i};n.SearchResultsSection.prototype.shutdownComponent=function(){this._searching&&People.RecentActivity.UI.Core.GlobalProgressControl.remove(this);Jx.dispose(this._collection);r.shutdownComponent.call(this)};n.SearchResultsSection.prototype._getSearchResultsCollection=function(){var r=this._peopleManager,t,i;return t=this._isGAL?new n.GALSearchCollection(this._platform,this._query,this._data):new n.IndexedSearchCollection(this._peopleManager,this._query,this._data),this._header&&(this._isGAL?t.addListener("updateHeader",this._updateHeader,this):t.addListener("load",this._updateHeader,this)),i=new n.ArrayCollection("search:"+this._query),i.appendItem({collection:t}),i};n.SearchResultsSection.prototype._getGALCollection=function(){var r=null,i=this._platform.accountManager.getConnectedAccountsByScenario(f.ApplicationScenario.peopleSearch,f.ConnectedFilter.normal,f.AccountSort.name),u,t;if(i.count>0){for(u=[],t=0;t<i.count;t++)u[t]={data:{title:"GAL Search",text:i.item(t).displayName,account:i.item(t)},type:"GALSearchButton"};r=new n.StaticCollection(u,"GALSearchButtons");r.loadComplete()}return r};n.SearchResultsSection.prototype._getCollection=function(){var n=this._getSearchResultsCollection(),t;return this._isGAL||(t=this._getGALCollection(),t!=null&&n.appendItem({header:null,collection:t})),n.loadComplete(),n};n.SearchResultsSection.prototype._getFactories=function(){var i=new n.IdentityControlNodeFactory(u.BillboardLayout,{className:"ic-listItem ic-hoverListItem",fontSize:this.getOrientation()===n.Orientation.horizontal?"medium":"normal",primaryContent:{element:t,query:this._query,primary:true},secondaryContent:{element:t,query:this._query,primary:false},tilePriority:n.Priority.userTileRender}),r=new n.Callback(this.addGALButtonClicked,this);return{person:new n.Callback(i.create,i),GALSearchButton:new n.Callback(function(){return new n.GALSearchButton(r)})}};n.SearchResultsSection.prototype.addGALButtonClicked=function(n){var t=People.Nav.getGALSearchUri(this._query,n.account.emailAddress);People.Nav.navigate(t)};n.SearchResultsSection.prototype._updateHeader=function(n){var i="",t;this._isGAL?n.error?(i=Jx.res.getString("/strings/galSearchServerError"),this._searching&&(People.RecentActivity.UI.Core.GlobalProgressControl.remove(this),this._searching=false)):n.searching?(People.RecentActivity.UI.Core.GlobalProgressControl.add(this),this._searching=true):(t=n.target.totalCount,i=Jx.res.loadCompoundString(t>0?"/strings/searchResultTitle":"/strings/searchResultEmptyTitle",this._query,t),this._searching&&(People.RecentActivity.UI.Core.GlobalProgressControl.remove(this),this._searching=false)):(t=n.target.totalCount,i=Jx.res.loadCompoundString(t>0?"/strings/searchResultTitle":"/strings/searchResultEmptyTitle",this._query,t));this._header&&this._header.updateSecondaryTitle(i)};t=n.Highlighter=function(){this._query="";this._primary=""};Jx.inherit(t,u.BaseElement);t.prototype.clone=function(){var n=new t;return n._query=this._query,n._primary=this._primary,n};t.prototype.getUI=function(n,t,i){return this._query=i.query,this._primary=i.primary,u.makeElement("span",t,"ic-name",i,"<span><\/span><span class='ic-searchHighlight'><\/span><span><\/span>")};t.prototype.activateUI=function(t,i){var r=i.children;this._prefix=r[0];this._highlight=r[1];this._suffix=r[2];t.bind(this._update,this,n.Priority.synchronous)};t.prototype._update=function(n){var i=this._split(n),t=this._primary?i.primary:i.secondary;this._prefix.innerText=t.prefix;this._highlight.innerText=t.highlight;this._suffix.innerText=t.suffix};t.prototype._split=function(t){var h=this._query,u=h.length,r=t.calculatedUIName,f=t.firstName,e=t.lastName,c={primary:{prefix:r,highlight:"",suffix:""},secondary:{prefix:"",highlight:"",suffix:""}},o=c.primary,y,l,a,p,s,v,w;if(i(r,h))l=r.substr(0,u),a=r.substr(u);else if(i(e,h))l=e.substr(0,u),a=e.substr(u),i(r.substr(-e.length),e)?y=r.substr(0,r.length-e.length):o=c.secondary;else if(i(f,h))l=f.substr(0,u),a=f.substr(u),i(r.substr(-f.length),f)?y=r.substr(0,r.length-f.length):o=c.secondary;else{for(o=c.secondary,p=n.Contact.createUniqueFields(t.linkedContacts,"email"),s="",v=0;v<p.length&&!s;v++)w=p[v].fieldValue,i(w,h)&&(s=w);Jx.isNonEmptyString(s)?(l=s.substr(0,u),a=s.substr(u)):Jx.log.warning("Highlighter didn't find a match for "+name)}return o.prefix=y||"",o.highlight=l||"",o.suffix=a||"",c}})