Jx.delayDefine(People.Accounts,["AccountFields","AccountDialog","AccountDialogMode","AccountDialogEvents"],function(){function d(n){return/^.+@.+\..+$/.test(n)}function y(n){return!isNaN(n)&&parseInt(n,10)>0}function i(n){return Jx.res.getString("/accountsStrings/"+n)}function h(n,t){return Jx.res.loadCompoundString("/accountsStrings/"+n,t)}function b(t,i){var r=t.getOtherConnectableAccounts(i),u,f;if(r&&r.count>0)for(u=0;u<r.count;u++)if(f=r.item(u),f&&f.accountType===n.AccountType.easAccountFactory)return f;return null}function w(t){return t.getServerByType(n.ServerType.eas)||t.getServerByType(n.ServerType.imap)}var f=window.People,o=f.Accounts,n=Microsoft.WindowsLive.Platform,v=Windows.Security.Cryptography,k=o.AccountDialogEvents={newAccountAdded:"People.Accounts.AccountDialogEvents.newAccountAdded",launchingOAuthFlow:"People.Accounts.AccountDialogEvents.launchingOAuthFlow",closingOAuthFlow:"People.Accounts.AccountDialogEvents.closingOAuthFlow"},e,t,c,p,u,l,r,a,s;Object.freeze(k);e=o.AccountDialogMode={add:0,update:1,updateSmtp:2,easiID:3,addPrimary:4};Object.freeze(e);t={abbreviated:0,intermediate:1,full:2,fullImap:3,smtpOnly:4,oauth:5};Object.freeze(t);c={noCerts:0,success:1,multipleSubjects:2};Object.freeze(c);p=12e4;u=o.AccountDialog=function(u,s,c,l,a,v,y){var p,ut,ft,it,rt;this._keyboardShowingListener=this._onKeyboardShowing.bind(this);this._keyboardHidingListener=this._onKeyboardHiding.bind(this);p=u;this._dialogMode=s;this._platform=l;var b="actdlgTitle",nt="actdlgAdd",w="",k="",tt=u.color.toString(16);this._cachedOAuthData=null;this._suggestedEmail=v;switch(s){case o.AccountDialogMode.add:this._template=u;u.sourceId==="IMAP"&&(p={displayName:i("actdlgOtherAccount"),iconMediumUrl:u.iconMediumUrl});w=h("actdlgDescription",[p.displayName]);this._scenario=c;u.supportsOAuth&&(b="actdlgTitle-OAuth");break;case o.AccountDialogMode.addPrimary:this._template=u;b="actdlgTitle-AddWorkAccount";this._accountName=y||i("actdlgWorkAccount");p={displayName:this._accountName,iconMediumUrl:""};w=i("actdlgDescription-AddWorkAccount");k=h("actdlgTitle-AddWorkAccount",[Jx.escapeHtml(this._accountName)]);tt="2072b8";this._scenario=c;break;case o.AccountDialogMode.update:b=u.supportsOAuth?"actdlgTitle-UpdateOAuth":"actdlgTitle-Update";w=i("actdlgDescription-Update");nt="actdlgUpdate";this._account=u;break;case o.AccountDialogMode.updateSmtp:b=u.supportsOAuth?"actdlgTitle-UpdateOAuth":"actdlgTitle-Update";w=i("actdlgDescription-UpdateSmtp");nt="actdlgUpdate";this._account=u;break;case o.AccountDialogMode.easiID:w=i("actdlgDescription-EasiID");u.supportsOAuth?b="actdlgTitle-OAuth":Jx.isNonEmptyString(p.displayName)||(k=i("easiIdTitle"));this._template=u;this._scenario=c}this._bici={configSource:f.Bici.ConfigSource.notAttempted,entryPoint:a||f.Bici.EntryPoint.other,result:n.Result.userCanceled,server:"",sourceId:u.sourceId,syncProtocol:f.Bici.SyncProtocol.unknown};it=tt;tt!=="0"&&it!=="ffffffff"&&(ut="#"+it,ft="White");Jx.isNonEmptyString(k)||(k=h(b,[p.displayName]));rt=s===e.updateSmtp?t.smtpOnly:t.abbreviated;u.supportsOAuth&&(rt=t.oauth,w="");var g=new f.DialogButton("actdlgAdd",i(nt),"submit"),et=this._fields=new r(u,w,s,c,v,rt),d=this._dialog=new f.FormDialog(k,et,{headerColor:ut,headerIcon:p.iconMediumUrl,titleColor:ft}),ot=new f.CloseButton("actdlgCancel",i("actdlgCancel"),d);et.setDialogButtons(g,ot);this._mainAction=this._createAccount;d.addListener("submit",this._mainDialogActionHandler,this);g.addListener("click",this._mainDialogActionHandler,this);g.autofocus=true;d.buttons=[g,ot];d.addListener("opened",this._onOpened.bind(this),this);d.addListener("closed",this._onClosed.bind(this),this)};Jx.inherit(u,Jx.Events);u.prototype._onKeyboardShowing=function(n){var e,u,i,t,r,f;n.ensuredFocusedElementInView=true;e=document.getElementById("actdlgAdd");u=e.getBoundingClientRect().bottom+7;u>n.occludedRect.y&&(i=document.getElementById("dlg-box"),t=document.getElementById("dlg-form"),i.style.position="fixed",i.style.msOverflowStyle="scrollbar",this._pointerDownTrap=function(n){n.preventDefault()},i.addEventListener("MSPointerDown",this._pointerDownTrap,false),r=u-n.occludedRect.y,f=-r,t.offsetTop<r&&(t.style.pixelHeight=t.offsetHeight-(r-t.offsetTop),f=-t.offsetTop),i.style.top=f+"px",msSetImmediate(function(){document.activeElement.scrollIntoView()}))};u.prototype._onKeyboardHiding=function(){if(this._dialog.hasUI()){var n=document.getElementById("dlg-box"),t=document.getElementById("dlg-form");n.style.position="";n.style.top="";t.style.height="";n.style.msOverflowStyle="";this._pointerDownTrap&&(n.removeEventListener("MSPointerDown",this._pointerDownTrap,false),this._pointerDownTrap=null)}};u.prototype.show=function(n){if(this._fields.layoutMode===t.oauth){if((this._dialog.canShow()||n)&&(n&&this._dialog.closeActive(),this._dialog.reserveNextShowing())){var i=this._suggestedEmail;if(this._account&&(i=i||this._account.emailAddress),this._launchOAuthFlow(i,n))return true}}else return this._dialog.show(true,n);return false};u.prototype.close=function(){this._dialog.close()};u.prototype._launchOAuthFlow=function(n,t){Jx.log.info("Invoking OAuth flow");var i=this._promise=o.authenticateOAuthAsync(n);return i.done(function(n){Jx.EventManager.broadcast(o.AccountDialogEvents.closingOAuthFlow);Jx.isObject(n)&&Jx.isNonEmptyString(n.emailAddress)&&Jx.isNonEmptyString(n.accessToken)&&Jx.isNonEmptyString(n.refreshToken)&&Jx.isObject(n.accessTokenExpiry)?(this._cachedOAuthData=n,this._createAccount()):(Jx.log.error("We didn't get back the data we expected from authenticateOAuthAsync. Failing out."),this._handleOAuthFlowError(new Error(-2147418113,"unexpected oauth results")))}.bind(this),function(n){this._handleOAuthFlowError(n);Jx.EventManager.broadcast(o.AccountDialogEvents.closingOAuthFlow)}.bind(this),function(){this._ensureDialogShowing(t)?this._fields.showProgress():i.cancel()}.bind(this)),Jx.EventManager.broadcast(o.AccountDialogEvents.launchingOAuthFlow),i};u.prototype._ensureDialogShowing=function(n){return this._dialog.isShowing()?true:this._dialog.show(n)};u.prototype._handleOAuthFlowError=function(n,t){var u,f,r;Jx.log.error("OAuth Failure: "+n);Jx.isNumber(n)||n&&n.number?this._ensureDialogShowing(t)&&(u=this._template||this._account,f=h("actdlgOAuthUnknownError",Jx.escapeHtml(u.displayName)),this._fields.showError(f,i("barDlgYesButton")),r=this._suggestedEmail,this._cachedOAuthData?r=this._cachedOAuthData.emailAddress||r:this._account&&(r=r||this._account.emailAddress),this._mainAction=this._launchOAuthFlow.bind(this,r)):(Jx.log.info("User cancelled OAuth flow. Exiting dialog."),this._dialog.isShowing()?this.close():this._dialog.cancelReservation())};u.prototype._fallbackToBasicAuth=function(){this._fields.updateLayout(t.abbreviated);this._fields.reapplyAccount(this._account);this._fields.email=this._cachedOAuthData.emailAddress;this._cachedOAuthData=null;this._mainAction=this._createAccount};u.prototype._validateInput=function(){var n=this._fields;if(n.showProgress(),Jx.safeSetActive(document.getElementById("dlg-title")),n.layoutMode!==t.oauth)if(Jx.isNonEmptyString(n.email)&&d(n.email))if(Jx.isNonEmptyString(n.server)||n.layoutMode!==t.full&&n.layoutMode!==t.fullImap)if(Jx.isNonEmptyString(n.password)||n.layoutMode===t.smtpOnly)if(n.layoutMode!==t.fullImap||y(n.port))if(n.layoutMode!==t.fullImap||Jx.isNonEmptyString(n.smtpServer))if(n.layoutMode!==t.fullImap||y(n.smtpPort)){if(n.layoutMode===t.fullImap&&n.smtpRequiresAuth&&!n.smtpReuseCreds)if(Jx.isNonEmptyString(n.smtpUsername)){if(!Jx.isNonEmptyString(n.smtpPassword))return new Error("empty SMTP password")}else return new Error("empty SMTP username")}else return new Error("invalid SMTP port");else return new Error("empty SMTP server");else return new Error("invalid IMAP port");else return new Error("empty password");else return new Error("empty server");else return new Error("invalid email")};l=function(n){return l=v.CryptographicBuffer.encodeToBase64String,l(n)};u.prototype._encryptPassword=function(n){var t=v.DataProtection.DataProtectionProvider("local=user"),i=v.CryptographicBuffer.convertStringToBinary(n,v.BinaryStringEncoding.utf8);return t.protectAsync(i)};u.prototype._switchToAddMode=function(){this._dialogMode=e.add;var n=h("actdlgTitle-OAuth",[Jx.escapeHtml(this._account.displayName)]);this._dialog.updateTitle(n);this._template=this._account;this._account=null};u.prototype._initAccount=function(i){var r=this._fields,o,c,u,f,s,h;if(this._upgradedImapTemplate=null,r.layoutMode===t.oauth&&Jx.isNullOrUndefined(this._template)&&this._account.emailAddress!==this._cachedOAuthData.emailAddress&&this._switchToAddMode(),Jx.isNullOrUndefined(this._template))this._account.getResourceByType(n.ResourceType.mail).isSyncNeeded=true;else{if(o=null,this._template.accountType===n.AccountType.imapAccountFactory&&r.layoutMode===t.abbreviated&&(r.syncContactsAndCal&&(o=b(this._template,this._scenario)),!o&&(this._upgradedImapTemplate=o=this._platform.accountManager.getConnectableAccountByEmailDomain("IMAP",r.email),o&&o.accountType===n.AccountType.popAccountFactory)))return n.Result.cannotCreatePopAccounts;Jx.isObject(o)||(o=this._template);c=r.email;r.layoutMode===t.oauth&&(c=this._cachedOAuthData.emailAddress);this._account=o.createConnectedAccount(c)}u=w(this._account);f=this._account.getServerByType(n.ServerType.smtp);switch(r.layoutMode){case t.fullImap:u.useSsl=r.useSsl;f.server=r.smtpServer;f.port=r.smtpPort;f.useSsl=r.smtpUseSsl;case t.full:u.server=r.server;u.port=r.port;case t.intermediate:u.domain=r.domain;u.userId=r.username;Jx.isObject(f)&&(r.smtpRequiresAuth&&!r.smtpReuseCreds?(f.userId=r.smtpUsername,f.serverRequiresLogin=true):f.userId=r.username);break;case t.smtpOnly:f.userId=r.smtpUsername}i[0]&&(r.layoutMode!==t.oauth?u.setPasswordCookie(l(i[0])):this._account.setAuthTokens(l(i[0]),l(i[1]),this._cachedOAuthData.accessTokenExpiry));Jx.isObject(f)&&(i[1]?f.setPasswordCookie(l(i[1])):i[0]&&f.setPasswordCookie(l(i[0])));Jx.isNonEmptyString(u.server)?this._dialogMode===e.update&&(this._account.settingsResult=n.Result.serverNotAttempted):this._account.settingsResult=n.Result.autoDiscoveryNotAttempted;this._ignorableCertErrorContent&&(this._ignorableCertErrorContent.setAccount(this._account),s=this._account.getResourceByType(n.ResourceType.mail),this._ignorableCertErrorContent.expiredSeen&&(u.ignoreServerCertificateExpired=true,s.serverCertificateExpired=false),this._ignorableCertErrorContent.mismatchedDomainSeen&&(u.ignoreServerCertificateMismatchedDomain=true,s.serverCertificateMismatchedDomain=false),this._ignorableCertErrorContent.unknownCASeen&&(u.ignoreServerCertificateUnknownCA=true,s.serverCertificateUnknownCA=false));this._hasAutoSelectedCertificate(r.email)&&u.serverType===n.ServerType.eas&&(u.certificateThumbPrint=this._selectedCerts[r.email].thumbPrint,h=this._issuerList,h[r.server]&&h[r.server][r.domain]&&(u.issuerList=h[r.server][r.domain]));(this._dialogMode===e.add||this._dialogMode===e.addPrimary)&&(this._platform.accountManager.canSetSyncTypePush()?this._account.syncType=n.SyncType.push:(this._account.syncType=n.SyncType.poll,this._account.pollInterval=30))};u.prototype._updateBiciProperties=function(){var r,p,c;if(this._dialogMode!==e.update){var u=f.Bici.ConfigSource.manual,i=this._account||this._upgradedImapTemplate||this._template,o="",h=false,s=n.ServerType.eas,y=f.Bici.SyncProtocol.eas;if(i.accountType===n.AccountType.imap||i.accountType===n.AccountType.imapAccountFactory?(s=n.ServerType.imap,y=f.Bici.SyncProtocol.imap):(i.accountType===n.AccountType.pop||i.accountType===n.AccountType.popAccountFactory)&&(s=n.ServerType.pop,y=f.Bici.SyncProtocol.pop),r=i.getServerByType(s),Jx.isNullOrUndefined(r)||(o=r.server),h=Jx.isNonEmptyString(o),h||(p=i.emailAddress||this._fields.email,Jx.isNonEmptyString(p)&&(c=p.split("@"),c.length>1&&(c.shift(),o=c.join("")))),o=o.toLowerCase(),this._fields.layoutMode===t.oauth)u=f.Bici.ConfigSource.oauth2;else switch(s){case n.ServerType.eas:u=h&&!r.supportsAdvancedProperties?f.Bici.ConfigSource.catalogConfig:h?f.Bici.ConfigSource.manual:Jx.isNonEmptyString(r.domain)||r.userId!==i.emailAddress?f.Bici.ConfigSource.autoDiscoverByUserDomain:f.Bici.ConfigSource.autoDiscoverByEmail;break;case n.ServerType.imap:if(u=f.Bici.ConfigSource.manual,Jx.isObject(this._upgradedImapTemplate)){var l=this._upgradedImapTemplate.getServerByType(s),a=i.getServerByType(n.ServerType.smtp),v=this._upgradedImapTemplate.getServerByType(n.ServerType.smtp);Jx.isObject(l)&&Jx.isObject(a)&&Jx.isObject(v)&&l.server===r.server&&l.port===r.port&&l.useSsl===r.useSsl&&v.server===a.server&&v.port===a.port&&v.useSsl===a.useSsl&&(u=f.Bici.ConfigSource.accountsConfig)}break;default:u=f.Bici.ConfigSource.pop}this._bici.configSource=u;this._bici.server=o;this._bici.sourceId=i.sourceId;this._bici.syncProtocol=y}};u.prototype._logStep=function(t,i){if(Jx.isNumber(t)&&(this._bici.result=t,this._dialogMode!==e.update&&this._dialogMode!==e.updateSmtp)){var r=Date.now(),u=r-i;Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.Platform.accountDialogStep,this._bici.sourceId,this._bici.server,this._bici.syncProtocol,this._bici.result,this._bici.configSource,this._bici.entryPoint,u);t!==n.Result.success&&this._bici.syncProtocol===f.Bici.SyncProtocol.imap&&this._bici.configSource===f.Bici.ConfigSource.accountsConfig&&Jx.fault("AccountDialogIMAPFault","accountdialog.js",t)}};u.prototype._onOpened=function(){if(Jx.log.info("Opening account dialog."),Jx.isNullOrUndefined(this._inputPane)){var n=this._inputPane=Windows.UI.ViewManagement.InputPane.getForCurrentView();n.addEventListener("showing",this._keyboardShowingListener);n.addEventListener("hiding",this._keyboardHidingListener)}};u.prototype._onClosed=function(){if(Jx.log.info("Closing account dialog."),this._inputPane){var n=this._inputPane;n.removeEventListener("showing",this._keyboardShowingListener);n.removeEventListener("hiding",this._keyboardHidingListener)}Jx.isNullOrUndefined(this._promise)||this._promise.cancel();this._dialogMode!==e.update&&this._dialogMode!==e.updateSmtp&&Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.Platform.accountDialogOverall,this._bici.sourceId,this._bici.server,this._bici.syncProtocol,this._bici.result,this._bici.configSource,this._bici.entryPoint);this.raiseEvent("closed")};u.prototype._commitAccount=function(){var n=new Date,t;return this._account.settingsChangedTime=n,t=f.Promises.waitForSettingsResult(this._account,n),f.Promises.commitAndWaitForPromise(p,this._account,t,"accountAdd_commit")};u.prototype._mainDialogActionHandler=function(){this._mainAction.call(this)};u.prototype._createAccount=function(){Jx.mark("Accounts.AccountDialog._createAccount,StartTA,People");var r=Date.now(),i=this;this._promise=f.Promises.synchronousPromise(function(){return i._validateInput()}).then(function(){var n=i._fields,r=WinJS.Promise.wrap(null),u=WinJS.Promise.wrap(null);return n.layoutMode!==t.oauth?(n.layoutMode!==t.smtpOnly&&(r=i._encryptPassword(n.password)),(n.layoutMode===t.smtpOnly||n.layoutMode===t.fullImap&&n.smtpRequiresAuth&&!n.smtpReuseCreds)&&(u=i._encryptPassword(n.smtpPassword))):(r=i._encryptPassword(i._cachedOAuthData.refreshToken),u=i._encryptPassword(i._cachedOAuthData.accessToken)),WinJS.Promise.join([r,u])}).then(function(n){return f.Promises.synchronousPromise(function(){var t=i._initAccount(n);return i._updateBiciProperties(),Jx.isNullOrUndefined(t)?void 0:new Error(t,t)})}).then(function(){return i._hasAutoSelectedCertificate(i._fields.email)?o.CertificateUtils.invokeCertificatePromptIfNeededAsync(i._selectedCerts[i._fields.email]):WinJS.Promise.wrap(null)}).then(function(){return i._commitAccount()},function(n){return n===o.CertPromptResult.accessDenied||n===o.CertPromptResult.failedToOpenKey?i._commitAccount():WinJS.Promise.wrapError(n)}).then(function(t){if(t===n.Result.serverNotAttempted){var r=f.Promises.waitForPropertyChange(i._account,"settingsResult");return i._account.settingsResult!==n.Result.serverNotAttempted?(r.cancel(),i._account.settingsResult):f.Promises.errorIfTimeout(r,p)}return t}).then(function(t){if(t!==n.Result.success)return t===n.Result.e_NEXUS_APPLY_POLICY_NEEDED||t===n.Result.e_NEXUS_UNABLE_TO_COMPLY_WITH_POLICY?void 0:WinJS.Promise.wrapError(t)}).then(function(){Jx.mark("Accounts.AccountDialog._createAccount,StopTA,AccountDialog");Jx.log.info("Account add success");i._setSyncType();i._logStep(n.Result.success,r);Jx.EventManager.fireDirect(null,o.AccountDialogEvents.newAccountAdded,{account:i._account});i._launchContactsFlowIfNeeded();i._purgeDuplicateIfNeeded();i.wasSuccess=true;i._dialog.close()},function(n){Jx.mark("Accounts.AccountDialog._createAccount,StopTA,AccountDialog");i._logStep(n,r);i._failure(n)})};u.prototype._closeWithCertSelectionNeeded=function(){Jx.log.info("Closing with cert selection neeeded.");this._account.settingsResult=n.Result.certSelectionNeeded;this._account.commit();this.wasSuccess=true;this._dialog.close()};u.prototype._failure=function(r){var l,y,u,k,a,v,d,g,p;if(Jx.log.error("Account add failure: "+r),l=Jx.fnEmpty,y=true,this._dialog.hasUI()){var f="",w=true,b=null;this._account&&(u=this._fields,Jx.isNullOrUndefined(this._upgradedImapTemplate)||u.layoutMode!==t.abbreviated||u.reapplyAccount(this._upgradedImapTemplate),!Jx.isNumber(r)&&r&&r.number&&(r=r.number),r===n.Result.e_HTTP_SERVICE_UNAVAIL||r===n.Result.e_HTTP_GATEWAY_TIMEOUT?f=h("actdlgServiceUnavailableError",[Jx.escapeHtml(this._account.emailAddress)]):r===-2067070966||r===n.Result.cannotAddAliasOfMicrosoftAccount?(f=i("actdlgDuplicateAccountError"),u.layoutMode===t.oauth&&(this._mainAction=this._launchOAuthFlow.bind(this,this._account.emailAddress))):r!==n.Result.e_HTTP_DENIED&&r!==n.Result.ixp_E_IMAP_LOGINFAILURE&&r!==n.Result.cannotMakeMicrosoftAccountAsPrimaryAccount||this._badCredsErrAlreadySeen?r===n.Result.credentialMissing?u.layoutMode!==t.oauth||this._account.supportsOAuth||(Jx.log.info("This account no longer supports OAuth. Downgrading the dialog to basic auth."),this._fallbackToBasicAuth()):r===n.Result.e_GOOGLE_APPS?f=i("actdlgGmailEasNotSupportedError"):r===n.Result.certUntrustedRoot||r===n.Result.invalidServerCertificate?f=i("actdlgCertMissingError"):r===n.Result.e_SYNC_IGNORABLE_SERVER_CERT_FAILURE?(this._ignorableCertErrorContent||(this._ignorableCertErrorContent=new s,this._ignorableCertErrorContent.setAccount(this._account)),this._ignorableCertErrorContent.updateError(),b=this._ignorableCertErrorContent):r===n.Result.e_SYNC_CBA_FAILED?this._hasAutoSelectedCertificate(this._account.emailAddress)?(Jx.log.error("Reconnection attempted failed after auto-selecting certificate."),l=this._closeWithCertSelectionNeeded,y=false):(k=this._autoSelectCert(),w=false,k===c.noCerts?(Jx.log.error("Auto-selecting certificate failed: no certs found."),f=i("actdlgCertMissingError"),w=true):k===c.multipleSubjects?(Jx.log.error("Auto-selecting certificate failed: multiple subjects."),l=this._closeWithCertSelectionNeeded,y=false):(Jx.log.info("Auto-selecting a certificate, and re-attempting account connection."),l=this._createAccount)):r===-2147023674||o.cannotConnectToNetwork()?f=i("actdlgNoInternetError"):r===n.Result.e_NEXUS_STATUS_MAXIMUM_DEVICES_REACHED?f=Jx.res.getString("/messagebar/messageBarDeviceLimitReached"):(a=this._template||this._account,u.layoutMode===t.oauth?f=h("actdlgOAuthUnknownError",Jx.escapeHtml(a.displayName)):(v=n.ServerType.eas,(a.accountType===n.AccountType.imap||a.accountType===n.AccountType.imapAccountFactory)&&(v=n.ServerType.imap),d=a.getServerByType(v),(d.supportsAdvancedProperties||this._dialogMode===e.addPrimary)&&(u.layoutMode!==t.full||u.layoutMode!==t.fullImap)&&(v!==n.ServerType.imap&&u.layoutMode===t.abbreviated?(f=h("actdlgAutoDiscoveryInitialFailure",[Jx.escapeHtml(u.email)]),u.updateLayout(t.intermediate)):(v===n.ServerType.imap||u.layoutMode===t.intermediate)&&(u.updateLayout(this._account.accountType===n.AccountType.imap?t.fullImap:t.full),f=h("actdlgAutoDiscoveryUtterFailure",[Jx.escapeHtml(u.email)]))))):(f=this._dialogMode===e.addPrimary?h("actdlgBadWorkCredentialsError",[Jx.escapeHtml(this._accountName)]):i("actdlgBadCredentialsError"),u.layoutMode===t.oauth?this._account.supportsOAuth?this._mainAction=this._launchOAuthFlow.bind(this,this._account.emailAddress):(Jx.log.info("This account no longer supports OAuth. Downgrading the dialog to basic auth."),this._fallbackToBasicAuth()):this._badCredsErrAlreadySeen=true));w&&(b?this._fields.showBarricadeError(b):(this._fields.ensureValidFocus(),g=this._fields.layoutMode===t.oauth?i("actdlgTryAgain"):"",this._fields.showError(f,g)))}y&&this._dialogMode!==e.update&&this._dialogMode!==e.updateSmtp&&(p=this._account,this._account=null,p&&p.canDelete&&p.deleteObject());l.call(this)};u.prototype._setSyncType=function(){if(this._account.accountType===n.AccountType.imap){var t=this._account.getServerByType(n.ServerType.imap);Jx.isObject(t)&&(t.pushSupported||(this._account.syncType=n.SyncType.poll,this._account.pollInterval=30,this._account.commit()))}};u.prototype._autoSelectCert=function(){var t=this._platform.accountManager.queryForCertificateCollection(this._account),r,n,i;if(Jx.isObject(t)){if(t.hasMultipleSubjects)return c.multipleSubjects;if(t.count>0)return r=t.item(0),this._selectedCerts=this._selectedCerts||{},this._selectedCerts[this._account.emailAddress]=r,n=w(this._account),i=this._issuerList=this._issuerList||{},i[n.server]=i[n.server]||{},i[n.server][n.domain]=n.issuerList,c.success}return c.noCerts};u.prototype._hasAutoSelectedCertificate=function(n){return Jx.isObject(this._selectedCerts)&&Jx.isObject(this._selectedCerts[n])};u.prototype._launchContactsFlowIfNeeded=function(){var u=this._account,t,r,i,f,o;if(u&&u.accountType===n.AccountType.imap&&this._dialogMode===e.add&&(t=u.getOtherConnectableAccounts(n.ApplicationScenario.people),t&&t.count>0))for(r=0;r<t.count;r++)if(i=t.item(r),i&&i.accountType===n.AccountType.withoutPlugins&&(f=i.getResourceByType(n.ResourceType.contactAgg),f&&!f.isEnabled)){o=new People.Accounts.FlowLauncher(this._platform,n.ApplicationScenario.people);o.launchManageFlow(i);break}};u.prototype._purgeDuplicateIfNeeded=function(){var t=this._account,u,r,f,i;if(t&&!t.isEasi&&t.accountType===n.AccountType.eas&&this._dialogMode===e.add)for(u=this._platform.accountManager.getConnectedAccountsByScenario(n.ApplicationScenario.mail,n.ConnectedFilter.normal,n.AccountSort.name),r=0,f=u.count;r<f;r++)if(i=u.item(r),!i.isDefault&&i.emailAddress===t.emailAddress&&i.accountType===n.AccountType.imap){i.deleteObject();n.SyncType.poll===t.syncType&&this._platform.accountManager.canSetSyncTypePush()&&(this._account.syncType=n.SyncType.push,this._account.commit());break}};r=o.AccountFields=function(t,i,r,u,f,o){this.initComponent();this._account=t;this._descriptionText=i;this._layoutMode=o;this._previousLayoutMode=this._layoutMode;this._mode=r;this._allowEmailEditing=r!==e.update;this._isImap=Jx.isObject(this._account.getServerByType(n.ServerType.imap));this._scenario=u;this._emailAddress=f||t.emailAddress};Jx.augment(r,Jx.Component);r.prototype.getUI=function(n){function r(n,t,r){return"<div id='"+n+"Label' class='"+r+"' role='sectionhead'>"+i(t)+"<\/div><div class='actdlg-input "+r+"'  data-fullLayout='true'><input id='"+n+"' aria-labelledby='"+n+"Label' type='url' maxlength='64'><\/div>"}function u(n,t,u){return"<div class='floatLeft showInFullImap hidden'>"+r(n,t,"")+"<\/div><div class='floatRight showInFullImap hidden'><div id='"+u+"Label' role='sectionhead'>"+i("actdlgPortLabel")+"<\/div><div class='actdlg-portInput'><input id='"+u+"' aria-labelledby='"+u+"Label' type='number' maxlength='5'><\/div><\/div><div class='clear'><\/div>"}var t=this._account;this._id="actdlgFields"+Jx.uid();n.html="<div id='"+this._id+"'><div id='actdlgFieldsContainer'><div id='dlgDescription' class='actdlg-description' role='heading'>"+Jx.escapeHtml(this._descriptionText)+"<\/div><div id='actdlgStatus'><progress id='actdlgProgress' class='hidden spinner showInProgress' role='progressbar' aria-describeby='actdlgStatusText'><\/progress><span id='actdlgStatusText' role='status' aria-live='polite'><\/span><\/div><div id='actdlgEmailLabel' class='showInAbbreviated showInIntermediate showInFull showInFullImap hidden' role='sectionhead' >"+i("actdlgEmailLabel")+"<\/div><div class='actdlg-input showInAbbreviated showInIntermediate showInFull showInFullImap hidden'><input id='actdlgEmail' aria-labelledby='actdlgEmailLabel' type='email' value='"+Jx.escapeHtml(this._emailAddress)+"' maxlength='100' "+(this._allowEmailEditing?"":"readonly")+"><\/div>"+r("actdlgServer","actdlgServerLabel","showInFull hidden")+"<div id='actdlgDomainLabel' class='showInIntermediate showInFull hidden' role='sectionhead'>"+i("actdlgDomainLabel")+"<\/div><div class='actdlg-input showInIntermediate showInFull hidden'><input id='actdlgDomain' aria-labelledby='actdlgDomainLabel' type='text' maxlength='256'><\/div><div id='actdlgUsernameLabel' class='showInIntermediate showInFull showInFullImap hidden' role='sectionhead'>"+i("actdlgUsernameLabel")+"<\/div><div class='actdlg-input showInIntermediate showInFull showInFullImap hidden'><input id='actdlgUsername' aria-labelledby='actdlgUsernameLabel' type='text' maxlength='64'><\/div><div id='actdlgPasswordLabel' class='showInAbbreviated showInIntermediate showInFull showInFullImap hidden' role='sectionhead'>"+i("actdlgPasswordLabel")+"<\/div><div class='actdlg-input showInAbbreviated showInIntermediate showInFull showInFullImap hidden'><input id='actdlgPassword' aria-labelledby='actdlgPasswordLabel' type='password' maxlength='256'><\/div><label class='showOnlyInAbbreviated hidden actdlg-checkbox'><input id='actdlgSyncContactsAndCal' class='actdlg-checkbox-input' type='checkbox' aria-label='"+Jx.escapeHtml(h("actdlgContactsAndCal",[t.displayName]))+"'>"+Jx.escapeHtml(h("actdlgContactsAndCal",[t.displayName]))+"<\/label>"+u("actdlgImapServer","actdlgImapServerLabel","actdlgPort")+"<div class='actdlg-checkbox showInFullImap hidden' role='sectionhead'><label><input id='actdlgUseSsl' class='actdlg-checkbox-input' type='checkbox' aria-label='"+Jx.escapeHtml(i("actdlgImapSslLabel"))+"'>"+i("actdlgImapSslLabel")+"<\/label><\/div>"+u("actdlgSmtpServer","actdlgSmtpServerLabel","actdlgSmtpPort")+"<div class='actdlg-checkbox showInFullImap hidden' role='sectionhead'><label><input id='actdlgSmtpUseSsl' class='actdlg-checkbox-input' type='checkbox' aria-label='"+Jx.escapeHtml(i("actdlgSmtpSslLabel"))+"'>"+i("actdlgSmtpSslLabel")+"<\/label><\/div><div class='actdlg-checkbox showInFullImap hidden' role='sectionhead'><label><input id='actdlgSmtpRequiresAuth' class='actdlg-checkbox-input' type='checkbox' aria-label='"+Jx.escapeHtml(i("actdlgSmtpRequiresAuthLabel"))+"' checked>"+i("actdlgSmtpRequiresAuthLabel")+"<\/label><\/div><div class='actdlg-checkbox showInFullImap hidden' role='sectionhead'><label><input id='actdlgSmtpReuseCreds' class='actdlg-checkbox-input' type='checkbox' aria-label='"+Jx.escapeHtml(i("actdlgSmtpReuseCredsLabel"))+"' checked>"+i("actdlgSmtpReuseCredsLabel")+"<\/label><\/div><div id='actdlgSmtpCredsHeaderLabel' class='showInDontReuseCreds hidden' role='sectionhead'>"+i("actdlgSmtpCredsHeaderLabel")+"<\/div><div id='actdlgSmtpUsernameLabel' class='showInDontReuseCreds hidden' role='sectionhead'>"+i("actdlgSmtpUsernameLabel")+"<\/div><div class='actdlg-input showInDontReuseCreds hidden'><input id='actdlgSmtpUsername' aria-labelledby='actdlgSmtpUsernameLabel' type='text' maxlength='64'><\/div><div id='actdlgSmtpPasswordLabel' role='sectionhead' class='showInDontReuseCreds hidden'>"+i("actdlgPasswordLabel")+"<\/div><div class='actdlg-input showInDontReuseCreds hidden'><input id='actdlgSmtpPassword' aria-labelledby='actdlgSmtpPasswordLabel' type='password' maxlength='256'><\/div><div class='actdlg-link hidden'><a id='actdlgShowAdvancedLink' tabIndex='0' aria-live='polite'>"+i("actdlgSeeMore")+"<\/a><\/div><\/div><div id='actdlgBarricadeError'><\/div><\/div>"};r.prototype.activateUI=function(){var i=this._inputs={email:document.getElementById("actdlgEmail"),server:document.getElementById("actdlgServer"),port:document.getElementById("actdlgPort"),domain:document.getElementById("actdlgDomain"),username:document.getElementById("actdlgUsername"),password:document.getElementById("actdlgPassword"),imapServer:document.getElementById("actdlgImapServer"),smtpServer:document.getElementById("actdlgSmtpServer"),smtpPort:document.getElementById("actdlgSmtpPort"),smtpUsername:document.getElementById("actdlgSmtpUsername"),smtpPassword:document.getElementById("actdlgSmtpPassword")},t=this._checkBoxes={ssl:document.getElementById("actdlgUseSsl"),smtpSsl:document.getElementById("actdlgSmtpUseSsl"),smtpRequiresAuth:document.getElementById("actdlgSmtpRequiresAuth"),smtpReuseCreds:document.getElementById("actdlgSmtpReuseCreds"),syncContactsAndCal:document.getElementById("actdlgSyncContactsAndCal")},u,f,r,e;this._status=document.getElementById("actdlgStatus");this._statusText=document.getElementById("actdlgStatusText");this._progress=document.getElementById("actdlgProgress");this._advancedLink=document.getElementById("actdlgShowAdvancedLink");this._descriptionText=document.getElementById("dlgDescription");this._container=document.getElementById(this._id);this._advancedLink.addEventListener("click",this._onAdvancedLink.bind(this),false);this._advancedLink.addEventListener("keydown",function(n){(n.key==="Spacebar"||n.key==="Enter")&&this._onAdvancedLink(n)}.bind(this),false);t.smtpRequiresAuth.addEventListener("change",function(){t.smtpReuseCreds.disabled=t.smtpRequiresAuth.checked?"":"disabled";this._updateSmtpCredInputsVisiblity()}.bind(this));t.smtpReuseCreds.addEventListener("change",this._updateSmtpCredInputsVisiblity.bind(this));t.syncContactsAndCal.addEventListener("change",function(){this._isImap=Jx.isObject(this._account.getServerByType(n.ServerType.imap))&&!this.syncContactsAndCal}.bind(this));t.ssl.addEventListener("change",function(){i.port.value=t.ssl.checked?993:143});t.smtpSsl.addEventListener("change",function(){i.smtpPort.value=t.smtpSsl.checked?465:25});this._reset();this.updateLayout(this._layoutMode);u=function(n){n.stopPropagation()};for(f in i)i[f].addEventListener("MSPointerDown",u,false);r=function(){var t=document.activeElement,n;for(n in i)if(i[n]===t){clearTimeout(e);document.removeEventListener("focus",r,true);break}};document.addEventListener("focus",r,true);e=setTimeout(function(){this.ensureValidFocus();document.removeEventListener("focus",r,true)}.bind(this),100);this._activated=true;Jx.Component.prototype.activateUI.call(this)};Object.defineProperty(r.prototype,"email",{get:function(){return this._inputs.email.value},set:function(n){this._inputs.email.value=n}});Object.defineProperty(r.prototype,"server",{get:function(){return this._isImap?this._inputs.imapServer.value:this._inputs.server.value}});Object.defineProperty(r.prototype,"port",{get:function(){return this._inputs.port.value}});Object.defineProperty(r.prototype,"useSsl",{get:function(){return this._checkBoxes.ssl.checked}});Object.defineProperty(r.prototype,"domain",{get:function(){return this._inputs.domain.value}});Object.defineProperty(r.prototype,"username",{get:function(){return this._inputs.username.value}});Object.defineProperty(r.prototype,"password",{get:function(){return this._inputs.password.value}});Object.defineProperty(r.prototype,"smtpServer",{get:function(){return this._inputs.smtpServer.value}});Object.defineProperty(r.prototype,"smtpPort",{get:function(){return this._inputs.smtpPort.value}});Object.defineProperty(r.prototype,"smtpUsername",{get:function(){return this._inputs.smtpUsername.value}});Object.defineProperty(r.prototype,"smtpPassword",{get:function(){return this._inputs.smtpPassword.value}});Object.defineProperty(r.prototype,"smtpUseSsl",{get:function(){return this._checkBoxes.smtpSsl.checked}});Object.defineProperty(r.prototype,"smtpRequiresAuth",{get:function(){return this._checkBoxes.smtpRequiresAuth.checked}});Object.defineProperty(r.prototype,"smtpReuseCreds",{get:function(){return this._checkBoxes.smtpReuseCreds.checked}});Object.defineProperty(r.prototype,"syncContactsAndCal",{get:function(){return this._checkBoxes.syncContactsAndCal.checked}});Object.defineProperty(r.prototype,"layoutMode",{get:function(){return this._layoutMode}});r.prototype.setDialogButtons=function(n,t){this._addButton=n;this._closeButton=t};r.prototype.showProgress=function(){var n=this._container.querySelector("#actdlgBarricadeError");n.hasChildNodes()&&(Jx.removeClass(this._fields,"hidden"),n.innerHTML="",this._addButton.value=i("actdlgAdd"),this._addButton.type="submit",this._closeButton.type="button");this._addButton.disabled=true;this._checkBoxes.syncContactsAndCal.disabled=true;Jx.addClass(this._status,"dlg-progress");Jx.addClass(this._descriptionText,"hidden");Jx.removeClass(this._status,"dlg-error");this._layoutMode===t.oauth?(this._statusText.innerText=i("actdlgStatus-OAuth"),this._addButton.hide(true)):this._statusText.innerText=this._mode===e.update||this._mode===e.updateSmtp?i("actdlgStatus-Updating"):i("actdlgStatus");this._statusText.scrollIntoView()};r.prototype.showError=function(n,t){this._addButton.value=t||i("actdlgAdd");this._addButton.hide(false);this._addButton.disabled=false;this._checkBoxes.syncContactsAndCal.disabled=false;Jx.addClass(this._status,"dlg-error");Jx.addClass(this._descriptionText,"hidden");Jx.removeClass(this._status,"dlg-progress");this._statusText.innerHTML=n||i("actdlgError");this._statusText.scrollIntoView()};r.prototype.showBarricadeError=function(n){Jx.removeClass(this._status,"dlg-progress");var t=this._container.querySelector("#actdlgBarricadeError"),r=this._fields=this._container.querySelector("#actdlgFieldsContainer");Jx.addClass(r,"hidden");t.innerHTML=Jx.getUI(n).html;n.activateUI();this._statusText.innerText=n.getErrorSummaryText();this._addButton.disabled=false;this._addButton.hide(false);this._addButton.value=i("actdlgConnectAnyway");this._addButton.type="button";this._closeButton.type="submit";this._closeButton.focus()};r.prototype.updateLayout=function(n){var r=document.getElementById("dlg-box");switch(n){case t.abbreviated:["intermediate","full","fullImap","dontReuseCreds","oauth"].forEach(function(n){Jx.removeClass(r,n)});Jx.addClass(r,"abbreviated");this._advancedLink.innerText=i("actdlgSeeMore");break;case t.intermediate:["full","fullImap","oauth"].forEach(function(n){Jx.removeClass(r,n)});Jx.addClass(r,"intermediate");this._advancedLink.innerText=i("actdlgSeeMore");break;case t.full:Jx.addClass(r,"full");this._advancedLink.innerText=i("actdlgSeeLess");break;case t.fullImap:Jx.addClass(r,"fullImap");this._advancedLink.innerText=i("actdlgSeeLess");break;case t.smtpOnly:["abbreviated","intermediate","full","fullImap","oauth"].forEach(function(n){Jx.removeClass(r,n)});Jx.addClass(r,"dontReuseCreds");this._advancedLink.innerText=i("actdlgSeeMore");break;case t.oauth:["abbreviated","intermediate","full","fullImap"].forEach(function(n){Jx.removeClass(r,n)});Jx.addClass(r,"oauth")}this._layoutMode=n};r.prototype.ensureValidFocus=function(){if(this.hasUI()){var n=this._inputs;this._allowEmailEditing?Jx.isNonEmptyString(this.email)&&!Jx.isNonEmptyString(this.password)&&this._layoutMode===t.abbreviated?n.password.focus():n.email.focus():n.password.focus()}};r.prototype.reapplyAccount=function(n){this._account=n;this._reset()};r.prototype._reset=function(){var i,r;if(this._layoutMode!==t.oauth){var f=this._checkBoxes,u=this._inputs,o=this._account;o&&(i=w(o)||{},r=o.getServerByType(n.ServerType.smtp)||{},this._isImap&&o.accountType===n.AccountType.imapAccountFactory&&(i={server:i.server,domain:i.domain,userId:i.userId,supportsAdvancedProperties:i.supportsAdvancedProperties,port:i.port,useSsl:i.useSsl},r={server:r.server,domain:r.domain,userId:r.userId,supportsAdvancedProperties:r.supportsAdvancedProperties,port:r.port,useSsl:r.useSsl},i.port=y(i.port)?i.port:993,r.port=y(r.port)?r.port:465,i.useSsl=true,r.useSsl=true,b(o,this._scenario)&&Jx.removeClass(f.syncContactsAndCal.parentElement,"hidden")),u.server.value=i.server,u.domain.value=i.domain,u.username.value=i.userId,this._isImap&&(u.imapServer.value=i.server,u.port.value=i.port,u.smtpPort.value=r.port,u.smtpServer.value=r.server,u.smtpUsername.value=r.userId,f.ssl.checked=i.useSsl,f.smtpSsl.checked=r.useSsl,f.smtpRequiresAuth.checked=true,f.smtpReuseCreds.checked=true),(i.supportsAdvancedProperties||this._mode===e.addPrimary)&&Jx.removeClass(document.querySelector(".actdlg-link"),"hidden"))}};r.prototype._updateSmtpCredInputsVisiblity=function(){var t=document.getElementById("dlg-box"),n=this._checkBoxes,i=n.smtpRequiresAuth.checked&&!n.smtpReuseCreds.checked?Jx.addClass:Jx.removeClass;i.call(Jx,t,"dontReuseCreds")};r.prototype._onAdvancedLink=function(n){if(n.preventDefault(),this._layoutMode!==t.full&&this._layoutMode!==t.fullImap)this._previousLayoutMode=this._layoutMode,this.updateLayout(this._isImap?t.fullImap:t.full);else{var i=this._previousLayoutMode;this._previousLayoutMode=this._layoutMode;this.updateLayout(i);this._reset()}Jx.safeSetActive(this._advancedLink)};a={expired:"Expired",mismatched:"MismatchedDomain",unknownCA:"UnknownCA"};Object.freeze(a);s=function(){this.initComponent();this._account=null;this._errors=[];this._shownError={}};Jx.augment(s,Jx.Component);Object.defineProperty(s.prototype,"expiredSeen",{get:function(){return this._shownError[this._account.emailAddress][a.expired]||false}});Object.defineProperty(s.prototype,"mismatchedDomainSeen",{get:function(){return this._shownError[this._account.emailAddress][a.mismatched]||false}});Object.defineProperty(s.prototype,"unknownCASeen",{get:function(){return this._shownError[this._account.emailAddress][a.unknownCA]||false}});s.prototype.setAccount=function(n){this._account=n;this._shownError[this._account.emailAddress]=this._shownError[this._account.emailAddress]||{}};s.prototype.updateError=function(){var i=this._account.getResourceByType(n.ResourceType.mail),t=[];i.serverCertificateExpired&&!this.expiredSeen&&t.push(a.expired);i.serverCertificateMismatchedDomain&&!this.mismatchedDomainSeen&&t.push(a.mismatched);i.serverCertificateUnknownCA&&!this.unknownCASeen&&t.push(a.unknownCA);this._errors=t};s.prototype.getUI=function(n){var t=this._errors.length>1?i("iceGenericMessage_multiple"):i("iceGenericMessage");n.html="<div class='iceDialogContent' aria-relevant='all' aria-atomic='false' aria-live='polite'><div class='dlg-subheader' role='heading'>"+t+"<\/div><br><div>"+i("actdlgICE_ImpactStatement")+"<\/div><br>"+this._errors.reduce(function(n,t){return n+"<div class='dlg-error'>"+s._getBriefErrorText(t)+"<\/div><div>"+s._getDetailedErrorText(t)+"<\/div><br>"},"")+"<div>"+i("actdlgICE_Recommendation")+"<\/div><\/div>"};s.prototype.getErrorSummaryText=function(){return i("iceGenericMessage")};s._getBriefErrorText=function(n){return i("ice_"+n+"_Brief")};s._getDetailedErrorText=function(n){return i("ice_"+n+"_Detailed")};s.prototype.activateUI=function(){Jx.Component.prototype.activateUI.call(this);Jx.log.info("IgnorableCertErrorContent.activateUI, error = "+this._error);this._errors.forEach(function(n){this._shownError[this._account.emailAddress][n]=true}.bind(this))}})