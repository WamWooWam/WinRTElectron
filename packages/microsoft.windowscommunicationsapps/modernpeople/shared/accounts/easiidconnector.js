Jx.delayDefine(People.Accounts,"checkForEasiId",function(){function o(n,t){for(var r,i=0;i<n.count;i++)if(r=n.item(i),r&&r.accountType===t)return r;return null}var r=window.People,t=r.Accounts,n=Microsoft.WindowsLive.Platform,f="completed",u="completedForPeopleAndCal",e=null,s=t.checkForEasiId=function(t,r){var s=t.accountManager.defaultAccount,o=(new Jx.AppData).localSettings().container(s.emailAddress).container("EasIdFirstRunFlow");if(!o.get(f)){if((r===n.ApplicationScenario.people||r===n.ApplicationScenario.calendar)&&o.get(u))return;e=new i(t,s,o,r);e.run()}},i=function(n,t,i,r){this._platform=n;this._account=t;this._settingsContainer=i;this._accountChangedListener=this._checkForEasiId.bind(this);this._scenario=r};i.prototype.run=function(){Jx.log.info("People.Accounts.EasiIdConnector.run");this._account.addEventListener("changed",this._accountChangedListener);this._checkForEasiId()};i.prototype._checkForEasiId=function(){var t,i,r;Jx.log.info("People.Accounts.EasiIdConnector._checkForEasiId");t=this._account;t.mailScenarioState!==n.ScenarioState.unknown&&(Jx.log.info("People.Accounts.EasiIdConnector._checkForEasiId, mailScenarioState="+t.mailScenarioState),t.removeEventListener("changed",this._accountChangedListener),t.isEasi?(i=t.getResourceByType(n.ResourceType.accounts),Jx.isNullOrUndefined(i)||(r=this._resourceChangedListener=this._checkSyncStatus.bind(this,i),i.addEventListener("changed",r),this._checkSyncStatus(i))):this._markCompleted())};i.prototype._checkSyncStatus=function(i){var h,l,e,s;if(Jx.log.info("People.Accounts.EasiIdConnector._checkSyncStatus"),i.isInitialSyncFinished){i.removeEventListener("changed",this._resourceChangedListener);var f=this._account,r=null,a=t.AccountDialogMode.easiID,c=this._platform.accountManager.getConnectedAccountsByScenario(n.ApplicationScenario.mail,n.ConnectedFilter.normal,n.AccountSort.name);for(h=0,l=c.count;h<l;h++)if(e=c.item(h),!e.isDefault&&e.emailAddress===f.emailAddress){if(e.lastAuthResult===n.Result.credentialMissing)r=e,this._launchAddAccountDialog(r,t.AccountDialogMode.update);else{this._markCompleted();return}break}if(!r)if(r=this._platform.accountManager.getConnectableAccountByEmailDomain("",f.emailAddress),Jx.isNullOrUndefined(r))this._scenario===n.ApplicationScenario.mail?this._showChooseAccountTypeDialog(f):this._showVerifyEasDialog(f);else if(r.accountType===n.AccountType.popAccountFactory)if(this._scenario===n.ApplicationScenario.mail)this._showPopNotSupportedDialog();else{this._markCompleted(u);return}else{if(s=r.getOtherConnectableAccounts(n.ApplicationScenario.mail),s&&s.count>0)this._scenario===n.ApplicationScenario.mail&&r.accountType!==n.AccountType.imapAccountFactory?r=o(s,n.AccountType.imapAccountFactory)||r:this._scenario!==n.ApplicationScenario.mail&&r.accountType!==n.AccountType.easAccountFactory&&(r=o(s,n.AccountType.easAccountFactory)||r);else if(r.accountType===n.AccountType.imapAccountFactory&&this._scenario!==n.ApplicationScenario.mail){this._markCompleted(u);return}this._launchAddAccountDialog(r,t.AccountDialogMode.easiID,f.emailAddress)}}};i.prototype._showChooseAccountTypeDialog=function(i){var r=new t.AccountBarricadeDialog(i,function(){this._markCompleted()}.bind(this));r.showChooseAccountTypeDialog(function(r){var u="";switch(r){case n.AccountType.easAccountFactory:u="EXCH";case n.AccountType.imapAccountFactory:i=this._platform.accountManager.getAccountBySourceId(Jx.isNonEmptyString(u)?u:"IMAP","");this._launchAddAccountDialog(i,t.AccountDialogMode.easiID,this._account.emailAddress)}}.bind(this))};i.prototype._showVerifyEasDialog=function(n){var i=new t.AccountBarricadeDialog(n,function(){this._markCompleted(u)}.bind(this));i.showIsEasDialog(function(){n=this._platform.accountManager.getAccountBySourceId("EXCH","");this._launchAddAccountDialog(n,t.AccountDialogMode.easiID,this._account.emailAddress)}.bind(this),function(){this._markCompleted(u)}.bind(this))};i.prototype._showPopNotSupportedDialog=function(){var n=new t.AccountBarricadeDialog(this._account,function(){this._markCompleted()}.bind(this));n.showPopNotSupportedDialog(r.Bici.EntryPoint.easiFlow,this._account.emailAddress)};i.prototype._launchAddAccountDialog=function(n,i,u){var e=new t.AccountDialog(n,i,this._scenario,this._platform,r.Bici.EntryPoint.easiFlow,u),f=function(){this._markCompleted();Jx.EventManager.removeListener(Jx.root,r.DialogEvents.closed,f,this)};Jx.EventManager.addListener(Jx.root,r.DialogEvents.closed,f,this);e.show()};i.prototype._markCompleted=function(n){n=n||f;this._settingsContainer.set(n,true)}})