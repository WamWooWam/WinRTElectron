Jx.delayDefine(People.Accounts,["CertificateSettingsControl","CertificateUtils","CertPromptResult"],function(){function t(n){return Jx.res.getString("/accountsStrings/"+n)}var o=window.People,i=o.Accounts,r=Microsoft.WindowsLive.Platform,s=Windows.Globalization.DateTimeFormatting,u=Windows.Security.Cryptography,l=u.Certificates,e=["serverCertificateExpired","serverCertificateMismatchedDomain","serverCertificateUnknownCA"],f=["ignoreServerCertificateExpired","ignoreServerCertificateMismatchedDomain","ignoreServerCertificateUnknownCA"],c=["Expired","MismatchedDomain","UnknownCA"],n=i.CertificateSettingsControl=function(n,t){this.initComponent();this._iceControlsActive=false;this._platform=n;this._account=t;this._selectedCert=null;this._settings=t.getServerByType(r.ServerType.eas)||t.getServerByType(r.ServerType.imap);this._smtpSettings=t.getServerByType(r.ServerType.smtp);this._mailResource=t.getResourceByType(r.ResourceType.mail);Jx.isNullOrUndefined(this._mailResource)&&(this.getUI=null)},h;Jx.augment(n,Jx.Component);Object.defineProperty(n.prototype,"selectedCertificate",{get:function(){return this._selectedCert}});n.prototype.getUI=function(n){this._id="idCertificateSettings"+Jx.uid();n.html="<div id='"+this._id+"'><div id='pasIgnorableCertSettingsContainer' class='hidden pas-settingGroup'><div id='pasIgnorableCertErrorStatus' role='status' class='pas-inlineAdvise pas-tooltipCheck' data-associatedControl='pasIgnoreCertErrors'><\/div><div id='pasDetailedCertErrors' class='hidden pas-inlineAdvise'><\/div><div class='pas-checkbox'><label><input id='pasIgnoreCertErrors' type='checkbox' aria-label='"+Jx.escapeHtml(t("pasIgnoreCertErrors"))+"'>"+t("pasIgnoreCertErrors")+"<\/label><\/div><\/div><div id='pasCertificateBaseAuthSettingsContainer' class='hidden pas-settingGroup'><div id='pasCertificateBaseAuthError' role='status' class='hidden pas-inlineAdvise pas-tooltipCheck' data-associatedControl='pasShowCertsLink'>"+t("pasCertificateRequiredError")+"<\/div><div id='pasCertSelectionContainer' class='hidden'><label class='pas-tooltipCheck'>"+Jx.escapeHtml(t("pasCertificateLabel"))+"<\/label><div class='pas-link'><a id='pasShowCertsLink' tabIndex='0'>"+Jx.escapeHtml(t("pasChoose"))+"<\/a><\/div><div id='pasSelectedCert'><\/div><\/div><\/div><\/div>"};n.prototype.activateUI=function(){var n,u,o,s,i,f;Jx.Component.prototype.activateUI.call(this);n=this._container=document.getElementById(this._id);(this._ignorableCertErrorPresent()||this._certErrorIgnored())&&(this._iceControlsActive=true,u=n.querySelector("#pasIgnoreCertErrors"),Jx.removeClass(n.querySelector("#pasIgnorableCertSettingsContainer"),"hidden"),this._ignorableCertErrorPresent()||(u.checked=true),o=e.filter(function(n){return this._mailResource[n]}.bind(this)),s=o.length>1?t("iceGenericMessage_multiple"):t("iceGenericMessage"),n.querySelector("#pasIgnorableCertErrorStatus").innerHTML=Jx.res.loadCompoundString("/accountsStrings/pasIgnorableCertDetailsLink",s),i=n.querySelector("#pasIgnorableCertErrorStatus").querySelector("a"),i.tabIndex=0,i.id="pasShowDetailsLink",i.addEventListener("click",this._showDetails.bind(this,true),false),i.addEventListener("keydown",function(n){(n.key==="Spacebar"||n.key==="Enter")&&this._showDetails(true)}.bind(this),false),u.addEventListener("change",function(){u.checked&&this._showDetails(false)}.bind(this)));this._isCbaAccount()&&(Jx.removeClass(n.querySelector("#pasCertificateBaseAuthSettingsContainer"),"hidden"),this._setupCertSelectionUI(),Jx.setClass(n.querySelector("#pasCertificateBaseAuthError"),"hidden",this._mailResource.lastSyncResult!==r.Result.e_SYNC_CBA_FAILED),Jx.isObject(this._settings.certificateThumbPrint)&&(f=this._platform.accountManager.queryForCertificate(this._settings.certificateThumbPrint),Jx.isObject(f)&&(this._selectedCert=f,n.querySelector("#pasSelectedCert").innerHTML=this._generateCertItemHtml(f))))};n.prototype._isCbaAccount=function(){return this._mailResource.lastSyncResult===r.Result.e_SYNC_CBA_FAILED||Jx.isObject(this._settings.certificateThumbPrint)};n.prototype._setupCertSelectionUI=function(){var i=this._availableCerts=this._platform.accountManager.queryForCertificateCollection(this._account),n,t;Jx.isObject(i)&&i.count>0&&(n=this._container,Jx.removeClass(n.querySelector("#pasCertSelectionContainer"),"hidden"),t=n.querySelector("#pasShowCertsLink"),t.addEventListener("click",this._showCerts.bind(this),false),t.addEventListener("keydown",function(n){(n.key==="Spacebar"||n.key==="Enter")&&this._showCerts()}.bind(this),false))};n.prototype._ignorableCertErrorPresent=function(){return e.some(function(n){return this._mailResource[n]}.bind(this))};n.prototype._certErrorIgnored=function(){return f.some(function(n){return this._settings[n]}.bind(this))};n.prototype._showDetails=function(n){var r="",i=this._container.querySelector("#pasDetailedCertErrors");i.hasChildNodes()||(e.forEach(function(n,i){if(this._mailResource[n]||this._settings[f[i]]){var u=c[i];r+="<div>"+t("ice_"+u+"_Brief")+"<\/div><div>"+t("ice_"+u+"_Detailed")+"<\/div><br>"}}.bind(this)),i.innerHTML=r);Jx.setClass(this._container.querySelector("#pasShowDetailsLink"),"hidden",n);Jx.setClass(i,"hidden",!n)};n.prototype._showCerts=function(){var n,t,i,f;var r=this._availableCerts,e=function(n){return Jx.isObject(this._selectedCert)?this._certsMatch(n.thumbPrint,this._selectedCert.thumbPrint):false}.bind(this),u=[];for(n=0;n<r.count;n++)t=r.item(n),u.push({html:this._generateCertItemHtml(t),id:n,selected:e(t),onItemSelected:this._onCertSelected.bind(this,t)});i=new o.Flyout(u);f=i.getFlyoutElement();Jx.addClass(f,"certMenu");i.show(this._container.querySelector("#pasShowCertsLink"),"top","left",function(){i.dispose()}.bind(this))};n.prototype._onCertSelected=function(n){this._selectedCert=n;this._container.querySelector("#pasSelectedCert").innerHTML=this._generateCertItemHtml(n)};n.prototype._certsMatch=function(n,t){if(!n||!t)return false;var i=Array.prototype.reduce.call(n,function(n,t){return n+t},""),r=Array.prototype.reduce.call(t,function(n,t){return n+t},"");return i===r};n.prototype._generateCertItemHtml=function(n){var t=s.DateTimeFormatter.shortDate.format(n.validFrom),i=s.DateTimeFormatter.shortDate.format(n.validTo);return"<div class='pas-certItem'><div>"+Jx.escapeHtml(n.subject)+"<\/div><div class='typeSizeSmall'>"+Jx.escapeHtml(Jx.res.loadCompoundString("/accountsStrings/pasCertIssuer",Jx.escapeHtml(n.issuer)))+"<\/div><div class='typeSizeSmall'>"+Jx.escapeHtml(Jx.res.loadCompoundString("/accountsStrings/pasCertValidFrom",t,i))+"<\/div><\/div>"};n.prototype.applyChanges=function(){var t=false,n;return this.hasUI()&&(this._iceControlsActive&&(n=this._container.querySelector("#pasIgnoreCertErrors"),e.forEach(function(i,r){(this._mailResource[i]||this._settings[f[r]])&&this._settings[f[r]]!==n.checked&&(t=true,this._settings[f[r]]=n.checked,this._smtpSettings&&(this._smtpSettings[f[r]]=n.checked),n.checked&&(this._mailResource[i]=false))}.bind(this))),Jx.isObject(this._selectedCert)&&!this._certsMatch(this._selectedCert.thumbPrint,this._settings.certificateThumbPrint)&&(this._settings.certificateThumbPrint=this._selectedCert.thumbPrint,t=true)),t};i.CertificateUtils={};h=i.CertPromptResult={accessGranted:"Accounts.CertPromptResult.accessGranted",accessDenied:"Accounts.CertPromptResult.accessDenied",failedToOpenKey:"Accounts.CertPromptResult.failedToOpenKey"};Object.freeze(h);i.CertificateUtils.invokeCertificatePromptIfNeededAsync=function(n){Jx.log.info("Running invokeCertificatePromptIfNeeded");var t=n.certificate,r=u.Core.PersistedKeyProvider.openKeyPairFromCertificateAsync;return r(t,u.Core.HashAlgorithmNames.sha1,u.Core.CryptographicPadding.rsaPkcs1V15).then(function(n){if(Jx.isObject(n)){var t=n,f=t.keySize,r=u.CryptographicBuffer.generateRandom(1);return u.Core.CryptographicEngine.signAsync(t,r)}return WinJS.Promise.wrapError(i.CertPromptResult.failedToOpenKey)}).then(function(){return Jx.log.info("invokeCertificatePromptIfNeededAsync successful"),WinJS.Promise.wrap(i.CertPromptResult.accessGranted)},function(n){return Jx.log.exception("Exception in invokeCertificatePromptIfNeededAsync",n),WinJS.Promise.wrapError(i.CertPromptResult.accessDenied)})}})