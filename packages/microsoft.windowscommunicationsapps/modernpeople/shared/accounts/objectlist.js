Jx.delayDefine(People.Accounts,"ObjectListControl",function(){var i=window.People.Accounts,t=Microsoft.WindowsLive.Platform,n=i.ObjectListControl=function(n,t){this._elContainer=null;this._elItemTemplate=null;this._selection={object:null,item:null};this._collection=null;this._focusListener=this._onLoseFocus.bind(this);this._objectChangeListener=this._onObjectChanged.bind(this);this._childObjectChangeListener=this._onChildObjectChanged.bind(this);this._name=n;this._childIdToParent={};t=t||{};this._selectionEnabled=!!t.selectionEnabled;this._delayRender=!!t.delayRender;this.initComponent()};Jx.augment(n,Jx.Component);n.prototype.getUI=function(n){this._id="id"+this._name+"_"+Jx.uid();n.html="<div id='"+this._id+"' role='list'><\/div>"};n.prototype.activateUI=function(){this._elContainer=document.getElementById(this._id);this._selectionEnabled&&this._elContainer.addEventListener("MSPointerDown",this._onPointerDown.bind(this),false);this._elContainer.addEventListener("click",this._onClick.bind(this),false);this._elContainer.addEventListener("keydown",this._onKeyDown.bind(this),false);this._elContainer.addEventListener("keyup",this._onKeyUp.bind(this),false);this._collection=this._collection||this._getCollection();this._delayRender||this._populateList();Jx.Component.prototype.activateUI.call(this)};n.prototype.render=function(){this._delayRender&&this._populateList();this._delayRender=false};n.prototype.getCount=function(){var n=0,t=this._collection=this._collection||this._getCollection();return t!==null&&(n=this._collection.count),n};n.prototype._updateObjectData=function(n){var t=this._findObjectIndex(n),i;t!==-1&&(i=this._findElementByObjectIndex(t),this._applyObject(i,n))};n.prototype.setInitialSelection=function(n){this._selection={object:n,item:null}};n.prototype._verticalNavigate=function(n){for(var t=this._elContainer.querySelector("div :focus");t!==null&&t.parentElement!==this._elContainer;)t=t.parentElement;t&&(n>0?t.nextSibling&&this._switchFocus(t,t.nextSibling):t.previousSibling&&this._switchFocus(t,t.previousSibling))};n.prototype._switchFocus=function(n,t){n.tabIndex=-1;n.removeEventListener("blur",this._focusListener);t.tabIndex=0;t.addEventListener("blur",this._focusListener);t.focus()};n.prototype._getCollection=function(){};n.prototype._getChildObject=function(){return null};n.prototype._populateList=function(){this._collection!==null&&(this._collectionChangeListener=this._onCollectionChanged.bind(this),this._collection.addEventListener("collectionchanged",this._collectionChangeListener),this._createAllElements(),Jx.EventManager.fire(this,"ready",null,null))};n.prototype._createAllElements=function(){for(var r=this._collection.count,i,t,u,n=0;n<r;n++)i=this._getNewObjectItem(),this._applyObject(i,this._collection.item(n)),this._elContainer.appendChild(i),this._setAriaIndex(i,n+1,r);this._fixTabAccessibility();this._selectionEnabled&&(t=r>0?0:-1,this._selection.object!==null&&(t=this._findObjectIndex(this._selection.object)),t!==-1&&(u=this._findElementByObjectIndex(t),this._selection.object=this._collection.item(t),this._selection.item=u,this._addSelectionStyle(u)))};n.prototype._removeAllElements=function(){var n,t;if(this._elContainer!==null){for(n=0;n<this._elContainer.children.length;n++)t=this._elContainer.children[n],this._unhookEventsForItem(t),t.__object=null,t.__childObject=null;this._elContainer.innerText=""}};n.prototype._unhookEventsForItem=function(n){Jx.isObject(n.__object)&&(n.__object.removeEventListener("changed",this._objectChangeListener),Jx.isObject(n.__childObject)&&n.__childObject.removeEventListener("changed",this._childObjectChangeListener))};n.prototype._fixTabAccessibility=function(){this._elContainer.children.length>0&&(this._elContainer.firstChild.tabIndex=0)};n.prototype._setAriaIndex=function(n,t,i){n.setAttribute("aria-posinset",t.toString());n.setAttribute("aria-setsize",i.toString())};n.prototype._fixAriaIndicesFrom=function(n){var i,r,t;for(i=this._elContainer.children,r=i.length,t=n;t<r;t++)this._setAriaIndex(i[t],t+1,r)};n.prototype._getNewObjectItem=function(){};n.prototype._applyObject=function(n,t){if(!Jx.isObject(n.__object)||n.__object.objectId!==t.objectId){this._unhookEventsForItem(n);t.addEventListener("changed",this._objectChangeListener,false);var i=this._getChildObject(t);Jx.isObject(i)&&(this._childIdToParent[i.objectId]=t,n.__childObject=i,i.addEventListener("changed",this._childObjectChangeListener,false));n.__object=t}};n.prototype._handlePrimaryAction=function(){};n.prototype._onPointerDown=function(n){var t=this._findObjectItemByInputEvent(n);t!==null&&People.Animation.startTapAnimation(t,n)};n.prototype._onClick=function(n){var t=this._findObjectItemByInputEvent(n),i;t!==null&&(i=this._findObjectByElement(t),this._selectObject(i,t),this._handlePrimaryAction(i))};n.prototype._selectObject=function(n,t){if(this._selectionEnabled){var i=this._selection;(this._selection.object===null||n===null||this._selection.object.objectId!==n.objectId)&&(t&&this._addSelectionStyle(t),this._selection={object:n,item:t},i.item!==null&&this._removeSelectionStyle(i.item),Jx.EventManager.fire(this,"selectionChanged",{object:n},null))}};n.prototype._addSelectionStyle=function(n){Jx.addClass(n,"selected");n.ariaSelected=true};n.prototype._removeSelectionStyle=function(n){Jx.removeClass(n,"selected");n.ariaSelected=false};n.prototype._onKeyDown=function(n){["Up","Down"].indexOf(n.key)>=0&&(this._verticalNavigate(n.key==="Up"?-1:1),n.preventDefault())};n.prototype._onKeyUp=function(n){(n.key==="Spacebar"||n.key==="Enter")&&this._onClick(n)};n.prototype._onLoseFocus=function(n){var t=this._findObjectItemByInputEvent(n);t&&(this._controlHasFocus()||(t.tabIndex=-1,this._fixTabAccessibility()))};n.prototype._controlHasFocus=function(){var n=this._elContainer.querySelector("div :focus");return n!==null};n.prototype._findObjectItemByInputEvent=function(n){for(var t=n.target;t!==null&&t.parentElement!==this._elContainer;)t=t.parentElement;return t};n.prototype._findObjectByMouseEvent=function(n){var t=null,i=this._findObjectItemByInputEvent(n);return i!==null&&(t=this._findObjectByElement(i)),t};n.prototype._findObjectByElement=function(n){return n.__object};n.prototype._findElementByObjectIndex=function(n){return this._elContainer.children[n]||null};n.prototype._findObjectIndex=function(n){for(var i=-1,t=0;t<this._collection.count;t++)if(this._collection.item(t).objectId===n.objectId){i=t;break}return i};n.prototype._onObjectChanged=function(n){var t=n.target,i=this._findObjectIndex(t);i!==-1&&this._applyObject(this._findElementByObjectIndex(i),t)};n.prototype._onChildObjectChanged=function(n){var t=this._childIdToParent[n.target.objectId];t&&this._applyObject(this._findElementByObjectIndex(this._findObjectIndex(t)),t)};n.prototype._onCollectionChanged=function(n){var i=n.detail[0],r=null;switch(i.eType){case t.CollectionChangeType.itemAdded:this._addObject(this._collection.item(i.index),i.index);Jx.EventManager.fire(this,"objectAdded",{object:this._collection.item(i.index)},null);Jx.log.info("ObjectListControl._onCollectionChanged, changeType: add, change.index: "+i.index+", objectId = "+i.objectId);break;case t.CollectionChangeType.itemRemoved:r=this._findElementByObjectIndex(i.index);r&&(this._removeObjectItem(r),Jx.EventManager.fire(this,"objectRemoved",{objectId:i.objectId},null));Jx.log.info("ObjectListControl._onCollectionChanged, changeType: remove, change.index: "+i.index+", objectId = "+i.objectId);break;case t.CollectionChangeType.itemChanged:r=this._findElementByObjectIndex(i.previousIndex);this._moveObjectItem(r,i.index,i.previousIndex);Jx.log.info("ObjectListControl._onCollectionChanged, changeType: move, change.index: "+i.index+", change.previousIndex = "+i.previousIndex);break;case t.CollectionChangeType.reset:this._removeAllElements();this._createAllElements()}};n.prototype._addObject=function(n,t){var i=this._getNewObjectItem(),r,e,o;this._applyObject(i,n);var u=this._elContainer.children,s=u.length,f=[];for(r=0;r<s;r++)f.push(u[r]);e=WinJS.UI.Animation.createAddToListAnimation(i,f);o=this._elContainer.children[t]||null;this._elContainer.insertBefore(i,o);this._controlHasFocus()||this._fixTabAccessibility();this._fixAriaIndicesFrom(t);this._collection.count===1&&this._selectionEnabled&&this._selectObject(n,i);e.execute()};n.prototype._removeObjectItem=function(n){for(var r=this._elContainer.children,o=r.length,u=0,f=[],e,t,i=0;i<o;i++)r[i].id!==n.id?f.push(r[i]):u=i;e=WinJS.UI.Animation.createDeleteFromListAnimation(n,f);this._selection.item!==null&&this._selection.item.id===n.id&&(t=null,n.previousSibling!==null?t=n.previousSibling:n.nextSibling!==null&&(t=n.nextSibling));this._unhookEventsForItem(n);this._elContainer.removeChild(n);t!==undefined&&this._selectObject(t?this._findObjectByElement(t):null,t);this._fixTabAccessibility();this._fixAriaIndicesFrom(u);e.execute()};n.prototype._moveObjectItem=function(n,t,i){var u=WinJS.UI.Animation.createRepositionAnimation(n),r;this._elContainer.removeChild(n);r=this._elContainer.children[t]||null;this._elContainer.insertBefore(n,r);this._controlHasFocus()||this._fixTabAccessibility();this._fixAriaIndicesFrom(Math.min(n,i));u.execute()};n.prototype.deactivateUI=function(){this._removeAllElements();Jx.isFunction(this._collectionChangeListener)&&(this._collection.removeEventListener("collectionchanged",this._collectionChangeListener),this._collectionChangeListener=null);Jx.dispose(this._collection);this._collection=null;Jx.Component.prototype.deactivateUI.call(this)};n.prototype.shutdownUI=function(){this._platform=null;Jx.Component.prototype.shutdownUI.call(this)}})