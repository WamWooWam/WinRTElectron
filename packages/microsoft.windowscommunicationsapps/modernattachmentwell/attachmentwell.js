Jx.delayDefine(window,"AttachmentWell",function(){window.AttachmentWell={AttachmentManager:{},Base:{},Read:{},Compose:{},DownloadSaveAllControl:{},ErrorManager:{},FilesAttachedControl:{},Templates:{},ShareAnythingControl:{},ShareAnything:{},Utils:{},ThumbnailResizer:{}},function(){var t=Microsoft.WindowsLive.Platform.AttachmentComposeStatus,i={count:1e3,sizeInBytes:26214400},n;AttachmentWell.AttachmentManager=function(n,t){this.initComponent();this._mailManager=n;this._mailMessage=t;this._changedListeners=[];this._attachmentManager=Microsoft.WindowsLive.Photomail.AttachmentManager.getManager(t.objectId);this._attachmentObjects={};this._attachmentSizes={};this._pendingAttachments={};this._failedAttachments={};this._attachmentCollection=t.getOrdinaryAttachmentCollection();this._attachmentChanged=this._attachmentChanged.bind(this);this._attachmentCollectionChanged=this._attachmentCollectionChanged.bind(this)};Jx.augment(AttachmentWell.AttachmentManager,Jx.Component);n=AttachmentWell.AttachmentManager.prototype;n.activate=function(){var n,t,r,i;for(this._attachmentCollection.addEventListener("collectionchanged",this._attachmentCollectionChanged),t=0,r=this._attachmentCollection.count;t<r;t++)n=this._attachmentCollection.item(t),n.addEventListener("changed",this._attachmentChanged),i=n.objectId,this._attachmentObjects[i]=n,this._update(i);this._isDirty=false;this._attachmentCollection.unlock();this._attachmentQueueEmpty=this._attachmentQueueEmpty.bind(this);this._attachmentManager.addEventListener("attachqueueempty",this._attachmentQueueEmpty)};n.addFiles=function(n){var i,r,t,u;if(this.canAddMore(n.length)){for(i=[],r=n.length,t=0;t<r;t++)i.push(n[t]);this.fire("clearerror",{errorId:AttachmentWell.ErrorIds.maxFiles});Jx.EventManager.fire(null,"attachstarted",{});this._attachmentManager.addFiles(i)}else u=new AttachmentWell.Error(AttachmentWell.ErrorIds.maxFiles,Jx.res.getString("composeMaxFilesErrorMessage")),this.fire("error",{error:u})};n.isAttaching=function(n){return this._attachmentManager.isAttaching(n||"")};n.isDirty=function(){return this._isDirty};n.canAddMore=function(n){return this._attachmentCollection.count+n<=i.count};n.canSendMail=function(){var n=this.isAttaching(""),t,i,r;return n&&(this._attachStartTime||(this._attachStartTime=(new Date).getTime()),t=new AttachmentWell.Error(AttachmentWell.ErrorIds.inProgress,Jx.res.getString("composeInProgressErrorMessage")),this.fire("error",{error:t}),this._numberOfValidateFailures++),i=Object.keys(this._failedAttachments).length,r=i>0,!n&&!r};n.removeFailedFiles=function(){Object.keys(this._failedAttachments).forEach(function(n){this.removeFile(n)},this)};n.finalizeForSend=function(){this._attachmentManager.finalizeForSend()};n.removeFile=function(n){this._attachmentManager.removeFile(n)};n.fileCategoryMap=[0,1,4,2,5,5,5,3,7,7,7,6,7,7,7];n.getAttachmentMetrics=function(){var n=0,i=0,r=/\.((doc)|(docx)|(xls)|(xlsx)|(ppt)|(pptx))$/i;return Object.keys(this._attachmentObjects).forEach(function(u){var f=this._attachmentObjects[u],e;Boolean(f)&&f.composeStatus===t.done&&(e=f.contentType,n|=e.indexOf("image")>=0?1:e.indexOf("video")>=0?2:f.fileName.match(r)?4:8,i++)},this),{totalSize:Math.round(this._totalAttachmentSize/1024),category:this.fileCategoryMap[n-1]||0,count:i,duration:Math.round(this._totalAttachDuration/1e3),validateFailures:this._numberOfValidateFailures}};n.discard=function(){this._attachmentManager.discard()};n.shutdown=function(){try{this._removeAttachmentListeners();this._attachmentManager.stopAll();this._attachmentManager.dispose();this._attachmentManager=null}catch(n){}};n._removeAttachmentListeners=function(){this._attachmentManager.removeEventListener("attachqueueempty",this._attachmentQueueEmpty);this._attachmentCollection.lock();this._attachmentCollection.removeEventListener("collectionchanged",this._attachmentCollectionChanged);Object.keys(this._attachmentObjects).forEach(function(n){var t=this._attachmentObjects[n];t&&t.removeEventListener("changed",this._attachmentChanged)},this);this._attachmentObjects={}};n._attachmentChanged=function(n){var i,r,u;i=n.target.objectId;r=this._attachmentObjects[i];r&&(this.fire("attachmentchanged",{id:i,dbObject:r}),u=r.composeStatus,(u===t.failed||u===t.done)&&(delete this._pendingAttachments[i],this._checkAndFireQueueEmpty()));this._update(i)};n._attachmentCollectionChanged=function(n){var i,r,u,f;i=n.objectId;n.eType===Microsoft.WindowsLive.Platform.CollectionChangeType.itemAdded?(this._isDirty=true,r=this._attachmentCollection.item(n.index),this._attachStartTime||(this._attachStartTime=(new Date).getTime()),r.addEventListener("changed",this._attachmentChanged),this._attachmentObjects[i]=r,u=r.composeStatus,u!==t.failed&&u!==t.done&&(this._pendingAttachments[i]=true),this.fire("attachmentadded",{id:i,dbObject:r})):n.eType===Microsoft.WindowsLive.Platform.CollectionChangeType.itemRemoved&&(this._isDirty=true,delete this._pendingAttachments[i],f=this._attachmentObjects[i],f&&(f.removeEventListener("changed",this._attachmentChanged),delete this._attachmentObjects[i],this.fire("attachmentremoved",{id:i,dbObject:null})),this._checkAndFireQueueEmpty());this._update(i)};n._update=function(n){var t=this._attachmentObjects[n]||null;this._updateFailedAttachments(n,t);this._updateTotalAttachmentSize(n,t)};n._updateFailedAttachments=function(n,i){var f=Boolean(i),r,u,e,o;if(f&&i.composeStatus===t.failed)this._failedAttachments[n]=true;else if((!f||i.composeStatus!==t.failed)&&this._failedAttachments[n]&&(delete this._failedAttachments[n],Object.keys(this._failedAttachments).length===0)){this.fire("clearerror",{errorId:AttachmentWell.ErrorIds.attachFailed});return}r=Object.keys(this._failedAttachments).length;u=this._attachmentCollection.count;r>0&&(e=r===1&&u>1?Jx.res.getString("composeOneAttachFailedErrorMessage"):r===u?u===1?Jx.res.getString("composeOneOfOneAttachFailedErrorMessage"):Jx.res.getString("composeAllAttachFailedErrorMessage"):Jx.res.getString("composeMultipleAttachFailedErrorMessage"),o=new AttachmentWell.Error(AttachmentWell.ErrorIds.attachFailed,e),this.fire("error",{error:o}))};n._updateTotalAttachmentSize=function(n,t){var f=this._totalAttachmentSize,o=this._attachmentSizes[n]||0,u,r,e;this._totalAttachmentSize-=o;u=t?t.size:0;this._totalAttachmentSize+=u;t?this._attachmentSizes[n]=u:delete this._attachmentSizes[n];r=i.sizeInBytes;f>=r&&this._totalAttachmentSize<r?this.fire("clearerror",{errorId:AttachmentWell.ErrorIds.maxBasicAttachmentsSize}):f<r&&this._totalAttachmentSize>=r&&(e=new AttachmentWell.Error(AttachmentWell.ErrorIds.maxBasicAttachmentsSize,Jx.res.getString("composeMaxBasicAttachmentsSizeErrorMessage")),this.fire("error",{error:e}))};n._attachmentQueueEmpty=function(){this._needToFireAttachComplete=true;this._checkAndFireQueueEmpty()};n._checkAndFireQueueEmpty=function(){this._needToFireAttachComplete&&Object.keys(this._pendingAttachments).length===0&&(this.fire("clearerror",{errorId:AttachmentWell.ErrorIds.inProgress}),this._attachStartTime>0&&(this._totalAttachDuration+=(new Date).getTime()-this._attachStartTime,this._attachStartTime=0),Jx.EventManager.fire(null,"attachcomplete",{}),this._needToFireAttachComplete=false)};n._mailManager=null;n._mailMessage=null;n._attachmentManager=null;n._attachmentCollection=null;n._attachmentCount=0;n._attachmentObjects=null;n._attachmentSizes=null;n._totalAttachmentSize=0;n._changedListeners=null;n._pendingAttachments=null;n._failedAttachments=null;n._totalAttachDuration=0;n._attachStartTime=0;n._numberOfValidateFailures=0;n._isDirty=null;n._needToFireAttachComplete=false}(),function(){var n=AttachmentWell.Templates={errorMessage:function(n){for(var t=n.error,r='<div data-errorId="'+t.id+'" class="attachmentWell-error-message">'+Jx.escapeHtml(t.message),i=0,u=t.commands.length;i<u;i++)r+='<button class="attachmentWell-error-command" type="button">'+t.commands[i].label+"<\/button>";return r+"<\/div>"},basicProperties:function(n){return'<li class="attachmentWell-item-property-fileName">'+Jx.escapeHtml(n.name)+'<\/li><li class="attachmentWell-item-property-fileExtension">'+Jx.escapeHtml(n.fileExtension)+'<\/li><li class="attachmentWell-item-property-fileSize">'+Jx.escapeHtml(n.fileSize)+"<\/li>"},properties:function(t){return'<ul class="attachmentWell-item-properties">'+n.basicProperties(t)+"<\/ul>"},image:function(n,t,i){return i=i?i:"",'<img class="'+i+'" src="'+t+'" alt="'+Jx.escapeHtml(n.name)+'">'},defaultImage:function(t,i,r){return n.image(t,"/resources/modernattachmentwell/images/"+i,r)},fileIcon:function(t){return t.isEml?'<div class="attachmentWell-item-status">'+n.defaultImage(t,"emlIcon.png","attachmentWell-photo-video-icon")+"<\/div>":t.fileIconUrl?'<div class="attachmentWell-item-status"><img src="'+t.fileIconUrl+'" alt="'+Jx.escapeHtml(t.name)+'" height="'+t.fileIconHeight+'" width="'+t.fileIconWidth+'"><\/div>':'<div class="attachmentWell-item-status attachmentWell-item-placeholder">'+n.defaultImage(t,"default.png","attachmentWell-default-icon")+"<\/div>"},photoVideoItemPlaceholder:function(t){return'<div class="attachmentWell-item-photoVideo attachmentWell-item-placeholder" aria-hidden="true">'+n.defaultImage(t,"default.png","attachmentWell-default-icon")+"<\/div>"},videoItem:function(t){return'<div class="attachmentWell-item-photoVideoDone" aria-hidden="true">'+n.image(t,t.thumbnailUrl)+'<div class="attachments-videoInfo" aria-hidden="true"><div class="videoPlayGlyph"><\/div><\/div><\/div>'},photoItem:function(n){return'<div class="attachmentWell-item-photoVideoDone" aria-hidden="true"><img src="'+n.thumbnailUrl+'"><\/div>'},otherItem:function(t){return'<div class="attachmentWell-item-other attachmentWell-item-downloaded" aria-hidden="true">'+n.fileIcon(t)+n.properties(t)+"<\/div>"},propertiesWithRemoveCommand:function(n){return'<ul class="attachmentWell-item-properties"><li class="attachmentWell-item-property-fileName">'+Jx.escapeHtml(n.name)+'<\/li><li class="attachmentWell-item-command">'+n.commandLabel+"<\/li><\/ul>"},composeItemWithProgress:function(){return'<div class="attachmentWell-item-progress" aria-hidden="true"><\/div>'},composeErrorItem:function(t){return'<div class="attachmentWell-item-other attachmentWell-item-error" aria-hidden="true"><div class="attachmentWell-item-status">'+n.defaultImage(t,"default.png","attachmentWell-default-icon")+"<\/div>"+n.propertiesWithRemoveCommand(t)+"<\/div>"},propertiesWithDownloadCommand:function(t){return'<ul class="attachmentWell-item-properties">'+n.basicProperties(t)+'<li class="attachmentWell-item-command">'+t.commandLabel+"<\/li><\/ul>"},propertiesWithCancelCommand:function(t){return'<ul class="attachmentWell-item-properties">'+n.basicProperties(t)+'<li class="attachmentWell-item-command"><progress class="win-ring"><\/progress>'+t.commandLabel+"<\/li><\/ul>"},notDownloadedPhotoVideo:function(t){return'<div class="attachmentWell-item-status attachmentWell-item-placeholder">'+n.defaultImage(t,"photoVideoIcon.png","attachmentWell-photo-video-icon")+"<\/div>"},readOtherItemDownloading:function(t){return'<div class="attachmentWell-item-other attachmentWell-item-downloading" aria-hidden="true">'+n.fileIcon(t)+n.propertiesWithCancelCommand(t)+"<\/div>"},readOtherItemNotDownloaded:function(t){return'<div class="attachmentWell-item-other attachmentWell-item-notDownloaded" aria-hidden="true">'+n.fileIcon(t)+n.propertiesWithDownloadCommand(t)+"<\/div>"},readPhotoVideoItemDownloading:function(t){return'<div class="attachmentWell-item-photoVideo attachmentWell-item-downloading" aria-hidden="true">'+n.notDownloadedPhotoVideo(t)+n.propertiesWithCancelCommand(t)+"<\/div>"},readPhotoVideoItemNotDownloaded:function(t){return'<div class="attachmentWell-item-photoVideo attachmentWell-item-notDownloaded" aria-hidden="true">'+n.notDownloadedPhotoVideo(t)+n.propertiesWithDownloadCommand(t)+"<\/div>"}}}(),function(){var n,t;AttachmentWell.ErrorIds={attachFailed:"attachFailed",downloadFailed:"downloadFailed",inProgress:"inProgress",maxBasicAttachmentsSize:"maxBasicAttachmentsSize",maxFiles:"maxFiles",openFailed:"openFailed"};AttachmentWell.Error=function(n,t){this.commands=[];this.id=n;this.message=t};n=AttachmentWell.Error.prototype;n.commands=null;n.id=null;n.message=null;AttachmentWell.ErrorCommand=function(n,t){this.action=t;this.label=n};t=AttachmentWell.ErrorCommand.prototype;t.action=null;t.label=null}(),function(){AttachmentWell.ErrorManager=function(){this.initComponent()};Jx.augment(AttachmentWell.ErrorManager,Jx.Component);var n=AttachmentWell.ErrorManager.prototype;n.getUI=function(n){n.html='<div class="attachmentWell-errorList" aria-hidden="true" aria-live="polite"><\/div>'};n.activateUI=function(){this._activeErrors={};this._commandCallbacks={};this._errorWrapper=document.createElement("div");var n=this.getParent();this._errorListElement=n.getElement().querySelector(".attachmentWell-errorList")};n._addCommandEventListeners=function(n,t){var s=n.querySelectorAll(".attachmentWell-error-command"),r,u,e,i,o,f;for(e=this,i=0,o=t.commands.length;i<o;i++)r=t.commands[i],u=s[i],u&&(f=function(){e.clearError(t.id);r.action()},this._commandCallbacks[r.action]=f,u.addEventListener("click",f,false))};n.clearError=function(n){var i,t;try{if(i=this._activeErrors[n],i&&(t=this._errorListElement.querySelector('[data-errorId="'+n+'"]'),t))return this._removeCommandEventListeners(t,i),this._errorListElement.removeChild(t),delete this._activeErrors[n],this._showOrHide(),true}catch(r){Jx.log.error("Failed to clear Attachment Well error "+n+": "+r)}return false};n.clearAllErrors=function(){var n,i,r,t;if(this._activeErrors)for(n=Object.keys(this._activeErrors),t=n.length;t--;)i=this._activeErrors[n[t]],r=this.clearError(i.id)};n._createErrorElement=function(n){return this._errorWrapper.innerHTML=AttachmentWell.Templates.errorMessage.call(this,{error:n}),this._errorWrapper.querySelector(".attachmentWell-error-message")};n._removeCommandEventListeners=function(n,t){for(var o=n.querySelectorAll(".attachmentWell-error-command"),f,r,u,i=0,e=t.commands.length;i<e;i++)f=t.commands[i],r=o[i],r&&(u=this._commandCallbacks[f.action],u&&r.removeEventListener("click",u,false))};n._showOrHide=function(){var n=Object.keys(this._activeErrors).length,t=this._errorListElement.querySelectorAll(".attachmentWell-error-message[aria-hidden='true']");n>0&&t.length!==n?this._errorListElement.removeAttribute("aria-hidden"):this._errorListElement.setAttribute("aria-hidden","true")};n.hideError=function(n){try{var t=this._errorListElement.querySelector('[data-errorId="'+n.id+'"]');if(t)return t.setAttribute("aria-hidden","true"),this._showOrHide(),true}catch(i){Jx.log.error("Failed to hide Attachment Well error "+n.id+": "+i)}return false};n.showError=function(n){var t,i,r;try{return Jx.log.info("AttachmentWell.ErrorManager.showError: "+n.id),this.clearError(n.id),t=this._createErrorElement(n),this._addCommandEventListeners(t,n),i=this._errorListElement,r=i.firstChild,r?i.insertBefore(t,r):i.appendChild(t),this._activeErrors[n.id]=n,this._showOrHide(),true}catch(u){Jx.log.error("Failed to show Attachment Well error "+n.id+": "+u)}return false};n.deactivateUI=function(){this.clearAllErrors();this._activeErrors=null;this._commandCallbacks=null;this._errorWrapper=null;this._errorListElement=null;Jx.Component.prototype.deactivateUI.call(this)};n._activeErrors=null;n._commandCallbacks=null;n._errorWrapper=null;n._errorListElement=null}(),function(){var n=AttachmentWell.Utils;n.GroupOrdering={photoVideo:0,others:1};n.FileCategory={photo:"photo",video:"video",others:"others"};n._photoExtensions=[".jpg",".jpeg",".png",".gif",".bmp",".tif",".tiff",".jpe",".jfif",".dib",".wdp",".pano",".arw",".cr2",".crw",".erf",".mrw",".nef",".orf",".pef",".sr2",".mef",".nrw",".raw",".rw2",".rwl"];n._videoExtensions=[".avi",".wmv",".mpg",".mpeg",".dvr-ms",".mp4",".mov",".m4v",".3g2",".3gp2",".3gp",".3gpp",".m4a",".mp4v",".mts",".m2ts",".ts",".wm",".wtv"];n.isSupportedPhotoOrVideoFormat=function(t){return n.isSupportedPhotoFormat(t)||n.isSupportedVideoFormat(t)};n.isSupportedPhotoFormat=function(t){return n._photoExtensions.indexOf(t.toLowerCase())>=0};n.isSupportedVideoFormat=function(t){return n._videoExtensions.indexOf(t.toLowerCase())>=0};n.isEml=function(n){return n.toLowerCase()===".eml"};n.getFileFromBodyUri=function(t){var i=n.encodeUri(t.bodyUri),r=new Windows.Foundation.Uri(i);try{return Windows.Storage.StorageFile.getFileFromApplicationUriAsync(r)}catch(u){return WinJS.Promise.wrapError(u)}};n.encodeUri=function(n){return n.replace(/%/g,"%25").replace(/#/g,"%23")};n.getFileName=function(n){var t=n.fileName,i=t.lastIndexOf(".");return i>=0&&(t=t.substr(0,i)),t};n.getFileExtension=function(n){var t=n.fileName,i="",r=t.lastIndexOf(".");return r>=0&&(i=t.substr(r).toLowerCase()),i};n.markFileAsWritable=function(n){if(n){var t="System.FileAttributes";return n.properties.retrievePropertiesAsync([t]).then(function(i){return i[t]=Windows.Storage.FileAttributes.normal,n.properties.savePropertiesAsync(i)})}};n._numSuggestedNumerals=3;n._ordersOfMagnitude=["bytes","kilobytes","megabytes","gigabytes","terabytes","petabytes","exabytes"];n.getFileSize=function(t){var s=t.size,o,c,l,a,r,e,v,y;if(s===1)return Jx.res.getString("singleByte");var i=s,u=i.toString(10),h=n._ordersOfMagnitude,f=0;if(i>=1024){for(o=n._numSuggestedNumerals,c=1024*Math.pow(10,o),f=1,l=h.length;f<l&&i>=c;f++)i/=1024;i/=1024;a=Math.floor(i);r=new Windows.Globalization.NumberFormatting.DecimalFormatter;r.fractionDigits=0;u=r.format(a);e=o-u.length;e>0&&(v=i.toFixed(e),y=parseFloat(v),r.fractionDigits=e,u=r.format(y))}return Jx.res.loadCompoundString(h[f],u)}}(),function(){AttachmentWell.Base.Module=function(){this.initComponent();this._id="idAttachmentWell_"+Jx.uid()};Jx.augment(AttachmentWell.Base.Module,Jx.Component);var n=AttachmentWell.Base.Module.prototype;n.getUI=function(n){n.html='<div id="'+this._id+'" class="attachmentWell-module">'+Jx.getUI(this._view).html+"<\/div>"};n._id=null;n._view=null}(),function(){var t=AttachmentWell.Utils,n;AttachmentWell.Base.ItemController=function(n){this._view=n};Jx.augment(AttachmentWell.Base.ItemController,Jx.EventTarget);n=AttachmentWell.Base.ItemController.prototype;n._getAttachmentStatus=function(){};n._getItemInvokedCallback=function(n){return this._itemInvokedCallbacks||(this._itemInvokedCallbacks=this._createItemInvokedCallbacks()),this._itemInvokedCallbacks[n]};n._createItemInvokedCallbacks=function(){};n._getContextMenuCallbacks=function(n){return this._contextMenuCallbacks||(this._contextMenuCallbacks=this._createContextMenuCallbacks()),this._contextMenuCallbacks[n]||[]};n._getContextMenuCommands=function(n,i){var f=this._getAttachmentStatus(n),e=this._getContextMenuCallbacks(f),r,u;return r=this._getContextMenu(),u=t.getFileExtension(n),e.filter(function(n){return n.isEnabled(u)}).map(function(t){var u=r.getCommandById(t.commandId);return u.onclick=function(){t.invoke(n,i)},u})};n._alwaysEnable=function(){return true};n._disableForEml=function(n){return!t.isEml(n)};n._enableForEml=function(n){return t.isEml(n)};n._getContextMenu=function(){var n,t;return this._contextMenu||(n=this._view.getElement().querySelector(".attachments-contextMenu"),WinJS.UI.processAll(n),Jx.res.processAll(n),t=this._getFlyoutContainerElement(),t&&t.appendChild(n),this._contextMenu=n.winControl),this._contextMenu};n._getFlyoutContainerElement=function(){};n.showContextMenu=function(n,t){var i,r;i=this._getContextMenuCommands(n,t);i.length>0&&(r=this._getContextMenu(),r.showOnlyCommands(i),r.show(t.itemDiv,"top","center"))};n.onItemInvoked=function(n,t){var r=this._getAttachmentStatus(n),i=this._getItemInvokedCallback(r);i?i(n,t):this.showContextMenu(n,t)};n._openWith=function(n,t){Jx.log.info("AttachmentWell.Base.ItemController._openWith");var i=new Windows.System.LauncherOptions;i.displayApplicationPicker=true;t.launcherOptions=i;this._open(n,t)};n._open=function(n,i){Jx.log.info("AttachmentWell.Base.ItemController._open");var u=t.getFileExtension(n),r=i?i.launcherOptions:null,f=this;this._view.fire("clearerror",{errorId:AttachmentWell.ErrorIds.openFailed});t.getFileFromBodyUri(n).then(function(n){return Jx.isNullOrUndefined(r)&&t.isEml(u)?n.openAsync(Windows.Storage.FileAccessMode.read).then(function(n){return Jx.EventManager.broadcast("openEml",[n]),true}):(r=r||new Windows.System.LauncherOptions,r.desiredRemainingView=t.isSupportedPhotoOrVideoFormat(u)?Windows.UI.ViewManagement.ViewSizePreference.useLess:Windows.UI.ViewManagement.ViewSizePreference.useHalf,Windows.System.Launcher.launchFileAsync(n,r))}).done(function(t){t||(Jx.log.error("Failed to open "+n.objectId+": Windows launcher failed to launch"),f._fireOpenFailedError(n))},function(t){Jx.log.error("Failed to open "+n.objectId+": "+t);f._fireOpenFailedError(n)})};n._fireOpenFailedError=function(){};n.dispose=function(){if(this._contextMenu){var n=this._contextMenu.element;n&&n.parentNode.removeChild(n);this._contextMenu=null}this._contextMenuCallbacks=null;this._itemInvokedCallbacks=null};n._contextMenu=null;n._contextMenuCallbacks=null;n._itemInvokedCallbacks=null}(),function(){var i=AttachmentWell.Templates,r=AttachmentWell.ThumbnailResizer,f=Windows.Storage.FileProperties.ThumbnailType,t=AttachmentWell.Utils,n,u;AttachmentWell.Base.Item=function(n,t,i){this._controller=t;this._attachment=n;this._host=i;this._currentStatus=this._getCurrentStatus();this._id="idAttachmentItem_"+Jx.uid();this._disposed=false;this._animationPromise=null;this._ignoreItemInvokedEvent=false;this._attachmentChanged=this._onAttachmentChanged.bind(this);n.addEventListener("changed",this._attachmentChanged,false);this._buildItemContainer()};n=AttachmentWell.Base.Item.prototype;u=Math.round(120);n._thumbnailDimensions={photoVideo:{height:90,width:u,minWidth:48,maxWidth:1024},fileIcon:{height:40,width:40}};n._setBasicProperties=function(){var n=this._attachment;return this._properties={ariaLabel:n.fileName,fileExtension:t.getFileExtension(n),name:t.getFileName(n)}};n._buildItemContainer=function(){var u=this._attachment,t=this._itemWrapperDiv=document.createElement("div"),n,i,r;t.setAttribute("aria-hidden","true");t.className="attachmentWell-item-wrapper";new WinJS.UI.Tooltip(t,{innerHTML:u.fileName,extraClass:"attachments-tooltip"});n=this._itemContainerDiv=document.createElement("div");n.id=this._id;n.tabIndex=-1;n.setAttribute("role","option");n.appendChild(t);i=new WinJS.UI.ItemContainer(n);i.selectionDisabled=true;i.oninvoked=this._onItemInvoked.bind(this);this._contextMenuHandler=this._onContextMenu.bind(this);this._keydownHandler=this._onKeyDown.bind(this);this._holdVisualHandler=this._onMSHoldVisual.bind(this);n.addEventListener("contextmenu",this._contextMenuHandler,false);n.addEventListener("keydown",this._keydownHandler,false);n.addEventListener("MSHoldVisual",this._holdVisualHandler,true);r=this._host.getContainerWidth();r>0&&(this._thumbnailDimensions.photoVideo.maxWidth=r);this._updateItemDiv()};n._onAttachmentChanged=function(n){var t=this._getCurrentStatus();t!==this._currentStatus&&(Jx.log.info("AttachmentWell.Base.Item._onAttachmentChanged: "+n.target.objectId+" status changed from "+this._currentStatus+" to "+t),this._currentStatus=t,this._updateItemDiv())};n._updateItemDiv=function(){var r=this._attachment,t=this._itemWrapperDiv,i=this._setBasicProperties(),u=this._getItemRenderer(i.fileExtension,this._currentStatus).render,n=this;u(r,i).done(function(r){var u,f,e;n._disposed||(t.hasChildNodes()?(Jx.isNullOrUndefined(n._animationPromise)||n._animationPromise.cancel(),u=t.firstChild,u.style.position="absolute",t.appendChild(r),r.style.opacity="0",f=function(){t.removeChild(u);r.style.opacity="1";n._animationPromise=null},n._animationPromise=WinJS.UI.Animation.crossFade(r,u),n._animationPromise.done(f,f)):t.appendChild(r),e=r.querySelector("img"),Jx.isNullOrUndefined(e)||e.setAttribute("draggable","false"),n._itemContainerDiv.setAttribute("aria-label",i.ariaLabel))})};n.getItemContainer=function(){return this._itemContainerDiv};n._onKeyDown=function(n){n.key==="Spacebar"&&this._onContextMenu(n)};n._onMSHoldVisual=function(n){n.stopImmediatePropagation();this._ignoreItemInvokedEvent=true};n._onItemInvoked=function(){if(!this._ignoreItemInvokedEvent)this._controller.onItemInvoked(this._attachment,{itemDiv:this._itemContainerDiv});this._ignoreItemInvokedEvent=false};n._onContextMenu=function(n){n.preventDefault();this._controller.showContextMenu(this._attachment,{itemDiv:this._itemContainerDiv})};n._getCurrentStatus=function(){};n._getItemRenderer=function(){};n.dispose=function(){this._disposed=true;this._animationPromise&&this._animationPromise.cancel();this._itemContainerDiv.removeEventListener("keydown",this._keydownHandler,false);this._itemContainerDiv.removeEventListener("contextmenu",this._contextMenuHandler,false);this._itemContainerDiv.removeEventListener("MSHoldVisual",this._holdVisualHandler,true);this._itemContainerDiv=null;this._itemWrapperDiv.winControl instanceof WinJS.UI.Tooltip&&(this._itemWrapperDiv.winControl.innerHTML="",this._itemWrapperDiv.winControl=null);this._itemWrapperDiv=null;this._attachment.removeEventListener("changed",this._attachmentChanged,false);this._attachment=null};n._renderWithTemplate=function(n,t){var i=document.createElement("div");return i.innerHTML=n.call(this,t),i.firstChild};n._photoItemRenderer={canRender:function(n,i,r){return i===r.done&&t.isSupportedPhotoFormat(n)},render:function(n,u){var f=this;return u.command="openCommand",r.getThumbnail(n,t.FileCategory.photo,this._thumbnailDimensions).then(function(t){return f._renderPhotoVideoItem(n,t,i.photoItem,u)})}.bind(n)};n._videoItemRenderer={canRender:function(n,i,r){return i===r.done&&t.isSupportedVideoFormat(n)},render:function(n,u){var f=this;return u.command="openCommand",r.getThumbnail(n,t.FileCategory.video,this._thumbnailDimensions).then(function(t){return f._renderPhotoVideoItem(n,t,i.videoItem,u)})}.bind(n)};n._otherItemRenderer={canRender:function(n,i,r){return i===r.done&&!t.isSupportedPhotoOrVideoFormat(n)},render:function(n,u){var f=t.isEml(u.fileExtension)?WinJS.Promise.wrap():r.getThumbnail(n,t.FileCategory.others,this._thumbnailDimensions),e=this;return f.then(function(t){return e._renderFileIconItem(n,t,i.otherItem,u,"openCommand")})}.bind(n)};n._renderPhotoVideoItem=function(n,u,e,o){if(o.fileSize=t.getFileSize(n),o.ariaLabel=Jx.res.loadCompoundString("label",o.name,o.fileSize,Jx.res.getString(o.command)),u){if(u.type===f.icon)return this._renderFileIconItem(n,u,i.otherItem,o,o.command);o.thumbnailUrl=URL.createObjectURL(u,{oneTimeOnly:true});var s=this._renderWithTemplate(e,o),h=r.calcDesiredDisplaySize(u,this._thumbnailDimensions.photoVideo);return r.scaleAndCenter(s.querySelector("img"),u.originalWidth,u.originalHeight,h.width,h.height,true),s}return Jx.log.info("AttachmentWell.Base.Item._renderPhotoVideoItem: failed to get thumbnailStream from file"),this._renderWithTemplate(i.photoVideoItemPlaceholder,o)};n._renderFileIconItem=function(n,i,r,u,f){return i&&(u.fileIconUrl=URL.createObjectURL(i,{oneTimeOnly:true})),u.isEml=u.fileExtension===".eml",u.fileIconHeight=this._thumbnailDimensions.fileIcon.height,u.fileIconWidth=this._thumbnailDimensions.fileIcon.width,u.commandLabel=Jx.res.getString(f),u.fileSize=t.getFileSize(n),u.ariaLabel=Jx.res.loadCompoundString("label",u.name,u.fileSize,u.commandLabel),this._renderWithTemplate(r,u)};n._itemRenderers=null}(),function(){var t=AttachmentWell.Utils,i=WinJS.UI.Animation,n;AttachmentWell.Base.ViewLayout=function(n,t){this.initComponent();this._id="idAttachmentWellView_"+Jx.uid();this._mailMessage=n;this._attachmentCollection=n.getOrdinaryAttachmentCollection();this._containerWidth=0;this._attachmentItems={};this._neighborElement=t;this._elementResize=this._onElementResize.bind(this);this._attachmentCollectionChanged=this._onAttachmentCollectionChanged.bind(this);this._onClearError=this.onClearError.bind(this);this._onError=this.onError.bind(this);this._filesAttachedControl=new AttachmentWell.FilesAttachedControl;this._errorManager=new AttachmentWell.ErrorManager;this.append(this._filesAttachedControl,this._errorManager)};Jx.augment(AttachmentWell.Base.ViewLayout,Jx.Component);n=AttachmentWell.Base.ViewLayout.prototype;n.getUI=function(n){n.html='<div id="'+this._id+'" class="attachmentWell-view">'+Jx.getUI(this._errorManager).html+'<div class="attachmentWell-controls">'+Jx.getUI(this._filesAttachedControl).html+'<\/div><div class="attachmentWell-repeater" role="listbox"><\/div>'+this._contextMenuUI()+"<\/div>"};n._contextMenuUI=function(){return'<div class="attachments-contextMenu" aria-hidden="true" data-win-control="WinJS.UI.Menu" data-win-res="aria-label:attachmentContextMenuLabel"><button data-win-control="WinJS.UI.MenuCommand" data-win-options="{id:\'openCommand\'}" data-win-res="innerText:openCommand;aria-label:openCommand" type="button"><\/button><button data-win-control="WinJS.UI.MenuCommand" data-win-options="{id:\'openInMailCommand\'}" data-win-res="innerText:openWithMailCommand;aria-label:openWithMailCommand" type="button"><\/button><button data-win-control="WinJS.UI.MenuCommand" data-win-options="{id:\'openWithCommand\'}" data-win-res="innerText:openWithCommand;aria-label:openWithCommand" type="button"><\/button><button data-win-control="WinJS.UI.MenuCommand" data-win-options="{id:\'removeCommand\'}" data-win-res="innerText:removeCommand;aria-label:removeCommand" type="button"><\/button><button data-win-control="WinJS.UI.MenuCommand" data-win-options="{id:\'saveCommand\'}" data-win-res="innerText:saveCommand;aria-label:saveCommand" type="button"><\/button><\/div>'};n.activateUI=function(){Jx.Component.prototype.activateUI.call(this);this.getElement().addEventListener("mselementresize",this._elementResize,false)};n._onElementResize=function(){if(this._containerWidth=parseInt(getComputedStyle(this.getElement()).width,10),Jx.isNullOrUndefined(this._repeater)&&this._containerWidth>0){var t=this.getElement(),n=t.querySelector(".attachmentWell-repeater");this._controller=this._createController();this._attachmentCollection.addEventListener("collectionchanged",this._attachmentCollectionChanged);this.on("clearerror",this._onClearError,this);this.on("error",this._onError,this);this._repeater=new WinJS.UI.Repeater(n,{data:this._getSortedBindingList(),template:this._getItemTemplate.bind(this)});this._keyboardNavigation=new Jx.KeyboardNavigation(n,"horizontal");this._updateCount();this._attachmentCollection.unlock()}};n._getItemTemplate=function(n){var i=this._mailMessage.loadAttachment(n),t=this._createAttachmentItem(i);return this._attachmentItems[n]=t,t.getItemContainer()};n._createAttachmentItem=function(){};n._createController=function(){};n._getSortedBindingList=function(){for(var r=this._attachmentCollection,s=this._mailMessage,u=new WinJS.Binding.List,e,i,o,n=0,f=r.count;n<f;n++)e=r.item(n),u.push(e.objectId);return i=function(n){var i=s.loadAttachment(n),r=t.getFileExtension(i);return t.isSupportedPhotoOrVideoFormat(r)?"photoVideo":"others"},o=function(n,t){var i=AttachmentWell.Utils.GroupOrdering;return i[n]-i[t]},u.createGrouped(i,i,o)};n._onAttachmentCollectionChanged=function(n){var i=n.objectId,t=Microsoft.WindowsLive.Platform.CollectionChangeType;switch(n.eType){case t.itemAdded:this._addAttachment(i);break;case t.itemRemoved:this._removeAttachment(i);break;case t.reset:this._resetAttachmentCollection()}this._updateCount();this._keyboardNavigation.update(true)};n._updateCount=function(){var n=this._attachmentCollection.count;this.isHidden=n===0;this._filesAttachedControl.updateCount(n)};n._addAttachment=function(n){Jx.log.info("AttachmentWell.Base.ViewLayout._addAttachment: "+n);this._repeater.data.push(n);var t=this._getRepeaterItem(n),r=this._getAffectedRepeaterItems(n),u=i.createAddToListAnimation(t,r);u.execute()};n._removeAttachment=function(n){var f,e,o;Jx.log.info("AttachmentWell.Base.ViewLayout._removeAttachment: "+n);var u=this._repeater,r=u.data,t=r.indexOf(n),s=this._getRepeaterItem(n),h=this._getAffectedRepeaterItems(n),c=i.createDeleteFromListAnimation(s,h);r.splice(t,1);c.execute();r.length>0&&(f=t===0?t:t-1,e=u.elementFromIndex(f),Jx.safeSetActive(e));o=this._attachmentItems[n];o.dispose();delete this._attachmentItems[n]};n._getRepeaterItem=function(n){var t=this._repeater.data,i=t.indexOf(n);return this._repeater.elementFromIndex(i)};n._getAffectedRepeaterItems=function(n){for(var i=this._repeater.data,u=i.indexOf(n),r=[],t=u+1;t<i.length;t++)r.push(this._repeater.elementFromIndex(t));return r};n._resetAttachmentCollection=function(){Jx.log.info("AttachmentWell.Base.ViewLayout._resetAttachmentCollection");this._disposeAttachmentItems();this._removeCollectionListener();this._attachmentCollection=this._mailMessage.getOrdinaryAttachmentCollection();this._attachmentCollection.addEventListener("collectionchanged",this._attachmentCollectionChanged);this._attachmentCollection.unlock();this._repeater.data=this._getSortedBindingList()};n.deactivateUI=function(){this._element.removeEventListener("mselementresize",this._elementResize,false);this._repeater&&(this._removeCollectionListener(),this._disposeAttachmentItems(),this._controller.dispose(),this._controller=null,this._repeater.dispose(),this._repeater=null,this._keyboardNavigation.dispose(),this._keyboardNavigation=null,this.detach("clearerror",this._onClearError,this),this.detach("error",this._onError,this),Jx.Component.prototype.deactivateUI.call(this))};n._removeCollectionListener=function(){var n=this._attachmentCollection;n.lock();n.removeEventListener("collectionchanged",this._attachmentCollectionChanged)};n._disposeAttachmentItems=function(){var n=this._attachmentItems;Object.keys(n).forEach(function(t){n[t].dispose()},this);this._attachmentItems={}};n.getElement=function(){return this._element||(this._element=document.getElementById(this._id)),this._element};n.getContainerWidth=function(){return this._containerWidth};Object.defineProperty(n,"isCollapsed",{get:function(){return Jx.hasClass(this._repeater.element,"hidden")},set:function(n){Jx.log.info("AttachmentWell.Base.ViewLayout.isCollapsed: "+n);var t=this._repeater.element,i=this._collapsed?WinJS.UI.Animation.createCollapseAnimation(t,this._neighborElement):WinJS.UI.Animation.createExpandAnimation(t,this._neighborElement);Jx.setClass(t,"hidden",n);i.execute()},enumerable:true});Object.defineProperty(n,"isHidden",{get:function(){return Jx.hasClass(this._element,"hidden")},set:function(n){Jx.log.info("AttachmentWell.Base.ViewLayout.isHidden: "+n);Jx.setClass(this._element,"hidden",n)},enumerable:true});n.onClearError=function(n){this._errorManager.clearError(n.data.errorId)&&(n.cancel=true)};n.onError=function(n){this._errorManager.showError(n.data.error)&&(n.cancel=true)};n._id=null;n._mailMessage=null;n._element=null;n._attachmentCollection=null;n._attachmentCollectionChanged=null;n._repeater=null}(),function(){AttachmentWell.Compose.ActivationType={compose:0,shareAnything:1};AttachmentWell.Compose.AttachmentTypeBici={skyDrive:0,convertedToAttachment:1,attachment:2,convertedToSkyDrive:3};AttachmentWell.Compose.Module=function(n,t,i){AttachmentWell.Base.Module.call(this);this._activationType=AttachmentWell.Compose.ActivationType.compose;this._removeFileHandler=this._onRemoveFile.bind(this);this._onClearError=this._onClearError.bind(this);this._onError=this._onError.bind(this);this._view=this._getViewLayout(t,i);this._attachmentManager=new AttachmentWell.AttachmentManager(n,t);this.append(this._attachmentManager,this._view)};Jx.inherit(AttachmentWell.Compose.Module,AttachmentWell.Base.Module);var n=AttachmentWell.Compose.Module.prototype;n._getViewLayout=function(n,t){return new AttachmentWell.Compose.ViewLayout(n,t)};n.activateUI=function(){Jx.Component.prototype.activateUI.call(this);this._element=document.getElementById(this._id);this._element.addEventListener("removeFile",this._removeFileHandler,false);this.on("clearerror",this._onClearError,this);this.on("error",this._onError,this);this._attachmentManager.activate()};n.deactivateUI=function(){this.detach("clearerror",this._onClearError,this);this.detach("error",this._onError,this);this._element.removeEventListener("removeFile",this._removeFileHandler,false);this._attachmentManager.shutdown();Jx.Component.prototype.deactivateUI.call(this)};n.discard=function(){var n=this._view;n&&n.isInit()&&n.shutdownUI();this._attachmentManager.discard()};n._onRemoveFile=function(n){var t=n.detail.objectId,i=n.detail.fileName;Jx.log.info("AttachmentWell.Compose.Module._onRemoveFile");this._attachmentManager.removeFile(t)};n.add=function(n){Jx.log.info("AttachmentWell.Compose.Module.add: adding "+n.length+" file(s)");this._attachmentManager.addFiles(n)};n.getMetrics=function(){return this._attachmentManager.getAttachmentMetrics()};n.finalizeForSend=function(){var n,i,t;try{n=this._attachmentManager.getAttachmentMetrics();n.count>0&&(i=AttachmentWell.Compose.AttachmentTypeBici.attachment,t=1,Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.Mail.sendMailWithAttachment,t,n.totalSize,i,n.count,n.validateFailures,0,0,n.category,n.count),Jx.bici.addToStream(Microsoft.WindowsLive.Instrumentation.Ids.Mail.sendButtonActive,this._activationType,t,n.count,n.duration))}catch(r){Jx.log.error("AttachmentWell - Failed to report instrumentation "+r)}this._attachmentManager.finalizeForSend()};n.canAddMore=function(n){return this._attachmentManager.canAddMore(n)};n.isAttaching=function(){return this._attachmentManager.isAttaching()};n.validate=function(){return this._attachmentManager.canSendMail()};n.focus=function(){this._view.focusFirst()};n.isHidden=function(){return this._view.isHidden};Object.defineProperty(n,"isDirty",{get:function(){return this._attachmentManager.isDirty()},enumarable:true});n._onClearError=function(n){this._view.onClearError(n)};n._onError=function(n){this._view.onError(n)};n._element=null;n._attachmentManager=null;n._removeFileHandler=null}(),function(){var t=Microsoft.WindowsLive.Platform.AttachmentComposeStatus,n;AttachmentWell.Compose.ItemController=function(n){AttachmentWell.Base.ItemController.call(this,n)};Jx.inherit(AttachmentWell.Compose.ItemController,AttachmentWell.Base.ItemController);n=AttachmentWell.Compose.ItemController.prototype;n._createContextMenuCallbacks=function(){var n={},i={commandId:"openCommand",invoke:this._open.bind(this),isEnabled:this._disableForEml},r={commandId:"removeCommand",invoke:this._remove.bind(this),isEnabled:this._alwaysEnable},u={commandId:"openInMailCommand",invoke:this._open.bind(this),isEnabled:this._enableForEml},f={commandId:"openWithCommand",invoke:this._openWith.bind(this),isEnabled:this._alwaysEnable};return n[t.done]=[u,i,f,r],n};n._createItemInvokedCallbacks=function(){var i=this._remove.bind(this),n={};return n[t.failed]=i,n};n._getAttachmentStatus=function(n){return n.composeStatus};n._getFlyoutContainerElement=function(){return document.getElementById(Mail.CompApp.rootElementId)};n._remove=function(n,t){Jx.log.info("AttachmentWell.Compose.ItemController._remove");this._view.fire("clearerror",{errorId:AttachmentWell.ErrorIds.openFailed});var r=t.itemDiv,i=document.createEvent("CustomEvent");i.initCustomEvent("removeFile",true,false,{objectId:n.objectId,fileName:n.fileName});r.dispatchEvent(i)};n._fireOpenFailedError=function(){var n=new AttachmentWell.Error(AttachmentWell.ErrorIds.openFailed,Jx.res.getString("composeOpenFailedErrorMessage"));this._view.fire("error",{error:n})}}(),function(){var t=Microsoft.WindowsLive.Platform.AttachmentComposeStatus,i=AttachmentWell.Templates,n;AttachmentWell.Compose.Item=function(n,t,i){this._itemRenderers=[this._otherItemRenderer,this._photoItemRenderer,this._videoItemRenderer,this._inProgressItemRenderer,this._failedItemRenderer];AttachmentWell.Base.Item.call(this,n,t,i)};Jx.inherit(AttachmentWell.Compose.Item,AttachmentWell.Base.Item);n=AttachmentWell.Compose.Item.prototype;n._getCurrentStatus=function(){return this._attachment.composeStatus};n._getItemRenderer=function(n,t){var i=this._itemRenderers.filter(function(i){return i.canRender(n,t,Microsoft.WindowsLive.Platform.AttachmentComposeStatus)});return i[0]};n._inProgressItemRenderer={canRender:function(n,i){return i===t.inProgress},render:function(n,t){t.commandLabel=Jx.res.getString("removeCommand");t.ariaLabel=Jx.res.loadCompoundString("label",t.name,t.fileSize,t.commandLabel);var r=this._renderWithTemplate(i.composeItemWithProgress,t);return WinJS.Promise.wrap(r)}.bind(n)};n._failedItemRenderer={canRender:function(n,i){return i===t.failed},render:function(n,t){Jx.log.info("AttachmentWell.Compose.Item._failedItemRenderer: failed to attach the file");t.commandLabel=Jx.res.getString("removeCommand");t.ariaLabel=Jx.res.loadCompoundString("label",t.name,t.fileSize,t.commandLabel);var r=this._renderWithTemplate(i.composeErrorItem,t);return WinJS.Promise.wrap(r)}.bind(n)};n._itemRenderers=null}(),function(){AttachmentWell.Compose.ViewLayout=function(n,t){AttachmentWell.Base.ViewLayout.call(this,n,t)};Jx.inherit(AttachmentWell.Compose.ViewLayout,AttachmentWell.Base.ViewLayout);var n=AttachmentWell.Compose.ViewLayout.prototype;n._createAttachmentItem=function(n){return new AttachmentWell.Compose.Item(n,this._controller,this)};n._createController=function(){return new AttachmentWell.Compose.ItemController(this)};n.focusFirst=function(){!this.isHidden&&!this.isCollapsed&&this._repeater.length>0&&this._repeater.elementFromIndex(0).focus()};Object.defineProperty(n,"isHidden",{get:function(){return Jx.hasClass(this._element,"hidden")},set:function(n){Jx.log.info("AttachmentWell.Compose.ViewLayout.isHidden: "+n);Jx.setClass(this._element,"hidden",n);n&&Jx.EventManager.fire(null,"hide",{})},enumerable:true});n._statusProperty="composeStatus"}(),function(){AttachmentWell.ShareAnything.Module=function(n,t,i){AttachmentWell.Compose.Module.call(this,n,t,i);this._activationType=AttachmentWell.Compose.ActivationType.shareAnything};Jx.inherit(AttachmentWell.ShareAnything.Module,AttachmentWell.Compose.Module);var n=AttachmentWell.ShareAnything.Module.prototype;n._getViewLayout=function(n){return new AttachmentWell.ShareAnything.ViewLayout(n)}}(),function(){var t=Microsoft.WindowsLive.Platform.AttachmentComposeStatus,n;AttachmentWell.ShareAnything.ItemController=function(n){AttachmentWell.Compose.ItemController.call(this,n)};Jx.inherit(AttachmentWell.ShareAnything.ItemController,AttachmentWell.Compose.ItemController);n=AttachmentWell.ShareAnything.ItemController.prototype;n._createContextMenuCallbacks=function(){var i={commandId:"removeCommand",invoke:this._remove.bind(this),isEnabled:this._alwaysEnable},n={};return n[t.done]=[i],n};n._getFlyoutContainerElement=function(){return document.getElementById("shareFlyout")}}(),function(){var i=AttachmentWell.Templates,r=AttachmentWell.ThumbnailResizer,t=AttachmentWell.Utils,n;AttachmentWell.ShareAnything.Item=function(n,t,i){AttachmentWell.Compose.Item.call(this,n,t,i)};Jx.inherit(AttachmentWell.ShareAnything.Item,AttachmentWell.Compose.Item);n=AttachmentWell.ShareAnything.Item.prototype;n._otherItemRenderer={canRender:function(n,i,r){return i===r.done&&!t.isSupportedPhotoOrVideoFormat(n)},render:function(n,u){var f=t.isEml(u.fileExtension)?WinJS.Promise.wrap():r.getThumbnail(n,t.FileCategory.others,this._thumbnailDimensions),e=this;return f.then(function(t){return e._renderFileIconItem(n,t,i.otherItem,u,"removeCommand")})}.bind(n)};n._photoItemRenderer={canRender:function(n,i,r){return i===r.done&&t.isSupportedPhotoFormat(n)},render:function(n,u){var f=this;return u.command="removeCommand",r.getThumbnail(n,t.FileCategory.photo,this._thumbnailDimensions).then(function(t){return f._renderPhotoVideoItem(n,t,i.photoItem,u)})}.bind(n)};n._videoItemRenderer={canRender:function(n,i,r){return i===r.done&&t.isSupportedVideoFormat(n)},render:function(n,u){var f=this;return u.command="removeCommand",r.getThumbnail(n,t.FileCategory.video,this._thumbnailDimensions).then(function(t){return f._renderPhotoVideoItem(n,t,i.videoItem,u)})}.bind(n)};n._itemRenderers=null}(),function(){AttachmentWell.ShareAnything.ViewLayout=function(n,t){AttachmentWell.Compose.ViewLayout.call(this,n,t)};Jx.inherit(AttachmentWell.ShareAnything.ViewLayout,AttachmentWell.Compose.ViewLayout);var n=AttachmentWell.ShareAnything.ViewLayout.prototype;n._createAttachmentItem=function(n){return new AttachmentWell.ShareAnything.Item(n,this._controller,this)};n._createController=function(){return new AttachmentWell.ShareAnything.ItemController(this)}}(),function(){AttachmentWell.Read.Module=function(n,t){AttachmentWell.Base.Module.call(this);this._view=new AttachmentWell.Read.ViewLayout(n,t);this.append(this._view)};Jx.inherit(AttachmentWell.Read.Module,AttachmentWell.Base.Module);var n=AttachmentWell.Read.Module.prototype}(),function(){var r=AttachmentWell.Utils,i=Microsoft.WindowsLive.Platform.AttachmentSyncStatus,t=Windows.Networking.Connectivity,n;AttachmentWell.Read.ItemController=function(n){AttachmentWell.Base.ItemController.call(this,n);this._networkStatusChangedHandler=this._onNetworkStatusChanged.bind(this)};Jx.inherit(AttachmentWell.Read.ItemController,AttachmentWell.Base.ItemController);n=AttachmentWell.Read.ItemController.prototype;n._createContextMenuCallbacks=function(){var n={},t={commandId:"saveCommand",invoke:this._save.bind(this),isEnabled:this._alwaysEnable},r={commandId:"openInMailCommand",invoke:this._open.bind(this),isEnabled:this._enableForEml},u={commandId:"openWithCommand",invoke:this._openWith.bind(this),isEnabled:this._alwaysEnable};return n[i.done]=[r,u,t],n};n._createItemInvokedCallbacks=function(){var t=this._download.bind(this),r=this._cancel.bind(this),u=this._open.bind(this),n={};return n[i.notStarted]=t,n[i.failed]=t,n[i.inProgress]=r,n[i.done]=u,n};n._getAttachmentStatus=function(n){return n.syncStatus};n._getFlyoutContainerElement=function(){return document.getElementById(Mail.CompApp.rootElementId)};n._download=function(n){this._view.fire("clearerror",{errorId:AttachmentWell.ErrorIds.downloadFailed});try{Jx.log.info("AttachmentWell.Read.ItemController._download: start downloading file");n.downloadBody()}catch(t){Jx.log.error("AttachmentWell.Read.ItemController._download: failed to download file: "+t);this.fireDownloadFailedError(n)}};n.fireDownloadFailedError=function(n){var f=this,i,r,u;this._getNetworkConnectivityLevel()===t.NetworkConnectivityLevel.internetAccess?(i=Jx.res.getString("readDownloadFailedGenericErrorMessage"),r=new AttachmentWell.ErrorCommand(Jx.res.getString("tryAgainCommand"),function(){f._download(n)})):(i=Jx.res.getString("readDownloadFailedConnectionErrorMessage"),this._registeredForNetworkStatusChange||(t.NetworkInformation.addEventListener("networkstatuschanged",this._networkStatusChangedHandler),this._registeredForNetworkStatusChange=true));u=new AttachmentWell.Error(AttachmentWell.ErrorIds.downloadFailed,i);r&&u.commands.push(r);this._view.fire("error",{error:u})};n._getNetworkConnectivityLevel=function(){var n=t.NetworkConnectivityLevel.internetAccess,i;try{i=t.NetworkInformation.getInternetConnectionProfile();n=i?i.getNetworkConnectivityLevel():t.NetworkConnectivityLevel.none}catch(r){Jx.log.error("Attachment Well failed to get connectivity information: "+r)}return Jx.log.info("AttachmentWell.Read.ItemController._getNetworkConnectivityLevel: connectivity level = "+n),n};n._onNetworkStatusChanged=function(){this._registeredForNetworkStatusChange&&this._getNetworkConnectivityLevel()===t.NetworkConnectivityLevel.internetAccess&&(Jx.log.info("AttachmentWell.Read.ItemController._onNetworkStatusChanged: has internet access now"),this._view.fire("clearerror",{errorId:AttachmentWell.ErrorIds.downloadFailed}),t.NetworkInformation.removeEventListener("networkstatuschanged",this._networkStatusChangedHandler),this._registeredForNetworkStatusChange=false)};n._cancel=function(n){try{Jx.log.info("AttachmentWell.Read.ItemController._cancel: cancel downloading file");n.cancelDownload()}catch(t){Jx.log.error("AttachmentWell.Read.ItemController._cancel: failed to cancel downloading file: "+t)}};n._save=function(n){var i,t,u,f;Jx.log.info("AttachmentWell.Read.ItemController._save");i=r.getFileExtension(n)||".ext";t=new Windows.Storage.Pickers.FileSavePicker;t.defaultFileExtension=i;t.fileTypeChoices.insert(i,[i]);t.settingsIdentifier="AttachmentWell.Read.ItemController";t.suggestedFileName=r.getFileName(n);t.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.picturesLibrary;u=function(n,t){if(n)return r.getFileFromBodyUri(t).then(function(t){return t.copyAndReplaceAsync(n)})};t.pickSaveFileAsync().then(function(t){return f=t,u(t,n)}).then(function(){return r.markFileAsWritable(f)}).done(Jx.fnEmpty,function(n){Jx.log.error("AttachmentWell.Read.ItemController._save: failed to save file: "+n)})};n._fireOpenFailedError=function(n){var i=this,t=new AttachmentWell.Error(AttachmentWell.ErrorIds.openFailed,Jx.res.getString("readOpenFailedErrorMessage")),r=new AttachmentWell.ErrorCommand(Jx.res.getString("saveCommand"),function(){i._save(n)});t.commands.push(r);this._view.fire("error",{error:t})};n._dispose=function(){this._registeredForNetworkStatusChange&&(t.NetworkInformation.removeEventListener("networkstatuschanged",this._networkStatusChangedHandler),this._registeredForNetworkStatusChange=false);AttachmentWell.Base.ItemController.prototype.dispose.call(this)}}(),function(){var t=Microsoft.WindowsLive.Platform.AttachmentSyncStatus,r=AttachmentWell.Templates,u=AttachmentWell.ThumbnailResizer,i=AttachmentWell.Utils,n;AttachmentWell.Read.Item=function(n,t,i){this._itemRenderers=[this._otherItemRenderer,this._photoItemRenderer,this._videoItemRenderer,this._inProgressOtherItemRenderer,this._inProgressPhotoVideoItemRenderer,this._notDownloadedOtherItemRenderer,this._notDownloadedPhotoVideoItemRenderer];AttachmentWell.Base.Item.call(this,n,t,i)};Jx.inherit(AttachmentWell.Read.Item,AttachmentWell.Base.Item);n=AttachmentWell.Read.Item.prototype;n._getCurrentStatus=function(){return this._attachment.syncStatus};n._onAttachmentChanged=function(n){AttachmentWell.Base.Item.prototype._onAttachmentChanged.call(this,n);this._reportStatus()};n._reportStatus=function(){var n=this._attachment.fileName;switch(this._currentStatus){case t.notStarted:this._logAccessibility(Jx.res.loadCompoundString("attachmentDownloadCancelled",n));break;case t.inProgress:this._logAccessibility(Jx.res.loadCompoundString("attachmentDownloading",n));break;case t.done:this._logAccessibility(Jx.res.loadCompoundString("attachmentFinishedDownloading",n));break;case t.failed:this._controller.fireDownloadFailedError(this._attachment)}};n._getItemRenderer=function(n,t){var i=this._itemRenderers.filter(function(i){return i.canRender(n,t,Microsoft.WindowsLive.Platform.AttachmentSyncStatus)});return i[0]};n._inProgressOtherItemRenderer={canRender:function(n,r){return r===t.inProgress&&!i.isSupportedPhotoOrVideoFormat(n)},render:function(n,t){var f=this;return u.getThumbnail(n,i.FileCategory.others,this._thumbnailDimensions).then(function(i){return f._renderFileIconItem(n,i,r.readOtherItemDownloading,t,"cancelCommand")})}.bind(n)};n._inProgressPhotoVideoItemRenderer={canRender:function(n,r){return r===t.inProgress&&i.isSupportedPhotoOrVideoFormat(n)},render:function(n,t){var i=this._renderFileIconItem(n,null,r.readPhotoVideoItemDownloading,t,"cancelCommand");return WinJS.Promise.wrap(i)}.bind(n)};n._notDownloadedOtherItemRenderer={canRender:function(n,r){return(r===t.notStarted||r===t.failed)&&!i.isSupportedPhotoOrVideoFormat(n)},render:function(n,t){var f=this;return u.getThumbnail(n,i.FileCategory.others,this._thumbnailDimensions).then(function(i){return f._renderFileIconItem(n,i,r.readOtherItemNotDownloaded,t,"downloadCommand")})}.bind(n)};n._notDownloadedPhotoVideoItemRenderer={canRender:function(n,r){return(r===t.notStarted||r===t.failed)&&i.isSupportedPhotoOrVideoFormat(n)},render:function(n,t){var i=this._renderFileIconItem(n,null,r.readPhotoVideoItemNotDownloaded,t,"downloadCommand");return WinJS.Promise.wrap(i)}.bind(n)};n._logAccessibility=function(n){var t=document.createElement("div"),i;t.setAttribute("aria-live","polite");t.setAttribute("role","status");t.className="attachmentWell-statusListItem";t.innerText=n;i=this._statusListElement;Jx.isNullOrUndefined(i)&&(i=this._statusListElement=this._host.getElement().querySelector(".attachmentWell-statusList"));i.appendChild(t)};n._itemRenderers=null}(),function(){AttachmentWell.Read.ViewLayout=function(n,t){AttachmentWell.Base.ViewLayout.call(this,n,t);this._downloadSaveAllControl=new AttachmentWell.DownloadSaveAllControl(n);this.append(this._downloadSaveAllControl)};Jx.inherit(AttachmentWell.Read.ViewLayout,AttachmentWell.Base.ViewLayout);var n=AttachmentWell.Read.ViewLayout.prototype;n.getUI=function(n){n.html='<div id="'+this._id+'" class="attachmentWell-view">'+Jx.getUI(this._errorManager).html+'<div class="attachmentWell-controls">'+Jx.getUI(this._filesAttachedControl).html+Jx.getUI(this._downloadSaveAllControl).html+'<\/div><div class="attachmentWell-repeater"><\/div><div class="attachmentWell-statusList" aria-hidden="true"><\/div>'+this._contextMenuUI()+"<\/div>"};n._createAttachmentItem=function(n){return new AttachmentWell.Read.Item(n,this._controller,this)};n._createController=function(){return new AttachmentWell.Read.ItemController(this)};n._resetAttachmentCollection=function(){AttachmentWell.Base.ViewLayout.prototype._resetAttachmentCollection.call(this);this._downloadSaveAllControl.resetAttachmentCollection()};n._statusProperty="syncStatus"}(),function(){var t=Microsoft.WindowsLive.Platform.AttachmentSyncStatus,i=AttachmentWell.Utils,n;AttachmentWell.DownloadSaveAllControl=function(n){this.initComponent();this._mailMessage=n;this._attachmentCollection=n.getOrdinaryAttachmentCollection();this._attachmentObjects={};this._attachmentChanged=this._updateControlState.bind(this)};Jx.augment(AttachmentWell.DownloadSaveAllControl,Jx.Component);n=AttachmentWell.DownloadSaveAllControl.prototype;n.getUI=function(n){n.html='<div class="attachmentWell-downloadSaveAllControl"><span class="attachmentWell-downloadAll hidden" tabIndex="0" role="button">'+Jx.escapeHtml(Jx.res.getString("downloadAll"))+'<\/span><span class="attachmentWell-saveAll hidden" tabIndex="0" role="button">'+Jx.escapeHtml(Jx.res.getString("saveAll"))+"<\/span><\/div>"};n.activateUI=function(){this._view=this.getParent();var n=this._element=this._view.getElement().querySelector(".attachmentWell-downloadSaveAllControl");this._downloadAll=n.querySelector(".attachmentWell-downloadAll");this._saveAll=n.querySelector(".attachmentWell-saveAll");this._downloadAllClicker=new Jx.Clicker(this._downloadAll,this._onDownloadAllClicked,this);this._saveAllClicker=new Jx.Clicker(this._saveAll,this._onSaveAllClicked,this);this._addAttachmentListeners();this._updateControlState()};n._addAttachmentListeners=function(){var n=this._attachmentCollection,t,i,r;for(n.addEventListener("collectionchanged",this._attachmentChanged),i=0,r=n.count;i<r;i++)t=n.item(i),t.addEventListener("changed",this._attachmentChanged),this._attachmentObjects[t.objectId]=t;n.unlock()};n._onDownloadAllClicked=function(){var n,i,r;for(Jx.log.info("AttachmentWell.DownloadSaveAllControl._onDownloadAllClicked"),i=0,r=this._attachmentCollection.count;i<r;i++)n=this._attachmentCollection.item(i),(n.syncStatus===t.notStarted||n.syncStatus===t.failed)&&n.downloadBody()};n._onSaveAllClicked=function(){Jx.log.info("AttachmentWell.DownloadSaveAllControl._onSaveAllClicked");var n=this._attachmentCollection,r=function(t){var f,u,r,e;if(t){for(u=[],r=0,e=n.count;r<e;r++)f=n.item(r),u.push(i.getFileFromBodyUri(f).then(function(n){return n.copyAsync(t,n.name,Windows.Storage.NameCollisionOption.generateUniqueName)}));return WinJS.Promise.join(u)}},u=function(){for(var r,u=[],t=0,f=n.count;t<f;t++)r=n.item(t),u.push(i.getFileFromBodyUri(r).then(i.markFileAsWritable));return WinJS.Promise.join(u)},t=new Windows.Storage.Pickers.FolderPicker;t.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.picturesLibrary;t.fileTypeFilter.replaceAll(["*"]);t.pickSingleFolderAsync().then(r).then(u).done(function(){Jx.log.info("AttachmentWell.DownloadSaveAllControl._onSaveAllClicked: all files saved successfully")},function(n){Jx.log.error("AttachmentWell.DownloadSaveAllControl._onSaveAllClicked: failed to save all files: "+n)})};n._updateControlState=function(){for(var e=this._attachmentCollection,n=e.count,r=0,u,f,i=0;i<n;i++)e.item(i).syncStatus===t.done&&r++;u=n<=1||r===n;f=n<=1||r!==n;Jx.setClass(this._downloadAll,"hidden",u);this._downloadAll.setAttribute("aria-hidden",u);Jx.setClass(this._saveAll,"hidden",f);this._saveAll.setAttribute("aria-hidden",f)};n.deactivateUI=function(){this._removeAttachmentListeners();Jx.dispose(this._downloadAllClicker);Jx.dispose(this._saveAllClicker);this._downloadAllClicker=null;this._saveAllClicker=null};n._removeAttachmentListeners=function(){this._attachmentCollection.lock();this._attachmentCollection.removeEventListener("collectionchanged",this._attachmentChanged);Object.keys(this._attachmentObjects).forEach(function(n){var t=this._attachmentObjects[n];t&&t.removeEventListener("changed",this._attachmentChanged)},this);this._attachmentObjects={}};n.resetAttachmentCollection=function(){this._removeAttachmentListeners();this._attachmentCollection=this._mailMessage.getOrdinaryAttachmentCollection();this._addAttachmentListeners();this._updateControlState()}}(),function(){AttachmentWell.FilesAttachedControl=function(){this.initComponent();this._collapsed=false};Jx.augment(AttachmentWell.FilesAttachedControl,Jx.Component);var n=AttachmentWell.FilesAttachedControl.prototype;n.getUI=function(n){n.html='<div class="attachmentWell-filesAttachedControl" tabIndex="0" role="button" aria-expanded="true"><span class="attachmentWell-numberOfFiles"><\/span>&ensp;<span class="attachmentWell-expandChevron"><\/span><span class="attachmentWell-collapseChevron hidden"><\/span><\/div>'};n.activateUI=function(){this._view=this.getParent();var n=this._element=this._view.getElement().querySelector(".attachmentWell-filesAttachedControl");this._numberOfFiles=n.querySelector(".attachmentWell-numberOfFiles");this._expandChevron=n.querySelector(".attachmentWell-expandChevron");this._collapseChevron=n.querySelector(".attachmentWell-collapseChevron");this._observer=Jx.observeAttribute(n,"aria-expanded",function(){this.collapse(n.getAttribute("aria-expanded")==="false")},this);this._clicker=new Jx.Clicker(n,function(){this._element.setAttribute("aria-expanded",this._collapsed)},this)};n.collapse=function(){var n=this._collapsed=!this._collapsed;this._view.isCollapsed=n;Jx.setClass(this._expandChevron,"hidden",n);Jx.setClass(this._collapseChevron,"hidden",!n)};n.updateCount=function(n){Jx.log.info("AttachmentWell.FilesAttachedControl.updateCount: count = "+n);var t=this._numberOfFiles.innerText=n===1?Jx.res.getString("oneFileAttached"):Jx.res.loadCompoundString("numberOfFilesAttached",n);this._element.setAttribute("aria-label",t)};n.deactivateUI=function(){Jx.dispose(this._clicker);this._clicker=null;this._observer.disconnect();this._observer=null}}(),function(){var i=Windows.Storage.FileProperties,n=AttachmentWell.ThumbnailResizer,t=AttachmentWell.Utils,f="Attachments",e="empty",o=function(n){if(n.bodyUri)return t.getFileFromBodyUri(n);var i=Windows.Storage.CreationCollisionOption.openIfExists;return Windows.Storage.ApplicationData.current.temporaryFolder.createFolderAsync(f,i).then(function(r){var u=t.getFileExtension(n);return r.createFileAsync(e+u,i)})},s=function(n,i,r,u){var e,f,o,s;return i?(e=u.photoVideo,f={width:r===t.FileCategory.photo?"System.Image.HorizontalSize":"System.Video.FrameWidth",height:r===t.FileCategory.photo?"System.Image.VerticalSize":"System.Video.FrameHeight"},n.properties.retrievePropertiesAsync([f.width,f.height]).then(function(n){var i=n[f.width],r=n[f.height],u=e.width,t=e.height;return r>t&&i>u?i<=r?t:Math.round(i*t/r):Math.max(u,t)})):(o=u.fileIcon,s=Math.max(o.width,o.height),WinJS.Promise.wrap(s))},r,u;n.getThumbnail=function(n,r,u){var f=r===t.FileCategory.photo||r===t.FileCategory.video,e;return o(n).then(function(n){return e=n,s(n,f,r,u)}).then(function(n){var t=f?i.ThumbnailMode.singleItem:i.ThumbnailMode.listView,r=i.ThumbnailOptions.useCurrentScale;return e.getThumbnailAsync(t,n,r)}).then(null,function(n){return Jx.log.exception("ThumbnailResizer.getThumbnail: failed to get thumbnail",n),WinJS.Promise.wrap(null)})};n.calcDesiredDisplaySize=function(t,i){var r=t.originalWidth,u=t.originalHeight,f=i.height,e=i.minWidth,o=i.maxWidth;return u>f||r>o?n.scaleAspect(o,f,false,r,u):r<e?n.scaleAspect(e,f,false,r,u):{width:r,height:u}};r=2;u=3;n.scaleAspect=function(n,t,i,r,u){if(r>0&&u>0&&n>0&&t>0){var f=r*t>n*u;i&&f||!i&&!f?(r=Math.round(t*r/u),u=t,r<1&&(r=1)):(u=Math.round(n*u/r),r=n,u<1&&(u=1))}else r=0,u=0;return{width:r,height:u}};n.centerElement=function(n,t,i,f){var e=n.style,c,l;var a=f.width,h=f.height,o=0,s=0;return t!==a?(c=(t-a)/r,o=Math.floor(c),e.marginLeft=o.toString()+"px",e.marginRight=Math.ceil(c).toString()+"px"):(o=0,e.marginLeft="",e.marginRight=""),i!==h?(l=(i-h)/(h>i?u:r),s=Math.floor(l),e.marginTop=s.toString()+"px",e.marginBottom=Math.ceil(l).toString()+"px"):(s=0,e.marginTop="",e.marginBottom=""),{top:s,left:o}};n.scaleAndCenter=function(t,i,r,u,f,e,o){var s=n.scaleAspect(u,f,e,i,r),h,c;return o&&(s.width>i*2||s.height>r*2)&&(s.width=i*2,s.height=r*2),t.style.width=String(s.width)+"px",t.style.height=String(s.height)+"px",h=n.centerElement(t,u,f,s),c={top:h.top,left:h.left,width:s.width,height:s.height},c}}()})