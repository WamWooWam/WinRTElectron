// --------------------------------------------------
// <auto-generated>
//     This code was generated by tswinrt.
//     Generated from Windows 255.255.255.255 at Fri Mar 26 17:23:00 2021
// </auto-generated>
// --------------------------------------------------

import { NamedResource } from "./NamedResource";
import { ResourceCandidate } from "./ResourceCandidate";
import { ResourceContext } from "./ResourceContext";
import { IIterable } from "../../../Foundation/Collections/IIterable`1";
import { IIterator } from "../../../Foundation/Collections/IIterator`1";
import { IKeyValuePair } from "../../../Foundation/Collections/IKeyValuePair`2";
import { IMapView } from "../../../Foundation/Collections/IMapView`2";
import { GenerateShim } from "../../../Foundation/Interop/GenerateShim";
import { Uri } from "../../../Foundation/Uri";
import { Dictionary } from "../../../Foundation/Interop/Dictionary`2";
import { Package } from "../../Package";

import deepRename from "deep-rename-keys"
import { getCurrentPackageName } from "../../../Foundation/Interop/Utils";
const path = require('path');
const fs = require('fs');
const { remote } = require("electron");

const supportedLanguages = ["en-gb", "en-us", "en", "generic"]; // this should be detected from the system. KEEP IN SYNC WITH index.ts!!

export class ResourceMap extends Dictionary<string, NamedResource> {
    #parent: ResourceMap;
    #languages: Map<any, any>;
    #subtree: string;

    get uri(): Uri {
        return new Uri(this.#parent != null ? this.#parent.#subtree + this.#subtree : this.#subtree);
    }

    constructor(parent?: ResourceMap, subtree?: string) {
        super();
        if (parent == null) {
            this.#subtree = "ms-resource://"
            this.#languages = new Map();
            let basePath = path.join(remote.app.getAppPath(), "packages", getCurrentPackageName(), "resources");
            for (const language of supportedLanguages) {
                let filePath = path.join(basePath, language + ".json");
                if (fs.existsSync(filePath)) {
                    const resourcesJson = fs.readFileSync(filePath, "utf-8");
                    const parsedResource = deepRename(JSON.parse(resourcesJson), (k: string) => k.toLowerCase());
                    this.#languages.set(language, parsedResource);
                }
            }
        }
        else {
            this.#parent = parent;
            this.#subtree = subtree;
            this.#languages = new Map();
            for (const key of parent.#languages.keys()) {
                this.#languages.set(key, parent.#languages.get(key)[subtree.toLowerCase()]);
            }
        }
    }

    getValue(resource: string): ResourceCandidate {
        let splits = resource.toLowerCase().split("/");
        let name = splits[splits.length - 1];
        let subsplits = splits.slice(0, splits.length - 1);
        let string = null;

        for (const language of this.#languages) {
            if (string != null)
                break;

            let json = language[1];
            for (const split of subsplits) {
                if (json === undefined || split == null || split == "")
                    continue;

                json = json[split];
            }

            if (json === undefined)
                continue;

            string = json[name];
        }

        console.debug(`ResourceMap:got ${string} for ${resource}`);
        var candidate = new ResourceCandidate();
        candidate.valueAsString = string;
        return candidate;
    }

    getSubtree(reference: string): ResourceMap {
        return new ResourceMap(this, reference);
    }

    getValueForContext(resource: string, context: ResourceContext): ResourceCandidate {
        throw new Error('ResourceMap#getValueForContext not implemented')
    }
}
